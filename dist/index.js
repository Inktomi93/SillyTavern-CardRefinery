var e={29(e,t,r){var n=r(566);e.exports=function(e){if(137!==e[0])throw new Error("Invalid .png file header");if(80!==e[1])throw new Error("Invalid .png file header");if(78!==e[2])throw new Error("Invalid .png file header");if(71!==e[3])throw new Error("Invalid .png file header");if(13!==e[4])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");if(10!==e[5])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");if(26!==e[6])throw new Error("Invalid .png file header");if(10!==e[7])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");var t=!1,r=[],s=8;for(;s<e.length;){i[3]=e[s++],i[2]=e[s++],i[1]=e[s++],i[0]=e[s++];var c=o[0]+4,l=new Uint8Array(c);l[0]=e[s++],l[1]=e[s++],l[2]=e[s++],l[3]=e[s++];var d=String.fromCharCode(l[0])+String.fromCharCode(l[1])+String.fromCharCode(l[2])+String.fromCharCode(l[3]);if(!r.length&&"IHDR"!==d)throw new Error("IHDR header missing");if("IEND"===d){t=!0,r.push({name:d,data:new Uint8Array(0)});break}for(var p=4;p<c;p++)l[p]=e[s++];i[3]=e[s++],i[2]=e[s++],i[1]=e[s++],i[0]=e[s++];var u=a[0];if(n.buf(l)!==u)throw new Error("CRC values for "+d+" header do not match, PNG file is likely corrupted");var f=new Uint8Array(l.buffer.slice(4));r.push({name:d,data:f})}if(!t)throw new Error(".png file ended prematurely: no IEND header was found");return r};var i=new Uint8Array(4),a=new Int32Array(i.buffer),o=new Uint32Array(i.buffer)},56(e,t,r){e.exports=function(e){var t=r.nc;t&&e.setAttribute("nonce",t)}},72(e){var t=[];function r(e){for(var r=-1,n=0;n<t.length;n++)if(t[n].identifier===e){r=n;break}return r}function n(e,n){for(var a={},o=[],s=0;s<e.length;s++){var c=e[s],l=n.base?c[0]+n.base:c[0],d=a[l]||0,p="".concat(l," ").concat(d);a[l]=d+1;var u=r(p),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)t[u].references++,t[u].updater(f);else{var m=i(f,n);n.byIndex=s,t.splice(s,0,{identifier:p,updater:m,references:1})}o.push(p)}return o}function i(e,t){var r=t.domAPI(t);r.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;r.update(e=t)}else r.remove()}}e.exports=function(e,i){var a=n(e=e||[],i=i||{});return function(e){e=e||[];for(var o=0;o<a.length;o++){var s=r(a[o]);t[s].references--}for(var c=n(e,i),l=0;l<a.length;l++){var d=r(a[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=c}}},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},179(e,t,r){r.r(t),r.d(t,{generate:()=>o,generateSimple:()=>s});var n=r(313),i=r(374),a=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function o(e){return a(this,void 0,void 0,function*(){var t,r,a,o,s,c;if(null===(t=e.signal)||void 0===t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!(0,n.cW)()){return{success:!1,error:(0,n.Lq)().error||"API not connected. Check your connection settings."}}if(e.jsonSchema){const t=(0,i.i6)(e.jsonSchema);if(!t.valid)return{success:!1,error:`Invalid schema: ${t.error}`}}try{if(null===(r=e.signal)||void 0===r?void 0:r.aborted)return{success:!1,error:"Generation cancelled"};const t=SillyTavern.getContext(),n=yield t.generateRaw({prompt:e.prompt,systemPrompt:null!==(a=e.systemPrompt)&&void 0!==a?a:"",responseLength:null!==(o=e.responseLength)&&void 0!==o?o:null,jsonSchema:null!==(s=e.jsonSchema)&&void 0!==s?s:null});if(null===(c=e.signal)||void 0===c?void 0:c.aborted)return{success:!1,error:"Generation cancelled"};const l=function(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e){const t=e;return"string"==typeof t.text?t.text:"string"==typeof t.content?t.content:JSON.stringify(e)}return String(e)}(n);if(!l||""===l.trim())return{success:!1,error:"Empty response from API"};if(e.jsonSchema){const t=(0,i.Ki)(l,e.jsonSchema);return t?{success:!0,response:l,parsed:t.data,isStructured:!0}:{success:!0,response:l,isStructured:!1}}return{success:!0,response:l,isStructured:!1}}catch(e){return function(e){if("AbortError"===e.name)return{success:!1,error:"Generation cancelled"};const t=e instanceof Error?e.message:String(e),r=t.toLowerCase();if(r.includes("401")||r.includes("unauthorized")||r.includes("invalid_api_key")||r.includes("api key"))return{success:!1,error:"API authentication failed. Check your API key."};if(r.includes("429")||r.includes("rate limit"))return{success:!1,error:"Rate limited. Please wait and try again."};if(r.includes("500")||r.includes("502")||r.includes("503"))return{success:!1,error:"API server error. The service may be temporarily unavailable."};if(r.includes("timeout")||r.includes("etimedout"))return{success:!1,error:"Request timed out. Check your connection or try a different model."};if(r.includes("network")||r.includes("econnrefused")||r.includes("fetch failed"))return{success:!1,error:"Network error. Check your internet connection."};if(r.includes("context")||r.includes("too long")||r.includes("maximum context")||r.includes("token"))return{success:!1,error:"Prompt too long for model context. Try reducing input length."};if(r.includes("model")&&(r.includes("not found")||r.includes("does not exist")))return{success:!1,error:"Model not found. It may have been deprecated or renamed."};if(r.includes("content")&&(r.includes("filter")||r.includes("policy")))return{success:!1,error:"Content was filtered by the API. Try rephrasing your prompt."};return{success:!1,error:t}}(e)}})}function s(e,t){return a(this,void 0,void 0,function*(){var r;const n=yield o({prompt:e,systemPrompt:t});return n.success&&null!==(r=n.response)&&void 0!==r?r:null})}},242(e){e.exports="data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath fill=%27%23999%27 d=%27m2 4 4 4 4-4%27/%3E%3C/svg%3E"},251(e,t){t.read=function(e,t,r,n,i){var a,o,s=8*i-n-1,c=(1<<s)-1,l=c>>1,d=-7,p=r?i-1:0,u=r?-1:1,f=e[t+p];for(p+=u,a=f&(1<<-d)-1,f>>=-d,d+=s;d>0;a=256*a+e[t+p],p+=u,d-=8);for(o=a&(1<<-d)-1,a>>=-d,d+=n;d>0;o=256*o+e[t+p],p+=u,d-=8);if(0===a)a=1-l;else{if(a===c)return o?NaN:1/0*(f?-1:1);o+=Math.pow(2,n),a-=l}return(f?-1:1)*o*Math.pow(2,a-n)},t.write=function(e,t,r,n,i,a){var o,s,c,l=8*a-i-1,d=(1<<l)-1,p=d>>1,u=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:a-1,m=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,o=d):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+p>=1?u/c:u*Math.pow(2,1-p))*c>=2&&(o++,c/=2),o+p>=d?(s=0,o=d):o+p>=1?(s=(t*c-1)*Math.pow(2,i),o+=p):(s=t*Math.pow(2,p-1)*Math.pow(2,i),o=0));i>=8;e[r+f]=255&s,f+=m,s/=256,i-=8);for(o=o<<i|s,l+=i;l>0;e[r+f]=255&o,f+=m,o/=256,l-=8);e[r+f-m]|=128*g}},287(e,t,r){const n=r(526),i=r(251),a="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.hp=c,t.IS=50;const o=2147483647;function s(e){if(e>o)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,c.prototype),t}function c(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return p(e)}return l(e,t,r)}function l(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!c.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const r=0|g(e,t);let n=s(r);const i=n.write(e,t);i!==r&&(n=n.slice(0,i));return n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(V(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return u(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(V(e,ArrayBuffer)||e&&V(e.buffer,ArrayBuffer))return f(e,t,r);if("undefined"!=typeof SharedArrayBuffer&&(V(e,SharedArrayBuffer)||e&&V(e.buffer,SharedArrayBuffer)))return f(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return c.from(n,t,r);const i=function(e){if(c.isBuffer(e)){const t=0|m(e.length),r=s(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||Q(e.length)?s(0):u(e);if("Buffer"===e.type&&Array.isArray(e.data))return u(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return c.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function d(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function p(e){return d(e),s(e<0?0:0|m(e))}function u(e){const t=e.length<0?0:0|m(e.length),r=s(t);for(let n=0;n<t;n+=1)r[n]=255&e[n];return r}function f(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),Object.setPrototypeOf(n,c.prototype),n}function m(e){if(e>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|e}function g(e,t){if(c.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||V(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return J(e).length;default:if(i)return n?-1:q(e).length;t=(""+t).toLowerCase(),i=!0}}function v(e,t,r){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return C(this,t,r);case"utf8":case"utf-8":return P(this,t,r);case"ascii":return E(this,t,r);case"latin1":case"binary":return A(this,t,r);case"base64":return S(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function h(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function y(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),Q(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:b(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):b(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function b(e,t,r,n,i){let a,o=1,s=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,s/=2,c/=2,r/=2}function l(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){let n=-1;for(a=r;a<s;a++)if(l(e,a)===l(t,-1===n?0:a-n)){if(-1===n&&(n=a),a-n+1===c)return n*o}else-1!==n&&(a-=a-n),n=-1}else for(r+c>s&&(r=s-c),a=r;a>=0;a--){let r=!0;for(let n=0;n<c;n++)if(l(e,a+n)!==l(t,n)){r=!1;break}if(r)return a}return-1}function _(e,t,r,n){r=Number(r)||0;const i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;const a=t.length;let o;for(n>a/2&&(n=a/2),o=0;o<n;++o){const n=parseInt(t.substr(2*o,2),16);if(Q(n))return o;e[r+o]=n}return o}function x(e,t,r,n){return Y(q(t,e.length-r),e,r,n)}function w(e,t,r,n){return Y(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function $(e,t,r,n){return Y(J(t),e,r,n)}function k(e,t,r,n){return Y(function(e,t){let r,n,i;const a=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)r=e.charCodeAt(o),n=r>>8,i=r%256,a.push(i),a.push(n);return a}(t,e.length-r),e,r,n)}function S(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function P(e,t,r){r=Math.min(e.length,r);const n=[];let i=t;for(;i<r;){const t=e[i];let a=null,o=t>239?4:t>223?3:t>191?2:1;if(i+o<=r){let r,n,s,c;switch(o){case 1:t<128&&(a=t);break;case 2:r=e[i+1],128==(192&r)&&(c=(31&t)<<6|63&r,c>127&&(a=c));break;case 3:r=e[i+1],n=e[i+2],128==(192&r)&&128==(192&n)&&(c=(15&t)<<12|(63&r)<<6|63&n,c>2047&&(c<55296||c>57343)&&(a=c));break;case 4:r=e[i+1],n=e[i+2],s=e[i+3],128==(192&r)&&128==(192&n)&&128==(192&s)&&(c=(15&t)<<18|(63&r)<<12|(63&n)<<6|63&s,c>65535&&c<1114112&&(a=c))}}null===a?(a=65533,o=1):a>65535&&(a-=65536,n.push(a>>>10&1023|55296),a=56320|1023&a),n.push(a),i+=o}return function(e){const t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=R));return r}(n)}c.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(e,t,r){return l(e,t,r)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array),c.alloc=function(e,t,r){return function(e,t,r){return d(e),e<=0?s(e):void 0!==t?"string"==typeof r?s(e).fill(t,r):s(e).fill(t):s(e)}(e,t,r)},c.allocUnsafe=function(e){return p(e)},c.allocUnsafeSlow=function(e){return p(e)},c.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==c.prototype},c.compare=function(e,t){if(V(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),V(t,Uint8Array)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,a=Math.min(r,n);i<a;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);let r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;const n=c.allocUnsafe(t);let i=0;for(r=0;r<e.length;++r){let t=e[r];if(V(t,Uint8Array))i+t.length>n.length?(c.isBuffer(t)||(t=c.from(t)),t.copy(n,i)):Uint8Array.prototype.set.call(n,t,i);else{if(!c.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,i)}i+=t.length}return n},c.byteLength=g,c.prototype._isBuffer=!0,c.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)h(this,t,t+1);return this},c.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)h(this,t,t+3),h(this,t+1,t+2);return this},c.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)h(this,t,t+7),h(this,t+1,t+6),h(this,t+2,t+5),h(this,t+3,t+4);return this},c.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?P(this,0,e):v.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){let e="";const r=t.IS;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},a&&(c.prototype[a]=c.prototype.inspect),c.prototype.compare=function(e,t,r,n,i){if(V(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;let a=(i>>>=0)-(n>>>=0),o=(r>>>=0)-(t>>>=0);const s=Math.min(a,o),l=this.slice(n,i),d=e.slice(t,r);for(let e=0;e<s;++e)if(l[e]!==d[e]){a=l[e],o=d[e];break}return a<o?-1:o<a?1:0},c.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return y(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return y(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let a=!1;for(;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return x(this,e,t,r);case"ascii":case"latin1":case"binary":return w(this,e,t,r);case"base64":return $(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,r);default:if(a)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),a=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const R=4096;function E(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function A(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function C(e,t,r){const n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=t;n<r;++n)i+=X[e[n]];return i}function I(e,t,r){const n=e.slice(t,r);let i="";for(let e=0;e<n.length-1;e+=2)i+=String.fromCharCode(n[e]+256*n[e+1]);return i}function z(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function O(e,t,r,n,i,a){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<a)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function T(e,t,r,n,i){U(t,n,i,e,r,7);let a=Number(t&BigInt(4294967295));e[r++]=a,a>>=8,e[r++]=a,a>>=8,e[r++]=a,a>>=8,e[r++]=a;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,r}function W(e,t,r,n,i){U(t,n,i,e,r,7);let a=Number(t&BigInt(4294967295));e[r+7]=a,a>>=8,e[r+6]=a,a>>=8,e[r+5]=a,a>>=8,e[r+4]=a;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=o,o>>=8,e[r+2]=o,o>>=8,e[r+1]=o,o>>=8,e[r]=o,r+8}function N(e,t,r,n,i,a){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function L(e,t,r,n,a){return t=+t,r>>>=0,a||N(e,0,r,4),i.write(e,t,r,n,23,4),r+4}function j(e,t,r,n,a){return t=+t,r>>>=0,a||N(e,0,r,8),i.write(e,t,r,n,52,8),r+8}c.prototype.slice=function(e,t){const r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,c.prototype),n},c.prototype.readUintLE=c.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||z(e,t,this.length);let n=this[e],i=1,a=0;for(;++a<t&&(i*=256);)n+=this[e+a]*i;return n},c.prototype.readUintBE=c.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||z(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n},c.prototype.readUint8=c.prototype.readUInt8=function(e,t){return e>>>=0,t||z(e,1,this.length),this[e]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(e,t){return e>>>=0,t||z(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(e,t){return e>>>=0,t||z(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(e,t){return e>>>=0,t||z(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(e,t){return e>>>=0,t||z(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readBigUInt64LE=K(function(e){F(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))}),c.prototype.readBigUInt64BE=K(function(e){F(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)}),c.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||z(e,t,this.length);let n=this[e],i=1,a=0;for(;++a<t&&(i*=256);)n+=this[e+a]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||z(e,t,this.length);let n=t,i=1,a=this[e+--n];for(;n>0&&(i*=256);)a+=this[e+--n]*i;return i*=128,a>=i&&(a-=Math.pow(2,8*t)),a},c.prototype.readInt8=function(e,t){return e>>>=0,t||z(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){e>>>=0,t||z(e,2,this.length);const r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){e>>>=0,t||z(e,2,this.length);const r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return e>>>=0,t||z(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return e>>>=0,t||z(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readBigInt64LE=K(function(e){F(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)}),c.prototype.readBigInt64BE=K(function(e){F(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+r)}),c.prototype.readFloatLE=function(e,t){return e>>>=0,t||z(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return e>>>=0,t||z(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return e>>>=0,t||z(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return e>>>=0,t||z(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUintLE=c.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){O(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=1,a=0;for(this[t]=255&e;++a<r&&(i*=256);)this[t+a]=e/i&255;return t+r},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){O(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=r-1,a=1;for(this[t+i]=255&e;--i>=0&&(a*=256);)this[t+i]=e/a&255;return t+r},c.prototype.writeUint8=c.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,1,255,0),this[t]=255&e,t+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigUInt64LE=K(function(e,t=0){return T(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=K(function(e,t=0){return W(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);O(this,e,t,r,n-1,-n)}let i=0,a=1,o=0;for(this[t]=255&e;++i<r&&(a*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/a|0)-o&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);O(this,e,t,r,n-1,-n)}let i=r-1,a=1,o=0;for(this[t+i]=255&e;--i>=0&&(a*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/a|0)-o&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||O(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigInt64LE=K(function(e,t=0){return T(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=K(function(e,t=0){return W(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeFloatLE=function(e,t,r){return L(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return L(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return j(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return j(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(!c.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);const i=n-r;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;let i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{const a=c.isBuffer(e)?e:c.from(e,n),o=a.length;if(0===o)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=a[i%o]}return this};const B={};function D(e,t,r){B[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function M(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function U(e,t,r,n,i,a){if(e>r||e<t){const n="bigint"==typeof t?"n":"";let i;throw i=a>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(a+1)}${n}`:`>= -(2${n} ** ${8*(a+1)-1}${n}) and < 2 ** ${8*(a+1)-1}${n}`:`>= ${t}${n} and <= ${r}${n}`,new B.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,r){F(t,"offset"),void 0!==e[t]&&void 0!==e[t+r]||H(t,e.length-(r+1))}(n,i,a)}function F(e,t){if("number"!=typeof e)throw new B.ERR_INVALID_ARG_TYPE(t,"number",e)}function H(e,t,r){if(Math.floor(e)!==e)throw F(e,r),new B.ERR_OUT_OF_RANGE(r||"offset","an integer",e);if(t<0)throw new B.ERR_BUFFER_OUT_OF_BOUNDS;throw new B.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}D("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),D("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError),D("ERR_OUT_OF_RANGE",function(e,t,r){let n=`The value of "${e}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=M(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=M(i)),i+="n"),n+=` It must be ${t}. Received ${i}`,n},RangeError);const G=/[^+/0-9A-Za-z-_]/g;function q(e,t){let r;t=t||1/0;const n=e.length;let i=null;const a=[];for(let o=0;o<n;++o){if(r=e.charCodeAt(o),r>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&a.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&a.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&a.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;a.push(r)}else if(r<2048){if((t-=2)<0)break;a.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;a.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return a}function J(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,r,n){let i;for(i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function V(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Q(e){return e!=e}const X=function(){const e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)t[n+i]=e[r]+e[i]}return t}();function K(e){return"undefined"==typeof BigInt?Z:e}function Z(){throw new Error("BigInt not supported")}},313(e,t,r){r.d(t,{IF:()=>f,U8:()=>g,Oi:()=>o,hi:()=>i,Nf:()=>v,pW:()=>n,v7:()=>l,$G:()=>s,an:()=>d,iu:()=>u,BA:()=>p,d5:()=>m,F:()=>c,xv:()=>a,Sn:()=>B,Lq:()=>C,We:()=>E,NR:()=>N,gg:()=>L,mi:()=>R,cW:()=>I,Ar:()=>P,Rm:()=>b,lY:()=>$,pM:()=>_,RG:()=>S,oR:()=>k});const n="SillyTavern-CardRefinery",i="CardRefinery",a="1.0.0",o=!0,s=2,c=2,l=1,d=["score","rewrite","analyze"],p={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},u={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},f=[{key:"description",label:"Description",path:"description"},{key:"personality",label:"Personality",path:"personality"},{key:"first_mes",label:"First Message",path:"first_mes"},{key:"scenario",label:"Scenario",path:"scenario"},{key:"mes_example",label:"Example Messages",path:"mes_example"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}],m={SESSIONS:`${n}_sessions`,SESSION_INDEX:`${n}_session_index`,STORAGE_META:`${n}_storage_meta`},g={SEARCH:150,SAVE:1e3,VALIDATE:300},v=50,h=[];let y=!1;const b={debug(e,t){x("debug",e,t),y&&(void 0!==t?console.debug(`[${n}]`,e,t):console.debug(`[${n}]`,e))},info(e,t){x("info",e,t),void 0!==t?console.log(`[${n}]`,e,t):console.log(`[${n}]`,e)},warn(e,t){x("warn",e,t),void 0!==t?console.warn(`[${n}]`,e,t):console.warn(`[${n}]`,e)},error(e,t){x("error",e,t),void 0!==t?console.error(`[${n}]`,e,t):console.error(`[${n}]`,e)}};function _(e){y=e,b.info("Debug mode "+(e?"enabled":"disabled"))}function x(e,t,r){h.unshift({timestamp:new Date,level:e,message:t,data:r}),h.length>100&&h.pop()}var w=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const $={confirm(e,t){return w(this,void 0,void 0,function*(){const r=yield SillyTavern.getContext().Popup.show.confirm(e,t);return!0===r||1===r})},input(e,t,r){return w(this,void 0,void 0,function*(){return SillyTavern.getContext().Popup.show.input(e,t,r)})},alert(e,t){return w(this,void 0,void 0,function*(){yield SillyTavern.getContext().Popup.show.text(e,t)})}},k={success(e,t){toastr.success(e,t)},error(e,t){toastr.error(e,t)},warning(e,t){toastr.warning(e,t)},info(e,t){toastr.info(e,t)}};function S(e,t){return w(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.setItem(e,t),!0}catch(t){return b.error(`storeLargeData: Failed to store ${e}:`,t),!1}})}function P(e){return w(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.getItem(e)}catch(t){return b.error(`loadLargeData: Failed to load ${e}:`,t),null}})}function R(){const e=SillyTavern.getContext().ConnectionManagerRequestService;return!(!e||"function"!=typeof e.sendRequest)}function E(){const e=SillyTavern.getContext().ConnectionManagerRequestService;if(!e||"function"!=typeof e.getSupportedProfiles)return[];try{return(e.getSupportedProfiles()||[]).map(t=>{const r=function(e,t){try{const r=(t.getSupportedProfiles()||[]).find(t=>t.id===e);return r?{valid:!0,error:null}:{valid:!1,error:"Profile not found"}}catch(e){return{valid:!1,error:"Failed to validate profile"}}}(t.id,e);return{id:t.id,name:t.name,model:t.model,api:t.api,mode:t.mode,presetName:t.presetName,isSupported:r.valid,validationError:r.error}})}catch(e){return b.error("Failed to get profiles",e),[]}}function A(e){return E().find(t=>t.id===e)||null}function C(e){const t=SillyTavern.getContext();return e?function(e){const t=A(e);if(!t)return{mode:"profile",displayName:"Unknown Profile",source:"unknown",model:"unknown",modelDisplay:"Unknown",apiType:"cc",contextSize:8192,maxOutput:4096,isReady:!1,statusText:"Profile Not Found",error:`Profile ${e} not found`};return{mode:"profile",displayName:t.name,source:t.api,model:t.model,modelDisplay:z(t.model),apiType:t.mode,contextSize:8192,maxOutput:4096,isReady:t.isSupported,statusText:t.isSupported?`${t.name} Ready`:"Not Supported",error:t.validationError}}(e):function(e){var t,r,n,i,a;const o=null!==(t=e.mainApi)&&void 0!==t?t:"unknown",s=e.chatCompletionSettings,c=e.textCompletionSettings,l="textgenerationwebui"!==o&&"kobold"!==o,d=l?"cc":"tc";let p="unknown";l&&"function"==typeof e.getChatCompletionModel?p=e.getChatCompletionModel()||"unknown":l||(p=e.onlineStatus||"unknown");let u=o;l&&(null==s?void 0:s.chat_completion_source)&&(u=s.chat_completion_source);const f=null!==(n=null!==(r=null==s?void 0:s.openai_max_context)&&void 0!==r?r:e.maxContext)&&void 0!==n?n:8192,m=l?null!==(i=null==s?void 0:s.openai_max_tokens)&&void 0!==i?i:4096:null!==(a=null==c?void 0:c.max_length)&&void 0!==a?a:2048,{isReady:g,error:v}=function(e){var t;const r=e.chatCompletionSettings;if(null==r?void 0:r.bypass_status_check)return{isReady:!0,error:null};const n=(null!==(t=e.onlineStatus)&&void 0!==t?t:"").toLowerCase();if(!n)return{isReady:!1,error:"No API connection"};if(["error","fail","invalid","unauthorized","missing"].some(e=>n.includes(e)))return{isReady:!1,error:`API error: ${n}`};if(["valid","connected","ok","ready","key","saved"].some(e=>n.includes(e)))return{isReady:!0,error:null};if("function"!=typeof e.generateRaw)return{isReady:!1,error:"Generation not available (ST version?)"};return{isReady:!0,error:null}}(e);return{mode:"current",displayName:"Current Settings",source:u,model:p,modelDisplay:z(p),apiType:d,contextSize:f,maxOutput:m,isReady:g,statusText:g?`${z(p)} Ready`:"Not Ready",error:v}}(t)}function I(e){return C(e).isReady}function z(e){if(!e||"unknown"===e)return"Unknown";const t=e.replace(/^gpt-/,"GPT-").replace(/^claude-/,"Claude-").replace(/^gemini-/,"Gemini-").replace(/-\d{4}-\d{2}-\d{2}$/,"").replace(/-preview$/,"");return t.length>30?t.slice(0,27)+"...":t}var O=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const T=new Map;new Map;function W(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t|=0}const r=e.slice(0,16),n=e.slice(-16);return`${t}_${e.length}_${r}_${n}`}function N(e){return O(this,void 0,void 0,function*(){const t=e.trim();if(!t)return 0;const r=W(t),n=T.get(r);if(void 0!==n)return n;const i=SillyTavern.getContext();if("function"!=typeof i.getTokenCountAsync)return null;try{const e=yield i.getTokenCountAsync(t);return j(r,e),e}catch(e){return b.error("Token count failed",e),null}})}function L(e){return O(this,void 0,void 0,function*(){const t=e.map(e=>e.text),r=yield function(e){return O(this,void 0,void 0,function*(){const t=new Map,r=[];for(const n of e){const e=n.trim();if(!e){t.set(n,0);continue}const i=W(e),a=T.get(i);void 0!==a?t.set(n,a):r.push({text:e,key:i,original:n})}if(r.length>0){const e=SillyTavern.getContext();if("function"!=typeof e.getTokenCountAsync){for(const{original:e}of r)t.set(e,null);return t}const n=r.map(t=>O(this,[t],void 0,function*({text:t,key:r,original:n}){try{const i=yield e.getTokenCountAsync(t);return j(r,i),{original:n,tokens:i}}catch(e){return{original:n,tokens:null}}})),i=yield Promise.all(n);for(const{original:e,tokens:r}of i)t.set(e,r)}return t})}(t);return e.map(e=>{var t;return{key:e.key,tokens:null!==(t=r.get(e.text))&&void 0!==t?t:null}})})}function j(e,t){if(!T.has(e)&&T.size>=500){const e=T.keys().next().value;e&&T.delete(e)}T.set(e,t)}function B(e,t){const r=new Set(t.map(e=>e.toLowerCase()));if(!r.has(e.toLowerCase()))return e;let n=2,i=`${e} (${n})`;for(;r.has(i.toLowerCase());)n++,i=`${e} (${n})`;return i}},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var r="",n=void 0!==t[5];return t[4]&&(r+="@supports (".concat(t[4],") {")),t[2]&&(r+="@media ".concat(t[2]," {")),n&&(r+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),r+=e(t),n&&(r+="}"),t[2]&&(r+="}"),t[4]&&(r+="}"),r}).join("")},t.i=function(e,r,n,i,a){"string"==typeof e&&(e=[[null,e,void 0]]);var o={};if(n)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(o[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);n&&o[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),r&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=r):d[2]=r),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},374(e,t,r){r.d(t,{Ki:()=>S,i6:()=>h,jf:()=>k,nr:()=>P});var n=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const i=8,a=100,o=10,s=100,c=500,l=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],d=[0,1],p=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],u=["minLength","maxLength"],f=["maxItems","uniqueItems","contains","minContains","maxContains"],m=["minProperties","maxProperties","propertyNames","patternProperties"],g=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],v=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function h(e){var t;if("string"==typeof e&&!e.trim())return{valid:!0,schema:void 0};let r;if("string"==typeof e)try{r=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",r=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${r?` (character ${r[1]})`:""}: ${t}`}}else r=e;if("object"!=typeof r||null===r||Array.isArray(r))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(r)?"array":typeof r)};const n=r;if("string"!=typeof n.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!n.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(n.name))return{valid:!1,error:`'name' must be a valid identifier (got '${n.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof n.value||null===n.value||Array.isArray(n.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const i=n.value;if("string"!=typeof i.type&&!i.anyOf&&!i.allOf&&!i.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==n.strict&&"boolean"!=typeof n.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const o={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(i.$defs&&"object"==typeof i.$defs?(o.defs=i.$defs,o.stats.defCount=Object.keys(o.defs).length):i.definitions&&"object"==typeof i.definitions&&(o.defs=i.definitions,o.stats.defCount=Object.keys(o.defs).length),o.stats.defCount>a&&o.errors.push(`Too many definitions: ${o.stats.defCount} (limit: ${a})`),y(i,"value",o),o.stats.optionalFieldCount>0){const e=o.stats.optionalFieldCount,t=o.stats.totalAnyOfVariants+2*e;e>10&&o.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&o.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(o.errors.length>0)return{valid:!1,error:o.errors.join("\n"),warnings:o.warnings.length>0?o.warnings:void 0};const s={name:n.name,strict:null===(t=n.strict)||void 0===t||t,value:i};return o.info.push(`Schema stats: ${o.stats.propertyCount} properties, ${o.stats.defCount} definitions, ${o.stats.anyOfCount} anyOf blocks, ${o.stats.optionalFieldCount} optional fields, max depth ${o.stats.maxDepth}`),{valid:!0,schema:s,warnings:o.warnings.length>0?o.warnings:void 0,info:o.info.length>0?o.info:void 0}}function y(e,t,r){if(r.currentDepth++,r.stats.maxDepth=Math.max(r.stats.maxDepth,r.currentDepth),r.currentDepth>o)return r.errors.push(`${t}: Exceeds maximum nesting depth of ${o}`),void r.currentDepth--;for(const n of g)void 0!==e[n]&&r.errors.push(`${t}: '${n}' is not supported`);for(const n of p)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of u)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of f)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of m)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,r){if(e.startsWith("http://")||e.startsWith("https://"))return void r.errors.push(`${t}: External $ref not supported ('${e}')`);if(r.seenRefs.has(e))return void r.info.push(`${t}: Circular reference to '${e}'`);r.seenRefs.add(e);const n=e.replace(/^#\/(\$defs|definitions)\//,"");r.defs[n]||r.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,r),void r.currentDepth--;const n=Array.isArray(e.type)?e.type:[e.type];for(const i of n)switch(i){case"object":b(e,t,r);break;case"array":_(e,t,r);break;case"string":x(e,t,r);break;case"number":case"integer":case"boolean":case"null":break;default:!i||e.anyOf||e.allOf||r.warnings.push(`${t}: Unknown type '${i}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,r){r.stats.anyOfCount++,r.stats.totalAnyOfVariants+=e.length,e.length>i&&r.errors.push(`${t}: anyOf has ${e.length} variants (max: ${i})`);if(0===e.length)return void r.errors.push(`${t}: anyOf cannot be empty`);e.forEach((e,n)=>{e&&"object"==typeof e&&y(e,`${t}.anyOf[${n}]`,r)})}(e.anyOf,t,r),e.allOf&&Array.isArray(e.allOf)&&function(e,t,r){if(0===e.length)return void r.errors.push(`${t}: allOf cannot be empty`);e.forEach((e,n)=>{if(e&&"object"==typeof e){const i=e;i.$ref&&r.errors.push(`${t}.allOf[${n}]: allOf with $ref not supported`),y(i,`${t}.allOf[${n}]`,r)}})}(e.allOf,t,r),e.enum&&Array.isArray(e.enum)&&function(e,t,r){if(r.stats.enumCount++,0===e.length)return void r.errors.push(`${t}: enum cannot be empty`);e.length>c&&r.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let n=0;n<e.length;n++){const i=e[n],a=typeof i;if("string"!==a&&"number"!==a&&"boolean"!==a&&null!==i){r.errors.push(`${t}.enum[${n}]: Complex type not allowed in enum (got ${a}). Only string, number, boolean, null permitted.`);break}}const n=new Set;for(const i of e){const e=JSON.stringify(i);if(n.has(e)){r.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}n.add(e)}}(e.enum,t,r),void 0!==e.const&&function(e,t,r){const n=typeof e;"string"!==n&&"number"!==n&&"boolean"!==n&&null!==e&&r.errors.push(`${t}: const must be string, number, boolean, or null (got ${n})`)}(e.const,t,r),r.currentDepth--}function b(e,t,r){if(!1!==e.additionalProperties&&r.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const n=e.properties,i=Object.keys(n).length;r.stats.propertyCount+=i,i>s&&r.warnings.push(`${t}: ${i} properties (may be slow, consider splitting)`);const a=e.required||[];for(const[e,i]of Object.entries(n))a.includes(e)||r.stats.optionalFieldCount++,i&&"object"==typeof i&&y(i,`${t}.${e}`,r)}}function _(e,t,r){if(void 0!==e.minItems){d.includes(e.minItems)||r.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach((e,n)=>{e&&"object"==typeof e&&y(e,`${t}.items[${n}]`,r)}):y(e.items,`${t}.items`,r)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach((e,n)=>{e&&"object"==typeof e&&y(e,`${t}.prefixItems[${n}]`,r)})}function x(e,t,r){if(e.format&&"string"==typeof e.format){const n=l;n.includes(e.format)||r.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${n.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,r){for(const{pattern:n,name:i}of v)n.test(e)&&r.errors.push(`${t}: Regex pattern uses unsupported feature: ${i}`);try{new RegExp(e)}catch(e){const n=e instanceof Error?e.message:"Invalid regex";r.errors.push(`${t}: Invalid regex pattern: ${n}`)}const n=/\{(\d+),(\d+)\}/g;let i;for(;null!==(i=n.exec(e));){const e=parseInt(i[1],10),n=parseInt(i[2],10);n-e>100&&r.warnings.push(`${t}: Large quantifier range {${e},${n}} may cause issues`)}}(e.pattern,t,r)}function w(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),$(t.value),t}function $(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&$(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&$(e)}):$(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&$(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&$(e)});const t=[];for(const r of p)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);for(const r of u)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);for(const r of f)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);if(void 0!==e.minItems&&null!==e.minItems){const r=e.minItems;0!==r&&1!==r&&(t.push(`minItems: ${r}`),e.minItems=r>0?1:0)}if(t.length>0){const r=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${r}`:e.description=r}}function k(e){return e?JSON.stringify(e,null,2):""}function S(e,t){let r;try{r=JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!n)return null;try{r=JSON.parse(n[1].trim())}catch(e){return null}}const n=[];if(t&&t.value.required&&Array.isArray(t.value.required)){const e=t.value.required.filter(e=>!(e in r));e.length>0&&n.push(`Missing required fields: ${e.join(", ")}`)}return{data:r,warnings:n}}function P(e){return n(this,void 0,void 0,function*(){var t;const{generateSimple:n}=yield Promise.resolve().then(r.bind(r,179));if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{const r=yield n(`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${e}`,"You are a JSON Schema expert. Output only valid JSON, nothing else.");if(!r)return{success:!1,error:"Generation failed - no response received"};let i=r.trim();i.startsWith("```")&&(i=i.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const a=h(i);if(!a.valid)return{success:!1,error:`Generated schema is invalid: ${a.error}`,schema:i};if(null===(t=a.warnings)||void 0===t?void 0:t.length){const e=w(a.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(a.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}})}},417(e){e.exports=function(e,t){return t||(t={}),e?(e=String(e.__esModule?e.default:e),/^['"].*['"]$/.test(e)&&(e=e.slice(1,-1)),t.hash&&(e+=t.hash),/["'() \t\n]|(%20)/.test(e)||t.needQuotes?'"'.concat(e.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):e):e}},524(e){e.exports=function(e,t){if(e=String(e),t=String(t),!/^[\x00-\xFF]+$/.test(e)||!/^[\x00-\xFF]+$/.test(t))throw new Error("Only Latin-1 characters are permitted in PNG tEXt chunks. You might want to consider base64 encoding and/or zEXt compression");if(e.length>=80)throw new Error('Keyword "'+e+'" is longer than the 79-character limit imposed by the PNG specification');for(var r,n=e.length+t.length+1,i=new Uint8Array(n),a=0,o=0;o<e.length;o++){if(!(r=e.charCodeAt(o)))throw new Error("0x00 character is not permitted in tEXt keywords");i[a++]=r}i[a++]=0;for(var s=0;s<t.length;s++){if(!(r=t.charCodeAt(s)))throw new Error("0x00 character is not permitted in tEXt content");i[a++]=r}return{name:"tEXt",data:i}}},526(e,t){t.byteLength=function(e){var t=s(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,a=s(e),o=a[0],c=a[1],l=new i(function(e,t,r){return 3*(t+r)/4-r}(0,o,c)),d=0,p=c>0?o-4:o;for(r=0;r<p;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],l[d++]=t>>16&255,l[d++]=t>>8&255,l[d++]=255&t;2===c&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,l[d++]=255&t);1===c&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,l[d++]=t>>8&255,l[d++]=255&t);return l},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,a=[],o=16383,s=0,c=n-i;s<c;s+=o)a.push(l(e,s,s+o>c?c:s+o));1===i?(t=e[n-1],a.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],a.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return a.join("")};for(var r=[],n=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0;o<64;++o)r[o]=a[o],n[a.charCodeAt(o)]=o;function s(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function c(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function l(e,t,r){for(var n,i=[],a=t;a<r;a+=3)n=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),i.push(c(n));return i.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},566(e,t){var r;r=function(e){e.version="0.3.0";var t=function(){for(var e=0,t=new Array(256),r=0;256!=r;++r)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=r)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1,t[r]=e;return"undefined"!=typeof Int32Array?new Int32Array(t):t}(),r="undefined"!=typeof Buffer;function n(e){for(var r=-1,n=0,i=e.length-7;n<i;)r=(r=(r=(r=(r=(r=(r=(r=r>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])];for(;n<i+7;)r=r>>>8^t[255&(r^e[n++])];return-1^r}e.table=t,e.bstr=function(e){if(e.length>32768&&r)return n(new Buffer(e));for(var i=-1,a=e.length-1,o=0;o<a;)i=t[255&(i^e.charCodeAt(o++))]^i>>>8,i=t[255&(i^e.charCodeAt(o++))]^i>>>8;return o===a&&(i=i>>>8^t[255&(i^e.charCodeAt(o))]),-1^i},e.buf=function(e){if(e.length>1e4)return n(e);for(var r=-1,i=0,a=e.length-3;i<a;)r=(r=(r=(r=r>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])];for(;i<a+3;)r=r>>>8^t[255&(r^e[i++])];return-1^r},e.str=function(e){for(var r,n,i=-1,a=0,o=e.length;a<o;)(r=e.charCodeAt(a++))<128?i=i>>>8^t[255&(i^r)]:r<2048?i=(i=i>>>8^t[255&(i^(192|r>>6&31))])>>>8^t[255&(i^(128|63&r))]:r>=55296&&r<57344?(r=64+(1023&r),n=1023&e.charCodeAt(a++),i=(i=(i=(i=i>>>8^t[255&(i^(240|r>>8&7))])>>>8^t[255&(i^(128|r>>2&63))])>>>8^t[255&(i^(128|n>>6&15|3&r))])>>>8^t[255&(i^(128|63&n))]):i=(i=(i=i>>>8^t[255&(i^(224|r>>12&15))])>>>8^t[255&(i^(128|r>>6&63))])>>>8^t[255&(i^(128|63&r))];return-1^i}},"undefined"==typeof DO_NOT_EXPORT_CRC?r(t):r({})},601(e){e.exports=function(e){return e[1]}},628(e){e.exports=function(e){e.data&&e.name&&(e=e.data);for(var t=!0,r="",n="",i=0;i<e.length;i++){var a=e[i];if(t)a?n+=String.fromCharCode(a):t=!1;else{if(!a)throw new Error("Invalid NULL character found. 0x00 character is not permitted in tEXt content");r+=String.fromCharCode(a)}}return{keyword:n,text:r}}},659(e){var t={};e.exports=function(e,r){var n=function(e){if(void 0===t[e]){var r=document.querySelector(e);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}t[e]=r}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(r)}},691(e,t,r){r.d(t,{tB:()=>o,lp:()=>a,WC:()=>s,L$:()=>c,a$:()=>l,_j:()=>i,Gv:()=>d,$q:()=>F,QO:()=>Y,wI:()=>D,mW:()=>B,SK:()=>b,Bx:()=>G,bA:()=>H,mt:()=>p,hu:()=>v,sR:()=>y,PL:()=>_,Tx:()=>f,UN:()=>u,DV:()=>M,aQ:()=>q,RC:()=>h,Fc:()=>U,iO:()=>J,G1:()=>V,tH:()=>Q});var n=r(313);const i={promptPresetId:null,customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},a="You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",o="You are refining a character card based on analysis feedback. Address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",s=[{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided.\n\nFor each field:\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Suggestions** - Concrete changes\n\nThen provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback only."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address weaknesses while preserving strengths.\n\nGuidelines:\n- Maintain core personality and unique traits\n- Improve weak areas from feedback\n- Keep similar length unless noted\n- Preserve distinctive voice/style\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\n**ACCEPT** (ready), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"}],c=[{id:"builtin_schema_score",name:"Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Analyze Schema",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issues:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulScore","soulAssessment","verdict","issues","recommendations"]}}}],l={version:n.$G,baseSystemPrompt:a,userSystemPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},baseRefinementPrompt:o,userRefinementPrompt:"",stageDefaults:{score:Object.assign(Object.assign({},i),{promptPresetId:"builtin_score_default"}),rewrite:Object.assign(Object.assign({},i),{promptPresetId:"builtin_rewrite_default"}),analyze:Object.assign(Object.assign({},i),{promptPresetId:"builtin_analyze_default"})},promptPresets:[...s],schemaPresets:[...c],generationMode:"current",profileId:null,maxTokensOverride:null,debugMode:!1};function d(e,t,r){return{id:e,characterId:t,characterName:r,createdAt:Date.now(),updatedAt:Date.now(),stageFields:{base:{},linked:!0,overrides:{}},originalData:{},configs:{score:Object.assign({},i),rewrite:Object.assign({},i),analyze:Object.assign({},i)},history:[],iterationCount:0,status:"active",version:n.F}}function p(){var e;const t=SillyTavern.getContext(),{lodash:r}=SillyTavern.libs,i=t.extensionSettings;if(!i[n.pW])return i[n.pW]=r.cloneDeep(l),u(),i[n.pW];const a=i[n.pW],o=null!==(e=a.version)&&void 0!==e?e:0;if(o<n.$G){!function(e,t){for(let r=t+1;r<=n.$G;r++){const t=m[r];t&&t(e)}}(a,o);const e=function(e){const{lodash:t}=SillyTavern.libs,r=e.promptPresets?[...e.promptPresets]:[],n=e.schemaPresets?[...e.schemaPresets]:[],i=t.merge(structuredClone(l),e);return i.promptPresets=r.length?r:[...l.promptPresets],i.schemaPresets=n.length?n:[...l.schemaPresets],i}(a);return e.version=n.$G,g(e),i[n.pW]=e,u(),e}const s=a;s.promptPresets||(s.promptPresets=[]),s.schemaPresets||(s.schemaPresets=[]);return g(s)&&u(),s}function u(){SillyTavern.getContext().saveSettingsDebounced()}function f(){const{lodash:e}=SillyTavern.libs,t=SillyTavern.getContext().extensionSettings;return t[n.pW]=e.cloneDeep(l),u(),t[n.pW]}const m={2:e=>{var t,r,n;e.stageDefaults||(e.stageDefaults={});const i=e.stageDefaults;(null===(t=i.score)||void 0===t?void 0:t.promptPresetId)||(i.score=Object.assign(Object.assign({},i.score||{}),{promptPresetId:"builtin_score_default"})),(null===(r=i.rewrite)||void 0===r?void 0:r.promptPresetId)||(i.rewrite=Object.assign(Object.assign({},i.rewrite||{}),{promptPresetId:"builtin_rewrite_default"})),(null===(n=i.analyze)||void 0===n?void 0:n.promptPresetId)||(i.analyze=Object.assign(Object.assign({},i.analyze||{}),{promptPresetId:"builtin_analyze_default"})),i.score&&(i.score.useStructuredOutput=!1),i.analyze&&(i.analyze.useStructuredOutput=!1)}};function g(e){const{lodash:t}=SillyTavern.libs;let r=!1;for(const n of s){const i=e.promptPresets.find(e=>e.id===n.id);i?i.version<n.version&&(Object.assign(i,t.cloneDeep(n)),r=!0):(e.promptPresets.push(t.cloneDeep(n)),r=!0)}for(const n of c){const i=e.schemaPresets.find(e=>e.id===n.id);i?i.version<n.version&&(Object.assign(i,t.cloneDeep(n)),r=!0):(e.schemaPresets.push(t.cloneDeep(n)),r=!0)}return r}function v(e){const{lodash:t}=SillyTavern.libs,r=p();return t.cloneDeep(r.stageDefaults[e])}function h(e,t){const{lodash:r}=SillyTavern.libs;p().stageDefaults[e]=r.cloneDeep(t),u()}function y(e){const t=p();return[t.baseSystemPrompt,t.userSystemPrompt,t.stageSystemPrompts[e]].filter(e=>e.trim()).join("\n\n")}function b(){const e=p();return[e.baseRefinementPrompt,e.userRefinementPrompt].filter(e=>e.trim()).join("\n\n")}const _=new class{constructor(){this.listeners=new Set,this.getPromptPresets=e=>{const t=p();return this.applyFilter(t.promptPresets,e)},this.getSchemaPresets=e=>{const t=p();return this.applyFilter(t.schemaPresets,e)},this.getPromptPreset=e=>{var t;return null!==(t=p().promptPresets.find(t=>t.id===e))&&void 0!==t?t:null},this.getSchemaPreset=e=>{var t;return null!==(t=p().schemaPresets.find(t=>t.id===e))&&void 0!==t?t:null},this.getPresetsForStage=(e,t)=>"prompt"===e?this.getPromptPresets({stage:t}):this.getSchemaPresets({stage:t}),this.exists=(e,t)=>"prompt"===e?null!==this.getPromptPreset(t):null!==this.getSchemaPreset(t),this.isBuiltin=(e,t)=>{var r;const n="prompt"===e?this.getPromptPreset(t):this.getSchemaPreset(t);return null!==(r=null==n?void 0:n.isBuiltin)&&void 0!==r&&r},this.registerPromptPreset=e=>{const t=p(),r=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.promptPresets.push(r),u(),this.emit({type:"add",presetType:"prompt",preset:r}),r},this.registerSchemaPreset=e=>{const t=p(),r=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.schemaPresets.push(r),u(),this.emit({type:"add",presetType:"schema",preset:r}),r},this.updatePromptPreset=(e,t)=>{const r=p().promptPresets.find(t=>t.id===e);if(!r||r.isBuiltin)return!1;const n=Object.assign({},r);return Object.assign(r,t,{updatedAt:Date.now()}),u(),this.emit({type:"update",presetType:"prompt",preset:r,previousValue:n}),!0},this.updateSchemaPreset=(e,t)=>{const r=p().schemaPresets.find(t=>t.id===e);if(!r||r.isBuiltin)return!1;const n=Object.assign({},r);return Object.assign(r,t,{updatedAt:Date.now()}),u(),this.emit({type:"update",presetType:"schema",preset:r,previousValue:n}),!0},this.deletePromptPreset=e=>{const t=p(),r=t.promptPresets.findIndex(t=>t.id===e&&!t.isBuiltin);if(-1===r)return!1;const[n]=t.promptPresets.splice(r,1);return u(),this.emit({type:"delete",presetType:"prompt",preset:n}),!0},this.deleteSchemaPreset=e=>{const t=p(),r=t.schemaPresets.findIndex(t=>t.id===e&&!t.isBuiltin);if(-1===r)return!1;const[n]=t.schemaPresets.splice(r,1);return u(),this.emit({type:"delete",presetType:"schema",preset:n}),!0},this.duplicatePromptPreset=(e,t)=>{const r=this.getPromptPreset(e);if(!r)return null;const n=t||`${r.name} (Copy)`;return this.registerPromptPreset({name:n,stages:[...r.stages],prompt:r.prompt})},this.duplicateSchemaPreset=(e,t)=>{const r=this.getSchemaPreset(e);if(!r)return null;const{lodash:n}=SillyTavern.libs,i=t||`${r.name} (Copy)`;return this.registerSchemaPreset({name:i,stages:[...r.stages],schema:n.cloneDeep(r.schema)})},this.subscribe=e=>(this.listeners.add(e),()=>this.listeners.delete(e)),this.isNameUnique=(e,t,r)=>!("prompt"===e?this.getPromptPresets():this.getSchemaPresets()).some(e=>e.name.toLowerCase()===t.toLowerCase()&&e.id!==r),this.generateUniquePresetName=(e,t)=>{const r="prompt"===e?this.getPromptPresets().map(e=>e.name):this.getSchemaPresets().map(e=>e.name);return(0,n.Sn)(t,r)},this.getDisplayName=(e,t)=>{if(!t)return"Custom";const r="prompt"===e?this.getPromptPreset(t):this.getSchemaPreset(t);return r?r.isBuiltin?`${r.name} (builtin)`:r.name:"Unknown"}}applyFilter(e,t){return t?e.filter(e=>{if(t.stage){if(!(0===e.stages.length||e.stages.includes(t.stage)))return!1}return!(t.builtinOnly&&!e.isBuiltin)&&(!t.userOnly||!e.isBuiltin)}):e}emit(e){for(const t of this.listeners)try{t(e)}catch(e){n.Rm.error("PresetRegistry listener error:",e)}}},{getPromptPresets:x,getSchemaPresets:w,getPromptPreset:$,getSchemaPreset:k,getPresetsForStage:S,registerPromptPreset:P,registerSchemaPreset:R,updatePromptPreset:E,updateSchemaPreset:A,deletePromptPreset:C,deleteSchemaPreset:I,duplicatePromptPreset:z,duplicateSchemaPreset:O,isNameUnique:T,generateUniquePresetName:W,getDisplayName:N,subscribe:L}=_;var j=r(374);function B(e){return x({stage:e})}function D(e){return $(e)}function M(e){return P(e)}function U(e,t){return E(e,t)}function F(e){return C(e)}function H(e){return w({stage:e})}function G(e){return k(e)}function q(e){return R(e)}function J(e,t){return A(e,t)}function Y(e){return I(e)}function V(e){var t,r;const n=[],i=[];return(null===(t=e.name)||void 0===t?void 0:t.trim())?e.name.length>100&&n.push("Name must be 100 characters or less"):n.push("Name is required"),(null===(r=e.prompt)||void 0===r?void 0:r.trim())?e.prompt.length>5e4&&n.push("Prompt is too long (max 50,000 characters)"):n.push("Prompt is required"),e.prompt&&/\{\{user\}\}/i.test(e.prompt)&&i.push("{{user}} is not replaced - user persona is not relevant to card analysis"),{valid:0===n.length,errors:n,warnings:i}}function Q(e){var t;const r=[],n=[];if((null===(t=e.name)||void 0===t?void 0:t.trim())?e.name.length>100&&r.push("Name must be 100 characters or less"):r.push("Name is required"),e.schema){const t="string"==typeof e.schema?e.schema:JSON.stringify(e.schema),i=(0,j.i6)(t);i.valid||r.push(i.error||"Invalid schema"),i.warnings&&n.push(...i.warnings)}else r.push("Schema is required");return{valid:0===r.length,errors:r,warnings:n}}},737(e,t,r){r.d(t,{BASE_REFINEMENT_PROMPT:()=>n.tB,BASE_SYSTEM_PROMPT:()=>n.lp,BUILTIN_PROMPT_PRESETS:()=>n.WC,BUILTIN_SCHEMA_PRESETS:()=>n.L$,DEFAULT_SETTINGS:()=>n.a$,DEFAULT_STAGE_CONFIG:()=>n._j,clearCache:()=>s,createDefaultSession:()=>n.Gv,createSession:()=>x,deleteAllSessionsForCharacter:()=>k,deletePromptPreset:()=>n.$q,deleteSchemaPreset:()=>n.QO,deleteSession:()=>$,getPromptPreset:()=>n.wI,getPromptPresetsForStage:()=>n.mW,getRefinementPrompt:()=>n.SK,getSchemaPreset:()=>n.Bx,getSchemaPresetsForStage:()=>n.bA,getSession:()=>_,getSessionsForCharacter:()=>b,getSettings:()=>n.mt,getStageDefaults:()=>n.hu,getSystemPrompt:()=>n.sR,presetRegistry:()=>n.PL,purgeAllSessions:()=>S,resetSettings:()=>n.Tx,save:()=>n.UN,savePromptPreset:()=>n.DV,saveSchemaPreset:()=>n.aQ,setStageDefaults:()=>n.RC,updatePromptPreset:()=>n.Fc,updateSchemaPreset:()=>n.iO,updateSession:()=>w,validatePromptPreset:()=>n.G1,validateSchemaPreset:()=>n.tH}),r.r(t);var n=r(691);let i=null,a=null,o=null;function s(){i=null,a=null,o=null}function c(){return i}function l(){return a}function d(e){a=e}function p(e){o=e}var u=r(313),f=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function m(){return f(this,void 0,void 0,function*(){if(o)return o;const e=yield(0,u.Ar)(u.d5.STORAGE_META);if(!e){const e={version:u.F,lastMigration:Date.now()};return p(e),yield(0,u.RG)(u.d5.STORAGE_META,e),e}return e.version!==u.F&&(yield function(e){return f(this,void 0,void 0,function*(){var t;const r=null!==(t=e.version)&&void 0!==t?t:0;if(r<2){const e=yield(0,u.Ar)(u.d5.SESSIONS);if(e){let t=!1;for(const r of Object.values(e))if(!r.stageFields&&r.selectedFields){const e=r.selectedFields;r.stageFields={base:e,linked:!0,overrides:{}},delete r.selectedFields,t=!0}t&&(yield(0,u.RG)(u.d5.SESSIONS,e))}}e.version=u.F,e.lastMigration=Date.now(),yield(0,u.RG)(u.d5.STORAGE_META,e)})}(e)),p(e),e})}function g(){return f(this,void 0,void 0,function*(){const e=c();if(e)return e;yield m();const t=yield(0,u.Ar)(u.d5.SESSIONS),r=new Map(Object.entries(null!=t?t:{}));return function(e){i=e}(r),r})}function v(){return f(this,void 0,void 0,function*(){var e;const t=l();if(t)return t;yield m();const r=null!==(e=yield(0,u.Ar)(u.d5.SESSION_INDEX))&&void 0!==e?e:{};return d(r),r})}function h(){return f(this,void 0,void 0,function*(){const e=c();if(!e)return u.Rm.warn("saveSessions: No cache to save"),!1;const t=yield(0,u.RG)(u.d5.SESSIONS,Object.fromEntries(e));return t||u.Rm.error("Failed to save sessions to storage"),t})}function y(){return f(this,void 0,void 0,function*(){const e=l();if(!e)return u.Rm.warn("saveIndex: No cache to save"),!1;const t=yield(0,u.RG)(u.d5.SESSION_INDEX,e);return t||u.Rm.error("Failed to save index to storage"),t})}function b(e){return f(this,void 0,void 0,function*(){var t;const r=yield g();return(null!==(t=(yield v())[e])&&void 0!==t?t:[]).map(e=>r.get(e)).filter(e=>void 0!==e)})}function _(e){return f(this,void 0,void 0,function*(){var t;return null!==(t=(yield g()).get(e))&&void 0!==t?t:null})}function x(e){return f(this,void 0,void 0,function*(){const{characterId:t,characterName:r,stageFields:i,originalData:a,configs:o}=e,s=yield g(),c=yield v(),l=SillyTavern.libs.lodash,d=(0,n.Gv)(crypto.randomUUID(),t,r);if(d.stageFields=l.cloneDeep(i),d.originalData=l.cloneDeep(a),d.configs=l.cloneDeep(o),s.set(d.id,d),c[t]||(c[t]=[]),c[t].unshift(d.id),c[t].length>u.Nf){const e=c[t].splice(u.Nf);for(const t of e)s.delete(t)}return yield h(),yield y(),d})}function w(e){return f(this,void 0,void 0,function*(){const t=yield g();if(!t.has(e.id))throw new Error(`Cannot update non-existent session: ${e.id}`);e.updatedAt=Date.now(),t.set(e.id,e),yield h()})}function $(e){return f(this,void 0,void 0,function*(){const t=yield g(),r=yield v(),n=t.get(e);if(!n)return u.Rm.warn("deleteSession: Session not found:",e),!1;t.delete(e);const i=r[n.characterId];if(i){const t=i.indexOf(e);-1!==t&&i.splice(t,1),0===i.length&&delete r[n.characterId]}const a=yield h(),o=yield y();return a&&o?(u.Rm.debug("Session deleted:",e),!0):(u.Rm.error("deleteSession: Failed to persist deletion"),!1)})}function k(e){return f(this,void 0,void 0,function*(){var t;const r=yield g(),n=yield v(),i=null!==(t=n[e])&&void 0!==t?t:[],a=i.length;if(0===a)return{success:!0,count:0};for(const e of i)r.delete(e);delete n[e];const o=yield h(),s=yield y();return o&&s?(u.Rm.debug(`Deleted ${a} sessions for character:`,e),{success:!0,count:a}):(u.Rm.error("deleteAllSessionsForCharacter: Failed to persist"),{success:!1,count:0})})}function S(){return f(this,void 0,void 0,function*(){const e=yield g(),t=e.size;if(0===t)return{success:!0,count:0};e.clear(),d({});const r=yield h(),n=yield y();return r&&n?(u.Rm.info(`Deleted ALL ${t} sessions`),{success:!0,count:t}):(u.Rm.error("deleteAllSessions: Failed to persist"),{success:!1,count:0})})}},805(e,t,r){r.d(t,{A:()=>u});var n=r(601),i=r.n(n),a=r(314),o=r.n(a),s=r(417),c=r.n(s),l=new URL(r(242),r.b),d=o()(i()),p=c()(l);d.push([e.id,`.cr-apply-dialog,.cr-drawer,.cr-popup{--cr-bg:var(--SmartThemeBlurTintColor);--cr-bg-secondary:var(--black30a,rgba(0,0,0,.3));--cr-bg-tertiary:var(--black50a,rgba(0,0,0,.5));--cr-bg-elevated:color-mix(in srgb,var(--SmartThemeBlurTintColor) 90%,#fff 10%);--cr-text:var(--SmartThemeBodyColor);--cr-text-muted:color-mix(in srgb,var(--SmartThemeBodyColor) 70%,transparent);--cr-text-dim:color-mix(in srgb,var(--SmartThemeBodyColor) 50%,transparent);--cr-border:var(--SmartThemeBorderColor);--cr-border-muted:color-mix(in srgb,var(--SmartThemeBorderColor) 50%,transparent);--cr-accent:var(--SmartThemeQuoteColor);--cr-accent-hover:color-mix(in srgb,var(--SmartThemeQuoteColor) 80%,#fff);--cr-accent-muted:color-mix(in srgb,var(--SmartThemeQuoteColor) 30%,transparent);--cr-success:var(--okGreen70a,#4caf50);--cr-success-bg:color-mix(in srgb,var(--okGreen70a,#4caf50) 15%,transparent);--cr-warning:var(--golden,#ff9800);--cr-warning-bg:color-mix(in srgb,var(--golden,#ff9800) 15%,transparent);--cr-danger:var(--fullred,#f44336);--cr-danger-bg:color-mix(in srgb,var(--fullred,#f44336) 15%,transparent);--cr-space-1:0.25rem;--cr-space-2:0.5rem;--cr-space-3:0.75rem;--cr-space-4:1rem;--cr-space-5:1.25rem;--cr-space-6:1.5rem;--cr-space-8:2rem;--cr-space-12:3rem;--cr-font:var(--mainFontFamily,system-ui,-apple-system,sans-serif);--cr-font-mono:var(--monoFontFamily,"Consolas","Monaco",monospace);--cr-font-size:var(--mainFontSize,1rem);--cr-text-xs:calc(var(--cr-font-size) * 0.75);--cr-text-sm:calc(var(--cr-font-size) * 0.875);--cr-text-base:var(--cr-font-size);--cr-text-lg:calc(var(--cr-font-size) * 1.125);--cr-text-xl:calc(var(--cr-font-size) * 1.25);--cr-radius-sm:4px;--cr-radius:8px;--cr-radius-lg:12px;--cr-radius-pill:9999px;--cr-shadow-sm:0 1px 3px var(--black30a,rgba(0,0,0,.3));--cr-shadow:0 4px 12px var(--black30a,rgba(0,0,0,.3));--cr-shadow-md:0 4px 12px rgba(0,0,0,.15);--cr-shadow-lg:0 8px 24px var(--black50a,rgba(0,0,0,.5));--cr-shadow-drawer:-4px 0 24px rgba(0,0,0,.4);--cr-backdrop:rgba(0,0,0,.6);--cr-backdrop-blur:blur(4px);--cr-transition-fast:var(--animation-duration,150ms) ease;--cr-transition:var(--animation-duration-slow,300ms) ease;--cr-panel-min:280px;--cr-panel-max:480px;--cr-header-height:48px;--cr-avatar-size:48px;--cr-avatar-size-sm:32px;--cr-icon-size:24px;--cr-icon-size-sm:18px;--cr-score-high:#10b981;--cr-score-good:#22c55e;--cr-score-mid:#eab308;--cr-score-low:#f97316;--cr-score-bad:#ef4444}.cr-popup{font-family:var(--cr-font);font-size:var(--cr-font-size);color:var(--cr-text);line-height:1.5;box-sizing:border-box}.cr-popup *,.cr-popup :after,.cr-popup :before{box-sizing:inherit}.cr-popup h2,.cr-popup h3{margin:0;font-weight:600;line-height:1.3;color:var(--cr-text)}.cr-popup h2{font-size:var(--cr-text-lg)}.cr-popup h3{font-size:var(--cr-text-base)}.cr-popup a{color:var(--cr-accent);text-decoration:none}.cr-popup a:hover{text-decoration:underline}.cr-stack{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-row,.cr-stack--tight{gap:var(--cr-space-2)}.cr-row{display:flex;flex-direction:row;align-items:center}.cr-row--between{justify-content:space-between}.cr-flex-1{flex:1 1 0%}.cr-gap-1{gap:var(--cr-space-1)}.cr-gap-2{gap:var(--cr-space-2)}.cr-mt-2{margin-top:var(--cr-space-2)}.cr-mt-4{margin-top:var(--cr-space-4)}.cr-mb-3{margin-bottom:var(--cr-space-3)}.cr-scrollable{overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-scrollable::-webkit-scrollbar{width:6px;height:6px}.cr-scrollable::-webkit-scrollbar-track{background:transparent}.cr-scrollable::-webkit-scrollbar-thumb{background:var(--cr-border);border-radius:var(--cr-radius-pill)}.cr-scrollable::-webkit-scrollbar-thumb:hover{background:var(--cr-accent)}.cr-text-dim{color:var(--cr-text-dim)}.cr-text-accent{color:var(--cr-accent)}.cr-text-success{color:var(--cr-success)}.cr-text-danger{color:var(--cr-danger)}.cr-text-xs{font-size:var(--cr-text-xs)}.cr-text-sm{font-size:var(--cr-text-sm)}.cr-text-right{text-align:right}.cr-font-medium{font-weight:500}.cr-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-hidden{display:none!important}.cr-popup{display:flex;flex-direction:column;width:100%;height:100%;min-height:0;background:var(--cr-bg);overflow:hidden}.popup:has(.cr-popup){width:95dvw;max-width:1200px;height:90dvh;max-height:none;padding:0;border-radius:var(--cr-radius-lg);overflow:hidden}.popup:has(.cr-popup)>div:first-child{display:flex;flex-direction:column;height:100%;padding:0;margin:0}@media (max-width:768px){.popup:has(.cr-popup){width:100dvw;height:100dvh;max-width:none;border-radius:0}}.cr-body{display:flex;flex-direction:column;flex:1;min-height:0}@media (min-width:769px){.cr-body{flex-direction:row}}.cr-panel{display:flex;flex-direction:column;min-height:0;min-width:0}.cr-panel--config{flex:1 1 auto;border-bottom:1px solid var(--cr-border-muted);overflow-y:auto}@media (min-width:769px){.cr-panel--config{flex:0 0 clamp(var(--cr-panel-min),38%,var(--cr-panel-max));border-bottom:none;border-right:1px solid var(--cr-border-muted)}}.cr-panel--results{flex:1 1 auto;overflow:hidden}@media (min-width:769px){.cr-panel--results{flex:1 1 62%}}.cr-section{display:flex;flex-direction:column;gap:var(--cr-space-3);padding:var(--cr-space-3);padding-top:0;border-bottom:1px solid var(--cr-border)}.cr-section:last-child{border-bottom:none}.cr-section__header{justify-content:space-between;margin:0 calc(-1 * var(--cr-space-3));margin-bottom:0;padding:var(--cr-space-2) var(--cr-space-3);min-height:40px;background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted)}.cr-section__header,.cr-section__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-section__title{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);text-transform:uppercase;letter-spacing:.025em}.cr-section__title i{color:var(--cr-accent);font-size:var(--cr-text-sm);width:1.25em;text-align:center}.cr-card{background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);overflow:hidden}.cr-card--selected{background:var(--cr-accent-muted);border-color:var(--cr-accent)}.cr-header{position:relative;z-index:100;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;min-height:var(--cr-header-height);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;gap:var(--cr-space-2) var(--cr-space-3)}@media (max-width:768px){.cr-header{grid-template-columns:auto 1fr auto;padding:var(--cr-space-2);gap:var(--cr-space-2)}}.cr-header__left{display:flex;align-items:center;justify-content:flex-start;gap:var(--cr-space-3)}.cr-header__left .cr-dropdown{flex:1;min-width:0;max-width:none}.cr-header__center{display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);min-width:0}.cr-header__center i{color:var(--cr-accent);font-size:var(--cr-text-lg)}@media (max-width:768px){.cr-header__center i{display:none}}.cr-header__center h2{font-size:var(--cr-text-base);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}@media (max-width:768px){.cr-header__center h2{font-size:var(--cr-text-sm)}}.cr-header__right{justify-content:flex-end;gap:var(--cr-space-2)}.cr-header__right,.cr-toolbar{display:flex;align-items:center}.cr-toolbar{justify-content:space-between;gap:var(--cr-space-2) var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:900px){.cr-toolbar{gap:var(--cr-space-2)}}.cr-toolbar__controls{flex-shrink:0}.cr-pipeline-controls,.cr-toolbar__controls{display:flex;align-items:center;gap:var(--cr-space-2);flex-wrap:wrap}.cr-pipeline-controls--generating{padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-radius:var(--cr-radius)}.cr-pipeline-status{font-size:var(--cr-text-sm);color:var(--cr-accent)}.cr-iteration-controls,.cr-pipeline-status{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-iteration-controls{margin-left:var(--cr-space-2);padding-left:var(--cr-space-2);border-left:1px solid var(--cr-border-muted)}@media (max-width:768px){.cr-iteration-controls{margin-left:0;padding-left:0;border-left:none;width:100%;flex:1 1 100%}}.cr-iteration-controls__input{width:120px;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);transition:border-color var(--cr-transition-fast),width var(--cr-transition-fast)}@media (max-width:768px){.cr-iteration-controls__input{flex:1;width:auto;min-width:0}}.cr-iteration-controls__input:focus{border-color:var(--cr-accent);outline:none;width:180px}@media (max-width:768px){.cr-iteration-controls__input:focus{width:auto}}.cr-iteration-controls__input::-moz-placeholder{color:var(--cr-text-muted)}.cr-iteration-controls__input::placeholder{color:var(--cr-text-muted)}.cr-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-stage-tabs{display:flex;gap:var(--cr-space-1);flex:1 1 auto;min-width:-moz-fit-content;min-width:fit-content}@media (max-width:768px){.cr-stage-tabs{gap:0}}.cr-stage-tab{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);white-space:nowrap}@media (max-width:768px){.cr-stage-tab{flex:1;justify-content:center;padding:var(--cr-space-2);font-size:var(--cr-text-xs);gap:var(--cr-space-1)}}.cr-stage-tab:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}.cr-stage-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-stage-tab__icon{font-size:1em;flex-shrink:0}.cr-stage-tab__label{flex:1 1 auto;min-width:-moz-max-content;min-width:max-content}@media (max-width:768px){.cr-stage-tab__label{display:none}}.cr-stage-tab__status{display:flex;align-items:center;justify-content:center;width:1.25em;height:1.25em;font-size:.75em;border-radius:50%;flex-shrink:0}.cr-stage-tab--running .cr-stage-tab__status{color:var(--cr-accent)}.cr-stage-tab--complete .cr-stage-tab__status{color:var(--cr-success);background:var(--cr-success-bg)}.cr-stage-tab--error .cr-stage-tab__status{color:var(--cr-danger);background:var(--cr-danger-bg)}.cr-dropdown{position:relative;min-width:200px;max-width:280px}@media (max-width:768px){.cr-dropdown{min-width:140px;max-width:220px}}.cr-dropdown--session{min-width:180px}@media (max-width:768px){.cr-dropdown--session{min-width:120px}}.cr-dropdown--disabled .cr-dropdown__trigger{opacity:.5;cursor:not-allowed}.cr-dropdown--open .cr-dropdown__trigger{border-color:var(--cr-accent);border-bottom-left-radius:0;border-bottom-right-radius:0}.cr-dropdown--open .cr-dropdown__trigger-chevron{transform:rotate(180deg)}.cr-dropdown--open .cr-dropdown__panel{display:flex}.cr-dropdown__trigger{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);color:var(--cr-text);background:var(--cr-bg);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-dropdown__trigger:hover{border-color:var(--cr-accent)}.cr-dropdown__trigger--session{gap:var(--cr-space-2)}.cr-dropdown__trigger-avatar{width:var(--cr-icon-size);height:var(--cr-icon-size);border-radius:var(--cr-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.cr-dropdown__trigger-icon{width:var(--cr-icon-size);text-align:center;color:var(--cr-text-muted);flex-shrink:0}.cr-dropdown__trigger-text{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-dropdown__trigger-text--placeholder{color:var(--cr-text-muted)}.cr-dropdown__trigger-chevron{font-size:.75em;color:var(--cr-text-muted);transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-dropdown__count{background:var(--cr-accent-muted);color:var(--cr-accent);padding:var(--cr-space-1) var(--cr-space-2);border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);font-weight:600}.cr-dropdown__panel{position:absolute;top:100%;left:0;right:0;min-width:320px;z-index:1000;display:none;flex-direction:column;background:var(--SmartThemeChatBg,#1a1a1a);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--cr-accent);border-top:none;border-bottom-left-radius:var(--cr-radius);border-bottom-right-radius:var(--cr-radius);box-shadow:var(--cr-shadow-lg);max-height:400px;overflow:hidden}@media (max-width:768px){.cr-dropdown__panel{min-width:280px;max-height:350px}}.cr-dropdown__panel--session{min-width:280px;max-height:320px}@media (max-width:768px){.cr-dropdown__panel--session{min-width:240px;max-height:280px}}.cr-dropdown__search{position:relative;padding:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted)}.cr-dropdown__search-icon{position:absolute;left:calc(var(--cr-space-2) + var(--cr-space-2));top:50%;transform:translateY(-50%);color:var(--cr-text-muted);font-size:var(--cr-text-xs);pointer-events:none}.cr-dropdown__search-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);padding-left:calc(var(--cr-space-3) * 2 + .75em);font-size:var(--cr-text-sm);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-dropdown__search-input:focus{border-color:var(--cr-accent);outline:none}.cr-dropdown__search-clear{position:absolute;right:calc(var(--cr-space-2) + var(--cr-space-1));top:50%;transform:translateY(-50%);padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;opacity:.7}.cr-dropdown__search-clear:hover{opacity:1;color:var(--cr-text)}.cr-dropdown__list{flex:1;overflow-y:auto;max-height:320px;padding:var(--cr-space-2);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-dropdown__list--session{max-height:220px}.cr-dropdown__empty{padding:var(--cr-space-6);text-align:center;font-size:var(--cr-text-sm);color:var(--cr-text-muted)}.cr-dropdown__empty i{display:block;font-size:2em;margin-bottom:var(--cr-space-2);opacity:.5}.cr-dropdown__footer{display:flex;gap:var(--cr-space-2);padding:var(--cr-space-2);border-top:1px solid var(--cr-border-muted)}.cr-dropdown__new-btn{flex:1;justify-content:center}.cr-dropdown__delete-all-btn{color:var(--cr-danger);flex-shrink:0}.cr-dropdown__delete-all-btn:hover{background:color-mix(in srgb,var(--cr-danger) 15%,transparent)}.cr-char-option{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);cursor:pointer;border-radius:var(--cr-radius);background:var(--cr-bg-secondary);border:1px solid transparent;transition:background var(--cr-transition-fast),border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast),transform var(--cr-transition-fast)}.cr-char-option:hover{background:var(--cr-bg-tertiary);border-color:var(--cr-border);transform:translateX(var(--cr-space-1))}.cr-char-option--selected{border-color:var(--cr-accent)}.cr-char-option--selected,.cr-char-option--selected:hover{background:var(--cr-accent-muted)}.cr-char-option--highlighted{background:var(--cr-bg-tertiary);border-color:var(--cr-accent);box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-char-option__avatar-wrap{position:relative;flex-shrink:0}.cr-char-option__avatar{width:var(--cr-avatar-size);height:var(--cr-avatar-size);border-radius:var(--cr-radius);-o-object-fit:cover;object-fit:cover;border:2px solid var(--cr-border-muted);transition:border-color var(--cr-transition-fast)}.cr-char-option--selected .cr-char-option__avatar,.cr-char-option:hover .cr-char-option__avatar{border-color:var(--cr-accent)}.cr-char-option__check{position:absolute;bottom:-4px;right:-4px;width:var(--cr-icon-size-sm);height:var(--cr-icon-size-sm);display:flex;align-items:center;justify-content:center;background:var(--cr-accent);color:var(--cr-bg);border-radius:50%;font-size:var(--cr-text-xs);box-shadow:var(--cr-shadow-sm)}.cr-char-option__info{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-char-option__name{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-char-option__desc{font-size:var(--cr-text-xs);color:var(--cr-text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.cr-char-option__meta{display:flex;align-items:center;gap:var(--cr-space-1);font-size:var(--cr-text-xs);color:var(--cr-text-muted);margin-top:var(--cr-space-1)}.cr-char-option__meta i{font-size:.75em;opacity:.7}.cr-session-option{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background var(--cr-transition-fast)}.cr-session-option:last-child{border-bottom:none}.cr-session-option:hover{background:var(--cr-bg-tertiary)}.cr-session-option--active,.cr-session-option--active:hover{background:var(--cr-accent-muted)}.cr-session-option__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-session-option__name{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cr-session-option__indicator{font-size:.5em;color:var(--cr-accent);flex-shrink:0}.cr-session-option__name-input{flex:1;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-sm);border:1px solid var(--cr-accent);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);outline:none}.cr-session-option__name-input:focus{box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-session-option__meta{display:flex;gap:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-session-option__meta span:after{content:"";margin-left:var(--cr-space-2);opacity:.5}.cr-session-option__meta span:last-child:after{display:none}.cr-session-option__actions{display:flex;gap:var(--cr-space-1);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-session-option__actions--editing{opacity:1}.cr-session-option__actions .menu_button--ghost{padding:var(--cr-space-1)}.cr-session-option__actions .menu_button--ghost:hover{background:var(--cr-bg-secondary)}.cr-session-option__actions .cr-session-delete:hover{color:var(--cr-danger)}.cr-session-option:hover .cr-session-option__actions{opacity:1}@media (max-width:768px){.cr-session-option__actions{opacity:1}}.cr-popup input[type=number],.cr-popup input[type=search],.cr-popup input[type=text],.cr-popup select,.cr-popup textarea{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);transition:border-color var(--cr-transition-fast)}.cr-popup input[type=number]:focus,.cr-popup input[type=search]:focus,.cr-popup input[type=text]:focus,.cr-popup select:focus,.cr-popup textarea:focus{border-color:var(--cr-accent);outline:none}.cr-popup textarea{min-height:100px;resize:vertical;line-height:1.5}.cr-popup textarea.cr-textarea--code{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs)}:is(.cr-popup,.cr-drawer) input[type=checkbox]{width:16px!important;height:16px!important;min-width:16px;min-height:16px;padding:0;margin:0;-webkit-appearance:auto;-moz-appearance:auto;appearance:auto;accent-color:var(--cr-accent);cursor:pointer;flex-shrink:0;opacity:1;visibility:visible}.cr-checkbox{display:flex;align-items:center;gap:var(--cr-space-2);cursor:pointer;font-size:var(--cr-text-sm)}.cr-checkbox input[type=checkbox]{width:16px!important;height:16px!important;accent-color:var(--cr-accent)}.cr-form-group{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-form-group__hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-form-group--grow{flex:1;display:flex;flex-direction:column;min-height:0}.cr-select{width:auto;min-width:140px;max-width:180px;padding:var(--cr-space-1) var(--cr-space-6) var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:border-color var(--cr-transition-fast);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;-moz-appearance:none!important;appearance:none!important;-webkit-appearance:none!important;background-image:url(${p})!important;background-repeat:no-repeat!important;background-position:right var(--cr-space-2) center!important;background-size:12px!important;padding-right:var(--cr-space-6)!important}.cr-select:focus,.cr-select:hover{border-color:var(--cr-accent);outline:none}.cr-textarea--editor{width:100%;height:100%;min-height:200px;resize:vertical;font-family:var(--cr-font);font-size:var(--cr-text-sm);line-height:1.6}.cr-textarea--compact{min-height:60px}.cr-editor-wrap{position:relative;flex:1;min-height:200px}.cr-editor-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border-muted);border-bottom:none;border-radius:var(--cr-radius) var(--cr-radius) 0 0}.cr-toolbar-divider{width:1px;height:1.5em;background:var(--cr-border-muted);margin:0 var(--cr-space-1)}.cr-code-editor{position:relative;flex:1;min-height:250px;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;border:1px solid var(--cr-border);border-top:none;border-radius:0 0 var(--cr-radius) var(--cr-radius);overflow:hidden}.cr-code-editor__highlight,.cr-code-editor__textarea{position:absolute;inset:0;margin:0;padding:var(--cr-space-3);font-family:inherit;font-size:inherit;line-height:inherit;white-space:pre-wrap;word-wrap:break-word;overflow:auto}.cr-code-editor__highlight{pointer-events:none;background:var(--cr-bg-secondary);color:var(--cr-text)}.cr-code-editor__highlight code{font-family:inherit;background:transparent}.cr-code-editor__textarea{background:transparent;color:transparent;caret-color:var(--cr-text);resize:none;border:none;outline:none;z-index:1}.cr-code-editor__textarea::-moz-selection{background:var(--cr-accent-muted)}.cr-code-editor__textarea::selection{background:var(--cr-accent-muted)}:is(.cr-popup,.cr-drawer) .menu_button{display:inline-flex;align-items:center;justify-content:center;gap:var(--cr-space-1);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast);width:auto;min-width:auto;margin:0}:is(.cr-popup,.cr-drawer) .menu_button--icon{padding:var(--cr-space-2);aspect-ratio:1}:is(.cr-popup,.cr-drawer) .menu_button--sm{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs)}:is(.cr-popup,.cr-drawer) .menu_button--lg{padding:var(--cr-space-3) var(--cr-space-4);font-size:var(--cr-text-base)}:is(.cr-popup,.cr-drawer) .menu_button--full{width:100%}:is(.cr-popup,.cr-drawer) .menu_button--primary{background:var(--cr-accent);border-color:var(--cr-accent);color:var(--cr-bg);filter:none}:is(.cr-popup,.cr-drawer) .menu_button--primary:hover:not(:disabled){background:var(--cr-accent-hover);border-color:var(--cr-accent-hover);filter:none}:is(.cr-popup,.cr-drawer) .menu_button--danger{background:var(--cr-danger);border-color:var(--cr-danger);color:#fff;filter:none}:is(.cr-popup,.cr-drawer) .menu_button--danger:hover:not(:disabled){filter:brightness(1.1)}:is(.cr-popup,.cr-drawer) .menu_button--ghost{background:transparent;border-color:transparent}:is(.cr-popup,.cr-drawer) .menu_button--ghost:hover:not(:disabled){background:var(--cr-bg-secondary)}:is(.cr-popup,.cr-drawer) .menu_button--success{background:var(--cr-success);border-color:var(--cr-success);color:#fff;filter:none}:is(.cr-popup,.cr-drawer) .menu_button:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.5)}:is(.cr-popup,.cr-drawer) .menu_button:active:not(:disabled){transform:scale(.97)}:is(.cr-popup,.cr-drawer) .menu_button.cr-active{color:var(--cr-accent);background:var(--cr-accent-muted);border-color:var(--cr-accent)}:is(.cr-popup,.cr-drawer) .menu_button.cr-active:hover:not(:disabled){background:color-mix(in srgb,var(--cr-accent) 40%,transparent)}.cr-button-group{display:flex;gap:var(--cr-space-2)}.cr-field-list{flex-direction:column;gap:var(--cr-space-1);min-height:80px;max-height:280px;overflow-y:auto;background:var(--cr-bg-secondary);border-radius:var(--cr-radius) var(--cr-radius) 0 0;border:1px solid var(--cr-border-muted);border-bottom:none;text-align:left}.cr-field-list,.cr-field-total{display:flex;padding:var(--cr-space-2)}.cr-field-total{align-items:center;justify-content:space-between;gap:var(--cr-space-2);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border-muted);border-radius:0 0 var(--cr-radius) var(--cr-radius);font-size:var(--cr-text-xs)}.cr-field-total__label{color:var(--cr-text-muted)}.cr-field-total__value{font-weight:500;color:var(--cr-text);font-variant-numeric:tabular-nums}.cr-token-warning{display:flex;align-items:flex-start;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);margin-top:var(--cr-space-2);font-size:var(--cr-text-xs);line-height:1.4;border-radius:var(--cr-radius-sm)}.cr-token-warning i{flex-shrink:0;margin-top:.1em}.cr-token-warning--warning{color:var(--cr-warning);background:color-mix(in srgb,var(--cr-warning) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-warning) 30%,transparent)}.cr-token-warning--critical{color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-danger) 30%,transparent)}.cr-field-item{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);padding:var(--cr-space-2);border-radius:var(--cr-radius-sm);transition:background var(--cr-transition-fast)}.cr-field-item:hover{background:var(--cr-bg-tertiary)}.cr-field-label{display:flex;align-items:center;gap:var(--cr-space-2);flex:1;cursor:pointer;font-size:var(--cr-text-sm)}.cr-field-checkbox{width:auto!important;margin:0;accent-color:var(--cr-accent);cursor:pointer;flex-shrink:0}.cr-field-name{flex:1;color:var(--cr-text)}.cr-field-count,.cr-field-tokens{font-size:var(--cr-text-xs);color:var(--cr-text-dim);flex-shrink:0;min-width:2.5em;text-align:right}.cr-field-group{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm);overflow:hidden}.cr-field-group .cr-field-item--parent{background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted)}.cr-field-group .cr-field-children{display:none;padding:var(--cr-space-1);background:var(--cr-bg-secondary)}.cr-field-group--expanded .cr-field-children{display:block}.cr-field-group .cr-field-item--child{padding-left:var(--cr-space-4)}.cr-field-expand{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;transition:transform var(--cr-transition-fast)}.cr-field-expand:hover{color:var(--cr-text)}.cr-field-group--expanded .cr-field-expand{transform:rotate(180deg)}.cr-field-preview{display:none;flex-direction:column;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted)}.cr-field-group--expanded .cr-field-preview{display:flex}.cr-field-preview__text{position:relative;margin:0;padding:var(--cr-space-2);max-height:80px;overflow:hidden;font-size:var(--cr-text-xs);font-family:var(--cr-font-mono);white-space:pre-wrap;word-break:break-word;line-height:1.4;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);color:var(--cr-text-muted)}.cr-field-preview__text:after{content:"";position:absolute;bottom:0;left:0;right:0;height:24px;background:linear-gradient(transparent,var(--cr-bg-tertiary));pointer-events:none}.cr-field-preview__more{display:inline-flex;align-items:center;align-self:flex-start;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-accent);background:var(--cr-bg-tertiary);border:1px solid var(--cr-accent-muted);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);flex-shrink:0}.cr-field-preview__more:hover{background:var(--cr-accent-muted)}.cr-field-preview-btn{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-dim);cursor:pointer;transition:color var(--cr-transition-fast)}.cr-field-preview-btn:hover{color:var(--cr-accent)}.cr-popup-preview{margin:0;padding:var(--cr-space-3);max-height:70vh;min-height:200px;overflow-y:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius);color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text;text-align:left}.cr-preview-content{max-height:70vh}.cr-preview-content pre{padding:var(--cr-space-3);line-height:1.6;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius);color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.cr-label{display:block;margin-bottom:var(--cr-space-1);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text)}.cr-required{color:var(--cr-danger)}.cr-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font)}.cr-hint{display:block;margin-top:var(--cr-space-1);font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-errors,.cr-warnings{display:flex;flex-direction:column;gap:var(--cr-space-1);padding:var(--cr-space-3);border-radius:var(--cr-radius-sm)}.cr-errors{background:var(--cr-danger-bg);border:1px solid var(--cr-danger)}.cr-warnings{background:var(--cr-warning-bg);border:1px solid var(--cr-warning)}.cr-error{color:var(--cr-danger)}.cr-error,.cr-warning{font-size:var(--cr-text-sm)}.cr-warning{color:var(--cr-warning)}.cr-collapsible{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-collapsible summary{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;cursor:pointer;background:var(--cr-bg-secondary);list-style:none;transition:background var(--cr-transition-fast)}.cr-collapsible summary:hover{background:var(--cr-bg-tertiary)}.cr-collapsible summary::-webkit-details-marker{display:none}.cr-collapsible[open] summary{border-bottom:1px solid var(--cr-border-muted)}.cr-collapsible__content{padding:var(--cr-space-3)}.cr-shortcut{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2);border-radius:var(--cr-radius-sm)}.cr-list{display:flex;flex-direction:column}.cr-list-item{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background var(--cr-transition-fast)}.cr-list-item:last-child{border-bottom:none}.cr-list-item:hover{background:var(--cr-bg-secondary)}.cr-list-item--selected{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-list-item__title{font-weight:600;font-size:var(--cr-text-sm);color:var(--cr-text)}.cr-list-item__subtitle{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-list-item__actions{display:flex;gap:var(--cr-space-1);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-list-item:hover .cr-list-item__actions{opacity:1}.cr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;min-height:0;padding:var(--cr-space-8);text-align:center;color:var(--cr-text-muted);animation:cr-empty-appear .3s ease-out}.cr-empty--compact{padding:var(--cr-space-4)}.cr-empty--compact .cr-empty__icon{font-size:2rem;margin-bottom:var(--cr-space-2)}.cr-empty--inline{flex-direction:row;flex:0;gap:var(--cr-space-2);padding:var(--cr-space-3);text-align:left}.cr-empty--inline .cr-empty__icon{font-size:1rem;margin:0;opacity:.5}.cr-empty--inline .cr-empty__text{font-size:var(--cr-text-xs);max-width:none}.cr-empty__icon{font-size:3rem;opacity:.3;margin-bottom:var(--cr-space-4);transition:opacity var(--cr-transition-fast),transform var(--cr-transition-fast)}.cr-empty:hover .cr-empty__icon{opacity:.4;transform:scale(1.05)}.cr-empty__title{font-weight:600;font-size:var(--cr-text-base);margin-bottom:var(--cr-space-2);color:var(--cr-text)}.cr-empty__text{font-size:var(--cr-text-sm);color:var(--cr-text-dim);max-width:280px;line-height:1.5}@keyframes cr-empty-appear{0%{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.cr-results-wrapper{display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden}.cr-results-toolbar{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);min-height:40px;background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:768px){.cr-results-toolbar{padding:var(--cr-space-2)}}.cr-results-content{flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column;text-align:left}.cr-results-content>*{flex:1;min-height:0}.cr-result{display:flex;flex-direction:column;height:100%}.cr-result__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-result__type{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-result__actions,.cr-result__type{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-result__content{flex:1;overflow-y:auto;padding:var(--cr-space-3);text-align:left}.cr-result__raw{line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.cr-result__code,.cr-result__raw{margin:0;padding:var(--cr-space-3);font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius)}.cr-result__code{line-height:1.5;overflow-x:auto}.cr-result__code code{font-family:inherit}:is(.cr-json-toggle,.cr-text-toggle){display:flex;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);padding:var(--cr-space-1)}:is(.cr-json-toggle,.cr-text-toggle)>button{display:flex;align-items:center;justify-content:center;min-width:1.75rem;height:1.5rem;padding:0 var(--cr-space-1);border:none;background:transparent;color:var(--cr-text-dim);cursor:pointer;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast)}:is(.cr-json-toggle,.cr-text-toggle)>button:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}:is(.cr-json-toggle__btn,.cr-text-toggle__btn)--active{color:var(--cr-accent);background:var(--cr-bg);box-shadow:var(--cr-shadow-sm)}.cr-view-toggle{display:flex;gap:var(--cr-space-1);background:var(--cr-bg-secondary);padding:var(--cr-space-1);border-radius:var(--cr-radius)}.cr-view-toggle__btn{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);border-radius:calc(var(--cr-radius) - var(--cr-space-1));background:transparent;border:none;color:var(--cr-text-dim);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-view-toggle__btn:hover{color:var(--cr-text)}.cr-view-toggle__btn--active{background:var(--cr-bg);color:var(--cr-text);box-shadow:var(--cr-shadow-sm)}.cr-compare-view{height:100%;overflow:hidden}.cr-compare-list,.cr-compare-view{display:flex;flex-direction:column;flex:1;min-height:0}.cr-compare-list{overflow-y:auto;padding:var(--cr-space-3)}@media (max-width:768px){.cr-compare-list{padding:var(--cr-space-2)}}.cr-compare-row{display:flex;flex-direction:column;flex:1;min-height:200px;margin-bottom:var(--cr-space-3);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-compare-row--unchanged{opacity:.7}.cr-compare-row__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted)}.cr-compare-row__label{font-weight:600;font-size:var(--cr-text-sm)}.cr-compare-row__content{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr;flex:1;min-height:0;gap:1px;background:var(--cr-border)}@media (max-width:768px){.cr-compare-row__content{grid-template-columns:1fr;grid-template-rows:1fr 1fr}}.cr-compare-row__content--single{grid-template-columns:1fr;background:transparent}.cr-compare-col{display:flex;flex-direction:column;background:var(--cr-bg);padding:var(--cr-space-2);text-align:left;min-height:0;overflow:hidden}.cr-compare-col__header{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;color:var(--cr-text-dim);margin-bottom:var(--cr-space-2)}.cr-compare-col--original .cr-compare-col__header{color:var(--cr-danger)}.cr-compare-col--rewritten .cr-compare-col__header{color:var(--cr-success)}.cr-compare-text{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;margin:0;flex:1;min-height:0;overflow:auto;text-align:left}.cr-formatted{display:flex;flex-direction:column;gap:var(--cr-space-2);font-size:var(--cr-text-sm);line-height:1.55}.cr-formatted--empty{padding:var(--cr-space-4);text-align:center;color:var(--cr-text-dim);font-style:italic}.cr-hero{position:relative;display:flex;flex-direction:column;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:linear-gradient(135deg,var(--cr-bg-secondary) 0,var(--cr-bg-tertiary) 100%);border-radius:var(--cr-radius);border:1px solid var(--cr-border);text-align:center;overflow:hidden}.cr-hero:before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:120px;background:var(--score-color,var(--cr-accent));opacity:.06;filter:blur(30px);border-radius:50%;pointer-events:none}.cr-hero__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--cr-text-muted);margin-bottom:var(--cr-space-1)}.cr-hero__score{display:flex;align-items:baseline;gap:var(--cr-space-1)}.cr-hero__value{font-size:2.5rem;font-weight:800;line-height:1;color:var(--score-color,var(--cr-accent));text-shadow:0 2px 12px color-mix(in srgb,var(--score-color,var(--cr-accent)) 25%,transparent);font-variant-numeric:tabular-nums}.cr-hero__max{font-size:1rem;font-weight:500;color:var(--cr-text-dim);margin-left:var(--cr-space-1)}.cr-hero__bar{width:100%;max-width:160px;height:var(--cr-space-1);margin-top:var(--cr-space-2);background:var(--cr-bg-tertiary);overflow:hidden}.cr-hero__bar,.cr-hero__fill{border-radius:var(--cr-radius-sm)}.cr-hero__fill{height:100%;transition:width var(--cr-transition);background:var(--score-color,var(--cr-accent))}.cr-formatted .cr-section{background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-formatted .cr-section .cr-section__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);margin:0}.cr-formatted .cr-section .cr-section__title{margin:0;font-size:var(--cr-text-sm);font-weight:700;color:var(--cr-text);text-transform:none;letter-spacing:normal}.cr-formatted .cr-section .cr-section__body{padding:var(--cr-space-3);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-formatted .cr-section .cr-section__body--nested{background:var(--cr-bg);border-left:2px solid var(--cr-accent)}.cr-section__score{display:inline-flex;align-items:baseline;padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-section__score-max{font-size:.8em;font-weight:500;opacity:.6;margin-left:1px}.cr-field{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-field__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--cr-text-muted)}.cr-field__value{font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-field--empty{color:var(--cr-text-dim);font-style:italic}.cr-para{margin:0;font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-para+.cr-para{margin-top:var(--cr-space-1)}.cr-text{font-size:var(--cr-text-sm);line-height:1.6;white-space:pre-wrap}.cr-formatted .cr-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-formatted .cr-list li{position:relative;padding-left:var(--cr-space-3);font-size:var(--cr-text-sm);line-height:1.5}.cr-formatted .cr-list li:before{content:"";position:absolute;left:0;top:.55em;width:5px;height:5px;background:var(--cr-accent);border-radius:50%;opacity:.7}.cr-cards{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-formatted .cr-card{padding:var(--cr-space-4);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);transition:border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast)}.cr-formatted .cr-card:hover{border-color:var(--cr-border);box-shadow:var(--cr-shadow-md)}.cr-formatted .cr-card__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);margin-bottom:var(--cr-space-3)}.cr-formatted .cr-card__title{font-weight:700;font-size:var(--cr-text-base);color:var(--cr-text)}.cr-formatted .cr-card__body{font-size:var(--cr-text-sm);line-height:1.7;color:var(--cr-text-muted)}.cr-formatted .cr-card__extra{margin-top:var(--cr-space-3);padding-top:var(--cr-space-3);border-top:1px solid var(--cr-border-muted);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-score{display:inline-flex;align-items:baseline;padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-score__max{font-size:.75em;font-weight:500;opacity:.6;margin-left:1px}.cr-inline-score{display:inline-flex;align-items:baseline;padding:1px var(--cr-space-2);margin:0 var(--cr-space-1);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 12%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:.95em;color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-inline-score__label{font-weight:500;color:var(--cr-text-muted);margin-right:var(--cr-space-1)}.cr-inline-score__max{font-size:.75em;font-weight:500;opacity:.5}.cr-code{position:relative;background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-code__lang{position:absolute;top:var(--cr-space-2);right:var(--cr-space-2);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius-sm);font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-text-muted);text-transform:uppercase;letter-spacing:.05em}.cr-code__pre{margin:0;padding:var(--cr-space-4);overflow-x:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6}.cr-code__pre code{font-family:inherit}.cr-inline-code{padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);font-family:var(--cr-font-mono);font-size:.9em;color:var(--cr-accent)}.cr-bool--yes{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-success);font-weight:600}.cr-bool--yes i{font-size:1.1em}.cr-bool--no{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-danger);font-weight:600}.cr-bool--no i{font-size:1.1em}.cr-formatted .cr-empty,.cr-null{color:var(--cr-text-dim)}.cr-formatted .cr-empty{font-style:italic}.cr-num{font-family:var(--cr-font-mono);font-weight:600;font-variant-numeric:tabular-nums}.cr-link{color:var(--cr-accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color var(--cr-transition-fast)}.cr-link:hover{border-bottom-color:var(--cr-accent)}.cr-preview-content{max-height:60vh;overflow-y:auto;padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);text-align:left}.cr-preview-content pre{margin:0;padding:0;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word;text-align:left}.cr-history{flex-shrink:0;border-top:1px solid var(--cr-border-muted);background:var(--cr-bg)}.cr-history--collapsed .cr-history__toggle-icon{transform:rotate(-90deg)}.cr-history--collapsed .cr-history__list{display:none}.cr-history__toggle{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border:none;cursor:pointer;font-size:var(--cr-text-xs);font-weight:500;color:var(--cr-text-muted);text-align:left}.cr-history__toggle:hover{background:var(--cr-bg-tertiary);color:var(--cr-text)}.cr-history__toggle-icon{margin-left:auto;transition:transform var(--cr-transition-fast)}.cr-history__list{max-height:180px;overflow-y:auto;padding:var(--cr-space-1);background:var(--cr-bg-secondary)}.cr-history-nav{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2) var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-bottom:1px solid var(--cr-accent);flex-wrap:wrap;flex-shrink:0}@media (max-width:768px){.cr-history-nav{padding:var(--cr-space-2)}}.cr-history-nav__info{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-accent)}@media (max-width:768px){.cr-history-nav__info{font-size:var(--cr-text-xs)}}.cr-history-nav__controls{display:flex;align-items:center;gap:var(--cr-space-2);flex-wrap:wrap}@media (max-width:768px){.cr-history-nav__controls{gap:var(--cr-space-1)}}.cr-history-nav__btn{flex-shrink:0}.cr-list-item--error{border-left:3px solid var(--cr-danger)}.cr-list-item--error .cr-list-item__title{color:var(--cr-danger)}.cr-list-item--viewing{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item--current{opacity:.7}.cr-history__list .cr-list-item{padding:var(--cr-space-2);gap:var(--cr-space-2);align-items:center}.cr-history__list .cr-list-item .cr-list-item__content{gap:0}.cr-history__list .cr-list-item .cr-list-item__title{font-size:var(--cr-text-xs)}.cr-history__list .cr-list-item .cr-list-item__subtitle{display:none}.cr-history__list .cr-list-item .cr-row{gap:var(--cr-space-2)}.cr-api-badge{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-success-bg);border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);color:var(--cr-text-muted);cursor:default;transition:background var(--cr-transition-fast)}.cr-api-badge--error{background:var(--cr-danger-bg)}.cr-api-badge i{font-size:.625em}.cr-api-status{display:flex;align-items:center;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-api-status--ready{border-color:var(--cr-success)}.cr-api-status--error{border-color:var(--cr-danger)}.cr-api-status__indicator{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-status__text{font-size:var(--cr-text-sm);font-weight:500}.cr-api-status__error{color:var(--cr-danger);cursor:help}.cr-badge{display:inline-flex;align-items:center;padding:.2em .6em;font-size:var(--cr-text-xs);font-weight:500;border-radius:var(--cr-radius-pill);text-transform:uppercase;letter-spacing:.03em}.cr-badge--success{background:var(--cr-success-bg);color:var(--cr-success)}.cr-badge--warning{background:var(--cr-warning-bg);color:var(--cr-warning)}.cr-badge--sm{padding:.1em .4em;font-size:var(--cr-text-xs)}.cr-badge--info{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-badge--muted{background:var(--cr-bg-secondary);color:var(--cr-text-dim)}.cr-alert{display:flex;gap:var(--cr-space-3);padding:var(--cr-space-3);border-radius:var(--cr-radius);font-size:var(--cr-text-sm)}.cr-alert--info{background:var(--cr-accent-muted);border:1px solid var(--cr-accent);color:var(--cr-accent)}.cr-alert--success{background:var(--cr-success-bg);border:1px solid var(--cr-success);color:var(--cr-success)}.cr-alert--warning{background:var(--cr-warning-bg);border:1px solid var(--cr-warning);color:var(--cr-warning)}.cr-alert--danger{background:var(--cr-danger-bg);border:1px solid var(--cr-danger);color:var(--cr-danger)}.cr-alert__icon{flex-shrink:0}.cr-alert__content{flex:1;min-width:0}.cr-alert__title{font-weight:600;margin-bottom:var(--cr-space-1)}.cr-alert__message{margin-top:var(--cr-space-1);font-size:var(--cr-text-sm);white-space:pre-wrap}@keyframes cr-spin{to{transform:rotate(1turn)}}@keyframes cr-pulse{0%,to{opacity:1}50%{opacity:.6}}@keyframes cr-shimmer{0%{transform:translateX(-100%)}to{transform:translateX(100%)}}.cr-drawer{position:absolute;inset:0;z-index:100;pointer-events:none;overflow:hidden}.cr-drawer[aria-hidden=true]{visibility:hidden}.cr-drawer--open{pointer-events:auto;visibility:visible}.cr-drawer--open .cr-drawer__backdrop{opacity:1}.cr-drawer--open .cr-drawer__panel{transform:translateX(0)}.cr-drawer__backdrop{position:absolute;inset:0;background:var(--cr-backdrop);opacity:0;transition:opacity var(--cr-transition);backdrop-filter:var(--cr-backdrop-blur)}.cr-drawer__panel{position:absolute;top:0;right:0;bottom:0;width:100%;max-width:640px;background:var(--SmartThemeBlurTintColor,var(--cr-bg));border-left:1px solid var(--cr-border);box-shadow:var(--cr-shadow-drawer);transform:translateX(100%);transition:transform var(--cr-transition);display:flex;flex-direction:column}@media (max-width:768px){.cr-drawer__panel{max-width:none}}.cr-drawer__content{display:flex;flex-direction:column;height:100%;min-height:0}.cr-drawer__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-drawer__title h3{margin:0;font-size:var(--cr-text-lg);font-weight:600}.cr-drawer__title i{font-size:var(--cr-text-base)}.cr-drawer__body{flex:1;min-height:0;overflow-y:auto;padding:var(--cr-space-4);display:flex;flex-direction:column;gap:var(--cr-space-4)}.cr-drawer__footer{display:flex;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__footer--list,.cr-drawer__footer--spaced{justify-content:space-between}.cr-drawer__footer--spaced{gap:var(--cr-space-4)}.cr-drawer__tabs{display:flex;background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__tab{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all var(--cr-transition-fast)}.cr-drawer__tab:hover{color:var(--cr-text);background:var(--cr-bg-tertiary)}.cr-drawer__tab--active{color:var(--cr-accent);border-bottom-color:var(--cr-accent)}.cr-preset-row{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-preset-row .cr-select{flex:1;min-width:0}.cr-preset-label{color:var(--cr-text-muted);flex-shrink:0;white-space:nowrap}.cr-chip,.cr-preset-label{font-size:var(--cr-text-xs)}.cr-chip{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-pill);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-chip--active,.cr-chip:hover{border-color:var(--cr-accent)}.cr-chip--active{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-chip input[type=checkbox]{display:none}.cr-preset-list{display:flex;flex-direction:column;flex:1;min-height:0}.cr-preset-list__section-label{padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--cr-text-dim);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);position:sticky;top:0;z-index:1}.cr-preset-list__item{display:flex;align-items:stretch;border-bottom:1px solid var(--cr-border-muted);transition:background var(--cr-transition-fast)}.cr-preset-list__item:last-child{border-bottom:none}.cr-preset-list__item:hover{background:var(--cr-bg-secondary)}.cr-preset-list__item--builtin{opacity:.85}.cr-preset-list__select{flex:1;display:flex;align-items:center;min-width:0;padding:var(--cr-space-3);background:none;border:none;cursor:pointer;text-align:left;color:inherit}.cr-preset-list__info{display:flex;flex-direction:column;gap:var(--cr-space-1);min-width:0}.cr-preset-list__name{display:flex;align-items:center;gap:var(--cr-space-2);font-weight:500;font-size:var(--cr-text-sm);color:var(--cr-text)}.cr-preset-list__name i,.cr-preset-list__stages{font-size:var(--cr-text-xs)}.cr-preset-list__stages{color:var(--cr-text-muted)}.cr-preset-list__actions{display:flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-2);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-preset-list__item:hover .cr-preset-list__actions{opacity:1}@media (max-width:768px){.cr-preset-list__actions{opacity:1}}.cr-preset-list__action{flex-shrink:0}.cr-drawer__body--list{padding:0;overflow:hidden}.cr-settings-section{display:flex;flex-direction:column;gap:var(--cr-space-3);padding:var(--cr-space-4);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius)}@media (max-width:768px){.cr-settings-section{padding:var(--cr-space-3);gap:var(--cr-space-2)}}.cr-settings-section h3{display:flex;align-items:center;gap:var(--cr-space-2);margin:0 0 var(--cr-space-2) 0;padding-bottom:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted);font-size:var(--cr-text-base);font-weight:600}@media (max-width:768px){.cr-settings-section h3{font-size:var(--cr-text-sm)}}.cr-settings-section h3 i{color:var(--cr-accent);font-size:var(--cr-text-sm)}.cr-api-banner{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);border-radius:var(--cr-radius);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);margin-bottom:var(--cr-space-3)}.cr-api-banner--ready{border-color:var(--cr-success);background:color-mix(in srgb,var(--cr-success) 10%,var(--cr-bg-secondary))}.cr-api-banner--ready .cr-api-banner__left i{color:var(--cr-success)}.cr-api-banner--error{border-color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,var(--cr-bg-secondary))}.cr-api-banner--error .cr-api-banner__left i{color:var(--cr-danger)}.cr-api-banner__left{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-banner__name{font-weight:500;font-size:var(--cr-text-sm)}.cr-api-banner__right{display:flex;align-items:center;gap:var(--cr-space-3);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-api-banner__model{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-api-banner__limits{display:flex;align-items:center;gap:var(--cr-space-1)}.cr-api-banner__limits--override{color:var(--cr-accent);font-weight:500}.cr-api-banner__override-icon{font-size:.6rem;color:var(--cr-accent)}.cr-api-error{align-items:center;padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 8%,transparent);border-radius:var(--cr-radius)}.cr-api-error,.cr-gen-mode-toggle{display:flex;gap:var(--cr-space-2);margin-bottom:var(--cr-space-3)}@media (max-width:768px){.cr-gen-mode-toggle{flex-direction:column;gap:var(--cr-space-1)}}.cr-gen-mode-option{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);background:var(--cr-bg-secondary);cursor:pointer;transition:all var(--cr-transition);font-size:var(--cr-text-sm)}@media (max-width:768px){.cr-gen-mode-option{padding:var(--cr-space-3);justify-content:flex-start}}.cr-gen-mode-option input[type=radio]{display:none}.cr-gen-mode-option:hover{border-color:var(--cr-border);background:var(--cr-bg-tertiary)}.cr-gen-mode-option--active{border-color:var(--cr-accent);background:color-mix(in srgb,var(--cr-accent) 15%,var(--cr-bg-secondary))}.cr-gen-mode-option--active i{color:var(--cr-accent)}.cr-profile-section{padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-profile-info{margin-top:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg);border-radius:var(--cr-radius-sm)}.cr-profile-info--empty{display:flex;align-items:center;gap:var(--cr-space-2);color:var(--cr-text-dim);font-size:var(--cr-text-sm);font-style:italic}.cr-profile-info--error{border:1px solid var(--cr-danger)}.cr-profile-info__row{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-1) 0;font-size:var(--cr-text-xs)}.cr-profile-info__row:not(:last-child){border-bottom:1px solid var(--cr-border-muted)}.cr-profile-info__label{color:var(--cr-text-muted)}.cr-profile-info__value{font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-profile-info__error{display:flex;align-items:center;gap:var(--cr-space-2);margin-top:var(--cr-space-2);padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,transparent);border-radius:var(--cr-radius-sm)}.cr-profile-empty{display:flex;gap:var(--cr-space-2);padding:var(--cr-space-3);color:var(--cr-text-muted);font-size:var(--cr-text-sm)}.cr-profile-empty i{color:var(--cr-accent);flex-shrink:0;margin-top:var(--cr-space-1)}.cr-profile-empty strong{display:block;margin-bottom:var(--cr-space-1);color:var(--cr-text)}.cr-profile-empty p{margin:0;font-size:var(--cr-text-xs);line-height:1.4}.cr-setting-item{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-setting-label{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text);cursor:pointer}.cr-setting-label input[type=checkbox]{width:auto;accent-color:var(--cr-accent);cursor:pointer}.cr-setting-hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-setting-desc{margin:0 0 var(--cr-space-2) 0;font-size:var(--cr-text-sm);color:var(--cr-text-muted);line-height:1.5}.cr-number-input{width:120px!important;padding:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-version{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-presets-tab--active{color:var(--cr-text);background:var(--cr-bg);box-shadow:var(--cr-shadow-sm)}.cr-shortcuts-list{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-shortcuts-list .cr-shortcut{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-shortcuts-list .cr-shortcut kbd{display:inline-flex;align-items:center;padding:.2em .5em;font-family:var(--cr-font);font-size:var(--cr-text-xs);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm)}.cr-shortcuts-list .cr-shortcut span{color:var(--cr-text-muted)}.cr-warning-banner{display:flex;align-items:flex-start;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);margin-bottom:var(--cr-space-2);font-size:var(--cr-text-xs);line-height:1.4;color:var(--cr-warning);background:color-mix(in srgb,var(--cr-warning) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-warning) 30%,transparent);border-radius:var(--cr-radius-sm)}.cr-warning-banner i{flex-shrink:0;margin-top:.1em}.cr-danger-zone{flex-direction:column;padding:var(--cr-space-3);background:color-mix(in srgb,var(--cr-danger) 5%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-danger) 30%,transparent);border-radius:var(--cr-radius);text-align:left}.cr-danger-zone,.cr-danger-zone__warning{display:flex;align-items:flex-start;gap:var(--cr-space-3)}.cr-danger-zone__warning{color:var(--cr-danger);font-size:var(--cr-text-sm)}.cr-danger-zone__warning i{flex-shrink:0;font-size:1.25em;margin-top:.1em}.cr-danger-zone__warning strong{display:block;margin-bottom:var(--cr-space-1)}.cr-danger-zone__warning p{margin:0;opacity:.85}.cr-panel-content{display:flex;flex-direction:column;gap:.75rem}.cr-panel-desc{margin:0;font-size:.8125rem;color:var(--SmartThemeEmColor,#999);line-height:1.4}.cr-panel-launch{display:flex;align-items:center;justify-content:center;gap:.5rem;width:100%;padding:.625rem 1rem;font-size:.875rem;font-weight:500}.cr-panel-footer{display:flex;align-items:center;justify-content:space-between;padding-top:.5rem;border-top:1px solid var(--SmartThemeBorderColor,#333)}.cr-panel-checkbox{display:flex;align-items:center;gap:.375rem;font-size:.75rem;color:var(--SmartThemeEmColor,#999);cursor:pointer}.cr-panel-checkbox input[type=checkbox]{margin:0;cursor:pointer}.cr-panel-version{font-size:.6875rem;color:var(--SmartThemeEmColor,#666)}.cr-apply-dialog{display:flex;flex-direction:column;gap:var(--cr-space-3);height:80vh;min-height:400px;width:100%;max-width:100%;padding:var(--cr-space-3);box-sizing:border-box;overflow:hidden}.cr-apply-dialog--split{width:min(1100px,calc(100vw - 60px))}.cr-apply-split{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:var(--cr-space-3);flex:1;min-height:0;min-width:0;width:100%;max-width:100%;overflow:hidden;box-sizing:border-box}@media (max-width:768px){.cr-apply-split{grid-template-columns:1fr;grid-template-rows:minmax(150px,1fr) minmax(250px,1.5fr);gap:var(--cr-space-2)}}.cr-apply-panel{display:flex;flex-direction:column;height:100%;min-height:0;min-width:0;width:100%;max-width:100%;overflow:hidden;box-sizing:border-box;border:1px solid var(--cr-border);border-radius:var(--cr-radius);background:var(--cr-bg-secondary)}.cr-apply-panel__header{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);font-weight:600;font-size:var(--cr-text-sm);color:var(--cr-text);flex-shrink:0}.cr-apply-panel__header i{color:var(--cr-accent)}.cr-apply-panel--source .cr-apply-source{flex:1;min-height:0;width:100%;max-width:100%;box-sizing:border-box;padding:var(--cr-space-3);margin:0;font-family:var(--cr-font-mono);font-size:var(--cr-text-sm);line-height:1.5;resize:none;border:none;background:var(--cr-bg);color:var(--cr-text);overflow:auto;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap}.cr-apply-panel--source .cr-apply-source:focus{outline:none}.cr-apply-panel--fields .cr-apply-fields-list{flex:1;min-height:0;min-width:0;overflow:hidden auto;padding:var(--cr-space-2);gap:var(--cr-space-2)}.cr-apply-field,.cr-apply-panel--fields .cr-apply-fields-list{width:100%;max-width:100%;display:flex;flex-direction:column;box-sizing:border-box}.cr-apply-field{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm);overflow:hidden;background:var(--cr-bg);transition:border-color var(--cr-transition-fast)}.cr-apply-field:not([open]){flex-shrink:0}.cr-apply-field__header{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;list-style:none;width:100%;box-sizing:border-box}.cr-apply-field__header::-webkit-details-marker{display:none}.cr-apply-field__header:before{content:"\\f054";font-family:Font Awesome\\ 6 Free;font-weight:900;font-size:var(--cr-text-xs);color:var(--cr-text-muted);transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-apply-field__header:hover{background:var(--cr-bg-tertiary)}.cr-apply-field__label{flex:1;font-weight:500;font-size:var(--cr-text-sm);color:var(--cr-text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-apply-field__badge{font-size:var(--cr-text-xs);padding:var(--cr-space-1) var(--cr-space-2);border-radius:var(--cr-radius-sm);white-space:nowrap;flex-shrink:0}.cr-apply-field__badge--filled{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-apply-field__badge--empty{background:var(--cr-bg-tertiary);color:var(--cr-text-muted)}.cr-apply-field__dirty{font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-warning);padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--cr-warning) 15%,transparent);border-radius:var(--cr-radius-sm);flex-shrink:0}.cr-apply-field__content{display:flex;flex-direction:column;padding:var(--cr-space-2);border-top:1px solid var(--cr-border-muted);flex:1;min-height:0;overflow:hidden auto;box-sizing:border-box}.cr-apply-field[open]{flex:1;min-height:150px}.cr-apply-field[open] .cr-apply-field__header:before{transform:rotate(90deg)}.cr-apply-field--dirty{border-color:var(--cr-warning);box-shadow:0 0 0 1px color-mix(in srgb,var(--cr-warning) 20%,transparent)}.cr-apply-field--dirty .cr-apply-field__header{background:color-mix(in srgb,var(--cr-warning) 8%,var(--cr-bg-secondary))}.cr-apply-textarea{width:100%;max-width:100%;min-height:100px;flex:1;box-sizing:border-box;padding:var(--cr-space-2);font-family:var(--cr-font);font-size:var(--cr-text-sm);line-height:1.5;border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);resize:vertical;overflow:hidden auto;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap;transition:border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast)}.cr-apply-textarea:focus{border-color:var(--cr-accent);box-shadow:0 0 0 2px color-mix(in srgb,var(--cr-accent) 20%,transparent);outline:none}.cr-apply-textarea::-moz-placeholder{color:var(--cr-text-muted);font-style:italic}.cr-apply-textarea::placeholder{color:var(--cr-text-muted);font-style:italic}.cr-apply-greetings{gap:var(--cr-space-2);box-sizing:border-box}.cr-apply-greetings,.cr-apply-greetings__item{display:flex;flex-direction:column;width:100%;max-width:100%}.cr-apply-greetings__item{gap:var(--cr-space-1)}.cr-apply-greetings__label{font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-text-muted);text-transform:uppercase;letter-spacing:.5px}.cr-apply-greetings__add{align-self:flex-start;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-accent);background:transparent;border:1px dashed var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-apply-greetings__add:hover{background:var(--cr-accent-muted);border-style:solid}.cr-apply-footer{padding:var(--cr-space-3);padding-top:var(--cr-space-2);margin:0 calc(-1 * var(--cr-space-3)) calc(-1 * var(--cr-space-3));background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted);flex-shrink:0}@media (max-width:768px){.cr-popup .menu_button{min-height:44px;padding:var(--cr-space-3)}.cr-list-item{padding:var(--cr-space-4)}.cr-list-item__actions{opacity:1}.cr-popup input[type=number],.cr-popup input[type=search],.cr-popup input[type=text],.cr-popup select{min-height:44px;font-size:16px}.cr-select{min-height:44px;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm)}.cr-checkbox{min-height:44px;padding:var(--cr-space-2) 0}.cr-checkbox input[type=checkbox]{width:20px;height:20px}.cr-drawer__tab{min-height:48px}.cr-preset-list__actions{opacity:1}}@media (prefers-reduced-motion:reduce){.cr-popup *,.cr-popup :after,.cr-popup :before{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}@media (prefers-contrast:high){.cr-popup{--cr-border:var(--cr-text);--cr-border-muted:var(--cr-text-muted)}}:is(.cr-popup,.cr-drawer) a:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) button:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) input:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) select:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) textarea:focus:not(:focus-visible){outline:none}:is(.cr-popup,.cr-drawer) a:focus-visible,:is(.cr-popup,.cr-drawer) button:focus-visible,:is(.cr-popup,.cr-drawer) input:focus-visible,:is(.cr-popup,.cr-drawer) select:focus-visible,:is(.cr-popup,.cr-drawer) textarea:focus-visible{outline:2px solid var(--cr-accent);outline-offset:2px}:is(.cr-popup,.cr-drawer) input:focus-visible,:is(.cr-popup,.cr-drawer) select:focus-visible,:is(.cr-popup,.cr-drawer) textarea:focus-visible{outline-offset:0;box-shadow:0 0 0 2px var(--cr-accent-muted)}`,""]);const u=d},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(r){!function(e,t,r){var n="";r.supports&&(n+="@supports (".concat(r.supports,") {")),r.media&&(n+="@media ".concat(r.media," {"));var i=void 0!==r.layer;i&&(n+="@layer".concat(r.layer.length>0?" ".concat(r.layer):""," {")),n+=r.css,i&&(n+="}"),r.media&&(n+="}"),r.supports&&(n+="}");var a=r.sourceMap;a&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,r)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},960(e,t,r){t.encode=r(524),t.decode=r(628)}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={id:n,exports:{}};return e[n](a,a.exports,r),a.exports}r.m=e,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.b=new URL("./",import.meta.url),r.nc=void 0;var n=r(72),i=r.n(n),a=r(825),o=r.n(a),s=r(659),c=r.n(s),l=r(56),d=r.n(l),p=r(540),u=r.n(p),f=r(113),m=r.n(f),g=r(805),v={};v.styleTagTransform=m(),v.setAttributes=d(),v.insert=c().bind(null,"head"),v.domAPI=o(),v.insertStyleElement=u();i()(g.A,v);g.A&&g.A.locals&&g.A.locals;var h=r(313),y=r(737),b=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function _(e,t){const r=e;let n=x(r,t);if(void 0===n&&t.startsWith("data.")){const e=t.replace(/^data\./,"").replace(/^extensions\./,"");n=x(r,e),void 0===n&&e in r&&(n=r[e])}if(void 0===n&&t.startsWith("data.extensions.")){n=x(r,`extensions.${t.replace("data.extensions.","")}`)}return n}function x(e,t){return t.split(".").reduce((e,t)=>{if(e&&"object"==typeof e)return e[t]},e)}function w(e,t){if(null==e)return!1;switch(t){case"array":return Array.isArray(e)&&e.length>0;case"object":return"object"==typeof e&&("prompt"in e?"string"==typeof e.prompt&&e.prompt.trim().length>0:"entries"in e?Array.isArray(e.entries)&&e.entries.length>0:Object.keys(e).length>0);default:return"string"==typeof e&&e.trim().length>0}}function $(e,t){switch(t.type){case"array":return Array.isArray(e)?e.map((e,t)=>`${t+1}. ${String(e).trim()}`).join("\n"):"";case"object":return function(e,t){var r,n,i,a;if(!e||"object"!=typeof e)return"";if("depth_prompt"===t){const t=e;return(null===(r=t.prompt)||void 0===r?void 0:r.trim())?`[Depth: ${null!==(n=t.depth)&&void 0!==n?n:0}, Role: ${null!==(i=t.role)&&void 0!==i?i:"system"}]\n${t.prompt.trim()}`:""}if("character_book"===t){const t=e;if(!(null===(a=t.entries)||void 0===a?void 0:a.length))return"";const r=[];t.name&&r.push(`Lorebook: ${t.name}`),r.push(`Entries: ${t.entries.length}`);for(const e of t.entries.slice(0,10)){const t=e.enabled?"":"",n=e.comment||e.keys.slice(0,3).join(", ");r.push(`  ${t} ${n}`)}return t.entries.length>10&&r.push(`  ... and ${t.entries.length-10} more`),r.join("\n")}try{return JSON.stringify(e,null,2)}catch(e){return"[Complex Object]"}}(e,t.key);default:return"string"==typeof e?e.trim():String(e)}}function k(e){if(!e)return[];const t=[];for(const r of h.IF){const n=_(e,r.path);if(!w(n,r.type))continue;const i=$(n,r);i&&t.push({key:r.key,label:r.label,value:i,rawValue:n,charCount:i.length,type:r.type})}return t}function S(e,t){const r=k(e),n=[];for(const e of r){const r=t[e.key];if(r)if("alternate_greetings"===e.key&&Array.isArray(r)){const t=e.rawValue,i=r.filter(e=>e>=0&&e<t.length).map(e=>`**Greeting ${e+1}:**\n${t[e].trim()}`).join("\n\n");i&&n.push(`### ${e.label}\n\n${i}`)}else n.push(`### ${e.label}\n\n${e.value}`)}const i=n.length>0?n.join("\n\n"):"(No fields selected)";let a=`# CHARACTER: ${e.name}\n\n${i}`;var o,s;return o=a,s=e.name,a=o&&s?o.replace(/\{\{char\}\}/gi,s):o,a=function(e,t=["user","persona","original","input"]){if(!e)return e;let r=e;for(const e of t){const t=new RegExp(`\\{\\{(${e})\\}\\}`,"gi");r=r.replace(t,"{{$1}}")}return r}(a),a}function P(e,t){const r=k(e),n={};for(const e of r)t[e.key]&&(n[e.key]=e.value);return n}var R=r(179),E=r(691),A=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function C(e,t){return A(this,arguments,void 0,function*(e,t,r={}){var n,i,a,o,s;const{signal:c,onProgress:l}=r,d=Date.now(),p=function(e,t){var r;const n=[];"analyze"===e.stage?(n.push("## ORIGINAL CHARACTER\n\n"),n.push(S(e.character,e.selection)),e.previousResults.score&&n.push("\n\n---\n\n## SCORE RESULTS\n\n"+e.previousResults.score.output),e.previousResults.rewrite&&n.push("\n\n---\n\n## REWRITTEN VERSION\n\n"+e.previousResults.rewrite.output)):(n.push(S(e.character,e.selection)),"rewrite"===e.stage&&(e.previousResults.score&&n.push("\n\n---\n\n## SCORE RESULTS\n\n"+e.previousResults.score.output),e.isRefinement&&e.previousResults.analyze&&n.push("\n\n---\n\n## ANALYSIS FEEDBACK\n\n"+e.previousResults.analyze.output))),(null===(r=e.guidance)||void 0===r?void 0:r.trim())&&n.push("\n\n---\n\n## USER GUIDANCE\n\n"+e.guidance.trim()),e.iterationCount>0&&n.push(`\n\n---\n\n*Refinement iteration ${e.iterationCount+1}*`);const i=function(e,t){if(e.customPrompt.trim())return e.customPrompt.trim();if(e.promptPresetId){const r=t.getPromptPreset(e.promptPresetId);if(r)return r.prompt}return""}(e.config,t);return i&&n.push("\n\n---\n\n## INSTRUCTIONS\n\n"+i),n.join("")}(e,t),u=function(e,t,r){return t?r.getRefinementPrompt():r.getSystemPrompt(e)}(e.stage,null!==(n=e.isRefinement)&&void 0!==n&&n,t),f=function(e,t){if(!e.useStructuredOutput)return null;if(e.customSchema.trim())try{return JSON.parse(e.customSchema)}catch(e){return null}if(e.schemaPresetId){const r=t.getSchemaPreset(e.schemaPresetId);if(r)return r.schema}return null}(e.config,t);if(null==l||l(`Running ${e.stage}...`),null==c?void 0:c.aborted)return{stage:e.stage,timestamp:d,input:p,output:"",guidance:e.guidance,error:"Aborted"};const m=null!==(i=(0,E.mt)().maxTokensOverride)&&void 0!==i?i:void 0,g=yield(0,R.generate)({prompt:p,systemPrompt:u,jsonSchema:null!==(a=f)&&void 0!==a?a:void 0,signal:c,responseLength:m});return g.success?{stage:e.stage,timestamp:d,input:p,output:null!==(s=g.response)&&void 0!==s?s:"",guidance:e.guidance}:(h.Rm.error(`Stage ${e.stage} failed`,g.error),{stage:e.stage,timestamp:d,input:p,output:"",guidance:e.guidance,error:null!==(o=g.error)&&void 0!==o?o:"Generation failed"})})}var I=r(374),z=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};var O=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function T(e,t,r){return O(this,void 0,void 0,function*(){yield r(),e._isLoading=!0;try{if(e.character=t,e.selectedFields={},e.stageFields={base:{},linked:!0,overrides:{}},e.activeSessionId=null,e.sessions=[],e.sessionsLoaded=!1,e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.stageResults={score:null,rewrite:null,analyze:null},e.iterationCount=0,e.iterationHistory=[],e.hasUnsavedChanges=!1,t){try{e.character=yield function(e){return b(this,void 0,void 0,function*(){const t=SillyTavern.getContext(),r=t.characters||[],n=r.findIndex(t=>t.avatar===e.avatar);if(-1===n)return h.Rm.debug("Character not found in ST array, using provided data"),e;const i=r[n];return i.shallow&&"function"==typeof t.unshallowCharacter?(h.Rm.debug(`Unshallowing character: ${e.name}`),yield t.unshallowCharacter(n),r[n]):i})}(t),h.Rm.debug(`Character loaded: ${e.character.name}`)}catch(r){h.Rm.error("Failed to unshallow character",r),e.character=t}const r=k(e.character),n={};for(const e of r)n[e.key]=!0;e.stageFields={base:n,linked:!0,overrides:{}},e.selectedFields=n,e.sessions=yield(0,y.getSessionsForCharacter)(t.avatar),e.sessionsLoaded=!0,h.Rm.debug(`Character ${t.name}: ${e.sessions.length} sessions, ${r.length} fields selected`)}}finally{e._isLoading=!1}})}var W=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let N=null;const L=function(e,t){const r=SillyTavern.libs.lodash;let n=null;const i=()=>z(this,void 0,void 0,function*(){n&&(yield n);const i=e();if(!(null==i?void 0:i.character))return;if(i._isLoading)return;let a;if(i.activeSessionId){if(a=yield(0,y.getSession)(i.activeSessionId),!a)return}else{const e=P(i.character,i.stageFields.base);a=yield(0,y.createSession)({characterId:i.character.avatar,characterName:i.character.name,stageFields:i.stageFields,originalData:e,configs:i.stageConfigs}),i.sessions.unshift(a),i.activeSessionId=a.id,h.Rm.debug(`Lazy-created session on auto-save: ${a.id}`)}a.stageFields=r.cloneDeep(i.stageFields),a.configs=r.cloneDeep(i.stageConfigs),a.stageResults=r.cloneDeep(i.stageResults),a.history=r.cloneDeep(i.iterationHistory),a.iterationCount=i.iterationCount,a.userGuidance=i.userGuidance||void 0,yield(0,y.updateSession)(a),t(!1)}),a=()=>z(this,void 0,void 0,function*(){const e=i();n=e;try{yield e}finally{n===e&&(n=null)}}),o=r.debounce(()=>{a()},1e3);return{trigger:o,save:a,cancel:()=>o.cancel(),flush:()=>z(this,void 0,void 0,function*(){o.cancel(),n&&(yield n),yield a()})}}(()=>N,e=>{N&&(N.hasUnsavedChanges=e)});function j(){return N={character:null,selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}},activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},stageResults:{score:null,rewrite:null,analyze:null},stageConfigs:{score:(0,y.getStageDefaults)("score"),rewrite:(0,y.getStageDefaults)("rewrite"),analyze:(0,y.getStageDefaults)("analyze")},activeStage:"score",iterationCount:0,iterationHistory:[],userGuidance:"",isGenerating:!1,abortController:null,searchQuery:"",searchResults:[],searchSelectedIndex:-1,dropdownOpen:!1,sessionListExpanded:!1,historyExpanded:!1,viewingHistoryIndex:null},N}function B(){if(!N)throw new Error("State not initialized");return N}function D(){return N}function M(){L.cancel(),N=null}function U(){const e=D();e&&(e.hasUnsavedChanges=!0,L.trigger())}function F(){return W(this,void 0,void 0,function*(){yield L.flush()})}function H(){return W(this,void 0,void 0,function*(){return function(e,t){return O(this,void 0,void 0,function*(){if(!e.character)return null;yield t();const r=P(e.character,e.stageFields.base),n=yield(0,y.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:r,configs:e.stageConfigs});return e.sessions.unshift(n),e.activeSessionId=n.id,e.iterationCount=0,e.iterationHistory=[],e.stageResults={score:null,rewrite:null,analyze:null},e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.hasUnsavedChanges=!1,n})}(B(),F)})}function G(e){return W(this,void 0,void 0,function*(){return function(e,t,r){return O(this,void 0,void 0,function*(){var n;yield r();const i=yield(0,y.getSession)(t);if(!i)return!1;e._isLoading=!0;try{if((null===(n=e.character)||void 0===n?void 0:n.avatar)!==i.characterId){const t=SillyTavern.getContext().characters.find(e=>e.avatar===i.characterId);if(!t)return!1;e.character=t}const t=SillyTavern.libs.lodash;if(e.activeSessionId=i.id,e.stageFields=t.cloneDeep(i.stageFields),e.selectedFields=t.cloneDeep(i.stageFields.base),e.stageConfigs=t.cloneDeep(i.configs),e.iterationHistory=t.cloneDeep(i.history),e.iterationCount=i.iterationCount,e.userGuidance=i.userGuidance||"",e.hasUnsavedChanges=!1,i.stageResults)e.stageResults=t.cloneDeep(i.stageResults);else{e.stageResults={score:null,rewrite:null,analyze:null};for(const t of i.history)e.stageResults[t.stage]=t}for(const t of h.an)e.stageStatus[t]=e.stageResults[t]?e.stageResults[t].error?"error":"complete":"pending";return!0}finally{e._isLoading=!1}})}(B(),e,F)})}function q(e){return W(this,void 0,void 0,function*(){return function(e,t){return O(this,void 0,void 0,function*(){if(!(yield(0,y.deleteSession)(t)))return h.Rm.error("Failed to delete session:",t),!1;const r=e.sessions.findIndex(e=>e.id===t);return-1!==r&&e.sessions.splice(r,1),e.activeSessionId===t&&(e.activeSessionId=null,e.iterationHistory=[],e.iterationCount=0,e.stageResults={score:null,rewrite:null,analyze:null},e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"}),!0})}(B(),e)})}function J(){return W(this,void 0,void 0,function*(){return function(e){return O(this,void 0,void 0,function*(){if(!e.character)return{success:!1,count:0};const t=yield(0,y.deleteAllSessionsForCharacter)(e.character.avatar);return t.success?(e.sessions=[],e.activeSessionId=null,e.iterationHistory=[],e.iterationCount=0,e.stageResults={score:null,rewrite:null,analyze:null},e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},t):(h.Rm.error("Failed to delete all sessions"),t)})}(B())})}function Y(){return W(this,void 0,void 0,function*(){const e=yield function(e){return O(this,void 0,void 0,function*(){if(e.activeSessionId){const t=e.sessions.find(t=>t.id===e.activeSessionId);if(t)return t}if(!e.character)return null;const t=P(e.character,e.stageFields.base),r=yield(0,y.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:t,configs:e.stageConfigs});return e.sessions.unshift(r),e.activeSessionId=r.id,h.Rm.debug(`Lazy-created new session: ${r.id}`),r})}(B());return null!==e})}function V(e,t){return W(this,void 0,void 0,function*(){const n=B().sessions.find(t=>t.id===e);if(!n)return;n.name=t.trim()||void 0,n.updatedAt=Date.now();const{updateSession:i}=yield Promise.resolve().then(r.bind(r,737));yield i(n)})}function Q(e){var t;const r=B(),n=null!=e?e:r.activeStage;return r.stageFields.linked?r.stageFields.base:null!==(t=r.stageFields.overrides[n])&&void 0!==t?t:r.stageFields.base}function X(){return Q()}function K(){return B().stageFields.linked}function Z(e,t){var r,n,i,a;const o=B(),s=o.stageFields.linked?o.stageFields.base:null!==(r=(i=o.stageFields.overrides)[a=o.activeStage])&&void 0!==r?r:i[a]={};if(!1===t||Array.isArray(t)&&0===t.length)delete s[e];else if("alternate_greetings"===e&&Array.isArray(t)&&o.character){const r=(null===(n=o.character.data)||void 0===n?void 0:n.alternate_greetings)||[],i=t.filter(e=>e>=0&&e<r.length);0===i.length?delete s[e]:s[e]=i}else s[e]=t;o.selectedFields=Object.assign({},s),U()}function ee(e){B().activeStage=e}function te(e,t){const r=B();Object.assign(r.stageConfigs[e],t),U(),(0,y.setStageDefaults)(e,r.stageConfigs[e])}function re(e){const t=B();null!==e&&(e<0||e>=t.iterationHistory.length)||(t.viewingHistoryIndex=e)}function ne(e){const t=B(),r=null!=e?e:t.viewingHistoryIndex;if(null===r||r<0||r>=t.iterationHistory.length)return;const n=t.iterationHistory[r];t.stageResults[n.stage]=n,t.stageStatus[n.stage]=n.error?"error":"complete",t.viewingHistoryIndex=null,U()}function ie(){var e;const t=B();return null===t.viewingHistoryIndex?null:null!==(e=t.iterationHistory[t.viewingHistoryIndex])&&void 0!==e?e:null}var ae=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const oe={getPromptPreset:y.getPromptPreset,getSchemaPreset:y.getSchemaPreset,getSystemPrompt:y.getSystemPrompt,getRefinementPrompt:y.getRefinementPrompt};function se(e,t,r){e.stageStatus[t]=r}function ce(e,t,r){e.isGenerating=t,e.abortController=t?null!=r?r:new AbortController:null}function le(e,t){e.abortController===t&&(e.isGenerating=!1,e.abortController=null)}function de(e,t){e.stageResults[t.stage]=t,e.stageStatus[t.stage]=t.error?"error":"complete",e.iterationHistory.push(t),e.hasUnsavedChanges=!0}function pe(e,t){return e.character?{character:e.character,selection:Q(t),stage:t,config:e.stageConfigs[t],previousResults:e.stageResults,iterationCount:e.iterationCount,guidance:e.userGuidance||void 0}:null}function ue(e,t){return ae(this,void 0,void 0,function*(){var r,n,i,a;const{stage:o,callbacks:s}=t;if(!e.character)return h.Rm.warn("Cannot execute stage: no character selected"),null;if(e.isGenerating)return h.Rm.warn("Cannot execute stage: generation already in progress"),null;yield Y();const c=pe(e,o);if(!c)return null;const l=new AbortController;ce(e,!0,l),se(e,o,"running"),null===(r=null==s?void 0:s.onStageStart)||void 0===r||r.call(s,o);try{const t=yield C(c,oe,{signal:l.signal,onProgress:e=>{var t;h.Rm.debug(`[Pipeline] ${e}`),null===(t=null==s?void 0:s.onProgress)||void 0===t||t.call(s,e)}});return de(e,t),null===(n=null==s?void 0:s.onStageComplete)||void 0===n||n.call(s,o,t),t.error&&(null===(i=null==s?void 0:s.onError)||void 0===i||i.call(s,o,t.error)),t}catch(t){const r=t instanceof Error?t.message:"Unknown error";return h.Rm.error(`Stage ${o} failed:`,t),se(e,o,"error"),null===(a=null==s?void 0:s.onError)||void 0===a||a.call(s,o,r),null}finally{le(e,l)}})}function fe(e,t=document){return t.querySelector(e)}function me(e,t=document){return Array.from(t.querySelectorAll(e))}function ge(e,t,r,n){return e?(e.addEventListener(t,r,n),()=>{e.removeEventListener(t,r,n)}):()=>{}}function ve(e){return void 0===e?"...":null===e?"":e>=1e3?`${(e/1e3).toFixed(1)}k`:e.toString()}function he(e,t){return e.length<=t?e:e.slice(0,t-1)+""}function ye(...e){return e.filter(Boolean).join(" ")}const be=new Map;let _e=new Set,xe=!1;function we(e,t,r){return be.set(e,{fn:t,categories:r}),()=>be.delete(e)}function $e(...e){for(const t of e)_e.add(t);xe||(xe=!0,queueMicrotask(ke))}function ke(){if(xe=!1,0===_e.size)return;const e=_e;_e=new Set;const t=e.has("all");for(const r of be.values())if(t||r.categories.some(t=>e.has(t)))try{r.fn()}catch(e){h.Rm.error("UpdateCoordinator update failed:",e)}}function Se(){$e("character","session","fields","config","results","pipeline")}function Pe(){$e("session","fields","config","results","pipeline","stage")}var Re=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function Ee(){return SillyTavern.getContext().characters||[]}let Ae=null;function Ce(){Ae=null}let Ie=!1,ze="",Oe=-1,Te=null;function We(e){Ie=e;const t=fe(`#${h.pW}_char_dropdown`);t&&t.classList.toggle("cr-dropdown--open",e);const r=fe(`#${h.pW}_char_trigger`);r&&r.setAttribute("aria-expanded",String(e)),e||(Oe=-1)}function Ne(){const e=ze.trim();if(!e)return Ee().slice(0,30);return function(){var e;const t=Ee();if(!Ae||(null===(e=Ae._docs)||void 0===e?void 0:e.length)!==t.length){const e=SillyTavern.libs.Fuse;Ae=new e(t,{keys:[{name:"name",weight:3},{name:"description",weight:1}],threshold:.3,includeScore:!0,minMatchCharLength:2,ignoreLocation:!0})}return Ae}().search(e).map(e=>e.item).slice(0,20)}function Le(){var e;const t=B(),r=Ne(),n=null===(e=t.character)||void 0===e?void 0:e.avatar;return 0===r.length?`\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid ${ze?"fa-search":"fa-users-slash"}"></i>\n                ${ze?`No matches for "${he(ze,20)}"`:"No characters available"}\n            </div>\n        `:r.map((e,t)=>function(e,t,r){var n,i;const a=SillyTavern.libs.DOMPurify,o=SillyTavern.getContext().getThumbnailUrl("avatar",e.avatar),s=k(e).length,c=he((e.description||"").replace(/\n/g," "),60),l=(null===(n=e.data)||void 0===n?void 0:n.creator)||"",d=(null===(i=e.data)||void 0===i?void 0:i.character_version)||"",p=[];return l&&p.push(l),d&&p.push(`v${d}`),0===p.length&&p.push(`${s} ${1===s?"field":"fields"}`),`\n        <div class="cr-char-option ${r?"cr-char-option--selected":""} ${t===Oe?"cr-char-option--highlighted":""}"\n             data-avatar="${a.sanitize(e.avatar)}"\n             data-index="${t}"\n             role="option"\n             aria-selected="${r}">\n            <div class="cr-char-option__avatar-wrap">\n                <img class="cr-char-option__avatar"\n                     src="${o}"\n                     alt=""\n                     onerror="this.src='/img/ai4.png'"\n                     loading="lazy"/>\n                ${r?'<i class="fa-solid fa-check cr-char-option__check"></i>':""}\n            </div>\n            <div class="cr-char-option__info">\n                <span class="cr-char-option__name">${a.sanitize(e.name)}</span>\n                ${c?`<span class="cr-char-option__desc">${a.sanitize(c)}</span>`:""}\n                <span class="cr-char-option__meta">\n                    <i class="fa-solid fa-user-pen"></i>\n                    ${a.sanitize(p.join("  "))}\n                </span>\n            </div>\n        </div>\n    `}(e,t,e.avatar===n)).join("")}function je(){if(!fe(`#${h.pW}_char_dropdown`))return;const e=SillyTavern.libs.DOMPurify,t=B().character,r=fe(`#${h.pW}_char_trigger`);if(r){const n=t?e.sanitize(t.name):"Select character...",i=t?`<img class="cr-dropdown__trigger-avatar"\n                   src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n                   alt=""\n                   onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';r.innerHTML=`\n            ${i}\n            <span class="cr-dropdown__trigger-text ${t?"":"cr-dropdown__trigger-text--placeholder"}">${n}</span>\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const n=fe(`#${h.pW}_char_list`);n&&(n.innerHTML=Le())}function Be(e){e.forEach((e,t)=>{e.classList.toggle("cr-char-option--highlighted",t===Oe),t===Oe&&e.scrollIntoView({block:"nearest"})})}function De(e){return Re(this,void 0,void 0,function*(){const t=e.dataset.avatar;if(!t)return;const r=Ee().find(e=>e.avatar===t);r&&(yield function(e){return W(this,void 0,void 0,function*(){yield T(B(),e,F)})}(r),ze="",We(!1),Se())})}var Me=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let Ue={isOpen:!1,type:"prompt",mode:"create",preset:null,activeTab:"edit"},Fe={},He=[];function Ge(){return`\n        <div id="${h.pW}_preset_drawer" class="cr-drawer" aria-hidden="true">\n            <div class="cr-drawer__backdrop"></div>\n            <aside class="cr-drawer__panel" role="dialog" aria-label="Preset Editor">\n                <div class="cr-drawer__content">\n                    ${qe()}\n                    ${Je()}\n                    ${Ye()}\n                </div>\n            </aside>\n        </div>\n    `}function qe(){const{type:e,mode:t,preset:r}=Ue;let n="",i="";return"create"===t?(n=`New ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-plus"):"edit"===t?(n=`Edit ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-pen"):(n=`Duplicate ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-copy"),`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid ${i} cr-text-accent"></i>\n                <h3>${n}</h3>\n                ${(null==r?void 0:r.isBuiltin)?'<span class="cr-badge cr-badge--info cr-badge--small">builtin</span>':""}\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n    `}function Je(){const{type:e,mode:t,preset:r}=Ue;return`\n        <div class="cr-drawer__body cr-scrollable">\n            ${"duplicate"===t&&(null==r?void 0:r.isBuiltin)?'\n                <div class="cr-alert cr-alert--info cr-mb-3">\n                    <i class="fa-solid fa-circle-info cr-alert__icon"></i>\n                    <div class="cr-alert__content">\n                        <div class="cr-alert__message">\n                            Builtin presets cannot be modified. You\'re creating an editable copy.\n                        </div>\n                    </div>\n                </div>\n            ':""}\n            ${function(){const{preset:e,mode:t}=Ue,r=SillyTavern.libs.DOMPurify;let n="";e&&(n="duplicate"===t?`${e.name} (Copy)`:e.name);return`\n        <div class="cr-form-group">\n            <label class="cr-label" for="${h.pW}_drawer_name">\n                Name <span class="cr-required">*</span>\n            </label>\n            <input type="text"\n                   id="${h.pW}_drawer_name"\n                   class="cr-input text_pole"\n                   value="${r.sanitize(n)}"\n                   placeholder="Enter preset name..."\n                   maxlength="100"\n                   autocomplete="off"/>\n        </div>\n    `}()}\n            ${function(){const{preset:e}=Ue,t=(null==e?void 0:e.stages)||[];return`\n        <div class="cr-form-group">\n            <label class="cr-label">\n                Applicable Stages\n                <span class="cr-hint cr-text-dim">(empty = all stages)</span>\n            </label>\n            <div class="cr-stage-chips">\n                ${h.an.map(e=>`\n                    <label class="cr-chip ${0===t.length||t.includes(e)?"cr-chip--active":""}">\n                        <input type="checkbox"\n                               name="drawer_stages"\n                               value="${e}"\n                               ${0===t.length||t.includes(e)?"checked":""}/>\n                        <span>${h.BA[e]}</span>\n                    </label>\n                `).join("")}\n            </div>\n        </div>\n    `}()}\n            ${"prompt"===e?function(){const{preset:e}=Ue,t=SillyTavern.libs.DOMPurify,r=(null==e?void 0:e.prompt)||"";return`\n        <div class="cr-form-group cr-form-group--grow">\n            <div class="cr-row cr-row--between">\n                <label class="cr-label" for="${h.pW}_drawer_prompt">\n                    Prompt Template <span class="cr-required">*</span>\n                </label>\n                <div class="cr-row cr-gap-1">\n                    <button id="${h.pW}_drawer_prompt_vars"\n                            class="menu_button menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="View available variables">\n                        <i class="fa-solid fa-code"></i>\n                        Variables\n                    </button>\n                </div>\n            </div>\n            <div class="cr-editor-wrap">\n                <textarea id="${h.pW}_drawer_prompt"\n                          class="cr-textarea cr-textarea--editor text_pole"\n                          placeholder="Enter your prompt template...\n\nUse {{character}} for character data, {{field_name}} for specific fields.\nThe prompt will be sent to the LLM along with the selected character fields."\n                          spellcheck="false">${t.sanitize(r)}</textarea>\n            </div>\n            <div class="cr-form-group__hint cr-row cr-row--between">\n                <span id="${h.pW}_drawer_prompt_tokens" class="cr-text-dim">Calculating tokens...</span>\n            </div>\n        </div>\n    `}():function(){const{preset:e}=Ue,t=SillyTavern.libs.DOMPurify;let r="";e&&"schema"in e&&(r="string"==typeof e.schema?e.schema:JSON.stringify(e.schema,null,2));return`\n        <div class="cr-form-group cr-form-group--grow">\n            <div class="cr-row cr-row--between">\n                <label class="cr-label" for="${h.pW}_drawer_schema">\n                    JSON Schema <span class="cr-required">*</span>\n                </label>\n            </div>\n\n            \x3c!-- Schema Toolbar --\x3e\n            <div class="cr-editor-toolbar">\n                <button id="${h.pW}_drawer_generate"\n                        class="menu_button menu_button--sm menu_button--primary"\n                        type="button"\n                        title="Generate schema from description using AI">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    AI Generate\n                </button>\n                <div class="cr-toolbar-divider"></div>\n                <button id="${h.pW}_drawer_validate"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Validate JSON schema">\n                    <i class="fa-solid fa-check-circle"></i>\n                    Validate\n                </button>\n                <button id="${h.pW}_drawer_format"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Format JSON">\n                    <i class="fa-solid fa-align-left"></i>\n                    Format\n                </button>\n                <button id="${h.pW}_drawer_minify"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Minify JSON">\n                    <i class="fa-solid fa-compress"></i>\n                </button>\n            </div>\n\n            \x3c!-- Schema Editor with syntax highlighting --\x3e\n            <div class="cr-code-editor" id="${h.pW}_drawer_schema_wrap">\n                <pre class="cr-code-editor__highlight" id="${h.pW}_drawer_schema_highlight" aria-hidden="true"><code class="language-json"></code></pre>\n                <textarea id="${h.pW}_drawer_schema"\n                          class="cr-code-editor__textarea cr-textarea--code text_pole"\n                          placeholder='{"name": "MySchema", "strict": true, "schema": {...}}'\n                          spellcheck="false">${t.sanitize(r)}</textarea>\n            </div>\n\n            \x3c!-- Validation messages --\x3e\n            <div id="${h.pW}_drawer_errors" class="cr-errors cr-hidden"></div>\n            <div id="${h.pW}_drawer_warnings" class="cr-warnings cr-hidden"></div>\n        </div>\n    `}()}\n        </div>\n    `}function Ye(){const{mode:e,preset:t}=Ue,r=(null==t?void 0:t.isBuiltin)||!1,n="create"===e?"Create Preset":"edit"===e?"Save Changes":"Create Copy";return`\n        <footer class="cr-drawer__footer">\n            <div class="cr-row cr-row--between cr-flex-1">\n                <div class="cr-row">\n                    ${t&&!r&&"edit"===e?`\n                        <button id="${h.pW}_drawer_delete"\n                                class="menu_button menu_button--danger"\n                                type="button">\n                            <i class="fa-solid fa-trash"></i>\n                            Delete\n                        </button>\n                    `:""}\n                </div>\n                <div class="cr-row cr-gap-2">\n                    <button id="${h.pW}_drawer_cancel"\n                            class="menu_button"\n                            type="button">\n                        Cancel\n                    </button>\n                    <button id="${h.pW}_drawer_save"\n                            class="menu_button menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-check"></i>\n                        ${n}\n                    </button>\n                </div>\n            </div>\n        </footer>\n    `}function Ve(){const{type:e}=Ue,t=[..."prompt"===e?y.presetRegistry.getPromptPresets():y.presetRegistry.getSchemaPresets()].sort((e,t)=>e.isBuiltin!==t.isBuiltin?e.isBuiltin?1:-1:e.name.localeCompare(t.name)),r=t.filter(e=>!e.isBuiltin).length,n=t.filter(e=>e.isBuiltin).length;return`\n        <div class="cr-drawer__body cr-drawer__body--list">\n            ${0===t.length?`\n                <div class="cr-empty cr-empty--compact">\n                    <i class="fa-solid fa-bookmark cr-empty__icon"></i>\n                    <div class="cr-empty__title">No ${e} presets</div>\n                    <div class="cr-empty__text">Create one to get started</div>\n                </div>\n            `:`\n                <div class="cr-preset-list cr-scrollable">\n                    ${r>0?'<div class="cr-preset-list__section-label">Custom</div>':""}\n                    ${t.filter(e=>!e.isBuiltin).map(t=>Qe(t,e)).join("")}\n                    ${n>0?'<div class="cr-preset-list__section-label">Built-in</div>':""}\n                    ${t.filter(e=>e.isBuiltin).map(t=>Qe(t,e)).join("")}\n                </div>\n            `}\n        </div>\n    `}function Qe(e,t){const r=SillyTavern.libs.DOMPurify,n=e.stages.length>0?e.stages.map(e=>h.BA[e]).join(", "):"All stages";return`\n        <div class="cr-preset-list__item ${e.isBuiltin?"cr-preset-list__item--builtin":""}"\n             data-id="${e.id}"\n             data-type="${t}">\n            <button class="cr-preset-list__select" type="button" title="Apply this preset">\n                <div class="cr-preset-list__info">\n                    <span class="cr-preset-list__name">\n                        ${e.isBuiltin?'<i class="fa-solid fa-lock cr-text-dim"></i>':""}\n                        ${r.sanitize(e.name)}\n                    </span>\n                    <span class="cr-preset-list__stages">${n}</span>\n                </div>\n            </button>\n            <div class="cr-preset-list__actions">\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Edit">\n                        <i class="fa-solid fa-pen"></i>\n                    </button>\n                '}\n                <button class="cr-preset-list__action cr-preset-list__action--duplicate menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        type="button" title="${e.isBuiltin?"Create editable copy":"Duplicate"}">\n                    <i class="fa-solid fa-copy"></i>\n                </button>\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                '}\n            </div>\n        </div>\n    `}function Xe(e,t){Ue={isOpen:!0,type:e,mode:"list",preset:null,activeTab:"edit"},Fe=t||{},Ze()}function Ke(){const e=fe(`#${h.pW}_preset_drawer`);e&&(e.classList.remove("cr-drawer--open"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{var e;He.forEach(e=>e()),He=[],Ue.isOpen=!1,null===(e=Fe.onClose)||void 0===e||e.call(Fe)},300))}function Ze(){const e=fe(`#${h.pW}_preset_drawer`);if(!e)return void h.Rm.error("Drawer not initialized");const t=fe(".cr-drawer__panel",e);t&&("list"===Ue.mode?t.innerHTML=`\n                <div class="cr-drawer__content cr-drawer__content--list">\n                    ${function(){const{type:e}=Ue;return`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid fa-bookmark cr-text-accent"></i>\n                <h3>Manage Presets</h3>\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n        <div class="cr-drawer__tabs">\n            <button class="cr-drawer__tab ${"prompt"===e?"cr-drawer__tab--active":""}"\n                    data-tab="prompt" type="button">\n                <i class="fa-solid fa-message"></i>\n                Prompts\n            </button>\n            <button class="cr-drawer__tab ${"schema"===e?"cr-drawer__tab--active":""}"\n                    data-tab="schema" type="button">\n                <i class="fa-solid fa-code"></i>\n                Schemas\n            </button>\n        </div>\n    `}()}\n                    ${Ve()}\n                    \n        <footer class="cr-drawer__footer cr-drawer__footer--list">\n            <button id="${h.pW}_drawer_list_create"\n                    class="menu_button menu_button--primary"\n                    type="button">\n                <i class="fa-solid fa-plus"></i>\n                New Preset\n            </button>\n            <div class="cr-row cr-gap-2">\n                <button id="${h.pW}_drawer_list_import"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Import presets from file">\n                    <i class="fa-solid fa-file-import"></i>\n                </button>\n                <button id="${h.pW}_drawer_list_export"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Export custom presets">\n                    <i class="fa-solid fa-file-export"></i>\n                </button>\n            </div>\n        </footer>\n    \n                </div>\n            `:t.innerHTML=`\n                <div class="cr-drawer__content">\n                    ${qe()}\n                    ${Je()}\n                    ${Ye()}\n                </div>\n            `),"list"===Ue.mode?function(e){const t=fe(`#${h.pW}_drawer_close`,e);t&&He.push(ge(t,"click",Ke));const r=fe(".cr-drawer__backdrop",e);r&&He.push(ge(r,"click",Ke));const n=me(".cr-drawer__tab",e);for(const t of n)He.push(ge(t,"click",()=>{const r=t.dataset.tab;if(r===Ue.type)return;Ue.type=r,n.forEach(e=>e.classList.remove("cr-drawer__tab--active")),t.classList.add("cr-drawer__tab--active");const i=fe(".cr-drawer__body--list",e);i&&(i.outerHTML=Ve())}));He.push(ge(e,"click",t=>Me(this,void 0,void 0,function*(){var r,n;const i=t.target;if(!i.closest(".cr-preset-list"))return;const a=i.closest(".cr-preset-list__item");if(!a)return;const o=a.dataset.id,s=a.dataset.type;if(!o||!s)return;const c="prompt"===s?y.presetRegistry.getPromptPreset(o):y.presetRegistry.getSchemaPreset(o);if(c){if(i.closest(".cr-preset-list__select"))return null===(r=Fe.onSelect)||void 0===r||r.call(Fe,c),void Ke();if(i.closest(".cr-preset-list__action--edit"))!function(e,t){const r="prompt"===e?y.presetRegistry.getPromptPreset(t):y.presetRegistry.getSchemaPreset(t);if(!r)return;He.forEach(e=>e()),He=[],Ue.mode="edit",Ue.type=e,Ue.preset=r;const n=fe(`#${h.pW}_preset_drawer`);if(!n)return;const i=fe(".cr-drawer__panel",n);i&&(i.innerHTML=`\n            <div class="cr-drawer__content">\n                ${qe()}\n                ${Je()}\n                ${Ye()}\n            </div>\n        `);et(n);const a=fe(`#${h.pW}_drawer_name`,n);a&&(a.focus(),a.select());"schema"===e&&tt()}(s,o);else if(i.closest(".cr-preset-list__action--duplicate"))!function(e,t){const r="prompt"===e?y.presetRegistry.getPromptPreset(t):y.presetRegistry.getSchemaPreset(t);if(!r)return;He.forEach(e=>e()),He=[],Ue.mode="duplicate",Ue.type=e,Ue.preset=r;const n=fe(`#${h.pW}_preset_drawer`);if(!n)return;const i=fe(".cr-drawer__panel",n);i&&(i.innerHTML=`\n            <div class="cr-drawer__content">\n                ${qe()}\n                ${Je()}\n                ${Ye()}\n            </div>\n        `);et(n);const a=fe(`#${h.pW}_drawer_name`,n);a&&(a.focus(),a.select());"schema"===e&&tt()}(s,o);else if(i.closest(".cr-preset-list__action--delete")){if(!(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${c.name}"?`)))return;"prompt"===s?y.presetRegistry.deletePromptPreset(o):y.presetRegistry.deleteSchemaPreset(o),h.oR.success("Preset deleted"),null===(n=Fe.onUpdate)||void 0===n||n.call(Fe),at(e)}}})));const i=fe(`#${h.pW}_drawer_list_create`,e);i&&He.push(ge(i,"click",()=>{!function(e){He.forEach(e=>e()),He=[],Ue.mode="create",Ue.type=e,Ue.preset=null;const t=fe(`#${h.pW}_preset_drawer`);if(!t)return;const r=fe(".cr-drawer__panel",t);r&&(r.innerHTML=`\n            <div class="cr-drawer__content">\n                ${qe()}\n                ${Je()}\n                ${Ye()}\n            </div>\n        `);et(t);const n=fe(`#${h.pW}_drawer_name`,t);n&&n.focus()}(Ue.type)}));const a=fe(`#${h.pW}_drawer_list_import`,e);a&&He.push(ge(a,"click",ot));const o=fe(`#${h.pW}_drawer_list_export`,e);o&&He.push(ge(o,"click",st));const s=e=>{"Escape"===e.key&&Ue.isOpen&&(e.preventDefault(),e.stopPropagation(),Ke())};document.addEventListener("keydown",s),He.push(()=>document.removeEventListener("keydown",s))}(e):et(e),requestAnimationFrame(()=>{if(e.classList.add("cr-drawer--open"),e.setAttribute("aria-hidden","false"),"list"!==Ue.mode){const t=fe(`#${h.pW}_drawer_name`,e);t&&(t.focus(),t.select()),"schema"===Ue.type&&tt()}})}function et(e){const t=fe(`#${h.pW}_drawer_close`,e);t&&He.push(ge(t,"click",Ke));const r=fe(".cr-drawer__backdrop",e);r&&He.push(ge(r,"click",Ke));const n=fe(`#${h.pW}_drawer_cancel`,e);n&&He.push(ge(n,"click",Ke));const i=fe(`#${h.pW}_drawer_save`,e);i&&He.push(ge(i,"click",rt));const a=fe(`#${h.pW}_drawer_delete`,e);a&&He.push(ge(a,"click",it));const o=me('.cr-chip input[name="drawer_stages"]',e);for(const e of o)He.push(ge(e,"change",()=>{const t=e.closest(".cr-chip");t&&t.classList.toggle("cr-chip--active",e.checked)}));"prompt"===Ue.type?function(e){const t=fe(`#${h.pW}_drawer_prompt`,e);if(t){const e=SillyTavern.libs.lodash.debounce(()=>Me(this,void 0,void 0,function*(){const e=fe(`#${h.pW}_drawer_prompt_tokens`);if(!e)return;const r=t.value,n=Math.ceil(r.length/4);e.textContent=`~${n} tokens`}),300);He.push(ge(t,"input",()=>{e()})),e()}const r=fe(`#${h.pW}_drawer_prompt_vars`,e);r&&He.push(ge(r,"click",()=>Me(this,void 0,void 0,function*(){yield h.lY.alert("Available Variables",'\n                    <div class="cr-stack">\n                        <p>Use these placeholders in your prompt:</p>\n                        <ul class="cr-list cr-text-sm">\n                            <li><code>{{character}}</code> - Full character summary</li>\n                            <li><code>{{name}}</code> - Character name</li>\n                            <li><code>{{description}}</code> - Character description</li>\n                            <li><code>{{personality}}</code> - Personality traits</li>\n                            <li><code>{{scenario}}</code> - Scenario/setting</li>\n                            <li><code>{{first_mes}}</code> - First message</li>\n                            <li><code>{{mes_example}}</code> - Example messages</li>\n                            <li><code>{{system_prompt}}</code> - System prompt</li>\n                            <li><code>{{creator_notes}}</code> - Creator notes</li>\n                        </ul>\n                    </div>\n                ')})))}(e):function(e){const t=fe(`#${h.pW}_drawer_schema`,e);if(t){const e=SillyTavern.libs.lodash.debounce(()=>{tt()},100);He.push(ge(t,"input",()=>{e()})),He.push(ge(t,"scroll",()=>{!function(e){const t=fe(`#${h.pW}_drawer_schema_highlight`);t&&(t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft)}(t)}))}const r=fe(`#${h.pW}_drawer_generate`,e);r&&He.push(ge(r,"click",()=>Me(this,void 0,void 0,function*(){const e=yield h.lY.input("Generate Schema","Describe the structure you want:","e.g., rating 1-10, list of strengths and weaknesses, summary paragraph");if(!e)return;r.setAttribute("disabled","true");const n=r.querySelector("i"),i=null==n?void 0:n.className;n&&(n.className="fa-solid fa-spinner fa-spin");try{const r=yield(0,I.nr)(e);r.success&&r.schema&&t?(t.value=r.schema,tt(),h.oR.success("Schema generated"),function(){const e=fe(`#${h.pW}_drawer_errors`),t=fe(`#${h.pW}_drawer_warnings`);null==e||e.classList.add("cr-hidden"),null==t||t.classList.add("cr-hidden")}()):h.oR.error(r.error||"Generation failed")}catch(e){h.oR.error(`Failed: ${e.message}`)}finally{r.removeAttribute("disabled"),n&&i&&(n.className=i)}})));const n=fe(`#${h.pW}_drawer_validate`,e);n&&t&&He.push(ge(n,"click",()=>{!function(e){var t;const r=fe(`#${h.pW}_drawer_errors`),n=fe(`#${h.pW}_drawer_warnings`);r&&(e.valid?(r.classList.add("cr-hidden"),h.oR.success("Schema is valid")):(r.innerHTML=`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e.error}</div>`,r.classList.remove("cr-hidden")));n&&((null===(t=e.warnings)||void 0===t?void 0:t.length)?(n.innerHTML=e.warnings.map(e=>`<div class="cr-warning"><i class="fa-solid fa-exclamation-triangle"></i> ${e}</div>`).join(""),n.classList.remove("cr-hidden")):n.classList.add("cr-hidden"))}((0,I.i6)(t.value))}));const i=fe(`#${h.pW}_drawer_format`,e);i&&t&&He.push(ge(i,"click",()=>{try{const e=JSON.parse(t.value);t.value=(0,I.jf)(e),tt(),h.oR.success("Formatted")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const a=fe(`#${h.pW}_drawer_minify`,e);a&&t&&He.push(ge(a,"click",()=>{try{const e=JSON.parse(t.value);t.value=JSON.stringify(e),tt(),h.oR.success("Minified")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}))}(e);const s=e=>{"Escape"===e.key&&Ue.isOpen&&(e.preventDefault(),e.stopPropagation(),Ke())};document.addEventListener("keydown",s),He.push(()=>document.removeEventListener("keydown",s))}function tt(){const e=fe(`#${h.pW}_drawer_schema`),t=fe(`#${h.pW}_drawer_schema_highlight code`);if(!e||!t)return;const r=SillyTavern.libs.hljs,n=SillyTavern.libs.DOMPurify;try{const i=r.highlight(e.value||" ",{language:"json"});t.innerHTML=n.sanitize(i.value)}catch(r){t.textContent=e.value}}function rt(){return Me(this,void 0,void 0,function*(){var e,t;const{type:r,mode:n,preset:i}=Ue,a=fe(`#${h.pW}_drawer_name`),o=(null==a?void 0:a.value.trim())||"",s=me('input[name="drawer_stages"]:checked'),c=Array.from(s).map(e=>e.value),l=c.length===h.an.length?[]:c;if("prompt"===r){const t=fe(`#${h.pW}_drawer_prompt`),r=(null==t?void 0:t.value)||"",a=(0,y.validatePromptPreset)({name:o,prompt:r,stages:l});if(!a.valid)return void nt(a.errors);const s="edit"===n?null==i?void 0:i.id:void 0;if(!y.presetRegistry.isNameUnique("prompt",o,s))return void nt(["A preset with this name already exists"]);let c;"edit"===n&&i?(y.presetRegistry.updatePromptPreset(i.id,{name:o,prompt:r,stages:l}),c=y.presetRegistry.getPromptPreset(i.id),h.oR.success("Preset updated")):(c=y.presetRegistry.registerPromptPreset({name:o,prompt:r,stages:l}),h.oR.success("Preset created")),null===(e=Fe.onSave)||void 0===e||e.call(Fe,c),Ke()}else{const e=fe(`#${h.pW}_drawer_schema`),r=(null==e?void 0:e.value)||"";let a;try{a=JSON.parse(r)}catch(e){return void nt([`Invalid JSON: ${e.message}`])}const s=(0,y.validateSchemaPreset)({name:o,schema:a,stages:l});if(!s.valid)return void nt(s.errors);const c="edit"===n?null==i?void 0:i.id:void 0;if(!y.presetRegistry.isNameUnique("schema",o,c))return void nt(["A preset with this name already exists"]);let d;"edit"===n&&i?(y.presetRegistry.updateSchemaPreset(i.id,{name:o,schema:a,stages:l}),d=y.presetRegistry.getSchemaPreset(i.id),h.oR.success("Schema preset updated")):(d=y.presetRegistry.registerSchemaPreset({name:o,schema:a,stages:l}),h.oR.success("Schema preset created")),null===(t=Fe.onSave)||void 0===t||t.call(Fe,d),Ke()}})}function nt(e){const t=fe(`#${h.pW}_drawer_errors`);t&&(t.innerHTML=e.map(e=>`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e}</div>`).join(""),t.classList.remove("cr-hidden"))}function it(){return Me(this,void 0,void 0,function*(){const{type:e,preset:t}=Ue;if(!t)return;(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${t.name}"?`))&&("prompt"===e?y.presetRegistry.deletePromptPreset(t.id):y.presetRegistry.deleteSchemaPreset(t.id),h.oR.success("Preset deleted"),Ke())})}function at(e){const t=fe(".cr-drawer__body--list",e);t&&(t.outerHTML=Ve())}function ot(){return Me(this,void 0,void 0,function*(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>Me(this,void 0,void 0,function*(){var t,r;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n)try{const e=yield n.text(),t=JSON.parse(e),i=(0,y.getSettings)();let a=0;if(Array.isArray(t.promptPresets))for(const e of t.promptPresets)e.isBuiltin||(e.id=crypto.randomUUID(),i.promptPresets.push(e),a++);if(Array.isArray(t.schemaPresets))for(const e of t.schemaPresets)e.isBuiltin||(e.id=crypto.randomUUID(),i.schemaPresets.push(e),a++);(0,y.save)(),h.oR.success(`Imported ${a} preset${1!==a?"s":""}`),null===(r=Fe.onUpdate)||void 0===r||r.call(Fe);const o=fe(`#${h.pW}_preset_drawer`);o&&"list"===Ue.mode&&at(o)}catch(e){h.oR.error("Failed to import presets"),h.Rm.error("Import error:",e)}}),e.click()})}function st(){const e=(0,y.getSettings)(),t=e.promptPresets.filter(e=>!e.isBuiltin),r=e.schemaPresets.filter(e=>!e.isBuiltin);if(0===t.length&&0===r.length)return void h.oR.warning("No custom presets to export");const n={version:h.xv,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:r},i=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.download=`character-tools-presets-${(new Date).toISOString().slice(0,10)}.json`,o.click(),URL.revokeObjectURL(a),h.oR.success(`Exported ${t.length+r.length} preset${t.length+r.length!==1?"s":""}`)}var ct=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let lt=[];function dt(){const e=B();if(!e.character)return'\n            <div class="cr-empty cr-empty--compact cr-empty--inline">\n                <i class="fa-solid fa-user-slash cr-empty__icon"></i>\n                <span class="cr-empty__text">Select a character to see fields</span>\n            </div>\n        ';const t=k(e.character);return 0===t.length?'\n            <div class="cr-empty cr-empty--compact cr-empty--inline">\n                <i class="fa-solid fa-file-circle-question cr-empty__icon"></i>\n                <span class="cr-empty__text">No populated fields found</span>\n            </div>\n        ':(requestAnimationFrame(()=>function(e){return ct(this,void 0,void 0,function*(){const t=e.filter(e=>"alternate_greetings"!==e.key).map(e=>({key:e.key,text:e.value}));if(0===t.length)return;const r=yield(0,h.gg)(t);for(const{key:e,tokens:t}of r){null!==t&&pt.set(e,t);const r=fe(`.cr-field-tokens[data-field="${e}"]`);r&&(r.textContent=ve(t))}ut()})}(t)),`\n        <div class="cr-field-list cr-scrollable">\n            ${t.map(e=>function(e){const t=SillyTavern.libs.DOMPurify,r=X(),n=e.key in r&&!1!==r[e.key];if("alternate_greetings"===e.key&&Array.isArray(e.rawValue)){const n=e.rawValue,i=Array.isArray(r[e.key])?r[e.key]:[],a=i.length===n.length;return`\n            <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n                <div class="cr-field-item cr-field-item--parent">\n                    <label class="cr-field-label">\n                        <input type="checkbox"\n                               class="cr-field-checkbox cr-field-checkbox--parent"\n                               data-field="${e.key}"\n                               ${a?"checked":""}\n                               ${i.length>0&&!a?"indeterminate":""}/>\n                        <span class="cr-field-name">${t.sanitize(e.label)}</span>\n                    </label>\n                    <span class="cr-field-count">${n.length} greetings</span>\n                    <button class="cr-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="cr-field-children">\n                    ${n.map((t,r)=>`\n                        <div class="cr-field-item cr-field-item--child">\n                            <label class="cr-field-label">\n                                <input type="checkbox"\n                                       class="cr-field-checkbox cr-field-checkbox--child"\n                                       data-field="${e.key}"\n                                       data-index="${r}"\n                                       ${i.includes(r)?"checked":""}/>\n                                <span class="cr-field-name">Greeting ${r+1}</span>\n                            </label>\n                            <button class="cr-field-preview-btn" type="button" data-field="${e.key}" data-index="${r}" title="Preview greeting">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}const i=150,a=e.value.length>i?e.value.substring(0,i).trim()+"":e.value;return`\n        <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n            <div class="cr-field-item cr-field-item--has-preview">\n                <label class="cr-field-label">\n                    <input type="checkbox"\n                           class="cr-field-checkbox"\n                           data-field="${e.key}"\n                           ${n?"checked":""}/>\n                    <span class="cr-field-name">${t.sanitize(e.label)}</span>\n                </label>\n                <span class="cr-field-tokens" data-field="${e.key}">${ve(e.tokens)}</span>\n                <button class="cr-field-expand" type="button" aria-label="Expand field preview">\n                    <i class="fa-solid fa-chevron-down"></i>\n                </button>\n            </div>\n            <div class="cr-field-preview">\n                <pre class="cr-field-preview__text">${t.sanitize(a)}</pre>\n                <button class="cr-field-preview__more" type="button" data-field="${e.key}" title="View full content in popup">\n                    <i class="fa-solid fa-expand"></i>\n                    <span>View full content</span>\n                </button>\n            </div>\n        </div>\n    `}(e)).join("")}\n        </div>\n        <div class="cr-field-total">\n            <span class="cr-field-total__label">Selected:</span>\n            <span id="${h.pW}_field_total" class="cr-field-total__value">calculating...</span>\n        </div>\n        <div id="${h.pW}_token_warning" class="cr-token-warning cr-hidden">\n            <i class="fa-solid fa-triangle-exclamation"></i>\n            <span class="cr-token-warning__text"></span>\n        </div>\n    `)}const pt=new Map;function ut(){const e=fe(`#${h.pW}_field_total`);if(!e)return;const t=X();let r=0,n=0;for(const[e,i]of pt){e in t&&!1!==t[e]&&(r+=i,n++)}e.textContent=0===n?"none":`${n} fields, ~${r.toLocaleString()}t`,function(e){const t=fe(`#${h.pW}_token_warning`);if(!t)return;const r=B(),n=t.querySelector(".cr-token-warning__text");if("rewrite"!==r.activeStage||0===e)return void t.classList.add("cr-hidden");const i=(0,y.getSettings)(),a=(0,h.Lq)(i.profileId),o=null!==i.maxTokensOverride?i.maxTokensOverride:a.maxOutput,s=e,c=Math.ceil(1.2*e);o<s?(t.classList.remove("cr-hidden"),t.classList.add("cr-token-warning--critical"),t.classList.remove("cr-token-warning--warning"),n&&(n.textContent=`Max output (${o.toLocaleString()}t) is less than character tokens (~${e.toLocaleString()}t). Rewrite will likely be truncated.`)):o<c?(t.classList.remove("cr-hidden"),t.classList.remove("cr-token-warning--critical"),t.classList.add("cr-token-warning--warning"),n&&(n.textContent=`Max output (${o.toLocaleString()}t) is close to character tokens (~${e.toLocaleString()}t). Consider increasing output limit.`)):t.classList.add("cr-hidden")}(r)}function ft(e,t,r){const n=SillyTavern.libs.DOMPurify,i="prompt"===e?(0,y.getPromptPresetsForStage)(t):(0,y.getSchemaPresetsForStage)(t);return`\n        <div class="cr-preset-row">\n            <span class="cr-preset-label">${"prompt"===e?"Preset:":"Schema:"}</span>\n            <select id="${`${h.pW}_${e}_select`}" class="cr-select text_pole" aria-label="${e} preset">\n                <option value="">Custom</option>\n                ${i.map(e=>`\n                    <option value="${e.id}" ${e.id===r?"selected":""}>\n                        ${n.sanitize(e.name)}${e.isBuiltin?"":" "}\n                    </option>\n                `).join("")}\n            </select>\n            <button class="cr-preset-manage-btn menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                    data-type="${e}"\n                    type="button"\n                    title="Manage ${e} presets">\n                <i class="fa-solid fa-folder-open"></i>\n            </button>\n        </div>\n    `}function mt(e,t,r){const n=fe(`#${`${h.pW}_${e}_select`}`);if(!n)return;const i=SillyTavern.libs.DOMPurify,a=`\n        <option value="">Custom</option>\n        ${("prompt"===e?(0,y.getPromptPresetsForStage)(t):(0,y.getSchemaPresetsForStage)(t)).map(e=>`\n            <option value="${e.id}" ${e.id===r?"selected":""}>\n                ${i.sanitize(e.name)}${e.isBuiltin?"":" "}\n            </option>\n        `).join("")}\n    `;n.innerHTML=a}function gt(){const e=fe(".cr-stage-config");if(!e)return;const t=B(),r=t.activeStage,n=t.stageConfigs[r],i=e.querySelector(".cr-section__title");i&&(i.innerHTML=`\n            <i class="fa-solid ${h.iu[r]}"></i>\n            ${h.BA[r]} Configuration\n        `);const a=fe(`#${h.pW}_fields_container`);a&&(a.innerHTML=dt());const o=fe(`#${h.pW}_prompt`);if(o){let e=n.customPrompt;if(!e&&n.promptPresetId){const t=(0,y.getPromptPreset)(n.promptPresetId);t&&(e=t.prompt)}o.value=e,vt(o.value)}mt("prompt",r,n.promptPresetId);const s=fe(`#${h.pW}_use_schema`);s&&(s.checked=n.useStructuredOutput);const c=fe(`#${h.pW}_schema_section`);c&&c.classList.toggle("cr-hidden",!n.useStructuredOutput),mt("schema",r,n.schemaPresetId);const l=fe(`#${h.pW}_schema`);if(l){let e=n.customSchema;if(!e&&n.schemaPresetId){const t=(0,y.getSchemaPreset)(n.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}l.value=e}const d=fe(`#${h.pW}_preview`);d&&(d.disabled=!t.character);const p=fe(`#${h.pW}_link_fields`);if(p){const e=K();p.classList.toggle("cr-active",e),p.setAttribute("aria-pressed",String(e)),p.title=e?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const t=p.querySelector("i");t&&(t.className="fa-solid "+(e?"fa-link":"fa-link-slash"))}}function vt(e){return ct(this,void 0,void 0,function*(){const t=fe(`#${h.pW}_prompt_tokens`);if(!t)return;const r=yield(0,h.NR)(e);t.textContent=null!==r?`~${r} tokens`:`~${Math.ceil(e.length/4)} tokens`})}function ht(e){const t=SillyTavern.libs.DOMPurify,r=[],n=fe(`#${h.pW}_link_fields`,e);n&&r.push(ge(n,"click",()=>{!function(){const e=B();if(e.stageFields.linked=!e.stageFields.linked,!e.stageFields.linked){const{lodash:t}=SillyTavern.libs;e.stageFields.overrides[e.activeStage]=t.cloneDeep(e.stageFields.base)}U()}();const e=K();n.classList.toggle("cr-active",e),n.setAttribute("aria-pressed",String(e)),n.title=e?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const t=n.querySelector("i");t&&(t.className="fa-solid "+(e?"fa-link":"fa-link-slash")),gt()}));const i=fe(`#${h.pW}_fields_container`,e);i&&(r.push(ge(i,"change",e=>{const t=e.target;if(!t.classList.contains("cr-field-checkbox"))return;const r=t.dataset.field;if(r){if(void 0!==t.dataset.index){const e=parseInt(t.dataset.index,10),n=X(),i=Array.isArray(n[r])?[...n[r]]:[];if(t.checked)i.includes(e)||i.push(e);else{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}Z(r,i.length>0&&i.sort((e,t)=>e-t))}else if(t.classList.contains("cr-field-checkbox--parent")){const e=t.closest(".cr-field-group");if(!e)return;const n=me(".cr-field-checkbox--child",e);if(t.checked){Z(r,n.map((e,t)=>t))}else Z(r,!1)}else Z(r,t.checked);!function(){const e=fe(`#${h.pW}_fields_container`);if(!e)return;const t=me(".cr-field-group",e);for(const e of t){if(!e.dataset.field)continue;const t=fe(".cr-field-checkbox--parent",e),r=me(".cr-field-checkbox--child",e);if(!t)continue;const n=r.filter(e=>e.checked).length,i=r.length;0===n?(t.checked=!1,t.indeterminate=!1):n===i?(t.checked=!0,t.indeterminate=!1):(t.checked=!1,t.indeterminate=!0)}ut()}()}})),r.push(ge(i,"click",e=>{const t=e.target.closest(".cr-field-expand");if(!t)return;const r=t.closest(".cr-field-group");r&&r.classList.toggle("cr-field-group--expanded")})),r.push(ge(i,"click",e=>ct(this,void 0,void 0,function*(){const t=e.target.closest(".cr-field-preview__more");if(!t)return;const r=t.dataset.field;if(!r)return;const n=B();if(!n.character)return;const i=k(n.character).find(e=>e.key===r);i&&h.lY.alert(i.label,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(i.value)}</pre>`)}))),r.push(ge(i,"click",e=>ct(this,void 0,void 0,function*(){const t=e.target.closest(".cr-field-preview-btn");if(!t)return;const r=t.dataset.field,n=t.dataset.index;if(!r||void 0===n)return;const i=B();if(!i.character)return;const a=k(i.character).find(e=>e.key===r);if(!a||!Array.isArray(a.rawValue))return;const o=parseInt(n,10),s=a.rawValue[o];s&&h.lY.alert(`Greeting ${o+1}`,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(s)}</pre>`)}))));const a=fe(`#${h.pW}_prompt`,e);if(a){const e=SillyTavern.libs.lodash.debounce(e=>{te(B().activeStage,{customPrompt:e,promptPresetId:null}),vt(e)},300);lt.push(e),r.push(ge(a,"input",()=>{e(a.value)})),r.push(()=>{e.cancel();const t=lt.indexOf(e);-1!==t&&lt.splice(t,1)}),vt(a.value)}const o=fe(`#${h.pW}_prompt_select`,e);o&&r.push(ge(o,"change",()=>{const e=B(),t=o.value||null;if(te(e.activeStage,{promptPresetId:t,customPrompt:""}),a)if(t){const e=(0,y.getPromptPreset)(t);e&&(a.value=e.prompt,vt(e.prompt))}else a.value="",vt("")}));const s=fe(`#${h.pW}_save_prompt`,e);s&&r.push(ge(s,"click",()=>ct(this,void 0,void 0,function*(){const e=B(),t=(null==a?void 0:a.value)||"";if(!t.trim())return void h.oR.warning("Enter a prompt first");const r=e.stageConfigs[e.activeStage],n=(null==r?void 0:r.promptPresetId)?(0,y.getPromptPreset)(r.promptPresetId):null;if(n&&!n.isBuiltin)return(0,y.updatePromptPreset)(n.id,{prompt:t}),h.oR.success(`Updated preset "${n.name}"`),void gt();const i=y.presetRegistry.getPromptPresets().map(e=>e.name),o=(0,h.Sn)(`${h.BA[e.activeStage]} Custom`,i),s=yield h.lY.input("Save Prompt Preset","Enter a name for this preset:",o);if(!s)return;const c=(0,y.savePromptPreset)({name:s.trim(),stages:[e.activeStage],prompt:t});te(e.activeStage,{promptPresetId:c.id,customPrompt:""}),h.oR.success(`Saved preset "${c.name}"`),gt()})));const c=fe(`#${h.pW}_use_schema`,e),l=fe(`#${h.pW}_schema_section`,e);c&&l&&r.push(ge(c,"change",()=>{te(B().activeStage,{useStructuredOutput:c.checked}),l.classList.toggle("cr-hidden",!c.checked)}));const d=fe(`#${h.pW}_schema`,e);if(d){const e=SillyTavern.libs.lodash.debounce(e=>{te(B().activeStage,{customSchema:e,schemaPresetId:null})},300);lt.push(e),r.push(ge(d,"input",()=>{e(d.value)})),r.push(()=>{e.cancel();const t=lt.indexOf(e);-1!==t&&lt.splice(t,1)})}const p=fe(`#${h.pW}_schema_select`,e);p&&d&&r.push(ge(p,"change",()=>{const e=B(),t=p.value||null;if(te(e.activeStage,{schemaPresetId:t,customSchema:""}),t){const e=(0,y.getSchemaPreset)(t);e&&(d.value=JSON.stringify(e.schema,null,2))}else d.value=""}));const u=fe(`#${h.pW}_generate_schema`,e);u&&d&&r.push(ge(u,"click",()=>ct(this,void 0,void 0,function*(){const t=yield h.lY.input("Generate JSON Schema",'Describe the structure you want (e.g., "rating 1-10, list of issues, summary"):',"");if(!t)return;const r=u.innerHTML;u.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Generating...',u.disabled=!0;try{const r=yield(0,I.nr)(t);if(r.success&&r.schema){d.value=r.schema;te(B().activeStage,{customSchema:r.schema,schemaPresetId:null});const t=fe(`#${h.pW}_schema_select`,e);t&&(t.value=""),h.oR.success("Schema generated! Review and save as preset if desired.")}else h.oR.error(r.error||"Failed to generate schema"),r.schema&&(d.value=r.schema)}catch(e){h.oR.error(`Generation failed: ${e.message}`)}finally{u.innerHTML=r,u.disabled=!1}})));const f=fe(`#${h.pW}_validate_schema`,e);f&&d&&r.push(ge(f,"click",()=>{try{JSON.parse(d.value),h.oR.success("Valid JSON")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const m=fe(`#${h.pW}_format_schema`,e);m&&d&&r.push(ge(m,"click",()=>{try{const e=JSON.parse(d.value);d.value=JSON.stringify(e,null,2),h.oR.success("Formatted")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const g=fe(`#${h.pW}_save_schema`,e);g&&d&&r.push(ge(g,"click",()=>ct(this,void 0,void 0,function*(){const e=B(),t=d.value||"";if(!t.trim())return void h.oR.warning("Enter a schema first");let r;try{r=JSON.parse(t)}catch(e){return void h.oR.error(`Invalid JSON: ${e.message}`)}const n=e.stageConfigs[e.activeStage],i=(null==n?void 0:n.schemaPresetId)?(0,y.getSchemaPreset)(n.schemaPresetId):null;if(i&&!i.isBuiltin)return(0,y.updateSchemaPreset)(i.id,{schema:r}),h.oR.success(`Updated preset "${i.name}"`),void gt();const a=y.presetRegistry.getSchemaPresets().map(e=>e.name),o=(0,h.Sn)(`${h.BA[e.activeStage]} Schema`,a),s=yield h.lY.input("Save Schema Preset","Enter a name for this schema preset:",o);if(!s)return;const c=(0,y.saveSchemaPreset)({name:s.trim(),stages:[e.activeStage],schema:r});te(e.activeStage,{schemaPresetId:c.id,customSchema:""}),h.oR.success(`Saved preset "${c.name}"`),gt()})));const v=fe(`#${h.pW}_preview`,e);v&&r.push(ge(v,"click",()=>ct(this,void 0,void 0,function*(){const e=B();if(!e.character)return void h.oR.warning("Select a character first");let r=S(e.character,e.selectedFields);e.userGuidance.trim()&&(r+=`\n\n---\n\n## USER GUIDANCE\n\n${e.userGuidance}`),yield h.lY.alert("Prompt Preview",`<div class="cr-preview-content"><pre>${t.sanitize(r)}</pre></div>`)})));const b=me(".cr-preset-manage-btn",e);for(const e of b)r.push(ge(e,"click",()=>{const t=e.dataset.type;Xe(t,{onSelect:e=>{const r=B();te(r.activeStage,"prompt"===t?{promptPresetId:e.id,customPrompt:""}:{schemaPresetId:e.id,customSchema:""}),gt()},onUpdate:()=>{gt()}})}));return()=>{r.forEach(e=>e())}}function yt(e){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[e.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function bt(){const e=B(),t=[];if(!e.character)return t;const r=k(e.character),n=e.stageResults.rewrite,i=(null==n?void 0:n.output)?function(e){var t,r;const n={},i=/^#{2,3}\s*(.+?)[\s:]*$/gm,a=[];let o;for(;null!==(o=i.exec(e))&&(a.push({name:o[1].trim().toLowerCase(),start:o.index+o[0].length}),!(a.length>=50)););for(let i=0;i<a.length;i++){const o=a[i],s=null!==(r=null===(t=a[i+1])||void 0===t?void 0:t.start)&&void 0!==r?r:e.length,c=e.slice(o.start,s).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=yt(o.name);l&&c&&(n[l]=c)}return n}(n.output):{};for(const e of r){const r=i[e.key]||null;t.push({key:e.key,label:e.label,original:e.value,rewritten:r,hasChanges:null!==r&&r!==e.value})}return t}function _t(e){const t=SillyTavern.libs.DOMPurify;if(!e.rewritten)return`\n            <div class="cr-compare-row cr-compare-row--unchanged">\n                <div class="cr-compare-row__header">\n                    <span class="cr-compare-row__label">${e.label}</span>\n                    <span class="cr-badge cr-badge--small cr-badge--muted">No changes</span>\n                </div>\n                <div class="cr-compare-row__content cr-compare-row__content--single">\n                    <pre class="cr-compare-text">${t.sanitize(e.original)}</pre>\n                </div>\n            </div>\n        `;const{originalHtml:r,rewrittenHtml:n}=function(e,t){const r=SillyTavern.libs.DOMPurify;return{originalHtml:r.sanitize(e),rewrittenHtml:r.sanitize(t)}}(e.original,e.rewritten);return`\n        <div class="cr-compare-row">\n            <div class="cr-compare-row__header">\n                <span class="cr-compare-row__label">${e.label}</span>\n            </div>\n            <div class="cr-compare-row__content">\n                <div class="cr-compare-col cr-compare-col--original">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-file"></i> Original\n                    </div>\n                    <pre class="cr-compare-text">${r}</pre>\n                </div>\n                <div class="cr-compare-col cr-compare-col--rewritten">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-pen-fancy"></i> Rewritten\n                    </div>\n                    <pre class="cr-compare-text">${n}</pre>\n                </div>\n            </div>\n        </div>\n    `}function xt(){const e=B();if(!e.character)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No character selected</div>\n                <div class="cr-empty__text">Select a character to compare versions</div>\n            </div>\n        ';if(!e.stageResults.rewrite)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No rewrite available</div>\n                <div class="cr-empty__text">Run the Rewrite stage first to see comparisons</div>\n            </div>\n        ';return`\n        <div class="cr-compare-view">\n            <div class="cr-compare-list cr-scrollable">\n                ${bt().map(_t).join("")}\n            </div>\n        </div>\n    `}var wt=r(29),$t=r.n(wt),kt=r(960);const St=(e,t=0)=>{let r=~~t,n=0;for(let t=0;t<e.length;t++)n+=e[t];return r+=n%256,r%256};var Pt=r(287);const Rt=(e,t)=>Pt.hp.from(e,t);function Et(e,t){const r=(e,r)=>t(Rt(e),r)>>>0;return r.signed=(e,r)=>t(Rt(e),r),r.unsigned=r,r.model=e,r}Et("crc1",St);let At=[0,7,14,9,28,27,18,21,56,63,54,49,36,35,42,45,112,119,126,121,108,107,98,101,72,79,70,65,84,83,90,93,224,231,238,233,252,251,242,245,216,223,214,209,196,195,202,205,144,151,158,153,140,139,130,133,168,175,166,161,180,179,186,189,199,192,201,206,219,220,213,210,255,248,241,246,227,228,237,234,183,176,185,190,171,172,165,162,143,136,129,134,147,148,157,154,39,32,41,46,59,60,53,50,31,24,17,22,3,4,13,10,87,80,89,94,75,76,69,66,111,104,97,102,115,116,125,122,137,142,135,128,149,146,155,156,177,182,191,184,173,170,163,164,249,254,247,240,229,226,235,236,193,198,207,200,221,218,211,212,105,110,103,96,117,114,123,124,81,86,95,88,77,74,67,68,25,30,23,16,5,2,11,12,33,38,47,40,61,58,51,52,78,73,64,71,82,85,92,91,118,113,120,127,106,109,100,99,62,57,48,55,34,37,44,43,6,1,8,15,26,29,20,19,174,169,160,167,178,181,188,187,150,145,152,159,138,141,132,131,222,217,208,215,194,197,204,203,230,225,232,239,250,253,244,243];"undefined"!=typeof Int32Array&&(At=new Int32Array(At));Et("crc-8",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&At[255&(r^e[t])];return r});let Ct=[0,94,188,226,97,63,221,131,194,156,126,32,163,253,31,65,157,195,33,127,252,162,64,30,95,1,227,189,62,96,130,220,35,125,159,193,66,28,254,160,225,191,93,3,128,222,60,98,190,224,2,92,223,129,99,61,124,34,192,158,29,67,161,255,70,24,250,164,39,121,155,197,132,218,56,102,229,187,89,7,219,133,103,57,186,228,6,88,25,71,165,251,120,38,196,154,101,59,217,135,4,90,184,230,167,249,27,69,198,152,122,36,248,166,68,26,153,199,37,123,58,100,134,216,91,5,231,185,140,210,48,110,237,179,81,15,78,16,242,172,47,113,147,205,17,79,173,243,112,46,204,146,211,141,111,49,178,236,14,80,175,241,19,77,206,144,114,44,109,51,209,143,12,82,176,238,50,108,142,208,83,13,239,177,240,174,76,18,145,207,45,115,202,148,118,40,171,245,23,73,8,86,180,234,105,55,213,139,87,9,235,181,54,104,138,212,149,203,41,119,244,170,72,22,233,183,85,11,136,214,52,106,43,117,151,201,74,20,246,168,116,42,200,150,21,75,169,247,182,232,10,84,215,137,107,53];"undefined"!=typeof Int32Array&&(Ct=new Int32Array(Ct));Et("dallas-1-wire",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&Ct[255&(r^e[t])];return r});let It=[0,213,127,170,254,43,129,84,41,252,86,131,215,2,168,125,82,135,45,248,172,121,211,6,123,174,4,209,133,80,250,47,164,113,219,14,90,143,37,240,141,88,242,39,115,166,12,217,246,35,137,92,8,221,119,162,223,10,160,117,33,244,94,139,157,72,226,55,99,182,28,201,180,97,203,30,74,159,53,224,207,26,176,101,49,228,78,155,230,51,153,76,24,205,103,178,57,236,70,147,199,18,184,109,16,197,111,186,238,59,145,68,107,190,20,193,149,64,234,63,66,151,61,232,188,105,195,22,239,58,144,69,17,196,110,187,198,19,185,108,56,237,71,146,189,104,194,23,67,150,60,233,148,65,235,62,106,191,21,192,75,158,52,225,181,96,202,31,98,183,29,200,156,73,227,54,25,204,102,179,231,50,152,77,48,229,79,154,206,27,177,100,114,167,13,216,140,89,243,38,91,142,36,241,165,112,218,15,32,245,95,138,222,11,161,116,9,220,118,163,247,34,136,93,214,3,169,124,40,253,87,130,255,42,128,85,1,212,126,171,132,81,251,46,122,175,5,208,173,120,210,7,83,134,44,249];"undefined"!=typeof Int32Array&&(It=new Int32Array(It));Et("crc-8-dvbs2",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&It[255&(r^e[t])];return r});let zt=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];"undefined"!=typeof Int32Array&&(zt=new Int32Array(zt));Et("crc-16",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=65535&(zt[255&(r^e[t])]^r>>8);return r});let Ot=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920];"undefined"!=typeof Int32Array&&(Ot=new Int32Array(Ot));Et("ccitt",(e,t)=>{let r=void 0!==t?~~t:65535;for(let t=0;t<e.length;t++)r=65535&(Ot[255&(r>>8^e[t])]^r<<8);return r});let Tt=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];"undefined"!=typeof Int32Array&&(Tt=new Int32Array(Tt));Et("crc-16-modbus",(e,t)=>{let r=void 0!==t?~~t:65535;for(let t=0;t<e.length;t++)r=65535&(Tt[255&(r^e[t])]^r>>8);return r}),Et("xmodem",(e,t)=>{let r=void 0!==t?~~t:0;for(let t=0;t<e.length;t++){let n=r>>>8&255;n^=255&e[t],n^=n>>>4,r=r<<8&65535,r^=n,n=n<<5&65535,r^=n,n=n<<7&65535,r^=n}return r});let Wt=[0,4489,8978,12955,17956,22445,25910,29887,35912,40385,44890,48851,51820,56293,59774,63735,4225,264,13203,8730,22181,18220,30135,25662,40137,36160,49115,44626,56045,52068,63999,59510,8450,12427,528,5017,26406,30383,17460,21949,44362,48323,36440,40913,60270,64231,51324,55797,12675,8202,4753,792,30631,26158,21685,17724,48587,44098,40665,36688,64495,60006,55549,51572,16900,21389,24854,28831,1056,5545,10034,14011,52812,57285,60766,64727,34920,39393,43898,47859,21125,17164,29079,24606,5281,1320,14259,9786,57037,53060,64991,60502,39145,35168,48123,43634,25350,29327,16404,20893,9506,13483,1584,6073,61262,65223,52316,56789,43370,47331,35448,39921,29575,25102,20629,16668,13731,9258,5809,1848,65487,60998,56541,52564,47595,43106,39673,35696,33800,38273,42778,46739,49708,54181,57662,61623,2112,6601,11090,15067,20068,24557,28022,31999,38025,34048,47003,42514,53933,49956,61887,57398,6337,2376,15315,10842,24293,20332,32247,27774,42250,46211,34328,38801,58158,62119,49212,53685,10562,14539,2640,7129,28518,32495,19572,24061,46475,41986,38553,34576,62383,57894,53437,49460,14787,10314,6865,2904,32743,28270,23797,19836,50700,55173,58654,62615,32808,37281,41786,45747,19012,23501,26966,30943,3168,7657,12146,16123,54925,50948,62879,58390,37033,33056,46011,41522,23237,19276,31191,26718,7393,3432,16371,11898,59150,63111,50204,54677,41258,45219,33336,37809,27462,31439,18516,23005,11618,15595,3696,8185,63375,58886,54429,50452,45483,40994,37561,33584,31687,27214,22741,18780,15843,11370,7921,3960];"undefined"!=typeof Int32Array&&(Wt=new Int32Array(Wt));Et("kermit",(e,t)=>{let r=void 0!==t?~~t:0;for(let t=0;t<e.length;t++)r=65535&(Wt[255&(r^e[t])]^r>>8);return r});let Nt=[0,8801531,9098509,825846,9692897,1419802,1651692,10452759,10584377,2608578,2839604,11344079,3303384,11807523,12104405,4128302,12930697,4391538,5217156,13227903,5679208,13690003,14450021,5910942,6606768,14844747,15604413,6837830,16197969,7431594,8256604,16494759,840169,9084178,8783076,18463,10434312,1670131,1434117,9678590,11358416,2825259,2590173,10602790,4109873,12122826,11821884,3289031,13213536,5231515,4409965,12912278,5929345,14431610,13675660,5693559,6823513,15618722,14863188,6588335,16513208,8238147,7417269,16212302,1680338,10481449,9664223,1391140,9061683,788936,36926,8838341,12067563,4091408,3340262,11844381,2868234,11372785,10555655,2579964,14478683,5939616,5650518,13661357,5180346,13190977,12967607,4428364,8219746,16457881,16234863,7468436,15633027,6866552,6578062,14816117,1405499,9649856,10463030,1698765,8819930,55329,803287,9047340,11858690,3325945,4072975,12086004,2561507,10574104,11387118,2853909,13647026,5664841,5958079,14460228,4446803,12949160,13176670,5194661,7454091,16249200,16476294,8201341,14834538,6559633,6852199,15647388,3360676,11864927,12161705,4185682,10527045,2551230,2782280,11286707,9619101,1346150,1577872,10379115,73852,8875143,9172337,899466,16124205,7357910,8182816,16421083,6680524,14918455,15678145,6911546,5736468,13747439,14507289,5968354,12873461,4334094,5159928,13170435,4167245,12180150,11879232,3346363,11301036,2767959,2532769,10545498,10360692,1596303,1360505,9604738,913813,9157998,8856728,92259,16439492,8164415,7343561,16138546,6897189,15692510,14936872,6662099,5986813,14488838,13733104,5750795,13156124,5174247,4352529,12855018,2810998,11315341,10498427,2522496,12124823,4148844,3397530,11901793,9135439,862644,110658,8912057,1606574,10407765,9590435,1317464,15706879,6940164,6651890,14889737,8145950,16384229,16161043,7394792,5123014,13133629,12910283,4370992,14535975,5997020,5707818,13718737,2504095,10516836,11329682,2796649,11916158,3383173,4130419,12143240,8893606,129117,876971,9121104,1331783,9576124,10389322,1625009,14908182,6633453,6925851,15721184,7380471,16175372,16402682,8127489,4389423,12891860,13119266,5137369,13704398,5722165,6015427,14517560];"undefined"!=typeof Int32Array&&(Nt=new Int32Array(Nt));Et("crc-24",(e,t)=>{let r=void 0!==t?~~t:11994318;for(let t=0;t<e.length;t++)r=16777215&(Nt[255&(r>>16^e[t])]^r<<8);return r});let Lt=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];"undefined"!=typeof Int32Array&&(Lt=new Int32Array(Lt));const jt=Et("crc-32",(e,t)=>{let r=0===t?0:-1^t;for(let t=0;t<e.length;t++)r=Lt[255&(r^e[t])]^r>>>8;return-1^r});let Bt=[0,79764919,159529838,222504665,319059676,398814059,445009330,507990021,638119352,583659535,797628118,726387553,890018660,835552979,1015980042,944750013,1276238704,1221641927,1167319070,1095957929,1595256236,1540665371,1452775106,1381403509,1780037320,1859660671,1671105958,1733955601,2031960084,2111593891,1889500026,1952343757,2552477408,2632100695,2443283854,2506133561,2334638140,2414271883,2191915858,2254759653,3190512472,3135915759,3081330742,3009969537,2905550212,2850959411,2762807018,2691435357,3560074640,3505614887,3719321342,3648080713,3342211916,3287746299,3467911202,3396681109,4063920168,4143685023,4223187782,4286162673,3779000052,3858754371,3904687514,3967668269,881225847,809987520,1023691545,969234094,662832811,591600412,771767749,717299826,311336399,374308984,453813921,533576470,25881363,88864420,134795389,214552010,2023205639,2086057648,1897238633,1976864222,1804852699,1867694188,1645340341,1724971778,1587496639,1516133128,1461550545,1406951526,1302016099,1230646740,1142491917,1087903418,2896545431,2825181984,2770861561,2716262478,3215044683,3143675388,3055782693,3001194130,2326604591,2389456536,2200899649,2280525302,2578013683,2640855108,2418763421,2498394922,3769900519,3832873040,3912640137,3992402750,4088425275,4151408268,4197601365,4277358050,3334271071,3263032808,3476998961,3422541446,3585640067,3514407732,3694837229,3640369242,1762451694,1842216281,1619975040,1682949687,2047383090,2127137669,1938468188,2001449195,1325665622,1271206113,1183200824,1111960463,1543535498,1489069629,1434599652,1363369299,622672798,568075817,748617968,677256519,907627842,853037301,1067152940,995781531,51762726,131386257,177728840,240578815,269590778,349224269,429104020,491947555,4046411278,4126034873,4172115296,4234965207,3794477266,3874110821,3953728444,4016571915,3609705398,3555108353,3735388376,3664026991,3290680682,3236090077,3449943556,3378572211,3174993278,3120533705,3032266256,2961025959,2923101090,2868635157,2813903052,2742672763,2604032198,2683796849,2461293480,2524268063,2284983834,2364738477,2175806836,2238787779,1569362073,1498123566,1409854455,1355396672,1317987909,1246755826,1192025387,1137557660,2072149281,2135122070,1912620623,1992383480,1753615357,1816598090,1627664531,1707420964,295390185,358241886,404320391,483945776,43990325,106832002,186451547,266083308,932423249,861060070,1041341759,986742920,613929101,542559546,756411363,701822548,3316196985,3244833742,3425377559,3370778784,3601682597,3530312978,3744426955,3689838204,3819031489,3881883254,3928223919,4007849240,4037393693,4100235434,4180117107,4259748804,2310601993,2373574846,2151335527,2231098320,2596047829,2659030626,2470359227,2550115596,2947551409,2876312838,2788305887,2733848168,3165939309,3094707162,3040238851,2985771188];"undefined"!=typeof Int32Array&&(Bt=new Int32Array(Bt));Et("crc-32-mpeg",(e,t)=>{let r=void 0!==t?~~t:4294967295;for(let t=0;t<e.length;t++)r=Bt[255&(r>>24^e[t])]^r<<8;return r});let Dt=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];"undefined"!=typeof Int32Array&&(Dt=new Int32Array(Dt));Et("jam",(e,t=-1)=>{let r=0===t?0:~~t;for(let t=0;t<e.length;t++)r=Dt[255&(r^e[t])]^r>>>8;return r});var Mt=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function Ut(e,t){const r=new Uint8Array(e),n=$t()(r).filter(e=>{if("tEXt"!==e.name)return!0;const t=kt.decode(e.data).keyword.toLowerCase();return"chara"!==t&&"ccv3"!==t}),i=JSON.stringify(t),a=btoa(unescape(encodeURIComponent(i))),o=kt.encode("chara",a),s=Object.assign(Object.assign({},t),{spec:"chara_card_v3",spec_version:"3.0"}),c=JSON.stringify(s),l=btoa(unescape(encodeURIComponent(c))),d=kt.encode("ccv3",l);n.splice(-1,0,o,d);const p=function(e){const t=new Uint8Array(4),r=new Int32Array(t.buffer),n=new Uint32Array(t.buffer);let i=8;for(const t of e)i+=t.data.length+12;const a=new Uint8Array(i);let o=8;a[0]=137,a[1]=80,a[2]=78,a[3]=71,a[4]=13,a[5]=10,a[6]=26,a[7]=10;for(const{name:i,data:s}of e){const e=s.length,c=new Uint8Array([i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);n[0]=e,a[o++]=t[3],a[o++]=t[2],a[o++]=t[1],a[o++]=t[0],a[o++]=c[0],a[o++]=c[1],a[o++]=c[2],a[o++]=c[3];for(let t=0;t<e;t++)a[o++]=s[t];const l=jt(s,jt(c));r[0]=l,a[o++]=t[3],a[o++]=t[2],a[o++]=t[1],a[o++]=t[0]}return a}(n);return new Blob([p.slice().buffer],{type:"image/png"})}function Ft(e,t,r){return Mt(this,void 0,void 0,function*(){const n=yield function(e){return Mt(this,void 0,void 0,function*(){try{const t=yield fetch(`/characters/${encodeURIComponent(e)}`);return t.ok?yield t.arrayBuffer():null}catch(e){return null}})}(e);if(!n)return!1;try{const e=Ut(n,t),i=URL.createObjectURL(e),a=document.createElement("a");return a.href=i,a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>URL.revokeObjectURL(i),100),!0}catch(e){return!1}})}var Ht=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function Gt(e){const{rawValue:t,type:r,key:n}=e;if(null==t)return"";if("array"===r&&Array.isArray(t))return t.join("\n---\n");if("object"===r){if("depth_prompt"===n){return t.prompt||""}if("character_book"===n)try{return JSON.stringify(t,null,2)}catch(e){return"[Character Lorebook - edit in ST]"}try{return JSON.stringify(t,null,2)}catch(e){return""}}return String(t)}function qt(e){return"character_book"!==e.key}function Jt(e,t,r,n){return Ht(this,void 0,void 0,function*(){const i=SillyTavern.getContext();try{return(yield fetch("/api/characters/edit-attribute",{method:"POST",headers:i.getRequestHeaders(),body:JSON.stringify({avatar_url:e,ch_name:t,field:r,value:n})})).ok}catch(e){return h.Rm.error(`Failed to edit attribute ${r}:`,e),!1}})}function Yt(e){return Ht(this,void 0,void 0,function*(){const t=SillyTavern.getContext();try{const r=yield fetch("/api/characters/export",{method:"POST",headers:t.getRequestHeaders(),body:JSON.stringify({avatar_url:e,format:"json"})});return r.ok?yield r.json():null}catch(e){return h.Rm.error("Failed to get character JSON:",e),null}})}function Vt(){return Ht(this,void 0,void 0,function*(){const e=B();if(!e.character)return void h.oR.warning("No character selected");if(!e.stageResults.rewrite)return void h.oR.warning("No rewrite results available");const t=e.character,r=e.stageResults.rewrite.output,n=SillyTavern.libs.DOMPurify,i=k(t),a=new Map(i.map(e=>[e.key,e])),o=[],s=a.get("alternate_greetings");s&&Array.isArray(s.rawValue)&&o.push(...s.rawValue);const c=h.IF.filter(qt).map(e=>{var t,r,i,s;const c=a.get(e.key);if("alternate_greetings"===e.key){const t=o.length>0?o.map((e,t)=>{const r=n.sanitize(e);return`\n                        <div class="cr-apply-greetings__item">\n                            <span class="cr-apply-greetings__label">Greeting ${t+1}</span>\n                            <textarea\n                                class="cr-apply-textarea cr-apply-greeting text_pole"\n                                data-field-key="alternate_greetings"\n                                data-greeting-index="${t}"\n                                data-original="${encodeURIComponent(e)}"\n                                rows="4"\n                                placeholder="Greeting ${t+1}..."\n                            >${r}</textarea>\n                        </div>\n                    `}).join(""):'<p class="cr-text-sm cr-text-dim">No alternate greetings defined</p>';return`\n                <details class="cr-apply-field" data-field-key="${e.key}">\n                    <summary class="cr-apply-field__header">\n                        <span class="cr-apply-field__label">${e.label}</span>\n                        <span class="cr-apply-field__badge ${o.length>0?"cr-apply-field__badge--filled":"cr-apply-field__badge--empty"}">\n                            ${o.length>0?`${o.length} greeting${o.length>1?"s":""}`:"empty"}\n                        </span>\n                        <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                    </summary>\n                    <div class="cr-apply-field__content">\n                        <div class="cr-apply-greetings">\n                            ${t}\n                            <button type="button" class="cr-apply-greetings__add" data-action="add-greeting">\n                                <i class="fa-solid fa-plus"></i> Add Greeting\n                            </button>\n                        </div>\n                    </div>\n                </details>\n            `}if("depth_prompt"===e.key&&c){const a=c.rawValue,o=a.prompt||"",l=`Depth: ${null!==(t=a.depth)&&void 0!==t?t:4}, Role: ${null!==(r=a.role)&&void 0!==r?r:"system"}`,d=n.sanitize(o);return`\n                <details class="cr-apply-field" data-field-key="${e.key}">\n                    <summary class="cr-apply-field__header">\n                        <span class="cr-apply-field__label">${e.label}</span>\n                        <span class="cr-apply-field__badge cr-apply-field__badge--filled">\n                            ${l}\n                        </span>\n                        <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                    </summary>\n                    <div class="cr-apply-field__content">\n                        <textarea\n                            class="cr-apply-textarea text_pole"\n                            data-field-key="${e.key}"\n                            data-field-type="depth_prompt"\n                            data-original="${encodeURIComponent(o)}"\n                            data-depth="${null!==(i=a.depth)&&void 0!==i?i:4}"\n                            data-role="${null!==(s=a.role)&&void 0!==s?s:"system"}"\n                            rows="6"\n                            placeholder="Depth prompt content..."\n                        >${d}</textarea>\n                    </div>\n                </details>\n            `}const l=c?Gt(c):"",d=l.length>0,p=n.sanitize(l);return`\n            <details class="cr-apply-field" data-field-key="${e.key}">\n                <summary class="cr-apply-field__header">\n                    <span class="cr-apply-field__label">${e.label}</span>\n                    <span class="cr-apply-field__badge cr-apply-field__tokens ${d?"cr-apply-field__badge--filled":"cr-apply-field__badge--empty"}" data-field="${e.key}">\n                        ${d?"...":"empty"}\n                    </span>\n                    <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                </summary>\n                <div class="cr-apply-field__content">\n                    <textarea\n                        class="cr-apply-textarea text_pole"\n                        data-field-key="${e.key}"\n                        data-original="${encodeURIComponent(l)}"\n                        rows="6"\n                        placeholder="Paste content here..."\n                    >${p}</textarea>\n                </div>\n            </details>\n        `}).join(""),l=`\n        <div class="cr-apply-dialog cr-apply-dialog--split">\n            <div class="cr-apply-split">\n                \x3c!-- Left Panel: Rewrite Output --\x3e\n                <div class="cr-apply-panel cr-apply-panel--source">\n                    <div class="cr-apply-panel__header">\n                        <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        <span>Rewrite Output</span>\n                    </div>\n                    <textarea\n                        class="cr-apply-source text_pole"\n                        readonly\n                        spellcheck="false"\n                    >${n.sanitize(r)}</textarea>\n                </div>\n\n                \x3c!-- Right Panel: Character Fields --\x3e\n                <div class="cr-apply-panel cr-apply-panel--fields">\n                    <div class="cr-apply-panel__header">\n                        <i class="fa-solid fa-user-pen"></i>\n                        <span>Character Fields</span>\n                    </div>\n                    <div class="cr-apply-fields-list">\n                        ${c}\n                    </div>\n                </div>\n            </div>\n\n            <div class="cr-apply-footer">\n                <p class="cr-text-sm cr-text-dim">\n                    Copy from the rewrite output and paste into the fields you want to update.\n                    Modified fields are highlighted. Changes are only saved when you click an action button.\n                </p>\n            </div>\n        </div>\n    `,d=SillyTavern.getContext(),p=new Map,u=[...o];let f=!1;const m=e=>{const t=e.target;if(!t.matches(".cr-apply-textarea"))return;const r=t.dataset.fieldKey,n=t.dataset.greetingIndex,i=t.dataset.original||"",a=decodeURIComponent(i),s=t.value!==a;if("alternate_greetings"===r&&void 0!==n){const e=parseInt(n,10);u[e]=t.value,s&&(f=!0);const r=u.some((e,t)=>e!==(o[t]||""))||u.length!==o.length,i=t.closest(".cr-apply-field"),a=null==i?void 0:i.querySelector(".cr-apply-field__dirty");return i&&i.classList.toggle("cr-apply-field--dirty",r),void(a&&(a.style.display=r?"inline":"none"))}const c=t.closest(".cr-apply-field"),l=null==c?void 0:c.querySelector(".cr-apply-field__dirty");c&&c.classList.toggle("cr-apply-field--dirty",s),l&&(l.style.display=s?"inline":"none"),r&&(s?p.set(r,t.value):p.delete(r))},g=e=>{const t=e.target.closest('[data-action="add-greeting"]');if(!t)return;e.preventDefault();const r=t.closest(".cr-apply-greetings");if(!r)return;const n=u.length;u.push(""),f=!0;const i=document.createElement("div");i.className="cr-apply-greetings__item",i.innerHTML=`\n            <span class="cr-apply-greetings__label">Greeting ${n+1} (new)</span>\n            <textarea\n                class="cr-apply-textarea cr-apply-greeting text_pole"\n                data-field-key="alternate_greetings"\n                data-greeting-index="${n}"\n                data-original=""\n                rows="4"\n                placeholder="New greeting..."\n            ></textarea>\n        `,r.insertBefore(i,t);const a=r.closest(".cr-apply-field"),o=null==a?void 0:a.querySelector(".cr-apply-field__dirty");a&&a.classList.add("cr-apply-field--dirty"),o&&(o.style.display="inline")};document.addEventListener("input",m),document.addEventListener("click",g);const v=setTimeout(()=>function(e){return Ht(this,void 0,void 0,function*(){const t=[];for(const[r,n]of e){if("alternate_greetings"===r)continue;const e=Gt(n);e&&t.push({key:r,text:e})}if(0===t.length)return;const r=yield(0,h.gg)(t);for(const{key:e,tokens:t}of r){const r=document.querySelector(`.cr-apply-field__tokens[data-field="${e}"]`);r&&null!==t&&(r.textContent=`${ve(t)} tokens`)}})}(a),50),y=yield d.callGenericPopup(l,d.POPUP_TYPE.CONFIRM,"",{okButton:"Apply to Card",cancelButton:"Cancel",customButtons:["Download PNG","Download JSON"],wide:!0,large:!0});if(clearTimeout(v),document.removeEventListener("input",m),document.removeEventListener("click",g),!1===y||void 0===y)return;const b=Array.from(p.entries()).map(([e,t])=>({key:e,value:t}));if(f){const e=u.filter(e=>e.trim());(e.length>0||o.length>0)&&b.push({key:"alternate_greetings",value:e.join("\n---\n")})}0!==b.length?!0===y||1===y?yield function(e,t,r){return Ht(this,void 0,void 0,function*(){let n=0;for(const i of r){const r="alternate_greetings"===i.key?i.value.split("\n---\n").filter(e=>e.trim()):i.value;(yield Jt(e,t,i.key,r))?n++:h.oR.error(`Failed to update ${i.key}`)}if(n>0){const e=SillyTavern.getContext();yield e.getCharacters(),h.oR.success(`Applied ${n} field${n>1?"s":""} to character!`)}})}(t.avatar,t.name,b):2===y?yield function(e,t,r){return Ht(this,void 0,void 0,function*(){const n=yield Yt(e);if(!n)return void h.oR.error("Failed to get character data");for(const e of r){const t="alternate_greetings"===e.key?e.value.split("\n---\n").filter(e=>e.trim()):e.value;n[e.key]=t,n.data&&"object"==typeof n.data&&(n.data[e.key]=t)}(yield Ft(e,n,`${t}_refined.png`))?h.oR.success("PNG downloaded! (Original character unchanged)"):h.oR.error("Failed to create PNG")})}(t.avatar,t.name,b):3===y?yield function(e,t){return Ht(this,void 0,void 0,function*(){const r=B();if(!r.character)return;const n=yield Yt(e);if(!n)return void h.oR.error("Failed to get character data");for(const e of t){const t="alternate_greetings"===e.key?e.value.split("\n---\n").filter(e=>e.trim()):e.value;n[e.key]=t,n.data&&"object"==typeof n.data&&(n.data[e.key]=t)}const i=JSON.stringify(n,null,2),a=new Blob([i],{type:"application/json"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=`${r.character.name}_updated.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),h.oR.success("JSON downloaded!")})}(t.avatar,b):h.Rm.warn("Unknown result from apply dialog:",y):h.oR.info("No changes to apply")})}function Qt(e,t){var r;const{DOMPurify:n}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=Xt(i);if(!a||"object"!=typeof a){const e=Kt(i);return n.sanitize(rr(e))}const o=function(e,t){const r=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const r of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===r&&"number"==typeof e[t])return t;return null}(e),n=r?e[r]:null,i=[];if(r&&"number"==typeof n){const e=n>10?100:10;i.push(ir({type:"hero",title:gr(r),score:{value:n,max:e}}))}const a=t.properties||{},o=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of o){if(t===r)continue;const n=e[t];if(void 0===n)continue;const o=a[t]||{type:fr(n)};i.push(cr(t,n,o,0))}return`<div class="cr-formatted">${i.join("")}</div>`}(a,null!==(r=null==t?void 0:t.value)&&void 0!==r?r:sr(a));return n.sanitize(o)}function Xt(e){try{return JSON.parse(e)}catch(t){const r=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(r)try{return JSON.parse(r[1].trim())}catch(e){return null}return null}}function Kt(e){const t=e.split("\n"),r=[];let n=null,i=[],a=!1,o="",s=[];const c=()=>{if(0===i.length)return;const e=i.join("\n").trim();if(!e)return void(i=[]);const t=function(e){const t=e.split("\n"),r=[];let n="",i=!1,a="bullet";for(const e of t){const t=e.match(/^[\s]*[-*]\s+(.+)$/),o=e.match(/^[\s]*\d+[.)]\s+(.+)$/);if(t||o)i||(i=!0,a=o?"numbered":"bullet"),n&&r.push(n.trim()),n=(t||o)[1];else if(i&&n&&e.match(/^\s+\S/))n+=" "+e.trim();else if(""===e.trim())n&&r.push(n.trim()),n="";else if(i&&e.trim()){n&&r.push(n.trim());break}}n&&r.push(n.trim());return 0===r.length?null:{items:r,listType:a}}(e),a=e.split("\n"),o=[];for(let e=0;e<a.length;e++){const t=a[e];if(t.match(/^[\s]*[-*]\s+.+$/)||t.match(/^[\s]*\d+[.)]\s+.+$/))break;t.trim()&&o.push(t)}if(o.length>0&&t){const e=o.join("\n").trim();if(e){const t=e.split(/\n\n+/);for(const e of t){if(!e.trim())continue;const t={type:"paragraph",content:e.trim()};n?(n.children=n.children||[],n.children.push(t)):r.push(t)}}}if(t){const e={type:"list",items:t.items,listType:t.listType};n?(n.children=n.children||[],n.children.push(e)):r.push(e)}else{const t=e.split(/\n\n+/);for(const e of t){if(!e.trim())continue;const t={type:"paragraph",content:e.trim()};n?(n.children=n.children||[],n.children.push(t)):r.push(t)}}i=[]},l=()=>{if(0===s.length)return;const e={type:"code",content:s.join("\n"),language:o};n?(n.children=n.children||[],n.children.push(e)):r.push(e),s=[],o=""};for(const e of t){if(/^[-*_]{3,}\s*$/.test(e.trim()))continue;const t=e.match(/^```(\w*)/);if(t){a?(l(),a=!1):(c(),a=!0,o=t[1]||"");continue}if(a){s.push(e);continue}const d=e.match(/^(#{1,3})\s+(.+)$/);if(d){c(),n&&(n.children&&n.children.length>0||n.score)&&r.push(n);const e=d[1].length,t=d[2].trim(),i=tr(t);if(i&&1===e)r.push({type:"hero",title:i.label,score:{value:i.value,max:i.max}}),n=null;else{n={type:"section",title:t,children:[]};const e=Zt(t);e&&(n.score={value:e.value,max:e.max},n.title=t.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim())}continue}const p=er(e);if(p&&n){n.score={value:p.value,max:p.max};continue}if(e.match(/^\*\*([^*]+):\*\*\s*$/)&&n){c();const t={type:"paragraph",content:e};n.children=n.children||[],n.children.push(t);continue}i.push(e)}if(c(),a&&l(),n&&(n.children&&n.children.length>0||n.score)&&r.push(n),r.length>0&&"section"===r[0].type){const e=r[0];e.score&&function(e){const t=e.toLowerCase().replace(/[_-]/g,"");return["overall","total","final","summary","verdict","rating","soulcheck"].some(e=>t.includes(e))}(e.title||"")&&(r[0]={type:"hero",title:e.title,score:e.score},e.children&&e.children.length>0&&r.splice(1,0,...e.children.map(e=>e)))}return r}function Zt(e){const t=e.match(/(\d+(?:\.\d+)?)\s*\/\s*(\d+)/);if(t){const e=parseFloat(t[1]),r=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(r)&&r>0)return{value:e,max:r}}return null}function er(e){const t=e.trim().match(/^(?:score\s*:?\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)$/i);if(t){const e=parseFloat(t[1]),r=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(r)&&r>0)return{value:e,max:r}}return null}function tr(e){const t=Zt(e);if(t){const r=e.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim();return Object.assign(Object.assign({},t),{label:r})}return null}function rr(e){if(0===e.length)return'<div class="cr-formatted cr-formatted--empty">No content</div>';return`<div class="cr-formatted">${e.map(nr).join("")}</div>`}function nr(e){switch(e.type){case"hero":return ir(e);case"section":return function(e){const t=e.title||"",r=null!=e.score,n=e.children||[];let i="";if(r&&e.score){i=`\n            <span class="cr-section__score" style="--score-color: ${vr(100===e.score.max?e.score.value/10:e.score.value)}">\n                ${Number.isInteger(e.score.value)?e.score.value:e.score.value.toFixed(1)}<span class="cr-section__score-max">/${e.score.max}</span>\n            </span>\n        `}const a=n.map(nr).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${ur(t)}</h3>\n                ${i}\n            </div>\n            <div class="cr-section__body">\n                ${a}\n            </div>\n        </div>\n    `}(e);case"paragraph":return function(e){const t=e.content||"";return`<p class="cr-para">${ar(t)}</p>`}(e);case"list":return function(e){const t=e.items||[];if(0===t.length)return"";const r=t.map(e=>`<li>${ar(e)}</li>`).join(""),n="numbered"===e.listType?"ol":"ul";return`<${n} class="cr-list">${r}</${n}>`}(e);case"code":return function(e){const{hljs:t}=SillyTavern.libs,r=e.content||"",n=e.language||"";let i;try{i=t?n&&t.getLanguage(n)?t.highlight(r,{language:n}).value:t.highlightAuto(r).value:ur(r)}catch(e){i=ur(r)}return`\n        <div class="cr-code">\n            ${n?`<div class="cr-code__lang">${ur(n)}</div>`:""}\n            <pre class="cr-code__pre"><code class="hljs">${i}</code></pre>\n        </div>\n    `}(e);default:return""}}function ir(e){const t=e.score;if(!t)return"";const r=vr(100===t.max?t.value/10:t.value),n=Number.isInteger(t.value)?t.value:t.value.toFixed(1);return`\n        <div class="cr-hero">\n            <div class="cr-hero__label">${ur(e.title||"Score")}</div>\n            <div class="cr-hero__score">\n                <span class="cr-hero__value" style="--score-color: ${r}">${n}</span>\n                <span class="cr-hero__max">/${t.max}</span>\n            </div>\n            <div class="cr-hero__bar">\n                <div class="cr-hero__fill" style="width: ${t.value/t.max*100}%; --score-color: ${r}"></div>\n            </div>\n        </div>\n    `}function ar(e){let t=ur(e);return t=t.replace(/(?:(\w+)\s*:\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)/gi,(e,t,r,n)=>{const i=parseFloat(r),a=parseInt(n,10);return`${t?`<span class="cr-inline-score__label">${t}:</span> `:""}<span class="cr-inline-score" style="--score-color: ${vr(100===a?i/10:i)}">${Number.isInteger(i)?i:i.toFixed(1)}<span class="cr-inline-score__max">/${a}</span></span>`}),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?![*\s])(.+?)(?<![*\s])\*(?![*_])/g,"<em>$1</em>"),t=t.replace(/(?<![*_])_(?![_\s])(.+?)(?<![_\s])_(?![*_])/g,"<em>$1</em>"),t=t.replace(/`([^`]+)`/g,'<code class="cr-inline-code">$1</code>'),t}const or=8;function sr(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?sr(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[r,n]of Object.entries(e))t[r]=sr(n);return{type:"object",properties:t}}return{type:typeof e}}function cr(e,t,r,n){if(n>or)return function(e){const{hljs:t}=SillyTavern.libs,r=JSON.stringify(e,null,2);return`<pre class="cr-code__pre"><code class="hljs">${t?t.highlight(r,{language:"json"}).value:ur(r)}</code></pre>`}(t);const i=gr(e),a=r.type||fr(t);if("array"===a&&Array.isArray(t))return function(e,t,r,n){if(0===t.length)return`\n            <div class="cr-field">\n                <div class="cr-field__label">${ur(e)}</div>\n                <div class="cr-field__value cr-field--empty">(none)</div>\n            </div>\n        `;const i=r.items||{type:fr(t[0])};if(t.every(mr)){const r=t.map(e=>`<li>${function(e){if("boolean"==typeof e)return pr(e);if("number"==typeof e)return`<span class="cr-num">${e.toLocaleString()}</span>`;return ar(String(e))}(e)}</li>`).join("");return`\n            <div class="cr-field">\n                <div class="cr-field__label">${ur(e)}</div>\n                <ul class="cr-list">${r}</ul>\n            </div>\n        `}const a=t.map((e,t)=>"object"==typeof e&&null!==e?function(e,t,r){const n=t.properties||{},i=Object.keys(n).length>0?Object.keys(n):Object.keys(e),a=i.find(t=>"string"==typeof e[t]&&e[t].length<100),o=i.find(t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100),s=i.find(t=>"string"==typeof e[t]&&e[t].length>=50&&t!==a);let c="";if(a||o){c=`<div class="cr-card__header">${a?`<span class="cr-card__title">${ur(String(e[a]))}</span>`:""}${o?dr(e[o]):""}</div>`}let l="";s&&(l=`<div class="cr-card__body">${ar(String(e[s]))}</div>`);const d=i.filter(e=>e!==a&&e!==o&&e!==s).map(t=>{const i=e[t];if(void 0===i)return"";return cr(t,i,n[t]||{type:fr(i)},r+1)}).filter(Boolean).join("");return`<div class="cr-card">${c}${l}${d?`<div class="cr-card__extra">${d}</div>`:""}</div>`}(e,i,n+1):`<div class="cr-card">${lr(e,i)}</div>`).join("");return`\n        <div class="cr-field">\n            <div class="cr-field__label">${ur(e)}</div>\n            <div class="cr-cards">${a}</div>\n        </div>\n    `}(i,t,r,n);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,r,n){const i=r.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map(e=>{const r=t[e];if(void 0===r)return"";return cr(e,r,i[e]||{type:fr(r)},n+1)}).filter(Boolean).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${ur(e)}</h3>\n            </div>\n            <div class="cr-section__body cr-section__body--nested">\n                ${a}\n            </div>\n        </div>\n    `}(i,t,r,n);const o=lr(t,r,e);return`\n        <div class="cr-field">\n            <div class="cr-field__label">${ur(i)}</div>\n            <div class="cr-field__value">${o}</div>\n        </div>\n    `}function lr(e,t,r){if(null==e)return'<span class="cr-null"></span>';switch(t.type||fr(e)){case"string":return function(e,t){if(!e.trim())return'<span class="cr-empty">(empty)</span>';const r=t.format;if("uri"===r||"url"===r||(n=e,/^https?:\/\//i.test(n))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${ur(e)}" target="_blank" rel="noopener" class="cr-link">${ur(t)}</a>`}var n;if("email"===r||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${ur(e)}" class="cr-link">${ur(e)}</a>`;if(e.length>100||e.includes("\n"))return`<div class="cr-text">${ar(e)}</div>`;return`<span>${ar(e)}</span>`}(e,t);case"number":case"integer":return function(e,t,r){const n=String(t.title||t.description||r||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some(t=>e.includes(t))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(n,e))return dr(e);return`<span class="cr-num">${e.toLocaleString(void 0,{maximumFractionDigits:2})}</span>`}(e,t,r);case"boolean":return pr(e);default:return`<span>${ur(String(e))}</span>`}}function dr(e){const t=e>10?100:10;return`<span class="cr-score" style="--score-color: ${vr(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="cr-score__max">/${t}</span></span>`}function pr(e){return`<span class="${e?"cr-bool--yes":"cr-bool--no"}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function ur(e){const{DOMPurify:t}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(r,{ALLOWED_TAGS:[]})}function fr(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function mr(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function gr(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function vr(e){return e>=8?"var(--cr-score-high, #10b981)":e>=6?"var(--cr-score-good, #22c55e)":e>=4?"var(--cr-score-mid, #eab308)":e>=2?"var(--cr-score-low, #f97316)":"var(--cr-score-bad, #ef4444)"}var hr=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let yr="result";const br={score:"smart",rewrite:"smart",analyze:"smart"},_r={score:"formatted",rewrite:"formatted",analyze:"formatted"};let xr=null;function wr(e,t){var r;const n=SillyTavern.libs.DOMPurify,i=SillyTavern.libs.hljs;if(!e)return`\n            <div class="cr-empty">\n                <i class="fa-solid ${h.iu[t]} cr-empty__icon"></i>\n                <div class="cr-empty__title">No results yet</div>\n                <div class="cr-empty__text">Run ${h.BA[t]} to see results</div>\n            </div>\n        `;if(e.error)return`\n            <div class="cr-alert cr-alert--danger">\n                <i class="fa-solid fa-exclamation-triangle cr-alert__icon"></i>\n                <div class="cr-alert__content">\n                    <div class="cr-alert__title">Error</div>\n                    <div class="cr-alert__message">${n.sanitize(e.error)}</div>\n                </div>\n            </div>\n        `;const a=Xt(e.output);if(null!==a&&"object"==typeof a){const o=JSON.stringify(a,null,2),s=B().stageConfigs[t];let c=null;if(null==s?void 0:s.schemaPresetId){const e=(0,E.Bx)(s.schemaPresetId);c=null!==(r=null==e?void 0:e.schema)&&void 0!==r?r:null}const l=br[t];let d;if("smart"===l)d=Qt(e.output,c);else{let e;try{e=i.highlight(o,{language:"json"}).value}catch(t){e=n.sanitize(o)}d=`<pre class="cr-result__code hljs"><code>${e}</code></pre>`}return`\n            <div class="cr-result" data-stage="${t}">\n                <div class="cr-result__header">\n                    <span class="cr-result__type">\n                        <i class="fa-solid fa-brackets-curly"></i>\n                        Structured Output\n                    </span>\n                    <div class="cr-result__actions">\n                        <div class="cr-json-toggle" data-stage="${t}">\n                            <button class="cr-json-toggle__btn ${"smart"===l?"cr-json-toggle__btn--active":""}"\n                                    data-mode="smart"\n                                    type="button"\n                                    title="Smart formatted view">\n                                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            </button>\n                            <button class="cr-json-toggle__btn ${"raw"===l?"cr-json-toggle__btn--active":""}"\n                                    data-mode="raw"\n                                    type="button"\n                                    title="Raw JSON view">\n                                <i class="fa-solid fa-code"></i>\n                            </button>\n                        </div>\n                        <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                data-type="json"\n                                data-stage="${t}"\n                                data-raw="${encodeURIComponent(e.output)}"\n                                data-formatted="${encodeURIComponent(o)}"\n                                type="button"\n                                title="Copy to clipboard">\n                            <i class="fa-solid fa-copy"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="cr-result__content">\n                    ${d}\n                </div>\n            </div>\n        `}const o=_r[t];let s;return s="formatted"===o?function(e){const{DOMPurify:t}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:""),n=Xt(r);if(n&&"object"==typeof n)return Qt(r,null);const i=rr(Kt(r));return t.sanitize(i)}(e.output):`<pre class="cr-result__raw">${n.sanitize(e.output)}</pre>`,`\n        <div class="cr-result" data-stage="${t}">\n            <div class="cr-result__header">\n                <span class="cr-result__type">\n                    <i class="fa-solid ${h.iu[t]}"></i>\n                    ${h.BA[t]}\n                </span>\n                <div class="cr-result__actions">\n                    <div class="cr-text-toggle" data-stage="${t}">\n                        <button class="cr-text-toggle__btn ${"formatted"===o?"cr-text-toggle__btn--active":""}"\n                                data-mode="formatted"\n                                type="button"\n                                title="Formatted view">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        </button>\n                        <button class="cr-text-toggle__btn ${"raw"===o?"cr-text-toggle__btn--active":""}"\n                                data-mode="raw"\n                                type="button"\n                                title="Raw text (easy to copy)">\n                            <i class="fa-solid fa-code"></i>\n                        </button>\n                    </div>\n                    <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            data-type="text"\n                            data-stage="${t}"\n                            data-raw="${encodeURIComponent(e.output)}"\n                            type="button"\n                            title="Copy to clipboard">\n                        <i class="fa-solid fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="cr-result__content">\n                ${s}\n            </div>\n        </div>\n    `}function $r(e,t){var r;const n=SillyTavern.libs.DOMPurify,i=SillyTavern.libs.moment,a=B(),o=i(e.timestamp),s=o.fromNow(),c=o.format("MMM D, h:mm A"),l=he(e.output||e.error||"",100),d=a.viewingHistoryIndex===t,p=(null===(r=a.stageResults[e.stage])||void 0===r?void 0:r.timestamp)===e.timestamp;return`\n        <div class="cr-list-item ${ye(e.error&&"cr-list-item--error",d&&"cr-list-item--viewing",p&&"cr-list-item--current")}"\n             data-index="${t}">\n            <div class="cr-list-item__content">\n                <div class="cr-row cr-row--between">\n                    <span class="cr-list-item__title">\n                        <i class="fa-solid ${h.iu[e.stage]} cr-text-accent"></i>\n                        ${h.BA[e.stage]}\n                        ${p?'<span class="cr-badge cr-badge--sm">current</span>':""}\n                    </span>\n                    <span class="cr-text-xs cr-text-dim" title="${c}">${s}</span>\n                </div>\n                <div class="cr-list-item__subtitle cr-truncate">${n.sanitize(l)}</div>\n            </div>\n            <div class="cr-list-item__actions">\n                <button class="cr-history-restore menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        data-index="${t}"\n                        type="button"\n                        title="Restore this result as current">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n        </div>\n    `}function kr(){var e,t;const r=B(),n=ie(),i=null!==n,a=!!r.stageResults.rewrite,o=r.iterationHistory.length>0,s=a&&!i&&"rewrite"===r.activeStage,c=!i&&a&&"rewrite"===r.activeStage,l=fe(".cr-results-wrapper");if(!l)return;let d=l.querySelector(".cr-history-nav");if(i){const t=`\n            <div class="cr-history-nav__info">\n                <i class="fa-solid fa-clock-rotate-left"></i>\n                <span>Viewing history ${(null!==(e=r.viewingHistoryIndex)&&void 0!==e?e:0)+1} of ${r.iterationHistory.length}</span>\n            </div>\n            <div class="cr-history-nav__controls">\n                <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                        id="${h.pW}_history_prev"\n                        type="button"\n                        title="Previous"\n                        ${0===r.viewingHistoryIndex?"disabled":""}>\n                    <i class="fa-solid fa-chevron-left"></i>\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                        id="${h.pW}_history_next"\n                        type="button"\n                        title="Next"\n                        ${r.viewingHistoryIndex===r.iterationHistory.length-1?"disabled":""}>\n                    <i class="fa-solid fa-chevron-right"></i>\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                        id="${h.pW}_history_restore"\n                        type="button"\n                        title="Restore this as current result">\n                    <i class="fa-solid fa-rotate-left"></i> Restore\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--sm"\n                        id="${h.pW}_history_back"\n                        type="button"\n                        title="Back to current results">\n                    <i class="fa-solid fa-xmark"></i> Back\n                </button>\n            </div>\n        `;d||(d=document.createElement("div"),d.className="cr-history-nav",l.insertBefore(d,l.firstChild)),d.innerHTML=t}else d&&d.remove();let p=l.querySelector(".cr-results-toolbar");if(s){const e=`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===yr?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===yr?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${c?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply or export rewritten content">\n                    <i class="fa-solid fa-file-export"></i> Apply / Export\n                </button>\n            ':""}\n        `;if(!p){p=document.createElement("div"),p.className="cr-results-toolbar";const e=fe(`#${h.pW}_results_content`);e&&l.insertBefore(p,e)}p.innerHTML=e}else p&&p.remove();const u=fe(`#${h.pW}_results_content`);if(!u)return;if(i)u.innerHTML=wr(n,null!==(t=null==n?void 0:n.stage)&&void 0!==t?t:r.activeStage);else if("compare"===yr&&s)u.innerHTML=`<div id="${h.pW}_compare_content">${xt()}</div>`;else{const e=r.stageResults[r.activeStage];u.innerHTML=wr(e,r.activeStage)}let f=l.querySelector(".cr-history");if(o){f||(f=document.createElement("div"),f.className="cr-history "+(r.historyExpanded?"":"cr-history--collapsed"),f.innerHTML=`\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${r.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${r.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="cr-history__list cr-list">\n                </div>\n            `,l.appendChild(f));const e=fe(`#${h.pW}_history_list`);if(e){!function(e,t,r){const n=SillyTavern.libs.morphdom,i=SillyTavern.libs.DOMPurify;if(!n)return void(e.innerHTML=i.sanitize(t));const a=document.createElement("div");a.innerHTML=i.sanitize(t),n(e,a,{childrenOnly:!0,onBeforeElUpdated:(e,t)=>{var n,i;if(document.activeElement===e&&"INPUT"===e.tagName){const r=e,n=t;n.value=r.value,n.selectionStart=r.selectionStart,n.selectionEnd=r.selectionEnd}if(document.activeElement===e&&"TEXTAREA"===e.tagName){const r=e,n=t;n.value=r.value,n.selectionStart=r.selectionStart,n.selectionEnd=r.selectionEnd}return null===(i=null===(n=null==r?void 0:r.onBeforeElUpdated)||void 0===n?void 0:n.call(r,e,t))||void 0===i||i},onBeforeNodeDiscarded:null==r?void 0:r.onBeforeNodeDiscarded,onNodeAdded:null==r?void 0:r.onNodeAdded})}(e,r.iterationHistory.map((e,t)=>$r(e,t)).join(""))}const t=f.querySelector(".cr-history__toggle span");t&&(t.textContent=`Run History (${r.iterationHistory.length})`)}else f&&f.remove()}function Sr(e){const t=[];t.push(ge(e,"click",e=>{const t=e.target.closest(".cr-view-toggle__btn");if(!t)return;const r=t.dataset.view;if(r&&r!==yr&&(xr&&(xr(),xr=null),yr=r,kr(),"compare"===r)){const e=fe(`#${h.pW}_compare_content`);e&&(xr=()=>{})}})),t.push(ge(e,"click",e=>{const t=e.target.closest(".cr-json-toggle__btn");if(!t)return;const r=t.closest(".cr-json-toggle"),n=null==r?void 0:r.dataset.stage;if(!n)return;const i=t.dataset.mode;i&&i!==br[n]&&(br[n]=i,kr())})),t.push(ge(e,"click",e=>{const t=e.target.closest(".cr-text-toggle__btn");if(!t)return;const r=t.closest(".cr-text-toggle"),n=null==r?void 0:r.dataset.stage;if(!n)return;const i=t.dataset.mode;i&&i!==_r[n]&&(_r[n]=i,kr())})),t.push(ge(e,"click",e=>{e.target.closest(".cr-apply-btn")&&Vt()}));const r=fe(`#${h.pW}_results_content`,e);return r&&t.push(ge(r,"click",e=>hr(this,void 0,void 0,function*(){const t=e.target.closest(".cr-result-copy");if(!t)return;const r=t,n=r.dataset.type,i=r.dataset.stage;let a;a="json"===n&&i&&"smart"===br[i]?decodeURIComponent(r.dataset.formatted||""):decodeURIComponent(r.dataset.raw||"");const o=yield function(e){return hr(this,void 0,void 0,function*(){if(navigator.clipboard&&window.isSecureContext)try{return yield navigator.clipboard.writeText(e),!0}catch(e){}try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",t.setAttribute("readonly",""),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const r=document.execCommand("copy");return document.body.removeChild(t),r}catch(e){return!1}})}(a),s=t.querySelector("i");o?s&&(s.className="fa-solid fa-check",setTimeout(()=>{s.className="fa-solid fa-copy"},1500)):(s&&(s.className="fa-solid fa-xmark",setTimeout(()=>{s.className="fa-solid fa-copy"},1500)),h.Rm.error("Failed to copy to clipboard"))}))),t.push(ge(e,"click",e=>{const t=e.target.closest(".cr-history__toggle");if(!t)return;const r=t.closest(".cr-history");r&&(!function(){const e=B();e.historyExpanded=!e.historyExpanded}(),r.classList.toggle("cr-history--collapsed"),t.setAttribute("aria-expanded",String(B().historyExpanded)))})),t.push(ge(e,"click",e=>{const t=e.target;return t.closest(`#${h.pW}_history_prev`)?(function(){const e=B();0!==e.iterationHistory.length&&(null===e.viewingHistoryIndex?e.viewingHistoryIndex=e.iterationHistory.length-1:e.viewingHistoryIndex>0&&e.viewingHistoryIndex--)}(),void kr()):t.closest(`#${h.pW}_history_next`)?(function(){const e=B();null!==e.viewingHistoryIndex&&(e.viewingHistoryIndex<e.iterationHistory.length-1?e.viewingHistoryIndex++:e.viewingHistoryIndex=null)}(),void kr()):t.closest(`#${h.pW}_history_restore`)?(ne(),h.oR.success("Result restored"),void kr()):t.closest(`#${h.pW}_history_back`)?(re(null),void kr()):void 0})),t.push(ge(e,"click",e=>{const t=e.target;if(!t.closest(`#${h.pW}_history_list`))return;const r=t.closest(".cr-history-restore");if(r){e.stopPropagation();return ne(parseInt(r.dataset.index||"0",10)),h.oR.success("Result restored"),void kr()}const n=t.closest(".cr-list-item");if(!n)return;re(parseInt(n.dataset.index||"0",10)),kr()})),()=>{xr&&(xr(),xr=null),t.forEach(e=>e())}}var Pr=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const Rr={pending:"",running:"fa-spinner fa-spin",complete:"fa-check",error:"fa-exclamation"},Er={pending:"",running:"cr-stage-tab--running",complete:"cr-stage-tab--complete",error:"cr-stage-tab--error"};function Ar(e){const t=B(),r=t.activeStage===e,n=t.stageStatus[e],i=Rr[n],a=i?`<span class="cr-stage-tab__status"><i class="fa-solid ${i}"></i></span>`:"";return`\n        <button class="cr-stage-tab ${ye(r&&"cr-stage-tab--active")} ${Er[n]}"\n                data-stage="${e}"\n                role="tab"\n                aria-selected="${r}"\n                type="button">\n            <i class="fa-solid ${h.iu[e]} cr-stage-tab__icon"></i>\n            <span class="cr-stage-tab__label">${h.BA[e]}</span>\n            ${a}\n        </button>\n    `}function Cr(){const e=SillyTavern.libs.DOMPurify,t=B(),r=t.character&&!t.isGenerating,n=!!t.stageResults[t.activeStage],i=!(!t.stageResults.score||t.stageResults.score.error||!t.stageResults.rewrite||t.stageResults.rewrite.error||!t.stageResults.analyze||t.stageResults.analyze.error),a=r&&t.stageResults.analyze&&!t.stageResults.analyze.error;if(t.isGenerating)return`\n            <div class="cr-pipeline-controls cr-pipeline-controls--generating">\n                <div class="cr-pipeline-status">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Generating...</span>\n                </div>\n                <button id="${h.pW}_abort"\n                        class="menu_button menu_button--danger menu_button--sm"\n                        type="button">\n                    <i class="fa-solid fa-stop"></i>\n                    Stop\n                </button>\n            </div>\n        `;return`\n        <div class="cr-pipeline-controls">\n            ${n?`\n            <button id="${h.pW}_run_stage"\n                    class="menu_button menu_button--icon"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Regenerate ${h.BA[t.activeStage]}">\n                <i class="fa-solid fa-rotate"></i>\n            </button>`:`\n            <button id="${h.pW}_run_stage"\n                    class="menu_button ${i?"":"menu_button--primary"}"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Run ${h.BA[t.activeStage]}">\n                <i class="fa-solid fa-play"></i>\n                Run\n            </button>`}\n            ${i?"":`\n            <button id="${h.pW}_run_all"\n                    class="menu_button"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Run all stages: Score  Rewrite  Analyze">\n                <i class="fa-solid fa-forward"></i>\n                All\n            </button>`}\n            ${`\n        <button id="${h.pW}_reset"\n                class="menu_button menu_button--icon menu_button--ghost"\n                type="button"\n                title="Clear all results and start fresh">\n            <i class="fa-solid fa-eraser"></i>\n        </button>`}\n            ${a?`\n            <div class="cr-iteration-controls">\n                <input type="text"\n                       id="${h.pW}_guidance_input"\n                       class="cr-iteration-controls__input"\n                       placeholder="Guidance..."\n                       value="${e.sanitize(B().userGuidance)}"\n                       title="Optional: Focus areas or constraints for the next iteration"/>\n                <button id="${h.pW}_iterate"\n                        class="menu_button menu_button--primary"\n                        type="button"\n                        title="Refine with feedback, then re-analyze (Iteration ${t.iterationCount+1})">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    Iterate\n                </button>\n            </div>`:""}\n        </div>\n    `}function Ir(){const e=fe(".cr-stage-tabs");e&&(e.innerHTML=h.an.map(Ar).join(""))}function zr(){const e=fe(`#${h.pW}_pipeline_controls`);e&&(e.innerHTML=Cr(),Nr(e))}function Or(){return Pr(this,void 0,void 0,function*(){const e=B();Ir(),zr(),yield function(e){return ae(this,arguments,void 0,function*(e,t={}){var r,n,i,a,o;const{stages:s=[...h.an],callbacks:c}=t;if(!e.character)return h.Rm.warn("Cannot execute pipeline: no character selected"),{score:null,rewrite:null,analyze:null};if(e.isGenerating)return h.Rm.warn("Cannot execute pipeline: generation already in progress"),{score:null,rewrite:null,analyze:null};const l=new AbortController;ce(e,!0,l);for(const t of h.an)se(e,t,"pending");const d={score:e.stageResults.score,rewrite:e.stageResults.rewrite,analyze:e.stageResults.analyze};try{for(const t of s){if(l.signal.aborted){h.Rm.debug("Pipeline aborted");break}const o=pe(e,t);if(!o)break;o.previousResults=d,se(e,t,"running"),null===(r=null==c?void 0:c.onStageStart)||void 0===r||r.call(c,t),null===(n=null==c?void 0:c.onProgress)||void 0===n||n.call(c,`Running ${t}...`);const s=yield C(o,oe,{signal:l.signal,onProgress:e=>{var t;h.Rm.debug(`[Pipeline] ${e}`),null===(t=null==c?void 0:c.onProgress)||void 0===t||t.call(c,e)}});if(d[t]=s,de(e,s),null===(i=null==c?void 0:c.onStageComplete)||void 0===i||i.call(c,t,s),s.error){null===(a=null==c?void 0:c.onError)||void 0===a||a.call(c,t,s.error);break}}}catch(t){const r=t instanceof Error?t.message:"Unknown error";h.Rm.error("Pipeline execution failed:",t),null===(o=null==c?void 0:c.onError)||void 0===o||o.call(c,e.activeStage,r)}finally{le(e,l)}return d})}(e,{callbacks:{onStageStart:()=>{Ir()},onStageComplete:()=>{kr(),Ir()},onProgress:()=>{zr()},onError:()=>{Ir(),zr()}}}),Ir(),zr()})}function Tr(){return Pr(this,void 0,void 0,function*(){const e=B();Ir(),zr(),yield function(e){return ae(this,arguments,void 0,function*(e,t={}){var r,n,i,a,o,s,c,l,d,p;const{callbacks:u}=t;if(!e.character)return h.Rm.warn("Cannot execute quick iterate: no character selected"),{rewrite:null,analyze:null};if(e.isGenerating)return h.Rm.warn("Cannot execute quick iterate: generation already in progress"),{rewrite:null,analyze:null};if(!e.stageResults.analyze)return h.Rm.warn("Cannot execute quick iterate: no analyze result available"),{rewrite:null,analyze:null};const f=new AbortController;ce(e,!0,f),e.iterationCount++;const m={rewrite:null,analyze:null};try{const t=pe(e,"rewrite");if(!t)return m;t.isRefinement=!0,se(e,"rewrite","running"),null===(r=null==u?void 0:u.onStageStart)||void 0===r||r.call(u,"rewrite"),null===(n=null==u?void 0:u.onProgress)||void 0===n||n.call(u,"Refining rewrite with feedback...");const p=yield C(t,oe,{signal:f.signal,onProgress:e=>{var t;h.Rm.debug(`[Pipeline] ${e}`),null===(t=null==u?void 0:u.onProgress)||void 0===t||t.call(u,e)}});if(m.rewrite=p,de(e,p),null===(i=null==u?void 0:u.onStageComplete)||void 0===i||i.call(u,"rewrite",p),p.error)return null===(a=null==u?void 0:u.onError)||void 0===a||a.call(u,"rewrite",p.error),m;if(f.signal.aborted)return h.Rm.debug("Quick iterate aborted"),m;const g=pe(e,"analyze");if(!g)return m;g.previousResults=Object.assign(Object.assign({},e.stageResults),{rewrite:p}),se(e,"analyze","running"),null===(o=null==u?void 0:u.onStageStart)||void 0===o||o.call(u,"analyze"),null===(s=null==u?void 0:u.onProgress)||void 0===s||s.call(u,"Analyzing refined version...");const v=yield C(g,oe,{signal:f.signal,onProgress:e=>{var t;h.Rm.debug(`[Pipeline] ${e}`),null===(t=null==u?void 0:u.onProgress)||void 0===t||t.call(u,e)}});return m.analyze=v,de(e,v),null===(c=null==u?void 0:u.onStageComplete)||void 0===c||c.call(u,"analyze",v),v.error&&(null===(l=null==u?void 0:u.onError)||void 0===l||l.call(u,"analyze",v.error)),null===(d=null==u?void 0:u.onIterateComplete)||void 0===d||d.call(u),m}catch(t){const r=t instanceof Error?t.message:"Unknown error";return h.Rm.error("Quick iterate failed:",t),null===(p=null==u?void 0:u.onError)||void 0===p||p.call(u,e.activeStage,r),m}finally{le(e,f)}})}(e,{callbacks:{onStageStart:e=>{Ir(),zr()},onStageComplete:()=>{kr(),Ir(),zr()},onError:()=>{Ir(),zr()},onIterateComplete:()=>{ee("analyze"),Ir(),gt(),kr()}}}),zr()})}let Wr=[];function Nr(e){Wr.forEach(e=>e()),Wr=[];const t=fe(`#${h.pW}_guidance_input`,e);if(t){const e=()=>{var e;e=t.value,B().userGuidance=e,U()};Wr.push(ge(t,"change",e)),Wr.push(ge(t,"blur",e))}const r=fe(`#${h.pW}_run_stage`,e);r&&Wr.push(ge(r,"click",()=>{(function(e){return Pr(this,void 0,void 0,function*(){const t=B();Ir(),zr(),yield ue(t,{stage:e,callbacks:{onStageStart:()=>{Ir(),zr()},onStageComplete:()=>{kr(),Ir(),zr()},onError:()=>{Ir(),zr()}}}),"rewrite"===e&&t.stageResults.rewrite&&!t.stageResults.rewrite.error&&(yield ue(t,{stage:"analyze",callbacks:{onStageStart:()=>{Ir(),zr()},onStageComplete:()=>{kr(),Ir(),zr()},onError:()=>{Ir(),zr()}}})),zr()})})(B().activeStage).catch(e=>{h.Rm.error("Stage execution failed",e)})}));const n=fe(`#${h.pW}_run_all`,e);n&&Wr.push(ge(n,"click",()=>{Or().catch(e=>{h.Rm.error("All stages execution failed",e)})}));const i=fe(`#${h.pW}_iterate`,e);i&&Wr.push(ge(i,"click",()=>{Tr().catch(e=>{h.Rm.error("Quick iterate failed",e)})}));const a=fe(`#${h.pW}_reset`,e);a&&Wr.push(ge(a,"click",()=>{!function(e){e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.stageResults={score:null,rewrite:null,analyze:null},e.iterationCount=0,e.hasUnsavedChanges=!0}(B()),Ir(),kr(),zr()}));const o=fe(`#${h.pW}_abort`,e);o&&Wr.push(ge(o,"click",()=>{!function(e){e.abortController&&(e.abortController.abort(),e.abortController=null,e.isGenerating=!1,h.Rm.debug("Pipeline aborted by user"))}(B()),Ir(),zr()}))}var Lr=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let jr=!1,Br=null;function Dr(e){jr=e;const t=fe(`#${h.pW}_session_dropdown`);t&&t.classList.toggle("cr-dropdown--open",e);const r=fe(`#${h.pW}_session_trigger`);r&&r.setAttribute("aria-expanded",String(e)),e||(Br=null)}function Mr(e){return e.name?e.name:(t=e.updatedAt,(0,SillyTavern.libs.moment)(t).calendar(null,{sameDay:"[Today] h:mm A",lastDay:"[Yesterday] h:mm A",lastWeek:"ddd, h:mm A",sameElse:"MMM D, h:mm A"}));var t}function Ur(){const e=B(),t=e.sessions;return e.character?0===t.length?'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-folder-open"></i>\n                No sessions yet\n            </div>\n        ':t.map(t=>function(e,t){var r,n;const i=SillyTavern.libs.DOMPurify,a=Mr(e),o=Br===e.id,s=Object.keys(null!==(n=null===(r=e.stageFields)||void 0===r?void 0:r.base)&&void 0!==n?n:{}).length,c=e.history.length;return`\n        <div class="cr-session-option ${ye(t&&"cr-session-option--active")}"\n             data-session-id="${e.id}"\n             role="option"\n             aria-selected="${t}">\n            <div class="cr-session-option__content">\n                ${o?`\n                    <input type="text"\n                           class="cr-session-option__name-input"\n                           value="${i.sanitize(e.name||"")}"\n                           placeholder="Session name..."\n                           autocomplete="off"\n                           data-session-id="${e.id}" />\n                `:`\n                    <div class="cr-session-option__name">\n                        ${t?'<i class="fa-solid fa-circle cr-session-option__indicator"></i>':""}\n                        <span>${i.sanitize(a)}</span>\n                    </div>\n                `}\n                <div class="cr-session-option__meta">\n                    <span>${s} fields</span>\n                    <span>${c} runs</span>\n                </div>\n            </div>\n            <div class="cr-session-option__actions ${ye(o&&"cr-session-option__actions--editing")}">\n                ${o?`\n                    <button class="cr-session-save menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Save name"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-check"></i>\n                    </button>\n                    <button class="cr-session-cancel menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Cancel">\n                        <i class="fa-solid fa-times"></i>\n                    </button>\n                `:`\n                    <button class="cr-session-edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Rename session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-pencil"></i>\n                    </button>\n                    <button class="cr-session-delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Delete session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                `}\n            </div>\n        </div>\n    `}(t,t.id===e.activeSessionId)).join(""):'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-user-slash"></i>\n                Select a character first\n            </div>\n        '}function Fr(){const e=fe(`#${h.pW}_session_dropdown`);if(!e)return;const t=B(),r=t.sessions.find(e=>e.id===t.activeSessionId),n=!!t.character;e.classList.toggle("cr-dropdown--disabled",!n);const i=fe(`#${h.pW}_session_trigger`);if(i){i.disabled=!n;let e="New Session";n?r&&(e=Mr(r)):e="Select character...";const a=t.sessions.length;i.innerHTML=`\n            <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n            <span class="cr-dropdown__trigger-text ${ye(!r&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(e)}</span>\n            ${a>0?`<span class="cr-dropdown__count">${a}</span>`:""}\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const a=fe(`#${h.pW}_new_session_btn`);a&&(a.disabled=!n);const o=fe(`#${h.pW}_session_list`);o&&(o.innerHTML=Ur());const s=t.sessions.length,c=fe(".cr-dropdown__footer",e);if(c){const e=fe(`#${h.pW}_delete_all_sessions_btn`,c);if(s>0&&!e){const e=document.createElement("button");e.id=`${h.pW}_delete_all_sessions_btn`,e.className="menu_button menu_button--sm menu_button--ghost cr-dropdown__delete-all-btn",e.type="button",e.title="Delete all sessions for this character",e.innerHTML='<i class="fa-solid fa-trash"></i> Delete All',c.appendChild(e),e.addEventListener("click",e=>Lr(this,void 0,void 0,function*(){e.stopPropagation();const t=B().sessions.length;if(yield h.lY.confirm("Delete All Sessions",`Are you sure you want to delete all ${t} session${1!==t?"s":""} for this character? This cannot be undone.`))try{const e=yield J();e.success?(h.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""}`),Dr(!1),Fr(),Pe()):h.oR.error("Failed to delete sessions")}catch(e){h.oR.error("Failed to delete sessions"),h.Rm.error("Delete all sessions error:",e)}}))}else 0===s&&e&&e.remove()}}var Hr=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};const Gr={isOpen:!1};let qr=[],Jr={};function Yr(e){const t=SillyTavern.libs.DOMPurify,r=(0,y.getSettings)(),n=e.isReady?"cr-api-banner--ready":"cr-api-banner--error",i=e.isReady?"fa-circle-check":"fa-circle-xmark",a="cc"===e.apiType?"Chat":"Text",o=null!==r.maxTokensOverride,s=o?r.maxTokensOverride:e.maxOutput,c=o?'<i class="fa-solid fa-pen cr-api-banner__override-icon" title="Custom output limit active"></i>':"";return`\n        <div class="cr-api-banner ${n}">\n            <div class="cr-api-banner__left">\n                <i class="fa-solid ${i}"></i>\n                <span class="cr-api-banner__name">${t.sanitize(e.displayName)}</span>\n                <span class="cr-badge cr-badge--small">${a}</span>\n            </div>\n            <div class="cr-api-banner__right">\n                <span class="cr-api-banner__model" title="${t.sanitize(e.model)}">${t.sanitize(e.modelDisplay)}</span>\n                <span class="cr-api-banner__limits ${o?"cr-api-banner__limits--override":""}">${c}${s.toLocaleString()}t max</span>\n            </div>\n        </div>\n        ${e.error?`\n            <div class="cr-api-error">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                <span>${t.sanitize(e.error)}</span>\n            </div>\n        `:""}\n    `}function Vr(e){const t=SillyTavern.libs.DOMPurify;if(!e)return'\n            <div class="cr-profile-info cr-profile-info--empty">\n                <i class="fa-solid fa-circle-question"></i>\n                <span>Select a profile above</span>\n            </div>\n        ';const r="cc"===e.mode?"Chat":"Text";return`\n        <div class="cr-profile-info ${e.isSupported?"":"cr-profile-info--error"}">\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">API</span>\n                <span class="cr-profile-info__value">${t.sanitize(e.api)}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Model</span>\n                <span class="cr-profile-info__value" title="${t.sanitize(e.model)}">${t.sanitize(function(e){const t=e.replace(/^anthropic\//,"").replace(/^openai\//,"").replace(/^google\//,"").replace(/^meta-llama\//,"llama-").replace(/^mistralai\//,"mistral-");if(t.length>30)return t.substring(0,27)+"...";return t}(e.model))}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Type</span>\n                <span class="cr-badge cr-badge--small">${r}</span>\n            </div>\n            ${e.presetName?`\n                <div class="cr-profile-info__row">\n                    <span class="cr-profile-info__label">Preset</span>\n                    <span class="cr-profile-info__value">${t.sanitize(e.presetName)}</span>\n                </div>\n            `:""}\n            ${e.isSupported?"":`\n                <div class="cr-profile-info__error">\n                    <i class="fa-solid fa-triangle-exclamation"></i>\n                    <span>${e.validationError||"Profile configuration is invalid"}</span>\n                </div>\n            `}\n        </div>\n    `}function Qr(){return`\n        <div id="${h.pW}_settings_drawer" class="cr-drawer" aria-hidden="true">\n            <div class="cr-drawer__backdrop"></div>\n            <aside class="cr-drawer__panel" role="dialog" aria-label="${h.hi} Settings">\n                <div class="cr-drawer__content">\n                    ${Xr()}\n                    ${Kr()}\n                    ${Zr()}\n                </div>\n            </aside>\n        </div>\n    `}function Xr(){return`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid fa-cog"></i>\n                <h3>${h.hi} Settings</h3>\n            </div>\n            <button id="${h.pW}_settings_close"\n                    class="cr-btn cr-btn--icon cr-btn--ghost menu_button"\n                    type="button"\n                    title="Close settings">\n                <i class="fa-solid fa-xmark"></i>\n            </button>\n        </header>\n    `}function Kr(){var e;const t=SillyTavern.libs.DOMPurify,r=(0,y.getSettings)(),n=(0,h.We)(),i=(0,h.Lq)("profile"===r.generationMode?r.profileId:null),a="profile"===r.generationMode&&0===n.length?"current":r.generationMode;return`\n        <div class="cr-drawer__body">\n            \x3c!-- Generation Settings --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-sliders"></i>\n                    Generation\n                </h3>\n\n                \x3c!-- Current API Status --\x3e\n                <div id="${h.pW}_api_status_banner">\n                    ${Yr(i)}\n                </div>\n\n                \x3c!-- Mode Toggle --\x3e\n                ${(0,h.mi)()?`\n                <div class="cr-gen-mode-toggle">\n                    <label class="cr-gen-mode-option ${"current"===a?"cr-gen-mode-option--active":""}" data-mode="current">\n                        <input type="radio" name="${h.pW}_gen_mode" value="current" ${"current"===a?"checked":""}/>\n                        <i class="fa-solid fa-sliders"></i>\n                        <span>Current ST Settings</span>\n                    </label>\n                    <label class="cr-gen-mode-option ${"profile"===a?"cr-gen-mode-option--active":""}" data-mode="profile">\n                        <input type="radio" name="${h.pW}_gen_mode" value="profile" ${"profile"===a?"checked":""}/>\n                        <i class="fa-solid fa-plug"></i>\n                        <span>Connection Profile</span>\n                    </label>\n                </div>\n\n                \x3c!-- Profile Selection --\x3e\n                <div id="${h.pW}_profile_section" class="cr-profile-section ${"current"===a?"cr-hidden":""}">\n                    ${n.length>0?`\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">Select Profile</label>\n                        <select id="${h.pW}_profile_select" class="cr-select text_pole">\n                            <option value="">-- Select a profile --</option>\n                            ${n.map(e=>`\n                            <option value="${e.id}"\n                                    ${e.id===r.profileId?"selected":""}\n                                    ${e.isSupported?"":"disabled"}>\n                                ${t.sanitize(e.name)}${e.isSupported?"":" (invalid)"}\n                            </option>\n                            `).join("")}\n                        </select>\n                    </div>\n                    <div id="${h.pW}_profile_info_container">\n                        ${Vr(n.find(e=>e.id===r.profileId)||null)}\n                    </div>\n                    `:'\n                    <div class="cr-profile-empty">\n                        <i class="fa-solid fa-info-circle"></i>\n                        <div>\n                            <strong>No connection profiles found</strong>\n                            <p>Create profiles in SillyTavern\'s Connection Manager to use specific API configurations.</p>\n                        </div>\n                    </div>\n                    '}\n                </div>\n                `:""}\n\n                \x3c!-- Max Tokens Override --\x3e\n                <details class="cr-collapsible">\n                    <summary>Response Length Override</summary>\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">\n                            <input type="checkbox"\n                                   id="${h.pW}_max_tokens_enabled"\n                                   ${null!==r.maxTokensOverride?"checked":""}/>\n                            <span>Override max response tokens</span>\n                        </label>\n                        <input type="number"\n                               id="${h.pW}_max_tokens"\n                               class="cr-number-input text_pole"\n                               value="${null!==(e=r.maxTokensOverride)&&void 0!==e?e:4096}"\n                               min="100"\n                               max="32000"\n                               step="100"\n                               ${null===r.maxTokensOverride?"disabled":""}/>\n                        <span class="cr-setting-hint">\n                            Leave unchecked to use the profile's preset settings\n                        </span>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- System Prompt --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-terminal"></i>\n                    System Prompt\n                </h3>\n                <p class="cr-setting-desc">\n                    The system prompt is sent with every generation. Your additions are appended after the base prompt.\n                </p>\n\n                <div class="cr-setting-item">\n                    <label class="cr-setting-label">Your Additions</label>\n                    <textarea id="${h.pW}_user_system_prompt"\n                              class="cr-textarea text_pole"\n                              rows="4"\n                              placeholder="Add custom instructions...">${t.sanitize(r.userSystemPrompt)}</textarea>\n                </div>\n\n                <details class="cr-collapsible">\n                    <summary>Base Prompt</summary>\n                    <div class="cr-collapsible__content">\n                        <div class="cr-warning-banner">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>Editing the base prompt may affect results. Use "Revert" to restore defaults.</span>\n                        </div>\n                        <textarea id="${h.pW}_base_system_prompt"\n                                  class="cr-textarea cr-textarea--compact text_pole"\n                                  rows="4">${t.sanitize(r.baseSystemPrompt)}</textarea>\n                        <button id="${h.pW}_revert_system_prompt"\n                                class="cr-btn cr-btn--small menu_button cr-mt-2"\n                                type="button">\n                            <i class="fa-solid fa-rotate-left"></i>\n                            Revert to Default\n                        </button>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- Refinement Prompt --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-rotate"></i>\n                    Refinement Prompt\n                </h3>\n                <p class="cr-setting-desc">\n                    Instructions for refinement iterations. Your additions are appended after the base.\n                </p>\n\n                <div class="cr-setting-item">\n                    <label class="cr-setting-label">Your Additions</label>\n                    <textarea id="${h.pW}_user_refinement_prompt"\n                              class="cr-textarea text_pole"\n                              rows="4"\n                              placeholder="Add custom refinement instructions...">${t.sanitize(r.userRefinementPrompt)}</textarea>\n                </div>\n\n                <details class="cr-collapsible">\n                    <summary>Base Prompt</summary>\n                    <div class="cr-collapsible__content">\n                        <div class="cr-warning-banner">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>Editing the base prompt may affect results. Use "Revert" to restore defaults.</span>\n                        </div>\n                        <textarea id="${h.pW}_base_refinement_prompt"\n                                  class="cr-textarea cr-textarea--compact text_pole"\n                                  rows="4">${t.sanitize(r.baseRefinementPrompt)}</textarea>\n                        <button id="${h.pW}_revert_refinement_prompt"\n                                class="cr-btn cr-btn--small menu_button cr-mt-2"\n                                type="button">\n                            <i class="fa-solid fa-rotate-left"></i>\n                            Revert to Default\n                        </button>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- Reset Settings --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-rotate-left"></i>\n                    Reset\n                </h3>\n                <button id="${h.pW}_reset_settings"\n                        class="cr-btn cr-btn--small cr-btn--danger menu_button"\n                        type="button">\n                    <i class="fa-solid fa-rotate-left"></i>\n                    Reset All Settings\n                </button>\n            </section>\n\n            \x3c!-- Data Management --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-database"></i>\n                    Data Management\n                </h3>\n                <div class="cr-danger-zone">\n                    <div class="cr-danger-zone__warning">\n                        <i class="fa-solid fa-skull-crossbones"></i>\n                        <div>\n                            <strong>Danger Zone</strong>\n                            <p>These actions are destructive and cannot be undone.</p>\n                        </div>\n                    </div>\n                    <button id="${h.pW}_purge_all_sessions"\n                            class="menu_button menu_button--danger"\n                            type="button">\n                        <i class="fa-solid fa-trash"></i>\n                        Delete All Sessions (All Characters)\n                    </button>\n                </div>\n            </section>\n\n            \x3c!-- Keyboard Shortcuts --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-keyboard"></i>\n                    Keyboard Shortcuts\n                </h3>\n                <div class="cr-shortcuts-list">\n                    <div class="cr-shortcut">\n                        <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n                        <span>Run current stage</span>\n                    </div>\n                    <div class="cr-shortcut">\n                        <kbd>Escape</kbd>\n                        <span>Cancel generation</span>\n                    </div>\n                </div>\n            </section>\n        </div>\n    `}function Zr(){return`\n        <footer class="cr-drawer__footer cr-drawer__footer--spaced">\n            <span class="cr-version">v${h.xv}</span>\n            <button id="${h.pW}_settings_save"\n                    class="cr-btn cr-btn--primary menu_button"\n                    type="button">\n                <i class="fa-solid fa-check"></i>\n                Save & Close\n            </button>\n        </footer>\n    `}function en(e,t){const r=fe(`#${h.pW}_api_status_banner`,e);if(!r)return;let n=null;if(t){const t=fe(`#${h.pW}_profile_select`,e);n=(null==t?void 0:t.value)||null}const i=(0,h.Lq)(n);r.innerHTML=Yr(i)}function tn(e){const t=fe(`#${h.pW}_settings_close`,e);t&&qr.push(ge(t,"click",()=>{nn()}));const r=fe(`#${h.pW}_settings_save`,e);r&&qr.push(ge(r,"click",()=>{!function(){const e=(0,y.getSettings)(),t=fe(`#${h.pW}_settings_drawer`);if(!t)return;const r=t.querySelector(`input[name="${h.pW}_gen_mode"]:checked`);r&&(e.generationMode=r.value);const n=fe(`#${h.pW}_profile_select`,t);n&&(e.profileId=n.value||null);const i=fe(`#${h.pW}_max_tokens_enabled`,t),a=fe(`#${h.pW}_max_tokens`,t);i&&a&&(e.maxTokensOverride=i.checked?parseInt(a.value,10):null);const o=fe(`#${h.pW}_user_system_prompt`,t);o&&(e.userSystemPrompt=o.value);const s=fe(`#${h.pW}_user_refinement_prompt`,t);s&&(e.userRefinementPrompt=s.value);const c=fe(`#${h.pW}_base_system_prompt`,t);c&&(e.baseSystemPrompt=c.value);const l=fe(`#${h.pW}_base_refinement_prompt`,t);l&&(e.baseRefinementPrompt=l.value),(0,y.save)(),h.oR.success("Settings saved")}(),nn()}));const n=fe(".cr-drawer__backdrop",e);n&&qr.push(ge(n,"click",()=>{nn()}));const i=e=>{"Escape"===e.key&&Gr.isOpen&&(e.preventDefault(),e.stopPropagation(),nn())};document.addEventListener("keydown",i),qr.push(()=>document.removeEventListener("keydown",i));const a=me(".cr-gen-mode-option",e),o=fe(`#${h.pW}_profile_section`,e);for(const t of a)qr.push(ge(t,"click",()=>{const r=t.dataset.mode;a.forEach(e=>e.classList.remove("cr-gen-mode-option--active")),t.classList.add("cr-gen-mode-option--active"),o&&o.classList.toggle("cr-hidden","current"===r),en(e,"profile"===r)}));const s=fe(`#${h.pW}_profile_select`,e),c=fe(`#${h.pW}_profile_info_container`,e);s&&c&&qr.push(ge(s,"change",()=>{const t=(0,h.We)().find(e=>e.id===s.value);c.innerHTML=Vr(t||null),en(e,!0)}));const l=fe(`#${h.pW}_max_tokens_enabled`,e),d=fe(`#${h.pW}_max_tokens`,e);l&&d&&qr.push(ge(l,"change",()=>{d.disabled=!l.checked}));const p=fe(`#${h.pW}_reset_settings`,e);p&&qr.push(ge(p,"click",()=>Hr(this,void 0,void 0,function*(){(yield h.lY.confirm("Reset Settings","This will reset all settings to defaults. Custom presets will be kept. Continue?"))&&((0,y.resetSettings)(),h.oR.success("Settings reset to defaults"),function(){const e=fe(`#${h.pW}_settings_drawer`);if(!e)return;const t=fe(".cr-drawer__panel",e);t&&(qr.forEach(e=>e()),qr=[],t.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Xr()}\n                ${Kr()}\n                ${Zr()}\n            </div>\n        `,tn(e))}())})));const u=fe(`#${h.pW}_revert_system_prompt`,e),f=fe(`#${h.pW}_base_system_prompt`,e);u&&f&&qr.push(ge(u,"click",()=>{f.value=y.BASE_SYSTEM_PROMPT,h.oR.info("Base system prompt reverted to default")}));const m=fe(`#${h.pW}_revert_refinement_prompt`,e),g=fe(`#${h.pW}_base_refinement_prompt`,e);m&&g&&qr.push(ge(m,"click",()=>{g.value=y.BASE_REFINEMENT_PROMPT,h.oR.info("Base refinement prompt reverted to default")}));const v=fe(`#${h.pW}_purge_all_sessions`,e);v&&qr.push(ge(v,"click",()=>Hr(this,void 0,void 0,function*(){if(yield h.lY.confirm("Delete ALL Sessions?","This will permanently delete ALL sessions for ALL characters. This action cannot be undone."))try{const e=yield(0,y.purgeAllSessions)();e.success?h.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""} across all characters`):h.oR.error("Failed to delete sessions")}catch(e){h.oR.error("Failed to delete sessions"),h.Rm.error("Purge all sessions error:",e)}})))}function rn(e){if(fe(`#${h.pW}_settings_drawer`))return;const t=e.closest(".popup");t?t.insertAdjacentHTML("beforeend",Qr()):document.body.insertAdjacentHTML("beforeend",Qr())}function nn(){const e=fe(`#${h.pW}_settings_drawer`);e&&Gr.isOpen&&(Gr.isOpen=!1,e.classList.remove("cr-drawer--open"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{var e;qr.forEach(e=>e()),qr=[],null===(e=Jr.onClose)||void 0===e||e.call(Jr)},300))}function an(e,t){rn(e),function(e){const t=fe(`#${h.pW}_settings_drawer`);if(!t)return void h.Rm.error("Settings drawer not initialized");qr.forEach(e=>e()),qr=[],Jr=e||{};const r=fe(".cr-drawer__panel",t);r&&(r.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Xr()}\n                ${Kr()}\n                ${Zr()}\n            </div>\n        `),tn(t),Gr.isOpen=!0,requestAnimationFrame(()=>{t.classList.add("cr-drawer--open"),t.setAttribute("aria-hidden","false")})}(t)}let on=null;function sn(){const e=SillyTavern.libs.DOMPurify,t=(0,h.Lq)(on),r=(0,h.mi)(),n=r?(0,h.We)():[],i=t.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger",a=t.isReady?"cr-api-status--ready":"cr-api-status--error",o=r&&n.length>0?`\n        <select id="${h.pW}_profile_select" \n                class="cr-select cr-selecr--sm text_pole" \n                aria-label="Connection profile">\n            <option value="" ${on?"":"selected"}>\n                Current Settings\n            </option>\n            ${n.map(e=>function(e,t){const r=SillyTavern.libs.DOMPurify;return`\n        <option value="${e.id}" \n                ${t?"selected":""}\n                ${e.isSupported?"":"disabled"}>\n            ${r.sanitize(e.name)} (${r.sanitize(e.model)})\n        </option>\n    `}(e,e.id===on)).join("")}\n        </select>\n    `:"";return`\n        <div id="${h.pW}_api_status" class="cr-api-status ${a}">\n            <div class="cr-api-status__indicator">\n                <i class="fa-solid ${i}"></i>\n                <span class="cr-api-status__text">${e.sanitize(t.modelDisplay)}</span>\n            </div>\n            ${o}\n            ${t.error?`\n                <span class="cr-api-status__error" title="${e.sanitize(t.error)}">\n                    <i class="fa-solid fa-exclamation-triangle"></i>\n                </span>\n            `:""}\n        </div>\n    `}function cn(e){const t=[],r=fe(`#${h.pW}_profile_select`,e);return r&&t.push(ge(r,"change",()=>{const e=r.value||null;on=e;(0,y.getSettings)().profileId=e,(0,y.save)(),function(){const e=fe(`#${h.pW}_api_status`);if(!e)return;const t=e.parentElement;t&&(t.innerHTML=sn(),cn(t))}()})),()=>{t.forEach(e=>e())}}var ln=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};let dn=null;function pn(){return`\n<div id="${h.pW}_popup" class="cr-popup">\n    <header class="cr-header">\n        <div class="cr-header__left">\n            ${function(){const e=SillyTavern.libs.DOMPurify,t=B().character,r=t?e.sanitize(t.name):"Select character...",n=t?`<img class="cr-dropdown__trigger-avatar"\n               src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n               alt=""\n               onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';return`\n        <div id="${h.pW}_char_dropdown" class="cr-dropdown ${Ie?"cr-dropdown--open":""}">\n            <button id="${h.pW}_char_trigger"\n                    class="cr-dropdown__trigger"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${Ie}">\n                ${n}\n                <span class="cr-dropdown__trigger-text ${t?"":"cr-dropdown__trigger-text--placeholder"}">${r}</span>\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel" role="listbox">\n                <div class="cr-dropdown__search">\n                    <i class="fa-solid fa-search cr-dropdown__search-icon"></i>\n                    <input type="text"\n                           id="${h.pW}_char_search"\n                           class="cr-dropdown__search-input"\n                           placeholder="Search characters..."\n                           autocomplete="off"\n                           value="${e.sanitize(ze)}"/>\n                    ${ze?'\n                        <button class="cr-dropdown__search-clear" type="button" aria-label="Clear">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    ':""}\n                </div>\n                <div id="${h.pW}_char_list" class="cr-dropdown__list cr-scrollable">\n                    ${Le()}\n                </div>\n            </div>\n        </div>\n    `}()}\n            ${function(){const e=B(),t=e.sessions.find(t=>t.id===e.activeSessionId),r=!!e.character;let n="New Session";r?t&&(n=Mr(t)):n="Select character...";const i=e.sessions.length;return`\n        <div id="${h.pW}_session_dropdown" class="cr-dropdown cr-dropdown--session ${ye(jr&&"cr-dropdown--open")} ${ye(!r&&"cr-dropdown--disabled")}">\n            <button id="${h.pW}_session_trigger"\n                    class="cr-dropdown__trigger cr-dropdown__trigger--session"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${jr}"\n                    ${r?"":"disabled"}>\n                <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n                <span class="cr-dropdown__trigger-text ${ye(!t&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(n)}</span>\n                ${i>0?`<span class="cr-dropdown__count">${i}</span>`:""}\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel cr-dropdown__panel--session" role="listbox">\n                <div id="${h.pW}_session_list" class="cr-dropdown__list cr-dropdown__list--session cr-scrollable">\n                    ${Ur()}\n                </div>\n                <div class="cr-dropdown__footer">\n                    <button id="${h.pW}_new_session_btn"\n                            class="menu_button menu_button--sm menu_button--primary cr-dropdown__new-btn"\n                            type="button"\n                            ${r?"":"disabled"}>\n                        <i class="fa-solid fa-plus"></i>\n                        New Session\n                    </button>\n                    ${i>0?`\n                    <button id="${h.pW}_delete_all_sessions_btn"\n                            class="menu_button menu_button--sm menu_button--ghost cr-dropdown__delete-all-btn"\n                            type="button"\n                            title="Delete all sessions for this character">\n                        <i class="fa-solid fa-trash"></i>\n                        Delete All\n                    </button>\n                    `:""}\n                </div>\n            </div>\n        </div>\n    `}()}\n        </div>\n        <div class="cr-header__center">\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <h2>Card Refinery</h2>\n            <div id="${h.pW}_api_status_container">\n                ${function(){const e=(0,h.Lq)(on),t=e.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger";return`\n        <div class="cr-api-badge ${ye(!e.isReady&&"cr-api-badge--error")}" \n             title="${e.statusText}${e.error?": "+e.error:""}">\n            <i class="fa-solid ${t}"></i>\n            <span>${e.modelDisplay}</span>\n        </div>\n    `}()}\n            </div>\n        </div>\n        <div class="cr-header__right">\n            <button id="${h.pW}_settings_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Settings"\n                    aria-label="Settings">\n                <i class="fa-solid fa-cog"></i>\n            </button>\n            <button id="${h.pW}_close_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Close"\n                    aria-label="Close popup">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    </header>\n\n    <div class="cr-toolbar">\n        \n        <nav class="cr-stage-tabs" role="tablist" aria-label="Pipeline stages">\n            ${h.an.map(Ar).join("")}\n        </nav>\n    \n        <div id="${h.pW}_pipeline_controls" class="cr-toolbar__controls">\n            ${Cr()}\n        </div>\n    </div>\n\n    <div class="cr-body">\n        <aside class="cr-panel cr-panel--config cr-scrollable">\n            ${function(){const e=SillyTavern.libs.DOMPurify,t=B(),r=t.activeStage,n=t.stageConfigs[r];let i=n.customPrompt;if(!i&&n.promptPresetId){const e=(0,y.getPromptPreset)(n.promptPresetId);e&&(i=e.prompt)}let a=n.customSchema;if(!a&&n.schemaPresetId){const e=(0,y.getSchemaPreset)(n.schemaPresetId);e&&(a=JSON.stringify(e.schema,null,2))}return`\n        <section class="cr-section cr-stage-config" aria-label="Stage Configuration">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">\n                    <i class="fa-solid ${h.iu[r]}"></i>\n                    ${h.BA[r]} Configuration\n                </h3>\n            </div>\n\n            \x3c!-- Field Selection --\x3e\n            <div class="cr-stack cr-stack--tight">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-list-check cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Fields to Include</span>\n                    </div>\n                    <button id="${h.pW}_link_fields"\n                            class="menu_button menu_button--icon menu_button--sm menu_button--ghost ${K()?"cr-active":""}"\n                            type="button"\n                            title="${K()?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)"}"\n                            aria-pressed="${K()}">\n                        <i class="fa-solid ${K()?"fa-link":"fa-link-slash"}"></i>\n                    </button>\n                </div>\n                <div id="${h.pW}_fields_container">\n                    ${dt()}\n                </div>\n            </div>\n\n            \x3c!-- Prompt Configuration --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-message cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Prompt</span>\n                    </div>\n                    <div class="cr-row cr-gap-1">\n                        <button id="${h.pW}_save_prompt"\n                                class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Save as preset"\n                                aria-label="Save as preset">\n                            <i class="fa-solid fa-floppy-disk"></i>\n                        </button>\n                        ${ft("prompt",r,n.promptPresetId)}\n                    </div>\n                </div>\n                <div class="cr-form-group">\n                    <textarea id="${h.pW}_prompt"\n                              placeholder="Enter instructions for this stage..."\n                              rows="6">${e.sanitize(i)}</textarea>\n                    <div class="cr-form-group__hint cr-text-right">\n                        <span id="${h.pW}_prompt_tokens">Calculating...</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Structured Output Toggle --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <label class="cr-checkbox">\n                    <input type="checkbox"\n                           id="${h.pW}_use_schema"\n                           ${n.useStructuredOutput?"checked":""}/>\n                    <span>Use Structured Output (JSON Schema)</span>\n                </label>\n\n                <div id="${h.pW}_schema_section"\n                     class="${ye(!n.useStructuredOutput&&"cr-hidden")} cr-stack cr-stack--tight cr-mt-2">\n                    <div class="cr-row cr-row--between">\n                        <div class="cr-row">\n                            <i class="fa-solid fa-code cr-text-accent"></i>\n                            <span class="cr-font-medium cr-text-sm">JSON Schema</span>\n                        </div>\n                        <div class="cr-row cr-gap-1">\n                            <button id="${h.pW}_save_schema"\n                                    class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                    type="button"\n                                    title="Save as schema preset"\n                                    aria-label="Save as schema preset">\n                                <i class="fa-solid fa-floppy-disk"></i>\n                            </button>\n                            ${ft("schema",r,n.schemaPresetId)}\n                        </div>\n                    </div>\n                    <textarea id="${h.pW}_schema"\n                              class="cr-textarea--code"\n                              placeholder='{"name": "MySchema", "strict": true, "value": {...}}'\n                              rows="8">${e.sanitize(a)}</textarea>\n                    <div class="cr-button-group">\n                        <button id="${h.pW}_generate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button"\n                                title="Generate schema from description using AI">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            Generate\n                        </button>\n                        <button id="${h.pW}_validate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-check"></i>\n                            Validate\n                        </button>\n                        <button id="${h.pW}_format_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-indent"></i>\n                            Format\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Preview --\x3e\n            <div class="cr-mt-4">\n                <button id="${h.pW}_preview"\n                        class="menu_button menu_button--full"\n                        type="button"\n                        ${t.character?"":"disabled"}>\n                    <i class="fa-solid fa-eye"></i>\n                    Preview Full Prompt\n                </button>\n            </div>\n        </section>\n    `}()}\n        </aside>\n        <main class="cr-panel cr-panel--results">\n            ${function(){var e,t;const r=B(),n=ie(),i=null!==n,a=i?n:r.stageResults[r.activeStage],o=!!r.stageResults.rewrite,s=r.iterationHistory.length>0,c=o&&!i&&"rewrite"===r.activeStage,l=!i&&o&&"rewrite"===r.activeStage,d=i?`\n            <div class="cr-history-nav">\n                <div class="cr-history-nav__info">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Viewing history ${(null!==(e=r.viewingHistoryIndex)&&void 0!==e?e:0)+1} of ${r.iterationHistory.length}</span>\n                </div>\n                <div class="cr-history-nav__controls">\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_prev"\n                            type="button"\n                            title="Previous"\n                            ${0===r.viewingHistoryIndex?"disabled":""}>\n                        <i class="fa-solid fa-chevron-left"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_next"\n                            type="button"\n                            title="Next"\n                            ${r.viewingHistoryIndex===r.iterationHistory.length-1?"disabled":""}>\n                        <i class="fa-solid fa-chevron-right"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                            id="${h.pW}_history_restore"\n                            type="button"\n                            title="Restore this as current result">\n                        <i class="fa-solid fa-rotate-left"></i> Restore\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--sm"\n                            id="${h.pW}_history_back"\n                            type="button"\n                            title="Back to current results">\n                        <i class="fa-solid fa-xmark"></i> Back\n                    </button>\n                </div>\n            </div>\n        `:"",p=c?`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===yr?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===yr?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${l?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply or export rewritten content">\n                    <i class="fa-solid fa-file-export"></i> Apply / Export\n                </button>\n            ':""}\n        `:"",u=i?wr(a,null!==(t=null==a?void 0:a.stage)&&void 0!==t?t:r.activeStage):"compare"===yr&&c?`<div id="${h.pW}_compare_content">${xt()}</div>`:wr(a,r.activeStage),f=s?`\n            <div class="cr-history ${ye(!r.historyExpanded&&"cr-history--collapsed")}">\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${r.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${r.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="cr-history__list cr-list">\n                    ${r.iterationHistory.map((e,t)=>$r(e,t)).join("")}\n                </div>\n            </div>\n        `:"";return`\n        <div class="cr-results-wrapper">\n            \x3c!-- History Navigation (when viewing history) --\x3e\n            ${d}\n\n            \x3c!-- View Toggle --\x3e\n            ${p?`<div class="cr-results-toolbar">${p}</div>`:""}\n\n            \x3c!-- Results/Compare content --\x3e\n            <div id="${h.pW}_results_content" class="cr-results-content">\n                ${u}\n            </div>\n\n            \x3c!-- Run History Section (only if there's history) --\x3e\n            ${f}\n        </div>\n    `}()}\n        </main>\n    </div>\n</div>`}let un=[];function fn(){return ln(this,void 0,void 0,function*(){const e=SillyTavern.getContext(),{DOMPurify:t}=SillyTavern.libs;j();const r=pn();new e.Popup(t.sanitize(r),e.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>ln(this,void 0,void 0,function*(){yield function(){return ln(this,void 0,void 0,function*(){!function(){for(const e of lt)e.flush()}(),yield F(),un.forEach(e=>e()),un=[],Wr.forEach(e=>e()),Wr=[],function(){const e=fe(`#${h.pW}_preset_drawer`);e&&e.remove(),He.forEach(e=>e()),He=[],Ue.isOpen=!1}(),function(){const e=fe(`#${h.pW}_settings_drawer`);e&&e.remove(),qr.forEach(e=>e()),qr=[],Gr.isOpen=!1}(),be.clear(),_e.clear(),xe=!1,function(){for(const e of lt)e.cancel();lt=[]}(),dn=null,M(),(0,y.clearCache)(),h.Rm.debug("Popup closed")})}()})),yield new Promise(e=>setTimeout(e,0)),dn=document.getElementById(`${h.pW}_popup`),dn?(!function(e){if(fe(`#${h.pW}_preset_drawer`))return;const t=e.closest(".popup");t?t.insertAdjacentHTML("beforeend",Ge()):document.body.insertAdjacentHTML("beforeend",Ge())}(dn),rn(dn),function(e){un.forEach(e=>e()),un=[],un.push(we("characterSelector",je,["character","session"])),un.push(we("stageTabs",Ir,["stage","pipeline"])),un.push(we("pipelineControls",zr,["pipeline","character"])),un.push(we("stageConfig",gt,["stage","config","fields","character"])),un.push(we("results",kr,["results","stage"])),un.push(we("sessionDropdown",Fr,["session","character"])),un.push(function(e){const t=[],r=fe(`#${h.pW}_char_dropdown`,e),n=fe(`#${h.pW}_char_trigger`,e),i=fe(`#${h.pW}_char_search`,e),a=fe(`#${h.pW}_char_list`,e);n&&t.push(ge(n,"click",e=>{e.stopPropagation(),We(!Ie),Ie&&i&&setTimeout(()=>i.focus(),0)}));const o=e=>{Ie&&r&&!r.contains(e.target)&&We(!1)};if(document.addEventListener("click",o),t.push(()=>document.removeEventListener("click",o)),i){Te&&(Te.cancel(),Te=null),Te=SillyTavern.libs.lodash.debounce(()=>{ze=i.value,Oe=-1,a&&(a.innerHTML=Le())},h.U8.SEARCH);const e=Te;t.push(ge(i,"input",()=>{e()})),t.push(ge(i,"keydown",e=>{const t=me(".cr-char-option",a),r=t.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),Oe=Math.min(Oe+1,r),Be(t);break;case"ArrowUp":e.preventDefault(),Oe=Math.max(Oe-1,0),Be(t);break;case"Enter":e.preventDefault(),Oe>=0&&t[Oe]&&De(t[Oe]);break;case"Escape":e.preventDefault(),We(!1),null==n||n.focus()}})),t.push(()=>{e.cancel(),Te=null})}const s=fe(".cr-dropdown__search-clear",e);return s&&i&&t.push(ge(s,"click",e=>{e.stopPropagation(),i.value="",ze="",Oe=-1,a&&(a.innerHTML=Le()),i.focus()})),a&&t.push(ge(a,"click",e=>{const t=e.target.closest(".cr-char-option");t&&De(t)})),()=>{t.forEach(e=>e()),Ie=!1,ze="",Oe=-1}}(e)),un.push(function(e){const t=[],r=fe(`#${h.pW}_session_dropdown`,e),n=fe(`#${h.pW}_session_trigger`,e),i=fe(`#${h.pW}_session_list`,e),a=fe(`#${h.pW}_new_session_btn`,e);n&&t.push(ge(n,"click",e=>{e.stopPropagation(),n.disabled||Dr(!jr)}));const o=e=>{jr&&r&&!r.contains(e.target)&&(Dr(!1),Fr())};document.addEventListener("click",o),t.push(()=>document.removeEventListener("click",o)),a&&t.push(ge(a,"click",e=>Lr(this,void 0,void 0,function*(){e.stopPropagation();try{(yield H())&&(h.oR.success("New session created"),Dr(!1),Pe())}catch(e){h.oR.error("Failed to create session"),h.Rm.error("Create session error:",e)}})));const s=fe(`#${h.pW}_delete_all_sessions_btn`,e);return s&&t.push(ge(s,"click",e=>Lr(this,void 0,void 0,function*(){e.stopPropagation();const t=B().sessions.length;if(yield h.lY.confirm("Delete All Sessions",`Are you sure you want to delete all ${t} session${1!==t?"s":""} for this character? This cannot be undone.`))try{const e=yield J();e.success?(h.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""}`),Dr(!1),Fr(),Pe()):h.oR.error("Failed to delete sessions")}catch(e){h.oR.error("Failed to delete sessions"),h.Rm.error("Delete all sessions error:",e)}}))),i&&(t.push(ge(i,"click",e=>Lr(this,void 0,void 0,function*(){const t=e.target,r=t.closest(".cr-session-option");if(!r)return;const n=r.dataset.sessionId||t.dataset.sessionId;if(n){if(t.closest(".cr-session-edit"))return e.stopPropagation(),Br=n,Fr(),void setTimeout(()=>{const e=fe(`.cr-session-option__name-input[data-session-id="${n}"]`);e&&(e.focus(),e.select())},0);if(t.closest(".cr-session-save")){e.stopPropagation();const t=fe(`.cr-session-option__name-input[data-session-id="${n}"]`);if(t)try{yield V(n,t.value),h.oR.success("Session renamed")}catch(e){h.oR.error("Failed to rename session"),h.Rm.error("Rename session error:",e)}return Br=null,void Fr()}if(t.closest(".cr-session-cancel"))return e.stopPropagation(),Br=null,void Fr();if(t.closest(".cr-session-delete")){if(e.stopPropagation(),yield h.lY.confirm("Delete Session","Are you sure you want to delete this session? This cannot be undone."))try{(yield q(n))?(h.oR.success("Session deleted"),Fr(),Pe()):h.oR.error("Failed to delete session")}catch(e){h.oR.error("Failed to delete session"),h.Rm.error("Delete session error:",e)}return}if(!r.classList.contains("cr-session-option--active")&&!Br)try{(yield G(n))?(h.oR.success("Session loaded"),Dr(!1),Pe()):h.oR.error("Failed to load session")}catch(e){h.oR.error("Failed to load session"),h.Rm.error("Load session error:",e)}}}))),t.push(ge(i,"keydown",e=>Lr(this,void 0,void 0,function*(){const t=e.target;if(!t.classList.contains("cr-session-option__name-input"))return;const r=t.dataset.sessionId;if(r)if("Enter"===e.key){e.preventDefault();try{yield V(r,t.value),h.oR.success("Session renamed")}catch(e){h.oR.error("Failed to rename session"),h.Rm.error("Rename session error:",e)}Br=null,Fr()}else"Escape"===e.key&&(e.preventDefault(),Br=null,Fr())})))),()=>{t.forEach(e=>e()),jr=!1,Br=null}}(e)),un.push(function(e){const t=[],r=fe(".cr-stage-tabs",e);r&&t.push(ge(r,"click",e=>{const t=e.target.closest(".cr-stage-tab");if(!t)return;const r=t.dataset.stage;r&&(ee(r),Ir(),gt(),kr(),zr())}));const n=fe(`#${h.pW}_pipeline_controls`,e);return n&&Nr(n),()=>{t.forEach(e=>e())}}(e)),un.push(ht(e)),un.push(Sr(e));const t=fe(`#${h.pW}_api_status_container`,e);t&&un.push(cn(t));const r=fe(`#${h.pW}_settings_btn`,e);r&&un.push(ge(r,"click",()=>{an(e)}));const n=fe(`#${h.pW}_close_btn`,e);n&&un.push(ge(n,"click",()=>{!function(){if(!dn)return;const e=dn.closest(".popup"),t=null==e?void 0:e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}()}));const i=t=>{const r=B();if(t.ctrlKey&&"Enter"===t.key){t.preventDefault();const n=fe(`#${h.pW}_run_stage`,e);n&&!r.isGenerating&&r.character&&n.click()}"Escape"===t.key&&r.isGenerating&&(t.preventDefault(),function(){const e=D();(null==e?void 0:e.abortController)&&(e.abortController.abort(),e.abortController=null,e.isGenerating=!1)}())};document.addEventListener("keydown",i),un.push(()=>document.removeEventListener("keydown",i))}(dn),h.Rm.debug("Popup opened")):h.Rm.error("Popup element not found")})}var mn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,s)}c((n=n.apply(e,t||[])).next())})};function gn(){return mn(this,void 0,void 0,function*(){const e=document.getElementById("extensions_settings");if(!e)return void h.Rm.error("Extensions container not found");if(document.getElementById(`${h.pW}_panel`))return void h.Rm.debug("Panel already initialized, skipping");e.insertAdjacentHTML("beforeend",function(){const e=(0,y.getSettings)();return`\n<div id="${h.pW}_panel">\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b><i class="fa-solid fa-wand-magic-sparkles"></i> ${h.hi}</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n            <div class="cr-panel-content">\n                <p class="cr-panel-desc">\n                    AI-powered character card scoring, rewriting, and analysis.\n                </p>\n                <button id="${h.pW}_open_btn" class="menu_button cr-panel-launch" type="button">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    <span>Open Card Refinery</span>\n                </button>\n                <div class="cr-panel-footer">\n                    <label class="cr-panel-checkbox">\n                        <input type="checkbox" id="${h.pW}_debug_mode" ${e.debugMode?"checked":""}/>\n                        <span>Debug mode</span>\n                    </label>\n                    <span class="cr-panel-version">v${h.xv}</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>`}());const t=document.getElementById(`${h.pW}_open_btn`);null==t||t.addEventListener("click",fn);const r=document.getElementById(`${h.pW}_debug_mode`);null==r||r.addEventListener("change",()=>{(0,y.getSettings)().debugMode=r.checked,(0,h.pM)(r.checked),(0,y.save)(),h.oR.info(r.checked?"Debug logging enabled":"Debug logging disabled")}),h.Rm.debug("Panel initialized")})}function vn(){try{h.Rm.info(`${h.hi} v${h.xv} initializing...`);const e=(0,y.getSettings)();(0,h.pM)(e.debugMode),gn(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),r=(t,r)=>{e.on(t,r),hn.push({type:t,handler:r})};r(t.CHARACTER_EDITED,()=>{h.Rm.debug("Character edited, resetting Fuse index and refreshing popup"),Ce(),function(){const e=D();if(!(null==e?void 0:e.character))return;const t=(SillyTavern.getContext().characters||[]).find(t=>{var r;return t.avatar===(null===(r=e.character)||void 0===r?void 0:r.avatar)});t&&(e.character=t)}(),Se()}),r(t.CHARACTER_DELETED,()=>{h.Rm.debug("Character deleted, resetting Fuse index"),Ce()}),r(t.CHATCOMPLETION_SOURCE_CHANGED,()=>{h.Rm.debug("Chat completion source changed")}),r(t.CHATCOMPLETION_MODEL_CHANGED,()=>{h.Rm.debug("Chat completion model changed")}),h.Rm.debug("Event listeners registered")}(),h.Rm.info(`${h.hi} v${h.xv} loaded`)}catch(e){h.Rm.error("Extension initialization failed",e),h.oR.error(`${h.hi} failed to initialize. Check console.`)}}(0,h.pM)(h.Oi);const hn=[];function yn(){!function(){const{eventSource:e}=SillyTavern.getContext();for(const{type:t,handler:r}of hn)e.off(t,r);hn.length=0,h.Rm.debug("Event listeners unregistered")}(),(0,y.clearCache)(),h.Rm.info("Extension cleaned up")}const{eventSource:bn,eventTypes:_n}=SillyTavern.getContext();bn.on(_n.APP_READY,vn);export{yn as cleanup,vn as init};export const log=h.Rm;