var t={56(t,e,n){t.exports=function(t){var e=n.nc;e&&t.setAttribute("nonce",e)}},72(t){var e=[];function n(t){for(var n=-1,r=0;r<e.length;r++)if(e[r].identifier===t){n=r;break}return n}function r(t,r){for(var i={},o=[],s=0;s<t.length;s++){var c=t[s],l=r.base?c[0]+r.base:c[0],d=i[l]||0,p="".concat(l," ").concat(d);i[l]=d+1;var u=n(p),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)e[u].references++,e[u].updater(f);else{var v=a(f,r);r.byIndex=s,e.splice(s,0,{identifier:p,updater:v,references:1})}o.push(p)}return o}function a(t,e){var n=e.domAPI(e);n.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;n.update(t=e)}else n.remove()}}t.exports=function(t,a){var i=r(t=t||[],a=a||{});return function(t){t=t||[];for(var o=0;o<i.length;o++){var s=n(i[o]);e[s].references--}for(var c=r(t,a),l=0;l<i.length;l++){var d=n(i[l]);0===e[d].references&&(e[d].updater(),e.splice(d,1))}i=c}}},113(t){t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}},179(t,e,n){n.r(e),n.d(e,{generate:()=>o,generateSimple:()=>s,generateStructured:()=>c,generateWithRetry:()=>l});var r=n(319),a=n(374),i=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function o(t){return i(this,void 0,void 0,function*(){var e,n,i,o,s,c;if(null===(e=t.signal)||void 0===e?void 0:e.aborted)return{success:!1,error:"Generation cancelled"};if(!(0,r.cW)()){return{success:!1,error:(0,r.Lq)().error||"API not connected. Check your connection settings."}}if(t.jsonSchema){const e=(0,a.i6)(t.jsonSchema);if(!e.valid)return{success:!1,error:`Invalid schema: ${e.error}`}}try{if(null===(n=t.signal)||void 0===n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};const e=SillyTavern.getContext(),r=yield e.generateRaw({prompt:t.prompt,systemPrompt:null!==(i=t.systemPrompt)&&void 0!==i?i:"",responseLength:null!==(o=t.responseLength)&&void 0!==o?o:null,jsonSchema:null!==(s=t.jsonSchema)&&void 0!==s?s:null});if(null===(c=t.signal)||void 0===c?void 0:c.aborted)return{success:!1,error:"Generation cancelled"};const l=function(t){if("string"==typeof t)return t;if(null==t)return"";if("object"==typeof t){const e=t;return"string"==typeof e.text?e.text:"string"==typeof e.content?e.content:JSON.stringify(t)}return String(t)}(r);if(!l||""===l.trim())return{success:!1,error:"Empty response from API"};if(t.jsonSchema){const e=(0,a.Ki)(l,t.jsonSchema);return e?{success:!0,response:l,parsed:e.data,isStructured:!0}:{success:!0,response:l,isStructured:!1}}return{success:!0,response:l,isStructured:!1}}catch(t){return function(t){if("AbortError"===t.name)return{success:!1,error:"Generation cancelled"};const e=t instanceof Error?t.message:String(t),n=e.toLowerCase();if(n.includes("401")||n.includes("unauthorized")||n.includes("invalid_api_key")||n.includes("api key"))return{success:!1,error:"API authentication failed. Check your API key."};if(n.includes("429")||n.includes("rate limit"))return{success:!1,error:"Rate limited. Please wait and try again."};if(n.includes("500")||n.includes("502")||n.includes("503"))return{success:!1,error:"API server error. The service may be temporarily unavailable."};if(n.includes("timeout")||n.includes("etimedout"))return{success:!1,error:"Request timed out. Check your connection or try a different model."};if(n.includes("network")||n.includes("econnrefused")||n.includes("fetch failed"))return{success:!1,error:"Network error. Check your internet connection."};if(n.includes("context")||n.includes("too long")||n.includes("maximum context")||n.includes("token"))return{success:!1,error:"Prompt too long for model context. Try reducing input length."};if(n.includes("model")&&(n.includes("not found")||n.includes("does not exist")))return{success:!1,error:"Model not found. It may have been deprecated or renamed."};if(n.includes("content")&&(n.includes("filter")||n.includes("policy")))return{success:!1,error:"Content was filtered by the API. Try rephrasing your prompt."};return{success:!1,error:e}}(t)}})}function s(t,e){return i(this,void 0,void 0,function*(){var n;const r=yield o({prompt:t,systemPrompt:e});return r.success&&null!==(n=r.response)&&void 0!==n?n:null})}function c(t,e,n){return i(this,void 0,void 0,function*(){const r=yield o({prompt:t,systemPrompt:n,jsonSchema:e});return r.success&&r.parsed?r.parsed:null})}function l(t){return i(this,arguments,void 0,function*(t,e=2,n=1e3){var r,a;let i={success:!1,error:"No attempts made"};for(let s=0;s<=e;s++){if(null===(r=t.signal)||void 0===r?void 0:r.aborted)return{success:!1,error:"Generation cancelled"};if(i=yield o(t),i.success)return i;const c=(null===(a=i.error)||void 0===a?void 0:a.toLowerCase())||"";if(c.includes("cancelled")||c.includes("authentication")||c.includes("api key")||c.includes("content")||c.includes("too long"))return i;s<e&&(yield new Promise(t=>setTimeout(t,n)))}return i})}},314(t){t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var n="",r=void 0!==e[5];return e[4]&&(n+="@supports (".concat(e[4],") {")),e[2]&&(n+="@media ".concat(e[2]," {")),r&&(n+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),n+=t(e),r&&(n+="}"),e[2]&&(n+="}"),e[4]&&(n+="}"),n}).join("")},e.i=function(t,n,r,a,i){"string"==typeof t&&(t=[[null,t,void 0]]);var o={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(o[c]=!0)}for(var l=0;l<t.length;l++){var d=[].concat(t[l]);r&&o[d[0]]||(void 0!==i&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=i),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),e.push(d))}},e}},319(t,e,n){n.d(e,{IF:()=>f,U8:()=>m,Oi:()=>o,hi:()=>a,Nf:()=>g,pW:()=>r,v7:()=>l,$G:()=>s,an:()=>d,iu:()=>u,BA:()=>p,d5:()=>v,F:()=>c,xv:()=>i,UH:()=>M,Lq:()=>O,We:()=>T,NR:()=>I,gg:()=>D,mi:()=>C,cW:()=>E,Ar:()=>w,wG:()=>_,Rm:()=>S,lY:()=>b,$n:()=>F,pM:()=>P,RG:()=>x,oR:()=>y});const r="SillyTavern-CardRefinery",a="CardRefinery",i="2.0.0",o=!0,s=1,c=2,l=1,d=["score","rewrite","analyze"],p={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},u={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},f=[{key:"description",label:"Description",path:"description"},{key:"personality",label:"Personality",path:"personality"},{key:"first_mes",label:"First Message",path:"first_mes"},{key:"scenario",label:"Scenario",path:"scenario"},{key:"mes_example",label:"Example Messages",path:"mes_example"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}],v={SESSIONS:`${r}_sessions`,SESSION_INDEX:`${r}_session_index`,STORAGE_META:`${r}_storage_meta`},m={SEARCH:150,SAVE:1e3,VALIDATE:300},g=50;var h=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};const b={confirm(t,e){return h(this,void 0,void 0,function*(){return!0===(yield SillyTavern.getContext().Popup.show.confirm(t,e))})},input(t,e,n){return h(this,void 0,void 0,function*(){return SillyTavern.getContext().Popup.show.input(t,e,n)})},alert(t,e){return h(this,void 0,void 0,function*(){yield SillyTavern.getContext().Popup.show.text(t,e)})}},y={success(t,e){toastr.success(t,e)},error(t,e){toastr.error(t,e)},warning(t,e){toastr.warning(t,e)},info(t,e){toastr.info(t,e)}};const _={show(){const t=SillyTavern.getContext();"function"==typeof t.showLoader&&t.showLoader()},hide(){const t=SillyTavern.getContext();"function"==typeof t.hideLoader&&t.hideLoader()},wrap(t){return h(this,void 0,void 0,function*(){_.show();try{return yield t()}finally{_.hide()}})}};function x(t,e){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.setItem(t,e),!0}catch(e){return console.error(`[storeLargeData] Failed to store ${t}:`,e),!1}})}function w(t){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.getItem(t)}catch(e){return console.error(`[loadLargeData] Failed to load ${t}:`,e),null}})}const $=[];let k=!1;const S={debug(t,e){R("debug",t,e),k&&(void 0!==e?console.debug(`[${r}]`,t,e):console.debug(`[${r}]`,t))},info(t,e){R("info",t,e),void 0!==e?console.log(`[${r}]`,t,e):console.log(`[${r}]`,t)},warn(t,e){R("warn",t,e),void 0!==e?console.warn(`[${r}]`,t,e):console.warn(`[${r}]`,t)},error(t,e){R("error",t,e),void 0!==e?console.error(`[${r}]`,t,e):console.error(`[${r}]`,t)}};function P(t){k=t,S.info("Debug mode "+(t?"enabled":"disabled"))}function R(t,e,n){$.unshift({timestamp:new Date,level:t,message:e,data:n}),$.length>100&&$.pop()}function C(){const t=SillyTavern.getContext().ConnectionManagerRequestService;return!(!t||"function"!=typeof t.sendRequest)}function T(){const t=SillyTavern.getContext().ConnectionManagerRequestService;if(!t||"function"!=typeof t.getSupportedProfiles)return[];try{return(t.getSupportedProfiles()||[]).map(e=>{const n=function(t,e){try{const n=(e.getSupportedProfiles()||[]).find(e=>e.id===t);return n?{valid:!0,error:null}:{valid:!1,error:"Profile not found"}}catch(t){return{valid:!1,error:"Failed to validate profile"}}}(e.id,t);return{id:e.id,name:e.name,model:e.model,api:e.api,mode:e.mode,presetName:e.presetName,isSupported:n.valid,validationError:n.error}})}catch(t){return S.error("Failed to get profiles",t),[]}}function z(t){return T().find(e=>e.id===t)||null}function O(t){const e=SillyTavern.getContext();return t?function(t){const e=z(t);if(!e)return{mode:"profile",displayName:"Unknown Profile",source:"unknown",model:"unknown",modelDisplay:"Unknown",apiType:"cc",contextSize:8192,maxOutput:4096,isReady:!1,statusText:"Profile Not Found",error:`Profile ${t} not found`};return{mode:"profile",displayName:e.name,source:e.api,model:e.model,modelDisplay:A(e.model),apiType:e.mode,contextSize:8192,maxOutput:4096,isReady:e.isSupported,statusText:e.isSupported?`${e.name} Ready`:"Not Supported",error:e.validationError}}(t):function(t){var e,n,r,a,i;const o=null!==(e=t.mainApi)&&void 0!==e?e:"unknown",s=t.chatCompletionSettings,c=t.textCompletionSettings,l="textgenerationwebui"!==o&&"kobold"!==o,d=l?"cc":"tc";let p="unknown";l&&"function"==typeof t.getChatCompletionModel?p=t.getChatCompletionModel()||"unknown":l||(p=t.onlineStatus||"unknown");let u=o;l&&(null==s?void 0:s.chat_completion_source)&&(u=s.chat_completion_source);const f=null!==(r=null!==(n=null==s?void 0:s.openai_max_context)&&void 0!==n?n:t.maxContext)&&void 0!==r?r:8192,v=l?null!==(a=null==s?void 0:s.openai_max_tokens)&&void 0!==a?a:4096:null!==(i=null==c?void 0:c.max_length)&&void 0!==i?i:2048,{isReady:m,error:g}=function(t){var e;const n=t.chatCompletionSettings;if(null==n?void 0:n.bypass_status_check)return{isReady:!0,error:null};const r=(null!==(e=t.onlineStatus)&&void 0!==e?e:"").toLowerCase();if(!r)return{isReady:!1,error:"No API connection"};if(["error","fail","invalid","unauthorized","missing"].some(t=>r.includes(t)))return{isReady:!1,error:`API error: ${r}`};if(["valid","connected","ok","ready","key","saved"].some(t=>r.includes(t)))return{isReady:!0,error:null};if("function"!=typeof t.generateRaw)return{isReady:!1,error:"Generation not available (ST version?)"};return{isReady:!0,error:null}}(t);return{mode:"current",displayName:"Current Settings",source:u,model:p,modelDisplay:A(p),apiType:d,contextSize:f,maxOutput:v,isReady:m,statusText:m?`${A(p)} Ready`:"Not Ready",error:g}}(e)}function E(t){return O(t).isReady}function A(t){if(!t||"unknown"===t)return"Unknown";const e=t.replace(/^gpt-/,"GPT-").replace(/^claude-/,"Claude-").replace(/^gemini-/,"Gemini-").replace(/-\d{4}-\d{2}-\d{2}$/,"").replace(/-preview$/,"");return e.length>30?e.slice(0,27)+"...":e}var j=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};const W=new Map;new Map;function N(t){let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}const n=t.slice(0,16),r=t.slice(-16);return`${e}_${t.length}_${n}_${r}`}function I(t){return j(this,void 0,void 0,function*(){const e=t.trim();if(!e)return 0;const n=N(e),r=W.get(n);if(void 0!==r)return r;const a=SillyTavern.getContext();if("function"!=typeof a.getTokenCountAsync)return null;try{const t=yield a.getTokenCountAsync(e);return L(n,t),t}catch(t){return S.error("Token count failed",t),null}})}function D(t){return j(this,void 0,void 0,function*(){const e=t.map(t=>t.text),n=yield function(t){return j(this,void 0,void 0,function*(){const e=new Map,n=[];for(const r of t){const t=r.trim();if(!t){e.set(r,0);continue}const a=N(t),i=W.get(a);void 0!==i?e.set(r,i):n.push({text:t,key:a,original:r})}if(n.length>0){const t=SillyTavern.getContext();if("function"!=typeof t.getTokenCountAsync){for(const{original:t}of n)e.set(t,null);return e}const r=n.map(e=>j(this,[e],void 0,function*({text:e,key:n,original:r}){try{const a=yield t.getTokenCountAsync(e);return L(n,a),{original:r,tokens:a}}catch(t){return{original:r,tokens:null}}})),a=yield Promise.all(r);for(const{original:t,tokens:n}of a)e.set(t,n)}return e})}(e);return t.map(t=>{var e;return{key:t.key,tokens:null!==(e=n.get(t.text))&&void 0!==e?e:null}})})}function L(t,e){if(W.size>=500){const t=W.keys().next().value;t&&W.delete(t)}W.set(t,e)}function M(t,e=["user","persona","original","input"]){if(!t)return t;let n=t;for(const t of e){const e=new RegExp(`\\{\\{(${t})\\}\\}`,"gi");n=n.replace(e,"{{​$1​}}")}return n}function F(t,e){return t&&e?t.replace(/\{\{char\}\}/gi,e):t}},374(t,e,n){n.d(e,{Ki:()=>S,i6:()=>h,jf:()=>k,nr:()=>P});var r=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};const a=8,i=100,o=10,s=100,c=500,l=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],d=[0,1],p=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],u=["minLength","maxLength"],f=["maxItems","uniqueItems","contains","minContains","maxContains"],v=["minProperties","maxProperties","propertyNames","patternProperties"],m=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],g=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function h(t){var e;if("string"==typeof t&&!t.trim())return{valid:!0,schema:void 0};let n;if("string"==typeof t)try{n=JSON.parse(t)}catch(t){const e=t instanceof Error?t.message:"Invalid JSON",n=e.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${n?` (character ${n[1]})`:""}: ${e}`}}else n=t;if("object"!=typeof n||null===n||Array.isArray(n))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(n)?"array":typeof n)};const r=n;if("string"!=typeof r.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!r.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r.name))return{valid:!1,error:`'name' must be a valid identifier (got '${r.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof r.value||null===r.value||Array.isArray(r.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const a=r.value;if("string"!=typeof a.type&&!a.anyOf&&!a.allOf&&!a.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==r.strict&&"boolean"!=typeof r.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const o={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(a.$defs&&"object"==typeof a.$defs?(o.defs=a.$defs,o.stats.defCount=Object.keys(o.defs).length):a.definitions&&"object"==typeof a.definitions&&(o.defs=a.definitions,o.stats.defCount=Object.keys(o.defs).length),o.stats.defCount>i&&o.errors.push(`Too many definitions: ${o.stats.defCount} (limit: ${i})`),b(a,"value",o),o.stats.optionalFieldCount>0){const t=o.stats.optionalFieldCount,e=o.stats.totalAnyOfVariants+2*t;t>10&&o.warnings.push(`${t} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),e>50&&o.warnings.push(`High anyOf count (~${e} including implicit nullables). May cause slow schema compilation or errors.`)}if(o.errors.length>0)return{valid:!1,error:o.errors.join("\n"),warnings:o.warnings.length>0?o.warnings:void 0};const s={name:r.name,strict:null===(e=r.strict)||void 0===e||e,value:a};return o.info.push(`Schema stats: ${o.stats.propertyCount} properties, ${o.stats.defCount} definitions, ${o.stats.anyOfCount} anyOf blocks, ${o.stats.optionalFieldCount} optional fields, max depth ${o.stats.maxDepth}`),{valid:!0,schema:s,warnings:o.warnings.length>0?o.warnings:void 0,info:o.info.length>0?o.info:void 0}}function b(t,e,n){if(n.currentDepth++,n.stats.maxDepth=Math.max(n.stats.maxDepth,n.currentDepth),n.currentDepth>o)return n.errors.push(`${e}: Exceeds maximum nesting depth of ${o}`),void n.currentDepth--;for(const r of m)void 0!==t[r]&&n.errors.push(`${e}: '${r}' is not supported`);for(const r of p)void 0!==t[r]&&n.warnings.push(`${e}: '${r}' will be ignored (not supported)`);for(const r of u)void 0!==t[r]&&n.warnings.push(`${e}: '${r}' will be ignored (not supported)`);for(const r of f)void 0!==t[r]&&n.warnings.push(`${e}: '${r}' will be ignored (not supported)`);for(const r of v)void 0!==t[r]&&n.warnings.push(`${e}: '${r}' will be ignored (not supported)`);if(t.$ref&&"string"==typeof t.$ref)return function(t,e,n){if(t.startsWith("http://")||t.startsWith("https://"))return void n.errors.push(`${e}: External $ref not supported ('${t}')`);if(n.seenRefs.has(t))return void n.info.push(`${e}: Circular reference to '${t}'`);n.seenRefs.add(t);const r=t.replace(/^#\/(\$defs|definitions)\//,"");n.defs[r]||n.errors.push(`${e}: Reference '${t}' not found in definitions`)}(t.$ref,e,n),void n.currentDepth--;const r=Array.isArray(t.type)?t.type:[t.type];for(const a of r)switch(a){case"object":y(t,e,n);break;case"array":_(t,e,n);break;case"string":x(t,e,n);break;case"number":case"integer":case"boolean":case"null":break;default:!a||t.anyOf||t.allOf||n.warnings.push(`${e}: Unknown type '${a}'`)}t.anyOf&&Array.isArray(t.anyOf)&&function(t,e,n){n.stats.anyOfCount++,n.stats.totalAnyOfVariants+=t.length,t.length>a&&n.errors.push(`${e}: anyOf has ${t.length} variants (max: ${a})`);if(0===t.length)return void n.errors.push(`${e}: anyOf cannot be empty`);t.forEach((t,r)=>{t&&"object"==typeof t&&b(t,`${e}.anyOf[${r}]`,n)})}(t.anyOf,e,n),t.allOf&&Array.isArray(t.allOf)&&function(t,e,n){if(0===t.length)return void n.errors.push(`${e}: allOf cannot be empty`);t.forEach((t,r)=>{if(t&&"object"==typeof t){const a=t;a.$ref&&n.errors.push(`${e}.allOf[${r}]: allOf with $ref not supported`),b(a,`${e}.allOf[${r}]`,n)}})}(t.allOf,e,n),t.enum&&Array.isArray(t.enum)&&function(t,e,n){if(n.stats.enumCount++,0===t.length)return void n.errors.push(`${e}: enum cannot be empty`);t.length>c&&n.warnings.push(`${e}: enum has ${t.length} values (may be slow)`);for(let r=0;r<t.length;r++){const a=t[r],i=typeof a;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==a){n.errors.push(`${e}.enum[${r}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const r=new Set;for(const a of t){const t=JSON.stringify(a);if(r.has(t)){n.warnings.push(`${e}: Duplicate value in enum: ${t}`);break}r.add(t)}}(t.enum,e,n),void 0!==t.const&&function(t,e,n){const r=typeof t;"string"!==r&&"number"!==r&&"boolean"!==r&&null!==t&&n.errors.push(`${e}: const must be string, number, boolean, or null (got ${r})`)}(t.const,e,n),n.currentDepth--}function y(t,e,n){if(!1!==t.additionalProperties&&n.warnings.push(`${e}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),t.properties&&"object"==typeof t.properties){const r=t.properties,a=Object.keys(r).length;n.stats.propertyCount+=a,a>s&&n.warnings.push(`${e}: ${a} properties (may be slow, consider splitting)`);const i=t.required||[];for(const[t,a]of Object.entries(r))i.includes(t)||n.stats.optionalFieldCount++,a&&"object"==typeof a&&b(a,`${e}.${t}`,n)}}function _(t,e,n){if(void 0!==t.minItems){d.includes(t.minItems)||n.warnings.push(`${e}: 'minItems: ${t.minItems}' not supported (only 0 or 1 allowed)`)}t.items&&("object"!=typeof t.items||Array.isArray(t.items)?Array.isArray(t.items)&&t.items.forEach((t,r)=>{t&&"object"==typeof t&&b(t,`${e}.items[${r}]`,n)}):b(t.items,`${e}.items`,n)),t.prefixItems&&Array.isArray(t.prefixItems)&&t.prefixItems.forEach((t,r)=>{t&&"object"==typeof t&&b(t,`${e}.prefixItems[${r}]`,n)})}function x(t,e,n){if(t.format&&"string"==typeof t.format){const r=l;r.includes(t.format)||n.warnings.push(`${e}: format '${t.format}' may not be supported. Supported: ${r.join(", ")}`)}t.pattern&&"string"==typeof t.pattern&&function(t,e,n){for(const{pattern:r,name:a}of g)r.test(t)&&n.errors.push(`${e}: Regex pattern uses unsupported feature: ${a}`);try{new RegExp(t)}catch(t){const r=t instanceof Error?t.message:"Invalid regex";n.errors.push(`${e}: Invalid regex pattern: ${r}`)}const r=/\{(\d+),(\d+)\}/g;let a;for(;null!==(a=r.exec(t));){const t=parseInt(a[1],10),r=parseInt(a[2],10);r-t>100&&n.warnings.push(`${e}: Large quantifier range {${t},${r}} may cause issues`)}}(t.pattern,e,n)}function w(t){const e=structuredClone(t);return void 0===e.strict&&(e.strict=!0),$(e.value),e}function $(t){if("object"===t.type&&(t.additionalProperties=!1,t.properties&&"object"==typeof t.properties))for(const e of Object.values(t.properties))e&&"object"==typeof e&&$(e);"array"===t.type&&t.items&&"object"==typeof t.items&&(Array.isArray(t.items)?t.items.forEach(t=>{t&&"object"==typeof t&&$(t)}):$(t.items)),t.anyOf&&Array.isArray(t.anyOf)&&t.anyOf.forEach(t=>{t&&"object"==typeof t&&$(t)}),t.allOf&&Array.isArray(t.allOf)&&t.allOf.forEach(t=>{t&&"object"==typeof t&&$(t)});const e=[];for(const n of p)void 0!==t[n]&&(e.push(`${n}: ${t[n]}`),delete t[n]);for(const n of u)void 0!==t[n]&&(e.push(`${n}: ${t[n]}`),delete t[n]);for(const n of f)void 0!==t[n]&&(e.push(`${n}: ${t[n]}`),delete t[n]);if(void 0!==t.minItems&&null!==t.minItems){const n=t.minItems;0!==n&&1!==n&&(e.push(`minItems: ${n}`),t.minItems=n>0?1:0)}if(e.length>0){const n=`[Constraints: ${e.join(", ")}]`;t.description?t.description=`${t.description} ${n}`:t.description=n}}function k(t){return t?JSON.stringify(t,null,2):""}function S(t,e){let n;try{n=JSON.parse(t)}catch(e){const r=t.match(/```(?:json)?\s*([\s\S]*?)```/);if(!r)return null;try{n=JSON.parse(r[1].trim())}catch(t){return null}}const r=[];if(e&&e.value.required&&Array.isArray(e.value.required)){const t=e.value.required.filter(t=>!(t in n));t.length>0&&r.push(`Missing required fields: ${t.join(", ")}`)}return{data:n,warnings:r}}function P(t){return r(this,void 0,void 0,function*(){var e;const{generateSimple:r}=yield Promise.resolve().then(n.bind(n,179));if(!t.trim())return{success:!1,error:"Please describe what you want in the schema"};try{const n=yield r(`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${t}`,"You are a JSON Schema expert. Output only valid JSON, nothing else.");if(!n)return{success:!1,error:"Generation failed - no response received"};let a=n.trim();a.startsWith("```")&&(a=a.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const i=h(a);if(!i.valid)return{success:!1,error:`Generated schema is invalid: ${i.error}`,schema:a};if(null===(e=i.warnings)||void 0===e?void 0:e.length){const t=w(i.schema);return{success:!0,schema:JSON.stringify(t,null,2)}}return{success:!0,schema:JSON.stringify(i.schema,null,2)}}catch(t){return{success:!1,error:`Generation failed: ${t.message}`}}})}},540(t){t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},601(t){t.exports=function(t){return t[1]}},659(t){var e={};t.exports=function(t,n){var r=function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}e[t]=n}return e[t]}(t);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},691(t,e,n){n.d(e,{tB:()=>o,lp:()=>i,WC:()=>s,L$:()=>c,a$:()=>l,_j:()=>a,O0:()=>d,Gv:()=>p,$q:()=>G,QO:()=>Y,lo:()=>N,jT:()=>I,wI:()=>F,mW:()=>M,SK:()=>_,Bx:()=>q,bA:()=>U,mt:()=>u,hu:()=>h,sR:()=>y,wM:()=>W,PL:()=>x,Tx:()=>v,UN:()=>f,DV:()=>B,aQ:()=>J,RC:()=>b,Fc:()=>H,iO:()=>V,G1:()=>Q,tH:()=>K});var r=n(319);const a={promptPresetId:null,customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},i="You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",o="You are refining a character card based on analysis feedback. Address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",s=[{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided.\n\nFor each field:\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Suggestions** - Concrete changes\n\nThen provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback only."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address weaknesses while preserving strengths.\n\nGuidelines:\n- Maintain core personality and unique traits\n- Improve weak areas from feedback\n- Keep similar length unless noted\n- Preserve distinctive voice/style\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\n**ACCEPT** (ready), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"}],c=[{id:"builtin_schema_score",name:"Score Schema",stages:["score"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score Schema",stages:["score"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Analyze Schema",stages:["analyze"],isBuiltin:!0,version:r.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issues:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulScore","soulAssessment","verdict","issues","recommendations"]}}}],l={version:r.$G,baseSystemPrompt:i,userSystemPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},baseRefinementPrompt:o,userRefinementPrompt:"",stageDefaults:{score:Object.assign(Object.assign({},a),{promptPresetId:"builtin_score_default"}),rewrite:Object.assign(Object.assign({},a),{promptPresetId:"builtin_rewrite_default"}),analyze:Object.assign(Object.assign({},a),{promptPresetId:"builtin_analyze_default"})},promptPresets:[...s],schemaPresets:[...c],generationMode:"current",profileId:null,maxTokensOverride:null,debugMode:!1},d={version:r.F,lastMigration:Date.now()};function p(t,e,n){return{id:t,characterId:e,characterName:n,createdAt:Date.now(),updatedAt:Date.now(),stageFields:{base:{},linked:!0,overrides:{}},originalData:{},configs:{score:Object.assign({},a),rewrite:Object.assign({},a),analyze:Object.assign({},a)},history:[],iterationCount:0,status:"active",version:r.F}}function u(){var t;const e=SillyTavern.getContext(),{lodash:n}=SillyTavern.libs,a=e.extensionSettings;if(!a[r.pW])return a[r.pW]=n.cloneDeep(l),f(),a[r.pW];const i=a[r.pW],o=null!==(t=i.version)&&void 0!==t?t:0;if(o<r.$G){!function(t,e){for(let n=e+1;n<=r.$G;n++){const e=m[n];e&&e(t)}}(i,o);const t=function(t){const{lodash:e}=SillyTavern.libs,n=t.promptPresets?[...t.promptPresets]:[],r=t.schemaPresets?[...t.schemaPresets]:[],a=e.merge(structuredClone(l),t);return a.promptPresets=n.length?n:[...l.promptPresets],a.schemaPresets=r.length?r:[...l.schemaPresets],a}(i);return t.version=r.$G,g(t),a[r.pW]=t,f(),t}const s=i;s.promptPresets||(s.promptPresets=[]),s.schemaPresets||(s.schemaPresets=[]);return g(s)&&f(),s}function f(){SillyTavern.getContext().saveSettingsDebounced()}function v(){const{lodash:t}=SillyTavern.libs,e=SillyTavern.getContext().extensionSettings;return e[r.pW]=t.cloneDeep(l),f(),e[r.pW]}const m={};function g(t){const{lodash:e}=SillyTavern.libs;let n=!1;for(const r of s){const a=t.promptPresets.find(t=>t.id===r.id);a?a.version<r.version&&(Object.assign(a,e.cloneDeep(r)),n=!0):(t.promptPresets.push(e.cloneDeep(r)),n=!0)}for(const r of c){const a=t.schemaPresets.find(t=>t.id===r.id);a?a.version<r.version&&(Object.assign(a,e.cloneDeep(r)),n=!0):(t.schemaPresets.push(e.cloneDeep(r)),n=!0)}return n}function h(t){const{lodash:e}=SillyTavern.libs,n=u();return e.cloneDeep(n.stageDefaults[t])}function b(t,e){const{lodash:n}=SillyTavern.libs;u().stageDefaults[t]=n.cloneDeep(e),f()}function y(t){const e=u();return[e.baseSystemPrompt,e.userSystemPrompt,e.stageSystemPrompts[t]].filter(t=>t.trim()).join("\n\n")}function _(){const t=u();return[t.baseRefinementPrompt,t.userRefinementPrompt].filter(t=>t.trim()).join("\n\n")}const x=new class{constructor(){this.listeners=new Set,this.getPromptPresets=t=>{const e=u();return this.applyFilter(e.promptPresets,t)},this.getSchemaPresets=t=>{const e=u();return this.applyFilter(e.schemaPresets,t)},this.getPromptPreset=t=>{var e;return null!==(e=u().promptPresets.find(e=>e.id===t))&&void 0!==e?e:null},this.getSchemaPreset=t=>{var e;return null!==(e=u().schemaPresets.find(e=>e.id===t))&&void 0!==e?e:null},this.getPresetsForStage=(t,e)=>"prompt"===t?this.getPromptPresets({stage:e}):this.getSchemaPresets({stage:e}),this.exists=(t,e)=>"prompt"===t?null!==this.getPromptPreset(e):null!==this.getSchemaPreset(e),this.isBuiltin=(t,e)=>{var n;const r="prompt"===t?this.getPromptPreset(e):this.getSchemaPreset(e);return null!==(n=null==r?void 0:r.isBuiltin)&&void 0!==n&&n},this.registerPromptPreset=t=>{const e=u(),n=Object.assign(Object.assign({},t),{id:crypto.randomUUID(),isBuiltin:!1,version:r.v7,createdAt:Date.now(),updatedAt:Date.now()});return e.promptPresets.push(n),f(),this.emit({type:"add",presetType:"prompt",preset:n}),n},this.registerSchemaPreset=t=>{const e=u(),n=Object.assign(Object.assign({},t),{id:crypto.randomUUID(),isBuiltin:!1,version:r.v7,createdAt:Date.now(),updatedAt:Date.now()});return e.schemaPresets.push(n),f(),this.emit({type:"add",presetType:"schema",preset:n}),n},this.updatePromptPreset=(t,e)=>{const n=u().promptPresets.find(e=>e.id===t);if(!n||n.isBuiltin)return!1;const r=Object.assign({},n);return Object.assign(n,e,{updatedAt:Date.now()}),f(),this.emit({type:"update",presetType:"prompt",preset:n,previousValue:r}),!0},this.updateSchemaPreset=(t,e)=>{const n=u().schemaPresets.find(e=>e.id===t);if(!n||n.isBuiltin)return!1;const r=Object.assign({},n);return Object.assign(n,e,{updatedAt:Date.now()}),f(),this.emit({type:"update",presetType:"schema",preset:n,previousValue:r}),!0},this.deletePromptPreset=t=>{const e=u(),n=e.promptPresets.findIndex(e=>e.id===t&&!e.isBuiltin);if(-1===n)return!1;const[r]=e.promptPresets.splice(n,1);return f(),this.emit({type:"delete",presetType:"prompt",preset:r}),!0},this.deleteSchemaPreset=t=>{const e=u(),n=e.schemaPresets.findIndex(e=>e.id===t&&!e.isBuiltin);if(-1===n)return!1;const[r]=e.schemaPresets.splice(n,1);return f(),this.emit({type:"delete",presetType:"schema",preset:r}),!0},this.duplicatePromptPreset=(t,e)=>{const n=this.getPromptPreset(t);if(!n)return null;const r=e||`${n.name} (Copy)`;return this.registerPromptPreset({name:r,stages:[...n.stages],prompt:n.prompt})},this.duplicateSchemaPreset=(t,e)=>{const n=this.getSchemaPreset(t);if(!n)return null;const{lodash:r}=SillyTavern.libs,a=e||`${n.name} (Copy)`;return this.registerSchemaPreset({name:a,stages:[...n.stages],schema:r.cloneDeep(n.schema)})},this.subscribe=t=>(this.listeners.add(t),()=>this.listeners.delete(t)),this.isNameUnique=(t,e,n)=>!("prompt"===t?this.getPromptPresets():this.getSchemaPresets()).some(t=>t.name.toLowerCase()===e.toLowerCase()&&t.id!==n),this.generateUniqueName=(t,e)=>{let n=e,r=1;for(;!this.isNameUnique(t,n);)n=`${e} (${r})`,r++;return n},this.getDisplayName=(t,e)=>{if(!e)return"Custom";const n="prompt"===t?this.getPromptPreset(e):this.getSchemaPreset(e);return n?n.isBuiltin?`${n.name} (builtin)`:n.name:"Unknown"}}applyFilter(t,e){return e?t.filter(t=>{if(e.stage){if(!(0===t.stages.length||t.stages.includes(e.stage)))return!1}return!(e.builtinOnly&&!t.isBuiltin)&&(!e.userOnly||!t.isBuiltin)}):t}emit(t){for(const e of this.listeners)try{e(t)}catch(t){console.error("[PresetRegistry] Listener error:",t)}}},{getPromptPresets:w,getSchemaPresets:$,getPromptPreset:k,getSchemaPreset:S,getPresetsForStage:P,registerPromptPreset:R,registerSchemaPreset:C,updatePromptPreset:T,updateSchemaPreset:z,deletePromptPreset:O,deleteSchemaPreset:E,duplicatePromptPreset:A,duplicateSchemaPreset:j,isNameUnique:W,generateUniqueName:N,getDisplayName:I,subscribe:D}=x;var L=n(374);function M(t){return w({stage:t})}function F(t){return k(t)}function B(t){return R(t)}function H(t,e){return T(t,e)}function G(t){return O(t)}function U(t){return $({stage:t})}function q(t){return S(t)}function J(t){return C(t)}function V(t,e){return z(t,e)}function Y(t){return E(t)}function Q(t){var e,n;const r=[],a=[];return(null===(e=t.name)||void 0===e?void 0:e.trim())?t.name.length>100&&r.push("Name must be 100 characters or less"):r.push("Name is required"),(null===(n=t.prompt)||void 0===n?void 0:n.trim())?t.prompt.length>5e4&&r.push("Prompt is too long (max 50,000 characters)"):r.push("Prompt is required"),t.prompt&&/\{\{user\}\}/i.test(t.prompt)&&a.push("{{user}} is not replaced - user persona is not relevant to card analysis"),{valid:0===r.length,errors:r,warnings:a}}function K(t){var e;const n=[],r=[];if((null===(e=t.name)||void 0===e?void 0:e.trim())?t.name.length>100&&n.push("Name must be 100 characters or less"):n.push("Name is required"),t.schema){const e="string"==typeof t.schema?t.schema:JSON.stringify(t.schema),a=(0,L.i6)(e);a.valid||n.push(a.error||"Invalid schema"),a.warnings&&r.push(...a.warnings)}else n.push("Schema is required");return{valid:0===n.length,errors:n,warnings:r}}},737(t,e,n){n.d(e,{BASE_REFINEMENT_PROMPT:()=>r.tB,BASE_SYSTEM_PROMPT:()=>r.lp,BUILTIN_PROMPT_PRESETS:()=>r.WC,BUILTIN_SCHEMA_PRESETS:()=>r.L$,DEFAULT_SETTINGS:()=>r.a$,DEFAULT_STAGE_CONFIG:()=>r._j,DEFAULT_STORAGE_META:()=>r.O0,clearCache:()=>s,createDefaultSession:()=>r.Gv,createSession:()=>_,deleteAllSessionsForCharacter:()=>$,deletePromptPreset:()=>r.$q,deleteSchemaPreset:()=>r.QO,deleteSession:()=>w,generateUniquePresetName:()=>r.lo,getPresetDisplayName:()=>r.jT,getPromptPreset:()=>r.wI,getPromptPresetsForStage:()=>r.mW,getRefinementPrompt:()=>r.SK,getSchemaPreset:()=>r.Bx,getSchemaPresetsForStage:()=>r.bA,getSession:()=>y,getSessionCount:()=>S,getSessionsForCharacter:()=>b,getSettings:()=>r.mt,getStageDefaults:()=>r.hu,getSystemPrompt:()=>r.sR,isPresetNameUnique:()=>r.wM,presetRegistry:()=>r.PL,renameSession:()=>k,resetSettings:()=>r.Tx,save:()=>r.UN,savePromptPreset:()=>r.DV,saveSchemaPreset:()=>r.aQ,setStageDefaults:()=>r.RC,updatePromptPreset:()=>r.Fc,updateSchemaPreset:()=>r.iO,updateSession:()=>x,validatePromptPreset:()=>r.G1,validateSchemaPreset:()=>r.tH}),n.r(e);var r=n(691);let a=null,i=null,o=null;function s(){a=null,i=null,o=null}function c(){return a}function l(){return i}function d(t){o=t}var p=n(319),u=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function f(){return u(this,void 0,void 0,function*(){if(o)return o;const t=yield(0,p.Ar)(p.d5.STORAGE_META);if(!t){const t={version:p.F,lastMigration:Date.now()};return d(t),yield(0,p.RG)(p.d5.STORAGE_META,t),t}return t.version!==p.F&&(yield function(t){return u(this,void 0,void 0,function*(){var e;const n=null!==(e=t.version)&&void 0!==e?e:0;if(n<2){const t=yield(0,p.Ar)(p.d5.SESSIONS);if(t){let e=!1;for(const n of Object.values(t))if(!n.stageFields&&n.selectedFields){const t=n.selectedFields;n.stageFields={base:t,linked:!0,overrides:{}},delete n.selectedFields,e=!0}e&&(yield(0,p.RG)(p.d5.SESSIONS,t))}}t.version=p.F,t.lastMigration=Date.now(),yield(0,p.RG)(p.d5.STORAGE_META,t)})}(t)),d(t),t})}function v(){return u(this,void 0,void 0,function*(){const t=c();if(t)return t;yield f();const e=yield(0,p.Ar)(p.d5.SESSIONS),n=new Map(Object.entries(null!=e?e:{}));return function(t){a=t}(n),n})}function m(){return u(this,void 0,void 0,function*(){var t;const e=l();if(e)return e;yield f();const n=null!==(t=yield(0,p.Ar)(p.d5.SESSION_INDEX))&&void 0!==t?t:{};return i=n,n})}function g(){return u(this,void 0,void 0,function*(){const t=c();t&&(yield(0,p.RG)(p.d5.SESSIONS,Object.fromEntries(t)))})}function h(){return u(this,void 0,void 0,function*(){const t=l();t&&(yield(0,p.RG)(p.d5.SESSION_INDEX,t))})}function b(t){return u(this,void 0,void 0,function*(){var e;const n=yield v();return(null!==(e=(yield m())[t])&&void 0!==e?e:[]).map(t=>n.get(t)).filter(t=>void 0!==t)})}function y(t){return u(this,void 0,void 0,function*(){var e;return null!==(e=(yield v()).get(t))&&void 0!==e?e:null})}function _(t){return u(this,void 0,void 0,function*(){const{characterId:e,characterName:n,stageFields:a,originalData:i,configs:o}=t,s=yield v(),c=yield m(),l=SillyTavern.libs.lodash,d=(0,r.Gv)(crypto.randomUUID(),e,n);if(d.stageFields=l.cloneDeep(a),d.originalData=l.cloneDeep(i),d.configs=l.cloneDeep(o),s.set(d.id,d),c[e]||(c[e]=[]),c[e].unshift(d.id),c[e].length>p.Nf){const t=c[e].splice(p.Nf);for(const e of t)s.delete(e)}return yield g(),yield h(),d})}function x(t){return u(this,void 0,void 0,function*(){const e=yield v();t.updatedAt=Date.now(),e.set(t.id,t),yield g()})}function w(t){return u(this,void 0,void 0,function*(){const e=yield v(),n=yield m(),r=e.get(t);if(!r)return;e.delete(t);const a=n[r.characterId];if(a){const e=a.indexOf(t);-1!==e&&a.splice(e,1),0===a.length&&delete n[r.characterId]}yield g(),yield h()})}function $(t){return u(this,void 0,void 0,function*(){var e;const n=yield v(),r=yield m(),a=null!==(e=r[t])&&void 0!==e?e:[];for(const t of a)n.delete(t);delete r[t],yield g(),yield h()})}function k(t,e){return u(this,void 0,void 0,function*(){const n=yield y(t);n&&(n.name=e.trim()||void 0,yield x(n))})}function S(t){return u(this,void 0,void 0,function*(){var e,n;return null!==(n=null===(e=(yield m())[t])||void 0===e?void 0:e.length)&&void 0!==n?n:0})}},805(t,e,n){n.d(e,{A:()=>s});var r=n(601),a=n.n(r),i=n(314),o=n.n(i)()(a());o.push([t.id,'.ct-drawer,.ct-popup,.ct-settings-modal{--ct-bg:var(--SmartThemeBlurTintColor);--ct-bg-secondary:var(--black30a,rgba(0,0,0,.3));--ct-bg-tertiary:var(--black50a,rgba(0,0,0,.5));--ct-bg-elevated:color-mix(in srgb,var(--SmartThemeBlurTintColor) 90%,#fff 10%);--ct-text:var(--SmartThemeBodyColor);--ct-text-muted:color-mix(in srgb,var(--SmartThemeBodyColor) 70%,transparent);--ct-text-dim:color-mix(in srgb,var(--SmartThemeBodyColor) 50%,transparent);--ct-border:var(--SmartThemeBorderColor);--ct-border-muted:color-mix(in srgb,var(--SmartThemeBorderColor) 50%,transparent);--ct-accent:var(--SmartThemeQuoteColor);--ct-accent-hover:color-mix(in srgb,var(--SmartThemeQuoteColor) 80%,#fff);--ct-accent-muted:color-mix(in srgb,var(--SmartThemeQuoteColor) 30%,transparent);--ct-success:var(--okGreen70a,#4caf50);--ct-success-bg:color-mix(in srgb,var(--okGreen70a,#4caf50) 15%,transparent);--ct-warning:var(--golden,#ff9800);--ct-warning-bg:color-mix(in srgb,var(--golden,#ff9800) 15%,transparent);--ct-danger:var(--fullred,#f44336);--ct-danger-bg:color-mix(in srgb,var(--fullred,#f44336) 15%,transparent);--ct-space-1:0.25rem;--ct-space-2:0.5rem;--ct-space-3:0.75rem;--ct-space-4:1rem;--ct-space-5:1.25rem;--ct-space-6:1.5rem;--ct-space-8:2rem;--ct-space-12:3rem;--ct-font:var(--mainFontFamily,system-ui,-apple-system,sans-serif);--ct-font-mono:var(--monoFontFamily,"Consolas","Monaco",monospace);--ct-font-size:var(--mainFontSize,1rem);--ct-text-xs:calc(var(--ct-font-size) * 0.75);--ct-text-sm:calc(var(--ct-font-size) * 0.875);--ct-text-base:var(--ct-font-size);--ct-text-lg:calc(var(--ct-font-size) * 1.125);--ct-text-xl:calc(var(--ct-font-size) * 1.25);--ct-radius-sm:4px;--ct-radius:8px;--ct-radius-lg:12px;--ct-radius-pill:9999px;--ct-shadow-sm:0 1px 3px var(--black30a,rgba(0,0,0,.3));--ct-shadow:0 4px 12px var(--black30a,rgba(0,0,0,.3));--ct-shadow-lg:0 8px 24px var(--black50a,rgba(0,0,0,.5));--ct-transition-fast:var(--animation-duration,150ms) ease;--ct-transition:var(--animation-duration-slow,300ms) ease;--ct-panel-min:280px;--ct-panel-max:480px;--ct-header-height:48px}.ct-popup{font-family:var(--ct-font);font-size:var(--ct-font-size);color:var(--ct-text);line-height:1.5;box-sizing:border-box}.ct-popup *,.ct-popup :after,.ct-popup :before{box-sizing:inherit}.ct-popup h1,.ct-popup h2,.ct-popup h3,.ct-popup h4{margin:0;font-weight:600;line-height:1.3;color:var(--ct-text)}.ct-popup h2{font-size:var(--ct-text-lg)}.ct-popup h3{font-size:var(--ct-text-base)}.ct-popup h4{font-size:var(--ct-text-sm)}.ct-popup a{color:var(--ct-accent);text-decoration:none}.ct-popup a:hover{text-decoration:underline}.ct-stack{display:flex;flex-direction:column;gap:var(--ct-space-3)}.ct-stack--tight{gap:var(--ct-space-2)}.ct-stack--loose{gap:var(--ct-space-4)}.ct-row{display:flex;flex-direction:row;align-items:center;gap:var(--ct-space-2)}.ct-row--wrap{flex-wrap:wrap}.ct-row--between{justify-content:space-between}.ct-row--end{justify-content:flex-end}.ct-row--stretch{align-items:stretch}.ct-grid{display:grid;gap:var(--ct-space-3)}.ct-grid--2col{grid-template-columns:repeat(2,1fr)}@media (max-width:600px){.ct-grid--2col{grid-template-columns:1fr}}.ct-flex-1{flex:1 1 0%}.ct-flex-auto{flex:1 1 auto}.ct-flex-none{flex:none}.ct-shrink-0{flex-shrink:0}.ct-gap-1{gap:var(--ct-space-1)}.ct-gap-2{gap:var(--ct-space-2)}.ct-gap-3{gap:var(--ct-space-3)}.ct-gap-4{gap:var(--ct-space-4)}.ct-p-2{padding:var(--ct-space-2)}.ct-p-3{padding:var(--ct-space-3)}.ct-p-4{padding:var(--ct-space-4)}.ct-mt-2{margin-top:var(--ct-space-2)}.ct-mt-3{margin-top:var(--ct-space-3)}.ct-mt-4{margin-top:var(--ct-space-4)}.ct-mt-auto{margin-top:auto}.ct-mb-2{margin-bottom:var(--ct-space-2)}.ct-mb-3{margin-bottom:var(--ct-space-3)}.ct-mb-4{margin-bottom:var(--ct-space-4)}.ct-ml-auto{margin-left:auto}.ct-mr-auto{margin-right:auto}.ct-w-full{width:100%}.ct-min-w-0{min-width:0}.ct-overflow-auto{overflow:auto}.ct-overflow-hidden{overflow:hidden}.ct-overflow-y-auto,.ct-scrollable{overflow-y:auto}.ct-scrollable{scrollbar-width:thin;scrollbar-color:var(--ct-border) transparent}.ct-scrollable::-webkit-scrollbar{width:6px;height:6px}.ct-scrollable::-webkit-scrollbar-track{background:transparent}.ct-scrollable::-webkit-scrollbar-thumb{background:var(--ct-border);border-radius:var(--ct-radius-pill)}.ct-scrollable::-webkit-scrollbar-thumb:hover{background:var(--ct-accent)}.ct-text-muted{color:var(--ct-text-muted)}.ct-text-dim{color:var(--ct-text-dim)}.ct-text-accent{color:var(--ct-accent)}.ct-text-success{color:var(--ct-success)}.ct-text-warning{color:var(--ct-warning)}.ct-text-danger{color:var(--ct-danger)}.ct-text-xs{font-size:var(--ct-text-xs)}.ct-text-sm{font-size:var(--ct-text-sm)}.ct-text-lg{font-size:var(--ct-text-lg)}.ct-text-mono{font-family:var(--ct-font-mono)}.ct-text-center{text-align:center}.ct-text-right{text-align:right}.ct-font-medium{font-weight:500}.ct-font-semibold{font-weight:600}.ct-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.ct-hidden{display:none!important}.ct-sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.ct-popup{display:flex;flex-direction:column;width:100%;height:100%;min-height:0;background:var(--ct-bg);overflow:hidden}.popup:has(.ct-popup){width:95dvw;max-width:1200px;height:90dvh;max-height:none;padding:0;border-radius:var(--ct-radius-lg);overflow:hidden}.popup:has(.ct-popup)>.popup-content,.popup:has(.ct-popup)>div:first-child{display:flex;flex-direction:column;height:100%;padding:0;margin:0}@media (max-width:768px){.popup:has(.ct-popup){width:100dvw;height:100dvh;max-width:none;border-radius:0}}.ct-body{display:flex;flex-direction:column;flex:1;min-height:0}@media (min-width:769px){.ct-body{flex-direction:row}}.ct-panel{display:flex;flex-direction:column;min-height:0;min-width:0}.ct-panel--config,.ct-panel--left{flex:1 1 auto;border-bottom:1px solid var(--ct-border-muted);overflow-y:auto}@media (min-width:769px){.ct-panel--config,.ct-panel--left{flex:0 0 clamp(var(--ct-panel-min),38%,var(--ct-panel-max));border-bottom:none;border-right:1px solid var(--ct-border-muted)}}.ct-panel--results,.ct-panel--right{flex:1 1 auto;overflow:hidden}@media (min-width:769px){.ct-panel--results,.ct-panel--right{flex:1 1 62%}}.ct-panel__content{flex:1;min-height:0;overflow-y:auto;padding:var(--ct-space-3)}.ct-section{display:flex;flex-direction:column;gap:var(--ct-space-3);padding:var(--ct-space-3);padding-top:0;border-bottom:1px solid var(--ct-border)}.ct-section:last-child{border-bottom:none}.ct-section__header{justify-content:space-between;margin:0 calc(-1 * var(--ct-space-3));margin-bottom:0;padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-tertiary);border-bottom:1px solid var(--ct-border-muted)}.ct-section__header,.ct-section__title{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-section__title{font-size:var(--ct-text-sm);font-weight:600;color:var(--ct-text);text-transform:uppercase;letter-spacing:.025em}.ct-section__title i{color:var(--ct-accent);font-size:var(--ct-text-sm);width:1.25em;text-align:center}.ct-section__actions{display:flex;gap:var(--ct-space-1)}.ct-card{background:var(--ct-bg-secondary);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius);overflow:hidden}.ct-card--interactive{cursor:pointer;transition:background var(--ct-transition-fast),border-color var(--ct-transition-fast)}.ct-card--interactive:hover{background:var(--ct-bg-tertiary);border-color:var(--ct-border)}.ct-card--selected{background:var(--ct-accent-muted);border-color:var(--ct-accent)}.ct-header{position:relative;z-index:100;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;min-height:var(--ct-header-height);padding:var(--ct-space-2) var(--ct-space-4);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0;gap:var(--ct-space-3)}.ct-header__left{display:flex;align-items:center;justify-content:flex-start}.ct-header__center{display:flex;align-items:center;justify-content:center;gap:var(--ct-space-2)}.ct-header__center i{color:var(--ct-accent);font-size:var(--ct-text-lg)}.ct-header__center h2{font-size:var(--ct-text-base);font-weight:600;white-space:nowrap}.ct-header__right{justify-content:flex-end;gap:var(--ct-space-2)}.ct-header__right,.ct-toolbar{display:flex;align-items:center}.ct-toolbar{justify-content:space-between;gap:var(--ct-space-2) var(--ct-space-3);padding:var(--ct-space-2) var(--ct-space-4);background:var(--ct-bg-tertiary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:900px){.ct-toolbar{gap:var(--ct-space-2)}}.ct-toolbar__controls{display:flex;align-items:center;gap:var(--ct-space-2);flex-wrap:wrap;flex-shrink:0}.ct-pipeline-controls{display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-pipeline-controls__main{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-pipeline-controls--generating{padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-accent-muted);border-radius:var(--ct-radius);flex-direction:row}.ct-pipeline-status{font-size:var(--ct-text-sm);color:var(--ct-accent)}.ct-iteration-row,.ct-pipeline-status{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-iteration-row{padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-accent-muted);border-radius:var(--ct-radius);border-left:3px solid var(--ct-accent)}.ct-iteration-row__label{display:flex;align-items:center;gap:var(--ct-space-1);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-accent);white-space:nowrap}.ct-iteration-row__input,.ct-iteration-row__label i{font-size:var(--ct-text-xs)}.ct-iteration-row__input{flex:1;min-width:150px;max-width:300px;padding:var(--ct-space-1) var(--ct-space-2);border:1px solid var(--ct-border);border-radius:var(--ct-radius-sm);background:var(--ct-bg);color:var(--ct-text);transition:border-color var(--ct-transition-fast)}.ct-iteration-row__input:focus{border-color:var(--ct-accent);outline:none}.ct-iteration-row__input::-moz-placeholder{color:var(--ct-text-muted);font-style:italic}.ct-iteration-row__input::placeholder{color:var(--ct-text-muted);font-style:italic}.ct-tabs{padding:var(--ct-space-2);background:var(--ct-bg-secondary);border-radius:var(--ct-radius);overflow-x:auto}.ct-tab,.ct-tabs{display:flex;gap:var(--ct-space-2)}.ct-tab{flex:1;align-items:center;justify-content:center;padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast);white-space:nowrap}.ct-tab:hover{color:var(--ct-text);background:var(--ct-bg-tertiary)}.ct-tab--active{color:var(--ct-text);background:var(--ct-bg);border-color:var(--ct-accent);box-shadow:var(--ct-shadow-sm)}.ct-tab__icon{font-size:1em}.ct-tab__badge{font-size:var(--ct-text-xs);padding:.1em .5em;background:var(--ct-accent-muted);color:var(--ct-accent);border-radius:var(--ct-radius-pill)}.ct-stage-tabs{display:flex;gap:var(--ct-space-1);flex:1 1 auto;min-width:-moz-fit-content;min-width:fit-content}.ct-stage-tab{display:flex;align-items:center;gap:var(--ct-space-2);padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast);white-space:nowrap}.ct-stage-tab:hover{color:var(--ct-text);background:var(--ct-bg-secondary)}.ct-stage-tab--active{color:var(--ct-text);background:var(--ct-bg);border-color:var(--ct-accent);box-shadow:var(--ct-shadow-sm)}.ct-stage-tab__icon{font-size:1em;flex-shrink:0}.ct-stage-tab__label{flex:1 1 auto;min-width:-moz-max-content;min-width:max-content}.ct-stage-tab__status{display:flex;align-items:center;justify-content:center;width:1.25em;height:1.25em;font-size:.75em;border-radius:50%;flex-shrink:0}.ct-stage-tab--running .ct-stage-tab__status{color:var(--ct-accent)}.ct-stage-tab--complete .ct-stage-tab__status{color:var(--ct-success);background:var(--ct-success-bg)}.ct-stage-tab--error .ct-stage-tab__status{color:var(--ct-danger);background:var(--ct-danger-bg)}.ct-dropdown{position:relative;min-width:200px;max-width:280px}.ct-dropdown--session{min-width:180px}.ct-dropdown--disabled .ct-dropdown__trigger{opacity:.5;cursor:not-allowed}.ct-dropdown--open .ct-dropdown__trigger{border-color:var(--ct-accent);border-bottom-left-radius:0;border-bottom-right-radius:0}.ct-dropdown--open .ct-dropdown__trigger-chevron{transform:rotate(180deg)}.ct-dropdown--open .ct-dropdown__panel{display:flex}.ct-dropdown__trigger{display:flex;align-items:center;gap:var(--ct-space-2);width:100%;padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);color:var(--ct-text);background:var(--ct-bg);border:1px solid var(--ct-border);border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast)}.ct-dropdown__trigger:hover{border-color:var(--ct-accent)}.ct-dropdown__trigger--session{gap:var(--ct-space-2)}.ct-dropdown__trigger-avatar{width:24px;height:24px;border-radius:var(--ct-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.ct-dropdown__trigger-icon{width:24px;text-align:center;color:var(--ct-text-muted);flex-shrink:0}.ct-dropdown__trigger-text{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-dropdown__trigger-text--placeholder{color:var(--ct-text-muted)}.ct-dropdown__trigger-chevron{font-size:.75em;color:var(--ct-text-muted);transition:transform var(--ct-transition-fast);flex-shrink:0}.ct-dropdown__count{background:var(--ct-accent-muted);color:var(--ct-accent);padding:2px 6px;border-radius:var(--ct-radius-pill);font-size:var(--ct-text-xs);font-weight:600}.ct-dropdown__panel{position:absolute;top:100%;left:0;right:0;min-width:320px;z-index:1000;display:none;flex-direction:column;background:var(--SmartThemeChatBg,#1a1a1a);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--ct-accent);border-top:none;border-bottom-left-radius:var(--ct-radius);border-bottom-right-radius:var(--ct-radius);box-shadow:var(--ct-shadow-lg);max-height:400px;overflow:hidden}.ct-dropdown__panel--session{min-width:280px;max-height:320px}.ct-dropdown__search{position:relative;padding:var(--ct-space-2);border-bottom:1px solid var(--ct-border-muted)}.ct-dropdown__search-icon{position:absolute;left:calc(var(--ct-space-2) + var(--ct-space-2));top:50%;transform:translateY(-50%);color:var(--ct-text-muted);font-size:var(--ct-text-xs);pointer-events:none}.ct-dropdown__search-input{width:100%;padding:var(--ct-space-2) var(--ct-space-3);padding-left:calc(var(--ct-space-3) * 2 + .75em);font-size:var(--ct-text-sm);background:var(--ct-bg-secondary);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius-sm)}.ct-dropdown__search-input:focus{border-color:var(--ct-accent);outline:none}.ct-dropdown__search-clear{position:absolute;right:calc(var(--ct-space-2) + var(--ct-space-1));top:50%;transform:translateY(-50%);padding:var(--ct-space-1);background:none;border:none;color:var(--ct-text-muted);cursor:pointer;opacity:.7}.ct-dropdown__search-clear:hover{opacity:1;color:var(--ct-text)}.ct-dropdown__list{flex:1;overflow-y:auto;max-height:320px;padding:var(--ct-space-2);display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-dropdown__list--session{max-height:220px}.ct-dropdown__empty{padding:var(--ct-space-6);text-align:center;font-size:var(--ct-text-sm);color:var(--ct-text-muted)}.ct-dropdown__empty i{display:block;font-size:2em;margin-bottom:var(--ct-space-2);opacity:.5}.ct-dropdown__footer{padding:var(--ct-space-2);border-top:1px solid var(--ct-border-muted)}.ct-dropdown__new-btn{width:100%;justify-content:center}.ct-char-option{display:flex;align-items:flex-start;gap:var(--ct-space-3);padding:var(--ct-space-3);cursor:pointer;border-radius:var(--ct-radius);background:var(--ct-bg-secondary);border:1px solid transparent;transition:background var(--ct-transition-fast),border-color var(--ct-transition-fast),box-shadow var(--ct-transition-fast),transform var(--ct-transition-fast)}.ct-char-option:hover{background:var(--ct-bg-tertiary);border-color:var(--ct-border);transform:translateX(2px)}.ct-char-option--selected{border-color:var(--ct-accent)}.ct-char-option--selected,.ct-char-option--selected:hover{background:var(--ct-accent-muted)}.ct-char-option--highlighted{background:var(--ct-bg-tertiary);border-color:var(--ct-accent);box-shadow:0 0 0 2px var(--ct-accent-muted)}.ct-char-option__avatar-wrap{position:relative;flex-shrink:0}.ct-char-option__avatar{width:48px;height:48px;border-radius:var(--ct-radius);-o-object-fit:cover;object-fit:cover;border:2px solid var(--ct-border-muted);transition:border-color var(--ct-transition-fast)}.ct-char-option--selected .ct-char-option__avatar,.ct-char-option:hover .ct-char-option__avatar{border-color:var(--ct-accent)}.ct-char-option__check{position:absolute;bottom:-4px;right:-4px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:var(--ct-accent);color:var(--ct-bg);border-radius:50%;font-size:10px;box-shadow:0 2px 4px rgba(0,0,0,.3)}.ct-char-option__info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}.ct-char-option__name{font-size:var(--ct-text-sm);font-weight:600;color:var(--ct-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-char-option__desc{font-size:var(--ct-text-xs);color:var(--ct-text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.ct-char-option__meta{display:flex;align-items:center;gap:var(--ct-space-1);font-size:10px;color:var(--ct-text-muted);margin-top:2px}.ct-char-option__meta i{font-size:9px;opacity:.7}.ct-session-option{display:flex;align-items:center;gap:var(--ct-space-2);padding:var(--ct-space-2) var(--ct-space-3);border-bottom:1px solid var(--ct-border-muted);cursor:pointer;transition:background .15s ease}.ct-session-option:last-child{border-bottom:none}.ct-session-option:hover{background:var(--ct-bg-tertiary)}.ct-session-option--active,.ct-session-option--active:hover{background:var(--ct-accent-muted)}.ct-session-option__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}.ct-session-option__name{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-sm);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ct-session-option__indicator{font-size:6px;color:var(--ct-accent);flex-shrink:0}.ct-session-option__name-input{flex:1;padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-sm);border:1px solid var(--ct-accent);border-radius:var(--ct-radius-sm);background:var(--ct-bg);color:var(--ct-text);outline:none}.ct-session-option__name-input:focus{box-shadow:0 0 0 2px var(--ct-accent-muted)}.ct-session-option__meta{display:flex;gap:var(--ct-space-2);font-size:var(--ct-text-xs);color:var(--ct-text-muted)}.ct-session-option__meta span:after{content:"•";margin-left:var(--ct-space-2);opacity:.5}.ct-session-option__meta span:last-child:after{display:none}.ct-session-option__actions{display:flex;gap:2px;opacity:0;transition:opacity .15s ease}.ct-session-option__actions--editing{opacity:1}.ct-session-option__actions .menu_button--ghost{padding:var(--ct-space-1)}.ct-session-option__actions .menu_button--ghost:hover{background:var(--ct-bg-secondary)}.ct-session-option__actions .ct-session-delete:hover{color:var(--ct-danger)}.ct-session-option:hover .ct-session-option__actions{opacity:1}.ct-popup input[type=number],.ct-popup input[type=search],.ct-popup input[type=text],.ct-popup select,.ct-popup textarea{width:100%;padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-family:var(--ct-font);color:var(--ct-text);background:var(--ct-bg-secondary);border:1px solid var(--ct-border);border-radius:var(--ct-radius-sm);transition:border-color var(--ct-transition-fast)}.ct-popup input[type=number]:focus,.ct-popup input[type=search]:focus,.ct-popup input[type=text]:focus,.ct-popup select:focus,.ct-popup textarea:focus{border-color:var(--ct-accent);outline:none}.ct-popup textarea{min-height:100px;resize:vertical;line-height:1.5}.ct-popup textarea.ct-textarea--code{font-family:var(--ct-font-mono);font-size:var(--ct-text-xs)}.ct-search{position:relative}.ct-search__icon{position:absolute;left:var(--ct-space-3);top:50%;transform:translateY(-50%);color:var(--ct-text-muted);pointer-events:none}.ct-search__input{padding-left:calc(var(--ct-space-3) * 2 + 1em)}.ct-search__clear{position:absolute;right:var(--ct-space-1);top:50%;transform:translateY(-50%);padding:var(--ct-space-1);background:none;border:none;color:var(--ct-text-muted);cursor:pointer;opacity:.7;transition:opacity var(--ct-transition-fast)}.ct-search__clear:hover{opacity:1;color:var(--ct-text)}.ct-checkbox{display:flex;align-items:center;gap:var(--ct-space-2);cursor:pointer;font-size:var(--ct-text-sm)}.ct-checkbox input[type=checkbox]{width:auto;accent-color:var(--ct-accent)}.ct-form-group{display:flex;flex-direction:column;gap:var(--ct-space-1)}.ct-form-group__label{font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text)}.ct-form-group__hint{font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-form-group--grow{flex:1;display:flex;flex-direction:column;min-height:0}.ct-select{width:auto;min-width:120px;padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-xs);font-family:var(--ct-font);color:var(--ct-text);background:var(--ct-bg-secondary);border:1px solid var(--ct-border);border-radius:var(--ct-radius-sm);cursor:pointer;transition:border-color var(--ct-transition-fast)}.ct-select:focus,.ct-select:hover{border-color:var(--ct-accent);outline:none}.ct-textarea--editor{width:100%;height:100%;min-height:200px;resize:vertical;font-family:var(--ct-font);font-size:var(--ct-text-sm);line-height:1.6}.ct-textarea--compact{min-height:60px}.ct-editor-wrap{position:relative;flex:1;min-height:200px}.ct-editor-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:var(--ct-space-2);padding:var(--ct-space-2);background:var(--ct-bg-tertiary);border:1px solid var(--ct-border-muted);border-bottom:none;border-radius:var(--ct-radius) var(--ct-radius) 0 0}.ct-toolbar-divider{width:1px;height:1.5em;background:var(--ct-border-muted);margin:0 var(--ct-space-1)}.ct-code-editor{position:relative;flex:1;min-height:250px;font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.6;border:1px solid var(--ct-border);border-top:none;border-radius:0 0 var(--ct-radius) var(--ct-radius);overflow:hidden}.ct-code-editor__highlight,.ct-code-editor__textarea{position:absolute;inset:0;margin:0;padding:var(--ct-space-3);font-family:inherit;font-size:inherit;line-height:inherit;white-space:pre-wrap;word-wrap:break-word;overflow:auto}.ct-code-editor__highlight{pointer-events:none;background:var(--ct-bg-secondary);color:var(--ct-text)}.ct-code-editor__highlight code{font-family:inherit;background:transparent}.ct-code-editor__textarea{background:transparent;color:transparent;caret-color:var(--ct-text);resize:none;border:none;outline:none;z-index:1}.ct-code-editor__textarea::-moz-selection{background:var(--ct-accent-muted)}.ct-code-editor__textarea::selection{background:var(--ct-accent-muted)}.ct-code-editor .hljs-string{color:var(--ct-success)}.ct-code-editor .hljs-number{color:var(--ct-warning)}.ct-code-editor .hljs-literal{color:var(--ct-accent)}.ct-code-editor .hljs-attr{color:var(--ct-text)}.ct-code-editor .hljs-punctuation{color:var(--ct-text-muted)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button{display:inline-flex;align-items:center;justify-content:center;gap:var(--ct-space-1);padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-weight:500;white-space:nowrap;border-radius:var(--ct-radius-sm);transition:all var(--ct-transition-fast);width:auto;min-width:auto;margin:0}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--icon{padding:var(--ct-space-2);aspect-ratio:1}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--sm{padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-xs)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--lg{padding:var(--ct-space-3) var(--ct-space-4);font-size:var(--ct-text-base)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--full{width:100%}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--primary{background:var(--ct-accent);border-color:var(--ct-accent);color:var(--ct-bg);filter:none}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--primary:hover:not(:disabled){background:var(--ct-accent-hover);border-color:var(--ct-accent-hover);filter:none}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--danger{background:var(--ct-danger);border-color:var(--ct-danger);color:#fff;filter:none}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--danger:hover:not(:disabled){filter:brightness(1.1)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--ghost{background:transparent;border-color:transparent}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--ghost:hover:not(:disabled){background:var(--ct-bg-secondary)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button--success{background:var(--ct-success);border-color:var(--ct-success);color:#fff;filter:none}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.5)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button.ct-active{color:var(--ct-accent);background:var(--ct-accent-muted);border-color:var(--ct-accent)}:is(.ct-popup,.ct-settings-modal,.ct-drawer) .menu_button.ct-active:hover:not(:disabled){background:color-mix(in srgb,var(--ct-accent) 40%,transparent)}.ct-button-group{display:flex;gap:var(--ct-space-2)}.ct-button-group--stretch .menu_button{flex:1}.ct-field-list{flex-direction:column;gap:var(--ct-space-1);max-height:200px;overflow-y:auto;background:var(--ct-bg-secondary);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius)}.ct-field-item,.ct-field-list{display:flex;padding:var(--ct-space-2)}.ct-field-item{align-items:center;justify-content:space-between;gap:var(--ct-space-3);border-radius:var(--ct-radius-sm);transition:background var(--ct-transition-fast)}.ct-field-item:hover{background:var(--ct-bg-tertiary)}.ct-field-item__label{display:flex;align-items:center;gap:var(--ct-space-3);flex:1;min-width:0;cursor:pointer;font-size:var(--ct-text-sm)}.ct-field-item__meta{font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-field-label{display:flex;align-items:center;gap:var(--ct-space-2);flex:1;cursor:pointer;font-size:var(--ct-text-sm)}.ct-field-checkbox{width:auto!important;margin:0;accent-color:var(--ct-accent);cursor:pointer;flex-shrink:0}.ct-field-name{flex:1;color:var(--ct-text)}.ct-field-count,.ct-field-tokens{font-size:var(--ct-text-xs);color:var(--ct-text-dim);flex-shrink:0;min-width:2.5em;text-align:right}.ct-field-group{border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius-sm);overflow:hidden}.ct-field-group .ct-field-item--parent{background:var(--ct-bg-tertiary);border-bottom:1px solid var(--ct-border-muted)}.ct-field-group .ct-field-children{display:none;padding:var(--ct-space-1);background:var(--ct-bg-secondary)}.ct-field-group--expanded .ct-field-children{display:block}.ct-field-group .ct-field-item--child{padding-left:var(--ct-space-4)}.ct-field-expand{padding:var(--ct-space-1);background:none;border:none;color:var(--ct-text-muted);cursor:pointer;transition:transform var(--ct-transition-fast)}.ct-field-expand:hover{color:var(--ct-text)}.ct-field-group--expanded .ct-field-expand{transform:rotate(180deg)}.ct-field-preview{display:none;flex-direction:column;gap:var(--ct-space-2);padding:var(--ct-space-2);background:var(--ct-bg-secondary);border-top:1px solid var(--ct-border-muted)}.ct-field-group--expanded .ct-field-preview{display:flex}.ct-field-preview__text{position:relative;margin:0;padding:var(--ct-space-2);max-height:100px;overflow:hidden;font-size:var(--ct-text-xs);font-family:var(--ct-font-mono);white-space:pre-wrap;word-break:break-word;line-height:1.4;background:var(--ct-bg-tertiary);border-radius:var(--ct-radius-sm);color:var(--ct-text-muted)}.ct-field-preview__text:after{content:"";position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,var(--ct-bg-tertiary));pointer-events:none}.ct-field-preview__more{display:inline-flex;align-items:center;align-self:flex-start;gap:var(--ct-space-1);padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-xs);color:var(--ct-accent);background:var(--ct-bg-tertiary);border:1px solid var(--ct-accent-muted);border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast);flex-shrink:0}.ct-field-preview__more:hover{background:var(--ct-accent-muted)}.ct-field-preview-btn{padding:var(--ct-space-1);background:none;border:none;color:var(--ct-text-dim);cursor:pointer;transition:color var(--ct-transition-fast)}.ct-field-preview-btn:hover{color:var(--ct-accent)}.ct-popup-preview{margin:0;padding:var(--ct-space-3);max-height:60vh;overflow-y:auto;font-family:var(--ct-font-mono);font-size:var(--ct-text-sm);white-space:pre-wrap;word-break:break-word;background:var(--ct-bg-secondary);border-radius:var(--ct-radius)}.ct-label{display:block;margin-bottom:var(--ct-space-1);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text)}.ct-required{color:var(--ct-danger)}.ct-input{width:100%;padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-family:var(--ct-font)}.ct-hint{display:block;margin-top:var(--ct-space-1);font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-checkbox-group{display:flex;flex-wrap:wrap;gap:var(--ct-space-3);padding:var(--ct-space-2);background:var(--ct-bg-tertiary);border-radius:var(--ct-radius-sm)}.ct-checkbox-label{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-sm);color:var(--ct-text);cursor:pointer}.ct-checkbox-label input[type=checkbox]{width:auto;accent-color:var(--ct-accent);cursor:pointer}.ct-schema-toolbar{display:flex;gap:var(--ct-space-2);margin-bottom:var(--ct-space-2)}.ct-errors,.ct-warnings{display:flex;flex-direction:column;gap:var(--ct-space-1);padding:var(--ct-space-3);border-radius:var(--ct-radius-sm)}.ct-errors{background:var(--ct-danger-bg);border:1px solid var(--ct-danger)}.ct-warnings{background:var(--ct-warning-bg);border:1px solid var(--ct-warning)}.ct-error{color:var(--ct-danger)}.ct-error,.ct-warning{font-size:var(--ct-text-sm)}.ct-warning{color:var(--ct-warning)}.ct-collapsible{border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius-sm)}.ct-collapsible summary{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-2) var(--ct-space-3);font-size:var(--ct-text-sm);font-weight:500;cursor:pointer;background:var(--ct-bg-secondary);list-style:none;transition:background var(--ct-transition-fast)}.ct-collapsible summary:hover{background:var(--ct-bg-tertiary)}.ct-collapsible summary::-webkit-details-marker{display:none}.ct-collapsible[open] summary{border-bottom:1px solid var(--ct-border-muted)}.ct-collapsible__content{padding:var(--ct-space-3)}.ct-shortcut{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-2);border-radius:var(--ct-radius-sm)}.ct-shortcut__keys{display:flex;gap:var(--ct-space-1)}.ct-shortcut__desc{color:var(--ct-text-muted)}.ct-list{display:flex;flex-direction:column}.ct-list-item{display:flex;align-items:flex-start;gap:var(--ct-space-3);padding:var(--ct-space-3);border-bottom:1px solid var(--ct-border-muted);cursor:pointer;transition:background var(--ct-transition-fast)}.ct-list-item:last-child{border-bottom:none}.ct-list-item:hover{background:var(--ct-bg-secondary)}.ct-list-item--selected{background:var(--ct-accent-muted);border-left:3px solid var(--ct-accent)}.ct-list-item--highlighted{background:var(--ct-bg-tertiary);outline:2px solid var(--ct-accent);outline-offset:-2px}.ct-list-item__avatar{width:48px;height:48px;border-radius:var(--ct-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.ct-list-item__avatar--sm{width:32px;height:32px}.ct-list-item__avatar--circle{border-radius:50%}.ct-list-item__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--ct-space-1)}.ct-list-item__title{font-weight:600;font-size:var(--ct-text-sm);color:var(--ct-text)}.ct-list-item__subtitle{font-size:var(--ct-text-xs);color:var(--ct-text-muted)}.ct-list-item__meta{display:flex;gap:var(--ct-space-3);font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-list-item__actions{display:flex;gap:var(--ct-space-1);opacity:0;transition:opacity var(--ct-transition-fast)}.ct-list-item:hover .ct-list-item__actions{opacity:1}.ct-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--ct-space-8);text-align:center;color:var(--ct-text-muted)}.ct-empty__icon{font-size:3rem;opacity:.3;margin-bottom:var(--ct-space-4)}.ct-empty__title{font-weight:500;margin-bottom:var(--ct-space-2)}.ct-empty__text{font-size:var(--ct-text-sm);color:var(--ct-text-dim)}.ct-results-wrapper{display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden}.ct-results-toolbar{display:flex;align-items:center;justify-content:space-between;gap:var(--ct-space-2);padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0}.ct-results-content{flex:1;min-height:0;overflow-y:auto}.ct-result{display:flex;flex-direction:column;height:100%}.ct-result__header{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0}.ct-result__type{font-size:var(--ct-text-xs);color:var(--ct-text-muted)}.ct-result__actions,.ct-result__type{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-result__content{flex:1;overflow-y:auto;padding:var(--ct-space-3)}.ct-result__raw{margin:0;background:var(--ct-bg-tertiary);color:var(--ct-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.ct-result__json,.ct-result__raw{padding:var(--ct-space-3);font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;border-radius:var(--ct-radius)}.ct-result__json{background:var(--ct-bg-secondary)}.ct-result__code{margin:0;padding:var(--ct-space-3);font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.5;background:var(--ct-bg-tertiary);border-radius:var(--ct-radius);overflow-x:auto}.ct-result__code code{font-family:inherit}.ct-result__prose{font-size:var(--ct-text-sm);line-height:1.7}.ct-result__prose h1,.ct-result__prose h2,.ct-result__prose h3{font-weight:600;margin-top:1.25em;margin-bottom:.5em}.ct-result__prose h1:first-child,.ct-result__prose h2:first-child,.ct-result__prose h3:first-child{margin-top:0}.ct-result__prose p{margin:0 0 .75em}.ct-result__prose ol,.ct-result__prose ul{margin:.5em 0;padding-left:1.5em}.ct-result__prose li{margin:.25em 0}.ct-result__prose code{font-family:var(--ct-font-mono);font-size:.9em;padding:.15em .4em;background:var(--ct-bg-secondary);border-radius:var(--ct-radius-sm)}.ct-result__prose pre{margin:.75em 0;padding:var(--ct-space-2);background:var(--ct-bg-secondary);border-radius:var(--ct-radius);overflow-x:auto}.ct-result__prose pre code{padding:0;background:none}.ct-result__prose strong{font-weight:600}:is(.ct-json-toggle,.ct-text-toggle){display:flex;background:var(--ct-bg-tertiary);border-radius:var(--ct-radius-sm);padding:2px}:is(.ct-json-toggle,.ct-text-toggle)>button{display:flex;align-items:center;justify-content:center;width:28px;height:24px;border:none;background:transparent;color:var(--ct-text-dim);cursor:pointer;border-radius:var(--ct-radius-sm);transition:all var(--ct-transition-fast)}:is(.ct-json-toggle,.ct-text-toggle)>button:hover{color:var(--ct-text);background:var(--ct-bg-secondary)}:is(.ct-json-toggle__btn,.ct-text-toggle__btn)--active{color:var(--ct-accent);background:var(--ct-bg);box-shadow:0 1px 2px rgba(0,0,0,.1)}.ct-view-toggle{display:flex;gap:var(--ct-space-1);background:var(--ct-bg-secondary);padding:var(--ct-space-1);border-radius:var(--ct-radius)}.ct-view-toggle__btn{padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-xs);border-radius:calc(var(--ct-radius) - 2px);background:transparent;border:none;color:var(--ct-text-dim);cursor:pointer;transition:all .15s ease}.ct-view-toggle__btn:hover{color:var(--ct-text)}.ct-view-toggle__btn--active{background:var(--ct-bg);color:var(--ct-text);box-shadow:var(--ct-shadow-sm)}.ct-compare-view{display:flex;flex-direction:column;height:100%;min-height:0}.ct-compare-header{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-2) var(--ct-space-3);border-bottom:1px solid var(--ct-border);flex-shrink:0}.ct-compare-stats{display:flex;gap:var(--ct-space-2)}.ct-compare-list{flex:1;overflow-y:auto;padding:var(--ct-space-2)}.ct-compare-row{margin-bottom:var(--ct-space-3);border:1px solid var(--ct-border);border-radius:var(--ct-radius);overflow:hidden}.ct-compare-row--changed{border-color:var(--ct-accent)}.ct-compare-row--unchanged{opacity:.7}.ct-compare-row__header{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border)}.ct-compare-row__label{font-weight:600;font-size:var(--ct-text-sm)}.ct-compare-row__badges{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-compare-row__content{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--ct-border)}.ct-compare-row__content--single{grid-template-columns:1fr;background:transparent}.ct-compare-col{background:var(--ct-bg);padding:var(--ct-space-2)}.ct-compare-col__header{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-xs);font-weight:600;text-transform:uppercase;color:var(--ct-text-dim);margin-bottom:var(--ct-space-2)}.ct-compare-col--original .ct-compare-col__header{color:var(--ct-danger)}.ct-compare-col--rewritten .ct-compare-col__header{color:var(--ct-success)}.ct-compare-text{font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;margin:0;max-height:200px;overflow-y:auto}.ct-diff--added{background:rgba(var(--ct-success-rgb,46,160,67),.2);color:var(--ct-success);padding:0 2px;border-radius:2px}.ct-diff--removed{background:rgba(var(--ct-danger-rgb,248,81,73),.2);color:var(--ct-danger);text-decoration:line-through;opacity:.8;padding:0 2px;border-radius:2px}.ct-diff-stats{display:inline-flex;gap:var(--ct-space-2);font-size:var(--ct-text-xs);font-family:var(--ct-font-mono);font-weight:600}.ct-diff-stats__add{color:var(--ct-success)}.ct-diff-stats__del{color:var(--ct-danger)}.ct-compare-popup{display:grid;grid-template-columns:1fr 1fr;gap:var(--ct-space-4)}.ct-compare-popup__side h4{margin-bottom:var(--ct-space-2);font-weight:600}.ct-compare-popup__side pre{font-size:var(--ct-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;padding:var(--ct-space-2);background:var(--ct-bg-secondary);border-radius:var(--ct-radius)}:root{--ct-score-high:#10b981;--ct-score-good:#22c55e;--ct-score-mid:#eab308;--ct-score-low:#f97316;--ct-score-bad:#ef4444}.ct-formatted{display:flex;flex-direction:column;gap:var(--ct-space-2);font-size:var(--ct-text-sm);line-height:1.55}.ct-formatted--empty{padding:var(--ct-space-4);text-align:center;color:var(--ct-text-dim);font-style:italic}.ct-hero{position:relative;display:flex;flex-direction:column;align-items:center;padding:var(--ct-space-3) var(--ct-space-4);background:linear-gradient(135deg,var(--ct-bg-secondary) 0,var(--ct-bg-tertiary) 100%);border-radius:var(--ct-radius);border:1px solid var(--ct-border);text-align:center;overflow:hidden}.ct-hero:before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:120px;background:var(--score-color,var(--ct-accent));opacity:.06;filter:blur(30px);border-radius:50%;pointer-events:none}.ct-hero__label{font-size:var(--ct-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--ct-text-muted);margin-bottom:var(--ct-space-1)}.ct-hero__score{display:flex;align-items:baseline;gap:2px}.ct-hero__value{font-size:2.5rem;font-weight:800;line-height:1;color:var(--score-color,var(--ct-accent));text-shadow:0 2px 12px color-mix(in srgb,var(--score-color,var(--ct-accent)) 25%,transparent);font-variant-numeric:tabular-nums}.ct-hero__max{font-size:1rem;font-weight:500;color:var(--ct-text-dim);margin-left:2px}.ct-hero__bar{width:100%;max-width:160px;height:4px;margin-top:var(--ct-space-2);background:var(--ct-bg-tertiary);border-radius:2px;overflow:hidden}.ct-hero__fill{height:100%;border-radius:2px;transition:width .5s cubic-bezier(.4,0,.2,1)}.ct-formatted .ct-section{background:var(--ct-bg-secondary);border:1px solid var(--ct-border);border-radius:var(--ct-radius);overflow:hidden}.ct-formatted .ct-section .ct-section__header{display:flex;align-items:center;justify-content:space-between;gap:var(--ct-space-2);padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-tertiary);border-bottom:1px solid var(--ct-border-muted);margin:0}.ct-formatted .ct-section .ct-section__title{margin:0;font-size:var(--ct-text-sm);font-weight:700;color:var(--ct-text);text-transform:none;letter-spacing:normal}.ct-formatted .ct-section .ct-section__body{padding:var(--ct-space-3);display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-formatted .ct-section .ct-section__body--nested{background:var(--ct-bg);border-left:2px solid var(--ct-accent)}.ct-section__score{display:inline-flex;align-items:baseline;padding:2px 8px;background:color-mix(in srgb,var(--score-color,var(--ct-accent)) 15%,transparent);border-radius:var(--ct-radius-sm);font-weight:700;font-size:var(--ct-text-sm);color:var(--score-color,var(--ct-accent));font-variant-numeric:tabular-nums}.ct-section__score-max{font-size:.8em;font-weight:500;opacity:.6;margin-left:1px}.ct-field{display:flex;flex-direction:column;gap:var(--ct-space-1)}.ct-field__label{font-size:var(--ct-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ct-text-muted)}.ct-field__value{font-size:var(--ct-text-sm);line-height:1.6;color:var(--ct-text)}.ct-field--empty{color:var(--ct-text-dim);font-style:italic}.ct-para{margin:0;font-size:var(--ct-text-sm);line-height:1.6;color:var(--ct-text)}.ct-para+.ct-para{margin-top:var(--ct-space-1)}.ct-text{font-size:var(--ct-text-sm);line-height:1.6;white-space:pre-wrap}.ct-formatted .ct-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:4px}.ct-formatted .ct-list li{position:relative;padding-left:var(--ct-space-3);font-size:var(--ct-text-sm);line-height:1.5}.ct-formatted .ct-list li:before{content:"";position:absolute;left:0;top:.55em;width:5px;height:5px;background:var(--ct-accent);border-radius:50%;opacity:.7}.ct-formatted .ct-list--numbered{counter-reset:list-counter}.ct-formatted .ct-list--numbered li{counter-increment:list-counter;padding-left:var(--ct-space-5)}.ct-formatted .ct-list--numbered li:before{content:counter(list-counter);width:auto;height:auto;background:none;border-radius:0;font-size:var(--ct-text-xs);font-weight:700;color:var(--ct-accent);opacity:1;top:0}.ct-cards{display:flex;flex-direction:column;gap:var(--ct-space-3)}.ct-formatted .ct-card{padding:var(--ct-space-4);background:var(--ct-bg-secondary);border:1px solid var(--ct-border);border-radius:var(--ct-radius);transition:border-color var(--ct-transition-fast),box-shadow var(--ct-transition-fast)}.ct-formatted .ct-card:hover{border-color:var(--ct-border);box-shadow:0 4px 12px rgba(0,0,0,.1)}.ct-formatted .ct-card__header{display:flex;align-items:center;justify-content:space-between;gap:var(--ct-space-3);margin-bottom:var(--ct-space-3)}.ct-formatted .ct-card__title{font-weight:700;font-size:var(--ct-text-base);color:var(--ct-text)}.ct-formatted .ct-card__body{font-size:var(--ct-text-sm);line-height:1.7;color:var(--ct-text-muted)}.ct-formatted .ct-card__extra{margin-top:var(--ct-space-3);padding-top:var(--ct-space-3);border-top:1px solid var(--ct-border-muted);display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-score{display:inline-flex;align-items:baseline;padding:2px 8px;background:color-mix(in srgb,var(--score-color,var(--ct-accent)) 15%,transparent);border-radius:var(--ct-radius-sm);font-weight:700;font-size:var(--ct-text-sm);color:var(--score-color,var(--ct-accent));font-variant-numeric:tabular-nums}.ct-score__max{font-size:.75em;font-weight:500;opacity:.6;margin-left:1px}.ct-inline-score{display:inline-flex;align-items:baseline;padding:1px 6px;margin:0 2px;background:color-mix(in srgb,var(--score-color,var(--ct-accent)) 12%,transparent);border-radius:4px;font-weight:700;font-size:.95em;color:var(--score-color,var(--ct-accent));font-variant-numeric:tabular-nums}.ct-inline-score__label{font-weight:500;color:var(--ct-text-muted);margin-right:2px}.ct-inline-score__max{font-size:.75em;font-weight:500;opacity:.5}.ct-code{position:relative;background:var(--ct-bg-tertiary);border:1px solid var(--ct-border);border-radius:var(--ct-radius);overflow:hidden}.ct-code__lang{position:absolute;top:var(--ct-space-2);right:var(--ct-space-2);padding:2px 8px;background:var(--ct-bg-secondary);border-radius:var(--ct-radius-sm);font-size:var(--ct-text-xs);font-weight:600;color:var(--ct-text-muted);text-transform:uppercase;letter-spacing:.05em}.ct-code__pre{margin:0;padding:var(--ct-space-4);overflow-x:auto;font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.6}.ct-code__pre code{font-family:inherit}.ct-inline-code{padding:2px 6px;background:var(--ct-bg-tertiary);border-radius:4px;font-family:var(--ct-font-mono);font-size:.9em;color:var(--ct-accent)}.ct-bool--yes{display:inline-flex;align-items:center;gap:var(--ct-space-1);color:var(--ct-success);font-weight:600}.ct-bool--yes i{font-size:1.1em}.ct-bool--no{display:inline-flex;align-items:center;gap:var(--ct-space-1);color:var(--ct-danger);font-weight:600}.ct-bool--no i{font-size:1.1em}.ct-formatted .ct-empty,.ct-null{color:var(--ct-text-dim)}.ct-formatted .ct-empty{font-style:italic}.ct-num{font-family:var(--ct-font-mono);font-weight:600;font-variant-numeric:tabular-nums}.ct-link{color:var(--ct-accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color var(--ct-transition-fast)}.ct-link:hover{border-bottom-color:var(--ct-accent)}.ct-preview-content{max-height:60vh;overflow-y:auto;padding:var(--ct-space-3);background:var(--ct-bg-secondary);border-radius:var(--ct-radius)}.ct-preview-content pre{margin:0;padding:0;font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word}.ct-error-box{padding:var(--ct-space-3);background:var(--ct-danger-bg);border:1px solid var(--ct-danger);border-radius:var(--ct-radius);color:var(--ct-danger);font-size:var(--ct-text-sm)}.ct-history{flex-shrink:0;border-top:1px solid var(--ct-border-muted);background:var(--ct-bg)}.ct-history--collapsed .ct-history__toggle-icon{transform:rotate(-90deg)}.ct-history--collapsed .ct-history__list{display:none}.ct-history__toggle{display:flex;align-items:center;gap:var(--ct-space-2);width:100%;padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);border:none;cursor:pointer;font-size:var(--ct-text-xs);font-weight:500;color:var(--ct-text-muted);text-align:left}.ct-history__toggle:hover{background:var(--ct-bg-tertiary);color:var(--ct-text)}.ct-history__toggle-icon{margin-left:auto;transition:transform var(--ct-transition-fast)}.ct-history__list{max-height:180px;overflow-y:auto;padding:var(--ct-space-1);background:var(--ct-bg-secondary)}.ct-history-nav{display:flex;align-items:center;justify-content:space-between;gap:var(--ct-space-3);padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-accent-muted);border-bottom:1px solid var(--ct-accent)}.ct-history-nav__info{font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-accent)}.ct-history-nav__controls,.ct-history-nav__info{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-history-nav__btn{flex-shrink:0}.ct-list-item--error{border-left:3px solid var(--ct-danger)}.ct-list-item--error .ct-list-item__title{color:var(--ct-danger)}.ct-list-item--viewing{background:var(--ct-accent-muted);border-left:3px solid var(--ct-accent)}.ct-list-item--current{opacity:.7}.ct-api-badge{display:inline-flex;align-items:center;gap:var(--ct-space-1);padding:var(--ct-space-1) var(--ct-space-2);background:var(--ct-success-bg);border-radius:var(--ct-radius-pill);font-size:var(--ct-text-xs);color:var(--ct-text-muted);cursor:default;transition:background var(--ct-transition-fast)}.ct-api-badge--error{background:var(--ct-danger-bg)}.ct-api-badge i{font-size:.625rem}.ct-api-status{display:flex;align-items:center;gap:var(--ct-space-3);padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);border-radius:var(--ct-radius);border:1px solid var(--ct-border-muted)}.ct-api-status--ready{border-color:var(--ct-success)}.ct-api-status--error{border-color:var(--ct-danger)}.ct-api-status__indicator{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-api-status__text{font-size:var(--ct-text-sm);font-weight:500}.ct-api-status__error{color:var(--ct-danger);cursor:help}.ct-badge{display:inline-flex;align-items:center;padding:.2em .6em;font-size:var(--ct-text-xs);font-weight:500;border-radius:var(--ct-radius-pill);text-transform:uppercase;letter-spacing:.03em}.ct-badge--default{background:var(--ct-bg-tertiary);color:var(--ct-text-muted)}.ct-badge--accent{background:var(--ct-accent-muted);color:var(--ct-accent)}.ct-badge--success{background:var(--ct-success-bg);color:var(--ct-success)}.ct-badge--warning{background:var(--ct-warning-bg);color:var(--ct-warning)}.ct-badge--danger{background:var(--ct-danger-bg);color:var(--ct-danger)}.ct-badge--sm,.ct-badge--small{padding:.1em .4em;font-size:9px}.ct-badge--info{background:var(--ct-accent-muted);color:var(--ct-accent)}.ct-badge--muted{background:var(--ct-bg-secondary);color:var(--ct-text-dim)}.ct-alert{display:flex;gap:var(--ct-space-3);padding:var(--ct-space-3);border-radius:var(--ct-radius);font-size:var(--ct-text-sm)}.ct-alert--info{background:var(--ct-accent-muted);border:1px solid var(--ct-accent);color:var(--ct-accent)}.ct-alert--success{background:var(--ct-success-bg);border:1px solid var(--ct-success);color:var(--ct-success)}.ct-alert--warning{background:var(--ct-warning-bg);border:1px solid var(--ct-warning);color:var(--ct-warning)}.ct-alert--danger{background:var(--ct-danger-bg);border:1px solid var(--ct-danger);color:var(--ct-danger)}.ct-alert__icon{flex-shrink:0}.ct-alert__content{flex:1}.ct-alert__title{font-weight:600;margin-bottom:var(--ct-space-1)}.ct-alert__message{margin-top:var(--ct-space-1);font-size:var(--ct-text-sm);white-space:pre-wrap}.ct-loading{display:flex;align-items:center;gap:var(--ct-space-3);padding:var(--ct-space-3);background:var(--ct-accent-muted);border-radius:var(--ct-radius);color:var(--ct-accent);font-size:var(--ct-text-sm);animation:ct-pulse 2s ease-in-out infinite}.ct-loading__spinner{animation:ct-spin 1s linear infinite}@keyframes ct-spin{to{transform:rotate(1turn)}}@keyframes ct-pulse{0%,to{opacity:1}50%{opacity:.6}}.ct-drawer{position:absolute;inset:0;z-index:100;pointer-events:none;overflow:hidden}.ct-drawer[aria-hidden=true]{visibility:hidden}.ct-drawer--open{pointer-events:auto;visibility:visible}.ct-drawer--open .ct-drawer__backdrop{opacity:1}.ct-drawer--open .ct-drawer__panel{transform:translateX(0)}.ct-drawer__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);opacity:0;transition:opacity var(--ct-transition);backdrop-filter:blur(4px)}.ct-drawer__panel{position:absolute;top:0;right:0;bottom:0;width:100%;max-width:640px;background:var(--SmartThemeBlurTintColor,var(--ct-bg));border-left:1px solid var(--ct-border);box-shadow:-4px 0 24px rgba(0,0,0,.4);transform:translateX(100%);transition:transform var(--ct-transition);display:flex;flex-direction:column}@media (max-width:768px){.ct-drawer__panel{max-width:none}}.ct-drawer__content{display:flex;flex-direction:column;height:100%;min-height:0}.ct-drawer__header{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-3) var(--ct-space-4);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0}.ct-drawer__title{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-drawer__title h3{margin:0;font-size:var(--ct-text-lg);font-weight:600}.ct-drawer__title i{font-size:var(--ct-text-base)}.ct-drawer__body{flex:1;min-height:0;overflow-y:auto;padding:var(--ct-space-4);display:flex;flex-direction:column;gap:var(--ct-space-4)}.ct-drawer__footer{display:flex;align-items:center;padding:var(--ct-space-3) var(--ct-space-4);background:var(--ct-bg-secondary);border-top:1px solid var(--ct-border-muted);flex-shrink:0}.ct-drawer__footer--list{justify-content:space-between}.ct-drawer__tabs{display:flex;background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted);flex-shrink:0}.ct-drawer__tab{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--ct-space-2);padding:var(--ct-space-3);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all var(--ct-transition-fast)}.ct-drawer__tab:hover{color:var(--ct-text);background:var(--ct-bg-tertiary)}.ct-drawer__tab--active{color:var(--ct-accent);border-bottom-color:var(--ct-accent)}.ct-preset-manage{display:inline-flex;align-items:center;gap:var(--ct-space-1);padding:var(--ct-space-1);color:var(--ct-text-muted);background:transparent;border:none;border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast)}.ct-preset-manage:hover{color:var(--ct-accent);background:var(--ct-accent-muted)}.ct-preset-row{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-preset-row .ct-select{flex:1;min-width:0}.ct-preset-row__actions{display:flex;gap:var(--ct-space-1);flex-shrink:0}.ct-chip{display:inline-flex;align-items:center;gap:var(--ct-space-1);padding:var(--ct-space-1) var(--ct-space-2);font-size:var(--ct-text-xs);background:var(--ct-bg-secondary);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius-pill);cursor:pointer;transition:all var(--ct-transition-fast)}.ct-chip--active,.ct-chip:hover{border-color:var(--ct-accent)}.ct-chip--active{background:var(--ct-accent-muted);color:var(--ct-accent)}.ct-chip input[type=checkbox]{display:none}.popup:has(.ct-settings-modal){width:90dvw;max-width:900px;min-width:320px;padding:0}@media (min-width:1024px){.popup:has(.ct-settings-modal){max-width:1000px}}.ct-settings-modal{display:flex;flex-direction:column;height:85vh;max-height:85vh;color:var(--ct-text);font-family:var(--ct-font);font-size:var(--ct-font-size)}.ct-settings-header{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-4);background:var(--ct-bg-secondary);border-bottom:1px solid var(--ct-border-muted)}.ct-settings-header h2{display:flex;align-items:center;gap:var(--ct-space-2);margin:0;font-size:var(--ct-text-lg);font-weight:600}.ct-settings-header h2 i{color:var(--ct-accent)}.ct-settings-body{flex:1;gap:var(--ct-space-4);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--ct-border) transparent}.ct-settings-body,.ct-settings-section{display:flex;flex-direction:column;padding:var(--ct-space-4)}.ct-settings-section{gap:var(--ct-space-3);background:var(--ct-bg-secondary);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius)}.ct-settings-section h3{display:flex;align-items:center;gap:var(--ct-space-2);margin:0 0 var(--ct-space-2) 0;padding-bottom:var(--ct-space-2);border-bottom:1px solid var(--ct-border-muted);font-size:var(--ct-text-base);font-weight:600}.ct-settings-section h3 i{color:var(--ct-accent);font-size:var(--ct-text-sm)}.ct-settings-footer{padding:var(--ct-space-3) var(--ct-space-4);border-top:1px solid var(--ct-border-muted)}.ct-api-banner,.ct-settings-footer{display:flex;align-items:center;justify-content:space-between;background:var(--ct-bg-secondary)}.ct-api-banner{gap:var(--ct-space-3);padding:var(--ct-space-2) var(--ct-space-3);border-radius:var(--ct-radius);border:1px solid var(--ct-border-muted);margin-bottom:var(--ct-space-3)}.ct-api-banner--ready{border-color:var(--ct-success);background:color-mix(in srgb,var(--ct-success) 10%,var(--ct-bg-secondary))}.ct-api-banner--ready .ct-api-banner__left i{color:var(--ct-success)}.ct-api-banner--error{border-color:var(--ct-danger);background:color-mix(in srgb,var(--ct-danger) 10%,var(--ct-bg-secondary))}.ct-api-banner--error .ct-api-banner__left i{color:var(--ct-danger)}.ct-api-banner__left{display:flex;align-items:center;gap:var(--ct-space-2)}.ct-api-banner__name{font-weight:500;font-size:var(--ct-text-sm)}.ct-api-banner__right{display:flex;align-items:center;gap:var(--ct-space-3);font-size:var(--ct-text-xs);color:var(--ct-text-muted)}.ct-api-banner__model{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-api-error{align-items:center;padding:var(--ct-space-2);font-size:var(--ct-text-xs);color:var(--ct-danger);background:color-mix(in srgb,var(--ct-danger) 8%,transparent);border-radius:var(--ct-radius)}.ct-api-error,.ct-gen-mode-toggle{display:flex;gap:var(--ct-space-2);margin-bottom:var(--ct-space-3)}.ct-gen-mode-option{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--ct-space-2);padding:var(--ct-space-2) var(--ct-space-3);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius);background:var(--ct-bg-secondary);cursor:pointer;transition:all var(--ct-transition);font-size:var(--ct-text-sm)}.ct-gen-mode-option input[type=radio]{display:none}.ct-gen-mode-option:hover{border-color:var(--ct-border);background:var(--ct-bg-tertiary)}.ct-gen-mode-option--active{border-color:var(--ct-accent);background:color-mix(in srgb,var(--ct-accent) 15%,var(--ct-bg-secondary))}.ct-gen-mode-option--active i{color:var(--ct-accent)}.ct-profile-section{padding:var(--ct-space-3);background:var(--ct-bg-secondary);border-radius:var(--ct-radius);border:1px solid var(--ct-border-muted)}.ct-profile-info{margin-top:var(--ct-space-2);padding:var(--ct-space-2);background:var(--ct-bg);border-radius:var(--ct-radius-sm)}.ct-profile-info--empty{display:flex;align-items:center;gap:var(--ct-space-2);color:var(--ct-text-dim);font-size:var(--ct-text-sm);font-style:italic}.ct-profile-info--error{border:1px solid var(--ct-danger)}.ct-profile-info__row{display:flex;align-items:center;justify-content:space-between;padding:var(--ct-space-1) 0;font-size:var(--ct-text-xs)}.ct-profile-info__row:not(:last-child){border-bottom:1px solid var(--ct-border-muted)}.ct-profile-info__label{color:var(--ct-text-muted)}.ct-profile-info__value{font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-profile-info__error{display:flex;align-items:center;gap:var(--ct-space-2);margin-top:var(--ct-space-2);padding:var(--ct-space-2);font-size:var(--ct-text-xs);color:var(--ct-danger);background:color-mix(in srgb,var(--ct-danger) 10%,transparent);border-radius:var(--ct-radius-sm)}.ct-profile-empty{display:flex;gap:var(--ct-space-2);padding:var(--ct-space-3);color:var(--ct-text-muted);font-size:var(--ct-text-sm)}.ct-profile-empty i{color:var(--ct-accent);flex-shrink:0;margin-top:2px}.ct-profile-empty strong{display:block;margin-bottom:var(--ct-space-1);color:var(--ct-text)}.ct-profile-empty p{margin:0;font-size:var(--ct-text-xs);line-height:1.4}.ct-setting-item{display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-setting-label{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text);cursor:pointer}.ct-setting-label input[type=checkbox]{width:auto;accent-color:var(--ct-accent);cursor:pointer}.ct-setting-hint{font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-setting-desc{margin:0 0 var(--ct-space-2) 0;font-size:var(--ct-text-sm);color:var(--ct-text-muted);line-height:1.5}.ct-number-input{width:120px!important;padding:var(--ct-space-2);font-size:var(--ct-text-sm)}.ct-readonly-text{margin:0;padding:var(--ct-space-3);font-family:var(--ct-font-mono);font-size:var(--ct-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word;background:var(--ct-bg-tertiary);border-radius:var(--ct-radius-sm);max-height:150px;overflow-y:auto}.ct-version{font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-presets-tabs{display:flex;gap:var(--ct-space-1);padding:var(--ct-space-1);background:var(--ct-bg-tertiary);border-radius:var(--ct-radius-sm);margin-bottom:var(--ct-space-3)}.ct-presets-tab{flex:1;padding:var(--ct-space-2);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text-muted);background:transparent;border:none;border-radius:var(--ct-radius-sm);cursor:pointer;transition:all var(--ct-transition-fast)}.ct-presets-tab:hover{color:var(--ct-text);background:var(--ct-bg-secondary)}.ct-presets-tab--active{color:var(--ct-text);background:var(--ct-bg);box-shadow:var(--ct-shadow-sm)}.ct-presets-list{flex-direction:column;max-height:250px;overflow-y:auto;padding:var(--ct-space-2);background:var(--ct-bg-tertiary);margin-bottom:var(--ct-space-3)}.ct-preset-item,.ct-presets-list{display:flex;gap:var(--ct-space-2);border:1px solid var(--ct-border-muted);border-radius:var(--ct-radius-sm)}.ct-preset-item{align-items:center;justify-content:space-between;padding:var(--ct-space-2) var(--ct-space-3);background:var(--ct-bg-secondary);transition:all var(--ct-transition-fast)}.ct-preset-item:hover{border-color:var(--ct-border);background:var(--ct-bg)}.ct-preset-item--builtin{opacity:.8}.ct-preset-info{display:flex;flex-direction:column;gap:var(--ct-space-1);min-width:0;flex:1}.ct-preset-name{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-sm);font-weight:500;color:var(--ct-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.ct-preset-stages{font-size:var(--ct-text-xs);color:var(--ct-text-dim)}.ct-preset-actions,.ct-presets-actions{display:flex;gap:var(--ct-space-1);flex-shrink:0}.ct-presets-actions{gap:var(--ct-space-2)}.ct-shortcuts-list{display:flex;flex-direction:column;gap:var(--ct-space-2)}.ct-shortcuts-list .ct-shortcut{display:flex;align-items:center;gap:var(--ct-space-2);font-size:var(--ct-text-sm)}.ct-shortcuts-list .ct-shortcut kbd{display:inline-flex;align-items:center;padding:.2em .5em;font-family:var(--ct-font);font-size:var(--ct-text-xs);background:var(--ct-bg-tertiary);border:1px solid var(--ct-border);border-radius:var(--ct-radius-sm)}.ct-shortcuts-list .ct-shortcut span{color:var(--ct-text-muted)}.ct-debug-actions{display:flex;flex-wrap:wrap;gap:var(--ct-space-2);margin-top:var(--ct-space-2)}.ct-panel-version{color:var(--SmartThemeEmColor,#999);font-size:.85em;margin-bottom:.5em}.ct-panel-desc{margin:0 0 1em;font-size:.9em;color:var(--SmartThemeBodyColor);line-height:1.4}.ct-panel-actions{display:flex;gap:.5em}@media (max-width:768px){.ct-popup .menu_button{min-height:44px;padding:var(--ct-space-3)}.ct-tab{min-height:44px}.ct-list-item{padding:var(--ct-space-4)}.ct-list-item__actions{opacity:1}}@media (prefers-reduced-motion:reduce){.ct-popup *,.ct-popup :after,.ct-popup :before{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}@media (prefers-contrast:high){.ct-popup{--ct-border:var(--ct-text);--ct-border-muted:var(--ct-text-muted)}}',""]);const s=o},825(t){t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(n){!function(t,e,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var a=void 0!==n.layer;a&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,a&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),e.styleTagTransform(r,t,e.options)}(e,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}}},e={};function n(r){var a=e[r];if(void 0!==a)return a.exports;var i=e[r]={id:r,exports:{}};return t[r](i,i.exports,n),i.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.nc=void 0;var r=n(72),a=n.n(r),i=n(825),o=n.n(i),s=n(659),c=n.n(s),l=n(56),d=n.n(l),p=n(540),u=n.n(p),f=n(113),v=n.n(f),m=n(805),g={};g.styleTagTransform=v(),g.setAttributes=d(),g.insert=c().bind(null,"head"),g.domAPI=o(),g.insertStyleElement=u();a()(m.A,g);m.A&&m.A.locals&&m.A.locals;var h=n(319),b=n(737),y=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};var _=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function x(t){return _(this,void 0,void 0,function*(){const e=SillyTavern.getContext(),n=e.characters||[],r=n.findIndex(e=>e.avatar===t.avatar);if(-1===r)return h.Rm.debug("Character not found in ST array, using provided data"),t;const a=n[r];return a.shallow&&"function"==typeof e.unshallowCharacter?(h.Rm.debug(`Unshallowing character: ${t.name}`),yield e.unshallowCharacter(r),n[r]):a})}function w(t,e){const n=t;let r=$(n,e);if(void 0===r&&e.startsWith("data.")){const t=e.replace(/^data\./,"").replace(/^extensions\./,"");r=$(n,t),void 0===r&&t in n&&(r=n[t])}if(void 0===r&&e.startsWith("data.extensions.")){r=$(n,`extensions.${e.replace("data.extensions.","")}`)}return r}function $(t,e){return e.split(".").reduce((t,e)=>{if(t&&"object"==typeof t)return t[e]},t)}function k(t,e){if(null==t)return!1;switch(e){case"array":return Array.isArray(t)&&t.length>0;case"object":return"object"==typeof t&&("prompt"in t?"string"==typeof t.prompt&&t.prompt.trim().length>0:"entries"in t?Array.isArray(t.entries)&&t.entries.length>0:Object.keys(t).length>0);default:return"string"==typeof t&&t.trim().length>0}}function S(t,e){switch(e.type){case"array":return Array.isArray(t)?t.map((t,e)=>`${e+1}. ${String(t).trim()}`).join("\n"):"";case"object":return function(t,e){var n,r,a,i;if(!t||"object"!=typeof t)return"";if("depth_prompt"===e){const e=t;return(null===(n=e.prompt)||void 0===n?void 0:n.trim())?`[Depth: ${null!==(r=e.depth)&&void 0!==r?r:0}, Role: ${null!==(a=e.role)&&void 0!==a?a:"system"}]\n${e.prompt.trim()}`:""}if("character_book"===e){const e=t;if(!(null===(i=e.entries)||void 0===i?void 0:i.length))return"";const n=[];e.name&&n.push(`Lorebook: ${e.name}`),n.push(`Entries: ${e.entries.length}`);for(const t of e.entries.slice(0,10)){const e=t.enabled?"✓":"✗",r=t.comment||t.keys.slice(0,3).join(", ");n.push(`  ${e} ${r}`)}return e.entries.length>10&&n.push(`  ... and ${e.entries.length-10} more`),n.join("\n")}try{return JSON.stringify(t,null,2)}catch(t){return"[Complex Object]"}}(t,e.key);default:return"string"==typeof t?t.trim():String(t)}}function P(t){if(!t)return[];const e=[];for(const n of h.IF){const r=w(t,n.path);if(!k(r,n.type))continue;const a=S(r,n);a&&e.push({key:n.key,label:n.label,value:a,rawValue:r,charCount:a.length,type:n.type})}return e}function R(t,e){const n=P(t),r=[];for(const t of n){const n=e[t.key];if(n)if("alternate_greetings"===t.key&&Array.isArray(n)){const e=t.rawValue,a=n.filter(t=>t>=0&&t<e.length).map(t=>`**Greeting ${t+1}:**\n${e[t].trim()}`).join("\n\n");a&&r.push(`### ${t.label}\n\n${a}`)}else r.push(`### ${t.label}\n\n${t.value}`)}const a=r.length>0?r.join("\n\n"):"(No fields selected)";let i=`# CHARACTER: ${t.name}\n\n${a}`;return i=(0,h.$n)(i,t.name),i=(0,h.UH)(i),i}function C(t,e){const n=P(t),r={};for(const t of n)e[t.key]&&(r[t.key]=t.value);return r}var T=n(179),z=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function O(t,e){return z(this,arguments,void 0,function*(t,e,n={}){var r,a,i,o;const{signal:s,onProgress:c}=n,l=Date.now(),d=function(t,e){var n;const r=[];"analyze"===t.stage?(r.push("## ORIGINAL CHARACTER\n\n"),r.push(R(t.character,t.selection)),t.previousResults.score&&r.push("\n\n---\n\n## SCORE RESULTS\n\n"+t.previousResults.score.output),t.previousResults.rewrite&&r.push("\n\n---\n\n## REWRITTEN VERSION\n\n"+t.previousResults.rewrite.output)):(r.push(R(t.character,t.selection)),"rewrite"===t.stage&&(t.previousResults.score&&r.push("\n\n---\n\n## SCORE RESULTS\n\n"+t.previousResults.score.output),t.isRefinement&&t.previousResults.analyze&&r.push("\n\n---\n\n## ANALYSIS FEEDBACK\n\n"+t.previousResults.analyze.output))),(null===(n=t.guidance)||void 0===n?void 0:n.trim())&&r.push("\n\n---\n\n## USER GUIDANCE\n\n"+t.guidance.trim()),t.iterationCount>0&&r.push(`\n\n---\n\n*Refinement iteration ${t.iterationCount+1}*`);const a=function(t,e){if(t.customPrompt.trim())return t.customPrompt.trim();if(t.promptPresetId){const n=e.getPromptPreset(t.promptPresetId);if(n)return n.prompt}return""}(t.config,e);return a&&r.push("\n\n---\n\n## INSTRUCTIONS\n\n"+a),r.join("")}(t,e),p=function(t,e,n){return e?n.getRefinementPrompt():n.getSystemPrompt(t)}(t.stage,null!==(r=t.isRefinement)&&void 0!==r&&r,e),u=function(t,e){if(!t.useStructuredOutput)return null;if(t.customSchema.trim())try{return JSON.parse(t.customSchema)}catch(t){return null}if(t.schemaPresetId){const n=e.getSchemaPreset(t.schemaPresetId);if(n)return n.schema}return null}(t.config,e);if(null==c||c(`Running ${t.stage}...`),null==s?void 0:s.aborted)return{stage:t.stage,timestamp:l,input:d,output:"",guidance:t.guidance,error:"Aborted"};const f=yield(0,T.generate)({prompt:d,systemPrompt:p,jsonSchema:null!==(a=u)&&void 0!==a?a:void 0,signal:s});return f.success?{stage:t.stage,timestamp:l,input:d,output:null!==(o=f.response)&&void 0!==o?o:"",guidance:t.guidance}:(h.Rm.error(`Stage ${t.stage} failed`,f.error),{stage:t.stage,timestamp:l,input:d,output:"",guidance:t.guidance,error:null!==(i=f.error)&&void 0!==i?i:"Generation failed"})})}var E=n(374),A=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};var j=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let W=null;const N=function(t,e){const n=SillyTavern.libs.lodash,r=()=>y(this,void 0,void 0,function*(){const r=t();if(!(null==r?void 0:r.activeSessionId)||!r.character)return;const a=yield(0,b.getSession)(r.activeSessionId);a&&(a.stageFields=n.cloneDeep(r.stageFields),a.configs=n.cloneDeep(r.stageConfigs),a.stageResults=n.cloneDeep(r.stageResults),a.history=n.cloneDeep(r.iterationHistory),a.iterationCount=r.iterationCount,a.userGuidance=r.userGuidance||void 0,yield(0,b.updateSession)(a),e(!1))}),a=n.debounce(()=>{r()},1e3);return{trigger:a,save:r,cancel:()=>a.cancel(),flush:()=>y(this,void 0,void 0,function*(){a.cancel(),yield r()})}}(()=>W,t=>{W&&(W.hasUnsavedChanges=t)});function I(){return W={character:null,selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}},activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},stageResults:{score:null,rewrite:null,analyze:null},stageConfigs:{score:(0,b.getStageDefaults)("score"),rewrite:(0,b.getStageDefaults)("rewrite"),analyze:(0,b.getStageDefaults)("analyze")},activeStage:"score",iterationCount:0,iterationHistory:[],userGuidance:"",isGenerating:!1,abortController:null,searchQuery:"",searchResults:[],searchSelectedIndex:-1,dropdownOpen:!1,sessionListExpanded:!1,historyExpanded:!0,viewingHistoryIndex:null},W}function D(){if(!W)throw new Error("State not initialized");return W}function L(){return W}function M(){N.cancel(),W=null}function F(){const t=L();t&&(t.hasUnsavedChanges=!0,N.trigger())}function B(){return j(this,void 0,void 0,function*(){yield N.flush()})}function H(t){return j(this,void 0,void 0,function*(){yield function(t,e,n){return A(this,void 0,void 0,function*(){if(yield n(),t.character=e,t.selectedFields={},t.stageFields={base:{},linked:!0,overrides:{}},t.activeSessionId=null,t.sessions=[],t.sessionsLoaded=!1,t.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},t.stageResults={score:null,rewrite:null,analyze:null},t.iterationCount=0,t.iterationHistory=[],t.hasUnsavedChanges=!1,e){try{t.character=yield x(e),h.Rm.debug(`Character loaded: ${t.character.name}`)}catch(n){h.Rm.error("Failed to unshallow character",n),t.character=e}if(t.sessions=yield(0,b.getSessionsForCharacter)(e.avatar),t.sessionsLoaded=!0,t.sessions.length>0){const e=t.sessions[0],n=SillyTavern.libs.lodash;if(t.activeSessionId=e.id,t.stageFields=n.cloneDeep(e.stageFields),t.selectedFields=n.cloneDeep(e.stageFields.base),t.stageConfigs=n.cloneDeep(e.configs),t.iterationHistory=n.cloneDeep(e.history),t.iterationCount=e.iterationCount,t.userGuidance=e.userGuidance||"",e.stageResults)t.stageResults=n.cloneDeep(e.stageResults);else for(const n of e.history)t.stageResults[n.stage]=n;for(const e of h.an)t.stageStatus[e]=t.stageResults[e]?t.stageResults[e].error?"error":"complete":"pending";h.Rm.debug(`Loaded most recent session: ${e.id}`),h.oR.info("Resumed session"+(e.name?`: ${e.name}`:""))}else{const e=C(t.character,t.stageFields.base),n=yield(0,b.createSession)({characterId:t.character.avatar,characterName:t.character.name,stageFields:t.stageFields,originalData:e,configs:t.stageConfigs});t.sessions.unshift(n),t.activeSessionId=n.id,h.Rm.debug(`Auto-created new session: ${n.id}`),h.oR.info("New session started")}}})}(D(),t,B)})}function G(){return j(this,void 0,void 0,function*(){return function(t,e){return A(this,void 0,void 0,function*(){if(!t.character)return null;yield e();const n=C(t.character,t.stageFields.base),r=yield(0,b.createSession)({characterId:t.character.avatar,characterName:t.character.name,stageFields:t.stageFields,originalData:n,configs:t.stageConfigs});return t.sessions.unshift(r),t.activeSessionId=r.id,t.iterationCount=0,t.iterationHistory=[],t.stageResults={score:null,rewrite:null,analyze:null},t.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},t.hasUnsavedChanges=!1,r})}(D(),B)})}function U(t){return j(this,void 0,void 0,function*(){return function(t,e,n){return A(this,void 0,void 0,function*(){var r;yield n();const a=yield(0,b.getSession)(e);if(!a)return!1;if((null===(r=t.character)||void 0===r?void 0:r.avatar)!==a.characterId){const e=SillyTavern.getContext().characters.find(t=>t.avatar===a.characterId);if(!e)return!1;t.character=e}const i=SillyTavern.libs.lodash;if(t.activeSessionId=a.id,t.stageFields=i.cloneDeep(a.stageFields),t.selectedFields=i.cloneDeep(a.stageFields.base),t.stageConfigs=i.cloneDeep(a.configs),t.iterationHistory=i.cloneDeep(a.history),t.iterationCount=a.iterationCount,t.userGuidance=a.userGuidance||"",t.hasUnsavedChanges=!1,a.stageResults)t.stageResults=i.cloneDeep(a.stageResults);else{t.stageResults={score:null,rewrite:null,analyze:null};for(const e of a.history)t.stageResults[e.stage]=e}for(const e of h.an)t.stageStatus[e]=t.stageResults[e]?t.stageResults[e].error?"error":"complete":"pending";return!0})}(D(),t,B)})}function q(t){return j(this,void 0,void 0,function*(){return function(t,e){return A(this,void 0,void 0,function*(){yield(0,b.deleteSession)(e);const n=t.sessions.findIndex(t=>t.id===e);-1!==n&&t.sessions.splice(n,1),t.activeSessionId===e&&(t.activeSessionId=null,t.iterationHistory=[],t.iterationCount=0,t.stageResults={score:null,rewrite:null,analyze:null},t.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"})})}(D(),t)})}function J(t,e){return j(this,void 0,void 0,function*(){const r=D().sessions.find(e=>e.id===t);if(!r)return;r.name=e.trim()||void 0,r.updatedAt=Date.now();const{updateSession:a}=yield Promise.resolve().then(n.bind(n,737));yield a(r)})}function V(t){var e;const n=D(),r=null!=t?t:n.activeStage;return n.stageFields.linked?n.stageFields.base:null!==(e=n.stageFields.overrides[r])&&void 0!==e?e:n.stageFields.base}function Y(){return V()}function Q(){return D().stageFields.linked}function K(t,e){var n,r,a;const i=D(),o=i.stageFields.linked?i.stageFields.base:null!==(n=(r=i.stageFields.overrides)[a=i.activeStage])&&void 0!==n?n:r[a]={};!1===e||Array.isArray(e)&&0===e.length?delete o[t]:o[t]=e,i.selectedFields=Object.assign({},o),F()}function X(t){D().activeStage=t}function Z(t,e){const n=D();Object.assign(n.stageConfigs[t],e),F()}function tt(t){const e=D();null!==t&&(t<0||t>=e.iterationHistory.length)||(e.viewingHistoryIndex=t)}function et(t){const e=D(),n=null!=t?t:e.viewingHistoryIndex;if(null===n||n<0||n>=e.iterationHistory.length)return;const r=e.iterationHistory[n];e.stageResults[r.stage]=r,e.stageStatus[r.stage]=r.error?"error":"complete",e.viewingHistoryIndex=null,F()}var nt=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};const rt={getPromptPreset:b.getPromptPreset,getSchemaPreset:b.getSchemaPreset,getSystemPrompt:b.getSystemPrompt,getRefinementPrompt:b.getRefinementPrompt};function at(t,e,n){t.stageStatus[e]=n}function it(t,e,n){t.isGenerating=e,t.abortController=e?null!=n?n:new AbortController:null,e?h.wG.show():h.wG.hide()}function ot(t,e){t.stageResults[e.stage]=e,t.stageStatus[e.stage]=e.error?"error":"complete",t.iterationHistory.push(e),t.hasUnsavedChanges=!0}function st(t,e){return t.character?{character:t.character,selection:V(e),stage:e,config:t.stageConfigs[e],previousResults:t.stageResults,iterationCount:t.iterationCount,guidance:t.userGuidance||void 0}:null}function ct(t,e=document){return e.querySelector(t)}function lt(t,e=document){return Array.from(e.querySelectorAll(t))}function dt(t,e,n,r){return t?(t.addEventListener(e,n,r),()=>{t.removeEventListener(e,n,r)}):()=>{}}function pt(t){return void 0===t?"...":null===t?"—":t>=1e3?`${(t/1e3).toFixed(1)}k`:t.toString()}function ut(t,e){return t.length<=e?t:t.slice(0,e-1)+"…"}function ft(...t){return t.filter(Boolean).join(" ")}const vt=new Map;let mt=new Set,gt=!1;function ht(t,e,n){return vt.set(t,{fn:e,categories:n}),()=>vt.delete(t)}function bt(...t){for(const e of t)mt.add(e);gt||(gt=!0,queueMicrotask(yt))}function yt(){if(gt=!1,0===mt.size)return;const t=mt;mt=new Set;const e=t.has("all");for(const n of vt.values())if(e||n.categories.some(e=>t.has(e)))try{n.fn()}catch(t){console.error("[UpdateCoordinator] Update failed:",t)}}function _t(){bt("character","session","fields","config","results","pipeline")}function xt(){bt("session","fields","config","results","pipeline","stage")}var wt=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function $t(){return SillyTavern.getContext().characters||[]}let kt=null;function St(){kt=null}let Pt=!1,Rt="",Ct=-1;function Tt(t){Pt=t;const e=ct(`#${h.pW}_char_dropdown`);e&&e.classList.toggle("ct-dropdown--open",t),t||(Ct=-1)}function zt(){const t=Rt.trim();if(!t)return $t().slice(0,30);return function(){var t;const e=$t();if(!kt||(null===(t=kt._docs)||void 0===t?void 0:t.length)!==e.length){const t=SillyTavern.libs.Fuse;kt=new t(e,{keys:[{name:"name",weight:3},{name:"description",weight:1}],threshold:.3,includeScore:!0,minMatchCharLength:2,ignoreLocation:!0})}return kt}().search(t).map(t=>t.item).slice(0,20)}function Ot(){var t;const e=D(),n=zt(),r=null===(t=e.character)||void 0===t?void 0:t.avatar;return 0===n.length?`\n            <div class="ct-dropdown__empty">\n                <i class="fa-solid ${Rt?"fa-search":"fa-users-slash"}"></i>\n                ${Rt?`No matches for "${ut(Rt,20)}"`:"No characters available"}\n            </div>\n        `:n.map((t,e)=>function(t,e,n){var r,a;const i=SillyTavern.libs.DOMPurify,o=SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar),s=P(t).length,c=ut((t.description||"").replace(/\n/g," "),60),l=(null===(r=t.data)||void 0===r?void 0:r.creator)||"",d=(null===(a=t.data)||void 0===a?void 0:a.character_version)||"",p=[];return l&&p.push(l),d&&p.push(`v${d}`),0===p.length&&p.push(`${s} ${1===s?"field":"fields"}`),`\n        <div class="ct-char-option ${n?"ct-char-option--selected":""} ${e===Ct?"ct-char-option--highlighted":""}"\n             data-avatar="${i.sanitize(t.avatar)}"\n             data-index="${e}"\n             role="option"\n             aria-selected="${n}">\n            <div class="ct-char-option__avatar-wrap">\n                <img class="ct-char-option__avatar"\n                     src="${o}"\n                     alt=""\n                     onerror="this.src='/img/ai4.png'"\n                     loading="lazy" />\n                ${n?'<i class="fa-solid fa-check ct-char-option__check"></i>':""}\n            </div>\n            <div class="ct-char-option__info">\n                <span class="ct-char-option__name">${i.sanitize(t.name)}</span>\n                ${c?`<span class="ct-char-option__desc">${i.sanitize(c)}</span>`:""}\n                <span class="ct-char-option__meta">\n                    <i class="fa-solid fa-user-pen"></i>\n                    ${i.sanitize(p.join(" • "))}\n                </span>\n            </div>\n        </div>\n    `}(t,e,t.avatar===r)).join("")}function Et(){if(!ct(`#${h.pW}_char_dropdown`))return;const t=SillyTavern.libs.DOMPurify,e=D().character,n=ct(`#${h.pW}_char_trigger`);if(n){const r=e?t.sanitize(e.name):"Select character...",a=e?`<img class="ct-dropdown__trigger-avatar"\n                   src="${SillyTavern.getContext().getThumbnailUrl("avatar",e.avatar)}"\n                   alt=""\n                   onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user ct-dropdown__trigger-icon"></i>';n.innerHTML=`\n            ${a}\n            <span class="ct-dropdown__trigger-text ${e?"":"ct-dropdown__trigger-text--placeholder"}">${r}</span>\n            <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n        `}const r=ct(`#${h.pW}_char_list`);r&&(r.innerHTML=Ot())}function At(t){t.forEach((t,e)=>{t.classList.toggle("ct-char-option--highlighted",e===Ct),e===Ct&&t.scrollIntoView({block:"nearest"})})}function jt(t){return wt(this,void 0,void 0,function*(){const e=t.dataset.avatar;if(!e)return;const n=$t().find(t=>t.avatar===e);n&&(yield H(n),Rt="",Tt(!1),_t())})}var Wt=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let Nt={isOpen:!1,type:"prompt",mode:"create",preset:null,activeTab:"edit"},It={},Dt=[];function Lt(){return`\n        <div id="${h.pW}_preset_drawer" class="ct-drawer" aria-hidden="true">\n            <div class="ct-drawer__backdrop"></div>\n            <aside class="ct-drawer__panel" role="dialog" aria-label="Preset Editor">\n                <div class="ct-drawer__content">\n                    ${Mt()}\n                    ${Ft()}\n                    ${Bt()}\n                </div>\n            </aside>\n        </div>\n    `}function Mt(){const{type:t,mode:e,preset:n}=Nt;let r="",a="";return"create"===e?(r=`New ${"prompt"===t?"Prompt":"Schema"} Preset`,a="fa-plus"):"edit"===e?(r=`Edit ${"prompt"===t?"Prompt":"Schema"} Preset`,a="fa-pen"):(r=`Duplicate ${"prompt"===t?"Prompt":"Schema"} Preset`,a="fa-copy"),`\n        <header class="ct-drawer__header">\n            <div class="ct-drawer__title">\n                <i class="fa-solid ${a} ct-text-accent"></i>\n                <h3>${r}</h3>\n                ${(null==n?void 0:n.isBuiltin)?'<span class="ct-badge ct-badge--info ct-badge--small">builtin</span>':""}\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n    `}function Ft(){const{type:t,mode:e,preset:n}=Nt;return`\n        <div class="ct-drawer__body ct-scrollable">\n            ${"duplicate"===e&&(null==n?void 0:n.isBuiltin)?'\n                <div class="ct-alert ct-alert--info ct-mb-3">\n                    <i class="fa-solid fa-circle-info ct-alert__icon"></i>\n                    <div class="ct-alert__content">\n                        <div class="ct-alert__message">\n                            Builtin presets cannot be modified. You\'re creating an editable copy.\n                        </div>\n                    </div>\n                </div>\n            ':""}\n            ${function(){const{preset:t,mode:e}=Nt,n=SillyTavern.libs.DOMPurify;let r="";t&&(r="duplicate"===e?`${t.name} (Copy)`:t.name);return`\n        <div class="ct-form-group">\n            <label class="ct-label" for="${h.pW}_drawer_name">\n                Name <span class="ct-required">*</span>\n            </label>\n            <input type="text"\n                   id="${h.pW}_drawer_name"\n                   class="ct-input text_pole"\n                   value="${n.sanitize(r)}"\n                   placeholder="Enter preset name..."\n                   maxlength="100"\n                   autocomplete="off" />\n        </div>\n    `}()}\n            ${function(){const{preset:t}=Nt,e=(null==t?void 0:t.stages)||[];return`\n        <div class="ct-form-group">\n            <label class="ct-label">\n                Applicable Stages\n                <span class="ct-hint ct-text-dim">(empty = all stages)</span>\n            </label>\n            <div class="ct-stage-chips">\n                ${h.an.map(t=>`\n                    <label class="ct-chip ${0===e.length||e.includes(t)?"ct-chip--active":""}">\n                        <input type="checkbox"\n                               name="drawer_stages"\n                               value="${t}"\n                               ${0===e.length||e.includes(t)?"checked":""} />\n                        <span>${h.BA[t]}</span>\n                    </label>\n                `).join("")}\n            </div>\n        </div>\n    `}()}\n            ${"prompt"===t?function(){const{preset:t}=Nt,e=SillyTavern.libs.DOMPurify,n=(null==t?void 0:t.prompt)||"";return`\n        <div class="ct-form-group ct-form-group--grow">\n            <div class="ct-row ct-row--between">\n                <label class="ct-label" for="${h.pW}_drawer_prompt">\n                    Prompt Template <span class="ct-required">*</span>\n                </label>\n                <div class="ct-row ct-gap-1">\n                    <button id="${h.pW}_drawer_prompt_vars"\n                            class="menu_button menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="View available variables">\n                        <i class="fa-solid fa-code"></i>\n                        Variables\n                    </button>\n                </div>\n            </div>\n            <div class="ct-editor-wrap">\n                <textarea id="${h.pW}_drawer_prompt"\n                          class="ct-textarea ct-textarea--editor text_pole"\n                          placeholder="Enter your prompt template...\n\nUse {{character}} for character data, {{field_name}} for specific fields.\nThe prompt will be sent to the LLM along with the selected character fields."\n                          spellcheck="false">${e.sanitize(n)}</textarea>\n            </div>\n            <div class="ct-form-group__hint ct-row ct-row--between">\n                <span id="${h.pW}_drawer_prompt_tokens" class="ct-text-dim">Calculating tokens...</span>\n            </div>\n        </div>\n    `}():function(){const{preset:t}=Nt,e=SillyTavern.libs.DOMPurify;let n="";t&&"schema"in t&&(n="string"==typeof t.schema?t.schema:JSON.stringify(t.schema,null,2));return`\n        <div class="ct-form-group ct-form-group--grow">\n            <div class="ct-row ct-row--between">\n                <label class="ct-label" for="${h.pW}_drawer_schema">\n                    JSON Schema <span class="ct-required">*</span>\n                </label>\n            </div>\n\n            \x3c!-- Schema Toolbar --\x3e\n            <div class="ct-editor-toolbar">\n                <button id="${h.pW}_drawer_generate"\n                        class="menu_button menu_button--sm menu_button--primary"\n                        type="button"\n                        title="Generate schema from description using AI">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    AI Generate\n                </button>\n                <div class="ct-toolbar-divider"></div>\n                <button id="${h.pW}_drawer_validate"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Validate JSON schema">\n                    <i class="fa-solid fa-check-circle"></i>\n                    Validate\n                </button>\n                <button id="${h.pW}_drawer_format"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Format JSON">\n                    <i class="fa-solid fa-align-left"></i>\n                    Format\n                </button>\n                <button id="${h.pW}_drawer_minify"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Minify JSON">\n                    <i class="fa-solid fa-compress"></i>\n                </button>\n            </div>\n\n            \x3c!-- Schema Editor with syntax highlighting --\x3e\n            <div class="ct-code-editor" id="${h.pW}_drawer_schema_wrap">\n                <pre class="ct-code-editor__highlight" id="${h.pW}_drawer_schema_highlight" aria-hidden="true"><code class="language-json"></code></pre>\n                <textarea id="${h.pW}_drawer_schema"\n                          class="ct-code-editor__textarea ct-textarea--code text_pole"\n                          placeholder='{"name": "MySchema", "strict": true, "schema": {...}}'\n                          spellcheck="false">${e.sanitize(n)}</textarea>\n            </div>\n\n            \x3c!-- Validation messages --\x3e\n            <div id="${h.pW}_drawer_errors" class="ct-errors ct-hidden"></div>\n            <div id="${h.pW}_drawer_warnings" class="ct-warnings ct-hidden"></div>\n        </div>\n    `}()}\n        </div>\n    `}function Bt(){const{mode:t,preset:e}=Nt,n=(null==e?void 0:e.isBuiltin)||!1,r="create"===t?"Create Preset":"edit"===t?"Save Changes":"Create Copy";return`\n        <footer class="ct-drawer__footer">\n            <div class="ct-row ct-row--between ct-flex-1">\n                <div class="ct-row">\n                    ${e&&!n&&"edit"===t?`\n                        <button id="${h.pW}_drawer_delete"\n                                class="menu_button menu_button--danger"\n                                type="button">\n                            <i class="fa-solid fa-trash"></i>\n                            Delete\n                        </button>\n                    `:""}\n                </div>\n                <div class="ct-row ct-gap-2">\n                    <button id="${h.pW}_drawer_cancel"\n                            class="menu_button"\n                            type="button">\n                        Cancel\n                    </button>\n                    <button id="${h.pW}_drawer_save"\n                            class="menu_button menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-check"></i>\n                        ${r}\n                    </button>\n                </div>\n            </div>\n        </footer>\n    `}function Ht(){const{type:t}=Nt,e=[..."prompt"===t?b.presetRegistry.getPromptPresets():b.presetRegistry.getSchemaPresets()].sort((t,e)=>t.isBuiltin!==e.isBuiltin?t.isBuiltin?1:-1:t.name.localeCompare(e.name)),n=e.filter(t=>!t.isBuiltin).length,r=e.filter(t=>t.isBuiltin).length;return`\n        <div class="ct-drawer__body ct-drawer__body--list">\n            ${0===e.length?`\n                <div class="ct-empty ct-empty--compact">\n                    <i class="fa-solid fa-bookmark ct-empty__icon"></i>\n                    <div class="ct-empty__title">No ${t} presets</div>\n                    <div class="ct-empty__text">Create one to get started</div>\n                </div>\n            `:`\n                <div class="ct-preset-list ct-scrollable">\n                    ${n>0?'<div class="ct-preset-list__section-label">Custom</div>':""}\n                    ${e.filter(t=>!t.isBuiltin).map(e=>Gt(e,t)).join("")}\n                    ${r>0?'<div class="ct-preset-list__section-label">Built-in</div>':""}\n                    ${e.filter(t=>t.isBuiltin).map(e=>Gt(e,t)).join("")}\n                </div>\n            `}\n        </div>\n    `}function Gt(t,e){const n=SillyTavern.libs.DOMPurify,r=t.stages.length>0?t.stages.map(t=>h.BA[t]).join(", "):"All stages";return`\n        <div class="ct-preset-list__item ${t.isBuiltin?"ct-preset-list__item--builtin":""}"\n             data-id="${t.id}"\n             data-type="${e}">\n            <button class="ct-preset-list__select" type="button" title="Apply this preset">\n                <div class="ct-preset-list__info">\n                    <span class="ct-preset-list__name">\n                        ${t.isBuiltin?'<i class="fa-solid fa-lock ct-text-dim"></i>':""}\n                        ${n.sanitize(t.name)}\n                    </span>\n                    <span class="ct-preset-list__stages">${r}</span>\n                </div>\n            </button>\n            <div class="ct-preset-list__actions">\n                ${t.isBuiltin?"":'\n                    <button class="ct-preset-list__action ct-preset-list__action--edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Edit">\n                        <i class="fa-solid fa-pen"></i>\n                    </button>\n                '}\n                <button class="ct-preset-list__action ct-preset-list__action--duplicate menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        type="button" title="${t.isBuiltin?"Create editable copy":"Duplicate"}">\n                    <i class="fa-solid fa-copy"></i>\n                </button>\n                ${t.isBuiltin?"":'\n                    <button class="ct-preset-list__action ct-preset-list__action--delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                '}\n            </div>\n        </div>\n    `}function Ut(t,e){Nt={isOpen:!0,type:t,mode:"list",preset:null,activeTab:"edit"},It=e||{},Jt()}function qt(){const t=ct(`#${h.pW}_preset_drawer`);t&&(t.classList.remove("ct-drawer--open"),t.setAttribute("aria-hidden","true"),setTimeout(()=>{var t;Dt.forEach(t=>t()),Dt=[],Nt.isOpen=!1,null===(t=It.onClose)||void 0===t||t.call(It)},300))}function Jt(){const t=ct(`#${h.pW}_preset_drawer`);if(!t)return void h.Rm.error("Drawer not initialized");const e=ct(".ct-drawer__panel",t);e&&("list"===Nt.mode?e.innerHTML=`\n                <div class="ct-drawer__content ct-drawer__content--list">\n                    ${function(){const{type:t}=Nt;return`\n        <header class="ct-drawer__header">\n            <div class="ct-drawer__title">\n                <i class="fa-solid fa-bookmark ct-text-accent"></i>\n                <h3>Manage Presets</h3>\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n        <div class="ct-drawer__tabs">\n            <button class="ct-drawer__tab ${"prompt"===t?"ct-drawer__tab--active":""}"\n                    data-tab="prompt" type="button">\n                <i class="fa-solid fa-message"></i>\n                Prompts\n            </button>\n            <button class="ct-drawer__tab ${"schema"===t?"ct-drawer__tab--active":""}"\n                    data-tab="schema" type="button">\n                <i class="fa-solid fa-code"></i>\n                Schemas\n            </button>\n        </div>\n    `}()}\n                    ${Ht()}\n                    \n        <footer class="ct-drawer__footer ct-drawer__footer--list">\n            <button id="${h.pW}_drawer_list_create"\n                    class="menu_button menu_button--primary"\n                    type="button">\n                <i class="fa-solid fa-plus"></i>\n                New Preset\n            </button>\n            <div class="ct-row ct-gap-2">\n                <button id="${h.pW}_drawer_list_import"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Import presets from file">\n                    <i class="fa-solid fa-file-import"></i>\n                </button>\n                <button id="${h.pW}_drawer_list_export"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Export custom presets">\n                    <i class="fa-solid fa-file-export"></i>\n                </button>\n            </div>\n        </footer>\n    \n                </div>\n            `:e.innerHTML=`\n                <div class="ct-drawer__content">\n                    ${Mt()}\n                    ${Ft()}\n                    ${Bt()}\n                </div>\n            `),"list"===Nt.mode?function(t){const e=ct(`#${h.pW}_drawer_close`,t);e&&Dt.push(dt(e,"click",qt));const n=ct(".ct-drawer__backdrop",t);n&&Dt.push(dt(n,"click",qt));const r=lt(".ct-drawer__tab",t);for(const e of r)Dt.push(dt(e,"click",()=>{const n=e.dataset.tab;if(n===Nt.type)return;Nt.type=n,r.forEach(t=>t.classList.remove("ct-drawer__tab--active")),e.classList.add("ct-drawer__tab--active");const a=ct(".ct-drawer__body--list",t);a&&(a.outerHTML=Ht())}));const a=ct(".ct-preset-list",t);a&&Dt.push(dt(a,"click",e=>Wt(this,void 0,void 0,function*(){var n,r;const a=e.target,i=a.closest(".ct-preset-list__item");if(!i)return;const o=i.dataset.id,s=i.dataset.type;if(!o||!s)return;const c="prompt"===s?b.presetRegistry.getPromptPreset(o):b.presetRegistry.getSchemaPreset(o);if(c){if(a.closest(".ct-preset-list__select"))return null===(n=It.onSelect)||void 0===n||n.call(It,c),void qt();if(a.closest(".ct-preset-list__action--edit"))!function(t,e){const n="prompt"===t?b.presetRegistry.getPromptPreset(e):b.presetRegistry.getSchemaPreset(e);if(!n)return;Dt.forEach(t=>t()),Dt=[],Nt.mode="edit",Nt.type=t,Nt.preset=n;const r=ct(`#${h.pW}_preset_drawer`);if(!r)return;const a=ct(".ct-drawer__panel",r);a&&(a.innerHTML=`\n            <div class="ct-drawer__content">\n                ${Mt()}\n                ${Ft()}\n                ${Bt()}\n            </div>\n        `);Vt(r);const i=ct(`#${h.pW}_drawer_name`,r);i&&(i.focus(),i.select());"schema"===t&&Yt()}(s,o);else if(a.closest(".ct-preset-list__action--duplicate"))!function(t,e){const n="prompt"===t?b.presetRegistry.getPromptPreset(e):b.presetRegistry.getSchemaPreset(e);if(!n)return;Dt.forEach(t=>t()),Dt=[],Nt.mode="duplicate",Nt.type=t,Nt.preset=n;const r=ct(`#${h.pW}_preset_drawer`);if(!r)return;const a=ct(".ct-drawer__panel",r);a&&(a.innerHTML=`\n            <div class="ct-drawer__content">\n                ${Mt()}\n                ${Ft()}\n                ${Bt()}\n            </div>\n        `);Vt(r);const i=ct(`#${h.pW}_drawer_name`,r);i&&(i.focus(),i.select());"schema"===t&&Yt()}(s,o);else if(a.closest(".ct-preset-list__action--delete")){if(!(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${c.name}"?`)))return;"prompt"===s?b.presetRegistry.deletePromptPreset(o):b.presetRegistry.deleteSchemaPreset(o),h.oR.success("Preset deleted"),null===(r=It.onUpdate)||void 0===r||r.call(It),Zt(t)}}})));const i=ct(`#${h.pW}_drawer_list_create`,t);i&&Dt.push(dt(i,"click",()=>{!function(t){Dt.forEach(t=>t()),Dt=[],Nt.mode="create",Nt.type=t,Nt.preset=null;const e=ct(`#${h.pW}_preset_drawer`);if(!e)return;const n=ct(".ct-drawer__panel",e);n&&(n.innerHTML=`\n            <div class="ct-drawer__content">\n                ${Mt()}\n                ${Ft()}\n                ${Bt()}\n            </div>\n        `);Vt(e);const r=ct(`#${h.pW}_drawer_name`,e);r&&r.focus()}(Nt.type)}));const o=ct(`#${h.pW}_drawer_list_import`,t);o&&Dt.push(dt(o,"click",te));const s=ct(`#${h.pW}_drawer_list_export`,t);s&&Dt.push(dt(s,"click",ee));const c=t=>{"Escape"===t.key&&Nt.isOpen&&(t.preventDefault(),t.stopPropagation(),qt())};document.addEventListener("keydown",c),Dt.push(()=>document.removeEventListener("keydown",c))}(t):Vt(t),requestAnimationFrame(()=>{if(t.classList.add("ct-drawer--open"),t.setAttribute("aria-hidden","false"),"list"!==Nt.mode){const e=ct(`#${h.pW}_drawer_name`,t);e&&(e.focus(),e.select()),"schema"===Nt.type&&Yt()}})}function Vt(t){const e=ct(`#${h.pW}_drawer_close`,t);e&&Dt.push(dt(e,"click",qt));const n=ct(".ct-drawer__backdrop",t);n&&Dt.push(dt(n,"click",qt));const r=ct(`#${h.pW}_drawer_cancel`,t);r&&Dt.push(dt(r,"click",qt));const a=ct(`#${h.pW}_drawer_save`,t);a&&Dt.push(dt(a,"click",Qt));const i=ct(`#${h.pW}_drawer_delete`,t);i&&Dt.push(dt(i,"click",Xt));const o=lt('.ct-chip input[name="drawer_stages"]',t);for(const t of o)Dt.push(dt(t,"change",()=>{const e=t.closest(".ct-chip");e&&e.classList.toggle("ct-chip--active",t.checked)}));"prompt"===Nt.type?function(t){const e=ct(`#${h.pW}_drawer_prompt`,t);if(e){const t=SillyTavern.libs.lodash.debounce(()=>Wt(this,void 0,void 0,function*(){const t=ct(`#${h.pW}_drawer_prompt_tokens`);if(!t)return;const n=e.value,r=Math.ceil(n.length/4);t.textContent=`~${r} tokens`}),300);Dt.push(dt(e,"input",()=>{t()})),t()}const n=ct(`#${h.pW}_drawer_prompt_vars`,t);n&&Dt.push(dt(n,"click",()=>Wt(this,void 0,void 0,function*(){yield h.lY.alert("Available Variables",'\n                    <div class="ct-stack">\n                        <p>Use these placeholders in your prompt:</p>\n                        <ul class="ct-list ct-text-sm">\n                            <li><code>{{character}}</code> - Full character summary</li>\n                            <li><code>{{name}}</code> - Character name</li>\n                            <li><code>{{description}}</code> - Character description</li>\n                            <li><code>{{personality}}</code> - Personality traits</li>\n                            <li><code>{{scenario}}</code> - Scenario/setting</li>\n                            <li><code>{{first_mes}}</code> - First message</li>\n                            <li><code>{{mes_example}}</code> - Example messages</li>\n                            <li><code>{{system_prompt}}</code> - System prompt</li>\n                            <li><code>{{creator_notes}}</code> - Creator notes</li>\n                        </ul>\n                    </div>\n                ')})))}(t):function(t){const e=ct(`#${h.pW}_drawer_schema`,t);if(e){const t=SillyTavern.libs.lodash.debounce(()=>{Yt()},100);Dt.push(dt(e,"input",()=>{t()})),Dt.push(dt(e,"scroll",()=>{!function(t){const e=ct(`#${h.pW}_drawer_schema_highlight`);e&&(e.scrollTop=t.scrollTop,e.scrollLeft=t.scrollLeft)}(e)}))}const n=ct(`#${h.pW}_drawer_generate`,t);n&&Dt.push(dt(n,"click",()=>Wt(this,void 0,void 0,function*(){const t=yield h.lY.input("Generate Schema","Describe the structure you want:","e.g., rating 1-10, list of strengths and weaknesses, summary paragraph");if(!t)return;n.setAttribute("disabled","true");const r=n.querySelector("i"),a=null==r?void 0:r.className;r&&(r.className="fa-solid fa-spinner fa-spin");try{const n=yield(0,E.nr)(t);n.success&&n.schema&&e?(e.value=n.schema,Yt(),h.oR.success("Schema generated"),function(){const t=ct(`#${h.pW}_drawer_errors`),e=ct(`#${h.pW}_drawer_warnings`);null==t||t.classList.add("ct-hidden"),null==e||e.classList.add("ct-hidden")}()):h.oR.error(n.error||"Generation failed")}catch(t){h.oR.error(`Failed: ${t.message}`)}finally{n.removeAttribute("disabled"),r&&a&&(r.className=a)}})));const r=ct(`#${h.pW}_drawer_validate`,t);r&&e&&Dt.push(dt(r,"click",()=>{!function(t){var e;const n=ct(`#${h.pW}_drawer_errors`),r=ct(`#${h.pW}_drawer_warnings`);n&&(t.valid?(n.classList.add("ct-hidden"),h.oR.success("Schema is valid")):(n.innerHTML=`<div class="ct-error"><i class="fa-solid fa-times-circle"></i> ${t.error}</div>`,n.classList.remove("ct-hidden")));r&&((null===(e=t.warnings)||void 0===e?void 0:e.length)?(r.innerHTML=t.warnings.map(t=>`<div class="ct-warning"><i class="fa-solid fa-exclamation-triangle"></i> ${t}</div>`).join(""),r.classList.remove("ct-hidden")):r.classList.add("ct-hidden"))}((0,E.i6)(e.value))}));const a=ct(`#${h.pW}_drawer_format`,t);a&&e&&Dt.push(dt(a,"click",()=>{try{const t=JSON.parse(e.value);e.value=(0,E.jf)(t),Yt(),h.oR.success("Formatted")}catch(t){h.oR.error(`Invalid JSON: ${t.message}`)}}));const i=ct(`#${h.pW}_drawer_minify`,t);i&&e&&Dt.push(dt(i,"click",()=>{try{const t=JSON.parse(e.value);e.value=JSON.stringify(t),Yt(),h.oR.success("Minified")}catch(t){h.oR.error(`Invalid JSON: ${t.message}`)}}))}(t);const s=t=>{"Escape"===t.key&&Nt.isOpen&&(t.preventDefault(),t.stopPropagation(),qt())};document.addEventListener("keydown",s),Dt.push(()=>document.removeEventListener("keydown",s))}function Yt(){const t=ct(`#${h.pW}_drawer_schema`),e=ct(`#${h.pW}_drawer_schema_highlight code`);if(!t||!e)return;const n=SillyTavern.libs.hljs,r=SillyTavern.libs.DOMPurify;try{const a=n.highlight(t.value||" ",{language:"json"});e.innerHTML=r.sanitize(a.value)}catch(n){e.textContent=t.value}}function Qt(){return Wt(this,void 0,void 0,function*(){var t,e;const{type:n,mode:r,preset:a}=Nt,i=ct(`#${h.pW}_drawer_name`),o=(null==i?void 0:i.value.trim())||"",s=lt('input[name="drawer_stages"]:checked'),c=Array.from(s).map(t=>t.value),l=c.length===h.an.length?[]:c;if("prompt"===n){const e=ct(`#${h.pW}_drawer_prompt`),n=(null==e?void 0:e.value)||"",i=(0,b.validatePromptPreset)({name:o,prompt:n,stages:l});if(!i.valid)return void Kt(i.errors);const s="edit"===r?null==a?void 0:a.id:void 0;if(!b.presetRegistry.isNameUnique("prompt",o,s))return void Kt(["A preset with this name already exists"]);let c;"edit"===r&&a?(b.presetRegistry.updatePromptPreset(a.id,{name:o,prompt:n,stages:l}),c=b.presetRegistry.getPromptPreset(a.id),h.oR.success("Preset updated")):(c=b.presetRegistry.registerPromptPreset({name:o,prompt:n,stages:l}),h.oR.success("Preset created")),null===(t=It.onSave)||void 0===t||t.call(It,c),qt()}else{const t=ct(`#${h.pW}_drawer_schema`),n=(null==t?void 0:t.value)||"";let i;try{i=JSON.parse(n)}catch(t){return void Kt([`Invalid JSON: ${t.message}`])}const s=(0,b.validateSchemaPreset)({name:o,schema:i,stages:l});if(!s.valid)return void Kt(s.errors);const c="edit"===r?null==a?void 0:a.id:void 0;if(!b.presetRegistry.isNameUnique("schema",o,c))return void Kt(["A preset with this name already exists"]);let d;"edit"===r&&a?(b.presetRegistry.updateSchemaPreset(a.id,{name:o,schema:i,stages:l}),d=b.presetRegistry.getSchemaPreset(a.id),h.oR.success("Schema preset updated")):(d=b.presetRegistry.registerSchemaPreset({name:o,schema:i,stages:l}),h.oR.success("Schema preset created")),null===(e=It.onSave)||void 0===e||e.call(It,d),qt()}})}function Kt(t){const e=ct(`#${h.pW}_drawer_errors`);e&&(e.innerHTML=t.map(t=>`<div class="ct-error"><i class="fa-solid fa-times-circle"></i> ${t}</div>`).join(""),e.classList.remove("ct-hidden"))}function Xt(){return Wt(this,void 0,void 0,function*(){const{type:t,preset:e}=Nt;if(!e)return;(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${e.name}"?`))&&("prompt"===t?b.presetRegistry.deletePromptPreset(e.id):b.presetRegistry.deleteSchemaPreset(e.id),h.oR.success("Preset deleted"),qt())})}function Zt(t){const e=ct(".ct-drawer__body--list",t);e&&(e.outerHTML=Ht())}function te(){return Wt(this,void 0,void 0,function*(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=t=>Wt(this,void 0,void 0,function*(){var e,n;const r=null===(e=t.target.files)||void 0===e?void 0:e[0];if(r)try{const t=yield r.text(),e=JSON.parse(t),a=(0,b.getSettings)();let i=0;if(Array.isArray(e.promptPresets))for(const t of e.promptPresets)t.isBuiltin||(t.id=crypto.randomUUID(),a.promptPresets.push(t),i++);if(Array.isArray(e.schemaPresets))for(const t of e.schemaPresets)t.isBuiltin||(t.id=crypto.randomUUID(),a.schemaPresets.push(t),i++);(0,b.save)(),h.oR.success(`Imported ${i} preset${1!==i?"s":""}`),null===(n=It.onUpdate)||void 0===n||n.call(It);const o=ct(`#${h.pW}_preset_drawer`);o&&"list"===Nt.mode&&Zt(o)}catch(t){h.oR.error("Failed to import presets"),console.error("Import error:",t)}}),t.click()})}function ee(){const t=(0,b.getSettings)(),e=t.promptPresets.filter(t=>!t.isBuiltin),n=t.schemaPresets.filter(t=>!t.isBuiltin);if(0===e.length&&0===n.length)return void h.oR.warning("No custom presets to export");const r={version:h.xv,exportedAt:(new Date).toISOString(),promptPresets:e,schemaPresets:n},a=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),o=document.createElement("a");o.href=i,o.download=`character-tools-presets-${(new Date).toISOString().slice(0,10)}.json`,o.click(),URL.revokeObjectURL(i),h.oR.success(`Exported ${e.length+n.length} preset${e.length+n.length!==1?"s":""}`)}var ne=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let re=[];function ae(){const t=D();if(!t.character)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-user-slash ct-empty__icon"></i>\n                <div class="ct-empty__title">No character selected</div>\n                <div class="ct-empty__text">Select a character to see available fields</div>\n            </div>\n        ';const e=P(t.character);return 0===e.length?'\n            <div class="ct-empty">\n                <i class="fa-solid fa-file-circle-question ct-empty__icon"></i>\n                <div class="ct-empty__title">No fields</div>\n                <div class="ct-empty__text">This character has no populated fields</div>\n            </div>\n        ':(requestAnimationFrame(()=>function(t){return ne(this,void 0,void 0,function*(){const e=t.filter(t=>"alternate_greetings"!==t.key).map(t=>({key:t.key,text:t.value}));if(0===e.length)return;const n=yield(0,h.gg)(e);for(const{key:t,tokens:e}of n){const n=ct(`.ct-field-tokens[data-field="${t}"]`);n&&(n.textContent=pt(e))}})}(e)),`\n        <div class="ct-field-list ct-scrollable">\n            ${e.map(t=>function(t){const e=SillyTavern.libs.DOMPurify,n=Y(),r=t.key in n&&!1!==n[t.key];if("alternate_greetings"===t.key&&Array.isArray(t.rawValue)){const r=t.rawValue,a=Array.isArray(n[t.key])?n[t.key]:[],i=a.length===r.length;return`\n            <div class="ct-field-group ct-field-group--expandable" data-field="${t.key}">\n                <div class="ct-field-item ct-field-item--parent">\n                    <label class="ct-field-label">\n                        <input type="checkbox"\n                               class="ct-field-checkbox ct-field-checkbox--parent"\n                               data-field="${t.key}"\n                               ${i?"checked":""}\n                               ${a.length>0&&!i?"indeterminate":""} />\n                        <span class="ct-field-name">${e.sanitize(t.label)}</span>\n                    </label>\n                    <span class="ct-field-count">${r.length} greetings</span>\n                    <button class="ct-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="ct-field-children">\n                    ${r.map((e,n)=>`\n                        <div class="ct-field-item ct-field-item--child">\n                            <label class="ct-field-label">\n                                <input type="checkbox"\n                                       class="ct-field-checkbox ct-field-checkbox--child"\n                                       data-field="${t.key}"\n                                       data-index="${n}"\n                                       ${a.includes(n)?"checked":""} />\n                                <span class="ct-field-name">Greeting ${n+1}</span>\n                            </label>\n                            <button class="ct-field-preview-btn" type="button" data-field="${t.key}" data-index="${n}" title="Preview greeting">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}const a=150,i=t.value.length>a?t.value.substring(0,a).trim()+"…":t.value;return`\n        <div class="ct-field-group ct-field-group--expandable" data-field="${t.key}">\n            <div class="ct-field-item ct-field-item--has-preview">\n                <label class="ct-field-label">\n                    <input type="checkbox"\n                           class="ct-field-checkbox"\n                           data-field="${t.key}"\n                           ${r?"checked":""} />\n                    <span class="ct-field-name">${e.sanitize(t.label)}</span>\n                </label>\n                <span class="ct-field-tokens" data-field="${t.key}">${pt(t.tokens)}</span>\n                <button class="ct-field-expand" type="button" aria-label="Expand field preview">\n                    <i class="fa-solid fa-chevron-down"></i>\n                </button>\n            </div>\n            <div class="ct-field-preview">\n                <pre class="ct-field-preview__text">${e.sanitize(i)}</pre>\n                <button class="ct-field-preview__more" type="button" data-field="${t.key}" title="View full content in popup">\n                    <i class="fa-solid fa-expand"></i>\n                    <span>View full content</span>\n                </button>\n            </div>\n        </div>\n    `}(t)).join("")}\n        </div>\n    `)}function ie(t,e,n){const r=SillyTavern.libs.DOMPurify,a="prompt"===t?(0,b.getPromptPresetsForStage)(e):(0,b.getSchemaPresetsForStage)(e);return`\n        <div class="ct-preset-row">\n            <select id="${`${h.pW}_${t}_select`}" class="ct-select text_pole" aria-label="${t} preset">\n                <option value="">Custom</option>\n                ${a.map(t=>`\n                    <option value="${t.id}" ${t.id===n?"selected":""}>\n                        ${r.sanitize(t.name)}${t.isBuiltin?"":" ✦"}\n                    </option>\n                `).join("")}\n            </select>\n            <button class="ct-preset-manage-btn menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                    data-type="${t}"\n                    type="button"\n                    title="Manage ${t} presets">\n                <i class="fa-solid fa-folder-open"></i>\n            </button>\n        </div>\n    `}function oe(t,e,n){const r=ct(`#${`${h.pW}_${t}_select`}`);if(!r)return;const a=SillyTavern.libs.DOMPurify,i=`\n        <option value="">Custom</option>\n        ${("prompt"===t?(0,b.getPromptPresetsForStage)(e):(0,b.getSchemaPresetsForStage)(e)).map(t=>`\n            <option value="${t.id}" ${t.id===n?"selected":""}>\n                ${a.sanitize(t.name)}${t.isBuiltin?"":" ✦"}\n            </option>\n        `).join("")}\n    `;r.innerHTML=i}function se(){const t=ct(".ct-stage-config");if(!t)return;const e=D(),n=e.activeStage,r=e.stageConfigs[n],a=t.querySelector(".ct-section__title");a&&(a.innerHTML=`\n            <i class="fa-solid ${h.iu[n]}"></i>\n            ${h.BA[n]} Configuration\n        `);const i=ct(`#${h.pW}_fields_container`);i&&(i.innerHTML=ae());const o=ct(`#${h.pW}_prompt`);if(o){let t=r.customPrompt;if(!t&&r.promptPresetId){const e=(0,b.getPromptPreset)(r.promptPresetId);e&&(t=e.prompt)}o.value=t,ce(o.value)}oe("prompt",n,r.promptPresetId);const s=ct(`#${h.pW}_use_schema`);s&&(s.checked=r.useStructuredOutput);const c=ct(`#${h.pW}_schema_section`);c&&c.classList.toggle("ct-hidden",!r.useStructuredOutput),oe("schema",n,r.schemaPresetId);const l=ct(`#${h.pW}_schema`);if(l){let t=r.customSchema;if(!t&&r.schemaPresetId){const e=(0,b.getSchemaPreset)(r.schemaPresetId);e&&(t=JSON.stringify(e.schema,null,2))}l.value=t}}function ce(t){return ne(this,void 0,void 0,function*(){const e=ct(`#${h.pW}_prompt_tokens`);if(!e)return;const n=yield(0,h.NR)(t);e.textContent=null!==n?`~${n} tokens`:`~${Math.ceil(t.length/4)} tokens`})}function le(t){const e=SillyTavern.libs.DOMPurify,n=[],r=ct(`#${h.pW}_link_fields`,t);r&&n.push(dt(r,"click",()=>{!function(){const t=D();if(t.stageFields.linked=!t.stageFields.linked,!t.stageFields.linked){const{lodash:e}=SillyTavern.libs;t.stageFields.overrides[t.activeStage]=e.cloneDeep(t.stageFields.base)}F()}();const t=Q();r.classList.toggle("ct-active",t),r.setAttribute("aria-pressed",String(t)),r.title=t?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const e=r.querySelector("i");e&&(e.className="fa-solid "+(t?"fa-link":"fa-link-slash")),se()}));const a=ct(`#${h.pW}_fields_container`,t);a&&(n.push(dt(a,"change",t=>{const e=t.target;if(!e.classList.contains("ct-field-checkbox"))return;const n=e.dataset.field;if(n){if(void 0!==e.dataset.index){const t=parseInt(e.dataset.index,10),r=Y(),a=Array.isArray(r[n])?[...r[n]]:[];if(e.checked)a.includes(t)||a.push(t);else{const e=a.indexOf(t);-1!==e&&a.splice(e,1)}K(n,a.length>0&&a.sort((t,e)=>t-e))}else if(e.classList.contains("ct-field-checkbox--parent")){const t=e.closest(".ct-field-group");if(!t)return;const r=lt(".ct-field-checkbox--child",t);if(e.checked){K(n,r.map((t,e)=>e))}else K(n,!1)}else K(n,e.checked);!function(){const t=ct(`#${h.pW}_fields_container`);if(!t)return;const e=lt(".ct-field-group",t);for(const t of e){if(!t.dataset.field)continue;const e=ct(".ct-field-checkbox--parent",t),n=lt(".ct-field-checkbox--child",t);if(!e)continue;const r=n.filter(t=>t.checked).length,a=n.length;0===r?(e.checked=!1,e.indeterminate=!1):r===a?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}}()}})),n.push(dt(a,"click",t=>{const e=t.target.closest(".ct-field-expand");if(!e)return;const n=e.closest(".ct-field-group");n&&n.classList.toggle("ct-field-group--expanded")})),n.push(dt(a,"click",t=>ne(this,void 0,void 0,function*(){const e=t.target.closest(".ct-field-preview__more");if(!e)return;const n=e.dataset.field;if(!n)return;const r=D();if(!r.character)return;const a=P(r.character).find(t=>t.key===n);a&&h.lY.alert(a.label,`<pre class="ct-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(a.value)}</pre>`)}))),n.push(dt(a,"click",t=>ne(this,void 0,void 0,function*(){const e=t.target.closest(".ct-field-preview-btn");if(!e)return;const n=e.dataset.field,r=e.dataset.index;if(!n||void 0===r)return;const a=D();if(!a.character)return;const i=P(a.character).find(t=>t.key===n);if(!i||!Array.isArray(i.rawValue))return;const o=parseInt(r,10),s=i.rawValue[o];s&&h.lY.alert(`Greeting ${o+1}`,`<pre class="ct-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(s)}</pre>`)}))));const i=ct(`#${h.pW}_prompt`,t);if(i){const t=SillyTavern.libs.lodash.debounce(t=>{Z(D().activeStage,{customPrompt:t,promptPresetId:null}),ce(t)},300);re.push(t),n.push(dt(i,"input",()=>{t(i.value)})),ce(i.value)}const o=ct(`#${h.pW}_prompt_select`,t);o&&n.push(dt(o,"change",()=>{const t=D(),e=o.value||null;if(Z(t.activeStage,{promptPresetId:e,customPrompt:""}),e){const t=(0,b.getPromptPreset)(e);t&&i&&(i.value=t.prompt,ce(t.prompt))}}));const s=ct(`#${h.pW}_save_prompt`,t);s&&n.push(dt(s,"click",()=>ne(this,void 0,void 0,function*(){const t=D(),e=(null==i?void 0:i.value)||"";if(!e.trim())return void h.oR.warning("Enter a prompt first");const n=yield h.lY.input("Save Prompt Preset","Enter a name for this preset:",`${h.BA[t.activeStage]} Custom`);if(!n)return;const r=(0,b.savePromptPreset)({name:n.trim(),stages:[t.activeStage],prompt:e});h.oR.success(`Saved preset "${r.name}"`),se()})));const c=ct(`#${h.pW}_use_schema`,t),l=ct(`#${h.pW}_schema_section`,t);c&&l&&n.push(dt(c,"change",()=>{Z(D().activeStage,{useStructuredOutput:c.checked}),l.classList.toggle("ct-hidden",!c.checked)}));const d=ct(`#${h.pW}_schema`,t);if(d){const t=SillyTavern.libs.lodash.debounce(t=>{Z(D().activeStage,{customSchema:t,schemaPresetId:null})},300);re.push(t),n.push(dt(d,"input",()=>{t(d.value)}))}const p=ct(`#${h.pW}_validate_schema`,t);p&&d&&n.push(dt(p,"click",()=>{try{JSON.parse(d.value),h.oR.success("Valid JSON")}catch(t){h.oR.error(`Invalid JSON: ${t.message}`)}}));const u=ct(`#${h.pW}_format_schema`,t);u&&d&&n.push(dt(u,"click",()=>{try{const t=JSON.parse(d.value);d.value=JSON.stringify(t,null,2),h.oR.success("Formatted")}catch(t){h.oR.error(`Invalid JSON: ${t.message}`)}}));const f=ct(`#${h.pW}_preview`,t);f&&n.push(dt(f,"click",()=>ne(this,void 0,void 0,function*(){const t=D();if(!t.character)return void h.oR.warning("Select a character first");let n=R(t.character,t.selectedFields);t.userGuidance.trim()&&(n+=`\n\n---\n\n## USER GUIDANCE\n\n${t.userGuidance}`),yield h.lY.alert("Prompt Preview",`<div class="ct-preview-content"><pre>${e.sanitize(n)}</pre></div>`)})));const v=lt(".ct-preset-manage-btn",t);for(const t of v)n.push(dt(t,"click",()=>{const e=t.dataset.type;Ut(e,{onSelect:t=>{const n=D();Z(n.activeStage,"prompt"===e?{promptPresetId:t.id,customPrompt:""}:{schemaPresetId:t.id,customSchema:""}),se()},onUpdate:()=>{se()}})}));return()=>{n.forEach(t=>t())}}var de=n(691);function pe(t){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[t.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function ue(){const t=D(),e=[];if(!t.character)return e;const n=P(t.character),r=t.stageResults.rewrite,a=(null==r?void 0:r.output)?function(t){var e,n;const r={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,i=[];let o;for(;null!==(o=a.exec(t));)i.push({name:o[1].trim().toLowerCase(),start:o.index+o[0].length});for(let a=0;a<i.length;a++){const o=i[a],s=null!==(n=null===(e=i[a+1])||void 0===e?void 0:e.start)&&void 0!==n?n:t.length,c=t.slice(o.start,s).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=pe(o.name);l&&c&&(r[l]=c)}return r}(r.output):{};for(const t of n){const n=a[t.key]||null;e.push({key:t.key,label:t.label,original:t.value,rewritten:n,hasChanges:null!==n&&n!==t.value})}return e}function fe(t){const e=SillyTavern.libs.DOMPurify;if(!t.rewritten)return`\n            <div class="ct-compare-row ct-compare-row--unchanged">\n                <div class="ct-compare-row__header">\n                    <span class="ct-compare-row__label">${t.label}</span>\n                    <span class="ct-badge ct-badge--small ct-badge--muted">No changes</span>\n                </div>\n                <div class="ct-compare-row__content ct-compare-row__content--single">\n                    <pre class="ct-compare-text">${e.sanitize(t.original)}</pre>\n                </div>\n            </div>\n        `;const{originalHtml:n,rewrittenHtml:r}=function(t,e){const n=SillyTavern.libs.DOMPurify,r=new(0,SillyTavern.libs.DiffMatchPatch),a=r.diff_main(t,e);r.diff_cleanupSemantic(a);const i=[],o=[];for(const[t,e]of a){const r=n.sanitize(e);switch(t){case-1:i.push(`<span class="ct-diff--removed">${r}</span>`);break;case 1:o.push(`<span class="ct-diff--added">${r}</span>`);break;default:i.push(r),o.push(r)}}return{originalHtml:i.join(""),rewrittenHtml:o.join("")}}(t.original,t.rewritten),a=function(t,e){const n=(new(0,SillyTavern.libs.DiffMatchPatch)).diff_main(t,e);let r=0,a=0,i=0;for(const[t,e]of n){const n=e.length;switch(t){case-1:a+=n;break;case 1:r+=n;break;default:i+=n}}return{additions:r,deletions:a,unchanged:i}}(t.original,t.rewritten),i=a.additions>0||a.deletions>0;return`\n        <div class="ct-compare-row ${t.hasChanges?"ct-compare-row--changed":""}">\n            <div class="ct-compare-row__header">\n                <span class="ct-compare-row__label">${t.label}</span>\n                <div class="ct-compare-row__badges">\n                    ${t.hasChanges?'<span class="ct-badge ct-badge--small ct-badge--accent">Modified</span>':""}\n                    ${i?`<span class="ct-diff-stats"><span class="ct-diff-stats__add">+${a.additions}</span> <span class="ct-diff-stats__del">-${a.deletions}</span></span>`:""}\n                </div>\n            </div>\n            <div class="ct-compare-row__content">\n                <div class="ct-compare-col ct-compare-col--original">\n                    <div class="ct-compare-col__header">\n                        <i class="fa-solid fa-file"></i> Original\n                    </div>\n                    <pre class="ct-compare-text">${n}</pre>\n                </div>\n                <div class="ct-compare-col ct-compare-col--rewritten">\n                    <div class="ct-compare-col__header">\n                        <i class="fa-solid fa-pen-fancy"></i> Rewritten\n                    </div>\n                    <pre class="ct-compare-text">${r}</pre>\n                </div>\n            </div>\n        </div>\n    `}function ve(){const t=D();if(!t.character)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-code-compare ct-empty__icon"></i>\n                <div class="ct-empty__title">No character selected</div>\n                <div class="ct-empty__text">Select a character to compare versions</div>\n            </div>\n        ';if(!t.stageResults.rewrite)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-code-compare ct-empty__icon"></i>\n                <div class="ct-empty__title">No rewrite available</div>\n                <div class="ct-empty__text">Run the Rewrite stage first to see comparisons</div>\n            </div>\n        ';const e=ue(),n=e.filter(t=>t.hasChanges).length;return`\n        <div class="ct-compare-view">\n            <div class="ct-compare-header">\n                <div class="ct-compare-stats">\n                    <span class="ct-badge ct-badge--accent">${n} field${1!==n?"s":""} modified</span>\n                    <span class="ct-badge ct-badge--muted">${e.length-n} unchanged</span>\n                </div>\n            </div>\n            <div class="ct-compare-list ct-scrollable">\n                ${e.map(fe).join("")}\n            </div>\n        </div>\n    `}var me=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function ge(t){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[t.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function he(){const t=D(),e=[];if(!t.character||!t.stageResults.rewrite)return e;const n=P(t.character),r=function(t){var e,n;const r={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,i=[];let o;for(;null!==(o=a.exec(t));)i.push({name:o[1].trim().toLowerCase(),start:o.index+o[0].length});for(let a=0;a<i.length;a++){const o=i[a],s=null!==(n=null===(e=i[a+1])||void 0===e?void 0:e.start)&&void 0!==n?n:t.length,c=t.slice(o.start,s).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=ge(o.name);l&&c&&(r[l]=c)}return r}(t.stageResults.rewrite.output);for(const t of n){const n=r[t.key];n&&n!==t.value&&e.push({key:t.key,label:t.label,original:t.value,rewritten:n,selected:!0})}return e}function be(t,e,n,r){return me(this,void 0,void 0,function*(){const a=SillyTavern.getContext();try{return(yield fetch("/api/characters/edit-attribute",{method:"POST",headers:a.getRequestHeaders(),body:JSON.stringify({avatar_url:t,ch_name:e,field:n,value:r})})).ok}catch(t){return h.Rm.error(`Failed to edit attribute ${n}:`,t),!1}})}function ye(t){return me(this,void 0,void 0,function*(){const e=SillyTavern.getContext();try{const n=yield fetch("/api/characters/export",{method:"POST",headers:e.getRequestHeaders(),body:JSON.stringify({avatar_url:t,format:"png"})});return n.ok?yield n.blob():null}catch(t){return h.Rm.error("Failed to export character:",t),null}})}function _e(t){return me(this,void 0,void 0,function*(){const e=D();if(!e.character)return!1;const n=e.character,r=yield function(t){return me(this,void 0,void 0,function*(){const e=SillyTavern.getContext();try{const n=yield fetch("/api/characters/export",{method:"POST",headers:e.getRequestHeaders(),body:JSON.stringify({avatar_url:t,format:"json"})});return n.ok?yield n.json():null}catch(t){return h.Rm.error("Failed to get character JSON:",t),null}})}(n.avatar);if(!r)return h.oR.error("Failed to get character data"),!1;for(const e of t)e.selected&&(r[e.key]=e.rewritten,r.data&&"object"==typeof r.data&&(r.data[e.key]=e.rewritten));const a=JSON.stringify(r,null,2),i=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(i),s=document.createElement("a");return s.href=o,s.download=`${n.name}_updated.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),h.oR.success("Character JSON downloaded!"),!0})}function xe(){return me(this,void 0,void 0,function*(){const t=he();if(0===t.length)return void h.oR.warning("No changes detected in the rewrite output.");const e=SillyTavern.libs.DOMPurify,n=`\n        <div class="ct-apply-dialog">\n            <p class="ct-apply-dialog__intro">\n                <strong>${t.length} field${t.length>1?"s":""}</strong> modified. \n                Select which fields to apply:\n            </p>\n            \n            <div class="ct-apply-dialog__fields">\n                ${t.map((t,n)=>`\n                    <div class="ct-apply-field">\n                        <label class="ct-apply-field__header">\n                            <input type="checkbox" \n                                   class="ct-apply-checkbox"\n                                   data-field-index="${n}" \n                                   ${t.selected?"checked":""}>\n                            <span class="ct-apply-field__label">${t.label}</span>\n                        </label>\n                        <div class="ct-apply-field__preview">\n                            <pre>${e.sanitize(t.rewritten.substring(0,300))}${t.rewritten.length>300?"...":""}</pre>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            \n            <div class="ct-apply-dialog__actions">\n                <button class="menu_button menu_button--sm ct-select-all-btn" type="button">\n                    Select All\n                </button>\n                <button class="menu_button menu_button--sm ct-select-none-btn" type="button">\n                    Select None\n                </button>\n            </div>\n            \n            <hr style="margin: 12px 0; border-color: var(--SmartThemeBorderColor);">\n            \n            <p class="ct-text-sm ct-text-dim">\n                <strong>Apply Directly</strong> - Updates the character card in SillyTavern immediately.<br>\n                <strong>Download PNG</strong> - Downloads the original card image with updated metadata.<br>\n                <strong>Download JSON</strong> - Downloads a JSON file you can import elsewhere.\n            </p>\n        </div>\n    `,r=SillyTavern.getContext();setTimeout(()=>{const t=document.querySelector(".ct-select-all-btn"),e=document.querySelector(".ct-select-none-btn");t&&t.addEventListener("click",()=>{document.querySelectorAll(".ct-apply-checkbox").forEach(t=>t.checked=!0)}),e&&e.addEventListener("click",()=>{document.querySelectorAll(".ct-apply-checkbox").forEach(t=>t.checked=!1)})},0);const a=yield r.callGenericPopup(n,r.POPUP_TYPE.CONFIRM,"",{okButton:"Apply Directly",cancelButton:"Cancel",customButtons:["Download PNG","Download JSON"],wide:!0});if(!1===a||void 0===a)return;const i=t.filter((t,e)=>{var n;const r=document.querySelector(`.ct-apply-checkbox[data-field-index="${e}"]`);return null!==(n=null==r?void 0:r.checked)&&void 0!==n&&n});0!==i.length?!0===a?yield function(t){return me(this,void 0,void 0,function*(){const e=D();if(!e.character)return!1;const n=e.character;let r=0;for(const e of t)e.selected&&((yield be(n.avatar,n.name,e.key,e.rewritten))?r++:h.oR.error(`Failed to update ${e.label}`));if(r>0){const t=SillyTavern.getContext();yield t.getCharacters(),h.oR.success(`Applied ${r} update${r>1?"s":""} to character!`)}return r===t.filter(t=>t.selected).length})}(i):0===a?yield function(t){return me(this,void 0,void 0,function*(){const e=D();if(!e.character)return!1;const n=e.character;let r=0;const a={};for(const e of t)e.selected&&(a[e.key]=e.original,(yield be(n.avatar,n.name,e.key,e.rewritten))&&r++);if(0===r)return h.oR.error("Failed to apply updates for PNG export"),!1;const i=yield ye(n.avatar);if(!i){h.oR.error("Failed to export character PNG");for(const[t,e]of Object.entries(a))yield be(n.avatar,n.name,t,e);return!1}const o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download=`${n.name}_updated.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),h.oR.success("Character PNG downloaded! (Changes applied to card)");const c=SillyTavern.getContext();return yield c.getCharacters(),!0})}(i):1===a&&(yield _e(i)):h.oR.warning("No fields selected.")})}const we=document.createElement("style");function $e(t,e){var n;const{DOMPurify:r}=SillyTavern.libs,a="string"==typeof t?t:String(null!=t?t:""),i=ke(a);if(!i||"object"!=typeof i){const t=Se(a);return r.sanitize(Te(t))}const o=function(t,e){const n=function(t){const e=["overallscore","totalscore","overall","total","score","rating"];for(const n of e)for(const e of Object.keys(t))if(e.toLowerCase().replace(/_/g,"")===n&&"number"==typeof t[e])return e;return null}(t),r=n?t[n]:null,a=[];if(n&&"number"==typeof r){const t=r>10?100:10;a.push(Oe({type:"hero",title:Be(n),score:{value:r,max:t}}))}const i=e.properties||{},o=Object.keys(i).length>0?Object.keys(i):Object.keys(t);for(const e of o){if(e===n)continue;const r=t[e];if(void 0===r)continue;const o=i[e]||{type:Me(r)};a.push(We(e,r,o,0))}return`<div class="ct-formatted">${a.join("")}</div>`}(i,null!==(n=null==e?void 0:e.value)&&void 0!==n?n:je(i));return r.sanitize(o)}function ke(t){try{return JSON.parse(t)}catch(e){const n=t.match(/```(?:json)?\s*([\s\S]*?)```/);if(n)try{return JSON.parse(n[1].trim())}catch(t){return null}return null}}function Se(t){const e=t.split("\n"),n=[];let r=null,a=[],i=!1,o="",s=[];const c=()=>{if(0===a.length)return;const t=a.join("\n").trim();if(!t)return void(a=[]);const e=function(t){const e=t.split("\n"),n=[];let r="";for(const t of e){const e=t.match(/^[\s]*[-*•]\s+(.+)$/),a=t.match(/^[\s]*\d+[.)]\s+(.+)$/);if(e||a)r&&n.push(r.trim()),r=(e||a)[1];else if(r&&t.match(/^\s+/))r+=" "+t.trim();else if(""===t.trim())r&&n.push(r.trim()),r="";else{if(0===n.length)return[];r&&n.push(r.trim()),r=""}}r&&n.push(r.trim());return n}(t);if(e.length>0){const t={type:"list",items:e};r?(r.children=r.children||[],r.children.push(t)):n.push(t)}else{const e=t.split(/\n\n+/);for(const t of e){if(!t.trim())continue;const e={type:"paragraph",content:t.trim()};r?(r.children=r.children||[],r.children.push(e)):n.push(e)}}a=[]},l=()=>{if(0===s.length)return;const t={type:"code",content:s.join("\n"),language:o};r?(r.children=r.children||[],r.children.push(t)):n.push(t),s=[],o=""};for(const t of e){if(/^[-*_]{3,}\s*$/.test(t.trim()))continue;const e=t.match(/^```(\w*)/);if(e){i?(l(),i=!1):(c(),i=!0,o=e[1]||"");continue}if(i){s.push(t);continue}const d=t.match(/^(#{1,3})\s+(.+)$/);if(d){c(),r&&(r.children&&r.children.length>0||r.score)&&n.push(r);const t=d[1].length,e=d[2].trim(),a=Ce(e);if(a&&1===t)n.push({type:"hero",title:a.label,score:{value:a.value,max:a.max}}),r=null;else{r={type:"section",title:e,children:[]};const t=Pe(e);t&&(r.score={value:t.value,max:t.max},r.title=e.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim())}continue}const p=Re(t);p&&r?r.score={value:p.value,max:p.max}:a.push(t)}if(c(),i&&l(),r&&(r.children&&r.children.length>0||r.score)&&n.push(r),n.length>0&&"section"===n[0].type){const t=n[0];t.score&&function(t){const e=t.toLowerCase().replace(/[_-]/g,"");return["overall","total","final","summary","verdict","rating","soulcheck"].some(t=>e.includes(t))}(t.title||"")&&(n[0]={type:"hero",title:t.title,score:t.score},t.children&&t.children.length>0&&n.splice(1,0,...t.children.map(t=>t)))}return n}function Pe(t){const e=t.match(/(\d+(?:\.\d+)?)\s*\/\s*(\d+)/);if(e){const t=parseFloat(e[1]),n=parseInt(e[2],10);if(!isNaN(t)&&!isNaN(n)&&n>0)return{value:t,max:n}}return null}function Re(t){const e=t.trim().match(/^(?:score\s*:?\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)$/i);if(e){const t=parseFloat(e[1]),n=parseInt(e[2],10);if(!isNaN(t)&&!isNaN(n)&&n>0)return{value:t,max:n}}return null}function Ce(t){const e=Pe(t);if(e){const n=t.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim();return Object.assign(Object.assign({},e),{label:n})}return null}function Te(t){if(0===t.length)return'<div class="ct-formatted ct-formatted--empty">No content</div>';return`<div class="ct-formatted">${t.map(ze).join("")}</div>`}function ze(t){switch(t.type){case"hero":return Oe(t);case"section":return function(t){const e=t.title||"",n=null!=t.score,r=t.children||[];let a="";if(n&&t.score){a=`\n            <span class="ct-section__score" style="--score-color: ${He(100===t.score.max?t.score.value/10:t.score.value)}">\n                ${Number.isInteger(t.score.value)?t.score.value:t.score.value.toFixed(1)}<span class="ct-section__score-max">/${t.score.max}</span>\n            </span>\n        `}const i=r.map(ze).join("");return`\n        <div class="ct-section">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">${Le(e)}</h3>\n                ${a}\n            </div>\n            <div class="ct-section__body">\n                ${i}\n            </div>\n        </div>\n    `}(t);case"paragraph":return function(t){const e=t.content||"";return`<p class="ct-para">${Ee(e)}</p>`}(t);case"list":return function(t){const e=t.items||[];if(0===e.length)return"";return`<ul class="ct-list">${e.map(t=>`<li>${Ee(t)}</li>`).join("")}</ul>`}(t);case"code":return function(t){const{hljs:e}=SillyTavern.libs,n=t.content||"",r=t.language||"";let a;try{a=r&&e.getLanguage(r)?e.highlight(n,{language:r}).value:e.highlightAuto(n).value}catch(t){a=Le(n)}return`\n        <div class="ct-code">\n            ${r?`<div class="ct-code__lang">${Le(r)}</div>`:""}\n            <pre class="ct-code__pre"><code class="hljs">${a}</code></pre>\n        </div>\n    `}(t);default:return""}}function Oe(t){const e=t.score;if(!e)return"";const n=He(100===e.max?e.value/10:e.value),r=Number.isInteger(e.value)?e.value:e.value.toFixed(1);return`\n        <div class="ct-hero">\n            <div class="ct-hero__label">${Le(t.title||"Score")}</div>\n            <div class="ct-hero__score">\n                <span class="ct-hero__value" style="--score-color: ${n}">${r}</span>\n                <span class="ct-hero__max">/${e.max}</span>\n            </div>\n            <div class="ct-hero__bar">\n                <div class="ct-hero__fill" style="width: ${e.value/e.max*100}%; background: ${n}"></div>\n            </div>\n        </div>\n    `}function Ee(t){let e=Le(t);return e=e.replace(/(?:(\w+)\s*:\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)/gi,(t,e,n,r)=>{const a=parseFloat(n),i=parseInt(r,10);return`${e?`<span class="ct-inline-score__label">${e}:</span> `:""}<span class="ct-inline-score" style="--score-color: ${He(100===i?a/10:a)}">${Number.isInteger(a)?a:a.toFixed(1)}<span class="ct-inline-score__max">/${i}</span></span>`}),e=e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__(.+?)__/g,"<strong>$1</strong>"),e=e.replace(/(?<![*_])\*(?![*\s])(.+?)(?<![*\s])\*(?![*_])/g,"<em>$1</em>"),e=e.replace(/(?<![*_])_(?![_\s])(.+?)(?<![_\s])_(?![*_])/g,"<em>$1</em>"),e=e.replace(/`([^`]+)`/g,'<code class="ct-inline-code">$1</code>'),e}we.textContent="\n.ct-apply-dialog {\n    max-height: 60vh;\n    overflow-y: auto;\n}\n\n.ct-apply-dialog__intro {\n    margin-bottom: 12px;\n}\n\n.ct-apply-dialog__fields {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    margin-bottom: 12px;\n}\n\n.ct-apply-field {\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 4px;\n    overflow: hidden;\n}\n\n.ct-apply-field__header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    cursor: pointer;\n}\n\n.ct-apply-field__header input {\n    margin: 0;\n}\n\n.ct-apply-field__label {\n    font-weight: 600;\n}\n\n.ct-apply-field__preview {\n    padding: 8px;\n    background: var(--SmartThemeBodyColor);\n}\n\n.ct-apply-field__preview pre {\n    margin: 0;\n    white-space: pre-wrap;\n    word-break: break-word;\n    font-size: 0.85em;\n    max-height: 100px;\n    overflow-y: auto;\n}\n\n.ct-apply-dialog__actions {\n    display: flex;\n    gap: 8px;\n}\n",document.head.appendChild(we);const Ae=8;function je(t){if(null===t)return{type:"null"};if(Array.isArray(t))return{type:"array",items:t.length>0?je(t[0]):{type:"string"}};if("object"==typeof t){const e={};for(const[n,r]of Object.entries(t))e[n]=je(r);return{type:"object",properties:e}}return{type:typeof t}}function We(t,e,n,r){if(r>Ae)return function(t){const{hljs:e}=SillyTavern.libs,n=JSON.stringify(t,null,2);return`<pre class="ct-code__pre"><code class="hljs">${e.highlight(n,{language:"json"}).value}</code></pre>`}(e);const a=Be(t),i=n.type||Me(e);if("array"===i&&Array.isArray(e))return function(t,e,n,r){if(0===e.length)return`\n            <div class="ct-field">\n                <div class="ct-field__label">${Le(t)}</div>\n                <div class="ct-field__value ct-field--empty">(none)</div>\n            </div>\n        `;const a=n.items||{type:Me(e[0])};if(e.every(Fe)){const n=e.map(t=>`<li>${function(t){if("boolean"==typeof t)return De(t);if("number"==typeof t)return`<span class="ct-num">${t.toLocaleString()}</span>`;return Ee(String(t))}(t)}</li>`).join("");return`\n            <div class="ct-field">\n                <div class="ct-field__label">${Le(t)}</div>\n                <ul class="ct-list">${n}</ul>\n            </div>\n        `}const i=e.map((t,e)=>"object"==typeof t&&null!==t?function(t,e,n){const r=e.properties||{},a=Object.keys(r).length>0?Object.keys(r):Object.keys(t),i=a.find(e=>"string"==typeof t[e]&&t[e].length<100),o=a.find(e=>"number"==typeof t[e]&&t[e]>=0&&t[e]<=100),s=a.find(e=>"string"==typeof t[e]&&t[e].length>=50&&e!==i);let c="";if(i||o){c=`<div class="ct-card__header">${i?`<span class="ct-card__title">${Le(String(t[i]))}</span>`:""}${o?Ie(t[o]):""}</div>`}let l="";s&&(l=`<div class="ct-card__body">${Ee(String(t[s]))}</div>`);const d=a.filter(t=>t!==i&&t!==o&&t!==s).map(e=>{const a=t[e];if(void 0===a)return"";return We(e,a,r[e]||{type:Me(a)},n+1)}).filter(Boolean).join("");return`<div class="ct-card">${c}${l}${d?`<div class="ct-card__extra">${d}</div>`:""}</div>`}(t,a,r+1):`<div class="ct-card">${Ne(t,a)}</div>`).join("");return`\n        <div class="ct-field">\n            <div class="ct-field__label">${Le(t)}</div>\n            <div class="ct-cards">${i}</div>\n        </div>\n    `}(a,e,n,r);if("object"===i&&"object"==typeof e&&null!==e)return function(t,e,n,r){const a=n.properties||{},i=(Object.keys(a).length>0?Object.keys(a):Object.keys(e)).map(t=>{const n=e[t];if(void 0===n)return"";return We(t,n,a[t]||{type:Me(n)},r+1)}).filter(Boolean).join("");return`\n        <div class="ct-section">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">${Le(t)}</h3>\n            </div>\n            <div class="ct-section__body ct-section__body--nested">\n                ${i}\n            </div>\n        </div>\n    `}(a,e,n,r);const o=Ne(e,n,t);return`\n        <div class="ct-field">\n            <div class="ct-field__label">${Le(a)}</div>\n            <div class="ct-field__value">${o}</div>\n        </div>\n    `}function Ne(t,e,n){if(null==t)return'<span class="ct-null">—</span>';switch(e.type||Me(t)){case"string":return function(t,e){if(!t.trim())return'<span class="ct-empty">(empty)</span>';const n=e.format;if("uri"===n||"url"===n||(r=t,/^https?:\/\//i.test(r))){const e=t.length>50?t.substring(0,47)+"...":t;return`<a href="${Le(t)}" target="_blank" rel="noopener" class="ct-link">${Le(e)}</a>`}var r;if("email"===n||function(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}(t))return`<a href="mailto:${Le(t)}" class="ct-link">${Le(t)}</a>`;if(t.length>100||t.includes("\n"))return`<div class="ct-text">${Ee(t)}</div>`;return`<span>${Ee(t)}</span>`}(t,e);case"number":case"integer":return function(t,e,n){const r=String(e.title||e.description||n||"").toLowerCase();if(function(t,e){return!!["score","rating","rank","grade","level","confidence","quality"].some(e=>t.includes(e))||(!!(e>=0&&e<=10&&Number.isFinite(e))||!!(e>=0&&e<=100&&Number.isInteger(e)))}(r,t))return Ie(t);return`<span class="ct-num">${t.toLocaleString(void 0,{maximumFractionDigits:2})}</span>`}(t,e,n);case"boolean":return De(t);default:return`<span>${Le(String(t))}</span>`}}function Ie(t){const e=t>10?100:10;return`<span class="ct-score" style="--score-color: ${He(t>10?t/10:t)}">${Number.isInteger(t)?t:t.toFixed(1)}<span class="ct-score__max">/${e}</span></span>`}function De(t){return`<span class="${t?"ct-bool--yes":"ct-bool--no"}"><i class="fa-solid ${t?"fa-check-circle":"fa-times-circle"}"></i> ${t?"Yes":"No"}</span>`}function Le(t){const{DOMPurify:e}=SillyTavern.libs,n="string"==typeof t?t:String(null!=t?t:"");return e.sanitize(n,{ALLOWED_TAGS:[]})}function Me(t){return null===t?"null":Array.isArray(t)?"array":typeof t}function Fe(t){return"string"==typeof t||"number"==typeof t||"boolean"==typeof t||null===t}function Be(t){return t.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,t=>t.toUpperCase())}function He(t){return t>=8?"var(--ct-score-high, #10b981)":t>=6?"var(--ct-score-good, #22c55e)":t>=4?"var(--ct-score-mid, #eab308)":t>=2?"var(--ct-score-low, #f97316)":"var(--ct-score-bad, #ef4444)"}var Ge=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let Ue="result",qe="smart",Je="formatted";function Ve(t,e){var n;const r=SillyTavern.libs.DOMPurify,a=SillyTavern.libs.hljs;if(!t)return`\n            <div class="ct-empty">\n                <i class="fa-solid ${h.iu[e]} ct-empty__icon"></i>\n                <div class="ct-empty__title">No results yet</div>\n                <div class="ct-empty__text">Run ${h.BA[e]} to see results</div>\n            </div>\n        `;if(t.error)return`\n            <div class="ct-alert ct-alert--danger">\n                <i class="fa-solid fa-exclamation-triangle ct-alert__icon"></i>\n                <div class="ct-alert__content">\n                    <div class="ct-alert__title">Error</div>\n                    <div class="ct-alert__message">${r.sanitize(t.error)}</div>\n                </div>\n            </div>\n        `;const i=ke(t.output);if(null!==i&&"object"==typeof i){const o=JSON.stringify(i,null,2),s=D().stageConfigs[e];let c,l=null;if(null==s?void 0:s.schemaPresetId){const t=(0,de.Bx)(s.schemaPresetId);l=null!==(n=null==t?void 0:t.schema)&&void 0!==n?n:null}if("smart"===qe)c=$e(t.output,l);else{let t;try{t=a.highlight(o,{language:"json"}).value}catch(e){t=r.sanitize(o)}c=`<pre class="ct-result__code hljs"><code>${t}</code></pre>`}return`\n            <div class="ct-result">\n                <div class="ct-result__header">\n                    <span class="ct-result__type">\n                        <i class="fa-solid fa-brackets-curly"></i>\n                        Structured Output\n                    </span>\n                    <div class="ct-result__actions">\n                        <div class="ct-json-toggle">\n                            <button class="ct-json-toggle__btn ${"smart"===qe?"ct-json-toggle__btn--active":""}"\n                                    data-mode="smart"\n                                    type="button"\n                                    title="Smart formatted view">\n                                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            </button>\n                            <button class="ct-json-toggle__btn ${"raw"===qe?"ct-json-toggle__btn--active":""}"\n                                    data-mode="raw"\n                                    type="button"\n                                    title="Raw JSON view">\n                                <i class="fa-solid fa-code"></i>\n                            </button>\n                        </div>\n                        <button class="ct-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                data-content="${encodeURIComponent(o)}"\n                                type="button"\n                                title="Copy to clipboard">\n                            <i class="fa-solid fa-copy"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="ct-result__content">\n                    ${c}\n                </div>\n            </div>\n        `}let o;return o="formatted"===Je?function(t){const{DOMPurify:e}=SillyTavern.libs,n="string"==typeof t?t:String(null!=t?t:""),r=ke(n);if(r&&"object"==typeof r)return $e(n,null);const a=Te(Se(n));return e.sanitize(a)}(t.output):`<pre class="ct-result__raw">${r.sanitize(t.output)}</pre>`,`\n        <div class="ct-result">\n            <div class="ct-result__header">\n                <span class="ct-result__type">\n                    <i class="fa-solid fa-file-lines"></i>\n                    Analysis\n                </span>\n                <div class="ct-result__actions">\n                    <div class="ct-text-toggle">\n                        <button class="ct-text-toggle__btn ${"formatted"===Je?"ct-text-toggle__btn--active":""}"\n                                data-mode="formatted"\n                                type="button"\n                                title="Formatted view">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        </button>\n                        <button class="ct-text-toggle__btn ${"raw"===Je?"ct-text-toggle__btn--active":""}"\n                                data-mode="raw"\n                                type="button"\n                                title="Raw text (easy to copy)">\n                            <i class="fa-solid fa-code"></i>\n                        </button>\n                    </div>\n                    <button class="ct-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            data-content="${encodeURIComponent(t.output)}"\n                            type="button"\n                            title="Copy to clipboard">\n                        <i class="fa-solid fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="ct-result__content">\n                ${o}\n            </div>\n        </div>\n    `}function Ye(t,e){var n;const r=SillyTavern.libs.DOMPurify,a=SillyTavern.libs.moment,i=D(),o=a(t.timestamp),s=o.fromNow(),c=o.format("MMM D, h:mm A"),l=ut(t.output||t.error||"",100),d=i.viewingHistoryIndex===e,p=(null===(n=i.stageResults[t.stage])||void 0===n?void 0:n.timestamp)===t.timestamp;return`\n        <div class="ct-list-item ${ft(t.error&&"ct-list-item--error",d&&"ct-list-item--viewing",p&&"ct-list-item--current")}"\n             data-index="${e}">\n            <div class="ct-list-item__content">\n                <div class="ct-row ct-row--between">\n                    <span class="ct-list-item__title">\n                        <i class="fa-solid ${h.iu[t.stage]} ct-text-accent"></i>\n                        ${h.BA[t.stage]}\n                        ${p?'<span class="ct-badge ct-badge--sm">current</span>':""}\n                    </span>\n                    <span class="ct-text-xs ct-text-dim" title="${c}">${s}</span>\n                </div>\n                <div class="ct-list-item__subtitle ct-truncate">${r.sanitize(l)}</div>\n            </div>\n            <div class="ct-list-item__actions">\n                <button class="ct-history-restore menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        data-index="${e}"\n                        type="button"\n                        title="Restore this result as current">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n        </div>\n    `}function Qe(){var t,e;const n=D(),r=function(){var t;const e=D();return null===e.viewingHistoryIndex?null:null!==(t=e.iterationHistory[e.viewingHistoryIndex])&&void 0!==t?t:null}(),a=null!==r,i=a?r:n.stageResults[n.activeStage],o=!!n.stageResults.rewrite,s=n.iterationHistory.length>0,c=!a&&o&&he().length>0,l=a?`\n            <div class="ct-history-nav">\n                <div class="ct-history-nav__info">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Viewing history ${(null!==(t=n.viewingHistoryIndex)&&void 0!==t?t:0)+1} of ${n.iterationHistory.length}</span>\n                </div>\n                <div class="ct-history-nav__controls">\n                    <button class="ct-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_prev"\n                            type="button"\n                            title="Previous"\n                            ${0===n.viewingHistoryIndex?"disabled":""}>\n                        <i class="fa-solid fa-chevron-left"></i>\n                    </button>\n                    <button class="ct-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_next"\n                            type="button"\n                            title="Next">\n                        <i class="fa-solid fa-chevron-right"></i>\n                    </button>\n                    <button class="ct-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                            id="${h.pW}_history_restore"\n                            type="button"\n                            title="Restore this as current result">\n                        <i class="fa-solid fa-rotate-left"></i> Restore\n                    </button>\n                    <button class="ct-history-nav__btn menu_button menu_button--sm"\n                            id="${h.pW}_history_back"\n                            type="button"\n                            title="Back to current results">\n                        <i class="fa-solid fa-xmark"></i> Back\n                    </button>\n                </div>\n            </div>\n        `:"",d=o&&!a?`\n            <div class="ct-view-toggle">\n                <button class="ct-view-toggle__btn ${"result"===Ue?"ct-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="ct-view-toggle__btn ${"compare"===Ue?"ct-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${c?'\n                <button class="menu_button menu_button--primary menu_button--sm ct-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `:"",p=a?Ve(i,null!==(e=null==i?void 0:i.stage)&&void 0!==e?e:n.activeStage):"compare"===Ue&&o?`<div id="${h.pW}_compare_content">${ve()}</div>`:Ve(i,n.activeStage),u=s?`\n            <div class="ct-history ${ft(!n.historyExpanded&&"ct-history--collapsed")}">\n                <button class="ct-history__toggle"\n                        type="button"\n                        aria-expanded="${n.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${n.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down ct-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="ct-history__list ct-list">\n                    ${n.iterationHistory.map((t,e)=>Ye(t,e)).join("")}\n                </div>\n            </div>\n        `:"";return`\n        <div class="ct-results-wrapper">\n            \x3c!-- History Navigation (when viewing history) --\x3e\n            ${l}\n\n            \x3c!-- View Toggle --\x3e\n            ${d?`<div class="ct-results-toolbar">${d}</div>`:""}\n\n            \x3c!-- Results/Compare content --\x3e\n            <div id="${h.pW}_results_content" class="ct-results-content">\n                ${p}\n            </div>\n\n            \x3c!-- Run History Section (only if there's history) --\x3e\n            ${u}\n        </div>\n    `}function Ke(){const t=D(),e=!!t.stageResults.rewrite,n=e&&he().length>0,r=t.iterationHistory.length>0,a=ct(".ct-results-wrapper");if(!a)return;let i=a.querySelector(".ct-results-toolbar");if(e){const t=`\n            <div class="ct-view-toggle">\n                <button class="ct-view-toggle__btn ${"result"===Ue?"ct-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="ct-view-toggle__btn ${"compare"===Ue?"ct-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${n?'\n                <button class="menu_button menu_button--primary menu_button--sm ct-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `;if(!i){i=document.createElement("div"),i.className="ct-results-toolbar";const t=ct(`#${h.pW}_results_content`);t&&a.insertBefore(i,t)}i.innerHTML=t}else i&&i.remove();const o=ct(`#${h.pW}_results_content`);if(!o)return;if("compare"===Ue&&e)o.innerHTML=`<div id="${h.pW}_compare_content">${ve()}</div>`;else{const e=t.stageResults[t.activeStage];o.innerHTML=Ve(e,t.activeStage)}let s=a.querySelector(".ct-history");if(r){s||(s=document.createElement("div"),s.className="ct-history "+(t.historyExpanded?"":"ct-history--collapsed"),s.innerHTML=`\n                <button class="ct-history__toggle"\n                        type="button"\n                        aria-expanded="${t.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${t.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down ct-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="ct-history__list ct-list">\n                </div>\n            `,a.appendChild(s));const e=ct(`#${h.pW}_history_list`);if(e){!function(t,e,n){const r=SillyTavern.libs.morphdom,a=SillyTavern.libs.DOMPurify,i=document.createElement("div");i.innerHTML=a.sanitize(e),r(t,i,{childrenOnly:!0,onBeforeElUpdated:(t,e)=>{var r,a;if(document.activeElement===t&&"INPUT"===t.tagName){const n=t,r=e;r.value=n.value,r.selectionStart=n.selectionStart,r.selectionEnd=n.selectionEnd}if(document.activeElement===t&&"TEXTAREA"===t.tagName){const n=t,r=e;r.value=n.value,r.selectionStart=n.selectionStart,r.selectionEnd=n.selectionEnd}return null===(a=null===(r=null==n?void 0:n.onBeforeElUpdated)||void 0===r?void 0:r.call(n,t,e))||void 0===a||a},onBeforeNodeDiscarded:null==n?void 0:n.onBeforeNodeDiscarded,onNodeAdded:null==n?void 0:n.onNodeAdded})}(e,t.iterationHistory.map((t,e)=>Ye(t,e)).join(""))}const n=s.querySelector(".ct-history__toggle span");n&&(n.textContent=`Run History (${t.iterationHistory.length})`)}else s&&s.remove()}function Xe(t){const e=[];e.push(dt(t,"click",t=>{const n=t.target.closest(".ct-view-toggle__btn");if(!n)return;const r=n.dataset.view;if(r&&r!==Ue&&(Ue=r,Ke(),"compare"===r)){const t=ct(`#${h.pW}_compare_content`);t&&e.push(function(t){const e=[],n=ct(".ct-compare-list",t);return n&&e.push(dt(n,"click",t=>{const e=t.target.closest(".ct-compare-row");if(!e)return;const n=e.querySelector(".ct-compare-row__label"),r=(null==n?void 0:n.textContent)||"Field",a=e.querySelector(".ct-compare-col--original pre"),i=e.querySelector(".ct-compare-col--rewritten pre");a&&i&&h.lY.alert(`Compare: ${r}`,`\n                        <div class="ct-compare-popup">\n                            <div class="ct-compare-popup__side">\n                                <h4>Original</h4>\n                                <pre>${a.innerHTML}</pre>\n                            </div>\n                            <div class="ct-compare-popup__side">\n                                <h4>Rewritten</h4>\n                                <pre>${i.innerHTML}</pre>\n                            </div>\n                        </div>\n                        `)})),()=>{e.forEach(t=>t())}}(t))}})),e.push(dt(t,"click",t=>{const e=t.target.closest(".ct-json-toggle__btn");if(!e)return;const n=e.dataset.mode;n&&n!==qe&&(qe=n,Ke())})),e.push(dt(t,"click",t=>{const e=t.target.closest(".ct-text-toggle__btn");if(!e)return;const n=e.dataset.mode;n&&n!==Je&&(Je=n,Ke())})),e.push(dt(t,"click",t=>{t.target.closest(".ct-apply-btn")&&xe()}));const n=ct(`#${h.pW}_results_content`,t);n&&e.push(dt(n,"click",t=>Ge(this,void 0,void 0,function*(){const e=t.target.closest(".ct-result-copy");if(!e)return;const n=decodeURIComponent(e.dataset.content||""),r=yield function(t){return Ge(this,void 0,void 0,function*(){if(navigator.clipboard&&window.isSecureContext)try{return yield navigator.clipboard.writeText(t),!0}catch(t){}try{const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",e.setAttribute("readonly",""),document.body.appendChild(e),e.select(),e.setSelectionRange(0,t.length);const n=document.execCommand("copy");return document.body.removeChild(e),n}catch(t){return!1}})}(n),a=e.querySelector("i");r?a&&(a.className="fa-solid fa-check",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)):(a&&(a.className="fa-solid fa-xmark",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)),console.error("Failed to copy to clipboard"))})));const r=ct(".ct-history__toggle",t),a=ct(".ct-history",t);r&&a&&e.push(dt(r,"click",()=>{!function(){const t=D();t.historyExpanded=!t.historyExpanded}(),a.classList.toggle("ct-history--collapsed"),r.setAttribute("aria-expanded",String(D().historyExpanded))})),e.push(dt(t,"click",t=>{const e=t.target;return e.closest(`#${h.pW}_history_prev`)?(function(){const t=D();0!==t.iterationHistory.length&&(null===t.viewingHistoryIndex?t.viewingHistoryIndex=t.iterationHistory.length-1:t.viewingHistoryIndex>0&&t.viewingHistoryIndex--)}(),void Ke()):e.closest(`#${h.pW}_history_next`)?(function(){const t=D();null!==t.viewingHistoryIndex&&(t.viewingHistoryIndex<t.iterationHistory.length-1?t.viewingHistoryIndex++:t.viewingHistoryIndex=null)}(),void Ke()):e.closest(`#${h.pW}_history_restore`)?(et(),h.oR.success("Result restored"),void Ke()):e.closest(`#${h.pW}_history_back`)?(tt(null),void Ke()):void 0}));const i=ct(`#${h.pW}_history_list`,t);return i&&e.push(dt(i,"click",t=>Ge(this,void 0,void 0,function*(){const e=t.target,n=e.closest(".ct-history-restore");if(n){t.stopPropagation();return et(parseInt(n.dataset.index||"0",10)),h.oR.success("Result restored"),void Ke()}const r=e.closest(".ct-list-item");if(!r)return;tt(parseInt(r.dataset.index||"0",10)),Ke()}))),()=>{e.forEach(t=>t())}}var Ze=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};const tn={pending:"",running:"fa-spinner fa-spin",complete:"fa-check",error:"fa-exclamation"},en={pending:"",running:"ct-stage-tab--running",complete:"ct-stage-tab--complete",error:"ct-stage-tab--error"};function nn(t){const e=D(),n=e.activeStage===t,r=e.stageStatus[t],a=tn[r],i=a?`<span class="ct-stage-tab__status"><i class="fa-solid ${a}"></i></span>`:"";return`\n        <button class="ct-stage-tab ${ft(n&&"ct-stage-tab--active")} ${en[r]}"\n                data-stage="${t}"\n                role="tab"\n                aria-selected="${n}"\n                type="button">\n            <i class="fa-solid ${h.iu[t]} ct-stage-tab__icon"></i>\n            <span class="ct-stage-tab__label">${h.BA[t]}</span>\n            ${i}\n        </button>\n    `}function rn(){const t=SillyTavern.libs.DOMPurify,e=D(),n=e.character&&!e.isGenerating,r=n&&e.stageResults.analyze&&!e.stageResults.analyze.error;if(e.isGenerating)return`\n            <div class="ct-pipeline-controls ct-pipeline-controls--generating">\n                <div class="ct-pipeline-status">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Generating...</span>\n                </div>\n                <button id="${h.pW}_abort"\n                        class="menu_button menu_button--danger menu_button--sm"\n                        type="button">\n                    <i class="fa-solid fa-stop"></i>\n                    Stop\n                </button>\n            </div>\n        `;const a=r?`\n        <div class="ct-iteration-row">\n            <div class="ct-iteration-row__label">\n                <i class="fa-solid fa-arrows-rotate"></i>\n                <span>Iteration ${e.iterationCount+1}</span>\n            </div>\n            <input type="text"\n                   id="${h.pW}_guidance_input"\n                   class="ct-iteration-row__input"\n                   placeholder="Optional guidance to steer refinement..."\n                   value="${t.sanitize(D().userGuidance)}"\n                   title="Focus areas or constraints for the next iteration" />\n            <button id="${h.pW}_iterate"\n                    class="menu_button menu_button--primary"\n                    type="button"\n                    title="Refine with feedback, then re-analyze">\n                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                Iterate\n            </button>\n        </div>\n    `:"";return`\n        <div class="ct-pipeline-controls">\n            <div class="ct-pipeline-controls__main">\n                <button id="${h.pW}_run_stage"\n                        class="menu_button menu_button--primary"\n                        type="button"\n                        ${n?"":"disabled"}>\n                    <i class="fa-solid fa-play"></i>\n                    Run ${h.BA[e.activeStage]}\n                </button>\n                <button id="${h.pW}_run_all"\n                        class="menu_button"\n                        type="button"\n                        ${n?"":"disabled"}\n                        title="Run all stages: Score → Rewrite → Analyze">\n                    <i class="fa-solid fa-forward"></i>\n                    Run All\n                </button>\n                <button id="${h.pW}_reset"\n                        class="menu_button menu_button--icon menu_button--ghost"\n                        type="button"\n                        title="Clear all results and start fresh">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n            ${a}\n        </div>\n    `}function an(){const t=ct(".ct-stage-tabs");t&&(t.innerHTML=h.an.map(nn).join(""))}function on(){const t=ct(`#${h.pW}_pipeline_controls`);t&&(t.innerHTML=rn(),pn(t))}function sn(t){return Ze(this,void 0,void 0,function*(){const e=D();an(),on(),yield function(t,e){return nt(this,void 0,void 0,function*(){var n,r,a,i;const{stage:o,callbacks:s}=e;if(!t.character)return h.Rm.warn("Cannot execute stage: no character selected"),null;if(t.isGenerating)return h.Rm.warn("Cannot execute stage: generation already in progress"),null;const c=st(t,o);if(!c)return null;const l=new AbortController;it(t,!0,l),at(t,o,"running"),null===(n=null==s?void 0:s.onStageStart)||void 0===n||n.call(s,o);try{const e=yield O(c,rt,{signal:l.signal,onProgress:t=>{var e;h.Rm.debug(`[Pipeline] ${t}`),null===(e=null==s?void 0:s.onProgress)||void 0===e||e.call(s,t)}});return ot(t,e),null===(r=null==s?void 0:s.onStageComplete)||void 0===r||r.call(s,o,e),e.error&&(null===(a=null==s?void 0:s.onError)||void 0===a||a.call(s,o,e.error)),e}catch(e){const n=e instanceof Error?e.message:"Unknown error";return h.Rm.error(`Stage ${o} failed:`,e),at(t,o,"error"),null===(i=null==s?void 0:s.onError)||void 0===i||i.call(s,o,n),null}finally{it(t,!1)}})}(e,{stage:t,callbacks:{onStageStart:()=>{an(),on()},onStageComplete:()=>{Ke(),an(),on()},onError:()=>{an(),on()}}})})}function cn(){return Ze(this,void 0,void 0,function*(){const t=D();an(),on(),yield function(t){return nt(this,arguments,void 0,function*(t,e={}){var n,r,a,i,o;const{stages:s=[...h.an],callbacks:c}=e;if(!t.character)return h.Rm.warn("Cannot execute pipeline: no character selected"),{score:null,rewrite:null,analyze:null};if(t.isGenerating)return h.Rm.warn("Cannot execute pipeline: generation already in progress"),{score:null,rewrite:null,analyze:null};const l=new AbortController;it(t,!0,l);for(const e of h.an)at(t,e,"pending");const d={score:t.stageResults.score,rewrite:t.stageResults.rewrite,analyze:t.stageResults.analyze};try{for(const e of s){if(l.signal.aborted){h.Rm.debug("Pipeline aborted");break}const o=st(t,e);if(!o)break;o.previousResults=d,at(t,e,"running"),null===(n=null==c?void 0:c.onStageStart)||void 0===n||n.call(c,e),null===(r=null==c?void 0:c.onProgress)||void 0===r||r.call(c,`Running ${e}...`);const s=yield O(o,rt,{signal:l.signal,onProgress:t=>{var e;h.Rm.debug(`[Pipeline] ${t}`),null===(e=null==c?void 0:c.onProgress)||void 0===e||e.call(c,t)}});if(d[e]=s,ot(t,s),null===(a=null==c?void 0:c.onStageComplete)||void 0===a||a.call(c,e,s),s.error){null===(i=null==c?void 0:c.onError)||void 0===i||i.call(c,e,s.error);break}}}catch(e){const n=e instanceof Error?e.message:"Unknown error";h.Rm.error("Pipeline execution failed:",e),null===(o=null==c?void 0:c.onError)||void 0===o||o.call(c,t.activeStage,n)}finally{it(t,!1)}return d})}(t,{callbacks:{onStageStart:()=>{an()},onStageComplete:()=>{Ke(),an()},onProgress:()=>{on()},onError:()=>{an(),on()}}}),an(),on()})}function ln(){return Ze(this,void 0,void 0,function*(){const t=D();an(),on(),yield function(t){return nt(this,arguments,void 0,function*(t,e={}){var n,r,a,i,o,s,c,l,d,p;const{callbacks:u}=e;if(!t.character)return h.Rm.warn("Cannot execute quick iterate: no character selected"),{rewrite:null,analyze:null};if(t.isGenerating)return h.Rm.warn("Cannot execute quick iterate: generation already in progress"),{rewrite:null,analyze:null};if(!t.stageResults.analyze)return h.Rm.warn("Cannot execute quick iterate: no analyze result available"),{rewrite:null,analyze:null};const f=new AbortController;it(t,!0,f),t.iterationCount++;const v={rewrite:null,analyze:null};try{const e=st(t,"rewrite");if(!e)return v;e.isRefinement=!0,at(t,"rewrite","running"),null===(n=null==u?void 0:u.onStageStart)||void 0===n||n.call(u,"rewrite"),null===(r=null==u?void 0:u.onProgress)||void 0===r||r.call(u,"Refining rewrite with feedback...");const p=yield O(e,rt,{signal:f.signal,onProgress:t=>{var e;h.Rm.debug(`[Pipeline] ${t}`),null===(e=null==u?void 0:u.onProgress)||void 0===e||e.call(u,t)}});if(v.rewrite=p,ot(t,p),null===(a=null==u?void 0:u.onStageComplete)||void 0===a||a.call(u,"rewrite",p),p.error)return null===(i=null==u?void 0:u.onError)||void 0===i||i.call(u,"rewrite",p.error),v;if(f.signal.aborted)return h.Rm.debug("Quick iterate aborted"),v;const m=st(t,"analyze");if(!m)return v;m.previousResults=Object.assign(Object.assign({},t.stageResults),{rewrite:p}),at(t,"analyze","running"),null===(o=null==u?void 0:u.onStageStart)||void 0===o||o.call(u,"analyze"),null===(s=null==u?void 0:u.onProgress)||void 0===s||s.call(u,"Analyzing refined version...");const g=yield O(m,rt,{signal:f.signal,onProgress:t=>{var e;h.Rm.debug(`[Pipeline] ${t}`),null===(e=null==u?void 0:u.onProgress)||void 0===e||e.call(u,t)}});return v.analyze=g,ot(t,g),null===(c=null==u?void 0:u.onStageComplete)||void 0===c||c.call(u,"analyze",g),g.error&&(null===(l=null==u?void 0:u.onError)||void 0===l||l.call(u,"analyze",g.error)),null===(d=null==u?void 0:u.onIterateComplete)||void 0===d||d.call(u),v}catch(e){const n=e instanceof Error?e.message:"Unknown error";return h.Rm.error("Quick iterate failed:",e),null===(p=null==u?void 0:u.onError)||void 0===p||p.call(u,t.activeStage,n),v}finally{it(t,!1)}})}(t,{callbacks:{onStageStart:t=>{an(),on()},onStageComplete:()=>{Ke(),an(),on()},onError:()=>{an(),on()},onIterateComplete:()=>{X("analyze"),an(),se(),Ke()}}})})}let dn=[];function pn(t){dn.forEach(t=>t()),dn=[];const e=ct(`#${h.pW}_guidance_input`,t);if(e){const t=()=>{var t;t=e.value,D().userGuidance=t,F()};dn.push(dt(e,"change",t)),dn.push(dt(e,"blur",t))}const n=ct(`#${h.pW}_run_stage`,t);n&&dn.push(dt(n,"click",()=>{sn(D().activeStage)}));const r=ct(`#${h.pW}_run_all`,t);r&&dn.push(dt(r,"click",()=>{cn()}));const a=ct(`#${h.pW}_iterate`,t);a&&dn.push(dt(a,"click",()=>{ln()}));const i=ct(`#${h.pW}_reset`,t);i&&dn.push(dt(i,"click",()=>{!function(t){t.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},t.stageResults={score:null,rewrite:null,analyze:null},t.iterationCount=0,t.hasUnsavedChanges=!0}(D()),an(),Ke(),on()}));const o=ct(`#${h.pW}_abort`,t);o&&dn.push(dt(o,"click",()=>{!function(t){t.abortController&&(t.abortController.abort(),t.abortController=null,t.isGenerating=!1,h.Rm.debug("Pipeline aborted by user"))}(D()),an(),on()}))}var un=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let fn=!1,vn=null;function mn(t){fn=t;const e=ct(`#${h.pW}_session_dropdown`);e&&e.classList.toggle("ct-dropdown--open",t),t||(vn=null)}function gn(t){return t.name?t.name:(e=t.updatedAt,(0,SillyTavern.libs.moment)(e).calendar(null,{sameDay:"[Today] h:mm A",lastDay:"[Yesterday] h:mm A",lastWeek:"ddd, h:mm A",sameElse:"MMM D, h:mm A"}));var e}function hn(){const t=D(),e=t.sessions;return t.character?0===e.length?'\n            <div class="ct-dropdown__empty">\n                <i class="fa-solid fa-folder-open"></i>\n                No sessions yet\n            </div>\n        ':e.map(e=>function(t,e){var n,r;const a=SillyTavern.libs.DOMPurify,i=gn(t),o=vn===t.id,s=Object.keys(null!==(r=null===(n=t.stageFields)||void 0===n?void 0:n.base)&&void 0!==r?r:{}).length,c=t.history.length;return`\n        <div class="ct-session-option ${ft(e&&"ct-session-option--active")}"\n             data-session-id="${t.id}"\n             role="option"\n             aria-selected="${e}">\n            <div class="ct-session-option__content">\n                ${o?`\n                    <input type="text"\n                           class="ct-session-option__name-input"\n                           value="${a.sanitize(t.name||"")}"\n                           placeholder="Session name..."\n                           autocomplete="off"\n                           data-session-id="${t.id}" />\n                `:`\n                    <div class="ct-session-option__name">\n                        ${e?'<i class="fa-solid fa-circle ct-session-option__indicator"></i>':""}\n                        <span>${a.sanitize(i)}</span>\n                    </div>\n                `}\n                <div class="ct-session-option__meta">\n                    <span>${s} fields</span>\n                    <span>${c} runs</span>\n                </div>\n            </div>\n            <div class="ct-session-option__actions ${ft(o&&"ct-session-option__actions--editing")}">\n                ${o?`\n                    <button class="ct-session-save menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Save name"\n                            data-session-id="${t.id}">\n                        <i class="fa-solid fa-check"></i>\n                    </button>\n                    <button class="ct-session-cancel menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Cancel">\n                        <i class="fa-solid fa-times"></i>\n                    </button>\n                `:`\n                    <button class="ct-session-edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Rename session"\n                            data-session-id="${t.id}">\n                        <i class="fa-solid fa-pencil"></i>\n                    </button>\n                    <button class="ct-session-delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Delete session"\n                            data-session-id="${t.id}">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                `}\n            </div>\n        </div>\n    `}(e,e.id===t.activeSessionId)).join(""):'\n            <div class="ct-dropdown__empty">\n                <i class="fa-solid fa-user-slash"></i>\n                Select a character first\n            </div>\n        '}function bn(){const t=ct(`#${h.pW}_session_dropdown`);if(!t)return;const e=D(),n=e.sessions.find(t=>t.id===e.activeSessionId),r=!!e.character;t.classList.toggle("ct-dropdown--disabled",!r);const a=ct(`#${h.pW}_session_trigger`);if(a){a.disabled=!r;let t="No session";r?n&&(t=gn(n)):t="Select character...";const i=e.sessions.length;a.innerHTML=`\n            <i class="fa-solid fa-folder ct-dropdown__trigger-icon"></i>\n            <span class="ct-dropdown__trigger-text ${ft(!n&&"ct-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(t)}</span>\n            ${i>0?`<span class="ct-dropdown__count">${i}</span>`:""}\n            <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n        `}const i=ct(`#${h.pW}_new_session_btn`);i&&(i.disabled=!r);const o=ct(`#${h.pW}_session_list`);o&&(o.innerHTML=hn())}var yn=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function _n(t){const e=SillyTavern.libs.DOMPurify,n=t.isReady?"ct-api-banner--ready":"ct-api-banner--error",r=t.isReady?"fa-circle-check":"fa-circle-xmark",a="cc"===t.apiType?"Chat":"Text";return`\n        <div class="ct-api-banner ${n}">\n            <div class="ct-api-banner__left">\n                <i class="fa-solid ${r}"></i>\n                <span class="ct-api-banner__name">${e.sanitize(t.displayName)}</span>\n                <span class="ct-badge ct-badge--small">${a}</span>\n            </div>\n            <div class="ct-api-banner__right">\n                <span class="ct-api-banner__model" title="${e.sanitize(t.model)}">${e.sanitize(t.modelDisplay)}</span>\n                <span class="ct-api-banner__limits">${t.maxOutput.toLocaleString()}t max</span>\n            </div>\n        </div>\n        ${t.error?`\n            <div class="ct-api-error">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                <span>${e.sanitize(t.error)}</span>\n            </div>\n        `:""}\n    `}function xn(t){const e=SillyTavern.libs.DOMPurify;if(!t)return'\n            <div class="ct-profile-info ct-profile-info--empty">\n                <i class="fa-solid fa-circle-question"></i>\n                <span>Select a profile above</span>\n            </div>\n        ';const n="cc"===t.mode?"Chat":"Text";return`\n        <div class="ct-profile-info ${t.isSupported?"":"ct-profile-info--error"}">\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">API</span>\n                <span class="ct-profile-info__value">${e.sanitize(t.api)}</span>\n            </div>\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">Model</span>\n                <span class="ct-profile-info__value" title="${e.sanitize(t.model)}">${e.sanitize(function(t){const e=t.replace(/^anthropic\//,"").replace(/^openai\//,"").replace(/^google\//,"").replace(/^meta-llama\//,"llama-").replace(/^mistralai\//,"mistral-");if(e.length>30)return e.substring(0,27)+"...";return e}(t.model))}</span>\n            </div>\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">Type</span>\n                <span class="ct-badge ct-badge--small">${n}</span>\n            </div>\n            ${t.presetName?`\n                <div class="ct-profile-info__row">\n                    <span class="ct-profile-info__label">Preset</span>\n                    <span class="ct-profile-info__value">${e.sanitize(t.presetName)}</span>\n                </div>\n            `:""}\n            ${t.isSupported?"":`\n                <div class="ct-profile-info__error">\n                    <i class="fa-solid fa-triangle-exclamation"></i>\n                    <span>${t.validationError||"Profile configuration is invalid"}</span>\n                </div>\n            `}\n        </div>\n    `}function wn(t,e){const n=ct(`#${h.pW}_api_status_banner`,t);if(!n)return;let r=null;if(e){const e=ct(`#${h.pW}_profile_select`,t);r=(null==e?void 0:e.value)||null}const a=(0,h.Lq)(r);n.innerHTML=_n(a)}function $n(){return yn(this,void 0,void 0,function*(){const t=SillyTavern.libs.DOMPurify,e=SillyTavern.getContext(),n=function(){var t;const e=SillyTavern.libs.DOMPurify,n=(0,b.getSettings)(),r=(0,h.We)(),a=(0,h.Lq)("profile"===n.generationMode?n.profileId:null);return`\n        <div id="${h.pW}_settings_modal" class="ct-settings-modal">\n            <div class="ct-settings-header">\n                <h2>\n                    <i class="fa-solid fa-cog"></i>\n                    ${h.hi} Settings\n                </h2>\n            </div>\n\n            <div class="ct-settings-body">\n                \x3c!-- Keyboard Shortcuts --\x3e\n                <section class="ct-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-keyboard"></i>\n                        Keyboard Shortcuts\n                    </h3>\n                    <div class="ct-shortcuts-list">\n                        <div class="ct-shortcut">\n                            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n                            <span>Run current stage</span>\n                        </div>\n                        <div class="ct-shortcut">\n                            <kbd>Escape</kbd>\n                            <span>Cancel generation</span>\n                        </div>\n                    </div>\n                </section>\n\n                \x3c!-- Generation Settings --\x3e\n                <section class="ct-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-sliders"></i>\n                        Generation\n                    </h3>\n\n                    \x3c!-- Current API Status --\x3e\n                    <div id="${h.pW}_api_status_banner">\n                        ${_n(a)}\n                    </div>\n\n                    \x3c!-- Mode Toggle --\x3e\n                    ${(0,h.mi)()?`\n                    <div class="ct-gen-mode-toggle">\n                        <label class="ct-gen-mode-option ${"current"===n.generationMode?"ct-gen-mode-option--active":""}" data-mode="current">\n                            <input type="radio" name="${h.pW}_gen_mode" value="current" ${"current"===n.generationMode?"checked":""}>\n                            <i class="fa-solid fa-sliders"></i>\n                            <span>Current ST Settings</span>\n                        </label>\n                        <label class="ct-gen-mode-option ${"profile"===n.generationMode?"ct-gen-mode-option--active":""}" data-mode="profile">\n                            <input type="radio" name="${h.pW}_gen_mode" value="profile" ${"profile"===n.generationMode?"checked":""}>\n                            <i class="fa-solid fa-plug"></i>\n                            <span>Connection Profile</span>\n                        </label>\n                    </div>\n\n                    \x3c!-- Profile Selection --\x3e\n                    <div id="${h.pW}_profile_section" class="ct-profile-section ${"current"===n.generationMode?"ct-hidden":""}">\n                        ${r.length>0?`\n                        <div class="ct-setting-item">\n                            <label class="ct-setting-label">Select Profile</label>\n                            <select id="${h.pW}_profile_select" class="ct-select text_pole">\n                                <option value="">-- Select a profile --</option>\n                                ${r.map(t=>`\n                                <option value="${t.id}"\n                                        ${t.id===n.profileId?"selected":""}\n                                        ${t.isSupported?"":"disabled"}>\n                                    ${e.sanitize(t.name)}${t.isSupported?"":" (invalid)"}\n                                </option>\n                                `).join("")}\n                            </select>\n                        </div>\n                        <div id="${h.pW}_profile_info_container">\n                            ${xn(r.find(t=>t.id===n.profileId)||null)}\n                        </div>\n                        `:'\n                        <div class="ct-profile-empty">\n                            <i class="fa-solid fa-info-circle"></i>\n                            <div>\n                                <strong>No connection profiles found</strong>\n                                <p>Create profiles in SillyTavern\'s Connection Manager to use specific API configurations.</p>\n                            </div>\n                        </div>\n                        '}\n                    </div>\n                    `:""}\n\n                    \x3c!-- Max Tokens Override --\x3e\n                    <details class="ct-collapsible">\n                        <summary>Response Length Override</summary>\n                        <div class="ct-setting-item">\n                            <label class="ct-setting-label">\n                                <input type="checkbox"\n                                       id="${h.pW}_max_tokens_enabled"\n                                       ${null!==n.maxTokensOverride?"checked":""} />\n                                <span>Override max response tokens</span>\n                            </label>\n                            <input type="number"\n                                   id="${h.pW}_max_tokens"\n                                   class="ct-number-input text_pole"\n                                   value="${null!==(t=n.maxTokensOverride)&&void 0!==t?t:4096}"\n                                   min="100"\n                                   max="32000"\n                                   step="100"\n                                   ${null===n.maxTokensOverride?"disabled":""} />\n                            <span class="ct-setting-hint">\n                                Leave unchecked to use the profile's preset settings\n                            </span>\n                        </div>\n                    </details>\n                </section>\n\n                \x3c!-- System Prompt --\x3e\n                <section class="ct-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-terminal"></i>\n                        System Prompt\n                    </h3>\n                    <p class="ct-setting-desc">\n                        The system prompt is sent with every generation. Your additions are appended after the base prompt.\n                    </p>\n\n                    <div class="ct-setting-item">\n                        <label class="ct-setting-label">Your Additions</label>\n                        <textarea id="${h.pW}_user_system_prompt"\n                                  class="ct-textarea text_pole"\n                                  rows="4"\n                                  placeholder="Add custom instructions...">${e.sanitize(n.userSystemPrompt)}</textarea>\n                    </div>\n\n                    <details class="ct-collapsible">\n                        <summary>Base Prompt (Read-only)</summary>\n                        <pre class="ct-readonly-text">${e.sanitize(n.baseSystemPrompt)}</pre>\n                    </details>\n                </section>\n\n                \x3c!-- Refinement Prompt --\x3e\n                <section class="ct-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-rotate"></i>\n                        Refinement Prompt\n                    </h3>\n                    <p class="ct-setting-desc">\n                        Instructions for refinement iterations. Your additions are appended after the base.\n                    </p>\n\n                    <div class="ct-setting-item">\n                        <label class="ct-setting-label">Your Additions</label>\n                        <textarea id="${h.pW}_user_refinement_prompt"\n                                  class="ct-textarea text_pole"\n                                  rows="4"\n                                  placeholder="Add custom refinement instructions...">${e.sanitize(n.userRefinementPrompt)}</textarea>\n                    </div>\n\n                    <details class="ct-collapsible">\n                        <summary>Base Prompt (Read-only)</summary>\n                        <pre class="ct-readonly-text">${e.sanitize(n.baseRefinementPrompt)}</pre>\n                    </details>\n                </section>\n\n                \x3c!-- Reset Settings --\x3e\n                <section class="ct-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-rotate-left"></i>\n                        Reset\n                    </h3>\n                    <button id="${h.pW}_reset_settings"\n                            class="ct-btn ct-btn--small ct-btn--danger menu_button"\n                            type="button">\n                        <i class="fa-solid fa-rotate-left"></i>\n                        Reset All Settings\n                    </button>\n                </section>\n            </div>\n\n            <div class="ct-settings-footer">\n                <span class="ct-version">v${h.xv}</span>\n                <button id="${h.pW}_settings_close"\n                        class="ct-btn ct-btn--primary menu_button"\n                        type="button">\n                    <i class="fa-solid fa-check"></i>\n                    Save & Close\n                </button>\n            </div>\n        </div>\n    `}();new e.Popup(t.sanitize(n),e.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show(),yield new Promise(t=>setTimeout(t,0));const r=ct(`#${h.pW}_settings_modal`);if(!r)return;const a=function(t){const e=[],n=lt(".ct-gen-mode-option",t),r=ct(`#${h.pW}_profile_section`,t);for(const a of n)e.push(dt(a,"click",()=>{const e=a.dataset.mode;n.forEach(t=>t.classList.remove("ct-gen-mode-option--active")),a.classList.add("ct-gen-mode-option--active"),r&&r.classList.toggle("ct-hidden","current"===e),wn(t,"profile"===e)}));const a=ct(`#${h.pW}_profile_select`,t),i=ct(`#${h.pW}_profile_info_container`,t);a&&i&&e.push(dt(a,"change",()=>{const e=(0,h.We)().find(t=>t.id===a.value);i.innerHTML=xn(e||null),wn(t,!0)}));const o=ct(`#${h.pW}_max_tokens_enabled`,t),s=ct(`#${h.pW}_max_tokens`,t);o&&s&&e.push(dt(o,"change",()=>{s.disabled=!o.checked}));const c=ct(`#${h.pW}_reset_settings`,t);c&&e.push(dt(c,"click",()=>yn(this,void 0,void 0,function*(){if(!(yield h.lY.confirm("Reset Settings","This will reset all settings to defaults. Custom presets will be kept. Continue?")))return;(0,b.resetSettings)(),h.oR.success("Settings reset to defaults");const e=t.closest(".popup"),n=null==e?void 0:e.querySelector(".popup-button-cancel, .popup-button-ok");null==n||n.click(),setTimeout(()=>$n(),100)})));return()=>{e.forEach(t=>t())}}(r),i=ct(`#${h.pW}_settings_close`,r);i&&i.addEventListener("click",()=>{!function(){const t=(0,b.getSettings)(),e=document.querySelector(`input[name="${h.pW}_gen_mode"]:checked`);e&&(t.generationMode=e.value);const n=ct(`#${h.pW}_profile_select`);n&&(t.profileId=n.value||null);const r=ct(`#${h.pW}_max_tokens_enabled`),a=ct(`#${h.pW}_max_tokens`);r&&a&&(t.maxTokensOverride=r.checked?parseInt(a.value,10):null);const i=ct(`#${h.pW}_user_system_prompt`);i&&(t.userSystemPrompt=i.value);const o=ct(`#${h.pW}_user_refinement_prompt`);o&&(t.userRefinementPrompt=o.value);(0,b.save)(),h.oR.success("Settings saved")}(),a();const t=r.closest(".popup"),e=null==t?void 0:t.querySelector(".popup-button-cancel, .popup-button-ok");null==e||e.click()})})}let kn=null;function Sn(){const t=SillyTavern.libs.DOMPurify,e=(0,h.Lq)(kn),n=(0,h.mi)(),r=n?(0,h.We)():[],a=e.isReady?"fa-circle-check ct-text-success":"fa-circle-xmark ct-text-danger",i=e.isReady?"ct-api-status--ready":"ct-api-status--error",o=n&&r.length>0?`\n        <select id="${h.pW}_profile_select" \n                class="ct-select ct-select--sm text_pole" \n                aria-label="Connection profile">\n            <option value="" ${kn?"":"selected"}>\n                Current Settings\n            </option>\n            ${r.map(t=>function(t,e){const n=SillyTavern.libs.DOMPurify;return`\n        <option value="${t.id}" \n                ${e?"selected":""}\n                ${t.isSupported?"":"disabled"}>\n            ${n.sanitize(t.name)} (${n.sanitize(t.model)})\n        </option>\n    `}(t,t.id===kn)).join("")}\n        </select>\n    `:"";return`\n        <div id="${h.pW}_api_status" class="ct-api-status ${i}">\n            <div class="ct-api-status__indicator">\n                <i class="fa-solid ${a}"></i>\n                <span class="ct-api-status__text">${t.sanitize(e.modelDisplay)}</span>\n            </div>\n            ${o}\n            ${e.error?`\n                <span class="ct-api-status__error" title="${t.sanitize(e.error)}">\n                    <i class="fa-solid fa-exclamation-triangle"></i>\n                </span>\n            `:""}\n        </div>\n    `}function Pn(t){const e=[],n=ct(`#${h.pW}_profile_select`,t);return n&&e.push(dt(n,"change",()=>{const t=n.value||null;kn=t;(0,b.getSettings)().selectedProfile=t,(0,b.save)(),function(){const t=ct(`#${h.pW}_api_status`);if(!t)return;const e=t.parentElement;e&&(e.innerHTML=Sn(),Pn(e))}()})),()=>{e.forEach(t=>t())}}var Rn=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};let Cn=null;function Tn(){return`\n<div id="${h.pW}_popup" class="ct-popup">\n    <header class="ct-header">\n        <div class="ct-header__left">\n            ${function(){const t=SillyTavern.libs.DOMPurify,e=D().character,n=e?t.sanitize(e.name):"Select character...",r=e?`<img class="ct-dropdown__trigger-avatar"\n               src="${SillyTavern.getContext().getThumbnailUrl("avatar",e.avatar)}"\n               alt=""\n               onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user ct-dropdown__trigger-icon"></i>';return`\n        <div id="${h.pW}_char_dropdown" class="ct-dropdown ${Pt?"ct-dropdown--open":""}">\n            <button id="${h.pW}_char_trigger"\n                    class="ct-dropdown__trigger"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${Pt}">\n                ${r}\n                <span class="ct-dropdown__trigger-text ${e?"":"ct-dropdown__trigger-text--placeholder"}">${n}</span>\n                <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="ct-dropdown__panel" role="listbox">\n                <div class="ct-dropdown__search">\n                    <i class="fa-solid fa-search ct-dropdown__search-icon"></i>\n                    <input type="text"\n                           id="${h.pW}_char_search"\n                           class="ct-dropdown__search-input"\n                           placeholder="Search characters..."\n                           autocomplete="off"\n                           value="${t.sanitize(Rt)}" />\n                    ${Rt?'\n                        <button class="ct-dropdown__search-clear" type="button" aria-label="Clear">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    ':""}\n                </div>\n                <div id="${h.pW}_char_list" class="ct-dropdown__list ct-scrollable">\n                    ${Ot()}\n                </div>\n            </div>\n        </div>\n    `}()}\n            ${function(){const t=D(),e=t.sessions.find(e=>e.id===t.activeSessionId),n=!!t.character;let r="No session";n?e&&(r=gn(e)):r="Select character...";const a=t.sessions.length;return`\n        <div id="${h.pW}_session_dropdown" class="ct-dropdown ct-dropdown--session ${ft(fn&&"ct-dropdown--open")} ${ft(!n&&"ct-dropdown--disabled")}">\n            <button id="${h.pW}_session_trigger"\n                    class="ct-dropdown__trigger ct-dropdown__trigger--session"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${fn}"\n                    ${n?"":"disabled"}>\n                <i class="fa-solid fa-folder ct-dropdown__trigger-icon"></i>\n                <span class="ct-dropdown__trigger-text ${ft(!e&&"ct-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(r)}</span>\n                ${a>0?`<span class="ct-dropdown__count">${a}</span>`:""}\n                <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="ct-dropdown__panel ct-dropdown__panel--session" role="listbox">\n                <div id="${h.pW}_session_list" class="ct-dropdown__list ct-dropdown__list--session ct-scrollable">\n                    ${hn()}\n                </div>\n                <div class="ct-dropdown__footer">\n                    <button id="${h.pW}_new_session_btn"\n                            class="menu_button menu_button--sm menu_button--primary ct-dropdown__new-btn"\n                            type="button"\n                            ${n?"":"disabled"}>\n                        <i class="fa-solid fa-plus"></i>\n                        New Session\n                    </button>\n                </div>\n            </div>\n        </div>\n    `}()}\n        </div>\n        <div class="ct-header__center">\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <h2>Character Tools</h2>\n            <div id="${h.pW}_api_status_container">\n                ${function(){const t=(0,h.Lq)(kn),e=t.isReady?"fa-circle-check ct-text-success":"fa-circle-xmark ct-text-danger";return`\n        <div class="ct-api-badge ${ft(!t.isReady&&"ct-api-badge--error")}" \n             title="${t.statusText}${t.error?": "+t.error:""}">\n            <i class="fa-solid ${e}"></i>\n            <span>${t.modelDisplay}</span>\n        </div>\n    `}()}\n            </div>\n        </div>\n        <div class="ct-header__right">\n            <button id="${h.pW}_export_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Export character as PNG"\n                    aria-label="Export character">\n                <i class="fa-solid fa-download"></i>\n            </button>\n            <button id="${h.pW}_settings_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Settings"\n                    aria-label="Settings">\n                <i class="fa-solid fa-cog"></i>\n            </button>\n            <button id="${h.pW}_close_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Close"\n                    aria-label="Close popup">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    </header>\n\n    <div class="ct-toolbar">\n        \n        <nav class="ct-stage-tabs" role="tablist" aria-label="Pipeline stages">\n            ${h.an.map(nn).join("")}\n        </nav>\n    \n        <div id="${h.pW}_pipeline_controls" class="ct-toolbar__controls">\n            ${rn()}\n        </div>\n    </div>\n\n    <div class="ct-body">\n        <aside class="ct-panel ct-panel--config ct-scrollable">\n            ${function(){const t=SillyTavern.libs.DOMPurify,e=D(),n=e.activeStage,r=e.stageConfigs[n];let a=r.customPrompt;if(!a&&r.promptPresetId){const t=(0,b.getPromptPreset)(r.promptPresetId);t&&(a=t.prompt)}let i=r.customSchema;if(!i&&r.schemaPresetId){const t=(0,b.getSchemaPreset)(r.schemaPresetId);t&&(i=JSON.stringify(t.schema,null,2))}return`\n        <section class="ct-section ct-stage-config" aria-label="Stage Configuration">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">\n                    <i class="fa-solid ${h.iu[n]}"></i>\n                    ${h.BA[n]} Configuration\n                </h3>\n            </div>\n\n            \x3c!-- Field Selection --\x3e\n            <div class="ct-stack ct-stack--tight">\n                <div class="ct-row ct-row--between">\n                    <div class="ct-row">\n                        <i class="fa-solid fa-list-check ct-text-accent"></i>\n                        <span class="ct-font-medium ct-text-sm">Fields to Include</span>\n                    </div>\n                    <button id="${h.pW}_link_fields"\n                            class="menu_button menu_button--icon menu_button--sm menu_button--ghost ${Q()?"ct-active":""}"\n                            type="button"\n                            title="${Q()?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)"}"\n                            aria-pressed="${Q()}">\n                        <i class="fa-solid ${Q()?"fa-link":"fa-link-slash"}"></i>\n                    </button>\n                </div>\n                <div id="${h.pW}_fields_container">\n                    ${ae()}\n                </div>\n            </div>\n\n            \x3c!-- Prompt Configuration --\x3e\n            <div class="ct-stack ct-stack--tight ct-mt-4">\n                <div class="ct-row ct-row--between">\n                    <div class="ct-row">\n                        <i class="fa-solid fa-message ct-text-accent"></i>\n                        <span class="ct-font-medium ct-text-sm">Prompt</span>\n                    </div>\n                    <div class="ct-row ct-gap-1">\n                        <button id="${h.pW}_save_prompt"\n                                class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Save as preset"\n                                aria-label="Save as preset">\n                            <i class="fa-solid fa-floppy-disk"></i>\n                        </button>\n                        ${ie("prompt",n,r.promptPresetId)}\n                    </div>\n                </div>\n                <div class="ct-form-group">\n                    <textarea id="${h.pW}_prompt"\n                              placeholder="Enter instructions for this stage..."\n                              rows="6">${t.sanitize(a)}</textarea>\n                    <div class="ct-form-group__hint ct-text-right">\n                        <span id="${h.pW}_prompt_tokens">Calculating...</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Structured Output Toggle --\x3e\n            <div class="ct-stack ct-stack--tight ct-mt-4">\n                <label class="ct-checkbox">\n                    <input type="checkbox"\n                           id="${h.pW}_use_schema"\n                           ${r.useStructuredOutput?"checked":""} />\n                    <span>Use Structured Output (JSON Schema)</span>\n                </label>\n\n                <div id="${h.pW}_schema_section"\n                     class="${ft(!r.useStructuredOutput&&"ct-hidden")} ct-stack ct-stack--tight ct-mt-2">\n                    <div class="ct-row ct-row--between">\n                        <div class="ct-row">\n                            <i class="fa-solid fa-code ct-text-accent"></i>\n                            <span class="ct-font-medium ct-text-sm">JSON Schema</span>\n                        </div>\n                        ${ie("schema",n,r.schemaPresetId)}\n                    </div>\n                    <textarea id="${h.pW}_schema"\n                              class="ct-textarea--code"\n                              placeholder='{"name": "MySchema", "strict": true, "value": {...}}'\n                              rows="8">${t.sanitize(i)}</textarea>\n                    <div class="ct-button-group">\n                        <button id="${h.pW}_validate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-check"></i>\n                            Validate\n                        </button>\n                        <button id="${h.pW}_format_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-indent"></i>\n                            Format\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Preview --\x3e\n            <div class="ct-mt-4">\n                <button id="${h.pW}_preview"\n                        class="menu_button menu_button--full"\n                        type="button"\n                        ${e.character?"":"disabled"}>\n                    <i class="fa-solid fa-eye"></i>\n                    Preview Full Prompt\n                </button>\n            </div>\n        </section>\n    `}()}\n        </aside>\n        <main class="ct-panel ct-panel--results">\n            ${Qe()}\n        </main>\n    </div>\n</div>`}let zn=[];function On(){return Rn(this,void 0,void 0,function*(){const t=SillyTavern.getContext(),{DOMPurify:e}=SillyTavern.libs;I();const n=Tn();new t.Popup(e.sanitize(n),t.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>Rn(this,void 0,void 0,function*(){yield function(){return Rn(this,void 0,void 0,function*(){!function(){for(const t of re)t.flush()}(),yield B(),zn.forEach(t=>t()),zn=[],dn.forEach(t=>t()),dn=[],function(){const t=ct(`#${h.pW}_preset_drawer`);t&&t.remove(),Dt.forEach(t=>t()),Dt=[],Nt.isOpen=!1}(),vt.clear(),mt.clear(),gt=!1,function(){for(const t of re)t.cancel();re=[]}(),Cn=null,M(),(0,b.clearCache)(),h.Rm.debug("Popup closed")})}()})),yield new Promise(t=>setTimeout(t,0)),Cn=document.getElementById(`${h.pW}_popup`),Cn?(!function(t){if(ct(`#${h.pW}_preset_drawer`))return;const e=t.closest(".popup");e?e.insertAdjacentHTML("beforeend",Lt()):document.body.insertAdjacentHTML("beforeend",Lt())}(Cn),function(t){zn.forEach(t=>t()),zn=[],zn.push(ht("characterSelector",Et,["character","session"])),zn.push(ht("stageTabs",an,["stage","pipeline"])),zn.push(ht("pipelineControls",on,["pipeline","character"])),zn.push(ht("stageConfig",se,["stage","config","fields","character"])),zn.push(ht("results",Ke,["results","stage"])),zn.push(ht("sessionDropdown",bn,["session","character"])),zn.push(function(t){const e=[],n=ct(`#${h.pW}_char_dropdown`,t),r=ct(`#${h.pW}_char_trigger`,t),a=ct(`#${h.pW}_char_search`,t),i=ct(`#${h.pW}_char_list`,t);r&&e.push(dt(r,"click",t=>{t.stopPropagation(),Tt(!Pt),Pt&&a&&setTimeout(()=>a.focus(),0)}));const o=t=>{Pt&&n&&!n.contains(t.target)&&Tt(!1)};if(document.addEventListener("click",o),e.push(()=>document.removeEventListener("click",o)),a){const t=SillyTavern.libs.lodash.debounce(()=>{Rt=a.value,Ct=-1,i&&(i.innerHTML=Ot())},h.U8.SEARCH);e.push(dt(a,"input",()=>{t()})),e.push(dt(a,"keydown",t=>{const e=lt(".ct-char-option",i),n=e.length-1;switch(t.key){case"ArrowDown":t.preventDefault(),Ct=Math.min(Ct+1,n),At(e);break;case"ArrowUp":t.preventDefault(),Ct=Math.max(Ct-1,0),At(e);break;case"Enter":t.preventDefault(),Ct>=0&&e[Ct]&&jt(e[Ct]);break;case"Escape":t.preventDefault(),Tt(!1),null==r||r.focus()}})),e.push(()=>t.cancel())}const s=ct(".ct-dropdown__search-clear",t);return s&&a&&e.push(dt(s,"click",t=>{t.stopPropagation(),a.value="",Rt="",Ct=-1,i&&(i.innerHTML=Ot()),a.focus()})),i&&e.push(dt(i,"click",t=>{const e=t.target.closest(".ct-char-option");e&&jt(e)})),()=>{e.forEach(t=>t()),Pt=!1,Rt="",Ct=-1}}(t)),zn.push(function(t){const e=[],n=ct(`#${h.pW}_session_dropdown`,t),r=ct(`#${h.pW}_session_trigger`,t),a=ct(`#${h.pW}_session_list`,t),i=ct(`#${h.pW}_new_session_btn`,t);r&&e.push(dt(r,"click",t=>{t.stopPropagation(),r.disabled||mn(!fn)}));const o=t=>{fn&&n&&!n.contains(t.target)&&(mn(!1),bn())};return document.addEventListener("click",o),e.push(()=>document.removeEventListener("click",o)),i&&e.push(dt(i,"click",t=>un(this,void 0,void 0,function*(){t.stopPropagation(),(yield G())&&(h.oR.success("New session created"),mn(!1),xt())}))),a&&(e.push(dt(a,"click",t=>un(this,void 0,void 0,function*(){const e=t.target,n=e.closest(".ct-session-option");if(!n)return;const r=n.dataset.sessionId||e.dataset.sessionId;if(r){if(e.closest(".ct-session-edit"))return t.stopPropagation(),vn=r,bn(),void setTimeout(()=>{const t=ct(`.ct-session-option__name-input[data-session-id="${r}"]`);t&&(t.focus(),t.select())},0);if(e.closest(".ct-session-save")){t.stopPropagation();const e=ct(`.ct-session-option__name-input[data-session-id="${r}"]`);return e&&(yield J(r,e.value),h.oR.success("Session renamed")),vn=null,void bn()}if(e.closest(".ct-session-cancel"))return t.stopPropagation(),vn=null,void bn();if(e.closest(".ct-session-delete"))return t.stopPropagation(),void((yield h.lY.confirm("Delete Session","Are you sure you want to delete this session? This cannot be undone."))&&(yield q(r),h.oR.success("Session deleted"),bn(),xt()));n.classList.contains("ct-session-option--active")||vn||((yield U(r))?(h.oR.success("Session loaded"),mn(!1),xt()):h.oR.error("Failed to load session"))}}))),e.push(dt(a,"keydown",t=>un(this,void 0,void 0,function*(){const e=t.target;if(!e.classList.contains("ct-session-option__name-input"))return;const n=e.dataset.sessionId;n&&("Enter"===t.key?(t.preventDefault(),yield J(n,e.value),h.oR.success("Session renamed"),vn=null,bn()):"Escape"===t.key&&(t.preventDefault(),vn=null,bn()))})))),()=>{e.forEach(t=>t()),fn=!1,vn=null}}(t)),zn.push(function(t){const e=[],n=ct(".ct-stage-tabs",t);n&&e.push(dt(n,"click",t=>{const e=t.target.closest(".ct-stage-tab");if(!e)return;const n=e.dataset.stage;n&&(X(n),an(),se(),Ke(),on())}));const r=ct(`#${h.pW}_pipeline_controls`,t);return r&&pn(r),()=>{e.forEach(t=>t())}}(t)),zn.push(le(t)),zn.push(Xe(t));const e=ct(`#${h.pW}_api_status_container`,t);e&&zn.push(Pn(e));const n=ct(`#${h.pW}_export_btn`,t);n&&zn.push(dt(n,"click",()=>{!function(){me(this,void 0,void 0,function*(){const t=D();if(!t.character)return h.oR.warning("No character selected"),!1;const e=t.character,n=yield ye(e.avatar);if(!n)return h.oR.error("Failed to export character PNG"),!1;const r=URL.createObjectURL(n),a=document.createElement("a");return a.href=r,a.download=`${e.name}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),h.oR.success("Character PNG downloaded!"),!0})}()}));const r=ct(`#${h.pW}_settings_btn`,t);r&&zn.push(dt(r,"click",()=>{$n()}));const a=ct(`#${h.pW}_close_btn`,t);a&&zn.push(dt(a,"click",()=>{!function(){if(!Cn)return;const t=Cn.closest(".popup"),e=null==t?void 0:t.querySelector(".popup-button-cancel, .popup-button-ok");null==e||e.click()}()}));const i=e=>{const n=D();if(e.ctrlKey&&"Enter"===e.key){e.preventDefault();const r=ct(`#${h.pW}_run_stage`,t);r&&!n.isGenerating&&n.character&&r.click()}"Escape"===e.key&&n.isGenerating&&(e.preventDefault(),function(){const t=L();(null==t?void 0:t.abortController)&&(t.abortController.abort(),t.abortController=null,t.isGenerating=!1)}())};document.addEventListener("keydown",i),zn.push(()=>document.removeEventListener("keydown",i))}(Cn),h.Rm.debug("Popup opened")):h.Rm.error("Popup element not found")})}var En=function(t,e,n,r){return new(n||(n=Promise))(function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,s)}c((r=r.apply(t,e||[])).next())})};function An(){return En(this,void 0,void 0,function*(){const t=document.getElementById("extensions_settings");if(!t)return void h.Rm.error("Extensions container not found");t.insertAdjacentHTML("beforeend",function(){const t=(0,b.getSettings)();return`\n<div id="${h.pW}_panel">\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b><i class="fa-solid fa-wand-magic-sparkles"></i> ${h.hi}</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n            <div class="flex-container flexFlowColumn">\n                <small class="ct-panel-version">Version ${h.xv}</small>\n                <p class="ct-panel-desc">\n                    AI-powered character card analysis, scoring, and enhancement.\n                    Run the pipeline to evaluate and improve your character cards.\n                </p>\n                <div class="ct-panel-actions">\n                    <button id="${h.pW}_open_btn" class="menu_button menu_button_icon">\n                        <i class="fa-solid fa-play"></i>\n                        <span>Open Character Tools</span>\n                    </button>\n                </div>\n                <hr class="ct-panel-divider" />\n                <div class="ct-panel-debug">\n                    <label class="ct-panel-checkbox">\n                        <input type="checkbox" id="${h.pW}_debug_mode" ${t.debugMode?"checked":""} />\n                        <span>Enable debug logging</span>\n                    </label>\n                    <button id="${h.pW}_view_logs" class="menu_button menu_button--sm">\n                        <i class="fa-solid fa-terminal"></i>\n                        <span>View Logs</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>`}());const e=document.getElementById(`${h.pW}_open_btn`);null==e||e.addEventListener("click",On);const n=document.getElementById(`${h.pW}_debug_mode`);null==n||n.addEventListener("change",()=>{(0,b.getSettings)().debugMode=n.checked,(0,h.pM)(n.checked),(0,b.save)(),h.oR.info(n.checked?"Debug logging enabled":"Debug logging disabled")});const r=document.getElementById(`${h.pW}_view_logs`);null==r||r.addEventListener("click",()=>{h.oR.info("Check browser console (F12) for logs")}),h.Rm.debug("Panel initialized")})}function jn(){try{h.Rm.info(`${h.hi} v${h.xv} initializing...`),(0,b.getSettings)(),An(),function(){const{eventSource:t,eventTypes:e}=SillyTavern.getContext();t.on(e.CHARACTER_EDITED,()=>{h.Rm.debug("Character edited, resetting Fuse index and refreshing popup"),St(),function(){const t=L();if(!(null==t?void 0:t.character))return;const e=(SillyTavern.getContext().characters||[]).find(e=>{var n;return e.avatar===(null===(n=t.character)||void 0===n?void 0:n.avatar)});e&&(t.character=e)}(),_t()}),t.on(e.CHARACTER_DELETED,()=>{h.Rm.debug("Character deleted, resetting Fuse index"),St()}),t.on(e.CHATCOMPLETION_SOURCE_CHANGED,()=>{h.Rm.debug("Chat completion source changed")}),t.on(e.CHATCOMPLETION_MODEL_CHANGED,()=>{h.Rm.debug("Chat completion model changed")}),h.Rm.debug("Event listeners registered")}(),h.Rm.info(`${h.hi} v${h.xv} loaded`)}catch(t){h.Rm.error("Extension initialization failed",t),h.oR.error(`${h.hi} failed to initialize. Check console.`)}}function Wn(){(0,b.clearCache)(),h.Rm.info("Extension cleaned up")}(0,h.pM)(h.Oi);const{eventSource:Nn,eventTypes:In}=SillyTavern.getContext();Nn.on(In.APP_READY,jn);export{Wn as cleanup,jn as init};export const log=h.Rm;