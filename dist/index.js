var e={29(e,t,r){var n=r(566);e.exports=function(e){if(137!==e[0])throw new Error("Invalid .png file header");if(80!==e[1])throw new Error("Invalid .png file header");if(78!==e[2])throw new Error("Invalid .png file header");if(71!==e[3])throw new Error("Invalid .png file header");if(13!==e[4])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");if(10!==e[5])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");if(26!==e[6])throw new Error("Invalid .png file header");if(10!==e[7])throw new Error("Invalid .png file header: possibly caused by DOS-Unix line ending conversion?");var t=!1,r=[],o=8;for(;o<e.length;){i[3]=e[o++],i[2]=e[o++],i[1]=e[o++],i[0]=e[o++];var c=s[0]+4,l=new Uint8Array(c);l[0]=e[o++],l[1]=e[o++],l[2]=e[o++],l[3]=e[o++];var d=String.fromCharCode(l[0])+String.fromCharCode(l[1])+String.fromCharCode(l[2])+String.fromCharCode(l[3]);if(!r.length&&"IHDR"!==d)throw new Error("IHDR header missing");if("IEND"===d){t=!0,r.push({name:d,data:new Uint8Array(0)});break}for(var u=4;u<c;u++)l[u]=e[o++];i[3]=e[o++],i[2]=e[o++],i[1]=e[o++],i[0]=e[o++];var p=a[0];if(n.buf(l)!==p)throw new Error("CRC values for "+d+" header do not match, PNG file is likely corrupted");var f=new Uint8Array(l.buffer.slice(4));r.push({name:d,data:f})}if(!t)throw new Error(".png file ended prematurely: no IEND header was found");return r};var i=new Uint8Array(4),a=new Int32Array(i.buffer),s=new Uint32Array(i.buffer)},56(e,t,r){e.exports=function(e){var t=r.nc;t&&e.setAttribute("nonce",t)}},72(e){var t=[];function r(e){for(var r=-1,n=0;n<t.length;n++)if(t[n].identifier===e){r=n;break}return r}function n(e,n){for(var a={},s=[],o=0;o<e.length;o++){var c=e[o],l=n.base?c[0]+n.base:c[0],d=a[l]||0,u="".concat(l," ").concat(d);a[l]=d+1;var p=r(u),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var m=i(f,n);n.byIndex=o,t.splice(o,0,{identifier:u,updater:m,references:1})}s.push(u)}return s}function i(e,t){var r=t.domAPI(t);r.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;r.update(e=t)}else r.remove()}}e.exports=function(e,i){var a=n(e=e||[],i=i||{});return function(e){e=e||[];for(var s=0;s<a.length;s++){var o=r(a[s]);t[o].references--}for(var c=n(e,i),l=0;l<a.length;l++){var d=r(a[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}a=c}}},113(e){e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},179(e,t,r){r.r(t),r.d(t,{generate:()=>o,generateSimple:()=>c});var n=r(752),i=r(265),a=r(737),s=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function o(e){return s(this,void 0,void 0,function*(){var t,r,s,o,c,l,d,u;if(null===(t=e.signal)||void 0===t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!(0,n.cW)()){return{success:!1,error:(0,n.Lq)().error||"API not connected. Check your connection settings."}}if(e.jsonSchema){const t=(0,i.i6)(e.jsonSchema);if(!t.valid)return{success:!1,error:`Invalid schema: ${t.error}`}}try{if(null===(r=e.signal)||void 0===r?void 0:r.aborted)return{success:!1,error:"Generation cancelled"};const t=SillyTavern.getContext(),p=(0,a.getSettings)(),f=(0,n.Lq)(p.profileId),m=(null===(s=f.source)||void 0===s?void 0:s.toLowerCase().includes("anthropic"))||(null===(o=f.model)||void 0===o?void 0:o.toLowerCase().includes("anthropic")),g=t.chatCompletionSettings;let h;(p.disableThinking||m&&e.jsonSchema)&&(null==g?void 0:g.reasoning_effort)&&"string"==typeof g.reasoning_effort&&"auto"!==g.reasoning_effort&&(h=g.reasoning_effort,g.reasoning_effort="auto",n.Rm.debug("Disabled reasoning_effort for generation",{reason:p.disableThinking?"user setting":"anthropic structured output",original:h}));const v=p.useAssistantPrefill&&p.assistantPrefill&&!(m&&e.jsonSchema),y=v?p.assistantPrefill:"";v?n.Rm.debug("Using assistant prefill",{prefill:y}):p.useAssistantPrefill&&p.assistantPrefill&&m&&e.jsonSchema&&n.Rm.debug("Skipped assistant prefill (incompatible with Anthropic structured output)");try{const r=yield t.generateRaw({prompt:e.prompt,systemPrompt:null!==(c=e.systemPrompt)&&void 0!==c?c:"",responseLength:null!==(l=e.responseLength)&&void 0!==l?l:null,jsonSchema:null!==(d=e.jsonSchema)&&void 0!==d?d:null,prefill:y});if(null===(u=e.signal)||void 0===u?void 0:u.aborted)return{success:!1,error:"Generation cancelled"};const n=function(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e){const t=e;return"string"==typeof t.text?t.text:"string"==typeof t.content?t.content:JSON.stringify(e)}return String(e)}(r);if(!n||""===n.trim())return{success:!1,error:"Empty response from API"};if(e.jsonSchema){const t=(0,i.Ki)(n,e.jsonSchema);return t?{success:!0,response:n,parsed:t.data,isStructured:!0}:{success:!0,response:n,isStructured:!1}}return{success:!0,response:n,isStructured:!1}}finally{if(void 0!==h){t.chatCompletionSettings.reasoning_effort=h,n.Rm.debug("Restored reasoning_effort",{value:h})}}}catch(e){return function(e){if("AbortError"===e.name)return{success:!1,error:"Generation cancelled"};const t=e instanceof Error?e.message:String(e),r=t.toLowerCase();if(r.includes("401")||r.includes("unauthorized")||r.includes("invalid_api_key")||r.includes("api key"))return{success:!1,error:"API authentication failed. Check your API key."};if(r.includes("429")||r.includes("rate limit"))return{success:!1,error:"Rate limited. Please wait and try again."};if(r.includes("500")||r.includes("502")||r.includes("503"))return{success:!1,error:"API server error. The service may be temporarily unavailable."};if(r.includes("timeout")||r.includes("etimedout"))return{success:!1,error:"Request timed out. Check your connection or try a different model."};if(r.includes("network")||r.includes("econnrefused")||r.includes("fetch failed"))return{success:!1,error:"Network error. Check your internet connection."};if(r.includes("context")||r.includes("too long")||r.includes("maximum context")||r.includes("token"))return{success:!1,error:"Prompt too long for model context. Try reducing input length."};if(r.includes("model")&&(r.includes("not found")||r.includes("does not exist")))return{success:!1,error:"Model not found. It may have been deprecated or renamed."};if(r.includes("content")&&(r.includes("filter")||r.includes("policy")))return{success:!1,error:"Content was filtered by the API. Try rephrasing your prompt."};return{success:!1,error:t}}(e)}})}function c(e,t){return s(this,void 0,void 0,function*(){var r;const n=yield o({prompt:e,systemPrompt:t});return n.success&&null!==(r=n.response)&&void 0!==r?r:null})}},242(e){e.exports="data:image/svg+xml;charset=utf-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath fill=%27%23999%27 d=%27m2 4 4 4 4-4%27/%3E%3C/svg%3E"},251(e,t){t.read=function(e,t,r,n,i){var a,s,o=8*i-n-1,c=(1<<o)-1,l=c>>1,d=-7,u=r?i-1:0,p=r?-1:1,f=e[t+u];for(u+=p,a=f&(1<<-d)-1,f>>=-d,d+=o;d>0;a=256*a+e[t+u],u+=p,d-=8);for(s=a&(1<<-d)-1,a>>=-d,d+=n;d>0;s=256*s+e[t+u],u+=p,d-=8);if(0===a)a=1-l;else{if(a===c)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,n),a-=l}return(f?-1:1)*s*Math.pow(2,a-n)},t.write=function(e,t,r,n,i,a){var s,o,c,l=8*a-i-1,d=(1<<l)-1,u=d>>1,p=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:a-1,m=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+u>=1?p/c:p*Math.pow(2,1-u))*c>=2&&(s++,c/=2),s+u>=d?(o=0,s=d):s+u>=1?(o=(t*c-1)*Math.pow(2,i),s+=u):(o=t*Math.pow(2,u-1)*Math.pow(2,i),s=0));i>=8;e[r+f]=255&o,f+=m,o/=256,i-=8);for(s=s<<i|o,l+=i;l>0;e[r+f]=255&s,f+=m,s/=256,l-=8);e[r+f-m]|=128*g}},265(e,t,r){r.d(t,{jf:()=>$,nr:()=>P,Ki:()=>k,i6:()=>h});const n=8,i=100,a=10,s=100,o=500,c=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],l=[0,1],d=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],u=["minLength","maxLength"],p=["maxItems","uniqueItems","contains","minContains","maxContains"],f=["minProperties","maxProperties","propertyNames","patternProperties"],m=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],g=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function h(e){var t;if("string"==typeof e&&!e.trim())return{valid:!0,schema:void 0};let r;if("string"==typeof e)try{r=JSON.parse(e)}catch(e){const t=e instanceof Error?e.message:"Invalid JSON",r=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${r?` (character ${r[1]})`:""}: ${t}`}}else r=e;if("object"!=typeof r||null===r||Array.isArray(r))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(r)?"array":typeof r)};const n=r;if("string"!=typeof n.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!n.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(n.name))return{valid:!1,error:`'name' must be a valid identifier (got '${n.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof n.value||null===n.value||Array.isArray(n.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const a=n.value;if("string"!=typeof a.type&&!a.anyOf&&!a.allOf&&!a.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==n.strict&&"boolean"!=typeof n.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const s={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(a.$defs&&"object"==typeof a.$defs?(s.defs=a.$defs,s.stats.defCount=Object.keys(s.defs).length):a.definitions&&"object"==typeof a.definitions&&(s.defs=a.definitions,s.stats.defCount=Object.keys(s.defs).length),s.stats.defCount>i&&s.errors.push(`Too many definitions: ${s.stats.defCount} (limit: ${i})`),v(a,"value",s),s.stats.optionalFieldCount>0){const e=s.stats.optionalFieldCount,t=s.stats.totalAnyOfVariants+2*e;e>10&&s.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&s.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(s.errors.length>0)return{valid:!1,error:s.errors.join("\n"),warnings:s.warnings.length>0?s.warnings:void 0};const o={name:n.name,strict:null===(t=n.strict)||void 0===t||t,value:a};return s.info.push(`Schema stats: ${s.stats.propertyCount} properties, ${s.stats.defCount} definitions, ${s.stats.anyOfCount} anyOf blocks, ${s.stats.optionalFieldCount} optional fields, max depth ${s.stats.maxDepth}`),{valid:!0,schema:o,warnings:s.warnings.length>0?s.warnings:void 0,info:s.info.length>0?s.info:void 0}}function v(e,t,r){if(r.currentDepth++,r.stats.maxDepth=Math.max(r.stats.maxDepth,r.currentDepth),r.currentDepth>a)return r.errors.push(`${t}: Exceeds maximum nesting depth of ${a}`),void r.currentDepth--;for(const n of m)void 0!==e[n]&&r.errors.push(`${t}: '${n}' is not supported`);for(const n of d)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of u)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of p)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);for(const n of f)void 0!==e[n]&&r.warnings.push(`${t}: '${n}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,t,r){if(e.startsWith("http://")||e.startsWith("https://"))return void r.errors.push(`${t}: External $ref not supported ('${e}')`);if(r.seenRefs.has(e))return void r.info.push(`${t}: Circular reference to '${e}'`);r.seenRefs.add(e);const n=e.replace(/^#\/(\$defs|definitions)\//,"");r.defs[n]||r.errors.push(`${t}: Reference '${e}' not found in definitions`)}(e.$ref,t,r),void r.currentDepth--;const i=Array.isArray(e.type)?e.type:[e.type];for(const n of i)switch(n){case"object":y(e,t,r);break;case"array":b(e,t,r);break;case"string":_(e,t,r);break;case"number":case"integer":case"boolean":case"null":break;default:!n||e.anyOf||e.allOf||r.warnings.push(`${t}: Unknown type '${n}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,t,r){r.stats.anyOfCount++,r.stats.totalAnyOfVariants+=e.length,e.length>n&&r.errors.push(`${t}: anyOf has ${e.length} variants (max: ${n})`);if(0===e.length)return void r.errors.push(`${t}: anyOf cannot be empty`);e.forEach((e,n)=>{e&&"object"==typeof e&&v(e,`${t}.anyOf[${n}]`,r)})}(e.anyOf,t,r),e.allOf&&Array.isArray(e.allOf)&&function(e,t,r){if(0===e.length)return void r.errors.push(`${t}: allOf cannot be empty`);e.forEach((e,n)=>{if(e&&"object"==typeof e){const i=e;i.$ref&&r.errors.push(`${t}.allOf[${n}]: allOf with $ref not supported`),v(i,`${t}.allOf[${n}]`,r)}})}(e.allOf,t,r),e.enum&&Array.isArray(e.enum)&&function(e,t,r){if(r.stats.enumCount++,0===e.length)return void r.errors.push(`${t}: enum cannot be empty`);e.length>o&&r.warnings.push(`${t}: enum has ${e.length} values (may be slow)`);for(let n=0;n<e.length;n++){const i=e[n],a=typeof i;if("string"!==a&&"number"!==a&&"boolean"!==a&&null!==i){r.errors.push(`${t}.enum[${n}]: Complex type not allowed in enum (got ${a}). Only string, number, boolean, null permitted.`);break}}const n=new Set;for(const i of e){const e=JSON.stringify(i);if(n.has(e)){r.warnings.push(`${t}: Duplicate value in enum: ${e}`);break}n.add(e)}}(e.enum,t,r),void 0!==e.const&&function(e,t,r){const n=typeof e;"string"!==n&&"number"!==n&&"boolean"!==n&&null!==e&&r.errors.push(`${t}: const must be string, number, boolean, or null (got ${n})`)}(e.const,t,r),r.currentDepth--}function y(e,t,r){if(!1!==e.additionalProperties&&r.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const n=e.properties,i=Object.keys(n).length;r.stats.propertyCount+=i,i>s&&r.warnings.push(`${t}: ${i} properties (may be slow, consider splitting)`);const a=e.required||[];for(const[e,i]of Object.entries(n))a.includes(e)||r.stats.optionalFieldCount++,i&&"object"==typeof i&&v(i,`${t}.${e}`,r)}}function b(e,t,r){if(void 0!==e.minItems){l.includes(e.minItems)||r.warnings.push(`${t}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach((e,n)=>{e&&"object"==typeof e&&v(e,`${t}.items[${n}]`,r)}):v(e.items,`${t}.items`,r)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach((e,n)=>{e&&"object"==typeof e&&v(e,`${t}.prefixItems[${n}]`,r)})}function _(e,t,r){if(e.format&&"string"==typeof e.format){const n=c;n.includes(e.format)||r.warnings.push(`${t}: format '${e.format}' may not be supported. Supported: ${n.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,t,r){for(const{pattern:n,name:i}of g)n.test(e)&&r.errors.push(`${t}: Regex pattern uses unsupported feature: ${i}`);try{new RegExp(e)}catch(e){const n=e instanceof Error?e.message:"Invalid regex";r.errors.push(`${t}: Invalid regex pattern: ${n}`)}const n=/\{(\d+),(\d+)\}/g;let i;for(;null!==(i=n.exec(e));){const e=parseInt(i[1],10),n=parseInt(i[2],10);n-e>100&&r.warnings.push(`${t}: Large quantifier range {${e},${n}} may cause issues`)}}(e.pattern,t,r)}function w(e){const t=structuredClone(e);return void 0===t.strict&&(t.strict=!0),x(t.value),t}function x(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const t of Object.values(e.properties))t&&"object"==typeof t&&x(t);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&x(e)}):x(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&x(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&x(e)});const t=[];for(const r of d)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);for(const r of u)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);for(const r of p)void 0!==e[r]&&(t.push(`${r}: ${e[r]}`),delete e[r]);if(void 0!==e.minItems&&null!==e.minItems){const r=e.minItems;0!==r&&1!==r&&(t.push(`minItems: ${r}`),e.minItems=r>0?1:0)}if(t.length>0){const r=`[Constraints: ${t.join(", ")}]`;e.description?e.description=`${e.description} ${r}`:e.description=r}}function $(e){return e?JSON.stringify(e,null,2):""}function k(e,t){let r;try{r=JSON.parse(e)}catch(t){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!n)return null;try{r=JSON.parse(n[1].trim())}catch(e){return null}}const n=[];if(t&&t.value.required&&Array.isArray(t.value.required)){const e=t.value.required.filter(e=>!(e in r));e.length>0&&n.push(`Missing required fields: ${e.join(", ")}`)}return{data:r,warnings:n}}var S=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function P(e){return S(this,void 0,void 0,function*(){var t;const{generateSimple:n}=yield Promise.resolve().then(r.bind(r,179));if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{const r=yield n(`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${e}`,"You are a JSON Schema expert. Output only valid JSON, nothing else.");if(!r)return{success:!1,error:"Generation failed - no response received"};let i=r.trim();i.startsWith("```")&&(i=i.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const a=h(i);if(!a.valid)return{success:!1,error:`Generated schema is invalid: ${a.error}`,schema:i};if(null===(t=a.warnings)||void 0===t?void 0:t.length){const e=w(a.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(a.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}})}},287(e,t,r){const n=r(526),i=r(251),a="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.hp=c,t.IS=50;const s=2147483647;function o(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,c.prototype),t}function c(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return l(e,t,r)}function l(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!c.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const r=0|g(e,t);let n=o(r);const i=n.write(e,t);i!==r&&(n=n.slice(0,i));return n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(Y(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return p(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Y(e,ArrayBuffer)||e&&Y(e.buffer,ArrayBuffer))return f(e,t,r);if("undefined"!=typeof SharedArrayBuffer&&(Y(e,SharedArrayBuffer)||e&&Y(e.buffer,SharedArrayBuffer)))return f(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return c.from(n,t,r);const i=function(e){if(c.isBuffer(e)){const t=0|m(e.length),r=o(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||K(e.length)?o(0):p(e);if("Buffer"===e.type&&Array.isArray(e.data))return p(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return c.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function d(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return d(e),o(e<0?0:0|m(e))}function p(e){const t=e.length<0?0:0|m(e.length),r=o(t);for(let n=0;n<t;n+=1)r[n]=255&e[n];return r}function f(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),Object.setPrototypeOf(n,c.prototype),n}function m(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function g(e,t){if(c.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Y(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return J(e).length;default:if(i)return n?-1:q(e).length;t=(""+t).toLowerCase(),i=!0}}function h(e,t,r){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return E(this,t,r);case"utf8":case"utf-8":return P(this,t,r);case"ascii":return A(this,t,r);case"latin1":case"binary":return C(this,t,r);case"base64":return S(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function v(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function y(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),K(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:b(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):b(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function b(e,t,r,n,i){let a,s=1,o=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,o/=2,c/=2,r/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){let n=-1;for(a=r;a<o;a++)if(l(e,a)===l(t,-1===n?0:a-n)){if(-1===n&&(n=a),a-n+1===c)return n*s}else-1!==n&&(a-=a-n),n=-1}else for(r+c>o&&(r=o-c),a=r;a>=0;a--){let r=!0;for(let n=0;n<c;n++)if(l(e,a+n)!==l(t,n)){r=!1;break}if(r)return a}return-1}function _(e,t,r,n){r=Number(r)||0;const i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;const a=t.length;let s;for(n>a/2&&(n=a/2),s=0;s<n;++s){const n=parseInt(t.substr(2*s,2),16);if(K(n))return s;e[r+s]=n}return s}function w(e,t,r,n){return V(q(t,e.length-r),e,r,n)}function x(e,t,r,n){return V(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function $(e,t,r,n){return V(J(t),e,r,n)}function k(e,t,r,n){return V(function(e,t){let r,n,i;const a=[];for(let s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,i=r%256,a.push(i),a.push(n);return a}(t,e.length-r),e,r,n)}function S(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function P(e,t,r){r=Math.min(e.length,r);const n=[];let i=t;for(;i<r;){const t=e[i];let a=null,s=t>239?4:t>223?3:t>191?2:1;if(i+s<=r){let r,n,o,c;switch(s){case 1:t<128&&(a=t);break;case 2:r=e[i+1],128==(192&r)&&(c=(31&t)<<6|63&r,c>127&&(a=c));break;case 3:r=e[i+1],n=e[i+2],128==(192&r)&&128==(192&n)&&(c=(15&t)<<12|(63&r)<<6|63&n,c>2047&&(c<55296||c>57343)&&(a=c));break;case 4:r=e[i+1],n=e[i+2],o=e[i+3],128==(192&r)&&128==(192&n)&&128==(192&o)&&(c=(15&t)<<18|(63&r)<<12|(63&n)<<6|63&o,c>65535&&c<1114112&&(a=c))}}null===a?(a=65533,s=1):a>65535&&(a-=65536,n.push(a>>>10&1023|55296),a=56320|1023&a),n.push(a),i+=s}return function(e){const t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=R));return r}(n)}c.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),c.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}}),c.poolSize=8192,c.from=function(e,t,r){return l(e,t,r)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array),c.alloc=function(e,t,r){return function(e,t,r){return d(e),e<=0?o(e):void 0!==t?"string"==typeof r?o(e).fill(t,r):o(e).fill(t):o(e)}(e,t,r)},c.allocUnsafe=function(e){return u(e)},c.allocUnsafeSlow=function(e){return u(e)},c.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==c.prototype},c.compare=function(e,t){if(Y(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),Y(t,Uint8Array)&&(t=c.from(t,t.offset,t.byteLength)),!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,a=Math.min(r,n);i<a;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);let r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;const n=c.allocUnsafe(t);let i=0;for(r=0;r<e.length;++r){let t=e[r];if(Y(t,Uint8Array))i+t.length>n.length?(c.isBuffer(t)||(t=c.from(t)),t.copy(n,i)):Uint8Array.prototype.set.call(n,t,i);else{if(!c.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,i)}i+=t.length}return n},c.byteLength=g,c.prototype._isBuffer=!0,c.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)v(this,t,t+1);return this},c.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},c.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},c.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?P(this,0,e):h.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){let e="";const r=t.IS;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},a&&(c.prototype[a]=c.prototype.inspect),c.prototype.compare=function(e,t,r,n,i){if(Y(e,Uint8Array)&&(e=c.from(e,e.offset,e.byteLength)),!c.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;let a=(i>>>=0)-(n>>>=0),s=(r>>>=0)-(t>>>=0);const o=Math.min(a,s),l=this.slice(n,i),d=e.slice(t,r);for(let e=0;e<o;++e)if(l[e]!==d[e]){a=l[e],s=d[e];break}return a<s?-1:s<a?1:0},c.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return y(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return y(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let a=!1;for(;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return w(this,e,t,r);case"ascii":case"latin1":case"binary":return x(this,e,t,r);case"base64":return $(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,r);default:if(a)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),a=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const R=4096;function A(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function C(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function E(e,t,r){const n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=t;n<r;++n)i+=Q[e[n]];return i}function I(e,t,r){const n=e.slice(t,r);let i="";for(let e=0;e<n.length-1;e+=2)i+=String.fromCharCode(n[e]+256*n[e+1]);return i}function O(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function z(e,t,r,n,i,a){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<a)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function T(e,t,r,n,i){F(t,n,i,e,r,7);let a=Number(t&BigInt(4294967295));e[r++]=a,a>>=8,e[r++]=a,a>>=8,e[r++]=a,a>>=8,e[r++]=a;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s,r}function W(e,t,r,n,i){F(t,n,i,e,r,7);let a=Number(t&BigInt(4294967295));e[r+7]=a,a>>=8,e[r+6]=a,a>>=8,e[r+5]=a,a>>=8,e[r+4]=a;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=s,s>>=8,e[r+2]=s,s>>=8,e[r+1]=s,s>>=8,e[r]=s,r+8}function j(e,t,r,n,i,a){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function L(e,t,r,n,a){return t=+t,r>>>=0,a||j(e,0,r,4),i.write(e,t,r,n,23,4),r+4}function N(e,t,r,n,a){return t=+t,r>>>=0,a||j(e,0,r,8),i.write(e,t,r,n,52,8),r+8}c.prototype.slice=function(e,t){const r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,c.prototype),n},c.prototype.readUintLE=c.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);let n=this[e],i=1,a=0;for(;++a<t&&(i*=256);)n+=this[e+a]*i;return n},c.prototype.readUintBE=c.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n},c.prototype.readUint8=c.prototype.readUInt8=function(e,t){return e>>>=0,t||O(e,1,this.length),this[e]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(e,t){return e>>>=0,t||O(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(e,t){return e>>>=0,t||O(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(e,t){return e>>>=0,t||O(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(e,t){return e>>>=0,t||O(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readBigUInt64LE=X(function(e){U(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))}),c.prototype.readBigUInt64BE=X(function(e){U(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)}),c.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);let n=this[e],i=1,a=0;for(;++a<t&&(i*=256);)n+=this[e+a]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);let n=t,i=1,a=this[e+--n];for(;n>0&&(i*=256);)a+=this[e+--n]*i;return i*=128,a>=i&&(a-=Math.pow(2,8*t)),a},c.prototype.readInt8=function(e,t){return e>>>=0,t||O(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){e>>>=0,t||O(e,2,this.length);const r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){e>>>=0,t||O(e,2,this.length);const r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return e>>>=0,t||O(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return e>>>=0,t||O(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readBigInt64LE=X(function(e){U(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)}),c.prototype.readBigInt64BE=X(function(e){U(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||H(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+r)}),c.prototype.readFloatLE=function(e,t){return e>>>=0,t||O(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return e>>>=0,t||O(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return e>>>=0,t||O(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return e>>>=0,t||O(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUintLE=c.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){z(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=1,a=0;for(this[t]=255&e;++a<r&&(i*=256);)this[t+a]=e/i&255;return t+r},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){z(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=r-1,a=1;for(this[t+i]=255&e;--i>=0&&(a*=256);)this[t+i]=e/a&255;return t+r},c.prototype.writeUint8=c.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,1,255,0),this[t]=255&e,t+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigUInt64LE=X(function(e,t=0){return T(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=X(function(e,t=0){return W(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);z(this,e,t,r,n-1,-n)}let i=0,a=1,s=0;for(this[t]=255&e;++i<r&&(a*=256);)e<0&&0===s&&0!==this[t+i-1]&&(s=1),this[t+i]=(e/a|0)-s&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);z(this,e,t,r,n-1,-n)}let i=r-1,a=1,s=0;for(this[t+i]=255&e;--i>=0&&(a*=256);)e<0&&0===s&&0!==this[t+i+1]&&(s=1),this[t+i]=(e/a|0)-s&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||z(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},c.prototype.writeBigInt64LE=X(function(e,t=0){return T(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=X(function(e,t=0){return W(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeFloatLE=function(e,t,r){return L(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return L(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return N(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return N(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(!c.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);const i=n-r;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;let i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{const a=c.isBuffer(e)?e:c.from(e,n),s=a.length;if(0===s)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=a[i%s]}return this};const D={};function B(e,t,r){D[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function M(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function F(e,t,r,n,i,a){if(e>r||e<t){const n="bigint"==typeof t?"n":"";let i;throw i=a>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(a+1)}${n}`:`>= -(2${n} ** ${8*(a+1)-1}${n}) and < 2 ** ${8*(a+1)-1}${n}`:`>= ${t}${n} and <= ${r}${n}`,new D.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,r){U(t,"offset"),void 0!==e[t]&&void 0!==e[t+r]||H(t,e.length-(r+1))}(n,i,a)}function U(e,t){if("number"!=typeof e)throw new D.ERR_INVALID_ARG_TYPE(t,"number",e)}function H(e,t,r){if(Math.floor(e)!==e)throw U(e,r),new D.ERR_OUT_OF_RANGE(r||"offset","an integer",e);if(t<0)throw new D.ERR_BUFFER_OUT_OF_BOUNDS;throw new D.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}B("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),B("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError),B("ERR_OUT_OF_RANGE",function(e,t,r){let n=`The value of "${e}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=M(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=M(i)),i+="n"),n+=` It must be ${t}. Received ${i}`,n},RangeError);const G=/[^+/0-9A-Za-z-_]/g;function q(e,t){let r;t=t||1/0;const n=e.length;let i=null;const a=[];for(let s=0;s<n;++s){if(r=e.charCodeAt(s),r>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&a.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&a.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&a.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;a.push(r)}else if(r<2048){if((t-=2)<0)break;a.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;a.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return a}function J(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function V(e,t,r,n){let i;for(i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function Y(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function K(e){return e!=e}const Q=function(){const e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)t[n+i]=e[r]+e[i]}return t}();function X(e){return"undefined"==typeof BigInt?Z:e}function Z(){throw new Error("BigInt not supported")}},314(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var r="",n=void 0!==t[5];return t[4]&&(r+="@supports (".concat(t[4],") {")),t[2]&&(r+="@media ".concat(t[2]," {")),n&&(r+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),r+=e(t),n&&(r+="}"),t[2]&&(r+="}"),t[4]&&(r+="}"),r}).join("")},t.i=function(e,r,n,i,a){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(n)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(s[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);n&&s[d[0]]||(void 0!==a&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=a),r&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=r):d[2]=r),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},417(e){e.exports=function(e,t){return t||(t={}),e?(e=String(e.__esModule?e.default:e),/^['"].*['"]$/.test(e)&&(e=e.slice(1,-1)),t.hash&&(e+=t.hash),/["'() \t\n]|(%20)/.test(e)||t.needQuotes?'"'.concat(e.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):e):e}},524(e){e.exports=function(e,t){if(e=String(e),t=String(t),!/^[\x00-\xFF]+$/.test(e)||!/^[\x00-\xFF]+$/.test(t))throw new Error("Only Latin-1 characters are permitted in PNG tEXt chunks. You might want to consider base64 encoding and/or zEXt compression");if(e.length>=80)throw new Error('Keyword "'+e+'" is longer than the 79-character limit imposed by the PNG specification');for(var r,n=e.length+t.length+1,i=new Uint8Array(n),a=0,s=0;s<e.length;s++){if(!(r=e.charCodeAt(s)))throw new Error("0x00 character is not permitted in tEXt keywords");i[a++]=r}i[a++]=0;for(var o=0;o<t.length;o++){if(!(r=t.charCodeAt(o)))throw new Error("0x00 character is not permitted in tEXt content");i[a++]=r}return{name:"tEXt",data:i}}},526(e,t){t.byteLength=function(e){var t=o(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,a=o(e),s=a[0],c=a[1],l=new i(function(e,t,r){return 3*(t+r)/4-r}(0,s,c)),d=0,u=c>0?s-4:s;for(r=0;r<u;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],l[d++]=t>>16&255,l[d++]=t>>8&255,l[d++]=255&t;2===c&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,l[d++]=255&t);1===c&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,l[d++]=t>>8&255,l[d++]=255&t);return l},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,a=[],s=16383,o=0,c=n-i;o<c;o+=s)a.push(l(e,o,o+s>c?c:o+s));1===i?(t=e[n-1],a.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],a.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return a.join("")};for(var r=[],n=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)r[s]=a[s],n[a.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function c(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function l(e,t,r){for(var n,i=[],a=t;a<r;a+=3)n=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),i.push(c(n));return i.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},540(e){e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},566(e,t){var r;r=function(e){e.version="0.3.0";var t=function(){for(var e=0,t=new Array(256),r=0;256!=r;++r)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=r)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1,t[r]=e;return"undefined"!=typeof Int32Array?new Int32Array(t):t}(),r="undefined"!=typeof Buffer;function n(e){for(var r=-1,n=0,i=e.length-7;n<i;)r=(r=(r=(r=(r=(r=(r=(r=r>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])])>>>8^t[255&(r^e[n++])];for(;n<i+7;)r=r>>>8^t[255&(r^e[n++])];return-1^r}e.table=t,e.bstr=function(e){if(e.length>32768&&r)return n(new Buffer(e));for(var i=-1,a=e.length-1,s=0;s<a;)i=t[255&(i^e.charCodeAt(s++))]^i>>>8,i=t[255&(i^e.charCodeAt(s++))]^i>>>8;return s===a&&(i=i>>>8^t[255&(i^e.charCodeAt(s))]),-1^i},e.buf=function(e){if(e.length>1e4)return n(e);for(var r=-1,i=0,a=e.length-3;i<a;)r=(r=(r=(r=r>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])])>>>8^t[255&(r^e[i++])];for(;i<a+3;)r=r>>>8^t[255&(r^e[i++])];return-1^r},e.str=function(e){for(var r,n,i=-1,a=0,s=e.length;a<s;)(r=e.charCodeAt(a++))<128?i=i>>>8^t[255&(i^r)]:r<2048?i=(i=i>>>8^t[255&(i^(192|r>>6&31))])>>>8^t[255&(i^(128|63&r))]:r>=55296&&r<57344?(r=64+(1023&r),n=1023&e.charCodeAt(a++),i=(i=(i=(i=i>>>8^t[255&(i^(240|r>>8&7))])>>>8^t[255&(i^(128|r>>2&63))])>>>8^t[255&(i^(128|n>>6&15|3&r))])>>>8^t[255&(i^(128|63&n))]):i=(i=(i=i>>>8^t[255&(i^(224|r>>12&15))])>>>8^t[255&(i^(128|r>>6&63))])>>>8^t[255&(i^(128|63&r))];return-1^i}},"undefined"==typeof DO_NOT_EXPORT_CRC?r(t):r({})},601(e){e.exports=function(e){return e[1]}},628(e){e.exports=function(e){e.data&&e.name&&(e=e.data);for(var t=!0,r="",n="",i=0;i<e.length;i++){var a=e[i];if(t)a?n+=String.fromCharCode(a):t=!1;else{if(!a)throw new Error("Invalid NULL character found. 0x00 character is not permitted in tEXt content");r+=String.fromCharCode(a)}}return{keyword:n,text:r}}},659(e){var t={};e.exports=function(e,r){var n=function(e){if(void 0===t[e]){var r=document.querySelector(e);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}t[e]=r}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(r)}},691(e,t,r){r.d(t,{tB:()=>s,lp:()=>a,WC:()=>o,L$:()=>c,a$:()=>l,_j:()=>i,Gv:()=>d,$q:()=>F,QO:()=>J,wI:()=>D,mW:()=>N,SK:()=>b,Bx:()=>H,bA:()=>U,mt:()=>u,hu:()=>h,sR:()=>y,PL:()=>_,Tx:()=>f,UN:()=>p,DV:()=>B,aQ:()=>G,RC:()=>v,Fc:()=>M,iO:()=>q});var n=r(752);const i={promptPresetId:null,customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},a="You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",s="You are refining a character card based on analysis feedback. Address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",o=[{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided.\n\nFor each field:\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Suggestions** - Concrete changes\n\nThen provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback only."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address weaknesses while preserving strengths.\n\nGuidelines:\n- Maintain core personality and unique traits\n- Improve weak areas from feedback\n- Keep similar length unless noted\n- Preserve distinctive voice/style\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\n**ACCEPT** (ready), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"}],c=[{id:"builtin_schema_score",name:"Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Analyze Schema",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issues:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulScore","soulAssessment","verdict","issues","recommendations"]}}}],l={version:n.$G,baseSystemPrompt:a,userSystemPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},baseRefinementPrompt:s,userRefinementPrompt:"",stageDefaults:{score:Object.assign(Object.assign({},i),{promptPresetId:"builtin_score_default"}),rewrite:Object.assign(Object.assign({},i),{promptPresetId:"builtin_rewrite_default"}),analyze:Object.assign(Object.assign({},i),{promptPresetId:"builtin_analyze_default"})},promptPresets:[...o],schemaPresets:[...c],generationMode:"current",profileId:null,maxTokensOverride:null,disableThinking:!1,useAssistantPrefill:!1,assistantPrefill:"",replaceUserMacro:!1,debugMode:!1};function d(e,t,r){return{id:e,characterId:t,characterName:r,createdAt:Date.now(),updatedAt:Date.now(),stageFields:{base:{},linked:!0,overrides:{}},originalData:{},configs:{score:Object.assign({},i),rewrite:Object.assign({},i),analyze:Object.assign({},i)},history:[],iterationCount:0,status:"active",version:n.F}}function u(){var e;const t=SillyTavern.getContext(),{lodash:r}=SillyTavern.libs,i=t.extensionSettings;if(!i[n.pW])return i[n.pW]=r.cloneDeep(l),p(),i[n.pW];const a=i[n.pW],s=null!==(e=a.version)&&void 0!==e?e:0;if(s<n.$G){!function(e,t){for(let r=t+1;r<=n.$G;r++){const t=m[r];t&&t(e)}}(a,s);const e=function(e){const{lodash:t}=SillyTavern.libs,r=e.promptPresets?[...e.promptPresets]:[],n=e.schemaPresets?[...e.schemaPresets]:[],i=t.merge(structuredClone(l),e);return i.promptPresets=r.length?r:[...l.promptPresets],i.schemaPresets=n.length?n:[...l.schemaPresets],i}(a);return e.version=n.$G,g(e),i[n.pW]=e,p(),e}const o=a;o.promptPresets||(o.promptPresets=[]),o.schemaPresets||(o.schemaPresets=[]);return g(o)&&p(),o}function p(){SillyTavern.getContext().saveSettingsDebounced()}function f(){const{lodash:e}=SillyTavern.libs,t=SillyTavern.getContext().extensionSettings;return t[n.pW]=e.cloneDeep(l),p(),t[n.pW]}const m={2:e=>{var t,r,n;e.stageDefaults||(e.stageDefaults={});const i=e.stageDefaults;(null===(t=i.score)||void 0===t?void 0:t.promptPresetId)||(i.score=Object.assign(Object.assign({},i.score||{}),{promptPresetId:"builtin_score_default"})),(null===(r=i.rewrite)||void 0===r?void 0:r.promptPresetId)||(i.rewrite=Object.assign(Object.assign({},i.rewrite||{}),{promptPresetId:"builtin_rewrite_default"})),(null===(n=i.analyze)||void 0===n?void 0:n.promptPresetId)||(i.analyze=Object.assign(Object.assign({},i.analyze||{}),{promptPresetId:"builtin_analyze_default"})),i.score&&(i.score.useStructuredOutput=!1),i.analyze&&(i.analyze.useStructuredOutput=!1)}};function g(e){const{lodash:t}=SillyTavern.libs;let r=!1;for(const n of o){const i=e.promptPresets.find(e=>e.id===n.id);i?i.version<n.version&&(Object.assign(i,t.cloneDeep(n)),r=!0):(e.promptPresets.push(t.cloneDeep(n)),r=!0)}for(const n of c){const i=e.schemaPresets.find(e=>e.id===n.id);i?i.version<n.version&&(Object.assign(i,t.cloneDeep(n)),r=!0):(e.schemaPresets.push(t.cloneDeep(n)),r=!0)}return r}function h(e){const{lodash:t}=SillyTavern.libs,r=u();return t.cloneDeep(r.stageDefaults[e])}function v(e,t){const{lodash:r}=SillyTavern.libs;u().stageDefaults[e]=r.cloneDeep(t),p()}function y(e){const t=u();return[t.baseSystemPrompt,t.userSystemPrompt,t.stageSystemPrompts[e]].filter(e=>e.trim()).join("\n\n")}function b(){const e=u();return[e.baseRefinementPrompt,e.userRefinementPrompt].filter(e=>e.trim()).join("\n\n")}const _=new class{constructor(){this.listeners=new Set,this.getPromptPresets=e=>{const t=u();return this.applyFilter(t.promptPresets,e)},this.getSchemaPresets=e=>{const t=u();return this.applyFilter(t.schemaPresets,e)},this.getPromptPreset=e=>{var t;return null!==(t=u().promptPresets.find(t=>t.id===e))&&void 0!==t?t:null},this.getSchemaPreset=e=>{var t;return null!==(t=u().schemaPresets.find(t=>t.id===e))&&void 0!==t?t:null},this.getPresetsForStage=(e,t)=>"prompt"===e?this.getPromptPresets({stage:t}):this.getSchemaPresets({stage:t}),this.exists=(e,t)=>"prompt"===e?null!==this.getPromptPreset(t):null!==this.getSchemaPreset(t),this.isBuiltin=(e,t)=>{var r;const n="prompt"===e?this.getPromptPreset(t):this.getSchemaPreset(t);return null!==(r=null==n?void 0:n.isBuiltin)&&void 0!==r&&r},this.registerPromptPreset=e=>{const t=u(),r=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.promptPresets.push(r),p(),this.emit({type:"add",presetType:"prompt",preset:r}),r},this.registerSchemaPreset=e=>{const t=u(),r=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.schemaPresets.push(r),p(),this.emit({type:"add",presetType:"schema",preset:r}),r},this.updatePromptPreset=(e,t)=>{const r=u().promptPresets.find(t=>t.id===e);if(!r||r.isBuiltin)return!1;const n=Object.assign({},r);return Object.assign(r,t,{updatedAt:Date.now()}),p(),this.emit({type:"update",presetType:"prompt",preset:r,previousValue:n}),!0},this.updateSchemaPreset=(e,t)=>{const r=u().schemaPresets.find(t=>t.id===e);if(!r||r.isBuiltin)return!1;const n=Object.assign({},r);return Object.assign(r,t,{updatedAt:Date.now()}),p(),this.emit({type:"update",presetType:"schema",preset:r,previousValue:n}),!0},this.deletePromptPreset=e=>{const t=u(),r=t.promptPresets.findIndex(t=>t.id===e&&!t.isBuiltin);if(-1===r)return!1;const[n]=t.promptPresets.splice(r,1);return p(),this.emit({type:"delete",presetType:"prompt",preset:n}),!0},this.deleteSchemaPreset=e=>{const t=u(),r=t.schemaPresets.findIndex(t=>t.id===e&&!t.isBuiltin);if(-1===r)return!1;const[n]=t.schemaPresets.splice(r,1);return p(),this.emit({type:"delete",presetType:"schema",preset:n}),!0},this.duplicatePromptPreset=(e,t)=>{const r=this.getPromptPreset(e);if(!r)return null;const n=t||`${r.name} (Copy)`;return this.registerPromptPreset({name:n,stages:[...r.stages],prompt:r.prompt})},this.duplicateSchemaPreset=(e,t)=>{const r=this.getSchemaPreset(e);if(!r)return null;const{lodash:n}=SillyTavern.libs,i=t||`${r.name} (Copy)`;return this.registerSchemaPreset({name:i,stages:[...r.stages],schema:n.cloneDeep(r.schema)})},this.subscribe=e=>(this.listeners.add(e),()=>this.listeners.delete(e)),this.isNameUnique=(e,t,r)=>!("prompt"===e?this.getPromptPresets():this.getSchemaPresets()).some(e=>e.name.toLowerCase()===t.toLowerCase()&&e.id!==r),this.generateUniquePresetName=(e,t)=>{const r="prompt"===e?this.getPromptPresets().map(e=>e.name):this.getSchemaPresets().map(e=>e.name);return(0,n.Sn)(t,r)},this.getDisplayName=(e,t)=>{if(!t)return"Custom";const r="prompt"===e?this.getPromptPreset(t):this.getSchemaPreset(t);return r?r.isBuiltin?`${r.name} (builtin)`:r.name:"Unknown"}}applyFilter(e,t){return t?e.filter(e=>{if(t.stage){if(!(0===e.stages.length||e.stages.includes(t.stage)))return!1}return!(t.builtinOnly&&!e.isBuiltin)&&(!t.userOnly||!e.isBuiltin)}):e}emit(e){for(const t of this.listeners)try{t(e)}catch(e){n.Rm.error("PresetRegistry listener error:",e)}}},{getPromptPresets:w,getSchemaPresets:x,getPromptPreset:$,getSchemaPreset:k,getPresetsForStage:S,registerPromptPreset:P,registerSchemaPreset:R,updatePromptPreset:A,updateSchemaPreset:C,deletePromptPreset:E,deleteSchemaPreset:I,duplicatePromptPreset:O,duplicateSchemaPreset:z,isNameUnique:T,generateUniquePresetName:W,getDisplayName:j,subscribe:L}=_;function N(e){return w({stage:e})}function D(e){return $(e)}function B(e){return P(e)}function M(e,t){return A(e,t)}function F(e){return E(e)}function U(e){return x({stage:e})}function H(e){return k(e)}function G(e){return R(e)}function q(e,t){return C(e,t)}function J(e){return I(e)}},709(e,t,r){r.d(t,{$D:()=>g,$G:()=>o,BA:()=>u,F:()=>c,IF:()=>f,Nf:()=>v,Oi:()=>s,U8:()=>h,an:()=>d,d5:()=>m,hi:()=>i,iu:()=>p,pW:()=>n,v7:()=>l,xv:()=>a});const n="SillyTavern-CardRefinery",i="CardRefinery",a="1.0.0",s=!0,o=2,c=2,l=1,d=["score","rewrite","analyze"],u={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},p={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},f=[{key:"description",label:"Description",path:"description"},{key:"personality",label:"Personality",path:"personality"},{key:"first_mes",label:"First Message",path:"first_mes"},{key:"scenario",label:"Scenario",path:"scenario"},{key:"mes_example",label:"Example Messages",path:"mes_example"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}],m={SESSIONS:`${n}_sessions`,SESSION_INDEX:`${n}_session_index`,STORAGE_META:`${n}_storage_meta`},g="cr",h={SEARCH:150,SAVE:1e3,VALIDATE:300},v=50},737(e,t,r){r.d(t,{BASE_REFINEMENT_PROMPT:()=>n.tB,BASE_SYSTEM_PROMPT:()=>n.lp,BUILTIN_PROMPT_PRESETS:()=>n.WC,BUILTIN_SCHEMA_PRESETS:()=>n.L$,DEFAULT_SETTINGS:()=>n.a$,DEFAULT_STAGE_CONFIG:()=>n._j,clearCache:()=>o,createDefaultSession:()=>n.Gv,createSession:()=>w,deleteAllSessionsForCharacter:()=>k,deletePromptPreset:()=>n.$q,deleteSchemaPreset:()=>n.QO,deleteSession:()=>$,getPromptPreset:()=>n.wI,getPromptPresetsForStage:()=>n.mW,getRefinementPrompt:()=>n.SK,getSchemaPreset:()=>n.Bx,getSchemaPresetsForStage:()=>n.bA,getSession:()=>_,getSessionsForCharacter:()=>b,getSettings:()=>n.mt,getStageDefaults:()=>n.hu,getSystemPrompt:()=>n.sR,presetRegistry:()=>n.PL,purgeAllSessions:()=>S,resetSettings:()=>n.Tx,save:()=>n.UN,savePromptPreset:()=>n.DV,saveSchemaPreset:()=>n.aQ,setStageDefaults:()=>n.RC,updatePromptPreset:()=>n.Fc,updateSchemaPreset:()=>n.iO,updateSession:()=>x}),r.r(t);var n=r(691);let i=null,a=null,s=null;function o(){i=null,a=null,s=null}function c(){return i}function l(){return a}function d(e){a=e}function u(e){s=e}var p=r(752),f=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function m(){return f(this,void 0,void 0,function*(){if(s)return s;const e=yield(0,p.Ar)(p.d5.STORAGE_META);if(!e){const e={version:p.F,lastMigration:Date.now()};return u(e),yield(0,p.RG)(p.d5.STORAGE_META,e),e}return e.version!==p.F&&(yield function(e){return f(this,void 0,void 0,function*(){var t;const r=null!==(t=e.version)&&void 0!==t?t:0;if(r<2){const e=yield(0,p.Ar)(p.d5.SESSIONS);if(e){let t=!1;for(const r of Object.values(e))if(!r.stageFields&&r.selectedFields){const e=r.selectedFields;r.stageFields={base:e,linked:!0,overrides:{}},delete r.selectedFields,t=!0}t&&(yield(0,p.RG)(p.d5.SESSIONS,e))}}e.version=p.F,e.lastMigration=Date.now(),yield(0,p.RG)(p.d5.STORAGE_META,e)})}(e)),u(e),e})}function g(){return f(this,void 0,void 0,function*(){const e=c();if(e)return e;yield m();const t=yield(0,p.Ar)(p.d5.SESSIONS),r=new Map(Object.entries(null!=t?t:{}));return function(e){i=e}(r),r})}function h(){return f(this,void 0,void 0,function*(){var e;const t=l();if(t)return t;yield m();const r=null!==(e=yield(0,p.Ar)(p.d5.SESSION_INDEX))&&void 0!==e?e:{};return d(r),r})}function v(){return f(this,void 0,void 0,function*(){const e=c();if(!e)return p.Rm.warn("saveSessions: No cache to save"),!1;const t=yield(0,p.RG)(p.d5.SESSIONS,Object.fromEntries(e));return t||p.Rm.error("Failed to save sessions to storage"),t})}function y(){return f(this,void 0,void 0,function*(){const e=l();if(!e)return p.Rm.warn("saveIndex: No cache to save"),!1;const t=yield(0,p.RG)(p.d5.SESSION_INDEX,e);return t||p.Rm.error("Failed to save index to storage"),t})}function b(e){return f(this,void 0,void 0,function*(){var t;const r=yield g();return(null!==(t=(yield h())[e])&&void 0!==t?t:[]).map(e=>r.get(e)).filter(e=>void 0!==e)})}function _(e){return f(this,void 0,void 0,function*(){var t;return null!==(t=(yield g()).get(e))&&void 0!==t?t:null})}function w(e){return f(this,void 0,void 0,function*(){const{characterId:t,characterName:r,stageFields:i,originalData:a,configs:s}=e,o=yield g(),c=yield h(),l=SillyTavern.libs.lodash,d=(0,n.Gv)(crypto.randomUUID(),t,r);if(d.stageFields=l.cloneDeep(i),d.originalData=l.cloneDeep(a),d.configs=l.cloneDeep(s),o.set(d.id,d),c[t]||(c[t]=[]),c[t].unshift(d.id),c[t].length>p.Nf){const e=c[t].splice(p.Nf);for(const t of e)o.delete(t)}return yield v(),yield y(),d})}function x(e){return f(this,void 0,void 0,function*(){const t=yield g();if(!t.has(e.id))throw new Error(`Cannot update non-existent session: ${e.id}`);e.updatedAt=Date.now(),t.set(e.id,e),yield v()})}function $(e){return f(this,void 0,void 0,function*(){const t=yield g(),r=yield h(),n=t.get(e);if(!n)return p.Rm.warn("deleteSession: Session not found:",e),!1;t.delete(e);const i=r[n.characterId];if(i){const t=i.indexOf(e);-1!==t&&i.splice(t,1),0===i.length&&delete r[n.characterId]}const a=yield v(),s=yield y();return a&&s?(p.Rm.debug("Session deleted:",e),!0):(p.Rm.error("deleteSession: Failed to persist deletion"),!1)})}function k(e){return f(this,void 0,void 0,function*(){var t;const r=yield g(),n=yield h(),i=null!==(t=n[e])&&void 0!==t?t:[],a=i.length;if(0===a)return{success:!0,count:0};for(const e of i)r.delete(e);delete n[e];const s=yield v(),o=yield y();return s&&o?(p.Rm.debug(`Deleted ${a} sessions for character:`,e),{success:!0,count:a}):(p.Rm.error("deleteAllSessionsForCharacter: Failed to persist"),{success:!1,count:0})})}function S(){return f(this,void 0,void 0,function*(){const e=yield g(),t=e.size;if(0===t)return{success:!0,count:0};e.clear(),d({});const r=yield v(),n=yield y();return r&&n?(p.Rm.info(`Deleted ALL ${t} sessions`),{success:!0,count:t}):(p.Rm.error("deleteAllSessions: Failed to persist"),{success:!1,count:0})})}},752(e,t,r){r.d(t,{IF:()=>n.IF,U8:()=>n.U8,Oi:()=>n.Oi,hi:()=>n.hi,Nf:()=>n.Nf,pW:()=>n.pW,v7:()=>n.v7,$G:()=>n.$G,an:()=>n.an,iu:()=>n.iu,BA:()=>n.BA,d5:()=>n.d5,F:()=>n.F,xv:()=>n.xv,ch:()=>m,Sn:()=>A,Lq:()=>b,We:()=>v,oN:()=>g,NR:()=>S,gg:()=>P,mi:()=>h,cW:()=>_,Ar:()=>f,Rm:()=>s,lY:()=>d,pM:()=>o,RG:()=>p,oR:()=>u});var n=r(709);const i=[];let a=!1;const s={debug(e,t){c("debug",e,t),a&&(void 0!==t?console.debug(`[${n.pW}]`,e,t):console.debug(`[${n.pW}]`,e))},info(e,t){c("info",e,t),void 0!==t?console.log(`[${n.pW}]`,e,t):console.log(`[${n.pW}]`,e)},warn(e,t){c("warn",e,t),void 0!==t?console.warn(`[${n.pW}]`,e,t):console.warn(`[${n.pW}]`,e)},error(e,t){c("error",e,t),void 0!==t?console.error(`[${n.pW}]`,e,t):console.error(`[${n.pW}]`,e)}};function o(e){a=e,s.info("Debug mode "+(e?"enabled":"disabled"))}function c(e,t,r){i.unshift({timestamp:new Date,level:e,message:t,data:r}),i.length>100&&i.pop()}var l=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const d={confirm(e,t){return l(this,void 0,void 0,function*(){const r=yield SillyTavern.getContext().Popup.show.confirm(e,t);return!0===r||1===r})},input(e,t,r){return l(this,void 0,void 0,function*(){return SillyTavern.getContext().Popup.show.input(e,t,r)})},alert(e,t){return l(this,void 0,void 0,function*(){yield SillyTavern.getContext().Popup.show.text(e,t)})}},u={success(e,t){toastr.success(e,t)},error(e,t){toastr.error(e,t)},warning(e,t){toastr.warning(e,t)},info(e,t){toastr.info(e,t)}};function p(e,t){return l(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.setItem(e,t),!0}catch(t){return s.error(`storeLargeData: Failed to store ${e}:`,t),!1}})}function f(e){return l(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.getItem(e)}catch(t){return s.error(`loadLargeData: Failed to load ${e}:`,t),null}})}function m(e,t,r,n){return l(this,void 0,void 0,function*(){const i=SillyTavern.getContext();try{return(yield fetch("/api/characters/edit-attribute",{method:"POST",headers:i.getRequestHeaders(),body:JSON.stringify({avatar_url:e,ch_name:t,field:r,value:n})})).ok}catch(e){return s.error(`Failed to edit attribute ${r}:`,e),!1}})}function g(e){return l(this,void 0,void 0,function*(){const t=SillyTavern.getContext();try{const r=yield fetch("/api/characters/export",{method:"POST",headers:t.getRequestHeaders(),body:JSON.stringify({avatar_url:e,format:"json"})});return r.ok?yield r.json():null}catch(e){return s.error("Failed to get character JSON:",e),null}})}function h(){const e=SillyTavern.getContext().ConnectionManagerRequestService;return!(!e||"function"!=typeof e.sendRequest)}function v(){const e=SillyTavern.getContext().ConnectionManagerRequestService;if(!e||"function"!=typeof e.getSupportedProfiles)return[];try{return(e.getSupportedProfiles()||[]).map(t=>{const r=function(e,t){try{const r=(t.getSupportedProfiles()||[]).find(t=>t.id===e);return r?{valid:!0,error:null}:{valid:!1,error:"Profile not found"}}catch(e){return{valid:!1,error:"Failed to validate profile"}}}(t.id,e);return{id:t.id,name:t.name,model:t.model,api:t.api,mode:t.mode,presetName:t.presetName,isSupported:r.valid,validationError:r.error}})}catch(e){return s.error("Failed to get profiles",e),[]}}function y(e){return v().find(t=>t.id===e)||null}function b(e){const t=SillyTavern.getContext();return e?function(e){const t=y(e);if(!t)return{mode:"profile",displayName:"Unknown Profile",source:"unknown",model:"unknown",modelDisplay:"Unknown",apiType:"cc",contextSize:8192,maxOutput:4096,isReady:!1,statusText:"Profile Not Found",error:`Profile ${e} not found`};return{mode:"profile",displayName:t.name,source:t.api,model:t.model,modelDisplay:w(t.model),apiType:t.mode,contextSize:8192,maxOutput:4096,isReady:t.isSupported,statusText:t.isSupported?`${t.name} Ready`:"Not Supported",error:t.validationError}}(e):function(e){var t,r,n,i,a;const s=null!==(t=e.mainApi)&&void 0!==t?t:"unknown",o=e.chatCompletionSettings,c=e.textCompletionSettings,l="textgenerationwebui"!==s&&"kobold"!==s,d=l?"cc":"tc";let u="unknown";l&&"function"==typeof e.getChatCompletionModel?u=e.getChatCompletionModel()||"unknown":l||(u=e.onlineStatus||"unknown");let p=s;l&&(null==o?void 0:o.chat_completion_source)&&(p=o.chat_completion_source);const f=null!==(n=null!==(r=null==o?void 0:o.openai_max_context)&&void 0!==r?r:e.maxContext)&&void 0!==n?n:8192,m=l?null!==(i=null==o?void 0:o.openai_max_tokens)&&void 0!==i?i:4096:null!==(a=null==c?void 0:c.max_length)&&void 0!==a?a:2048,{isReady:g,error:h}=function(e){var t;const r=e.chatCompletionSettings;if(null==r?void 0:r.bypass_status_check)return{isReady:!0,error:null};const n=(null!==(t=e.onlineStatus)&&void 0!==t?t:"").toLowerCase();if(!n)return{isReady:!1,error:"No API connection"};if(["error","fail","invalid","unauthorized","missing"].some(e=>n.includes(e)))return{isReady:!1,error:`API error: ${n}`};if(["valid","connected","ok","ready","key","saved"].some(e=>n.includes(e)))return{isReady:!0,error:null};if("function"!=typeof e.generateRaw)return{isReady:!1,error:"Generation not available (ST version?)"};return{isReady:!0,error:null}}(e);return{mode:"current",displayName:"Current Settings",source:p,model:u,modelDisplay:w(u),apiType:d,contextSize:f,maxOutput:m,isReady:g,statusText:g?`${w(u)} Ready`:"Not Ready",error:h}}(t)}function _(e){return b(e).isReady}function w(e){if(!e||"unknown"===e)return"Unknown";const t=e.replace(/^gpt-/,"GPT-").replace(/^claude-/,"Claude-").replace(/^gemini-/,"Gemini-").replace(/-\d{4}-\d{2}-\d{2}$/,"").replace(/-preview$/,"");return t.length>30?t.slice(0,27)+"...":t}var x=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const $=new Map;new Map;function k(e){let t=0;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t|=0}const r=e.slice(0,16),n=e.slice(-16);return`${t}_${e.length}_${r}_${n}`}function S(e){return x(this,void 0,void 0,function*(){const t=e.trim();if(!t)return 0;const r=k(t),n=$.get(r);if(void 0!==n)return n;const i=SillyTavern.getContext();if("function"!=typeof i.getTokenCountAsync)return null;try{const e=yield i.getTokenCountAsync(t);return R(r,e),e}catch(e){return s.error("Token count failed",e),null}})}function P(e){return x(this,void 0,void 0,function*(){const t=e.map(e=>e.text),r=yield function(e){return x(this,void 0,void 0,function*(){const t=new Map,r=[];for(const n of e){const e=n.trim();if(!e){t.set(n,0);continue}const i=k(e),a=$.get(i);void 0!==a?t.set(n,a):r.push({text:e,key:i,original:n})}if(r.length>0){const e=SillyTavern.getContext();if("function"!=typeof e.getTokenCountAsync){for(const{original:e}of r)t.set(e,null);return t}const n=r.map(t=>x(this,[t],void 0,function*({text:t,key:r,original:n}){try{const i=yield e.getTokenCountAsync(t);return R(r,i),{original:n,tokens:i}}catch(e){return{original:n,tokens:null}}})),i=yield Promise.all(n);for(const{original:e,tokens:r}of i)t.set(e,r)}return t})}(t);return e.map(e=>{var t;return{key:e.key,tokens:null!==(t=r.get(e.text))&&void 0!==t?t:null}})})}function R(e,t){if(!$.has(e)&&$.size>=500){const e=$.keys().next().value;e&&$.delete(e)}$.set(e,t)}function A(e,t){const r=new Set(t.map(e=>e.toLowerCase()));if(!r.has(e.toLowerCase()))return e;let n=2,i=`${e} (${n})`;for(;r.has(i.toLowerCase());)n++,i=`${e} (${n})`;return i}},805(e,t,r){r.d(t,{A:()=>p});var n=r(601),i=r.n(n),a=r(314),s=r.n(a),o=r(417),c=r.n(o),l=new URL(r(242),r.b),d=s()(i()),u=c()(l);d.push([e.id,`.cr-apply-dialog,.cr-drawer,.cr-popup{--cr-bg:var(--SmartThemeBlurTintColor);--cr-bg-secondary:var(--black30a,rgba(0,0,0,.3));--cr-bg-tertiary:var(--black50a,rgba(0,0,0,.5));--cr-bg-elevated:color-mix(in srgb,var(--SmartThemeBlurTintColor) 90%,#fff 10%);--cr-text:var(--SmartThemeBodyColor);--cr-text-muted:color-mix(in srgb,var(--SmartThemeBodyColor) 70%,transparent);--cr-text-dim:color-mix(in srgb,var(--SmartThemeBodyColor) 50%,transparent);--cr-border:var(--SmartThemeBorderColor);--cr-border-muted:color-mix(in srgb,var(--SmartThemeBorderColor) 50%,transparent);--cr-accent:var(--SmartThemeQuoteColor);--cr-accent-hover:color-mix(in srgb,var(--SmartThemeQuoteColor) 80%,#fff);--cr-accent-muted:color-mix(in srgb,var(--SmartThemeQuoteColor) 30%,transparent);--cr-success:var(--okGreen70a,#4caf50);--cr-success-bg:color-mix(in srgb,var(--okGreen70a,#4caf50) 15%,transparent);--cr-warning:var(--golden,#ff9800);--cr-warning-bg:color-mix(in srgb,var(--golden,#ff9800) 15%,transparent);--cr-danger:var(--fullred,#f44336);--cr-danger-bg:color-mix(in srgb,var(--fullred,#f44336) 15%,transparent);--cr-space-1:0.25rem;--cr-space-2:0.5rem;--cr-space-3:0.75rem;--cr-space-4:1rem;--cr-space-5:1.25rem;--cr-space-6:1.5rem;--cr-space-8:2rem;--cr-space-12:3rem;--cr-font:var(--mainFontFamily,system-ui,-apple-system,sans-serif);--cr-font-mono:var(--monoFontFamily,"Consolas","Monaco",monospace);--cr-font-size:var(--mainFontSize,1rem);--cr-text-xs:calc(var(--cr-font-size) * 0.75);--cr-text-sm:calc(var(--cr-font-size) * 0.875);--cr-text-base:var(--cr-font-size);--cr-text-lg:calc(var(--cr-font-size) * 1.125);--cr-text-xl:calc(var(--cr-font-size) * 1.25);--cr-radius-sm:4px;--cr-radius:8px;--cr-radius-lg:12px;--cr-radius-pill:9999px;--cr-shadow-sm:0 1px 3px var(--black30a,rgba(0,0,0,.3));--cr-shadow:0 4px 12px var(--black30a,rgba(0,0,0,.3));--cr-shadow-md:0 4px 12px rgba(0,0,0,.15);--cr-shadow-lg:0 8px 24px var(--black50a,rgba(0,0,0,.5));--cr-shadow-drawer:-4px 0 24px rgba(0,0,0,.4);--cr-backdrop:rgba(0,0,0,.6);--cr-backdrop-blur:blur(4px);--cr-transition-fast:var(--animation-duration,150ms) ease;--cr-transition:var(--animation-duration-slow,300ms) ease;--cr-panel-min:280px;--cr-panel-max:480px;--cr-header-height:48px;--cr-avatar-size:48px;--cr-avatar-size-sm:32px;--cr-icon-size:24px;--cr-icon-size-sm:18px;--cr-score-high:#10b981;--cr-score-good:#22c55e;--cr-score-mid:#eab308;--cr-score-low:#f97316;--cr-score-bad:#ef4444}.cr-popup{font-family:var(--cr-font);font-size:var(--cr-font-size);color:var(--cr-text);line-height:1.5;box-sizing:border-box}.cr-popup *,.cr-popup :after,.cr-popup :before{box-sizing:inherit}.cr-popup h2,.cr-popup h3{margin:0;font-weight:600;line-height:1.3;color:var(--cr-text)}.cr-popup h2{font-size:var(--cr-text-lg)}.cr-popup h3{font-size:var(--cr-text-base)}.cr-popup a{color:var(--cr-accent);text-decoration:none}.cr-popup a:hover{text-decoration:underline}.cr-stack{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-row,.cr-stack--tight{gap:var(--cr-space-2)}.cr-row{display:flex;flex-direction:row;align-items:center}.cr-row--between{justify-content:space-between}.cr-flex-1{flex:1 1 0%}.cr-gap-1{gap:var(--cr-space-1)}.cr-gap-2{gap:var(--cr-space-2)}.cr-mt-2{margin-top:var(--cr-space-2)}.cr-mt-3{margin-top:var(--cr-space-3)}.cr-mt-4{margin-top:var(--cr-space-4)}.cr-mb-3{margin-bottom:var(--cr-space-3)}.cr-scrollable{overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-scrollable::-webkit-scrollbar{width:6px;height:6px}.cr-scrollable::-webkit-scrollbar-track{background:transparent}.cr-scrollable::-webkit-scrollbar-thumb{background:var(--cr-border);border-radius:var(--cr-radius-pill)}.cr-scrollable::-webkit-scrollbar-thumb:hover{background:var(--cr-accent)}.cr-text-dim{color:var(--cr-text-dim)}.cr-text-accent{color:var(--cr-accent)}.cr-text-success{color:var(--cr-success)}.cr-text-danger{color:var(--cr-danger)}.cr-text-xs{font-size:var(--cr-text-xs)}.cr-text-sm{font-size:var(--cr-text-sm)}.cr-text-right{text-align:right}.cr-font-medium{font-weight:500}.cr-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-hidden{display:none!important}.cr-popup{display:flex;flex-direction:column;width:100%;height:100%;min-height:0;background:var(--cr-bg);overflow:hidden}.popup:has(.cr-popup){width:95dvw;max-width:1200px;height:90dvh;max-height:none;padding:0;border-radius:var(--cr-radius-lg);overflow:hidden}.popup:has(.cr-popup)>div:first-child{display:flex;flex-direction:column;height:100%;padding:0;margin:0}@media (max-width:768px){.popup:has(.cr-popup){width:100dvw;height:100dvh;max-width:none;border-radius:0}}.cr-body{display:flex;flex-direction:column;flex:1;min-height:0}@media (min-width:769px){.cr-body{flex-direction:row}}.cr-panel{display:flex;flex-direction:column;min-height:0;min-width:0}.cr-panel--config{flex:1 1 auto;border-bottom:1px solid var(--cr-border-muted);overflow-y:auto}@media (min-width:769px){.cr-panel--config{flex:0 0 clamp(var(--cr-panel-min),38%,var(--cr-panel-max));border-bottom:none;border-right:1px solid var(--cr-border-muted)}}.cr-panel--results{flex:1 1 auto;overflow:hidden}@media (min-width:769px){.cr-panel--results{flex:1 1 62%}}.cr-section{display:flex;flex-direction:column;gap:var(--cr-space-3);padding:var(--cr-space-3);padding-top:0;border-bottom:1px solid var(--cr-border)}.cr-section:last-child{border-bottom:none}.cr-section__header{justify-content:space-between;margin:0 calc(-1 * var(--cr-space-3));margin-bottom:0;padding:var(--cr-space-2) var(--cr-space-3);min-height:40px;background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted)}.cr-section__header,.cr-section__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-section__title{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);text-transform:uppercase;letter-spacing:.025em}.cr-section__title i{color:var(--cr-accent);font-size:var(--cr-text-sm);width:1.25em;text-align:center}.cr-card{background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);overflow:hidden}.cr-card--selected{background:var(--cr-accent-muted);border-color:var(--cr-accent)}.cr-header{position:relative;z-index:100;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;min-height:var(--cr-header-height);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;gap:var(--cr-space-2) var(--cr-space-3)}@media (max-width:768px){.cr-header{grid-template-columns:auto 1fr auto;padding:var(--cr-space-2);gap:var(--cr-space-2)}}.cr-header__left{display:flex;align-items:center;justify-content:flex-start;gap:var(--cr-space-3)}.cr-header__left .cr-dropdown{flex:1;min-width:0;max-width:none}.cr-header__center{display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);min-width:0}.cr-header__center i{color:var(--cr-accent);font-size:var(--cr-text-lg)}@media (max-width:768px){.cr-header__center i{display:none}}.cr-header__center h2{font-size:var(--cr-text-base);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}@media (max-width:768px){.cr-header__center h2{font-size:var(--cr-text-sm)}}.cr-header__right{justify-content:flex-end;gap:var(--cr-space-2)}.cr-header__right,.cr-toolbar{display:flex;align-items:center}.cr-toolbar{justify-content:space-between;gap:var(--cr-space-2) var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:900px){.cr-toolbar{gap:var(--cr-space-2)}}.cr-toolbar__controls{flex-shrink:0}.cr-pipeline-controls,.cr-toolbar__controls{display:flex;align-items:center;gap:var(--cr-space-2);flex-wrap:wrap}.cr-pipeline-controls--generating{padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-radius:var(--cr-radius)}.cr-pipeline-status{font-size:var(--cr-text-sm);color:var(--cr-accent)}.cr-iteration-controls,.cr-pipeline-status{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-iteration-controls{margin-left:var(--cr-space-2);padding-left:var(--cr-space-2);border-left:1px solid var(--cr-border-muted)}@media (max-width:768px){.cr-iteration-controls{margin-left:0;padding-left:0;border-left:none;width:100%;flex:1 1 100%}}.cr-iteration-controls__input{width:120px;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);transition:border-color var(--cr-transition-fast),width var(--cr-transition-fast)}@media (max-width:768px){.cr-iteration-controls__input{flex:1;width:auto;min-width:0}}.cr-iteration-controls__input:focus{border-color:var(--cr-accent);outline:none;width:180px}@media (max-width:768px){.cr-iteration-controls__input:focus{width:auto}}.cr-iteration-controls__input::-moz-placeholder{color:var(--cr-text-muted)}.cr-iteration-controls__input::placeholder{color:var(--cr-text-muted)}.cr-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-stage-tabs{display:flex;gap:var(--cr-space-1);flex:1 1 auto;min-width:-moz-fit-content;min-width:fit-content}@media (max-width:768px){.cr-stage-tabs{gap:0}}.cr-stage-tab{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);white-space:nowrap}@media (max-width:768px){.cr-stage-tab{flex:1;justify-content:center;padding:var(--cr-space-2);font-size:var(--cr-text-xs);gap:var(--cr-space-1)}}.cr-stage-tab:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}.cr-stage-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-stage-tab__icon{font-size:1em;flex-shrink:0}.cr-stage-tab__label{flex:1 1 auto;min-width:-moz-max-content;min-width:max-content}@media (max-width:768px){.cr-stage-tab__label{display:none}}.cr-stage-tab__status{display:flex;align-items:center;justify-content:center;width:1.25em;height:1.25em;font-size:.75em;border-radius:50%;flex-shrink:0}.cr-stage-tab--running .cr-stage-tab__status{color:var(--cr-accent)}.cr-stage-tab--complete .cr-stage-tab__status{color:var(--cr-success);background:var(--cr-success-bg)}.cr-stage-tab--error .cr-stage-tab__status{color:var(--cr-danger);background:var(--cr-danger-bg)}.cr-dropdown{position:relative;min-width:200px;max-width:280px}@media (max-width:768px){.cr-dropdown{min-width:140px;max-width:220px}}.cr-dropdown--session{min-width:180px}@media (max-width:768px){.cr-dropdown--session{min-width:120px}}.cr-dropdown--disabled .cr-dropdown__trigger{opacity:.5;cursor:not-allowed}.cr-dropdown--open .cr-dropdown__trigger{border-color:var(--cr-accent);border-bottom-left-radius:0;border-bottom-right-radius:0}.cr-dropdown--open .cr-dropdown__trigger-chevron{transform:rotate(180deg)}.cr-dropdown--open .cr-dropdown__panel{display:flex}.cr-dropdown__trigger{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);color:var(--cr-text);background:var(--cr-bg);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-dropdown__trigger:hover{border-color:var(--cr-accent)}.cr-dropdown__trigger--session{gap:var(--cr-space-2)}.cr-dropdown__trigger-avatar{width:var(--cr-icon-size);height:var(--cr-icon-size);border-radius:var(--cr-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.cr-dropdown__trigger-icon{width:var(--cr-icon-size);text-align:center;color:var(--cr-text-muted);flex-shrink:0}.cr-dropdown__trigger-text{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-dropdown__trigger-text--placeholder{color:var(--cr-text-muted)}.cr-dropdown__trigger-chevron{font-size:.75em;color:var(--cr-text-muted);transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-dropdown__count{background:var(--cr-accent-muted);color:var(--cr-accent);padding:var(--cr-space-1) var(--cr-space-2);border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);font-weight:600}.cr-dropdown__panel{position:absolute;top:100%;left:0;right:0;min-width:320px;z-index:1000;display:none;flex-direction:column;background:var(--SmartThemeChatBg,#1a1a1a);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--cr-accent);border-top:none;border-bottom-left-radius:var(--cr-radius);border-bottom-right-radius:var(--cr-radius);box-shadow:var(--cr-shadow-lg);max-height:400px;overflow:hidden}@media (max-width:768px){.cr-dropdown__panel{min-width:280px;max-height:350px}}.cr-dropdown__panel--session{min-width:280px;max-height:320px}@media (max-width:768px){.cr-dropdown__panel--session{min-width:240px;max-height:280px}}.cr-dropdown__search{position:relative;padding:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted)}.cr-dropdown__search-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--cr-text-muted);font-size:14px;pointer-events:none;z-index:1}.cr-popup .cr-dropdown input.cr-dropdown__search-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);padding-left:44px;font-size:var(--cr-text-sm);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm);color:var(--cr-text)}.cr-popup .cr-dropdown input.cr-dropdown__search-input::-moz-placeholder{color:var(--cr-text-muted)}.cr-popup .cr-dropdown input.cr-dropdown__search-input::placeholder{color:var(--cr-text-muted)}.cr-popup .cr-dropdown input.cr-dropdown__search-input:focus{border-color:var(--cr-accent);outline:none}.cr-dropdown__search-clear{position:absolute;right:calc(var(--cr-space-2) + var(--cr-space-1));top:50%;transform:translateY(-50%);padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;opacity:.7}.cr-dropdown__search-clear:hover{opacity:1;color:var(--cr-text)}.cr-dropdown__list{flex:1;overflow-y:auto;max-height:320px;padding:var(--cr-space-2);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-dropdown__list--session{max-height:220px}.cr-dropdown__empty{padding:var(--cr-space-6);text-align:center;font-size:var(--cr-text-sm);color:var(--cr-text-muted)}.cr-dropdown__empty i{display:block;font-size:2em;margin-bottom:var(--cr-space-2);opacity:.5}.cr-dropdown__footer{display:flex;gap:var(--cr-space-2);padding:var(--cr-space-2);border-top:1px solid var(--cr-border-muted)}.cr-dropdown__new-btn{flex:1;justify-content:center}.cr-dropdown__delete-all-btn{color:var(--cr-danger);flex-shrink:0}.cr-dropdown__delete-all-btn:hover{background:color-mix(in srgb,var(--cr-danger) 15%,transparent)}.cr-char-option{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);cursor:pointer;border-radius:var(--cr-radius);background:var(--cr-bg-secondary);border:1px solid transparent;transition:background var(--cr-transition-fast),border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast),transform var(--cr-transition-fast)}.cr-char-option:hover{background:var(--cr-bg-tertiary);border-color:var(--cr-border);transform:translateX(var(--cr-space-1))}.cr-char-option--selected{border-color:var(--cr-accent)}.cr-char-option--selected,.cr-char-option--selected:hover{background:var(--cr-accent-muted)}.cr-char-option--highlighted{background:var(--cr-bg-tertiary);border-color:var(--cr-accent);box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-char-option__avatar-wrap{position:relative;flex-shrink:0}.cr-char-option__avatar{width:var(--cr-avatar-size);height:var(--cr-avatar-size);border-radius:var(--cr-radius);-o-object-fit:cover;object-fit:cover;border:2px solid var(--cr-border-muted);transition:border-color var(--cr-transition-fast)}.cr-char-option--selected .cr-char-option__avatar,.cr-char-option:hover .cr-char-option__avatar{border-color:var(--cr-accent)}.cr-char-option__check{position:absolute;bottom:-4px;right:-4px;width:var(--cr-icon-size-sm);height:var(--cr-icon-size-sm);display:flex;align-items:center;justify-content:center;background:var(--cr-accent);color:var(--cr-bg);border-radius:50%;font-size:var(--cr-text-xs);box-shadow:var(--cr-shadow-sm)}.cr-char-option__info{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-char-option__name{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-char-option__desc{font-size:var(--cr-text-xs);color:var(--cr-text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.cr-char-option__meta{display:flex;align-items:center;gap:var(--cr-space-1);font-size:var(--cr-text-xs);color:var(--cr-text-muted);margin-top:var(--cr-space-1)}.cr-char-option__meta i{font-size:.75em;opacity:.7}.cr-session-option{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background var(--cr-transition-fast)}.cr-session-option:last-child{border-bottom:none}.cr-session-option:hover{background:var(--cr-bg-tertiary)}.cr-session-option--active,.cr-session-option--active:hover{background:var(--cr-accent-muted)}.cr-session-option__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-session-option__name{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cr-session-option__indicator{font-size:.5em;color:var(--cr-accent);flex-shrink:0}.cr-session-option__name-input{flex:1;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-sm);border:1px solid var(--cr-accent);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);outline:none}.cr-session-option__name-input:focus{box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-session-option__meta{display:flex;gap:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-session-option__meta span:after{content:"";margin-left:var(--cr-space-2);opacity:.5}.cr-session-option__meta span:last-child:after{display:none}.cr-session-option__actions{display:flex;gap:var(--cr-space-1);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-session-option__actions--editing{opacity:1}.cr-session-option__actions .menu_button--ghost{padding:var(--cr-space-1)}.cr-session-option__actions .menu_button--ghost:hover{background:var(--cr-bg-secondary)}.cr-session-option__actions .cr-session-delete:hover{color:var(--cr-danger)}.cr-session-option:hover .cr-session-option__actions{opacity:1}@media (max-width:768px){.cr-session-option__actions{opacity:1}}.cr-popup input[type=number],.cr-popup input[type=search],.cr-popup input[type=text],.cr-popup select,.cr-popup textarea{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);transition:border-color var(--cr-transition-fast)}.cr-popup input[type=number]:focus,.cr-popup input[type=search]:focus,.cr-popup input[type=text]:focus,.cr-popup select:focus,.cr-popup textarea:focus{border-color:var(--cr-accent);outline:none}.cr-popup textarea{min-height:100px;resize:vertical;line-height:1.5}.cr-popup textarea.cr-textarea--code{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs)}:is(.cr-popup,.cr-drawer) input[type=checkbox]{width:16px!important;height:16px!important;min-width:16px;min-height:16px;padding:0;margin:0;-webkit-appearance:auto;-moz-appearance:auto;appearance:auto;accent-color:var(--cr-accent);cursor:pointer;flex-shrink:0;opacity:1;visibility:visible}.cr-checkbox{display:flex;align-items:center;gap:var(--cr-space-2);cursor:pointer;font-size:var(--cr-text-sm)}.cr-checkbox input[type=checkbox]{width:16px!important;height:16px!important;accent-color:var(--cr-accent)}.cr-form-group{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-form-group__hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-form-group--grow{flex:1;display:flex;flex-direction:column;min-height:0}.cr-select{width:auto;min-width:140px;max-width:180px;padding:var(--cr-space-1) var(--cr-space-6) var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:border-color var(--cr-transition-fast);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;-moz-appearance:none!important;appearance:none!important;-webkit-appearance:none!important;background-image:url(${u})!important;background-repeat:no-repeat!important;background-position:right var(--cr-space-2) center!important;background-size:12px!important;padding-right:var(--cr-space-6)!important}.cr-select:focus,.cr-select:hover{border-color:var(--cr-accent);outline:none}.cr-textarea--editor{width:100%;height:100%;min-height:200px;resize:vertical;font-family:var(--cr-font);font-size:var(--cr-text-sm);line-height:1.6}.cr-textarea--compact{min-height:60px}.cr-editor-wrap{position:relative;flex:1;min-height:200px}.cr-editor-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border-muted);border-bottom:none;border-radius:var(--cr-radius) var(--cr-radius) 0 0}.cr-toolbar-divider{width:1px;height:1.5em;background:var(--cr-border-muted);margin:0 var(--cr-space-1)}.cr-code-editor{position:relative;flex:1;min-height:250px;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;border:1px solid var(--cr-border);border-top:none;border-radius:0 0 var(--cr-radius) var(--cr-radius);overflow:hidden}.cr-code-editor__highlight,.cr-code-editor__textarea{position:absolute;inset:0;margin:0;padding:var(--cr-space-3);font-family:inherit;font-size:inherit;line-height:inherit;white-space:pre-wrap;word-wrap:break-word;overflow:auto}.cr-code-editor__highlight{pointer-events:none;background:var(--cr-bg-secondary);color:var(--cr-text)}.cr-code-editor__highlight code{font-family:inherit;background:transparent}.cr-code-editor__textarea{background:transparent;color:transparent;caret-color:var(--cr-text);resize:none;border:none;outline:none;z-index:1}.cr-code-editor__textarea::-moz-selection{background:var(--cr-accent-muted)}.cr-code-editor__textarea::selection{background:var(--cr-accent-muted)}:is(.cr-popup,.cr-drawer) .menu_button{display:inline-flex;align-items:center;justify-content:center;gap:var(--cr-space-1);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast);width:auto;min-width:auto;margin:0}:is(.cr-popup,.cr-drawer) .menu_button--icon{padding:var(--cr-space-2);aspect-ratio:1}:is(.cr-popup,.cr-drawer) .menu_button--sm{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs)}:is(.cr-popup,.cr-drawer) .menu_button--lg{padding:var(--cr-space-3) var(--cr-space-4);font-size:var(--cr-text-base)}:is(.cr-popup,.cr-drawer) .menu_button--full{width:100%}:is(.cr-popup,.cr-drawer) .menu_button--primary{background:var(--cr-accent);border-color:var(--cr-accent);color:var(--cr-bg);filter:none}:is(.cr-popup,.cr-drawer) .menu_button--primary:hover:not(:disabled){background:var(--cr-accent-hover);border-color:var(--cr-accent-hover);filter:none}:is(.cr-popup,.cr-drawer) .menu_button--danger{background:var(--cr-danger);border-color:var(--cr-danger);color:#fff;filter:none}:is(.cr-popup,.cr-drawer) .menu_button--danger:hover:not(:disabled){filter:brightness(1.1)}:is(.cr-popup,.cr-drawer) .menu_button--ghost{background:transparent;border-color:transparent}:is(.cr-popup,.cr-drawer) .menu_button--ghost:hover:not(:disabled){background:var(--cr-bg-secondary)}:is(.cr-popup,.cr-drawer) .menu_button--success{background:var(--cr-success);border-color:var(--cr-success);color:#fff;filter:none}:is(.cr-popup,.cr-drawer) .menu_button:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.5)}:is(.cr-popup,.cr-drawer) .menu_button:active:not(:disabled){transform:scale(.97)}:is(.cr-popup,.cr-drawer) .menu_button.cr-active{color:var(--cr-accent);background:var(--cr-accent-muted);border-color:var(--cr-accent)}:is(.cr-popup,.cr-drawer) .menu_button.cr-active:hover:not(:disabled){background:color-mix(in srgb,var(--cr-accent) 40%,transparent)}.cr-button-group{display:flex;gap:var(--cr-space-2)}.cr-field-list{display:flex;flex-direction:column;gap:var(--cr-space-1);min-height:80px;max-height:400px;overflow:hidden auto;padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius) var(--cr-radius) 0 0;border:1px solid var(--cr-border-muted);border-bottom:none;text-align:left;scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-field-list::-webkit-scrollbar{width:6px}.cr-field-list::-webkit-scrollbar-track{background:transparent}.cr-field-list::-webkit-scrollbar-thumb{background:var(--cr-border);border-radius:var(--cr-radius-pill)}.cr-field-list::-webkit-scrollbar-thumb:hover{background:var(--cr-accent)}.cr-field-total{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border-muted);border-radius:0 0 var(--cr-radius) var(--cr-radius);font-size:var(--cr-text-xs)}.cr-field-total__label{color:var(--cr-text-muted)}.cr-field-total__value{font-weight:500;color:var(--cr-text);font-variant-numeric:tabular-nums}.cr-token-warning{display:flex;align-items:flex-start;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);margin-top:var(--cr-space-2);font-size:var(--cr-text-xs);line-height:1.4;border-radius:var(--cr-radius-sm)}.cr-token-warning i{flex-shrink:0;margin-top:.1em}.cr-token-warning--warning{color:var(--cr-warning);background:color-mix(in srgb,var(--cr-warning) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-warning) 30%,transparent)}.cr-token-warning--critical{color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-danger) 30%,transparent)}.cr-field-item{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);padding:var(--cr-space-2);border-radius:var(--cr-radius-sm);transition:background var(--cr-transition-fast)}.cr-field-item:hover{background:var(--cr-bg-tertiary)}.cr-field-label{display:flex;align-items:center;gap:var(--cr-space-2);flex:1;cursor:pointer;font-size:var(--cr-text-sm)}.cr-field-checkbox{width:auto!important;margin:0;accent-color:var(--cr-accent);cursor:pointer;flex-shrink:0}.cr-field-name{flex:1;color:var(--cr-text)}.cr-field-count,.cr-field-tokens{font-size:var(--cr-text-xs);color:var(--cr-text-dim);flex-shrink:0;min-width:2.5em;text-align:right}.cr-entry-status{flex-shrink:0;width:1em;text-align:center;font-size:var(--cr-text-xs)}.cr-entry-enabled{color:var(--cr-success)}.cr-entry-disabled{color:var(--cr-text-dim);opacity:.6}.cr-field-group,.cr-field-group .cr-field-item--parent{border-radius:var(--cr-radius-sm)}.cr-field-group .cr-field-item--parent:hover{background:var(--cr-bg-tertiary)}.cr-field-group .cr-field-children{display:none;max-height:200px;overflow-y:auto;margin-top:var(--cr-space-1);margin-left:var(--cr-space-4);padding-left:var(--cr-space-2);border-left:2px solid var(--cr-border-muted);scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-field-group--expanded .cr-field-children{display:block}.cr-field-group .cr-field-item--child{padding:var(--cr-space-1) var(--cr-space-2);border-radius:var(--cr-radius-sm)}.cr-field-group .cr-field-item--child:hover{background:var(--cr-bg-tertiary)}.cr-field-expand{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-field-expand:hover{color:var(--cr-text)}.cr-field-group--expanded .cr-field-expand{transform:rotate(180deg)}.cr-field-preview-btn{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-dim);cursor:pointer;transition:color var(--cr-transition-fast)}.cr-field-preview-btn:hover{color:var(--cr-accent)}.cr-popup-preview{margin:0;padding:var(--cr-space-3);max-height:70vh;min-height:200px;overflow-y:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius);color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text;text-align:left}.cr-preview-content{max-height:70vh}.cr-preview-content pre{padding:var(--cr-space-3);line-height:1.6;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius);color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.cr-label{display:block;margin-bottom:var(--cr-space-1);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text)}.cr-required{color:var(--cr-danger)}.cr-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font)}.cr-hint{display:block;margin-top:var(--cr-space-1);font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-checkbox-label{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);color:var(--cr-text);cursor:pointer}.cr-checkbox-label input[type=checkbox]{width:auto;accent-color:var(--cr-accent);cursor:pointer}.cr-errors,.cr-warnings{display:flex;flex-direction:column;gap:var(--cr-space-1);padding:var(--cr-space-3);border-radius:var(--cr-radius-sm)}.cr-errors{background:var(--cr-danger-bg);border:1px solid var(--cr-danger)}.cr-warnings{background:var(--cr-warning-bg);border:1px solid var(--cr-warning)}.cr-error{color:var(--cr-danger)}.cr-error,.cr-warning{font-size:var(--cr-text-sm)}.cr-warning{color:var(--cr-warning)}.cr-collapsible{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-collapsible summary{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;cursor:pointer;background:var(--cr-bg-secondary);list-style:none;transition:background var(--cr-transition-fast)}.cr-collapsible summary:hover{background:var(--cr-bg-tertiary)}.cr-collapsible summary::-webkit-details-marker{display:none}.cr-collapsible[open] summary{border-bottom:1px solid var(--cr-border-muted)}.cr-collapsible__content{padding:var(--cr-space-3)}.cr-shortcut{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2);border-radius:var(--cr-radius-sm)}.cr-list{display:flex;flex-direction:column}.cr-list-item{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background var(--cr-transition-fast)}.cr-list-item:last-child{border-bottom:none}.cr-list-item:hover{background:var(--cr-bg-secondary)}.cr-list-item--selected{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-list-item__title{font-weight:600;font-size:var(--cr-text-sm);color:var(--cr-text)}.cr-list-item__subtitle{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-list-item__actions{display:flex;gap:var(--cr-space-1);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-list-item:hover .cr-list-item__actions{opacity:1}.cr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;min-height:0;padding:var(--cr-space-8);text-align:center;color:var(--cr-text-muted);animation:cr-empty-appear .3s ease-out}.cr-empty--compact{padding:var(--cr-space-4)}.cr-empty--compact .cr-empty__icon{font-size:2rem;margin-bottom:var(--cr-space-2)}.cr-empty--inline{flex-direction:row;flex:0;gap:var(--cr-space-2);padding:var(--cr-space-3);text-align:left}.cr-empty--inline .cr-empty__icon{font-size:1rem;margin:0;opacity:.5}.cr-empty--inline .cr-empty__text{font-size:var(--cr-text-xs);max-width:none}.cr-empty__icon{font-size:3rem;opacity:.3;margin-bottom:var(--cr-space-4);transition:opacity var(--cr-transition-fast),transform var(--cr-transition-fast)}.cr-empty:hover .cr-empty__icon{opacity:.4;transform:scale(1.05)}.cr-empty__title{font-weight:600;font-size:var(--cr-text-base);margin-bottom:var(--cr-space-2);color:var(--cr-text)}.cr-empty__text{font-size:var(--cr-text-sm);color:var(--cr-text-dim);max-width:280px;line-height:1.5}@keyframes cr-empty-appear{0%{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.cr-results-wrapper{display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden}.cr-results-toolbar{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);min-height:40px;background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:768px){.cr-results-toolbar{padding:var(--cr-space-2)}}.cr-results-content{flex:1;min-height:0;overflow:hidden;display:flex;flex-direction:column;text-align:left}.cr-results-content>*{flex:1;min-height:0}.cr-result{display:flex;flex-direction:column;height:100%}.cr-result__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-result__type{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-result__actions,.cr-result__type{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-result__content{flex:1;overflow-y:auto;padding:var(--cr-space-3);text-align:left}.cr-result__raw{line-height:1.6;white-space:pre-wrap;word-break:break-word;color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.cr-result__code,.cr-result__raw{margin:0;padding:var(--cr-space-3);font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius)}.cr-result__code{line-height:1.5;overflow-x:auto}.cr-result__code code{font-family:inherit}:is(.cr-json-toggle,.cr-text-toggle){display:flex;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);padding:var(--cr-space-1)}:is(.cr-json-toggle,.cr-text-toggle)>button{display:flex;align-items:center;justify-content:center;min-width:1.75rem;height:1.5rem;padding:0 var(--cr-space-1);border:none;background:transparent;color:var(--cr-text-dim);cursor:pointer;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast)}:is(.cr-json-toggle,.cr-text-toggle)>button:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}:is(.cr-json-toggle__btn,.cr-text-toggle__btn)--active{color:var(--cr-accent);background:var(--cr-bg);box-shadow:var(--cr-shadow-sm)}.cr-view-toggle{display:flex;gap:var(--cr-space-1);background:var(--cr-bg-secondary);padding:var(--cr-space-1);border-radius:var(--cr-radius)}.cr-view-toggle__btn{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);border-radius:calc(var(--cr-radius) - var(--cr-space-1));background:transparent;border:none;color:var(--cr-text-dim);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-view-toggle__btn:hover{color:var(--cr-text)}.cr-view-toggle__btn--active{background:var(--cr-bg);color:var(--cr-text);box-shadow:var(--cr-shadow-sm)}.cr-compare-view{height:100%;overflow:hidden}.cr-compare-list,.cr-compare-view{display:flex;flex-direction:column;flex:1;min-height:0}.cr-compare-list{overflow-y:auto;padding:var(--cr-space-3)}@media (max-width:768px){.cr-compare-list{padding:var(--cr-space-2)}}.cr-compare-row{display:flex;flex-direction:column;flex:1;min-height:200px;margin-bottom:var(--cr-space-3);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-compare-row--unchanged{opacity:.7}.cr-compare-row__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted)}.cr-compare-row__label{font-weight:600;font-size:var(--cr-text-sm)}.cr-compare-row__content{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr;flex:1;min-height:0;gap:1px;background:var(--cr-border)}@media (max-width:768px){.cr-compare-row__content{grid-template-columns:1fr;grid-template-rows:1fr 1fr}}.cr-compare-row__content--single{grid-template-columns:1fr;background:transparent}.cr-compare-col{display:flex;flex-direction:column;background:var(--cr-bg);padding:var(--cr-space-2);text-align:left;min-height:0;overflow:hidden}.cr-compare-col__header{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;color:var(--cr-text-dim);margin-bottom:var(--cr-space-2)}.cr-compare-col--original .cr-compare-col__header{color:var(--cr-danger)}.cr-compare-col--rewritten .cr-compare-col__header{color:var(--cr-success)}.cr-compare-text{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;margin:0;flex:1;min-height:0;overflow:auto;text-align:left}.cr-formatted{display:flex;flex-direction:column;gap:var(--cr-space-2);font-size:var(--cr-text-sm);line-height:1.55}.cr-formatted--empty{padding:var(--cr-space-4);text-align:center;color:var(--cr-text-dim);font-style:italic}.cr-hero{position:relative;display:flex;flex-direction:column;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:linear-gradient(135deg,var(--cr-bg-secondary) 0,var(--cr-bg-tertiary) 100%);border-radius:var(--cr-radius);border:1px solid var(--cr-border);text-align:center;overflow:hidden}.cr-hero:before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:120px;background:var(--score-color,var(--cr-accent));opacity:.06;filter:blur(30px);border-radius:50%;pointer-events:none}.cr-hero__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--cr-text-muted);margin-bottom:var(--cr-space-1)}.cr-hero__score{display:flex;align-items:baseline;gap:var(--cr-space-1)}.cr-hero__value{font-size:2.5rem;font-weight:800;line-height:1;color:var(--score-color,var(--cr-accent));text-shadow:0 2px 12px color-mix(in srgb,var(--score-color,var(--cr-accent)) 25%,transparent);font-variant-numeric:tabular-nums}.cr-hero__max{font-size:1rem;font-weight:500;color:var(--cr-text-dim);margin-left:var(--cr-space-1)}.cr-hero__bar{width:100%;max-width:160px;height:var(--cr-space-1);margin-top:var(--cr-space-2);background:var(--cr-bg-tertiary);overflow:hidden}.cr-hero__bar,.cr-hero__fill{border-radius:var(--cr-radius-sm)}.cr-hero__fill{height:100%;transition:width var(--cr-transition);background:var(--score-color,var(--cr-accent))}.cr-formatted .cr-section{background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-formatted .cr-section .cr-section__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);margin:0}.cr-formatted .cr-section .cr-section__title{margin:0;font-size:var(--cr-text-sm);font-weight:700;color:var(--cr-text);text-transform:none;letter-spacing:normal}.cr-formatted .cr-section .cr-section__body{padding:var(--cr-space-3);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-formatted .cr-section .cr-section__body--nested{background:var(--cr-bg);border-left:2px solid var(--cr-accent)}.cr-section__score{display:inline-flex;align-items:baseline;padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-section__score-max{font-size:.8em;font-weight:500;opacity:.6;margin-left:1px}.cr-field{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-field__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--cr-text-muted)}.cr-field__value{font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-field--empty{color:var(--cr-text-dim);font-style:italic}.cr-para{margin:0;font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-para+.cr-para{margin-top:var(--cr-space-1)}.cr-text{font-size:var(--cr-text-sm);line-height:1.6;white-space:pre-wrap}.cr-formatted .cr-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-formatted .cr-list li{position:relative;padding-left:var(--cr-space-3);font-size:var(--cr-text-sm);line-height:1.5}.cr-formatted .cr-list li:before{content:"";position:absolute;left:0;top:.55em;width:5px;height:5px;background:var(--cr-accent);border-radius:50%;opacity:.7}.cr-cards{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-formatted .cr-card{padding:var(--cr-space-4);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);transition:border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast)}.cr-formatted .cr-card:hover{border-color:var(--cr-border);box-shadow:var(--cr-shadow-md)}.cr-formatted .cr-card__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);margin-bottom:var(--cr-space-3)}.cr-formatted .cr-card__title{font-weight:700;font-size:var(--cr-text-base);color:var(--cr-text)}.cr-formatted .cr-card__body{font-size:var(--cr-text-sm);line-height:1.7;color:var(--cr-text-muted)}.cr-formatted .cr-card__extra{margin-top:var(--cr-space-3);padding-top:var(--cr-space-3);border-top:1px solid var(--cr-border-muted);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-score{display:inline-flex;align-items:baseline;padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-score__max{font-size:.75em;font-weight:500;opacity:.6;margin-left:1px}.cr-inline-score{display:inline-flex;align-items:baseline;padding:1px var(--cr-space-2);margin:0 var(--cr-space-1);background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 12%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:.95em;color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-inline-score__label{font-weight:500;color:var(--cr-text-muted);margin-right:var(--cr-space-1)}.cr-inline-score__max{font-size:.75em;font-weight:500;opacity:.5}.cr-code{position:relative;background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-code__lang{position:absolute;top:var(--cr-space-2);right:var(--cr-space-2);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius-sm);font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-text-muted);text-transform:uppercase;letter-spacing:.05em}.cr-code__pre{margin:0;padding:var(--cr-space-4);overflow-x:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6}.cr-code__pre code{font-family:inherit}.cr-inline-code{padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);font-family:var(--cr-font-mono);font-size:.9em;color:var(--cr-accent)}.cr-bool--yes{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-success);font-weight:600}.cr-bool--yes i{font-size:1.1em}.cr-bool--no{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-danger);font-weight:600}.cr-bool--no i{font-size:1.1em}.cr-formatted .cr-empty,.cr-null{color:var(--cr-text-dim)}.cr-formatted .cr-empty{font-style:italic}.cr-num{font-family:var(--cr-font-mono);font-weight:600;font-variant-numeric:tabular-nums}.cr-link{color:var(--cr-accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color var(--cr-transition-fast)}.cr-link:hover{border-bottom-color:var(--cr-accent)}.cr-preview-content{max-height:60vh;overflow-y:auto;padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);text-align:left}.cr-preview-content pre{margin:0;padding:0;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word;text-align:left}.cr-history{flex-shrink:0;border-top:1px solid var(--cr-border-muted);background:var(--cr-bg)}.cr-history--collapsed .cr-history__toggle-icon{transform:rotate(-90deg)}.cr-history--collapsed .cr-history__list{display:none}.cr-history__toggle{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border:none;cursor:pointer;font-size:var(--cr-text-xs);font-weight:500;color:var(--cr-text-muted);text-align:left}.cr-history__toggle:hover{background:var(--cr-bg-tertiary);color:var(--cr-text)}.cr-history__toggle-icon{margin-left:auto;transition:transform var(--cr-transition-fast)}.cr-history__list{max-height:180px;overflow-y:auto;padding:var(--cr-space-1);background:var(--cr-bg-secondary)}.cr-history-nav{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2) var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-bottom:1px solid var(--cr-accent);flex-wrap:wrap;flex-shrink:0}@media (max-width:768px){.cr-history-nav{padding:var(--cr-space-2)}}.cr-history-nav__info{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-accent)}@media (max-width:768px){.cr-history-nav__info{font-size:var(--cr-text-xs)}}.cr-history-nav__controls{display:flex;align-items:center;gap:var(--cr-space-2);flex-wrap:wrap}@media (max-width:768px){.cr-history-nav__controls{gap:var(--cr-space-1)}}.cr-history-nav__btn{flex-shrink:0}.cr-list-item--error{border-left:3px solid var(--cr-danger)}.cr-list-item--error .cr-list-item__title{color:var(--cr-danger)}.cr-list-item--viewing{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item--current{opacity:.7}.cr-history__list .cr-list-item{padding:var(--cr-space-2);gap:var(--cr-space-2);align-items:center}.cr-history__list .cr-list-item .cr-list-item__content{gap:0}.cr-history__list .cr-list-item .cr-list-item__title{font-size:var(--cr-text-xs)}.cr-history__list .cr-list-item .cr-list-item__subtitle{display:none}.cr-history__list .cr-list-item .cr-row{gap:var(--cr-space-2)}.cr-api-badge{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-success-bg);border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);color:var(--cr-text-muted);cursor:default;transition:background var(--cr-transition-fast)}.cr-api-badge--error{background:var(--cr-danger-bg)}.cr-api-badge i{font-size:.625em}.cr-api-status{display:flex;align-items:center;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-api-status--ready{border-color:var(--cr-success)}.cr-api-status--error{border-color:var(--cr-danger)}.cr-api-status__indicator{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-status__text{font-size:var(--cr-text-sm);font-weight:500}.cr-api-status__error{color:var(--cr-danger);cursor:help}.cr-badge{display:inline-flex;align-items:center;padding:.2em .6em;font-size:var(--cr-text-xs);font-weight:500;border-radius:var(--cr-radius-pill);text-transform:uppercase;letter-spacing:.03em}.cr-badge--success{background:var(--cr-success-bg);color:var(--cr-success)}.cr-badge--warning{background:var(--cr-warning-bg);color:var(--cr-warning)}.cr-badge--sm{padding:.1em .4em;font-size:var(--cr-text-xs)}.cr-badge--info{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-badge--muted{background:var(--cr-bg-secondary);color:var(--cr-text-dim)}.cr-alert{display:flex;gap:var(--cr-space-3);padding:var(--cr-space-3);border-radius:var(--cr-radius);font-size:var(--cr-text-sm)}.cr-alert--info{background:var(--cr-accent-muted);border:1px solid var(--cr-accent);color:var(--cr-accent)}.cr-alert--success{background:var(--cr-success-bg);border:1px solid var(--cr-success);color:var(--cr-success)}.cr-alert--warning{background:var(--cr-warning-bg);border:1px solid var(--cr-warning);color:var(--cr-warning)}.cr-alert--danger{background:var(--cr-danger-bg);border:1px solid var(--cr-danger);color:var(--cr-danger)}.cr-alert__icon{flex-shrink:0}.cr-alert__content{flex:1;min-width:0}.cr-alert__title{font-weight:600;margin-bottom:var(--cr-space-1)}.cr-alert__message{margin-top:var(--cr-space-1);font-size:var(--cr-text-sm);white-space:pre-wrap}@keyframes cr-spin{to{transform:rotate(1turn)}}@keyframes cr-pulse{0%,to{opacity:1}50%{opacity:.6}}@keyframes cr-shimmer{0%{transform:translateX(-100%)}to{transform:translateX(100%)}}.cr-drawer{position:absolute;inset:0;z-index:100;pointer-events:none;overflow:hidden}.cr-drawer[aria-hidden=true]{visibility:hidden}.cr-drawer--open{pointer-events:auto;visibility:visible}.cr-drawer--open .cr-drawer__backdrop{opacity:1}.cr-drawer--open .cr-drawer__panel{transform:translateX(0)}.cr-drawer__backdrop{position:absolute;inset:0;background:var(--cr-backdrop);opacity:0;transition:opacity var(--cr-transition);backdrop-filter:var(--cr-backdrop-blur)}.cr-drawer__panel{position:absolute;top:0;right:0;bottom:0;width:100%;max-width:640px;background:var(--SmartThemeBlurTintColor,var(--cr-bg));border-left:1px solid var(--cr-border);box-shadow:var(--cr-shadow-drawer);transform:translateX(100%);transition:transform var(--cr-transition);display:flex;flex-direction:column}@media (max-width:768px){.cr-drawer__panel{max-width:none}}.cr-drawer__content{display:flex;flex-direction:column;height:100%;min-height:0}.cr-drawer__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-drawer__title h3{margin:0;font-size:var(--cr-text-lg);font-weight:600}.cr-drawer__title i{font-size:var(--cr-text-base)}.cr-drawer__body{flex:1;min-height:0;overflow-y:auto;padding:var(--cr-space-4);display:flex;flex-direction:column;gap:var(--cr-space-4)}.cr-drawer__footer{display:flex;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__footer--list,.cr-drawer__footer--spaced{justify-content:space-between}.cr-drawer__footer--spaced{gap:var(--cr-space-4)}.cr-drawer__tabs{display:flex;background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__tab{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all var(--cr-transition-fast)}.cr-drawer__tab:hover{color:var(--cr-text);background:var(--cr-bg-tertiary)}.cr-drawer__tab--active{color:var(--cr-accent);border-bottom-color:var(--cr-accent)}.cr-preset-row{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-preset-row .cr-select{flex:1;min-width:0}.cr-preset-label{color:var(--cr-text-muted);flex-shrink:0;white-space:nowrap}.cr-chip,.cr-preset-label{font-size:var(--cr-text-xs)}.cr-chip{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-pill);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-chip--active,.cr-chip:hover{border-color:var(--cr-accent)}.cr-chip--active{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-chip input[type=checkbox]{display:none}.cr-preset-list{display:flex;flex-direction:column;flex:1;min-height:0}.cr-preset-list__section-label{padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--cr-text-dim);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);position:sticky;top:0;z-index:1}.cr-preset-list__item{display:flex;align-items:stretch;border-bottom:1px solid var(--cr-border-muted);transition:background var(--cr-transition-fast)}.cr-preset-list__item:last-child{border-bottom:none}.cr-preset-list__item:hover{background:var(--cr-bg-secondary)}.cr-preset-list__item--builtin{opacity:.85}.cr-preset-list__select{flex:1;display:flex;align-items:center;min-width:0;padding:var(--cr-space-3);background:none;border:none;cursor:pointer;text-align:left;color:inherit}.cr-preset-list__info{display:flex;flex-direction:column;gap:var(--cr-space-1);min-width:0}.cr-preset-list__name{display:flex;align-items:center;gap:var(--cr-space-2);font-weight:500;font-size:var(--cr-text-sm);color:var(--cr-text)}.cr-preset-list__name i,.cr-preset-list__stages{font-size:var(--cr-text-xs)}.cr-preset-list__stages{color:var(--cr-text-muted)}.cr-preset-list__actions{display:flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-2);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-preset-list__item:hover .cr-preset-list__actions{opacity:1}@media (max-width:768px){.cr-preset-list__actions{opacity:1}}.cr-preset-list__action{flex-shrink:0}.cr-drawer__body--list{padding:0;overflow:hidden}.cr-settings-section{display:flex;flex-direction:column;gap:var(--cr-space-3);padding:var(--cr-space-4);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius)}@media (max-width:768px){.cr-settings-section{padding:var(--cr-space-3);gap:var(--cr-space-2)}}.cr-settings-section h3{display:flex;align-items:center;gap:var(--cr-space-2);margin:0 0 var(--cr-space-2) 0;padding-bottom:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted);font-size:var(--cr-text-base);font-weight:600}@media (max-width:768px){.cr-settings-section h3{font-size:var(--cr-text-sm)}}.cr-settings-section h3 i{color:var(--cr-accent);font-size:var(--cr-text-sm)}.cr-api-banner{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);border-radius:var(--cr-radius);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);margin-bottom:var(--cr-space-3)}.cr-api-banner--ready{border-color:var(--cr-success);background:color-mix(in srgb,var(--cr-success) 10%,var(--cr-bg-secondary))}.cr-api-banner--ready .cr-api-banner__left i{color:var(--cr-success)}.cr-api-banner--error{border-color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,var(--cr-bg-secondary))}.cr-api-banner--error .cr-api-banner__left i{color:var(--cr-danger)}.cr-api-banner__left{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-banner__name{font-weight:500;font-size:var(--cr-text-sm)}.cr-api-banner__right{display:flex;align-items:center;gap:var(--cr-space-3);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-api-banner__model{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-api-banner__limits{display:flex;align-items:center;gap:var(--cr-space-1)}.cr-api-banner__limits--override{color:var(--cr-accent);font-weight:500}.cr-api-banner__override-icon{font-size:.6rem;color:var(--cr-accent)}.cr-api-error{align-items:center;padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 8%,transparent);border-radius:var(--cr-radius)}.cr-api-error,.cr-gen-mode-toggle{display:flex;gap:var(--cr-space-2);margin-bottom:var(--cr-space-3)}@media (max-width:768px){.cr-gen-mode-toggle{flex-direction:column;gap:var(--cr-space-1)}}.cr-gen-mode-option{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);background:var(--cr-bg-secondary);cursor:pointer;transition:all var(--cr-transition);font-size:var(--cr-text-sm)}@media (max-width:768px){.cr-gen-mode-option{padding:var(--cr-space-3);justify-content:flex-start}}.cr-gen-mode-option input[type=radio]{display:none}.cr-gen-mode-option:hover{border-color:var(--cr-border);background:var(--cr-bg-tertiary)}.cr-gen-mode-option--active{border-color:var(--cr-accent);background:color-mix(in srgb,var(--cr-accent) 15%,var(--cr-bg-secondary))}.cr-gen-mode-option--active i{color:var(--cr-accent)}.cr-profile-section{padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-profile-info{margin-top:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg);border-radius:var(--cr-radius-sm)}.cr-profile-info--empty{display:flex;align-items:center;gap:var(--cr-space-2);color:var(--cr-text-dim);font-size:var(--cr-text-sm);font-style:italic}.cr-profile-info--error{border:1px solid var(--cr-danger)}.cr-profile-info__row{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-1) 0;font-size:var(--cr-text-xs)}.cr-profile-info__row:not(:last-child){border-bottom:1px solid var(--cr-border-muted)}.cr-profile-info__label{color:var(--cr-text-muted)}.cr-profile-info__value{font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-profile-info__error{display:flex;align-items:center;gap:var(--cr-space-2);margin-top:var(--cr-space-2);padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,transparent);border-radius:var(--cr-radius-sm)}.cr-profile-empty{display:flex;gap:var(--cr-space-2);padding:var(--cr-space-3);color:var(--cr-text-muted);font-size:var(--cr-text-sm)}.cr-profile-empty i{color:var(--cr-accent);flex-shrink:0;margin-top:var(--cr-space-1)}.cr-profile-empty strong{display:block;margin-bottom:var(--cr-space-1);color:var(--cr-text)}.cr-profile-empty p{margin:0;font-size:var(--cr-text-xs);line-height:1.4}.cr-setting-item{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-setting-label{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text);cursor:pointer}.cr-setting-label input[type=checkbox]{width:auto;accent-color:var(--cr-accent);cursor:pointer}.cr-setting-hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-setting-desc{margin:0 0 var(--cr-space-2) 0;font-size:var(--cr-text-sm);color:var(--cr-text-muted);line-height:1.5}.cr-number-input{width:120px!important;padding:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-version{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-presets-tab--active{color:var(--cr-text);background:var(--cr-bg);box-shadow:var(--cr-shadow-sm)}.cr-shortcuts-list{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-shortcuts-list .cr-shortcut{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-shortcuts-list .cr-shortcut kbd{display:inline-flex;align-items:center;padding:.2em .5em;font-family:var(--cr-font);font-size:var(--cr-text-xs);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm)}.cr-shortcuts-list .cr-shortcut span{color:var(--cr-text-muted)}.cr-warning-banner{display:flex;align-items:flex-start;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);margin-bottom:var(--cr-space-2);font-size:var(--cr-text-xs);line-height:1.4;color:var(--cr-warning);background:color-mix(in srgb,var(--cr-warning) 10%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-warning) 30%,transparent);border-radius:var(--cr-radius-sm)}.cr-warning-banner i{flex-shrink:0;margin-top:.1em}.cr-danger-zone{flex-direction:column;padding:var(--cr-space-3);background:color-mix(in srgb,var(--cr-danger) 5%,var(--cr-bg-secondary));border:1px solid color-mix(in srgb,var(--cr-danger) 30%,transparent);border-radius:var(--cr-radius);text-align:left}.cr-danger-zone,.cr-danger-zone__warning{display:flex;align-items:flex-start;gap:var(--cr-space-3)}.cr-danger-zone__warning{color:var(--cr-danger);font-size:var(--cr-text-sm)}.cr-danger-zone__warning i{flex-shrink:0;font-size:1.25em;margin-top:.1em}.cr-danger-zone__warning strong{display:block;margin-bottom:var(--cr-space-1)}.cr-danger-zone__warning p{margin:0;opacity:.85}.cr-panel-content{display:flex;flex-direction:column;gap:.75rem}.cr-panel-desc{margin:0;font-size:.8125rem;color:var(--SmartThemeEmColor,#999);line-height:1.4}.cr-panel-launch{display:flex;align-items:center;justify-content:center;gap:.5rem;width:100%;padding:.625rem 1rem;font-size:.875rem;font-weight:500}.cr-panel-footer{display:flex;align-items:center;justify-content:space-between;padding-top:.5rem;border-top:1px solid var(--SmartThemeBorderColor,#333)}.cr-panel-checkbox{display:flex;align-items:center;gap:.375rem;font-size:.75rem;color:var(--SmartThemeEmColor,#999);cursor:pointer}.cr-panel-checkbox input[type=checkbox]{margin:0;cursor:pointer}.cr-panel-version{font-size:.6875rem;color:var(--SmartThemeEmColor,#666)}.cr-apply-dialog{display:flex;flex-direction:column;gap:var(--cr-space-3);height:80vh;min-height:400px;width:100%;max-width:100%;padding:var(--cr-space-3);box-sizing:border-box;overflow:hidden}.cr-apply-dialog--split{width:min(1100px,calc(100vw - 60px))}.cr-apply-split{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:var(--cr-space-3);flex:1;min-height:0;min-width:0;width:100%;max-width:100%;overflow:hidden;box-sizing:border-box}@media (max-width:768px){.cr-apply-split{grid-template-columns:1fr;grid-template-rows:minmax(150px,1fr) minmax(250px,1.5fr);gap:var(--cr-space-2)}}.cr-apply-panel{display:flex;flex-direction:column;height:100%;min-height:0;min-width:0;width:100%;max-width:100%;overflow:hidden;box-sizing:border-box;border:1px solid var(--cr-border);border-radius:var(--cr-radius);background:var(--cr-bg-secondary)}.cr-apply-panel__header{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);font-weight:600;font-size:var(--cr-text-sm);color:var(--cr-text);flex-shrink:0}.cr-apply-panel__header i{color:var(--cr-accent)}.cr-apply-panel--source .cr-apply-source{flex:1;min-height:0;width:100%;max-width:100%;box-sizing:border-box;padding:var(--cr-space-3);margin:0;font-family:var(--cr-font-mono);font-size:var(--cr-text-sm);line-height:1.5;resize:none;border:none;background:var(--cr-bg);color:var(--cr-text);overflow:auto;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap}.cr-apply-panel--source .cr-apply-source:focus{outline:none}.cr-apply-panel--fields .cr-apply-fields-list{flex:1;min-height:0;min-width:0;overflow:hidden auto;padding:var(--cr-space-2);gap:var(--cr-space-2)}.cr-apply-field,.cr-apply-panel--fields .cr-apply-fields-list{width:100%;max-width:100%;display:flex;flex-direction:column;box-sizing:border-box}.cr-apply-field{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm);overflow:hidden;background:var(--cr-bg);transition:border-color var(--cr-transition-fast)}.cr-apply-field:not([open]){flex-shrink:0}.cr-apply-field__header{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);cursor:pointer;-webkit-user-select:none;-moz-user-select:none;user-select:none;list-style:none;width:100%;box-sizing:border-box}.cr-apply-field__header::-webkit-details-marker{display:none}.cr-apply-field__header:before{content:"\\f054";font-family:Font Awesome\\ 6 Free;font-weight:900;font-size:var(--cr-text-xs);color:var(--cr-text-muted);transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-apply-field__header:hover{background:var(--cr-bg-tertiary)}.cr-apply-field__label{flex:1;font-weight:500;font-size:var(--cr-text-sm);color:var(--cr-text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-apply-field__badge{font-size:var(--cr-text-xs);padding:var(--cr-space-1) var(--cr-space-2);border-radius:var(--cr-radius-sm);white-space:nowrap;flex-shrink:0}.cr-apply-field__badge--filled{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-apply-field__badge--empty{background:var(--cr-bg-tertiary);color:var(--cr-text-muted)}.cr-apply-field__dirty{font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-warning);padding:var(--cr-space-1) var(--cr-space-2);background:color-mix(in srgb,var(--cr-warning) 15%,transparent);border-radius:var(--cr-radius-sm);flex-shrink:0}.cr-apply-field__content{display:flex;flex-direction:column;padding:var(--cr-space-2);border-top:1px solid var(--cr-border-muted);flex:1;min-height:0;overflow:hidden auto;box-sizing:border-box}.cr-apply-field[open]{flex:1;min-height:150px}.cr-apply-field[open] .cr-apply-field__header:before{transform:rotate(90deg)}.cr-apply-field--dirty{border-color:var(--cr-warning);box-shadow:0 0 0 1px color-mix(in srgb,var(--cr-warning) 20%,transparent)}.cr-apply-field--dirty .cr-apply-field__header{background:color-mix(in srgb,var(--cr-warning) 8%,var(--cr-bg-secondary))}.cr-apply-textarea{width:100%;max-width:100%;min-height:100px;flex:1;box-sizing:border-box;padding:var(--cr-space-2);font-family:var(--cr-font);font-size:var(--cr-text-sm);line-height:1.5;border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);resize:vertical;overflow:hidden auto;word-wrap:break-word;overflow-wrap:break-word;white-space:pre-wrap;transition:border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast)}.cr-apply-textarea:focus{border-color:var(--cr-accent);box-shadow:0 0 0 2px color-mix(in srgb,var(--cr-accent) 20%,transparent);outline:none}.cr-apply-textarea::-moz-placeholder{color:var(--cr-text-muted);font-style:italic}.cr-apply-textarea::placeholder{color:var(--cr-text-muted);font-style:italic}.cr-apply-greetings{gap:var(--cr-space-2);box-sizing:border-box}.cr-apply-greetings,.cr-apply-greetings__item{display:flex;flex-direction:column;width:100%;max-width:100%}.cr-apply-greetings__item{gap:var(--cr-space-1)}.cr-apply-greetings__label{font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-text-muted);text-transform:uppercase;letter-spacing:.5px}.cr-apply-greetings__add{align-self:flex-start;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-accent);background:transparent;border:1px dashed var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-apply-greetings__add:hover{background:var(--cr-accent-muted);border-style:solid}.cr-apply-footer{padding:var(--cr-space-3);padding-top:var(--cr-space-2);margin:0 calc(-1 * var(--cr-space-3)) calc(-1 * var(--cr-space-3));background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted);flex-shrink:0}@media (max-width:768px){.cr-popup .menu_button{min-height:44px;padding:var(--cr-space-3)}.cr-list-item{padding:var(--cr-space-4)}.cr-list-item__actions{opacity:1}.cr-popup input[type=number],.cr-popup input[type=search],.cr-popup input[type=text],.cr-popup select{min-height:44px;font-size:16px}.cr-select{min-height:44px;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm)}.cr-checkbox{min-height:44px;padding:var(--cr-space-2) 0}.cr-checkbox input[type=checkbox]{width:20px;height:20px}.cr-drawer__tab{min-height:48px}.cr-preset-list__actions{opacity:1}}@media (prefers-reduced-motion:reduce){.cr-popup *,.cr-popup :after,.cr-popup :before{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}@media (prefers-contrast:high){.cr-popup{--cr-border:var(--cr-text);--cr-border-muted:var(--cr-text-muted)}}:is(.cr-popup,.cr-drawer) a:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) button:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) input:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) select:focus:not(:focus-visible),:is(.cr-popup,.cr-drawer) textarea:focus:not(:focus-visible){outline:none}:is(.cr-popup,.cr-drawer) a:focus-visible,:is(.cr-popup,.cr-drawer) button:focus-visible,:is(.cr-popup,.cr-drawer) input:focus-visible,:is(.cr-popup,.cr-drawer) select:focus-visible,:is(.cr-popup,.cr-drawer) textarea:focus-visible{outline:2px solid var(--cr-accent);outline-offset:2px}:is(.cr-popup,.cr-drawer) input:focus-visible,:is(.cr-popup,.cr-drawer) select:focus-visible,:is(.cr-popup,.cr-drawer) textarea:focus-visible{outline-offset:0;box-shadow:0 0 0 2px var(--cr-accent-muted)}`,""]);const p=d},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(r){!function(e,t,r){var n="";r.supports&&(n+="@supports (".concat(r.supports,") {")),r.media&&(n+="@media ".concat(r.media," {"));var i=void 0!==r.layer;i&&(n+="@layer".concat(r.layer.length>0?" ".concat(r.layer):""," {")),n+=r.css,i&&(n+="}"),r.media&&(n+="}"),r.supports&&(n+="}");var a=r.sourceMap;a&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,r)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},960(e,t,r){t.encode=r(524),t.decode=r(628)}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={id:n,exports:{}};return e[n](a,a.exports,r),a.exports}r.m=e,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.b=new URL("./",import.meta.url),r.nc=void 0;var n=r(72),i=r.n(n),a=r(825),s=r.n(a),o=r(659),c=r.n(o),l=r(56),d=r.n(l),u=r(540),p=r.n(u),f=r(113),m=r.n(f),g=r(805),h={};h.styleTagTransform=m(),h.setAttributes=d(),h.insert=c().bind(null,"head"),h.domAPI=s(),h.insertStyleElement=p();i()(g.A,h);g.A&&g.A.locals&&g.A.locals;var v=r(752),y=r(737);const b={character:["character"],session:["activeSessionId","sessions","sessionsLoaded","hasUnsavedChanges"],pipeline:["stageStatus","activeStage","isGenerating","abortController"],results:["stageResults","iterationHistory","iterationCount"],config:["stageConfigs"],fields:["stageFields","selectedFields"],search:["searchQuery","searchResults","searchSelectedIndex","dropdownOpen"],ui:["sessionListExpanded","historyExpanded","viewingHistoryIndex"],guidance:["userGuidance"]};var _=r(691);const w=new class{constructor(){this.state=null,this.listeners=new Set,this.batchDepth=0,this.pendingSlices=new Set,this.notificationScheduled=!1}getState(){if(!this.state)throw new Error("[Store] Not initialized. Call init() before accessing state.");return this.state}getStateOrNull(){return this.state}setState(e,t){if(!this.state)return void v.Rm.warn("[Store] setState called before init, ignoring");const r="function"==typeof t?t(this.state):t;this.state=Object.assign(Object.assign({},this.state),r),this.pendingSlices.add(e),0===this.batchDepth&&this.scheduleNotification()}batch(e){this.batchDepth++;try{e()}finally{this.batchDepth--,0===this.batchDepth&&this.pendingSlices.size>0&&this.scheduleNotification()}}subscribe(e,t){const r={slices:e,callback:t};return this.listeners.add(r),()=>{this.listeners.delete(r)}}init(){this.state={character:null,selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}},activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},stageResults:{score:null,rewrite:null,analyze:null},stageConfigs:{score:(0,_.hu)("score"),rewrite:(0,_.hu)("rewrite"),analyze:(0,_.hu)("analyze")},activeStage:"score",iterationCount:0,iterationHistory:[],userGuidance:"",isGenerating:!1,abortController:null,searchQuery:"",searchResults:[],searchSelectedIndex:-1,dropdownOpen:!1,sessionListExpanded:!1,historyExpanded:!1,viewingHistoryIndex:null},this.pendingSlices.clear(),this.notificationScheduled=!1,v.Rm.debug("[Store] Initialized")}reset(){var e;(null===(e=this.state)||void 0===e?void 0:e.abortController)&&this.state.abortController.abort(),this.notifyAll(),this.state=null,this.pendingSlices.clear(),this.notificationScheduled=!1,v.Rm.debug("[Store] Reset")}scheduleNotification(){this.notificationScheduled||(this.notificationScheduled=!0,queueMicrotask(()=>this.flushNotifications()))}flushNotifications(){if(this.notificationScheduled=!1,0===this.pendingSlices.size)return;const e=Array.from(this.pendingSlices);this.pendingSlices.clear(),v.Rm.debug("[Store] Notifying for slices:",e);for(const t of this.listeners){if(t.slices.some(t=>e.includes(t)))try{t.callback()}catch(e){v.Rm.error("[Store] Listener callback failed:",e)}}}notifyAll(){const e=Object.keys(b);for(const t of e)this.pendingSlices.add(t);this.flushNotifications()}},x=()=>w.getState(),$=()=>w.getStateOrNull(),k=(e,t)=>w.setState(e,t),S=e=>w.batch(e);var P=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function R(e,t){const r=e;let n=A(r,t);if(void 0===n&&t.startsWith("data.")){const e=t.replace(/^data\./,"").replace(/^extensions\./,"");n=A(r,e),void 0===n&&e in r&&(n=r[e])}if(void 0===n&&t.startsWith("data.extensions.")){n=A(r,`extensions.${t.replace("data.extensions.","")}`)}return n}function A(e,t){return t.split(".").reduce((e,t)=>{if(e&&"object"==typeof e)return e[t]},e)}function C(e,t){if(null==e)return!1;switch(t){case"array":return Array.isArray(e)&&e.length>0;case"object":return"object"==typeof e&&("prompt"in e?"string"==typeof e.prompt&&e.prompt.trim().length>0:"entries"in e?Array.isArray(e.entries)&&e.entries.length>0:Object.keys(e).length>0);default:return"string"==typeof e&&e.trim().length>0}}function E(e,t){switch(t.type){case"array":return Array.isArray(e)?e.map((e,t)=>`${t+1}. ${String(e).trim()}`).join("\n"):"";case"object":return function(e,t){var r,n,i,a,s,o,c,l;if(!e||"object"!=typeof e)return"";if("depth_prompt"===t){const t=e;return(null===(r=t.prompt)||void 0===r?void 0:r.trim())?`[Depth: ${null!==(n=t.depth)&&void 0!==n?n:0}, Role: ${null!==(i=t.role)&&void 0!==i?i:"system"}]\n${t.prompt.trim()}`:""}if("character_book"===t){const t=e;if(!(null===(a=t.entries)||void 0===a?void 0:a.length))return"";const r=[];t.name?r.push(`## Lorebook: ${t.name}`):r.push("## Character Lorebook"),t.description&&r.push(t.description),r.push(`Total Entries: ${t.entries.length}`),r.push("");for(const e of t.entries){const t=e.name||e.comment||`Entry ${null!==(s=e.id)&&void 0!==s?s:"?"}`,n=!1!==e.enabled?"Active":"Inactive";r.push(`### ${t}`),void 0!==e.id&&r.push(`ID: ${e.id}`),r.push(`Status: ${n}`),(null===(o=e.keys)||void 0===o?void 0:o.length)&&r.push(`Keys: ${e.keys.join(", ")}`),(null===(c=e.secondary_keys)||void 0===c?void 0:c.length)&&r.push(`Secondary Keys: ${e.secondary_keys.join(", ")}`),r.push(""),r.push("Content:"),r.push((null===(l=e.content)||void 0===l?void 0:l.trim())||"(empty)"),r.push("")}return r.join("\n")}try{return JSON.stringify(e,null,2)}catch(e){return"[Complex Object]"}}(e,t.key);default:return"string"==typeof e?e.trim():String(e)}}function I(e){if(!e)return[];const t=[];for(const r of v.IF){const n=R(e,r.path);if(!C(n,r.type))continue;const i=E(n,r);i&&t.push({key:r.key,label:r.label,value:i,rawValue:n,charCount:i.length,type:r.type})}return t}function O(e,t=["user","persona","original","input"]){if(!e)return e;let r=e;for(const e of t){const t=new RegExp(`\\{\\{(${e})\\}\\}`,"gi");r=r.replace(t,"{{$1}}")}return r}function z(e,t,r){var n,i,a,s;const o=[];e?o.push(`## Lorebook: ${e}`):o.push("## Character Lorebook"),t&&o.push(t),o.push(`Selected Entries: ${r.length}`),o.push("");for(const e of r){const t=e.name||e.comment||`Entry ${null!==(n=e.id)&&void 0!==n?n:"?"}`,r=!1!==e.enabled?"Active":"Inactive";o.push(`### ${t}`),void 0!==e.id&&o.push(`ID: ${e.id}`),o.push(`Status: ${r}`),(null===(i=e.keys)||void 0===i?void 0:i.length)&&o.push(`Keys: ${e.keys.join(", ")}`),(null===(a=e.secondary_keys)||void 0===a?void 0:a.length)&&o.push(`Secondary Keys: ${e.secondary_keys.join(", ")}`),o.push(""),o.push("Content:"),o.push((null===(s=e.content)||void 0===s?void 0:s.trim())||"(empty)"),o.push("")}return o.join("\n")}function T(e,t){const r=(0,_.mt)(),n=I(e),i=[];for(const e of n){const r=t[e.key];if(r){if("alternate_greetings"===e.key&&Array.isArray(r)){const t=e.rawValue,n=r.filter(e=>e>=0&&e<t.length).map(e=>`**Greeting ${e+1}:**\n${t[e].trim()}`).join("\n\n");n&&i.push(`### ${e.label}\n\n${n}`);continue}if("character_book"===e.key&&Array.isArray(r)){const t=e.rawValue,n=t.entries||[],a=r.filter(e=>e>=0&&e<n.length).map(e=>n[e]);if(a.length>0){const r=z(t.name,t.description,a);i.push(`### ${e.label}\n\n${r}`)}continue}i.push(`### ${e.label}\n\n${e.value}`)}}const a=i.length>0?i.join("\n\n"):"(No fields selected)";let s=`# CHARACTER: ${e.name}\n\n${a}`;var o,c;return o=s,c=e.name,s=o&&c?o.replace(/\{\{char\}\}/gi,c):o,r.replaceUserMacro?(s=function(e,t){if(!e)return e;const r=t||SillyTavern.getContext().name1||"User";return e.replace(/\{\{user\}\}/gi,r)}(s),s=O(s,["persona","original","input"])):s=O(s),s}function W(e,t){const r=I(e),n={};for(const e of r)t[e.key]&&(n[e.key]=e.value);return n}var j=r(179),L=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function N(e,t){return L(this,arguments,void 0,function*(e,t,r={}){var n,i,a,s,o;const{signal:c,onProgress:l}=r,d=Date.now(),u=function(e,t){var r;const n=[];let i=`# TASK: ${{score:"Score & Evaluate",rewrite:"Rewrite & Improve",analyze:"Analyze Changes"}[e.stage]}`;e.iterationCount>0&&(i+=` (Refinement #${e.iterationCount+1})`),n.push(i);const a=function(e,t){if(e.customPrompt.trim())return e.customPrompt.trim();if(e.promptPresetId){const r=t.getPromptPreset(e.promptPresetId);if(r)return r.prompt}return""}(e.config,t);return a&&n.push(`## Instructions\n\n${a}`),"analyze"===e.stage?(n.push("## Original Character\n\n"+T(e.character,e.selection)),e.previousResults.rewrite&&n.push("## Rewritten Version\n\n"+e.previousResults.rewrite.output)):n.push("## Character Data\n\n"+T(e.character,e.selection)),"rewrite"===e.stage&&e.previousResults.score&&n.push("## Score Results\n\n"+e.previousResults.score.output),"rewrite"===e.stage&&e.isRefinement&&e.previousResults.analyze&&n.push("## Analysis Feedback\n\n"+e.previousResults.analyze.output),"analyze"===e.stage&&e.previousResults.score&&n.push("## Score Results (Context)\n\n"+e.previousResults.score.output),(null===(r=e.guidance)||void 0===r?void 0:r.trim())&&n.push("## User Guidance\n\n"+e.guidance.trim()),n.join("\n\n---\n\n")}(e,t),p=function(e,t,r){return t?r.getRefinementPrompt():r.getSystemPrompt(e)}(e.stage,null!==(n=e.isRefinement)&&void 0!==n&&n,t),f=function(e,t){if(!e.useStructuredOutput)return null;if(e.customSchema.trim())try{return JSON.parse(e.customSchema)}catch(e){return null}if(e.schemaPresetId){const r=t.getSchemaPreset(e.schemaPresetId);if(r)return r.schema}return null}(e.config,t);if(null==l||l(`Running ${e.stage}...`),null==c?void 0:c.aborted)return{stage:e.stage,timestamp:d,input:u,output:"",guidance:e.guidance,error:"Aborted"};const m=null!==(i=(0,_.mt)().maxTokensOverride)&&void 0!==i?i:void 0,g=yield(0,j.generate)({prompt:u,systemPrompt:p,jsonSchema:null!==(a=f)&&void 0!==a?a:void 0,signal:c,responseLength:m});return g.success?{stage:e.stage,timestamp:d,input:u,output:null!==(o=g.response)&&void 0!==o?o:"",guidance:e.guidance}:(v.Rm.error(`Stage ${e.stage} failed`,g.error),{stage:e.stage,timestamp:d,input:u,output:"",guidance:e.guidance,error:null!==(s=g.error)&&void 0!==s?s:"Generation failed"})})}var D=r(265);function B(e){var t;const r=[],n=[];if((null===(t=e.name)||void 0===t?void 0:t.trim())?e.name.length>100&&r.push("Name must be 100 characters or less"):r.push("Name is required"),e.schema){const t="string"==typeof e.schema?e.schema:JSON.stringify(e.schema),i=(0,D.i6)(t);i.valid||r.push(i.error||"Invalid schema"),i.warnings&&n.push(...i.warnings)}else r.push("Schema is required");return{valid:0===r.length,errors:r,warnings:n}}var M=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};var F=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function U(e,t,r){return F(this,void 0,void 0,function*(){var e;if(yield r(),S(()=>{k("character",{character:t}),k("fields",{selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}}}),k("session",{activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1}),k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}}),k("results",{stageResults:{score:null,rewrite:null,analyze:null},iterationCount:0,iterationHistory:[]})}),t){let r=t;try{r=yield function(e){return P(this,void 0,void 0,function*(){const t=SillyTavern.getContext(),r=t.characters||[],n=r.findIndex(t=>t.avatar===e.avatar);if(-1===n)return v.Rm.debug("Character not found in ST array, using provided data"),e;const i=r[n];return i.shallow&&"function"==typeof t.unshallowCharacter?(v.Rm.debug(`Unshallowing character: ${e.name}`),yield t.unshallowCharacter(n),r[n]):i})}(t),v.Rm.debug(`Character loaded: ${r.name}`)}catch(e){v.Rm.error("Failed to unshallow character",e)}const n=I(r),i={};for(const t of n)if("alternate_greetings"===t.key&&Array.isArray(t.rawValue)){const e=t.rawValue.length;i[t.key]=Array.from({length:e},(e,t)=>t)}else if("character_book"===t.key&&t.rawValue){const r=(null===(e=t.rawValue.entries)||void 0===e?void 0:e.length)||0;i[t.key]=Array.from({length:r},(e,t)=>t)}else i[t.key]=!0;const a=yield(0,y.getSessionsForCharacter)(r.avatar);S(()=>{k("character",{character:r}),k("fields",{stageFields:{base:i,linked:!0,overrides:{}},selectedFields:i}),k("session",{sessions:a,sessionsLoaded:!0})}),v.Rm.debug(`Character ${r.name}: ${a.length} sessions, ${n.length} fields selected`)}})}var H=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const G=function(e,t){const r=SillyTavern.libs.lodash;let n=null;const i=()=>M(this,void 0,void 0,function*(){n&&(yield n);const i=e();if(!(null==i?void 0:i.character))return;if(i._isLoading)return;let a;if(i.activeSessionId){if(a=yield(0,y.getSession)(i.activeSessionId),!a)return}else{const e=W(i.character,i.stageFields.base);a=yield(0,y.createSession)({characterId:i.character.avatar,characterName:i.character.name,stageFields:i.stageFields,originalData:e,configs:i.stageConfigs}),k("session",{sessions:[a,...i.sessions],activeSessionId:a.id}),v.Rm.debug(`Lazy-created session on auto-save: ${a.id}`)}a.stageFields=r.cloneDeep(i.stageFields),a.configs=r.cloneDeep(i.stageConfigs),a.stageResults=r.cloneDeep(i.stageResults),a.history=r.cloneDeep(i.iterationHistory),a.iterationCount=i.iterationCount,a.userGuidance=i.userGuidance||void 0,yield(0,y.updateSession)(a),t(!1)}),a=()=>M(this,void 0,void 0,function*(){const e=i();n=e;try{yield e}finally{n===e&&(n=null)}}),s=r.debounce(()=>{a()},1e3);return{trigger:s,save:a,cancel:()=>s.cancel(),flush:()=>M(this,void 0,void 0,function*(){s.cancel(),n&&(yield n),yield a()})}}(()=>$(),e=>{$()&&k("session",{hasUnsavedChanges:e})});function q(){return w.init(),x()}function J(){return x()}function V(){G.cancel(),w.reset()}function Y(){$()&&(k("session",{hasUnsavedChanges:!0}),G.trigger())}function K(){return H(this,void 0,void 0,function*(){yield G.flush()})}function Q(){return H(this,void 0,void 0,function*(){return function(e,t){return F(this,void 0,void 0,function*(){if(!e.character)return null;yield t();const r=W(e.character,e.stageFields.base),n=yield(0,y.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:r,configs:e.stageConfigs});return S(()=>{k("session",{sessions:[n,...e.sessions],activeSessionId:n.id,hasUnsavedChanges:!1}),k("results",{iterationCount:0,iterationHistory:[],stageResults:{score:null,rewrite:null,analyze:null}}),k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}})}),n})}(J(),K)})}function X(e){return H(this,void 0,void 0,function*(){return function(e,t,r){return F(this,void 0,void 0,function*(){var n;yield r();const i=yield(0,y.getSession)(t);if(!i)return!1;let a=e.character;if((null===(n=e.character)||void 0===n?void 0:n.avatar)!==i.characterId){const e=SillyTavern.getContext().characters.find(e=>e.avatar===i.characterId);if(!e)return!1;a=e}const s=SillyTavern.libs.lodash;let o={score:null,rewrite:null,analyze:null};if(i.stageResults)o=s.cloneDeep(i.stageResults);else for(const e of i.history)o[e.stage]=e;const c={};for(const e of v.an){const t=o[e];c[e]=t?t.error?"error":"complete":"pending"}return S(()=>{k("character",{character:a}),k("session",{activeSessionId:i.id,hasUnsavedChanges:!1}),k("fields",{stageFields:s.cloneDeep(i.stageFields),selectedFields:s.cloneDeep(i.stageFields.base)}),k("config",{stageConfigs:s.cloneDeep(i.configs)}),k("results",{iterationHistory:s.cloneDeep(i.history),iterationCount:i.iterationCount,stageResults:o}),k("pipeline",{stageStatus:c}),k("guidance",{userGuidance:i.userGuidance||""})}),!0})}(J(),e,K)})}function Z(e){return H(this,void 0,void 0,function*(){return function(e,t){return F(this,void 0,void 0,function*(){if(!(yield(0,y.deleteSession)(t)))return v.Rm.error("Failed to delete session:",t),!1;const r=e.sessions.filter(e=>e.id!==t);return e.activeSessionId===t?S(()=>{k("session",{sessions:r,activeSessionId:null}),k("results",{iterationHistory:[],iterationCount:0,stageResults:{score:null,rewrite:null,analyze:null}}),k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}})}):k("session",{sessions:r}),!0})}(J(),e)})}function ee(){return H(this,void 0,void 0,function*(){return function(e){return F(this,void 0,void 0,function*(){if(!e.character)return{success:!1,count:0};const t=yield(0,y.deleteAllSessionsForCharacter)(e.character.avatar);return t.success?(S(()=>{k("session",{sessions:[],activeSessionId:null}),k("results",{iterationHistory:[],iterationCount:0,stageResults:{score:null,rewrite:null,analyze:null}}),k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}})}),t):(v.Rm.error("Failed to delete all sessions"),t)})}(J())})}function te(){return H(this,void 0,void 0,function*(){return null!==(yield function(e){return F(this,void 0,void 0,function*(){if(e.activeSessionId){const t=e.sessions.find(t=>t.id===e.activeSessionId);if(t)return t}if(!e.character)return null;const t=W(e.character,e.stageFields.base),r=yield(0,y.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:t,configs:e.stageConfigs});return k("session",{sessions:[r,...e.sessions],activeSessionId:r.id}),v.Rm.debug(`Lazy-created new session: ${r.id}`),r})}(J()))})}function re(e,t){return H(this,void 0,void 0,function*(){const n=J(),i=n.sessions.findIndex(t=>t.id===e);if(-1===i)return;const a=Object.assign(Object.assign({},n.sessions[i]),{name:t.trim()||void 0,updatedAt:Date.now()}),s=[...n.sessions];s[i]=a,k("session",{sessions:s});const{updateSession:o}=yield Promise.resolve().then(r.bind(r,737));yield o(a)})}function ne(e){var t;const r=J(),n=null!=e?e:r.activeStage;return r.stageFields.linked?r.stageFields.base:null!==(t=r.stageFields.overrides[n])&&void 0!==t?t:r.stageFields.base}function ie(){return ne()}function ae(){return J().stageFields.linked}function se(e,t){var r,n,i,a;const s=J(),{lodash:o}=SillyTavern.libs,c=o.cloneDeep(s.stageFields),l=c.linked?c.base:null!==(r=(i=c.overrides)[a=s.activeStage])&&void 0!==r?r:i[a]={};if(!1===t||Array.isArray(t)&&0===t.length)delete l[e];else if("alternate_greetings"===e&&Array.isArray(t)&&s.character){const r=(null===(n=s.character.data)||void 0===n?void 0:n.alternate_greetings)||[],i=t.filter(e=>e>=0&&e<r.length);0===i.length?delete l[e]:l[e]=i}else l[e]=t;k("fields",{stageFields:c,selectedFields:Object.assign({},l)}),Y()}function oe(e){k("pipeline",{activeStage:e})}function ce(e,t){const r=J(),n=Object.assign(Object.assign({},r.stageConfigs),{[e]:Object.assign(Object.assign({},r.stageConfigs[e]),t)});k("config",{stageConfigs:n}),Y(),(0,y.setStageDefaults)(e,n[e])}function le(e){const t=J();null!==e&&(e<0||e>=t.iterationHistory.length)||k("ui",{viewingHistoryIndex:e})}function de(e){const t=J(),r=null!=e?e:t.viewingHistoryIndex;if(null===r||r<0||r>=t.iterationHistory.length)return;const n=t.iterationHistory[r];S(()=>{k("results",{stageResults:Object.assign(Object.assign({},t.stageResults),{[n.stage]:n})}),k("pipeline",{stageStatus:Object.assign(Object.assign({},t.stageStatus),{[n.stage]:n.error?"error":"complete"})}),k("ui",{viewingHistoryIndex:null})}),Y()}function ue(){var e;const t=J();return null===t.viewingHistoryIndex?null:null!==(e=t.iterationHistory[t.viewingHistoryIndex])&&void 0!==e?e:null}var pe=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const fe={getPromptPreset:y.getPromptPreset,getSchemaPreset:y.getSchemaPreset,getSystemPrompt:y.getSystemPrompt,getRefinementPrompt:y.getRefinementPrompt};function me(e,t){const r=J();k("pipeline",{stageStatus:Object.assign(Object.assign({},r.stageStatus),{[e]:t})})}function ge(e,t){k("pipeline",{isGenerating:e,abortController:e?null!=t?t:new AbortController:null})}function he(e){J().abortController===e&&k("pipeline",{isGenerating:!1,abortController:null})}function ve(e){const t=J();S(()=>{k("results",{stageResults:Object.assign(Object.assign({},t.stageResults),{[e.stage]:e}),iterationHistory:[...t.iterationHistory,e]}),k("pipeline",{stageStatus:Object.assign(Object.assign({},t.stageStatus),{[e.stage]:e.error?"error":"complete"})}),k("session",{hasUnsavedChanges:!0})})}function ye(e){const t=J();return t.character?{character:t.character,selection:ne(e),stage:e,config:t.stageConfigs[e],previousResults:t.stageResults,iterationCount:t.iterationCount,guidance:t.userGuidance||void 0}:null}function be(e,t){return pe(this,void 0,void 0,function*(){var r,n,i,a;const{stage:s,callbacks:o}=t;if(!e.character)return v.Rm.warn("Cannot execute stage: no character selected"),null;if(e.isGenerating)return v.Rm.warn("Cannot execute stage: generation already in progress"),null;yield te();const c=ye(s);if(!c)return null;const l=new AbortController;ge(!0,l),me(s,"running"),null===(r=null==o?void 0:o.onStageStart)||void 0===r||r.call(o,s);try{const e=yield N(c,fe,{signal:l.signal,onProgress:e=>{var t;v.Rm.debug(`[Pipeline] ${e}`),null===(t=null==o?void 0:o.onProgress)||void 0===t||t.call(o,e)}});return ve(e),null===(n=null==o?void 0:o.onStageComplete)||void 0===n||n.call(o,s,e),e.error&&(null===(i=null==o?void 0:o.onError)||void 0===i||i.call(o,s,e.error)),e}catch(e){const t=e instanceof Error?e.message:"Unknown error";return v.Rm.error(`Stage ${s} failed:`,e),me(s,"error"),null===(a=null==o?void 0:o.onError)||void 0===a||a.call(o,s,t),null}finally{he(l)}})}function _e(e,t=document){return t.querySelector(e)}function we(e,t=document){return Array.from(t.querySelectorAll(e))}function xe(e,t,r,n){return e?(e.addEventListener(t,r,n),()=>{e.removeEventListener(t,r,n)}):()=>{}}function $e(e){return void 0===e?"...":null===e?"":e>=1e3?`${(e/1e3).toFixed(1)}k`:e.toString()}function ke(e,t){return e.length<=t?e:e.slice(0,t-1)+""}function Se(...e){return e.filter(Boolean).join(" ")}var Pe=r(709),Re=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function Ae(){var e;try{return null!==(e=(0,_.mt)().debugMode)&&void 0!==e&&e}catch(e){return!1}}function Ce(e){return e instanceof Error?e:new Error(String(e))}function Ee(e,t,r){var n;if(v.Rm.error(`[${t.name}] ${r}:`,e),null===(n=t.onError)||void 0===n||n.call(t,e),t.showToast){const r=Ae()?`${t.name}: ${e.message}`:`${t.name} failed`;v.oR.error(r)}}function Ie(e,t){return(...r)=>{var n;try{return e(...r)}catch(e){const r=Ce(e);return Ee(r,t,"Render failed"),"function"==typeof t.fallback?t.fallback(r):null!==(n=t.fallback)&&void 0!==n?n:function(e,t){const r=Ae(),n=r?t.message||"Unknown error":"Failed to render";return`\n        <div class="${Pe.$D}-error-fallback">\n            <div class="${Pe.$D}-error-fallback__icon">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n            </div>\n            <div class="${Pe.$D}-error-fallback__content">\n                <div class="${Pe.$D}-error-fallback__title">\n                    ${e}\n                </div>\n                <div class="${Pe.$D}-error-fallback__message">\n                    ${n}\n                </div>\n                ${r&&t.stack?`\n                    <details class="${Pe.$D}-error-fallback__details">\n                        <summary>Stack trace</summary>\n                        <pre>${t.stack}</pre>\n                    </details>\n                `:""}\n            </div>\n        </div>\n    `}(t.name,r)}}}function Oe(e,t){return(...r)=>{var n;try{e(...r)}catch(e){Ee(Ce(e),Object.assign(Object.assign({},t),{showToast:null!==(n=t.showToast)&&void 0!==n&&n}),"Update failed")}}}function ze(e,t){return r=>{var n;try{return e(r)}catch(e){return Ee(Ce(e),Object.assign(Object.assign({},t),{showToast:null===(n=t.showToast)||void 0===n||n}),"Event binding failed"),()=>{}}}}function Te(e,t){var r;try{return e()}catch(e){const n=Ce(e);if(v.Rm.error(`[${t.name}] Failed:`,n),null===(r=t.onError)||void 0===r||r.call(t,n),t.showToast){const e=Ae()?`${t.name}: ${n.message}`:`${t.name} failed`;v.oR.error(e)}return}}const We={character:["character"],session:["session"],stage:["pipeline"],pipeline:["pipeline"],fields:["fields"],config:["config"],results:["results"],all:["character","session","pipeline","results","config","fields","search","ui","guidance"]},je=new Map;let Le=new Set,Ne=!1;function De(e,t,r){const n=[...new Set(r.flatMap(e=>We[e]))],i=w.subscribe(n,()=>{Be(...r)});return je.set(e,{fn:t,categories:r,storeUnsubscribe:i}),()=>{var t;const r=je.get(e);null===(t=null==r?void 0:r.storeUnsubscribe)||void 0===t||t.call(r),je.delete(e)}}function Be(...e){for(const t of e)Le.add(t);Ne||(Ne=!0,queueMicrotask(Me))}function Me(){if(Ne=!1,0===Le.size)return;const e=Le;Le=new Set;const t=e.has("all");for(const r of je.values())if(t||r.categories.some(t=>e.has(t)))try{r.fn()}catch(e){v.Rm.error("UpdateCoordinator update failed:",e)}}function Fe(){Be("character","session","fields","config","results","pipeline")}function Ue(){Be("session","fields","config","results","pipeline","stage")}var He=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function Ge(){return SillyTavern.getContext().characters||[]}let qe=null;function Je(){qe=null}let Ve=!1,Ye="",Ke=-1,Qe=null;function Xe(e){Ve=e;const t=_e(`#${v.pW}_char_dropdown`);t&&t.classList.toggle("cr-dropdown--open",e);const r=_e(`#${v.pW}_char_trigger`);r&&r.setAttribute("aria-expanded",String(e)),e||(Ke=-1)}function Ze(){const e=Ye.trim();if(!e)return Ge().slice(0,30);return function(){var e;const t=Ge();if(!qe||(null===(e=qe._docs)||void 0===e?void 0:e.length)!==t.length){const e=SillyTavern.libs.Fuse;qe=new e(t,{keys:[{name:"name",weight:3},{name:"description",weight:1}],threshold:.3,includeScore:!0,minMatchCharLength:2,ignoreLocation:!0})}return qe}().search(e).map(e=>e.item).slice(0,20)}function et(){var e;const t=J(),r=Ze(),n=null===(e=t.character)||void 0===e?void 0:e.avatar;return 0===r.length?`\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid ${Ye?"fa-search":"fa-users-slash"}"></i>\n                ${Ye?`No matches for "${ke(Ye,20)}"`:"No characters available"}\n            </div>\n        `:r.map((e,t)=>function(e,t,r){var n,i;const a=SillyTavern.libs.DOMPurify,s=SillyTavern.getContext().getThumbnailUrl("avatar",e.avatar),o=I(e).length,c=ke((e.description||"").replace(/\n/g," "),60),l=(null===(n=e.data)||void 0===n?void 0:n.creator)||"",d=(null===(i=e.data)||void 0===i?void 0:i.character_version)||"",u=[];return l&&u.push(l),d&&u.push(`v${d}`),0===u.length&&u.push(`${o} ${1===o?"field":"fields"}`),`\n        <div class="cr-char-option ${r?"cr-char-option--selected":""} ${t===Ke?"cr-char-option--highlighted":""}"\n             data-avatar="${a.sanitize(e.avatar)}"\n             data-index="${t}"\n             role="option"\n             aria-selected="${r}">\n            <div class="cr-char-option__avatar-wrap">\n                <img class="cr-char-option__avatar"\n                     src="${s}"\n                     alt=""\n                     onerror="this.src='/img/ai4.png'"\n                     loading="lazy"/>\n                ${r?'<i class="fa-solid fa-check cr-char-option__check"></i>':""}\n            </div>\n            <div class="cr-char-option__info">\n                <span class="cr-char-option__name">${a.sanitize(e.name)}</span>\n                ${c?`<span class="cr-char-option__desc">${a.sanitize(c)}</span>`:""}\n                <span class="cr-char-option__meta">\n                    <i class="fa-solid fa-user-pen"></i>\n                    ${a.sanitize(u.join("  "))}\n                </span>\n            </div>\n        </div>\n    `}(e,t,e.avatar===n)).join("")}const tt=Ie(()=>{const e=SillyTavern.libs.DOMPurify,t=J().character,r=t?e.sanitize(t.name):"Select character...",n=t?`<img class="cr-dropdown__trigger-avatar"\n               src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n               alt=""\n               onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';return`\n        <div id="${v.pW}_char_dropdown" class="cr-dropdown ${Ve?"cr-dropdown--open":""}">\n            <button id="${v.pW}_char_trigger"\n                    class="cr-dropdown__trigger"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${Ve}">\n                ${n}\n                <span class="cr-dropdown__trigger-text ${t?"":"cr-dropdown__trigger-text--placeholder"}">${r}</span>\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel" role="listbox">\n                <div class="cr-dropdown__search">\n                    <i class="fa-solid fa-search cr-dropdown__search-icon"></i>\n                    <input type="text"\n                           id="${v.pW}_char_search"\n                           class="cr-dropdown__search-input"\n                           placeholder="Search characters..."\n                           autocomplete="off"\n                           value="${e.sanitize(Ye)}"/>\n                    ${Ye?'\n                        <button class="cr-dropdown__search-clear" type="button" aria-label="Clear">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    ':""}\n                </div>\n                <div id="${v.pW}_char_list" class="cr-dropdown__list cr-scrollable">\n                    ${et()}\n                </div>\n            </div>\n        </div>\n    `},{name:"CharacterSelector"});function rt(e){e.forEach((e,t)=>{e.classList.toggle("cr-char-option--highlighted",t===Ke),t===Ke&&e.scrollIntoView({block:"nearest"})})}function nt(e){return He(this,void 0,void 0,function*(){const t=e.dataset.avatar;if(!t)return;const r=Ge().find(e=>e.avatar===t);r&&(yield function(e){return H(this,void 0,void 0,function*(){yield U(J(),e,K)})}(r),Ye="",Xe(!1),Fe())})}let it=[];function at(e){it.push(e)}function st(e){const t=it.indexOf(e);-1!==t&&it.splice(t,1)}const ot=new Map;var ct=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const lt=["alternate_greetings","character_book"];function dt(){const e=_e(`#${v.pW}_field_total`);if(!e)return;const t=ie();let r=0,n=0;for(const[e,i]of ot){if(e.includes(":"))continue;e in t&&!1!==t[e]&&(r+=i,n++)}for(const e of lt){if(!(e in t))continue;const i=t[e];if(Array.isArray(i)&&0!==i.length){n++;for(const t of i){const n=`${e}:${t}`,i=ot.get(n);void 0!==i&&(r+=i)}}}e.textContent=0===n?"none":`${n} fields, ~${r.toLocaleString()}t`,function(e){const t=_e(`#${v.pW}_token_warning`);if(!t)return;const r=J(),n=t.querySelector(".cr-token-warning__text");if("rewrite"!==r.activeStage||0===e)return void t.classList.add("cr-hidden");const i=(0,y.getSettings)(),a=(0,v.Lq)(i.profileId),s=null!==i.maxTokensOverride?i.maxTokensOverride:a.maxOutput,o=e,c=Math.ceil(1.2*e);s<o?(t.classList.remove("cr-hidden"),t.classList.add("cr-token-warning--critical"),t.classList.remove("cr-token-warning--warning"),n&&(n.textContent=`Max output (${s.toLocaleString()}t) is less than character tokens (~${e.toLocaleString()}t). Rewrite will likely be truncated.`)):s<c?(t.classList.remove("cr-hidden"),t.classList.remove("cr-token-warning--critical"),t.classList.add("cr-token-warning--warning"),n&&(n.textContent=`Max output (${s.toLocaleString()}t) is close to character tokens (~${e.toLocaleString()}t). Consider increasing output limit.`)):t.classList.add("cr-hidden")}(r)}function ut(e){return ct(this,void 0,void 0,function*(){const t=_e(`#${v.pW}_prompt_tokens`);if(!t)return;const r=yield(0,v.NR)(e);t.textContent=null!==r?`~${r} tokens`:`~${Math.ceil(e.length/4)} tokens`})}const pt=Ie(()=>{const e=J();if(!e.character)return'\n            <div class="cr-empty cr-empty--compact cr-empty--inline">\n                <i class="fa-solid fa-user-slash cr-empty__icon"></i>\n                <span class="cr-empty__text">Select a character to see fields</span>\n            </div>\n        ';const t=I(e.character);return 0===t.length?'\n            <div class="cr-empty cr-empty--compact cr-empty--inline">\n                <i class="fa-solid fa-file-circle-question cr-empty__icon"></i>\n                <span class="cr-empty__text">No populated fields found</span>\n            </div>\n        ':(requestAnimationFrame(()=>{!function(e){ct(this,void 0,void 0,function*(){const t=[];for(const r of e)if("alternate_greetings"===r.key&&Array.isArray(r.rawValue)){const e=r.rawValue;for(let n=0;n<e.length;n++)t.push({key:`${r.key}:${n}`,text:e[n]})}else if("character_book"===r.key&&r.rawValue){const e=r.rawValue.entries||[];for(let n=0;n<e.length;n++){const i=e[n].content||"";t.push({key:`${r.key}:${n}`,text:i})}}else t.push({key:r.key,text:r.value});if(0===t.length)return;const r=yield(0,v.gg)(t);for(const{key:e,tokens:t}of r)if(null!==t&&ot.set(e,t),!e.includes(":")){const r=_e(`.cr-field-tokens[data-field="${e}"]`);r&&(r.textContent=$e(t))}dt()})}(t),gt()}),`\n        <div class="cr-field-list cr-scrollable">\n            ${t.map(e=>ft(e)).join("")}\n        </div>\n        <div class="cr-field-total">\n            <span class="cr-field-total__label">Selected:</span>\n            <span id="${v.pW}_field_total" class="cr-field-total__value">calculating...</span>\n        </div>\n        <div id="${v.pW}_token_warning" class="cr-token-warning cr-hidden">\n            <i class="fa-solid fa-triangle-exclamation"></i>\n            <span class="cr-token-warning__text"></span>\n        </div>\n    `)},{name:"FieldSelector"}),ft=Ie(e=>{const t=SillyTavern.libs.DOMPurify,r=ie(),n=e.key in r&&!1!==r[e.key];if("alternate_greetings"===e.key&&Array.isArray(e.rawValue)){const n=e.rawValue,i=Array.isArray(r[e.key])?r[e.key]:[],a=i.length===n.length;return`\n            <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n                <div class="cr-field-item cr-field-item--parent">\n                    <label class="cr-field-label">\n                        <input type="checkbox"\n                               class="cr-field-checkbox cr-field-checkbox--parent"\n                               data-field="${e.key}"\n                               ${a?"checked":""}/>\n                        <span class="cr-field-name">${t.sanitize(e.label)}</span>\n                    </label>\n                    <span class="cr-field-count">${n.length} greetings</span>\n                    <button class="cr-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="cr-field-children">\n                    ${n.map((t,r)=>`\n                        <div class="cr-field-item cr-field-item--child">\n                            <label class="cr-field-label">\n                                <input type="checkbox"\n                                       class="cr-field-checkbox cr-field-checkbox--child"\n                                       data-field="${e.key}"\n                                       data-index="${r}"\n                                       ${i.includes(r)?"checked":""}/>\n                                <span class="cr-field-name">Greeting ${r+1}</span>\n                            </label>\n                            <button class="cr-field-preview-btn" type="button" data-field="${e.key}" data-index="${r}" title="Preview greeting">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}if("character_book"===e.key&&e.rawValue){const n=e.rawValue,i=n.entries||[];if(0===i.length)return"";const a=Array.isArray(r[e.key])?r[e.key]:[],s=a.length===i.length,o=n.name||"Character Lorebook";return`\n            <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n                <div class="cr-field-item cr-field-item--parent">\n                    <label class="cr-field-label">\n                        <input type="checkbox"\n                               class="cr-field-checkbox cr-field-checkbox--parent"\n                               data-field="${e.key}"\n                               ${s?"checked":""}/>\n                        <span class="cr-field-name">${t.sanitize(o)}</span>\n                    </label>\n                    <span class="cr-field-count">${i.length} entries</span>\n                    <button class="cr-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="cr-field-children">\n                    ${i.map((r,n)=>{var i,s;const o=r.name||r.comment||(null===(i=r.keys)||void 0===i?void 0:i.slice(0,2).join(", "))||`Entry ${n+1}`,c=(null===(s=r.keys)||void 0===s?void 0:s.slice(0,3).join(", "))||"",l=!1!==r.enabled?"":"",d=!1!==r.enabled?"cr-entry-enabled":"cr-entry-disabled";return`\n                        <div class="cr-field-item cr-field-item--child">\n                            <label class="cr-field-label">\n                                <input type="checkbox"\n                                       class="cr-field-checkbox cr-field-checkbox--child"\n                                       data-field="${e.key}"\n                                       data-index="${n}"\n                                       ${a.includes(n)?"checked":""}/>\n                                <span class="cr-entry-status ${d}">${l}</span>\n                                <span class="cr-field-name" title="${t.sanitize(c)}">${t.sanitize(o)}</span>\n                            </label>\n                            <button class="cr-field-preview-btn" type="button" data-field="${e.key}" data-index="${n}" title="Preview entry">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `}).join("")}\n                </div>\n            </div>\n        `}return`\n        <div class="cr-field-item" data-field="${e.key}">\n            <label class="cr-field-label">\n                <input type="checkbox"\n                       class="cr-field-checkbox"\n                       data-field="${e.key}"\n                       ${n?"checked":""}/>\n                <span class="cr-field-name">${t.sanitize(e.label)}</span>\n            </label>\n            <span class="cr-field-tokens" data-field="${e.key}">${$e(e.tokens)}</span>\n            <button class="cr-field-preview-btn" type="button" data-field="${e.key}" title="Preview content">\n                <i class="fa-solid fa-eye"></i>\n            </button>\n        </div>\n    `},{name:"FieldItem"}),mt=new Set;function gt(){var e;const t=_e(`#${v.pW}_fields_container`);if(!t)return;const r=_e(".cr-field-list",t),n=null!==(e=null==r?void 0:r.scrollTop)&&void 0!==e?e:0,i=ie(),a=we(".cr-field-group",t);for(const e of a){const t=e.dataset.field;if(!t)continue;mt.has(t)&&e.classList.add("cr-field-group--expanded");const r=_e(".cr-field-checkbox--parent",e),n=we(".cr-field-checkbox--child",e);if(!r||0===n.length)continue;const a=i[t],s=Array.isArray(a)?a:[],o=n.length,c=s.filter(e=>e<o).length;n.forEach((e,t)=>{e.checked=s.includes(t)}),0===c?(r.checked=!1,r.indeterminate=!1):c===o?(r.checked=!0,r.indeterminate=!1):(r.checked=!1,r.indeterminate=!0)}const s=we(".cr-field-item:not(.cr-field-item--parent):not(.cr-field-item--child) .cr-field-checkbox",t);for(const e of s){const t=e.dataset.field;t&&(e.checked=t in i&&!1!==i[t])}dt(),r&&n>0&&(r.scrollTop=n)}const ht=Ie((e,t,r)=>{const n=SillyTavern.libs.DOMPurify,i="prompt"===e?(0,y.getPromptPresetsForStage)(t):(0,y.getSchemaPresetsForStage)(t);return`\n        <div class="cr-preset-row">\n            <span class="cr-preset-label">${"prompt"===e?"Preset:":"Schema:"}</span>\n            <select id="${`${v.pW}_${e}_select`}" class="cr-select text_pole" aria-label="${e} preset">\n                <option value="">Custom</option>\n                ${i.map(e=>`\n                    <option value="${e.id}" ${e.id===r?"selected":""}>\n                        ${n.sanitize(e.name)}${e.isBuiltin?"":" "}\n                    </option>\n                `).join("")}\n            </select>\n            <button class="cr-preset-manage-btn menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                    data-type="${e}"\n                    type="button"\n                    title="Manage ${e} presets">\n                <i class="fa-solid fa-folder-open"></i>\n            </button>\n        </div>\n    `},{name:"PresetDropdown"});function vt(e,t,r){const n=_e(`#${`${v.pW}_${e}_select`}`);if(!n)return;const i=SillyTavern.libs.DOMPurify,a=`\n        <option value="">Custom</option>\n        ${("prompt"===e?(0,y.getPromptPresetsForStage)(t):(0,y.getSchemaPresetsForStage)(t)).map(e=>`\n            <option value="${e.id}" ${e.id===r?"selected":""}>\n                ${i.sanitize(e.name)}${e.isBuiltin?"":" "}\n            </option>\n        `).join("")}\n    `;n.innerHTML=a}const yt=Ie(()=>{const e=SillyTavern.libs.DOMPurify,t=J(),r=t.activeStage,n=t.stageConfigs[r];let i=n.customPrompt;if(!i&&n.promptPresetId){const e=(0,y.getPromptPreset)(n.promptPresetId);e&&(i=e.prompt)}let a=n.customSchema;if(!a&&n.schemaPresetId){const e=(0,y.getSchemaPreset)(n.schemaPresetId);e&&(a=JSON.stringify(e.schema,null,2))}return`\n        <section class="cr-section cr-stage-config" aria-label="Stage Configuration">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">\n                    <i class="fa-solid ${v.iu[r]}"></i>\n                    ${v.BA[r]} Configuration\n                </h3>\n            </div>\n\n            \x3c!-- Field Selection --\x3e\n            <div class="cr-stack cr-stack--tight">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-list-check cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Fields to Include</span>\n                    </div>\n                    <button id="${v.pW}_link_fields"\n                            class="menu_button menu_button--icon menu_button--sm menu_button--ghost ${ae()?"cr-active":""}"\n                            type="button"\n                            title="${ae()?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)"}"\n                            aria-pressed="${ae()}">\n                        <i class="fa-solid ${ae()?"fa-link":"fa-link-slash"}"></i>\n                    </button>\n                </div>\n                <div id="${v.pW}_fields_container">\n                    ${pt()}\n                </div>\n            </div>\n\n            \x3c!-- Prompt Configuration --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-message cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Prompt</span>\n                    </div>\n                    <div class="cr-row cr-gap-1">\n                        <button id="${v.pW}_save_prompt"\n                                class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Save as preset"\n                                aria-label="Save as preset">\n                            <i class="fa-solid fa-floppy-disk"></i>\n                        </button>\n                        ${ht("prompt",r,n.promptPresetId)}\n                    </div>\n                </div>\n                <div class="cr-form-group">\n                    <textarea id="${v.pW}_prompt"\n                              placeholder="Enter instructions for this stage..."\n                              rows="6">${e.sanitize(i)}</textarea>\n                    <div class="cr-form-group__hint cr-text-right">\n                        <span id="${v.pW}_prompt_tokens">Calculating...</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Structured Output Toggle --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <label class="cr-checkbox">\n                    <input type="checkbox"\n                           id="${v.pW}_use_schema"\n                           ${n.useStructuredOutput?"checked":""}/>\n                    <span>Use Structured Output (JSON Schema)</span>\n                </label>\n\n                <div id="${v.pW}_schema_section"\n                     class="${Se(!n.useStructuredOutput&&"cr-hidden")} cr-stack cr-stack--tight cr-mt-2">\n                    <div class="cr-row cr-row--between">\n                        <div class="cr-row">\n                            <i class="fa-solid fa-code cr-text-accent"></i>\n                            <span class="cr-font-medium cr-text-sm">JSON Schema</span>\n                        </div>\n                        <div class="cr-row cr-gap-1">\n                            <button id="${v.pW}_save_schema"\n                                    class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                    type="button"\n                                    title="Save as schema preset"\n                                    aria-label="Save as schema preset">\n                                <i class="fa-solid fa-floppy-disk"></i>\n                            </button>\n                            ${ht("schema",r,n.schemaPresetId)}\n                        </div>\n                    </div>\n                    <textarea id="${v.pW}_schema"\n                              class="cr-textarea--code"\n                              placeholder='{"name": "MySchema", "strict": true, "value": {...}}'\n                              rows="8">${e.sanitize(a)}</textarea>\n                    <div class="cr-button-group">\n                        <button id="${v.pW}_generate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button"\n                                title="Generate schema from description using AI">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            Generate\n                        </button>\n                        <button id="${v.pW}_validate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-check"></i>\n                            Validate\n                        </button>\n                        <button id="${v.pW}_format_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-indent"></i>\n                            Format\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Preview --\x3e\n            <div class="cr-mt-4">\n                <button id="${v.pW}_preview"\n                        class="menu_button menu_button--full"\n                        type="button"\n                        ${t.character?"":"disabled"}>\n                    <i class="fa-solid fa-eye"></i>\n                    Preview Full Prompt\n                </button>\n            </div>\n        </section>\n    `},{name:"StageConfig"});function bt(){const e=_e(".cr-stage-config");if(!e)return;const t=J(),r=t.activeStage,n=t.stageConfigs[r],i=e.querySelector(".cr-section__title");i&&(i.innerHTML=`\n            <i class="fa-solid ${v.iu[r]}"></i>\n            ${v.BA[r]} Configuration\n        `);const a=_e(`#${v.pW}_fields_container`);a&&(a.innerHTML=pt());const s=_e(`#${v.pW}_prompt`);if(s){let e=n.customPrompt;if(!e&&n.promptPresetId){const t=(0,y.getPromptPreset)(n.promptPresetId);t&&(e=t.prompt)}s.value=e,ut(s.value)}vt("prompt",r,n.promptPresetId);const o=_e(`#${v.pW}_use_schema`);o&&(o.checked=n.useStructuredOutput);const c=_e(`#${v.pW}_schema_section`);c&&c.classList.toggle("cr-hidden",!n.useStructuredOutput),vt("schema",r,n.schemaPresetId);const l=_e(`#${v.pW}_schema`);if(l){let e=n.customSchema;if(!e&&n.schemaPresetId){const t=(0,y.getSchemaPreset)(n.schemaPresetId);t&&(e=JSON.stringify(t.schema,null,2))}l.value=e}const d=_e(`#${v.pW}_preview`);d&&(d.disabled=!t.character);const u=_e(`#${v.pW}_link_fields`);if(u){const e=ae();u.classList.toggle("cr-active",e),u.setAttribute("aria-pressed",String(e)),u.title=e?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const t=u.querySelector("i");t&&(t.className="fa-solid "+(e?"fa-link":"fa-link-slash"))}}let _t={isOpen:!1,type:"prompt",mode:"create",preset:null,activeTab:"edit"},wt={},xt=[];function $t(){xt.forEach(e=>e()),xt=[]}function kt(e){xt.push(e)}const St=Ie(()=>{const{preset:e,mode:t}=_t,r=SillyTavern.libs.DOMPurify;let n="";return e&&(n="duplicate"===t?`${e.name} (Copy)`:e.name),`\n        <div class="cr-form-group">\n            <label class="cr-label" for="${v.pW}_drawer_name">\n                Name <span class="cr-required">*</span>\n            </label>\n            <input type="text"\n                   id="${v.pW}_drawer_name"\n                   class="cr-input text_pole"\n                   value="${r.sanitize(n)}"\n                   placeholder="Enter preset name..."\n                   maxlength="100"\n                   autocomplete="off"/>\n        </div>\n    `},{name:"PresetNameField"}),Pt=Ie(()=>{const{preset:e}=_t,t=(null==e?void 0:e.stages)||[];return`\n        <div class="cr-form-group">\n            <label class="cr-label">\n                Applicable Stages\n                <span class="cr-hint cr-text-dim">(empty = all stages)</span>\n            </label>\n            <div class="cr-stage-chips">\n                ${v.an.map(e=>`\n                    <label class="cr-chip ${0===t.length||t.includes(e)?"cr-chip--active":""}">\n                        <input type="checkbox"\n                               name="drawer_stages"\n                               value="${e}"\n                               ${0===t.length||t.includes(e)?"checked":""}/>\n                        <span>${v.BA[e]}</span>\n                    </label>\n                `).join("")}\n            </div>\n        </div>\n    `},{name:"PresetStagesField"}),Rt=Ie(()=>{const{preset:e}=_t,t=SillyTavern.libs.DOMPurify,r=(null==e?void 0:e.prompt)||"";return`\n        <div class="cr-form-group cr-form-group--grow">\n            <label class="cr-label" for="${v.pW}_drawer_prompt">\n                Prompt Template <span class="cr-required">*</span>\n            </label>\n            <div class="cr-editor-wrap">\n                <textarea id="${v.pW}_drawer_prompt"\n                          class="cr-textarea cr-textarea--editor text_pole"\n                          placeholder="Enter instructions for the LLM.\n\nYour prompt will be combined with the selected character fields and any previous stage results."\n                          spellcheck="false">${t.sanitize(r)}</textarea>\n            </div>\n            <div class="cr-form-group__hint cr-row cr-row--between">\n                <span id="${v.pW}_drawer_prompt_tokens" class="cr-text-dim">Calculating tokens...</span>\n            </div>\n        </div>\n    `},{name:"PresetPromptEditor"}),At=Ie(()=>{const{preset:e}=_t,t=SillyTavern.libs.DOMPurify;let r="";return e&&"schema"in e&&(r="string"==typeof e.schema?e.schema:JSON.stringify(e.schema,null,2)),`\n        <div class="cr-form-group cr-form-group--grow">\n            <div class="cr-row cr-row--between">\n                <label class="cr-label" for="${v.pW}_drawer_schema">\n                    JSON Schema <span class="cr-required">*</span>\n                </label>\n            </div>\n\n            \x3c!-- Schema Toolbar --\x3e\n            <div class="cr-editor-toolbar">\n                <button id="${v.pW}_drawer_generate"\n                        class="menu_button menu_button--sm menu_button--primary"\n                        type="button"\n                        title="Generate schema from description using AI">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    AI Generate\n                </button>\n                <div class="cr-toolbar-divider"></div>\n                <button id="${v.pW}_drawer_validate"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Validate JSON schema">\n                    <i class="fa-solid fa-check-circle"></i>\n                    Validate\n                </button>\n                <button id="${v.pW}_drawer_format"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Format JSON">\n                    <i class="fa-solid fa-align-left"></i>\n                    Format\n                </button>\n                <button id="${v.pW}_drawer_minify"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Minify JSON">\n                    <i class="fa-solid fa-compress"></i>\n                </button>\n            </div>\n\n            \x3c!-- Schema Editor with syntax highlighting --\x3e\n            <div class="cr-code-editor" id="${v.pW}_drawer_schema_wrap">\n                <pre class="cr-code-editor__highlight" id="${v.pW}_drawer_schema_highlight" aria-hidden="true"><code class="language-json"></code></pre>\n                <textarea id="${v.pW}_drawer_schema"\n                          class="cr-code-editor__textarea cr-textarea--code text_pole"\n                          placeholder='{"name": "MySchema", "strict": true, "schema": {...}}'\n                          spellcheck="false">${t.sanitize(r)}</textarea>\n            </div>\n\n            \x3c!-- Validation messages --\x3e\n            <div id="${v.pW}_drawer_errors" class="cr-errors cr-hidden"></div>\n            <div id="${v.pW}_drawer_warnings" class="cr-warnings cr-hidden"></div>\n        </div>\n    `},{name:"PresetSchemaEditor"});var Ct=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const Et=Ie(()=>`\n        <div id="${v.pW}_preset_drawer" class="cr-drawer" aria-hidden="true">\n            <div class="cr-drawer__backdrop"></div>\n            <aside class="cr-drawer__panel" role="dialog" aria-label="Preset Editor">\n                <div class="cr-drawer__content">\n                    ${It()}\n                    ${Ot()}\n                    ${zt()}\n                </div>\n            </aside>\n        </div>\n    `,{name:"PresetDrawer"}),It=Ie(()=>{const{type:e,mode:t,preset:r}=_t;let n="",i="";return"create"===t?(n=`New ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-plus"):"edit"===t?(n=`Edit ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-pen"):(n=`Duplicate ${"prompt"===e?"Prompt":"Schema"} Preset`,i="fa-copy"),`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid ${i} cr-text-accent"></i>\n                <h3>${n}</h3>\n                ${(null==r?void 0:r.isBuiltin)?'<span class="cr-badge cr-badge--info cr-badge--small">builtin</span>':""}\n            </div>\n            <button id="${v.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n    `},{name:"PresetDrawerHeader"}),Ot=Ie(()=>{const{type:e,mode:t,preset:r}=_t;return`\n        <div class="cr-drawer__body cr-scrollable">\n            ${"duplicate"===t&&(null==r?void 0:r.isBuiltin)?'\n                <div class="cr-alert cr-alert--info cr-mb-3">\n                    <i class="fa-solid fa-circle-info cr-alert__icon"></i>\n                    <div class="cr-alert__content">\n                        <div class="cr-alert__message">\n                            Builtin presets cannot be modified. You\'re creating an editable copy.\n                        </div>\n                    </div>\n                </div>\n            ':""}\n            ${St()}\n            ${Pt()}\n            ${"prompt"===e?Rt():At()}\n        </div>\n    `},{name:"PresetDrawerBody"}),zt=Ie(()=>{const{mode:e,preset:t}=_t,r=(null==t?void 0:t.isBuiltin)||!1,n="create"===e?"Create Preset":"edit"===e?"Save Changes":"Create Copy";return`\n        <footer class="cr-drawer__footer">\n            <div class="cr-row cr-row--between cr-flex-1">\n                <div class="cr-row">\n                    ${t&&!r&&"edit"===e?`\n                        <button id="${v.pW}_drawer_delete"\n                                class="menu_button menu_button--danger"\n                                type="button">\n                            <i class="fa-solid fa-trash"></i>\n                            Delete\n                        </button>\n                    `:""}\n                </div>\n                <div class="cr-row cr-gap-2">\n                    <button id="${v.pW}_drawer_cancel"\n                            class="menu_button"\n                            type="button">\n                        Cancel\n                    </button>\n                    <button id="${v.pW}_drawer_save"\n                            class="menu_button menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-check"></i>\n                        ${n}\n                    </button>\n                </div>\n            </div>\n        </footer>\n    `},{name:"PresetDrawerFooter"});function Tt(e,t,r,n){const i=_e(`#${v.pW}_drawer_close`,e);i&&kt(xe(i,"click",t));const a=_e(".cr-drawer__backdrop",e);a&&kt(xe(a,"click",t));const s=_e(`#${v.pW}_drawer_cancel`,e);s&&kt(xe(s,"click",t));const o=_e(`#${v.pW}_drawer_save`,e);o&&kt(xe(o,"click",r));const c=_e(`#${v.pW}_drawer_delete`,e);c&&kt(xe(c,"click",n));const l=we('.cr-chip input[name="drawer_stages"]',e);for(const e of l)kt(xe(e,"change",()=>{const t=e.closest(".cr-chip");t&&t.classList.toggle("cr-chip--active",e.checked)}));"prompt"===_t.type?function(e){const t=_e(`#${v.pW}_drawer_prompt`,e);if(t){const e=SillyTavern.libs.lodash.debounce(()=>Ct(this,void 0,void 0,function*(){const e=_e(`#${v.pW}_drawer_prompt_tokens`);if(!e)return;const r=t.value,n=Math.ceil(r.length/4);e.textContent=`~${n} tokens`}),300);kt(xe(t,"input",()=>{e()})),e()}}(e):function(e){const t=_e(`#${v.pW}_drawer_schema`,e);if(t){const e=SillyTavern.libs.lodash.debounce(()=>{Wt()},100);kt(xe(t,"input",()=>{e()})),kt(xe(t,"scroll",()=>{!function(e){const t=_e(`#${v.pW}_drawer_schema_highlight`);t&&(t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft)}(t)}))}const r=_e(`#${v.pW}_drawer_generate`,e);r&&kt(xe(r,"click",()=>Ct(this,void 0,void 0,function*(){const e=yield v.lY.input("Generate Schema","Describe the structure you want:","e.g., rating 1-10, list of strengths and weaknesses, summary paragraph");if(!e)return;r.setAttribute("disabled","true");const n=r.querySelector("i"),i=null==n?void 0:n.className;n&&(n.className="fa-solid fa-spinner fa-spin");try{const r=yield(0,D.nr)(e);r.success&&r.schema&&t?(t.value=r.schema,Wt(),v.oR.success("Schema generated"),function(){const e=_e(`#${v.pW}_drawer_errors`),t=_e(`#${v.pW}_drawer_warnings`);null==e||e.classList.add("cr-hidden"),null==t||t.classList.add("cr-hidden")}()):v.oR.error(r.error||"Generation failed")}catch(e){v.oR.error(`Failed: ${e.message}`)}finally{r.removeAttribute("disabled"),n&&i&&(n.className=i)}})));const n=_e(`#${v.pW}_drawer_validate`,e);n&&t&&kt(xe(n,"click",()=>{!function(e){var t;const r=_e(`#${v.pW}_drawer_errors`),n=_e(`#${v.pW}_drawer_warnings`);r&&(e.valid?(r.classList.add("cr-hidden"),v.oR.success("Schema is valid")):(r.innerHTML=`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e.error}</div>`,r.classList.remove("cr-hidden")));n&&((null===(t=e.warnings)||void 0===t?void 0:t.length)?(n.innerHTML=e.warnings.map(e=>`<div class="cr-warning"><i class="fa-solid fa-exclamation-triangle"></i> ${e}</div>`).join(""),n.classList.remove("cr-hidden")):n.classList.add("cr-hidden"))}((0,D.i6)(t.value))}));const i=_e(`#${v.pW}_drawer_format`,e);i&&t&&kt(xe(i,"click",()=>{try{const e=JSON.parse(t.value);t.value=(0,D.jf)(e),Wt(),v.oR.success("Formatted")}catch(e){v.oR.error(`Invalid JSON: ${e.message}`)}}));const a=_e(`#${v.pW}_drawer_minify`,e);a&&t&&kt(xe(a,"click",()=>{try{const e=JSON.parse(t.value);t.value=JSON.stringify(e),Wt(),v.oR.success("Minified")}catch(e){v.oR.error(`Invalid JSON: ${e.message}`)}}))}(e);const d=e=>{"Escape"===e.key&&_t.isOpen&&(e.preventDefault(),e.stopPropagation(),t())};document.addEventListener("keydown",d),kt(()=>document.removeEventListener("keydown",d))}function Wt(){const e=_e(`#${v.pW}_drawer_schema`),t=_e(`#${v.pW}_drawer_schema_highlight code`);if(!e||!t)return;const r=SillyTavern.libs.hljs,n=SillyTavern.libs.DOMPurify;try{const i=r.highlight(e.value||" ",{language:"json"});t.innerHTML=n.sanitize(i.value)}catch(r){t.textContent=e.value}}function jt(e){const t=_e(`#${v.pW}_drawer_errors`);t&&(t.innerHTML=e.map(e=>`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e}</div>`).join(""),t.classList.remove("cr-hidden"))}var Lt=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const Nt=Ie(()=>{const{type:e}=_t;return`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid fa-bookmark cr-text-accent"></i>\n                <h3>Manage Presets</h3>\n            </div>\n            <button id="${v.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n        <div class="cr-drawer__tabs">\n            <button class="cr-drawer__tab ${"prompt"===e?"cr-drawer__tab--active":""}"\n                    data-tab="prompt" type="button">\n                <i class="fa-solid fa-message"></i>\n                Prompts\n            </button>\n            <button class="cr-drawer__tab ${"schema"===e?"cr-drawer__tab--active":""}"\n                    data-tab="schema" type="button">\n                <i class="fa-solid fa-code"></i>\n                Schemas\n            </button>\n        </div>\n    `},{name:"PresetListHeader"}),Dt=Ie(()=>{const{type:e}=_t,t=[..."prompt"===e?y.presetRegistry.getPromptPresets():y.presetRegistry.getSchemaPresets()].sort((e,t)=>e.isBuiltin!==t.isBuiltin?e.isBuiltin?1:-1:e.name.localeCompare(t.name)),r=t.filter(e=>!e.isBuiltin).length,n=t.filter(e=>e.isBuiltin).length;return`\n        <div class="cr-drawer__body cr-drawer__body--list">\n            ${0===t.length?`\n                <div class="cr-empty cr-empty--compact">\n                    <i class="fa-solid fa-bookmark cr-empty__icon"></i>\n                    <div class="cr-empty__title">No ${e} presets</div>\n                    <div class="cr-empty__text">Create one to get started</div>\n                </div>\n            `:`\n                <div class="cr-preset-list cr-scrollable">\n                    ${r>0?'<div class="cr-preset-list__section-label">Custom</div>':""}\n                    ${t.filter(e=>!e.isBuiltin).map(t=>Bt(t,e)).join("")}\n                    ${n>0?'<div class="cr-preset-list__section-label">Built-in</div>':""}\n                    ${t.filter(e=>e.isBuiltin).map(t=>Bt(t,e)).join("")}\n                </div>\n            `}\n        </div>\n    `},{name:"PresetListBody"}),Bt=Ie((e,t)=>{const r=SillyTavern.libs.DOMPurify,n=e.stages.length>0?e.stages.map(e=>v.BA[e]).join(", "):"All stages";return`\n        <div class="cr-preset-list__item ${e.isBuiltin?"cr-preset-list__item--builtin":""}"\n             data-id="${e.id}"\n             data-type="${t}">\n            <button class="cr-preset-list__select" type="button" title="Apply this preset">\n                <div class="cr-preset-list__info">\n                    <span class="cr-preset-list__name">\n                        ${e.isBuiltin?'<i class="fa-solid fa-lock cr-text-dim"></i>':""}\n                        ${r.sanitize(e.name)}\n                    </span>\n                    <span class="cr-preset-list__stages">${n}</span>\n                </div>\n            </button>\n            <div class="cr-preset-list__actions">\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Edit">\n                        <i class="fa-solid fa-pen"></i>\n                    </button>\n                '}\n                <button class="cr-preset-list__action cr-preset-list__action--duplicate menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        type="button" title="${e.isBuiltin?"Create editable copy":"Duplicate"}">\n                    <i class="fa-solid fa-copy"></i>\n                </button>\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                '}\n            </div>\n        </div>\n    `},{name:"PresetListItem"}),Mt=Ie(()=>`\n        <footer class="cr-drawer__footer cr-drawer__footer--list">\n            <button id="${v.pW}_drawer_list_create"\n                    class="menu_button menu_button--primary"\n                    type="button">\n                <i class="fa-solid fa-plus"></i>\n                New Preset\n            </button>\n            <div class="cr-row cr-gap-2">\n                <button id="${v.pW}_drawer_list_import"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Import presets from file">\n                    <i class="fa-solid fa-file-import"></i>\n                </button>\n                <button id="${v.pW}_drawer_list_export"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Export custom presets">\n                    <i class="fa-solid fa-file-export"></i>\n                </button>\n            </div>\n        </footer>\n    `,{name:"PresetListFooter"});function Ft(e){const t=_e(".cr-drawer__body--list",e);t&&(t.outerHTML=Dt())}var Ut=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function Ht(e){return Ut(this,void 0,void 0,function*(){var t,r;const{type:n,mode:i,preset:a}=_t,s=_e(`#${v.pW}_drawer_name`),o=(null==s?void 0:s.value.trim())||"",c=we('input[name="drawer_stages"]:checked'),l=Array.from(c).map(e=>e.value),d=l.length===Pe.an.length?[]:l;if("prompt"===n){const r=_e(`#${v.pW}_drawer_prompt`),n=(null==r?void 0:r.value)||"",s=function(e){var t,r;const n=[],i=[];return(null===(t=e.name)||void 0===t?void 0:t.trim())?e.name.length>100&&n.push("Name must be 100 characters or less"):n.push("Name is required"),(null===(r=e.prompt)||void 0===r?void 0:r.trim())?e.prompt.length>5e4&&n.push("Prompt is too long (max 50,000 characters)"):n.push("Prompt is required"),e.prompt&&/\{\{user\}\}/i.test(e.prompt)&&i.push('{{user}} replacement depends on the "Replace {{user}} with persona name" setting'),{valid:0===n.length,errors:n,warnings:i}}({name:o,prompt:n,stages:d});if(!s.valid)return void jt(s.errors);const c="edit"===i?null==a?void 0:a.id:void 0;if(!y.presetRegistry.isNameUnique("prompt",o,c))return void jt(["A preset with this name already exists"]);let l;"edit"===i&&a?(y.presetRegistry.updatePromptPreset(a.id,{name:o,prompt:n,stages:d}),l=y.presetRegistry.getPromptPreset(a.id),v.oR.success("Preset updated")):(l=y.presetRegistry.registerPromptPreset({name:o,prompt:n,stages:d}),v.oR.success("Preset created")),null===(t=wt.onSave)||void 0===t||t.call(wt,l),e()}else{const t=_e(`#${v.pW}_drawer_schema`),n=(null==t?void 0:t.value)||"";let s;try{s=JSON.parse(n)}catch(e){return void jt([`Invalid JSON: ${e.message}`])}const c=B({name:o,schema:s,stages:d});if(!c.valid)return void jt(c.errors);const l="edit"===i?null==a?void 0:a.id:void 0;if(!y.presetRegistry.isNameUnique("schema",o,l))return void jt(["A preset with this name already exists"]);let u;"edit"===i&&a?(y.presetRegistry.updateSchemaPreset(a.id,{name:o,schema:s,stages:d}),u=y.presetRegistry.getSchemaPreset(a.id),v.oR.success("Schema preset updated")):(u=y.presetRegistry.registerSchemaPreset({name:o,schema:s,stages:d}),v.oR.success("Schema preset created")),null===(r=wt.onSave)||void 0===r||r.call(wt,u),e()}})}function Gt(e){return Ut(this,void 0,void 0,function*(){const{type:t,preset:r}=_t;if(!r)return;(yield v.lY.confirm("Delete Preset",`Are you sure you want to delete "${r.name}"?`))&&("prompt"===t?y.presetRegistry.deletePromptPreset(r.id):y.presetRegistry.deleteSchemaPreset(r.id),v.oR.success("Preset deleted"),e())})}function qt(){return Ut(this,void 0,void 0,function*(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>Ut(this,void 0,void 0,function*(){var t,r;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n)try{const e=yield n.text(),t=JSON.parse(e),i=(0,y.getSettings)();let a=0;if(Array.isArray(t.promptPresets))for(const e of t.promptPresets)e.isBuiltin||(e.id=crypto.randomUUID(),i.promptPresets.push(e),a++);if(Array.isArray(t.schemaPresets))for(const e of t.schemaPresets)e.isBuiltin||(e.id=crypto.randomUUID(),i.schemaPresets.push(e),a++);(0,y.save)(),v.oR.success(`Imported ${a} preset${1!==a?"s":""}`),null===(r=wt.onUpdate)||void 0===r||r.call(wt);const s=_e(`#${v.pW}_preset_drawer`);s&&"list"===_t.mode&&Ft(s)}catch(e){v.oR.error("Failed to import presets"),v.Rm.error("Import error:",e)}}),e.click()})}function Jt(){const e=(0,y.getSettings)(),t=e.promptPresets.filter(e=>!e.isBuiltin),r=e.schemaPresets.filter(e=>!e.isBuiltin);if(0===t.length&&0===r.length)return void v.oR.warning("No custom presets to export");const n={version:v.xv,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:r},i=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download=`character-tools-presets-${(new Date).toISOString().slice(0,10)}.json`,s.click(),URL.revokeObjectURL(a),v.oR.success(`Exported ${t.length+r.length} preset${t.length+r.length!==1?"s":""}`)}function Vt(e,t){_t={isOpen:!0,type:e,mode:"list",preset:null,activeTab:"edit"},function(e){wt=e}(t||{}),Kt()}function Yt(){const e=_e(`#${v.pW}_preset_drawer`);e&&(e.classList.remove("cr-drawer--open"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{var e;$t(),_t.isOpen=!1,null===(e=wt.onClose)||void 0===e||e.call(wt)},300))}function Kt(){const e=_e(`#${v.pW}_preset_drawer`);if(!e)return void v.Rm.error("Drawer not initialized");const t=_e(".cr-drawer__panel",e);t&&("list"===_t.mode?t.innerHTML=`\n                <div class="cr-drawer__content cr-drawer__content--list">\n                    ${Nt()}\n                    ${Dt()}\n                    ${Mt()}\n                </div>\n            `:t.innerHTML=`\n                <div class="cr-drawer__content">\n                    ${It()}\n                    ${Ot()}\n                    ${zt()}\n                </div>\n            `),"list"===_t.mode?function(e,t,r,n,i,a,s){const o=_e(`#${v.pW}_drawer_close`,e);o&&kt(xe(o,"click",t));const c=_e(".cr-drawer__backdrop",e);c&&kt(xe(c,"click",t));const l=we(".cr-drawer__tab",e);for(const t of l)kt(xe(t,"click",()=>{const r=t.dataset.tab;if(r===_t.type)return;_t.type=r,l.forEach(e=>e.classList.remove("cr-drawer__tab--active")),t.classList.add("cr-drawer__tab--active");const n=_e(".cr-drawer__body--list",e);n&&(n.outerHTML=Dt())}));kt(xe(e,"click",r=>Lt(this,void 0,void 0,function*(){var a,s;const o=r.target;if(!o.closest(".cr-preset-list"))return;const c=o.closest(".cr-preset-list__item");if(!c)return;const l=c.dataset.id,d=c.dataset.type;if(!l||!d)return;const u="prompt"===d?y.presetRegistry.getPromptPreset(l):y.presetRegistry.getSchemaPreset(l);if(u){if(o.closest(".cr-preset-list__select"))return null===(a=wt.onSelect)||void 0===a||a.call(wt,u),void t();if(o.closest(".cr-preset-list__action--edit"))n(d,l);else if(o.closest(".cr-preset-list__action--duplicate"))i(d,l);else if(o.closest(".cr-preset-list__action--delete")){if(!(yield v.lY.confirm("Delete Preset",`Are you sure you want to delete "${u.name}"?`)))return;"prompt"===d?y.presetRegistry.deletePromptPreset(l):y.presetRegistry.deleteSchemaPreset(l),v.oR.success("Preset deleted"),null===(s=wt.onUpdate)||void 0===s||s.call(wt),Ft(e)}}})));const d=_e(`#${v.pW}_drawer_list_create`,e);d&&kt(xe(d,"click",()=>{r(_t.type)}));const u=_e(`#${v.pW}_drawer_list_import`,e);u&&kt(xe(u,"click",a));const p=_e(`#${v.pW}_drawer_list_export`,e);p&&kt(xe(p,"click",s));const f=e=>{"Escape"===e.key&&_t.isOpen&&(e.preventDefault(),e.stopPropagation(),t())};document.addEventListener("keydown",f),kt(()=>document.removeEventListener("keydown",f))}(e,Yt,Qt,Xt,Zt,qt,Jt):Tt(e,Yt,()=>Ht(Yt),()=>Gt(Yt)),requestAnimationFrame(()=>{if(e.classList.add("cr-drawer--open"),e.setAttribute("aria-hidden","false"),"list"!==_t.mode){const t=_e(`#${v.pW}_drawer_name`,e);t&&(t.focus(),t.select()),"schema"===_t.type&&Wt()}})}function Qt(e){$t(),_t.mode="create",_t.type=e,_t.preset=null;const t=_e(`#${v.pW}_preset_drawer`);if(!t)return;const r=_e(".cr-drawer__panel",t);r&&(r.innerHTML=`\n            <div class="cr-drawer__content">\n                ${It()}\n                ${Ot()}\n                ${zt()}\n            </div>\n        `),Tt(t,Yt,()=>Ht(Yt),()=>Gt(Yt));const n=_e(`#${v.pW}_drawer_name`,t);n&&n.focus()}function Xt(e,t){const r="prompt"===e?y.presetRegistry.getPromptPreset(t):y.presetRegistry.getSchemaPreset(t);if(!r)return;$t(),_t.mode="edit",_t.type=e,_t.preset=r;const n=_e(`#${v.pW}_preset_drawer`);if(!n)return;const i=_e(".cr-drawer__panel",n);i&&(i.innerHTML=`\n            <div class="cr-drawer__content">\n                ${It()}\n                ${Ot()}\n                ${zt()}\n            </div>\n        `),Tt(n,Yt,()=>Ht(Yt),()=>Gt(Yt));const a=_e(`#${v.pW}_drawer_name`,n);a&&(a.focus(),a.select()),"schema"===e&&Wt()}function Zt(e,t){const r="prompt"===e?y.presetRegistry.getPromptPreset(t):y.presetRegistry.getSchemaPreset(t);if(!r)return;$t(),_t.mode="duplicate",_t.type=e,_t.preset=r;const n=_e(`#${v.pW}_preset_drawer`);if(!n)return;const i=_e(".cr-drawer__panel",n);i&&(i.innerHTML=`\n            <div class="cr-drawer__content">\n                ${It()}\n                ${Ot()}\n                ${zt()}\n            </div>\n        `),Tt(n,Yt,()=>Ht(Yt),()=>Gt(Yt));const a=_e(`#${v.pW}_drawer_name`,n);a&&(a.focus(),a.select()),"schema"===e&&Wt()}var er=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function tr(e){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[e.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function rr(){const e=J(),t=[];if(!e.character)return t;const r=I(e.character),n=e.stageResults.rewrite,i=(null==n?void 0:n.output)?function(e){var t,r;const n={},i=/^#{2,3}\s*(.+?)[\s:]*$/gm,a=[];let s;for(;null!==(s=i.exec(e))&&(a.push({name:s[1].trim().toLowerCase(),start:s.index+s[0].length}),!(a.length>=50)););for(let i=0;i<a.length;i++){const s=a[i],o=null!==(r=null===(t=a[i+1])||void 0===t?void 0:t.start)&&void 0!==r?r:e.length,c=e.slice(s.start,o).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=tr(s.name);l&&c&&(n[l]=c)}return n}(n.output):{};for(const e of r){const r=i[e.key]||null;t.push({key:e.key,label:e.label,original:e.value,rewritten:r,hasChanges:null!==r&&r!==e.value})}return t}function nr(e){const t=SillyTavern.libs.DOMPurify;if(!e.rewritten)return`\n            <div class="cr-compare-row cr-compare-row--unchanged">\n                <div class="cr-compare-row__header">\n                    <span class="cr-compare-row__label">${e.label}</span>\n                    <span class="cr-badge cr-badge--small cr-badge--muted">No changes</span>\n                </div>\n                <div class="cr-compare-row__content cr-compare-row__content--single">\n                    <pre class="cr-compare-text">${t.sanitize(e.original)}</pre>\n                </div>\n            </div>\n        `;const{originalHtml:r,rewrittenHtml:n}=function(e,t){const r=SillyTavern.libs.DOMPurify;return{originalHtml:r.sanitize(e),rewrittenHtml:r.sanitize(t)}}(e.original,e.rewritten);return`\n        <div class="cr-compare-row">\n            <div class="cr-compare-row__header">\n                <span class="cr-compare-row__label">${e.label}</span>\n            </div>\n            <div class="cr-compare-row__content">\n                <div class="cr-compare-col cr-compare-col--original">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-file"></i> Original\n                    </div>\n                    <pre class="cr-compare-text">${r}</pre>\n                </div>\n                <div class="cr-compare-col cr-compare-col--rewritten">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-pen-fancy"></i> Rewritten\n                    </div>\n                    <pre class="cr-compare-text">${n}</pre>\n                </div>\n            </div>\n        </div>\n    `}const ir=Ie(()=>{const e=J();if(!e.character)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No character selected</div>\n                <div class="cr-empty__text">Select a character to compare versions</div>\n            </div>\n        ';if(!e.stageResults.rewrite)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No rewrite available</div>\n                <div class="cr-empty__text">Run the Rewrite stage first to see comparisons</div>\n            </div>\n        ';return`\n        <div class="cr-compare-view">\n            <div class="cr-compare-list cr-scrollable">\n                ${rr().map(nr).join("")}\n            </div>\n        </div>\n    `},{name:"CompareView"});function ar(e){const t=e.split("\n"),r=[];let n=null,i=[],a=!1,s="",o=[];const c=()=>{if(0===i.length)return;const e=i.join("\n").trim();if(!e)return void(i=[]);const t=function(e){const t=e.split("\n"),r=[];let n="",i=!1,a="bullet";for(const e of t){const t=e.match(/^[\s]*[-*]\s+(.+)$/),s=e.match(/^[\s]*\d+[.)]\s+(.+)$/);if(t||s)i||(i=!0,a=s?"numbered":"bullet"),n&&r.push(n.trim()),n=(t||s)[1];else if(i&&n&&e.match(/^\s+\S/))n+=" "+e.trim();else if(""===e.trim())n&&r.push(n.trim()),n="";else if(i&&e.trim()){n&&r.push(n.trim());break}}n&&r.push(n.trim());return 0===r.length?null:{items:r,listType:a}}(e),a=e.split("\n"),s=[];for(let e=0;e<a.length;e++){const t=a[e];if(t.match(/^[\s]*[-*]\s+.+$/)||t.match(/^[\s]*\d+[.)]\s+.+$/))break;t.trim()&&s.push(t)}if(s.length>0&&t){const e=s.join("\n").trim();if(e){const t=e.split(/\n\n+/);for(const e of t){if(!e.trim())continue;const t={type:"paragraph",content:e.trim()};n?(n.children=n.children||[],n.children.push(t)):r.push(t)}}}if(t){const e={type:"list",items:t.items,listType:t.listType};n?(n.children=n.children||[],n.children.push(e)):r.push(e)}else{const t=e.split(/\n\n+/);for(const e of t){if(!e.trim())continue;const t={type:"paragraph",content:e.trim()};n?(n.children=n.children||[],n.children.push(t)):r.push(t)}}i=[]},l=()=>{if(0===o.length)return;const e={type:"code",content:o.join("\n"),language:s};n?(n.children=n.children||[],n.children.push(e)):r.push(e),o=[],s=""};for(const e of t){if(/^[-*_]{3,}\s*$/.test(e.trim()))continue;const t=e.match(/^```(\w*)/);if(t){a?(l(),a=!1):(c(),a=!0,s=t[1]||"");continue}if(a){o.push(e);continue}const d=e.match(/^(#{1,3})\s+(.+)$/);if(d){c(),n&&(n.children&&n.children.length>0||n.score)&&r.push(n);const e=d[1].length,t=d[2].trim(),i=cr(t);if(i&&1===e)r.push({type:"hero",title:i.label,score:{value:i.value,max:i.max}}),n=null;else{n={type:"section",title:t,children:[]};const e=sr(t);e&&(n.score={value:e.value,max:e.max},n.title=t.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim())}continue}const u=or(e);if(u&&n){n.score={value:u.value,max:u.max};continue}if(e.match(/^\*\*([^*]+):\*\*\s*$/)&&n){c();const t={type:"paragraph",content:e};n.children=n.children||[],n.children.push(t);continue}i.push(e)}if(c(),a&&l(),n&&(n.children&&n.children.length>0||n.score)&&r.push(n),r.length>0&&"section"===r[0].type){const e=r[0];e.score&&function(e){const t=e.toLowerCase().replace(/[_-]/g,"");return["overall","total","final","summary","verdict","rating","soulcheck"].some(e=>t.includes(e))}(e.title||"")&&(r[0]={type:"hero",title:e.title,score:e.score},e.children&&e.children.length>0&&r.splice(1,0,...e.children.map(e=>e)))}return r}function sr(e){const t=e.match(/(\d+(?:\.\d+)?)\s*\/\s*(\d+)/);if(t){const e=parseFloat(t[1]),r=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(r)&&r>0)return{value:e,max:r}}return null}function or(e){const t=e.trim().match(/^(?:score\s*:?\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)$/i);if(t){const e=parseFloat(t[1]),r=parseInt(t[2],10);if(!isNaN(e)&&!isNaN(r)&&r>0)return{value:e,max:r}}return null}function cr(e){const t=sr(e);if(t){const r=e.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim();return Object.assign(Object.assign({},t),{label:r})}return null}function lr(e){const{DOMPurify:t}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:"");return t.sanitize(r,{ALLOWED_TAGS:[]})}function dr(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function ur(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function pr(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function fr(e){return e>=8?"var(--cr-score-high, #10b981)":e>=6?"var(--cr-score-good, #22c55e)":e>=4?"var(--cr-score-mid, #eab308)":e>=2?"var(--cr-score-low, #f97316)":"var(--cr-score-bad, #ef4444)"}function mr(e){if(0===e.length)return'<div class="cr-formatted cr-formatted--empty">No content</div>';return`<div class="cr-formatted">${e.map(gr).join("")}</div>`}function gr(e){switch(e.type){case"hero":return hr(e);case"section":return function(e){const t=e.title||"",r=null!=e.score,n=e.children||[];let i="";if(r&&e.score){i=`\n            <span class="cr-section__score" style="--score-color: ${fr(100===e.score.max?e.score.value/10:e.score.value)}">\n                ${Number.isInteger(e.score.value)?e.score.value:e.score.value.toFixed(1)}<span class="cr-section__score-max">/${e.score.max}</span>\n            </span>\n        `}const a=n.map(gr).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${lr(t)}</h3>\n                ${i}\n            </div>\n            <div class="cr-section__body">\n                ${a}\n            </div>\n        </div>\n    `}(e);case"paragraph":return function(e){const t=e.content||"";return`<p class="cr-para">${vr(t)}</p>`}(e);case"list":return function(e){const t=e.items||[];if(0===t.length)return"";const r=t.map(e=>`<li>${vr(e)}</li>`).join(""),n="numbered"===e.listType?"ol":"ul";return`<${n} class="cr-list">${r}</${n}>`}(e);case"code":return function(e){const{hljs:t}=SillyTavern.libs,r=e.content||"",n=e.language||"";let i;try{i=t?n&&t.getLanguage(n)?t.highlight(r,{language:n}).value:t.highlightAuto(r).value:lr(r)}catch(e){i=lr(r)}return`\n        <div class="cr-code">\n            ${n?`<div class="cr-code__lang">${lr(n)}</div>`:""}\n            <pre class="cr-code__pre"><code class="hljs">${i}</code></pre>\n        </div>\n    `}(e);default:return""}}function hr(e){const t=e.score;if(!t)return"";const r=fr(100===t.max?t.value/10:t.value),n=Number.isInteger(t.value)?t.value:t.value.toFixed(1);return`\n        <div class="cr-hero">\n            <div class="cr-hero__label">${lr(e.title||"Score")}</div>\n            <div class="cr-hero__score">\n                <span class="cr-hero__value" style="--score-color: ${r}">${n}</span>\n                <span class="cr-hero__max">/${t.max}</span>\n            </div>\n            <div class="cr-hero__bar">\n                <div class="cr-hero__fill" style="width: ${t.value/t.max*100}%; --score-color: ${r}"></div>\n            </div>\n        </div>\n    `}function vr(e){let t=lr(e);return t=t.replace(/(?:(\w+)\s*:\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)/gi,(e,t,r,n)=>{const i=parseFloat(r),a=parseInt(n,10);return`${t?`<span class="cr-inline-score__label">${t}:</span> `:""}<span class="cr-inline-score" style="--score-color: ${fr(100===a?i/10:i)}">${Number.isInteger(i)?i:i.toFixed(1)}<span class="cr-inline-score__max">/${a}</span></span>`}),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?![*\s])(.+?)(?<![*\s])\*(?![*_])/g,"<em>$1</em>"),t=t.replace(/(?<![*_])_(?![_\s])(.+?)(?<![_\s])_(?![*_])/g,"<em>$1</em>"),t=t.replace(/`([^`]+)`/g,'<code class="cr-inline-code">$1</code>'),t}function yr(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?yr(e[0]):{type:"string"}};if("object"==typeof e){const t={};for(const[r,n]of Object.entries(e))t[r]=yr(n);return{type:"object",properties:t}}return{type:typeof e}}function br(e,t){const r=function(e){const t=["overallscore","totalscore","overall","total","score","rating"];for(const r of t)for(const t of Object.keys(e))if(t.toLowerCase().replace(/_/g,"")===r&&"number"==typeof e[t])return t;return null}(e),n=r?e[r]:null,i=[];if(r&&"number"==typeof n){const e=n>10?100:10;i.push(hr({type:"hero",title:pr(r),score:{value:n,max:e}}))}const a=t.properties||{},s=Object.keys(a).length>0?Object.keys(a):Object.keys(e);for(const t of s){if(t===r)continue;const n=e[t];if(void 0===n)continue;const s=a[t]||{type:dr(n)};i.push(_r(t,n,s,0))}return`<div class="cr-formatted">${i.join("")}</div>`}function _r(e,t,r,n){if(n>8)return function(e){const{hljs:t}=SillyTavern.libs,r=JSON.stringify(e,null,2);return`<pre class="cr-code__pre"><code class="hljs">${t?t.highlight(r,{language:"json"}).value:lr(r)}</code></pre>`}(t);const i=pr(e),a=r.type||dr(t);if("array"===a&&Array.isArray(t))return function(e,t,r,n){if(0===t.length)return`\n            <div class="cr-field">\n                <div class="cr-field__label">${lr(e)}</div>\n                <div class="cr-field__value cr-field--empty">(none)</div>\n            </div>\n        `;const i=r.items||{type:dr(t[0])};if(t.every(ur)){const r=t.map(e=>`<li>${function(e){if("boolean"==typeof e)return $r(e);if("number"==typeof e)return`<span class="cr-num">${e.toLocaleString()}</span>`;return vr(String(e))}(e)}</li>`).join("");return`\n            <div class="cr-field">\n                <div class="cr-field__label">${lr(e)}</div>\n                <ul class="cr-list">${r}</ul>\n            </div>\n        `}const a=t.map((e,t)=>"object"==typeof e&&null!==e?function(e,t,r){const n=t.properties||{},i=Object.keys(n).length>0?Object.keys(n):Object.keys(e),a=i.find(t=>"string"==typeof e[t]&&e[t].length<100),s=i.find(t=>"number"==typeof e[t]&&e[t]>=0&&e[t]<=100),o=i.find(t=>"string"==typeof e[t]&&e[t].length>=50&&t!==a);let c="";if(a||s){c=`<div class="cr-card__header">${a?`<span class="cr-card__title">${lr(String(e[a]))}</span>`:""}${s?xr(e[s]):""}</div>`}let l="";o&&(l=`<div class="cr-card__body">${vr(String(e[o]))}</div>`);const d=i.filter(e=>e!==a&&e!==s&&e!==o).map(t=>{const i=e[t];if(void 0===i)return"";return _r(t,i,n[t]||{type:dr(i)},r+1)}).filter(Boolean).join("");return`<div class="cr-card">${c}${l}${d?`<div class="cr-card__extra">${d}</div>`:""}</div>`}(e,i,n+1):`<div class="cr-card">${wr(e,i)}</div>`).join("");return`\n        <div class="cr-field">\n            <div class="cr-field__label">${lr(e)}</div>\n            <div class="cr-cards">${a}</div>\n        </div>\n    `}(i,t,r,n);if("object"===a&&"object"==typeof t&&null!==t)return function(e,t,r,n){const i=r.properties||{},a=(Object.keys(i).length>0?Object.keys(i):Object.keys(t)).map(e=>{const r=t[e];if(void 0===r)return"";return _r(e,r,i[e]||{type:dr(r)},n+1)}).filter(Boolean).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${lr(e)}</h3>\n            </div>\n            <div class="cr-section__body cr-section__body--nested">\n                ${a}\n            </div>\n        </div>\n    `}(i,t,r,n);const s=wr(t,r,e);return`\n        <div class="cr-field">\n            <div class="cr-field__label">${lr(i)}</div>\n            <div class="cr-field__value">${s}</div>\n        </div>\n    `}function wr(e,t,r){if(null==e)return'<span class="cr-null"></span>';switch(t.type||dr(e)){case"string":return function(e,t){if(!e.trim())return'<span class="cr-empty">(empty)</span>';const r=t.format;if("uri"===r||"url"===r||(n=e,/^https?:\/\//i.test(n))){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${lr(e)}" target="_blank" rel="noopener" class="cr-link">${lr(t)}</a>`}var n;if("email"===r||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${lr(e)}" class="cr-link">${lr(e)}</a>`;if(e.length>100||e.includes("\n"))return`<div class="cr-text">${vr(e)}</div>`;return`<span>${vr(e)}</span>`}(e,t);case"number":case"integer":return function(e,t,r){const n=String(t.title||t.description||r||"").toLowerCase();if(function(e,t){return!!["score","rating","rank","grade","level","confidence","quality"].some(t=>e.includes(t))||!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t))}(n,e))return xr(e);return`<span class="cr-num">${e.toLocaleString(void 0,{maximumFractionDigits:2})}</span>`}(e,t,r);case"boolean":return $r(e);default:return`<span>${lr(String(e))}</span>`}}function xr(e){const t=e>10?100:10;return`<span class="cr-score" style="--score-color: ${fr(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="cr-score__max">/${t}</span></span>`}function $r(e){return`<span class="${e?"cr-bool--yes":"cr-bool--no"}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function kr(e,t){var r;const{DOMPurify:n}=SillyTavern.libs,i="string"==typeof e?e:String(null!=e?e:""),a=Sr(i);if(!a||"object"!=typeof a){const e=ar(i);return n.sanitize(mr(e))}const s=br(a,null!==(r=null==t?void 0:t.value)&&void 0!==r?r:yr(a));return n.sanitize(s)}function Sr(e){try{return JSON.parse(e)}catch(t){const r=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(r)try{return JSON.parse(r[1].trim())}catch(e){return null}return null}}let Pr="result";const Rr={score:"smart",rewrite:"smart",analyze:"smart"},Ar={score:"formatted",rewrite:"formatted",analyze:"formatted"};let Cr=null;function Er(){return Pr}function Ir(e){return Rr[e]}function Or(e){return Ar[e]}function zr(){return Cr}function Tr(e){Cr=e}const Wr=Ie((e,t)=>{var r;const n=SillyTavern.libs.DOMPurify,i=SillyTavern.libs.hljs;if(!e)return`\n            <div class="cr-empty">\n                <i class="fa-solid ${v.iu[t]} cr-empty__icon"></i>\n                <div class="cr-empty__title">No results yet</div>\n                <div class="cr-empty__text">Run ${v.BA[t]} to see results</div>\n            </div>\n        `;if(e.error)return`\n            <div class="cr-alert cr-alert--danger">\n                <i class="fa-solid fa-exclamation-triangle cr-alert__icon"></i>\n                <div class="cr-alert__content">\n                    <div class="cr-alert__title">Error</div>\n                    <div class="cr-alert__message">${n.sanitize(e.error)}</div>\n                </div>\n            </div>\n        `;const a=Sr(e.output);if(null!==a&&"object"==typeof a){const s=JSON.stringify(a,null,2),o=J().stageConfigs[t];let c=null;if(null==o?void 0:o.schemaPresetId){const e=(0,_.Bx)(o.schemaPresetId);c=null!==(r=null==e?void 0:e.schema)&&void 0!==r?r:null}const l=Ir(t);let d;if("smart"===l)d=kr(e.output,c);else{let e;try{e=i.highlight(s,{language:"json"}).value}catch(t){e=n.sanitize(s)}d=`<pre class="cr-result__code hljs"><code>${e}</code></pre>`}return`\n            <div class="cr-result" data-stage="${t}">\n                <div class="cr-result__header">\n                    <span class="cr-result__type">\n                        <i class="fa-solid fa-brackets-curly"></i>\n                        Structured Output\n                    </span>\n                    <div class="cr-result__actions">\n                        <div class="cr-json-toggle" data-stage="${t}">\n                            <button class="cr-json-toggle__btn ${"smart"===l?"cr-json-toggle__btn--active":""}"\n                                    data-mode="smart"\n                                    type="button"\n                                    title="Smart formatted view">\n                                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            </button>\n                            <button class="cr-json-toggle__btn ${"raw"===l?"cr-json-toggle__btn--active":""}"\n                                    data-mode="raw"\n                                    type="button"\n                                    title="Raw JSON view">\n                                <i class="fa-solid fa-code"></i>\n                            </button>\n                        </div>\n                        <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                data-type="json"\n                                data-stage="${t}"\n                                data-raw="${encodeURIComponent(e.output)}"\n                                data-formatted="${encodeURIComponent(s)}"\n                                type="button"\n                                title="Copy to clipboard">\n                            <i class="fa-solid fa-copy"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="cr-result__content">\n                    ${d}\n                </div>\n            </div>\n        `}const s=Or(t);let o;return o="formatted"===s?function(e){const{DOMPurify:t}=SillyTavern.libs,r="string"==typeof e?e:String(null!=e?e:""),n=Sr(r);if(n&&"object"==typeof n)return kr(r,null);const i=mr(ar(r));return t.sanitize(i)}(e.output):`<pre class="cr-result__raw">${n.sanitize(e.output)}</pre>`,`\n        <div class="cr-result" data-stage="${t}">\n            <div class="cr-result__header">\n                <span class="cr-result__type">\n                    <i class="fa-solid ${v.iu[t]}"></i>\n                    ${v.BA[t]}\n                </span>\n                <div class="cr-result__actions">\n                    <div class="cr-text-toggle" data-stage="${t}">\n                        <button class="cr-text-toggle__btn ${"formatted"===s?"cr-text-toggle__btn--active":""}"\n                                data-mode="formatted"\n                                type="button"\n                                title="Formatted view">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        </button>\n                        <button class="cr-text-toggle__btn ${"raw"===s?"cr-text-toggle__btn--active":""}"\n                                data-mode="raw"\n                                type="button"\n                                title="Raw text (easy to copy)">\n                            <i class="fa-solid fa-code"></i>\n                        </button>\n                    </div>\n                    <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            data-type="text"\n                            data-stage="${t}"\n                            data-raw="${encodeURIComponent(e.output)}"\n                            type="button"\n                            title="Copy to clipboard">\n                        <i class="fa-solid fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="cr-result__content">\n                ${o}\n            </div>\n        </div>\n    `},{name:"ResultContent"}),jr=Ie((e,t)=>{var r;const n=SillyTavern.libs.DOMPurify,i=SillyTavern.libs.moment,a=J(),s=i(e.timestamp),o=s.fromNow(),c=s.format("MMM D, h:mm A"),l=ke(e.output||e.error||"",100),d=a.viewingHistoryIndex===t,u=(null===(r=a.stageResults[e.stage])||void 0===r?void 0:r.timestamp)===e.timestamp;return`\n        <div class="cr-list-item ${Se(e.error&&"cr-list-item--error",d&&"cr-list-item--viewing",u&&"cr-list-item--current")}"\n             data-index="${t}">\n            <div class="cr-list-item__content">\n                <div class="cr-row cr-row--between">\n                    <span class="cr-list-item__title">\n                        <i class="fa-solid ${v.iu[e.stage]} cr-text-accent"></i>\n                        ${v.BA[e.stage]}\n                        ${u?'<span class="cr-badge cr-badge--sm">current</span>':""}\n                    </span>\n                    <span class="cr-text-xs cr-text-dim" title="${c}">${o}</span>\n                </div>\n                <div class="cr-list-item__subtitle cr-truncate">${n.sanitize(l)}</div>\n            </div>\n            <div class="cr-list-item__actions">\n                <button class="cr-history-restore menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        data-index="${t}"\n                        type="button"\n                        title="Restore this result as current">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n        </div>\n    `},{name:"HistoryItem"}),Lr=Ie(()=>{var e,t;const r=J(),n=ue(),i=null!==n,a=Er(),s=i?n:r.stageResults[r.activeStage],o=!!r.stageResults.rewrite,c=r.iterationHistory.length>0,l=o&&!i&&"rewrite"===r.activeStage,d=!i&&o&&"rewrite"===r.activeStage,u=i?`\n            <div class="cr-history-nav">\n                <div class="cr-history-nav__info">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Viewing history ${(null!==(e=r.viewingHistoryIndex)&&void 0!==e?e:0)+1} of ${r.iterationHistory.length}</span>\n                </div>\n                <div class="cr-history-nav__controls">\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${v.pW}_history_prev"\n                            type="button"\n                            title="Previous"\n                            ${0===r.viewingHistoryIndex?"disabled":""}>\n                        <i class="fa-solid fa-chevron-left"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${v.pW}_history_next"\n                            type="button"\n                            title="Next"\n                            ${r.viewingHistoryIndex===r.iterationHistory.length-1?"disabled":""}>\n                        <i class="fa-solid fa-chevron-right"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                            id="${v.pW}_history_restore"\n                            type="button"\n                            title="Restore this as current result">\n                        <i class="fa-solid fa-rotate-left"></i> Restore\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--sm"\n                            id="${v.pW}_history_back"\n                            type="button"\n                            title="Back to current results">\n                        <i class="fa-solid fa-xmark"></i> Back\n                    </button>\n                </div>\n            </div>\n        `:"",p=l?`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===a?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===a?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${d?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply or export rewritten content">\n                    <i class="fa-solid fa-file-export"></i> Apply / Export\n                </button>\n            ':""}\n        `:"",f=i?Wr(s,null!==(t=null==s?void 0:s.stage)&&void 0!==t?t:r.activeStage):"compare"===a&&l?`<div id="${v.pW}_compare_content">${ir()}</div>`:Wr(s,r.activeStage),m=c?`\n            <div class="cr-history ${Se(!r.historyExpanded&&"cr-history--collapsed")}">\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${r.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${r.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${v.pW}_history_list" class="cr-history__list cr-list">\n                    ${r.iterationHistory.map((e,t)=>jr(e,t)).join("")}\n                </div>\n            </div>\n        `:"";return`\n        <div class="cr-results-wrapper">\n            \x3c!-- History Navigation (when viewing history) --\x3e\n            ${u}\n\n            \x3c!-- View Toggle --\x3e\n            ${p?`<div class="cr-results-toolbar">${p}</div>`:""}\n\n            \x3c!-- Results/Compare content --\x3e\n            <div id="${v.pW}_results_content" class="cr-results-content">\n                ${f}\n            </div>\n\n            \x3c!-- Run History Section (only if there's history) --\x3e\n            ${m}\n        </div>\n    `},{name:"ResultsPanel"});function Nr(){var e,t;const r=J(),n=ue(),i=null!==n,a=Er(),s=!!r.stageResults.rewrite,o=r.iterationHistory.length>0,c=s&&!i&&"rewrite"===r.activeStage,l=!i&&s&&"rewrite"===r.activeStage,d=_e(".cr-results-wrapper");if(!d)return;let u=d.querySelector(".cr-history-nav");if(i){const t=`\n            <div class="cr-history-nav__info">\n                <i class="fa-solid fa-clock-rotate-left"></i>\n                <span>Viewing history ${(null!==(e=r.viewingHistoryIndex)&&void 0!==e?e:0)+1} of ${r.iterationHistory.length}</span>\n            </div>\n            <div class="cr-history-nav__controls">\n                <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                        id="${v.pW}_history_prev"\n                        type="button"\n                        title="Previous"\n                        ${0===r.viewingHistoryIndex?"disabled":""}>\n                    <i class="fa-solid fa-chevron-left"></i>\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                        id="${v.pW}_history_next"\n                        type="button"\n                        title="Next"\n                        ${r.viewingHistoryIndex===r.iterationHistory.length-1?"disabled":""}>\n                    <i class="fa-solid fa-chevron-right"></i>\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                        id="${v.pW}_history_restore"\n                        type="button"\n                        title="Restore this as current result">\n                    <i class="fa-solid fa-rotate-left"></i> Restore\n                </button>\n                <button class="cr-history-nav__btn menu_button menu_button--sm"\n                        id="${v.pW}_history_back"\n                        type="button"\n                        title="Back to current results">\n                    <i class="fa-solid fa-xmark"></i> Back\n                </button>\n            </div>\n        `;u||(u=document.createElement("div"),u.className="cr-history-nav",d.insertBefore(u,d.firstChild)),u.innerHTML=t}else u&&u.remove();let p=d.querySelector(".cr-results-toolbar");if(c){const e=`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===a?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===a?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${l?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply or export rewritten content">\n                    <i class="fa-solid fa-file-export"></i> Apply / Export\n                </button>\n            ':""}\n        `;if(!p){p=document.createElement("div"),p.className="cr-results-toolbar";const e=_e(`#${v.pW}_results_content`);e&&d.insertBefore(p,e)}p.innerHTML=e}else p&&p.remove();const f=_e(`#${v.pW}_results_content`);if(!f)return;if(i)f.innerHTML=Wr(n,null!==(t=null==n?void 0:n.stage)&&void 0!==t?t:r.activeStage);else if("compare"===a&&c)f.innerHTML=`<div id="${v.pW}_compare_content">${ir()}</div>`;else{const e=r.stageResults[r.activeStage];f.innerHTML=Wr(e,r.activeStage)}let m=d.querySelector(".cr-history");if(o){m||(m=document.createElement("div"),m.className="cr-history "+(r.historyExpanded?"":"cr-history--collapsed"),m.innerHTML=`\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${r.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${r.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${v.pW}_history_list" class="cr-history__list cr-list">\n                </div>\n            `,d.appendChild(m));const e=_e(`#${v.pW}_history_list`);if(e){!function(e,t,r){const n=SillyTavern.libs.morphdom,i=SillyTavern.libs.DOMPurify;if(!n)return void(e.innerHTML=i.sanitize(t));const a=document.createElement("div");a.innerHTML=i.sanitize(t),n(e,a,{childrenOnly:!0,onBeforeElUpdated:(e,t)=>{var n,i;if(document.activeElement===e&&"INPUT"===e.tagName){const r=e,n=t;n.value=r.value,n.selectionStart=r.selectionStart,n.selectionEnd=r.selectionEnd}if(document.activeElement===e&&"TEXTAREA"===e.tagName){const r=e,n=t;n.value=r.value,n.selectionStart=r.selectionStart,n.selectionEnd=r.selectionEnd}return null===(i=null===(n=null==r?void 0:r.onBeforeElUpdated)||void 0===n?void 0:n.call(r,e,t))||void 0===i||i},onBeforeNodeDiscarded:null==r?void 0:r.onBeforeNodeDiscarded,onNodeAdded:null==r?void 0:r.onNodeAdded})}(e,r.iterationHistory.map((e,t)=>jr(e,t)).join(""))}const t=m.querySelector(".cr-history__toggle span");t&&(t.textContent=`Run History (${r.iterationHistory.length})`)}else m&&m.remove()}var Dr=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function Br(e){const{rawValue:t,type:r,key:n}=e;if(null==t)return"";if("array"===r&&Array.isArray(t))return t.join("\n---\n");if("object"===r){if("depth_prompt"===n){return t.prompt||""}if("character_book"===n)try{return JSON.stringify(t,null,2)}catch(e){return"[Character Lorebook - edit in ST]"}try{return JSON.stringify(t,null,2)}catch(e){return""}}return String(t)}function Mr(e){return"character_book"!==e.key}var Fr=r(29),Ur=r.n(Fr),Hr=r(960);const Gr=(e,t=0)=>{let r=~~t,n=0;for(let t=0;t<e.length;t++)n+=e[t];return r+=n%256,r%256};var qr=r(287);const Jr=(e,t)=>qr.hp.from(e,t);function Vr(e,t){const r=(e,r)=>t(Jr(e),r)>>>0;return r.signed=(e,r)=>t(Jr(e),r),r.unsigned=r,r.model=e,r}Vr("crc1",Gr);let Yr=[0,7,14,9,28,27,18,21,56,63,54,49,36,35,42,45,112,119,126,121,108,107,98,101,72,79,70,65,84,83,90,93,224,231,238,233,252,251,242,245,216,223,214,209,196,195,202,205,144,151,158,153,140,139,130,133,168,175,166,161,180,179,186,189,199,192,201,206,219,220,213,210,255,248,241,246,227,228,237,234,183,176,185,190,171,172,165,162,143,136,129,134,147,148,157,154,39,32,41,46,59,60,53,50,31,24,17,22,3,4,13,10,87,80,89,94,75,76,69,66,111,104,97,102,115,116,125,122,137,142,135,128,149,146,155,156,177,182,191,184,173,170,163,164,249,254,247,240,229,226,235,236,193,198,207,200,221,218,211,212,105,110,103,96,117,114,123,124,81,86,95,88,77,74,67,68,25,30,23,16,5,2,11,12,33,38,47,40,61,58,51,52,78,73,64,71,82,85,92,91,118,113,120,127,106,109,100,99,62,57,48,55,34,37,44,43,6,1,8,15,26,29,20,19,174,169,160,167,178,181,188,187,150,145,152,159,138,141,132,131,222,217,208,215,194,197,204,203,230,225,232,239,250,253,244,243];"undefined"!=typeof Int32Array&&(Yr=new Int32Array(Yr));Vr("crc-8",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&Yr[255&(r^e[t])];return r});let Kr=[0,94,188,226,97,63,221,131,194,156,126,32,163,253,31,65,157,195,33,127,252,162,64,30,95,1,227,189,62,96,130,220,35,125,159,193,66,28,254,160,225,191,93,3,128,222,60,98,190,224,2,92,223,129,99,61,124,34,192,158,29,67,161,255,70,24,250,164,39,121,155,197,132,218,56,102,229,187,89,7,219,133,103,57,186,228,6,88,25,71,165,251,120,38,196,154,101,59,217,135,4,90,184,230,167,249,27,69,198,152,122,36,248,166,68,26,153,199,37,123,58,100,134,216,91,5,231,185,140,210,48,110,237,179,81,15,78,16,242,172,47,113,147,205,17,79,173,243,112,46,204,146,211,141,111,49,178,236,14,80,175,241,19,77,206,144,114,44,109,51,209,143,12,82,176,238,50,108,142,208,83,13,239,177,240,174,76,18,145,207,45,115,202,148,118,40,171,245,23,73,8,86,180,234,105,55,213,139,87,9,235,181,54,104,138,212,149,203,41,119,244,170,72,22,233,183,85,11,136,214,52,106,43,117,151,201,74,20,246,168,116,42,200,150,21,75,169,247,182,232,10,84,215,137,107,53];"undefined"!=typeof Int32Array&&(Kr=new Int32Array(Kr));Vr("dallas-1-wire",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&Kr[255&(r^e[t])];return r});let Qr=[0,213,127,170,254,43,129,84,41,252,86,131,215,2,168,125,82,135,45,248,172,121,211,6,123,174,4,209,133,80,250,47,164,113,219,14,90,143,37,240,141,88,242,39,115,166,12,217,246,35,137,92,8,221,119,162,223,10,160,117,33,244,94,139,157,72,226,55,99,182,28,201,180,97,203,30,74,159,53,224,207,26,176,101,49,228,78,155,230,51,153,76,24,205,103,178,57,236,70,147,199,18,184,109,16,197,111,186,238,59,145,68,107,190,20,193,149,64,234,63,66,151,61,232,188,105,195,22,239,58,144,69,17,196,110,187,198,19,185,108,56,237,71,146,189,104,194,23,67,150,60,233,148,65,235,62,106,191,21,192,75,158,52,225,181,96,202,31,98,183,29,200,156,73,227,54,25,204,102,179,231,50,152,77,48,229,79,154,206,27,177,100,114,167,13,216,140,89,243,38,91,142,36,241,165,112,218,15,32,245,95,138,222,11,161,116,9,220,118,163,247,34,136,93,214,3,169,124,40,253,87,130,255,42,128,85,1,212,126,171,132,81,251,46,122,175,5,208,173,120,210,7,83,134,44,249];"undefined"!=typeof Int32Array&&(Qr=new Int32Array(Qr));Vr("crc-8-dvbs2",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=255&Qr[255&(r^e[t])];return r});let Xr=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];"undefined"!=typeof Int32Array&&(Xr=new Int32Array(Xr));Vr("crc-16",(e,t=0)=>{let r=~~t;for(let t=0;t<e.length;t++)r=65535&(Xr[255&(r^e[t])]^r>>8);return r});let Zr=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920];"undefined"!=typeof Int32Array&&(Zr=new Int32Array(Zr));Vr("ccitt",(e,t)=>{let r=void 0!==t?~~t:65535;for(let t=0;t<e.length;t++)r=65535&(Zr[255&(r>>8^e[t])]^r<<8);return r});let en=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];"undefined"!=typeof Int32Array&&(en=new Int32Array(en));Vr("crc-16-modbus",(e,t)=>{let r=void 0!==t?~~t:65535;for(let t=0;t<e.length;t++)r=65535&(en[255&(r^e[t])]^r>>8);return r}),Vr("xmodem",(e,t)=>{let r=void 0!==t?~~t:0;for(let t=0;t<e.length;t++){let n=r>>>8&255;n^=255&e[t],n^=n>>>4,r=r<<8&65535,r^=n,n=n<<5&65535,r^=n,n=n<<7&65535,r^=n}return r});let tn=[0,4489,8978,12955,17956,22445,25910,29887,35912,40385,44890,48851,51820,56293,59774,63735,4225,264,13203,8730,22181,18220,30135,25662,40137,36160,49115,44626,56045,52068,63999,59510,8450,12427,528,5017,26406,30383,17460,21949,44362,48323,36440,40913,60270,64231,51324,55797,12675,8202,4753,792,30631,26158,21685,17724,48587,44098,40665,36688,64495,60006,55549,51572,16900,21389,24854,28831,1056,5545,10034,14011,52812,57285,60766,64727,34920,39393,43898,47859,21125,17164,29079,24606,5281,1320,14259,9786,57037,53060,64991,60502,39145,35168,48123,43634,25350,29327,16404,20893,9506,13483,1584,6073,61262,65223,52316,56789,43370,47331,35448,39921,29575,25102,20629,16668,13731,9258,5809,1848,65487,60998,56541,52564,47595,43106,39673,35696,33800,38273,42778,46739,49708,54181,57662,61623,2112,6601,11090,15067,20068,24557,28022,31999,38025,34048,47003,42514,53933,49956,61887,57398,6337,2376,15315,10842,24293,20332,32247,27774,42250,46211,34328,38801,58158,62119,49212,53685,10562,14539,2640,7129,28518,32495,19572,24061,46475,41986,38553,34576,62383,57894,53437,49460,14787,10314,6865,2904,32743,28270,23797,19836,50700,55173,58654,62615,32808,37281,41786,45747,19012,23501,26966,30943,3168,7657,12146,16123,54925,50948,62879,58390,37033,33056,46011,41522,23237,19276,31191,26718,7393,3432,16371,11898,59150,63111,50204,54677,41258,45219,33336,37809,27462,31439,18516,23005,11618,15595,3696,8185,63375,58886,54429,50452,45483,40994,37561,33584,31687,27214,22741,18780,15843,11370,7921,3960];"undefined"!=typeof Int32Array&&(tn=new Int32Array(tn));Vr("kermit",(e,t)=>{let r=void 0!==t?~~t:0;for(let t=0;t<e.length;t++)r=65535&(tn[255&(r^e[t])]^r>>8);return r});let rn=[0,8801531,9098509,825846,9692897,1419802,1651692,10452759,10584377,2608578,2839604,11344079,3303384,11807523,12104405,4128302,12930697,4391538,5217156,13227903,5679208,13690003,14450021,5910942,6606768,14844747,15604413,6837830,16197969,7431594,8256604,16494759,840169,9084178,8783076,18463,10434312,1670131,1434117,9678590,11358416,2825259,2590173,10602790,4109873,12122826,11821884,3289031,13213536,5231515,4409965,12912278,5929345,14431610,13675660,5693559,6823513,15618722,14863188,6588335,16513208,8238147,7417269,16212302,1680338,10481449,9664223,1391140,9061683,788936,36926,8838341,12067563,4091408,3340262,11844381,2868234,11372785,10555655,2579964,14478683,5939616,5650518,13661357,5180346,13190977,12967607,4428364,8219746,16457881,16234863,7468436,15633027,6866552,6578062,14816117,1405499,9649856,10463030,1698765,8819930,55329,803287,9047340,11858690,3325945,4072975,12086004,2561507,10574104,11387118,2853909,13647026,5664841,5958079,14460228,4446803,12949160,13176670,5194661,7454091,16249200,16476294,8201341,14834538,6559633,6852199,15647388,3360676,11864927,12161705,4185682,10527045,2551230,2782280,11286707,9619101,1346150,1577872,10379115,73852,8875143,9172337,899466,16124205,7357910,8182816,16421083,6680524,14918455,15678145,6911546,5736468,13747439,14507289,5968354,12873461,4334094,5159928,13170435,4167245,12180150,11879232,3346363,11301036,2767959,2532769,10545498,10360692,1596303,1360505,9604738,913813,9157998,8856728,92259,16439492,8164415,7343561,16138546,6897189,15692510,14936872,6662099,5986813,14488838,13733104,5750795,13156124,5174247,4352529,12855018,2810998,11315341,10498427,2522496,12124823,4148844,3397530,11901793,9135439,862644,110658,8912057,1606574,10407765,9590435,1317464,15706879,6940164,6651890,14889737,8145950,16384229,16161043,7394792,5123014,13133629,12910283,4370992,14535975,5997020,5707818,13718737,2504095,10516836,11329682,2796649,11916158,3383173,4130419,12143240,8893606,129117,876971,9121104,1331783,9576124,10389322,1625009,14908182,6633453,6925851,15721184,7380471,16175372,16402682,8127489,4389423,12891860,13119266,5137369,13704398,5722165,6015427,14517560];"undefined"!=typeof Int32Array&&(rn=new Int32Array(rn));Vr("crc-24",(e,t)=>{let r=void 0!==t?~~t:11994318;for(let t=0;t<e.length;t++)r=16777215&(rn[255&(r>>16^e[t])]^r<<8);return r});let nn=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];"undefined"!=typeof Int32Array&&(nn=new Int32Array(nn));const an=Vr("crc-32",(e,t)=>{let r=0===t?0:-1^t;for(let t=0;t<e.length;t++)r=nn[255&(r^e[t])]^r>>>8;return-1^r});let sn=[0,79764919,159529838,222504665,319059676,398814059,445009330,507990021,638119352,583659535,797628118,726387553,890018660,835552979,1015980042,944750013,1276238704,1221641927,1167319070,1095957929,1595256236,1540665371,1452775106,1381403509,1780037320,1859660671,1671105958,1733955601,2031960084,2111593891,1889500026,1952343757,2552477408,2632100695,2443283854,2506133561,2334638140,2414271883,2191915858,2254759653,3190512472,3135915759,3081330742,3009969537,2905550212,2850959411,2762807018,2691435357,3560074640,3505614887,3719321342,3648080713,3342211916,3287746299,3467911202,3396681109,4063920168,4143685023,4223187782,4286162673,3779000052,3858754371,3904687514,3967668269,881225847,809987520,1023691545,969234094,662832811,591600412,771767749,717299826,311336399,374308984,453813921,533576470,25881363,88864420,134795389,214552010,2023205639,2086057648,1897238633,1976864222,1804852699,1867694188,1645340341,1724971778,1587496639,1516133128,1461550545,1406951526,1302016099,1230646740,1142491917,1087903418,2896545431,2825181984,2770861561,2716262478,3215044683,3143675388,3055782693,3001194130,2326604591,2389456536,2200899649,2280525302,2578013683,2640855108,2418763421,2498394922,3769900519,3832873040,3912640137,3992402750,4088425275,4151408268,4197601365,4277358050,3334271071,3263032808,3476998961,3422541446,3585640067,3514407732,3694837229,3640369242,1762451694,1842216281,1619975040,1682949687,2047383090,2127137669,1938468188,2001449195,1325665622,1271206113,1183200824,1111960463,1543535498,1489069629,1434599652,1363369299,622672798,568075817,748617968,677256519,907627842,853037301,1067152940,995781531,51762726,131386257,177728840,240578815,269590778,349224269,429104020,491947555,4046411278,4126034873,4172115296,4234965207,3794477266,3874110821,3953728444,4016571915,3609705398,3555108353,3735388376,3664026991,3290680682,3236090077,3449943556,3378572211,3174993278,3120533705,3032266256,2961025959,2923101090,2868635157,2813903052,2742672763,2604032198,2683796849,2461293480,2524268063,2284983834,2364738477,2175806836,2238787779,1569362073,1498123566,1409854455,1355396672,1317987909,1246755826,1192025387,1137557660,2072149281,2135122070,1912620623,1992383480,1753615357,1816598090,1627664531,1707420964,295390185,358241886,404320391,483945776,43990325,106832002,186451547,266083308,932423249,861060070,1041341759,986742920,613929101,542559546,756411363,701822548,3316196985,3244833742,3425377559,3370778784,3601682597,3530312978,3744426955,3689838204,3819031489,3881883254,3928223919,4007849240,4037393693,4100235434,4180117107,4259748804,2310601993,2373574846,2151335527,2231098320,2596047829,2659030626,2470359227,2550115596,2947551409,2876312838,2788305887,2733848168,3165939309,3094707162,3040238851,2985771188];"undefined"!=typeof Int32Array&&(sn=new Int32Array(sn));Vr("crc-32-mpeg",(e,t)=>{let r=void 0!==t?~~t:4294967295;for(let t=0;t<e.length;t++)r=sn[255&(r>>24^e[t])]^r<<8;return r});let on=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];"undefined"!=typeof Int32Array&&(on=new Int32Array(on));Vr("jam",(e,t=-1)=>{let r=0===t?0:~~t;for(let t=0;t<e.length;t++)r=on[255&(r^e[t])]^r>>>8;return r});var cn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function ln(e,t){const r=new Uint8Array(e),n=Ur()(r).filter(e=>{if("tEXt"!==e.name)return!0;const t=Hr.decode(e.data).keyword.toLowerCase();return"chara"!==t&&"ccv3"!==t}),i=JSON.stringify(t),a=btoa(unescape(encodeURIComponent(i))),s=Hr.encode("chara",a),o=Object.assign(Object.assign({},t),{spec:"chara_card_v3",spec_version:"3.0"}),c=JSON.stringify(o),l=btoa(unescape(encodeURIComponent(c))),d=Hr.encode("ccv3",l);n.splice(-1,0,s,d);const u=function(e){const t=new Uint8Array(4),r=new Int32Array(t.buffer),n=new Uint32Array(t.buffer);let i=8;for(const t of e)i+=t.data.length+12;const a=new Uint8Array(i);let s=8;a[0]=137,a[1]=80,a[2]=78,a[3]=71,a[4]=13,a[5]=10,a[6]=26,a[7]=10;for(const{name:i,data:o}of e){const e=o.length,c=new Uint8Array([i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);n[0]=e,a[s++]=t[3],a[s++]=t[2],a[s++]=t[1],a[s++]=t[0],a[s++]=c[0],a[s++]=c[1],a[s++]=c[2],a[s++]=c[3];for(let t=0;t<e;t++)a[s++]=o[t];const l=an(o,an(c));r[0]=l,a[s++]=t[3],a[s++]=t[2],a[s++]=t[1],a[s++]=t[0]}return a}(n);return new Blob([u.slice().buffer],{type:"image/png"})}function dn(e,t,r){return cn(this,void 0,void 0,function*(){const n=yield function(e){return cn(this,void 0,void 0,function*(){try{const t=yield fetch(`/characters/${encodeURIComponent(e)}`);return t.ok?yield t.arrayBuffer():null}catch(e){return null}})}(e);if(!n)return!1;try{const e=ln(n,t),i=URL.createObjectURL(e),a=document.createElement("a");return a.href=i,a.download=r,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>URL.revokeObjectURL(i),100),!0}catch(e){return!1}})}var un=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};var pn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function fn(){return pn(this,void 0,void 0,function*(){const e=J();if(!e.character)return void v.oR.warning("No character selected");if(!e.stageResults.rewrite)return void v.oR.warning("No rewrite results available");const t=e.character,r=e.stageResults.rewrite.output,n=SillyTavern.libs.DOMPurify,i=I(t),a=new Map(i.map(e=>[e.key,e])),s=[],o=a.get("alternate_greetings");o&&Array.isArray(o.rawValue)&&s.push(...o.rawValue);const c=v.IF.filter(Mr).map(e=>{var t,r,i,o;const c=a.get(e.key);if("alternate_greetings"===e.key){const t=s.length>0?s.map((e,t)=>{const r=n.sanitize(e);return`\n                        <div class="cr-apply-greetings__item">\n                            <span class="cr-apply-greetings__label">Greeting ${t+1}</span>\n                            <textarea\n                                class="cr-apply-textarea cr-apply-greeting text_pole"\n                                data-field-key="alternate_greetings"\n                                data-greeting-index="${t}"\n                                data-original="${encodeURIComponent(e)}"\n                                rows="4"\n                                placeholder="Greeting ${t+1}..."\n                            >${r}</textarea>\n                        </div>\n                    `}).join(""):'<p class="cr-text-sm cr-text-dim">No alternate greetings defined</p>';return`\n                <details class="cr-apply-field" data-field-key="${e.key}">\n                    <summary class="cr-apply-field__header">\n                        <span class="cr-apply-field__label">${e.label}</span>\n                        <span class="cr-apply-field__badge ${s.length>0?"cr-apply-field__badge--filled":"cr-apply-field__badge--empty"}">\n                            ${s.length>0?`${s.length} greeting${s.length>1?"s":""}`:"empty"}\n                        </span>\n                        <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                    </summary>\n                    <div class="cr-apply-field__content">\n                        <div class="cr-apply-greetings">\n                            ${t}\n                            <button type="button" class="cr-apply-greetings__add" data-action="add-greeting">\n                                <i class="fa-solid fa-plus"></i> Add Greeting\n                            </button>\n                        </div>\n                    </div>\n                </details>\n            `}if("depth_prompt"===e.key&&c){const a=c.rawValue,s=a.prompt||"",l=`Depth: ${null!==(t=a.depth)&&void 0!==t?t:4}, Role: ${null!==(r=a.role)&&void 0!==r?r:"system"}`,d=n.sanitize(s);return`\n                <details class="cr-apply-field" data-field-key="${e.key}">\n                    <summary class="cr-apply-field__header">\n                        <span class="cr-apply-field__label">${e.label}</span>\n                        <span class="cr-apply-field__badge cr-apply-field__badge--filled">\n                            ${l}\n                        </span>\n                        <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                    </summary>\n                    <div class="cr-apply-field__content">\n                        <textarea\n                            class="cr-apply-textarea text_pole"\n                            data-field-key="${e.key}"\n                            data-field-type="depth_prompt"\n                            data-original="${encodeURIComponent(s)}"\n                            data-depth="${null!==(i=a.depth)&&void 0!==i?i:4}"\n                            data-role="${null!==(o=a.role)&&void 0!==o?o:"system"}"\n                            rows="6"\n                            placeholder="Depth prompt content..."\n                        >${d}</textarea>\n                    </div>\n                </details>\n            `}const l=c?Br(c):"",d=l.length>0,u=n.sanitize(l);return`\n            <details class="cr-apply-field" data-field-key="${e.key}">\n                <summary class="cr-apply-field__header">\n                    <span class="cr-apply-field__label">${e.label}</span>\n                    <span class="cr-apply-field__badge cr-apply-field__tokens ${d?"cr-apply-field__badge--filled":"cr-apply-field__badge--empty"}" data-field="${e.key}">\n                        ${d?"...":"empty"}\n                    </span>\n                    <span class="cr-apply-field__dirty" style="display: none;">modified</span>\n                </summary>\n                <div class="cr-apply-field__content">\n                    <textarea\n                        class="cr-apply-textarea text_pole"\n                        data-field-key="${e.key}"\n                        data-original="${encodeURIComponent(l)}"\n                        rows="6"\n                        placeholder="Paste content here..."\n                    >${u}</textarea>\n                </div>\n            </details>\n        `}).join(""),l=`\n        <div class="cr-apply-dialog cr-apply-dialog--split">\n            <div class="cr-apply-split">\n                \x3c!-- Left Panel: Rewrite Output --\x3e\n                <div class="cr-apply-panel cr-apply-panel--source">\n                    <div class="cr-apply-panel__header">\n                        <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        <span>Rewrite Output</span>\n                    </div>\n                    <textarea\n                        class="cr-apply-source text_pole"\n                        readonly\n                        spellcheck="false"\n                    >${n.sanitize(r)}</textarea>\n                </div>\n\n                \x3c!-- Right Panel: Character Fields --\x3e\n                <div class="cr-apply-panel cr-apply-panel--fields">\n                    <div class="cr-apply-panel__header">\n                        <i class="fa-solid fa-user-pen"></i>\n                        <span>Character Fields</span>\n                    </div>\n                    <div class="cr-apply-fields-list">\n                        ${c}\n                    </div>\n                </div>\n            </div>\n\n            <div class="cr-apply-footer">\n                <p class="cr-text-sm cr-text-dim">\n                    Copy from the rewrite output and paste into the fields you want to update.\n                    Modified fields are highlighted. Changes are only saved when you click an action button.\n                </p>\n            </div>\n        </div>\n    `,d=SillyTavern.getContext(),u=new Map,p=[...s];let f=!1;const m=e=>{const t=e.target;if(!t.matches(".cr-apply-textarea"))return;const r=t.dataset.fieldKey,n=t.dataset.greetingIndex,i=t.dataset.original||"",a=decodeURIComponent(i),o=t.value!==a;if("alternate_greetings"===r&&void 0!==n){const e=parseInt(n,10);p[e]=t.value,o&&(f=!0);const r=p.some((e,t)=>e!==(s[t]||""))||p.length!==s.length,i=t.closest(".cr-apply-field"),a=null==i?void 0:i.querySelector(".cr-apply-field__dirty");return i&&i.classList.toggle("cr-apply-field--dirty",r),void(a&&(a.style.display=r?"inline":"none"))}const c=t.closest(".cr-apply-field"),l=null==c?void 0:c.querySelector(".cr-apply-field__dirty");c&&c.classList.toggle("cr-apply-field--dirty",o),l&&(l.style.display=o?"inline":"none"),r&&(o?u.set(r,t.value):u.delete(r))},g=e=>{const t=e.target.closest('[data-action="add-greeting"]');if(!t)return;e.preventDefault();const r=t.closest(".cr-apply-greetings");if(!r)return;const n=p.length;p.push(""),f=!0;const i=document.createElement("div");i.className="cr-apply-greetings__item",i.innerHTML=`\n            <span class="cr-apply-greetings__label">Greeting ${n+1} (new)</span>\n            <textarea\n                class="cr-apply-textarea cr-apply-greeting text_pole"\n                data-field-key="alternate_greetings"\n                data-greeting-index="${n}"\n                data-original=""\n                rows="4"\n                placeholder="New greeting..."\n            ></textarea>\n        `,r.insertBefore(i,t);const a=r.closest(".cr-apply-field"),s=null==a?void 0:a.querySelector(".cr-apply-field__dirty");a&&a.classList.add("cr-apply-field--dirty"),s&&(s.style.display="inline")};document.addEventListener("input",m),document.addEventListener("click",g);const h=setTimeout(()=>function(e){return Dr(this,void 0,void 0,function*(){const t=[];for(const[r,n]of e){if("alternate_greetings"===r)continue;const e=Br(n);e&&t.push({key:r,text:e})}if(0===t.length)return;const r=yield(0,v.gg)(t);for(const{key:e,tokens:t}of r){const r=document.querySelector(`.cr-apply-field__tokens[data-field="${e}"]`);r&&null!==t&&(r.textContent=`${$e(t)} tokens`)}})}(a),50),y=yield d.callGenericPopup(l,d.POPUP_TYPE.CONFIRM,"",{okButton:"Apply to Card",cancelButton:"Cancel",customButtons:["Download PNG","Download JSON"],wide:!0,large:!0});if(clearTimeout(h),document.removeEventListener("input",m),document.removeEventListener("click",g),!1===y||void 0===y)return;const b=Array.from(u.entries()).map(([e,t])=>({key:e,value:t}));if(f){const e=p.filter(e=>e.trim());(e.length>0||s.length>0)&&b.push({key:"alternate_greetings",value:e.join("\n---\n")})}0!==b.length?!0===y||1===y?yield function(e,t,r){return un(this,void 0,void 0,function*(){let n=0;for(const i of r){const r="alternate_greetings"===i.key?i.value.split("\n---\n").filter(e=>e.trim()):i.value;(yield(0,v.ch)(e,t,i.key,r))?n++:v.oR.error(`Failed to update ${i.key}`)}if(n>0){const e=SillyTavern.getContext();yield e.getCharacters(),v.oR.success(`Applied ${n} field${n>1?"s":""} to character!`)}})}(t.avatar,t.name,b):2===y?yield function(e,t,r){return un(this,void 0,void 0,function*(){const n=yield(0,v.oN)(e);if(n){for(const e of r){const t="alternate_greetings"===e.key?e.value.split("\n---\n").filter(e=>e.trim()):e.value;n[e.key]=t,n.data&&"object"==typeof n.data&&(n.data[e.key]=t)}(yield dn(e,n,`${t}_refined.png`))?v.oR.success("PNG downloaded! (Original character unchanged)"):v.oR.error("Failed to create PNG")}else v.oR.error("Failed to get character data")})}(t.avatar,t.name,b):3===y?yield function(e,t){return un(this,void 0,void 0,function*(){const r=J();if(!r.character)return;const n=yield(0,v.oN)(e);if(!n)return void v.oR.error("Failed to get character data");for(const e of t){const t="alternate_greetings"===e.key?e.value.split("\n---\n").filter(e=>e.trim()):e.value;n[e.key]=t,n.data&&"object"==typeof n.data&&(n.data[e.key]=t)}const i=JSON.stringify(n,null,2),a=new Blob([i],{type:"application/json"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`${r.character.name}_updated.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s),v.oR.success("JSON downloaded!")})}(t.avatar,b):v.Rm.warn("Unknown result from apply dialog:",y):v.oR.info("No changes to apply")})}var mn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};var gn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};var hn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};const vn={pending:"",running:"fa-spinner fa-spin",complete:"fa-check",error:"fa-exclamation"},yn={pending:"",running:"cr-stage-tab--running",complete:"cr-stage-tab--complete",error:"cr-stage-tab--error"};function bn(e){const t=J(),r=t.activeStage===e,n=t.stageStatus[e],i=vn[n],a=i?`<span class="cr-stage-tab__status"><i class="fa-solid ${i}"></i></span>`:"";return`\n        <button class="cr-stage-tab ${Se(r&&"cr-stage-tab--active")} ${yn[n]}"\n                data-stage="${e}"\n                role="tab"\n                aria-selected="${r}"\n                type="button">\n            <i class="fa-solid ${v.iu[e]} cr-stage-tab__icon"></i>\n            <span class="cr-stage-tab__label">${v.BA[e]}</span>\n            ${a}\n        </button>\n    `}const _n=Ie(()=>`\n        <nav class="cr-stage-tabs" role="tablist" aria-label="Pipeline stages">\n            ${v.an.map(bn).join("")}\n        </nav>\n    `,{name:"StageTabs"}),wn=Ie(()=>{const e=SillyTavern.libs.DOMPurify,t=J(),r=t.character&&!t.isGenerating,n=!!t.stageResults[t.activeStage],i=!(!t.stageResults.score||t.stageResults.score.error||!t.stageResults.rewrite||t.stageResults.rewrite.error||!t.stageResults.analyze||t.stageResults.analyze.error),a=r&&t.stageResults.analyze&&!t.stageResults.analyze.error;if(t.isGenerating)return`\n            <div class="cr-pipeline-controls cr-pipeline-controls--generating">\n                <div class="cr-pipeline-status">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Generating...</span>\n                </div>\n                <button id="${v.pW}_abort"\n                        class="menu_button menu_button--danger menu_button--sm"\n                        type="button">\n                    <i class="fa-solid fa-stop"></i>\n                    Stop\n                </button>\n            </div>\n        `;return`\n        <div class="cr-pipeline-controls">\n            ${n?`\n            <button id="${v.pW}_run_stage"\n                    class="menu_button menu_button--icon"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Regenerate ${v.BA[t.activeStage]}">\n                <i class="fa-solid fa-rotate"></i>\n            </button>`:`\n            <button id="${v.pW}_run_stage"\n                    class="menu_button ${i?"":"menu_button--primary"}"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Run ${v.BA[t.activeStage]}">\n                <i class="fa-solid fa-play"></i>\n                Run\n            </button>`}\n            ${i?"":`\n            <button id="${v.pW}_run_all"\n                    class="menu_button"\n                    type="button"\n                    ${r?"":"disabled"}\n                    title="Run all stages: Score  Rewrite  Analyze">\n                <i class="fa-solid fa-forward"></i>\n                All\n            </button>`}\n            ${`\n        <button id="${v.pW}_reset"\n                class="menu_button menu_button--icon menu_button--ghost"\n                type="button"\n                title="Clear all results and start fresh">\n            <i class="fa-solid fa-eraser"></i>\n        </button>`}\n            ${a?`\n            <div class="cr-iteration-controls">\n                <input type="text"\n                       id="${v.pW}_guidance_input"\n                       class="cr-iteration-controls__input"\n                       placeholder="Guidance..."\n                       value="${e.sanitize(J().userGuidance)}"\n                       title="Optional: Focus areas or constraints for the next iteration"/>\n                <button id="${v.pW}_iterate"\n                        class="menu_button menu_button--primary"\n                        type="button"\n                        title="Refine with feedback, then re-analyze (Iteration ${t.iterationCount+1})">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    Iterate\n                </button>\n            </div>`:""}\n        </div>\n    `},{name:"PipelineControls"});function xn(){const e=_e(".cr-stage-tabs");e&&(e.innerHTML=v.an.map(bn).join(""))}function $n(){const e=_e(`#${v.pW}_pipeline_controls`);e&&(e.innerHTML=wn(),Rn(e))}function kn(){return hn(this,void 0,void 0,function*(){const e=J();xn(),$n(),yield function(e){return pe(this,arguments,void 0,function*(e,t={}){var r,n,i,a,s;const{stages:o=[...v.an],callbacks:c}=t;if(!e.character)return v.Rm.warn("Cannot execute pipeline: no character selected"),{score:null,rewrite:null,analyze:null};if(e.isGenerating)return v.Rm.warn("Cannot execute pipeline: generation already in progress"),{score:null,rewrite:null,analyze:null};const l=new AbortController;ge(!0,l),k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}});const d={score:e.stageResults.score,rewrite:e.stageResults.rewrite,analyze:e.stageResults.analyze};try{for(const e of o){if(l.signal.aborted){v.Rm.debug("Pipeline aborted");break}const t=ye(e);if(!t)break;t.previousResults=d,me(e,"running"),null===(r=null==c?void 0:c.onStageStart)||void 0===r||r.call(c,e),null===(n=null==c?void 0:c.onProgress)||void 0===n||n.call(c,`Running ${e}...`);const s=yield N(t,fe,{signal:l.signal,onProgress:e=>{var t;v.Rm.debug(`[Pipeline] ${e}`),null===(t=null==c?void 0:c.onProgress)||void 0===t||t.call(c,e)}});if(d[e]=s,ve(s),null===(i=null==c?void 0:c.onStageComplete)||void 0===i||i.call(c,e,s),s.error){null===(a=null==c?void 0:c.onError)||void 0===a||a.call(c,e,s.error);break}}}catch(e){const t=e instanceof Error?e.message:"Unknown error";v.Rm.error("Pipeline execution failed:",e),null===(s=null==c?void 0:c.onError)||void 0===s||s.call(c,J().activeStage,t)}finally{he(l)}return d})}(e,{callbacks:{onStageStart:()=>{xn()},onStageComplete:()=>{Nr(),xn()},onProgress:()=>{$n()},onError:()=>{xn(),$n()}}}),xn(),$n()})}function Sn(){return hn(this,void 0,void 0,function*(){const e=J();xn(),$n(),yield function(e){return pe(this,arguments,void 0,function*(e,t={}){var r,n,i,a,s,o,c,l,d,u;const{callbacks:p}=t;if(!e.character)return v.Rm.warn("Cannot execute quick iterate: no character selected"),{rewrite:null,analyze:null};if(e.isGenerating)return v.Rm.warn("Cannot execute quick iterate: generation already in progress"),{rewrite:null,analyze:null};if(!e.stageResults.analyze)return v.Rm.warn("Cannot execute quick iterate: no analyze result available"),{rewrite:null,analyze:null};const f=new AbortController;ge(!0,f);const m=J();k("results",{iterationCount:m.iterationCount+1});const g={rewrite:null,analyze:null};try{const e=ye("rewrite");if(!e)return g;e.isRefinement=!0,me("rewrite","running"),null===(r=null==p?void 0:p.onStageStart)||void 0===r||r.call(p,"rewrite"),null===(n=null==p?void 0:p.onProgress)||void 0===n||n.call(p,"Refining rewrite with feedback...");const t=yield N(e,fe,{signal:f.signal,onProgress:e=>{var t;v.Rm.debug(`[Pipeline] ${e}`),null===(t=null==p?void 0:p.onProgress)||void 0===t||t.call(p,e)}});if(g.rewrite=t,ve(t),null===(i=null==p?void 0:p.onStageComplete)||void 0===i||i.call(p,"rewrite",t),t.error)return null===(a=null==p?void 0:p.onError)||void 0===a||a.call(p,"rewrite",t.error),g;if(f.signal.aborted)return v.Rm.debug("Quick iterate aborted"),g;const u=ye("analyze");if(!u)return g;u.previousResults=Object.assign(Object.assign({},u.previousResults),{rewrite:t}),me("analyze","running"),null===(s=null==p?void 0:p.onStageStart)||void 0===s||s.call(p,"analyze"),null===(o=null==p?void 0:p.onProgress)||void 0===o||o.call(p,"Analyzing refined version...");const m=yield N(u,fe,{signal:f.signal,onProgress:e=>{var t;v.Rm.debug(`[Pipeline] ${e}`),null===(t=null==p?void 0:p.onProgress)||void 0===t||t.call(p,e)}});return g.analyze=m,ve(m),null===(c=null==p?void 0:p.onStageComplete)||void 0===c||c.call(p,"analyze",m),m.error&&(null===(l=null==p?void 0:p.onError)||void 0===l||l.call(p,"analyze",m.error)),null===(d=null==p?void 0:p.onIterateComplete)||void 0===d||d.call(p),g}catch(e){const t=e instanceof Error?e.message:"Unknown error";return v.Rm.error("Quick iterate failed:",e),null===(u=null==p?void 0:p.onError)||void 0===u||u.call(p,J().activeStage,t),g}finally{he(f)}})}(e,{callbacks:{onStageStart:e=>{xn(),$n()},onStageComplete:()=>{Nr(),xn(),$n()},onError:()=>{xn(),$n()},onIterateComplete:()=>{oe("analyze"),xn(),bt(),Nr()}}}),$n()})}let Pn=[];function Rn(e){Pn.forEach(e=>e()),Pn=[];const t=_e(`#${v.pW}_guidance_input`,e);if(t){const e=()=>{var e;e=t.value,k("guidance",{userGuidance:e}),Y()};Pn.push(xe(t,"change",e)),Pn.push(xe(t,"blur",e))}const r=_e(`#${v.pW}_run_stage`,e);r&&Pn.push(xe(r,"click",()=>{(function(e){return hn(this,void 0,void 0,function*(){const t=J();xn(),$n(),yield be(t,{stage:e,callbacks:{onStageStart:()=>{xn(),$n()},onStageComplete:()=>{Nr(),xn(),$n()},onError:()=>{xn(),$n()}}}),"rewrite"===e&&t.stageResults.rewrite&&!t.stageResults.rewrite.error&&(yield be(t,{stage:"analyze",callbacks:{onStageStart:()=>{xn(),$n()},onStageComplete:()=>{Nr(),xn(),$n()},onError:()=>{xn(),$n()}}})),$n()})})(J().activeStage).catch(e=>{v.Rm.error("Stage execution failed",e)})}));const n=_e(`#${v.pW}_run_all`,e);n&&Pn.push(xe(n,"click",()=>{kn().catch(e=>{v.Rm.error("All stages execution failed",e)})}));const i=_e(`#${v.pW}_iterate`,e);i&&Pn.push(xe(i,"click",()=>{Sn().catch(e=>{v.Rm.error("Quick iterate failed",e)})}));const a=_e(`#${v.pW}_reset`,e);a&&Pn.push(xe(a,"click",()=>{J(),S(()=>{k("pipeline",{stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"}}),k("results",{stageResults:{score:null,rewrite:null,analyze:null},iterationCount:0}),k("session",{hasUnsavedChanges:!0})}),xn(),Nr(),$n()}));const s=_e(`#${v.pW}_abort`,e);s&&Pn.push(xe(s,"click",()=>{var e;(e=J()).abortController&&(e.abortController.abort(),k("pipeline",{abortController:null,isGenerating:!1}),v.Rm.debug("Pipeline aborted by user")),xn(),$n()}))}var An=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};let Cn=!1,En=null;function In(e){Cn=e;const t=_e(`#${v.pW}_session_dropdown`);t&&t.classList.toggle("cr-dropdown--open",e);const r=_e(`#${v.pW}_session_trigger`);r&&r.setAttribute("aria-expanded",String(e)),e||(En=null)}function On(e){return e.name?e.name:(t=e.updatedAt,(0,SillyTavern.libs.moment)(t).calendar(null,{sameDay:"[Today] h:mm A",lastDay:"[Yesterday] h:mm A",lastWeek:"ddd, h:mm A",sameElse:"MMM D, h:mm A"}));var t}function zn(){const e=J(),t=e.sessions;return e.character?0===t.length?'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-folder-open"></i>\n                No sessions yet\n            </div>\n        ':t.map(t=>function(e,t){var r,n;const i=SillyTavern.libs.DOMPurify,a=On(e),s=En===e.id,o=Object.keys(null!==(n=null===(r=e.stageFields)||void 0===r?void 0:r.base)&&void 0!==n?n:{}).length,c=e.history.length;return`\n        <div class="cr-session-option ${Se(t&&"cr-session-option--active")}"\n             data-session-id="${e.id}"\n             role="option"\n             aria-selected="${t}">\n            <div class="cr-session-option__content">\n                ${s?`\n                    <input type="text"\n                           class="cr-session-option__name-input"\n                           value="${i.sanitize(e.name||"")}"\n                           placeholder="Session name..."\n                           autocomplete="off"\n                           data-session-id="${e.id}" />\n                `:`\n                    <div class="cr-session-option__name">\n                        ${t?'<i class="fa-solid fa-circle cr-session-option__indicator"></i>':""}\n                        <span>${i.sanitize(a)}</span>\n                    </div>\n                `}\n                <div class="cr-session-option__meta">\n                    <span>${o} fields</span>\n                    <span>${c} runs</span>\n                </div>\n            </div>\n            <div class="cr-session-option__actions ${Se(s&&"cr-session-option__actions--editing")}">\n                ${s?`\n                    <button class="cr-session-save menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Save name"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-check"></i>\n                    </button>\n                    <button class="cr-session-cancel menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Cancel">\n                        <i class="fa-solid fa-times"></i>\n                    </button>\n                `:`\n                    <button class="cr-session-edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Rename session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-pencil"></i>\n                    </button>\n                    <button class="cr-session-delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Delete session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                `}\n            </div>\n        </div>\n    `}(t,t.id===e.activeSessionId)).join(""):'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-user-slash"></i>\n                Select a character first\n            </div>\n        '}const Tn=Ie(()=>{const e=J(),t=e.sessions.find(t=>t.id===e.activeSessionId),r=!!e.character;let n="New Session";r?t&&(n=On(t)):n="Select character...";const i=e.sessions.length;return`\n        <div id="${v.pW}_session_dropdown" class="cr-dropdown cr-dropdown--session ${Se(Cn&&"cr-dropdown--open")} ${Se(!r&&"cr-dropdown--disabled")}">\n            <button id="${v.pW}_session_trigger"\n                    class="cr-dropdown__trigger cr-dropdown__trigger--session"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${Cn}"\n                    ${r?"":"disabled"}>\n                <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n                <span class="cr-dropdown__trigger-text ${Se(!t&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(n)}</span>\n                ${i>0?`<span class="cr-dropdown__count">${i}</span>`:""}\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel cr-dropdown__panel--session" role="listbox">\n                <div id="${v.pW}_session_list" class="cr-dropdown__list cr-dropdown__list--session cr-scrollable">\n                    ${zn()}\n                </div>\n                <div class="cr-dropdown__footer">\n                    <button id="${v.pW}_new_session_btn"\n                            class="menu_button menu_button--sm menu_button--primary cr-dropdown__new-btn"\n                            type="button"\n                            ${r?"":"disabled"}>\n                        <i class="fa-solid fa-plus"></i>\n                        New Session\n                    </button>\n                    ${i>0?`\n                    <button id="${v.pW}_delete_all_sessions_btn"\n                            class="menu_button menu_button--sm menu_button--ghost cr-dropdown__delete-all-btn"\n                            type="button"\n                            title="Delete all sessions for this character">\n                        <i class="fa-solid fa-trash"></i>\n                        Delete All\n                    </button>\n                    `:""}\n                </div>\n            </div>\n        </div>\n    `},{name:"SessionDropdown"});function Wn(){const e=_e(`#${v.pW}_session_dropdown`);if(!e)return;const t=J(),r=t.sessions.find(e=>e.id===t.activeSessionId),n=!!t.character;e.classList.toggle("cr-dropdown--disabled",!n);const i=_e(`#${v.pW}_session_trigger`);if(i){i.disabled=!n;let e="New Session";n?r&&(e=On(r)):e="Select character...";const a=t.sessions.length;i.innerHTML=`\n            <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n            <span class="cr-dropdown__trigger-text ${Se(!r&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(e)}</span>\n            ${a>0?`<span class="cr-dropdown__count">${a}</span>`:""}\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const a=_e(`#${v.pW}_new_session_btn`);a&&(a.disabled=!n);const s=_e(`#${v.pW}_session_list`);s&&(s.innerHTML=zn());const o=t.sessions.length,c=_e(".cr-dropdown__footer",e);if(c){const e=_e(`#${v.pW}_delete_all_sessions_btn`,c);if(o>0&&!e){const e=document.createElement("button");e.id=`${v.pW}_delete_all_sessions_btn`,e.className="menu_button menu_button--sm menu_button--ghost cr-dropdown__delete-all-btn",e.type="button",e.title="Delete all sessions for this character",e.innerHTML='<i class="fa-solid fa-trash"></i> Delete All',c.appendChild(e),e.addEventListener("click",e=>An(this,void 0,void 0,function*(){e.stopPropagation();const t=J().sessions.length;if(yield v.lY.confirm("Delete All Sessions",`Are you sure you want to delete all ${t} session${1!==t?"s":""} for this character? This cannot be undone.`))try{const e=yield ee();e.success?(v.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""}`),In(!1),Wn(),Ue()):v.oR.error("Failed to delete sessions")}catch(e){v.oR.error("Failed to delete sessions"),v.Rm.error("Delete all sessions error:",e)}}))}else 0===o&&e&&e.remove()}}const jn={isOpen:!1};let Ln=[],Nn={};function Dn(){return jn.isOpen}function Bn(e){jn.isOpen=e}function Mn(e){Ln.push(e)}function Fn(){Ln.forEach(e=>e()),Ln=[]}const Un=Ie(e=>{const t=SillyTavern.libs.DOMPurify,r=(0,y.getSettings)(),n=e.isReady?"cr-api-banner--ready":"cr-api-banner--error",i=e.isReady?"fa-circle-check":"fa-circle-xmark",a="cc"===e.apiType?"Chat":"Text",s=null!==r.maxTokensOverride,o=s?r.maxTokensOverride:e.maxOutput,c=s?'<i class="fa-solid fa-pen cr-api-banner__override-icon" title="Custom output limit active"></i>':"";return`\n        <div class="cr-api-banner ${n}">\n            <div class="cr-api-banner__left">\n                <i class="fa-solid ${i}"></i>\n                <span class="cr-api-banner__name">${t.sanitize(e.displayName)}</span>\n                <span class="cr-badge cr-badge--small">${a}</span>\n            </div>\n            <div class="cr-api-banner__right">\n                <span class="cr-api-banner__model" title="${t.sanitize(e.model)}">${t.sanitize(e.modelDisplay)}</span>\n                <span class="cr-api-banner__limits ${s?"cr-api-banner__limits--override":""}">${c}${o.toLocaleString()}t max</span>\n            </div>\n        </div>\n        ${e.error?`\n            <div class="cr-api-error">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                <span>${t.sanitize(e.error)}</span>\n            </div>\n        `:""}\n    `},{name:"SettingsApiStatusBanner"}),Hn=Ie(e=>{const t=SillyTavern.libs.DOMPurify;if(!e)return'\n            <div class="cr-profile-info cr-profile-info--empty">\n                <i class="fa-solid fa-circle-question"></i>\n                <span>Select a profile above</span>\n            </div>\n        ';const r="cc"===e.mode?"Chat":"Text";return`\n        <div class="cr-profile-info ${e.isSupported?"":"cr-profile-info--error"}">\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">API</span>\n                <span class="cr-profile-info__value">${t.sanitize(e.api)}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Model</span>\n                <span class="cr-profile-info__value" title="${t.sanitize(e.model)}">${t.sanitize(function(e){const t=e.replace(/^anthropic\//,"").replace(/^openai\//,"").replace(/^google\//,"").replace(/^meta-llama\//,"llama-").replace(/^mistralai\//,"mistral-");return t.length>30?t.substring(0,27)+"...":t}(e.model))}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Type</span>\n                <span class="cr-badge cr-badge--small">${r}</span>\n            </div>\n            ${e.presetName?`\n                <div class="cr-profile-info__row">\n                    <span class="cr-profile-info__label">Preset</span>\n                    <span class="cr-profile-info__value">${t.sanitize(e.presetName)}</span>\n                </div>\n            `:""}\n            ${e.isSupported?"":`\n                <div class="cr-profile-info__error">\n                    <i class="fa-solid fa-triangle-exclamation"></i>\n                    <span>${e.validationError||"Profile configuration is invalid"}</span>\n                </div>\n            `}\n        </div>\n    `},{name:"SettingsProfileInfo"}),Gn=Ie(()=>`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid fa-cog"></i>\n                <h3>${v.hi} Settings</h3>\n            </div>\n            <button id="${v.pW}_settings_close"\n                    class="cr-btn cr-btn--icon cr-btn--ghost menu_button"\n                    type="button"\n                    title="Close settings">\n                <i class="fa-solid fa-xmark"></i>\n            </button>\n        </header>\n    `,{name:"SettingsDrawerHeader"}),qn=Ie(()=>{var e;const t=SillyTavern.libs.DOMPurify,r=(0,y.getSettings)(),n=(0,v.We)(),i=(0,v.Lq)("profile"===r.generationMode?r.profileId:null),a="profile"===r.generationMode&&0===n.length?"current":r.generationMode;return`\n        <div class="cr-drawer__body">\n            \x3c!-- Generation Settings --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-sliders"></i>\n                    Generation\n                </h3>\n\n                \x3c!-- Current API Status --\x3e\n                <div id="${v.pW}_api_status_banner">\n                    ${Un(i)}\n                </div>\n\n                \x3c!-- Mode Toggle --\x3e\n                ${(0,v.mi)()?`\n                <div class="cr-gen-mode-toggle">\n                    <label class="cr-gen-mode-option ${"current"===a?"cr-gen-mode-option--active":""}" data-mode="current">\n                        <input type="radio" name="${v.pW}_gen_mode" value="current" ${"current"===a?"checked":""}/>\n                        <i class="fa-solid fa-sliders"></i>\n                        <span>Current ST Settings</span>\n                    </label>\n                    <label class="cr-gen-mode-option ${"profile"===a?"cr-gen-mode-option--active":""}" data-mode="profile">\n                        <input type="radio" name="${v.pW}_gen_mode" value="profile" ${"profile"===a?"checked":""}/>\n                        <i class="fa-solid fa-plug"></i>\n                        <span>Connection Profile</span>\n                    </label>\n                </div>\n\n                \x3c!-- Profile Selection --\x3e\n                <div id="${v.pW}_profile_section" class="cr-profile-section ${"current"===a?"cr-hidden":""}">\n                    ${n.length>0?`\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">Select Profile</label>\n                        <select id="${v.pW}_profile_select" class="cr-select text_pole">\n                            <option value="">-- Select a profile --</option>\n                            ${n.map(e=>`\n                            <option value="${e.id}"\n                                    ${e.id===r.profileId?"selected":""}\n                                    ${e.isSupported?"":"disabled"}>\n                                ${t.sanitize(e.name)}${e.isSupported?"":" (invalid)"}\n                            </option>\n                            `).join("")}\n                        </select>\n                    </div>\n                    <div id="${v.pW}_profile_info_container">\n                        ${Hn(n.find(e=>e.id===r.profileId)||null)}\n                    </div>\n                    `:'\n                    <div class="cr-profile-empty">\n                        <i class="fa-solid fa-info-circle"></i>\n                        <div>\n                            <strong>No connection profiles found</strong>\n                            <p>Create profiles in SillyTavern\'s Connection Manager to use specific API configurations.</p>\n                        </div>\n                    </div>\n                    '}\n                </div>\n                `:""}\n\n                \x3c!-- Max Tokens Override --\x3e\n                <details class="cr-collapsible">\n                    <summary>Response Length Override</summary>\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">\n                            <input type="checkbox"\n                                   id="${v.pW}_max_tokens_enabled"\n                                   ${null!==r.maxTokensOverride?"checked":""}/>\n                            <span>Override max response tokens</span>\n                        </label>\n                        <input type="number"\n                               id="${v.pW}_max_tokens"\n                               class="cr-number-input text_pole"\n                               value="${null!==(e=r.maxTokensOverride)&&void 0!==e?e:4096}"\n                               min="100"\n                               max="32000"\n                               step="100"\n                               ${null===r.maxTokensOverride?"disabled":""}/>\n                        <span class="cr-setting-hint">\n                            Leave unchecked to use the profile's preset settings\n                        </span>\n                    </div>\n                </details>\n\n                \x3c!-- Advanced Options --\x3e\n                <details class="cr-collapsible">\n                    <summary>Advanced Options</summary>\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label cr-checkbox-label">\n                            <input type="checkbox"\n                                   id="${v.pW}_disable_thinking"\n                                   ${r.disableThinking?"checked":""}/>\n                            <span>Disable reasoning</span>\n                        </label>\n                        <span class="cr-setting-hint">\n                            Disables model reasoning/thinking during generation.\n                            Reasoning is automatically disabled for Anthropic when using structured output.\n                        </span>\n                    </div>\n                    <div class="cr-setting-item cr-mt-3">\n                        <label class="cr-setting-label cr-checkbox-label">\n                            <input type="checkbox"\n                                   id="${v.pW}_use_assistant_prefill"\n                                   ${r.useAssistantPrefill?"checked":""}/>\n                            <span>Enable assistant prefill</span>\n                        </label>\n                        <span class="cr-setting-hint">\n                            Inserts text as the start of the assistant's response to guide output format.\n                        </span>\n                    </div>\n                    <div class="cr-setting-item cr-mt-2" id="${v.pW}_prefill_container" ${r.useAssistantPrefill?"":'style="display: none;"'}>\n                        <label class="cr-setting-label">Prefill Text</label>\n                        <input type="text"\n                               id="${v.pW}_assistant_prefill"\n                               class="cr-input text_pole"\n                               value="${t.sanitize(r.assistantPrefill)}"\n                               placeholder="e.g., { or Here is my analysis:"/>\n                        <span class="cr-setting-hint">\n                            Common prefills: <code>{</code> for JSON, <code>&lt;response&gt;</code> for XML\n                        </span>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- System Prompt --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-terminal"></i>\n                    System Prompt\n                </h3>\n                <p class="cr-setting-desc">\n                    The system prompt is sent with every generation. Your additions are appended after the base prompt.\n                </p>\n\n                <div class="cr-setting-item">\n                    <label class="cr-setting-label">Your Additions</label>\n                    <textarea id="${v.pW}_user_system_prompt"\n                              class="cr-textarea text_pole"\n                              rows="4"\n                              placeholder="Add custom instructions...">${t.sanitize(r.userSystemPrompt)}</textarea>\n                </div>\n\n                <details class="cr-collapsible">\n                    <summary>Base Prompt</summary>\n                    <div class="cr-collapsible__content">\n                        <div class="cr-warning-banner">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>Editing the base prompt may affect results. Use "Revert" to restore defaults.</span>\n                        </div>\n                        <textarea id="${v.pW}_base_system_prompt"\n                                  class="cr-textarea cr-textarea--compact text_pole"\n                                  rows="4">${t.sanitize(r.baseSystemPrompt)}</textarea>\n                        <button id="${v.pW}_revert_system_prompt"\n                                class="cr-btn cr-btn--small menu_button cr-mt-2"\n                                type="button">\n                            <i class="fa-solid fa-rotate-left"></i>\n                            Revert to Default\n                        </button>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- Refinement Prompt --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-rotate"></i>\n                    Refinement Prompt\n                </h3>\n                <p class="cr-setting-desc">\n                    Instructions for refinement iterations. Your additions are appended after the base.\n                </p>\n\n                <div class="cr-setting-item">\n                    <label class="cr-setting-label">Your Additions</label>\n                    <textarea id="${v.pW}_user_refinement_prompt"\n                              class="cr-textarea text_pole"\n                              rows="4"\n                              placeholder="Add custom refinement instructions...">${t.sanitize(r.userRefinementPrompt)}</textarea>\n                </div>\n\n                <details class="cr-collapsible">\n                    <summary>Base Prompt</summary>\n                    <div class="cr-collapsible__content">\n                        <div class="cr-warning-banner">\n                            <i class="fa-solid fa-triangle-exclamation"></i>\n                            <span>Editing the base prompt may affect results. Use "Revert" to restore defaults.</span>\n                        </div>\n                        <textarea id="${v.pW}_base_refinement_prompt"\n                                  class="cr-textarea cr-textarea--compact text_pole"\n                                  rows="4">${t.sanitize(r.baseRefinementPrompt)}</textarea>\n                        <button id="${v.pW}_revert_refinement_prompt"\n                                class="cr-btn cr-btn--small menu_button cr-mt-2"\n                                type="button">\n                            <i class="fa-solid fa-rotate-left"></i>\n                            Revert to Default\n                        </button>\n                    </div>\n                </details>\n            </section>\n\n            \x3c!-- Processing Options --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-gears"></i>\n                    Processing\n                </h3>\n                <p class="cr-setting-desc">\n                    Options for how character card content is processed before analysis.\n                </p>\n\n                <div class="cr-setting-item">\n                    <label class="cr-setting-label cr-checkbox-label">\n                        <input type="checkbox"\n                               id="${v.pW}_replace_user_macro"\n                               ${r.replaceUserMacro?"checked":""}/>\n                        <span>Replace {{user}} with persona name</span>\n                    </label>\n                    <span class="cr-setting-hint">\n                        When enabled, {{user}} in character fields will be replaced with your current persona name.\n                        This helps the LLM provide gender-specific and persona-aware suggestions.\n                        When disabled, {{user}} is shown literally to the LLM.\n                    </span>\n                </div>\n            </section>\n\n            \x3c!-- Reset Settings --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-rotate-left"></i>\n                    Reset\n                </h3>\n                <button id="${v.pW}_reset_settings"\n                        class="cr-btn cr-btn--small cr-btn--danger menu_button"\n                        type="button">\n                    <i class="fa-solid fa-rotate-left"></i>\n                    Reset All Settings\n                </button>\n            </section>\n\n            \x3c!-- Data Management --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-database"></i>\n                    Data Management\n                </h3>\n                <div class="cr-danger-zone">\n                    <div class="cr-danger-zone__warning">\n                        <i class="fa-solid fa-skull-crossbones"></i>\n                        <div>\n                            <strong>Danger Zone</strong>\n                            <p>These actions are destructive and cannot be undone.</p>\n                        </div>\n                    </div>\n                    <button id="${v.pW}_purge_all_sessions"\n                            class="menu_button menu_button--danger"\n                            type="button">\n                        <i class="fa-solid fa-trash"></i>\n                        Delete All Sessions (All Characters)\n                    </button>\n                </div>\n            </section>\n\n            \x3c!-- Keyboard Shortcuts --\x3e\n            <section class="cr-settings-section">\n                <h3>\n                    <i class="fa-solid fa-keyboard"></i>\n                    Keyboard Shortcuts\n                </h3>\n                <div class="cr-shortcuts-list">\n                    <div class="cr-shortcut">\n                        <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n                        <span>Run current stage</span>\n                    </div>\n                    <div class="cr-shortcut">\n                        <kbd>Escape</kbd>\n                        <span>Cancel generation</span>\n                    </div>\n                </div>\n            </section>\n        </div>\n    `},{name:"SettingsDrawerBody"}),Jn=Ie(()=>`\n        <footer class="cr-drawer__footer cr-drawer__footer--spaced">\n            <span class="cr-version">v${v.xv}</span>\n            <button id="${v.pW}_settings_save"\n                    class="cr-btn cr-btn--primary menu_button"\n                    type="button">\n                <i class="fa-solid fa-check"></i>\n                Save & Close\n            </button>\n        </footer>\n    `,{name:"SettingsDrawerFooter"}),Vn=Ie(()=>`\n        <div id="${v.pW}_settings_drawer" class="cr-drawer" aria-hidden="true">\n            <div class="cr-drawer__backdrop"></div>\n            <aside class="cr-drawer__panel" role="dialog" aria-label="${v.hi} Settings">\n                <div class="cr-drawer__content">\n                    ${Gn()}\n                    ${qn()}\n                    ${Jn()}\n                </div>\n            </aside>\n        </div>\n    `,{name:"SettingsDrawer"});var Yn=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function Kn(e,t){const r=_e(`#${v.pW}_api_status_banner`,e);if(!r)return;let n=null;if(t){const t=_e(`#${v.pW}_profile_select`,e);n=(null==t?void 0:t.value)||null}const i=(0,v.Lq)(n);r.innerHTML=Un(i)}function Qn(e){const t=_e(`#${v.pW}_settings_close`,e);t&&Mn(xe(t,"click",()=>{ei()}));const r=_e(`#${v.pW}_settings_save`,e);r&&Mn(xe(r,"click",()=>{!function(){const e=(0,y.getSettings)(),t=_e(`#${v.pW}_settings_drawer`);if(!t)return;const r=t.querySelector(`input[name="${v.pW}_gen_mode"]:checked`);r&&(e.generationMode=r.value);const n=_e(`#${v.pW}_profile_select`,t);n&&(e.profileId=n.value||null);const i=_e(`#${v.pW}_max_tokens_enabled`,t),a=_e(`#${v.pW}_max_tokens`,t);i&&a&&(e.maxTokensOverride=i.checked?parseInt(a.value,10):null);const s=_e(`#${v.pW}_user_system_prompt`,t);s&&(e.userSystemPrompt=s.value);const o=_e(`#${v.pW}_user_refinement_prompt`,t);o&&(e.userRefinementPrompt=o.value);const c=_e(`#${v.pW}_base_system_prompt`,t);c&&(e.baseSystemPrompt=c.value);const l=_e(`#${v.pW}_base_refinement_prompt`,t);l&&(e.baseRefinementPrompt=l.value);const d=_e(`#${v.pW}_replace_user_macro`,t);d&&(e.replaceUserMacro=d.checked);const u=_e(`#${v.pW}_disable_thinking`,t);u&&(e.disableThinking=u.checked);const p=_e(`#${v.pW}_use_assistant_prefill`,t);p&&(e.useAssistantPrefill=p.checked);const f=_e(`#${v.pW}_assistant_prefill`,t);f&&(e.assistantPrefill=f.value),(0,y.save)(),v.oR.success("Settings saved")}(),ei()}));const n=_e(".cr-drawer__backdrop",e);n&&Mn(xe(n,"click",()=>{ei()}));const i=e=>{"Escape"===e.key&&Dn()&&(e.preventDefault(),e.stopPropagation(),ei())};document.addEventListener("keydown",i),Mn(()=>document.removeEventListener("keydown",i));const a=we(".cr-gen-mode-option",e),s=_e(`#${v.pW}_profile_section`,e);for(const t of a)Mn(xe(t,"click",()=>{const r=t.dataset.mode;a.forEach(e=>e.classList.remove("cr-gen-mode-option--active")),t.classList.add("cr-gen-mode-option--active"),s&&s.classList.toggle("cr-hidden","current"===r),Kn(e,"profile"===r)}));const o=_e(`#${v.pW}_profile_select`,e),c=_e(`#${v.pW}_profile_info_container`,e);o&&c&&Mn(xe(o,"change",()=>{const t=(0,v.We)().find(e=>e.id===o.value);c.innerHTML=Hn(t||null),Kn(e,!0)}));const l=_e(`#${v.pW}_max_tokens_enabled`,e),d=_e(`#${v.pW}_max_tokens`,e);l&&d&&Mn(xe(l,"change",()=>{d.disabled=!l.checked}));const u=_e(`#${v.pW}_use_assistant_prefill`,e),p=_e(`#${v.pW}_prefill_container`,e);u&&p&&Mn(xe(u,"change",()=>{p.style.display=u.checked?"":"none"}));const f=_e(`#${v.pW}_reset_settings`,e);f&&Mn(xe(f,"click",()=>Yn(this,void 0,void 0,function*(){(yield v.lY.confirm("Reset Settings","This will reset all settings to defaults. Custom presets will be kept. Continue?"))&&((0,y.resetSettings)(),v.oR.success("Settings reset to defaults"),function(){const e=_e(`#${v.pW}_settings_drawer`);if(!e)return;const t=_e(".cr-drawer__panel",e);t&&(Fn(),t.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Gn()}\n                ${qn()}\n                ${Jn()}\n            </div>\n        `,Qn(e))}())})));const m=_e(`#${v.pW}_revert_system_prompt`,e),g=_e(`#${v.pW}_base_system_prompt`,e);m&&g&&Mn(xe(m,"click",()=>{g.value=y.BASE_SYSTEM_PROMPT,v.oR.info("Base system prompt reverted to default")}));const h=_e(`#${v.pW}_revert_refinement_prompt`,e),b=_e(`#${v.pW}_base_refinement_prompt`,e);h&&b&&Mn(xe(h,"click",()=>{b.value=y.BASE_REFINEMENT_PROMPT,v.oR.info("Base refinement prompt reverted to default")}));const _=_e(`#${v.pW}_purge_all_sessions`,e);_&&Mn(xe(_,"click",()=>Yn(this,void 0,void 0,function*(){if(yield v.lY.confirm("Delete ALL Sessions?","This will permanently delete ALL sessions for ALL characters. This action cannot be undone."))try{const e=yield(0,y.purgeAllSessions)();e.success?v.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""} across all characters`):v.oR.error("Failed to delete sessions")}catch(e){v.oR.error("Failed to delete sessions"),v.Rm.error("Purge all sessions error:",e)}})))}function Xn(e){if(_e(`#${v.pW}_settings_drawer`))return;const t=e.closest(".popup");t?t.insertAdjacentHTML("beforeend",Vn()):document.body.insertAdjacentHTML("beforeend",Vn())}function Zn(e){const t=_e(`#${v.pW}_settings_drawer`);if(!t)return void v.Rm.error("Settings drawer not initialized");Fn(),function(e){Nn=e}(e||{});const r=_e(".cr-drawer__panel",t);r&&(r.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Gn()}\n                ${qn()}\n                ${Jn()}\n            </div>\n        `),Qn(t),Bn(!0),requestAnimationFrame(()=>{t.classList.add("cr-drawer--open"),t.setAttribute("aria-hidden","false")})}function ei(){const e=_e(`#${v.pW}_settings_drawer`);e&&Dn()&&(Bn(!1),e.classList.remove("cr-drawer--open"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{var e,t;Fn(),null===(t=(e=Nn).onClose)||void 0===t||t.call(e)},300))}let ti=null;const ri=Ie(()=>{const e=SillyTavern.libs.DOMPurify,t=(0,v.Lq)(ti),r=(0,v.mi)(),n=r?(0,v.We)():[],i=t.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger",a=t.isReady?"cr-api-status--ready":"cr-api-status--error",s=r&&n.length>0?`\n        <select id="${v.pW}_profile_select" \n                class="cr-select cr-selecr--sm text_pole" \n                aria-label="Connection profile">\n            <option value="" ${ti?"":"selected"}>\n                Current Settings\n            </option>\n            ${n.map(e=>function(e,t){const r=SillyTavern.libs.DOMPurify;return`\n        <option value="${e.id}" \n                ${t?"selected":""}\n                ${e.isSupported?"":"disabled"}>\n            ${r.sanitize(e.name)} (${r.sanitize(e.model)})\n        </option>\n    `}(e,e.id===ti)).join("")}\n        </select>\n    `:"";return`\n        <div id="${v.pW}_api_status" class="cr-api-status ${a}">\n            <div class="cr-api-status__indicator">\n                <i class="fa-solid ${i}"></i>\n                <span class="cr-api-status__text">${e.sanitize(t.modelDisplay)}</span>\n            </div>\n            ${s}\n            ${t.error?`\n                <span class="cr-api-status__error" title="${e.sanitize(t.error)}">\n                    <i class="fa-solid fa-exclamation-triangle"></i>\n                </span>\n            `:""}\n        </div>\n    `},{name:"ApiStatus"}),ni=Ie(()=>{const e=(0,v.Lq)(ti),t=e.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger";return`\n        <div class="cr-api-badge ${Se(!e.isReady&&"cr-api-badge--error")}" \n             title="${e.statusText}${e.error?": "+e.error:""}">\n            <i class="fa-solid ${t}"></i>\n            <span>${e.modelDisplay}</span>\n        </div>\n    `},{name:"ApiStatusCompact"});function ii(e){const t=[],r=_e(`#${v.pW}_profile_select`,e);return r&&t.push(xe(r,"change",()=>{const e=r.value||null;ti=e;(0,y.getSettings)().profileId=e,(0,y.save)(),function(){const e=_e(`#${v.pW}_api_status`);if(!e)return;const t=e.parentElement;t&&(t.innerHTML=ri(),ii(t))}()})),()=>{t.forEach(e=>e())}}var ai=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};let si=null;const oi=Ie(function(){return`\n<div id="${v.pW}_popup" class="cr-popup">\n    <header class="cr-header">\n        <div class="cr-header__left">\n            ${tt()}\n            ${Tn()}\n        </div>\n        <div class="cr-header__center">\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <h2>Card Refinery</h2>\n            <div id="${v.pW}_api_status_container">\n                ${ni()}\n            </div>\n        </div>\n        <div class="cr-header__right">\n            <button id="${v.pW}_settings_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Settings"\n                    aria-label="Settings">\n                <i class="fa-solid fa-cog"></i>\n            </button>\n            <button id="${v.pW}_close_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Close"\n                    aria-label="Close popup">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    </header>\n\n    <div class="cr-toolbar">\n        ${_n()}\n        <div id="${v.pW}_pipeline_controls" class="cr-toolbar__controls">\n            ${wn()}\n        </div>\n    </div>\n\n    <div class="cr-body">\n        <aside class="cr-panel cr-panel--config cr-scrollable">\n            ${yt()}\n        </aside>\n        <main class="cr-panel cr-panel--results">\n            ${Lr()}\n        </main>\n    </div>\n</div>`},{name:"PopupContent",showToast:!0});let ci=[];const li=Oe(function(){if(!_e(`#${v.pW}_char_dropdown`))return;const e=SillyTavern.libs.DOMPurify,t=J().character,r=_e(`#${v.pW}_char_trigger`);if(r){const n=t?e.sanitize(t.name):"Select character...",i=t?`<img class="cr-dropdown__trigger-avatar"\n                   src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n                   alt=""\n                   onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';r.innerHTML=`\n            ${i}\n            <span class="cr-dropdown__trigger-text ${t?"":"cr-dropdown__trigger-text--placeholder"}">${n}</span>\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const n=_e(`#${v.pW}_char_list`);n&&(n.innerHTML=et())},{name:"CharacterSelector"}),di=Oe(xn,{name:"StageTabs"}),ui=Oe($n,{name:"PipelineControls"}),pi=Oe(bt,{name:"StageConfig"}),fi=Oe(Nr,{name:"Results"}),mi=Oe(Wn,{name:"SessionDropdown"}),gi=ze(function(e){const t=[],r=_e(`#${v.pW}_char_dropdown`,e),n=_e(`#${v.pW}_char_trigger`,e),i=_e(`#${v.pW}_char_search`,e),a=_e(`#${v.pW}_char_list`,e);n&&t.push(xe(n,"click",e=>{e.stopPropagation(),Xe(!Ve),Ve&&i&&setTimeout(()=>i.focus(),0)}));const s=e=>{Ve&&r&&!r.contains(e.target)&&Xe(!1)};if(document.addEventListener("click",s),t.push(()=>document.removeEventListener("click",s)),i){Qe&&(Qe.cancel(),Qe=null),Qe=SillyTavern.libs.lodash.debounce(()=>{Ye=i.value,Ke=-1,a&&(a.innerHTML=et())},v.U8.SEARCH);const e=Qe;t.push(xe(i,"input",()=>{e()})),t.push(xe(i,"keydown",e=>{const t=we(".cr-char-option",a),r=t.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),Ke=Math.min(Ke+1,r),rt(t);break;case"ArrowUp":e.preventDefault(),Ke=Math.max(Ke-1,0),rt(t);break;case"Enter":e.preventDefault(),Ke>=0&&t[Ke]&&nt(t[Ke]);break;case"Escape":e.preventDefault(),Xe(!1),null==n||n.focus()}})),t.push(()=>{e.cancel(),Qe=null})}const o=_e(".cr-dropdown__search-clear",e);return o&&i&&t.push(xe(o,"click",e=>{e.stopPropagation(),i.value="",Ye="",Ke=-1,a&&(a.innerHTML=et()),i.focus()})),a&&t.push(xe(a,"click",e=>{const t=e.target.closest(".cr-char-option");t&&nt(t)})),()=>{t.forEach(e=>e()),Ve=!1,Ye="",Ke=-1}},{name:"CharacterSelector"}),hi=ze(function(e){const t=[],r=_e(`#${v.pW}_session_dropdown`,e),n=_e(`#${v.pW}_session_trigger`,e),i=_e(`#${v.pW}_session_list`,e),a=_e(`#${v.pW}_new_session_btn`,e);n&&t.push(xe(n,"click",e=>{e.stopPropagation(),n.disabled||In(!Cn)}));const s=e=>{Cn&&r&&!r.contains(e.target)&&(In(!1),Wn())};document.addEventListener("click",s),t.push(()=>document.removeEventListener("click",s)),a&&t.push(xe(a,"click",e=>An(this,void 0,void 0,function*(){e.stopPropagation();try{(yield Q())&&(v.oR.success("New session created"),In(!1),Ue())}catch(e){v.oR.error("Failed to create session"),v.Rm.error("Create session error:",e)}})));const o=_e(`#${v.pW}_delete_all_sessions_btn`,e);return o&&t.push(xe(o,"click",e=>An(this,void 0,void 0,function*(){e.stopPropagation();const t=J().sessions.length;if(yield v.lY.confirm("Delete All Sessions",`Are you sure you want to delete all ${t} session${1!==t?"s":""} for this character? This cannot be undone.`))try{const e=yield ee();e.success?(v.oR.success(`Deleted ${e.count} session${1!==e.count?"s":""}`),In(!1),Wn(),Ue()):v.oR.error("Failed to delete sessions")}catch(e){v.oR.error("Failed to delete sessions"),v.Rm.error("Delete all sessions error:",e)}}))),i&&(t.push(xe(i,"click",e=>An(this,void 0,void 0,function*(){const t=e.target,r=t.closest(".cr-session-option");if(!r)return;const n=r.dataset.sessionId||t.dataset.sessionId;if(n){if(t.closest(".cr-session-edit"))return e.stopPropagation(),En=n,Wn(),void setTimeout(()=>{const e=_e(`.cr-session-option__name-input[data-session-id="${n}"]`);e&&(e.focus(),e.select())},0);if(t.closest(".cr-session-save")){e.stopPropagation();const t=_e(`.cr-session-option__name-input[data-session-id="${n}"]`);if(t)try{yield re(n,t.value),v.oR.success("Session renamed")}catch(e){v.oR.error("Failed to rename session"),v.Rm.error("Rename session error:",e)}return En=null,void Wn()}if(t.closest(".cr-session-cancel"))return e.stopPropagation(),En=null,void Wn();if(t.closest(".cr-session-delete")){e.stopPropagation();if(yield v.lY.confirm("Delete Session","Are you sure you want to delete this session? This cannot be undone."))try{(yield Z(n))?(v.oR.success("Session deleted"),Wn(),Ue()):v.oR.error("Failed to delete session")}catch(e){v.oR.error("Failed to delete session"),v.Rm.error("Delete session error:",e)}return}if(!r.classList.contains("cr-session-option--active")&&!En)try{(yield X(n))?(v.oR.success("Session loaded"),In(!1),Ue()):v.oR.error("Failed to load session")}catch(e){v.oR.error("Failed to load session"),v.Rm.error("Load session error:",e)}}}))),t.push(xe(i,"keydown",e=>An(this,void 0,void 0,function*(){const t=e.target;if(!t.classList.contains("cr-session-option__name-input"))return;const r=t.dataset.sessionId;if(r)if("Enter"===e.key){e.preventDefault();try{yield re(r,t.value),v.oR.success("Session renamed")}catch(e){v.oR.error("Failed to rename session"),v.Rm.error("Rename session error:",e)}En=null,Wn()}else"Escape"===e.key&&(e.preventDefault(),En=null,Wn())})))),()=>{t.forEach(e=>e()),Cn=!1,En=null}},{name:"SessionDropdown"}),vi=ze(function(e){const t=[],r=_e(".cr-stage-tabs",e);r&&t.push(xe(r,"click",e=>{const t=e.target.closest(".cr-stage-tab");if(!t)return;const r=t.dataset.stage;r&&(oe(r),xn(),bt(),Nr(),$n())}));const n=_e(`#${v.pW}_pipeline_controls`,e);return n&&Rn(n),()=>{t.forEach(e=>e())}},{name:"StageTabs"}),yi=ze(function(e){const t=SillyTavern.libs.DOMPurify,r=[],n=_e(`#${v.pW}_link_fields`,e);return n&&r.push(xe(n,"click",()=>{!function(){const e=J(),{lodash:t}=SillyTavern.libs,r=!e.stageFields.linked,n=Object.assign({},e.stageFields.overrides);r||(n[e.activeStage]=t.cloneDeep(e.stageFields.base)),k("fields",{stageFields:Object.assign(Object.assign({},e.stageFields),{linked:r,overrides:n})}),Y()}();const e=ae();n.classList.toggle("cr-active",e),n.setAttribute("aria-pressed",String(e)),n.title=e?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const t=n.querySelector("i");t&&(t.className="fa-solid "+(e?"fa-link":"fa-link-slash")),bt()})),function(e,t){const r=_e(`#${v.pW}_fields_container`,e);if(!r)return;t.push(xe(r,"change",e=>{const t=e.target;if(!t.classList.contains("cr-field-checkbox"))return;const r=t.dataset.field;if(r){if(void 0!==t.dataset.index){const e=parseInt(t.dataset.index,10),n=ie(),i=Array.isArray(n[r])?[...n[r]]:[];if(t.checked)i.includes(e)||i.push(e);else{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}se(r,i.length>0&&i.sort((e,t)=>e-t))}else if(t.classList.contains("cr-field-checkbox--parent")){const e=t.closest(".cr-field-group");if(!e)return;const n=we(".cr-field-checkbox--child",e);if(t.checked){se(r,n.map((e,t)=>t))}else se(r,!1)}else se(r,t.checked);gt()}})),t.push(xe(r,"click",e=>{const t=e.target.closest(".cr-field-expand");if(!t)return;const r=t.closest(".cr-field-group");if(!r)return;const n=r.dataset.field;if(!n)return;const i=function(e){return mt.has(e)?(mt.delete(e),!1):(mt.add(e),!0)}(n);r.classList.toggle("cr-field-group--expanded",i)})),t.push(xe(r,"click",e=>er(this,void 0,void 0,function*(){var t;const r=e.target.closest(".cr-field-preview-btn");if(!r)return;const n=r.dataset.field;if(!n)return;const i=J();if(!i.character)return;const a=I(i.character).find(e=>e.key===n);if(!a)return;const s=r.dataset.index;if(void 0!==s){const e=parseInt(s,10);if("alternate_greetings"===n&&Array.isArray(a.rawValue)){const t=a.rawValue[e];t&&v.lY.alert(`Greeting ${e+1}`,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(t)}</pre>`)}else if("character_book"===n&&a.rawValue){const r=null===(t=a.rawValue.entries)||void 0===t?void 0:t[e];if(r){const t=r.name||r.comment||`Entry ${e+1}`;v.lY.alert(t,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(r.content||"(empty)")}</pre>`)}}return}v.lY.alert(a.label,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(a.value)}</pre>`)})))}(e,r),function(e,t){const r=_e(`#${v.pW}_prompt`,e);if(r){const e=SillyTavern.libs.lodash.debounce(e=>{ce(J().activeStage,{customPrompt:e,promptPresetId:null}),ut(e)},300);at(e),t.push(xe(r,"input",()=>{e(r.value)})),t.push(()=>{e.cancel(),st(e)}),ut(r.value)}const n=_e(`#${v.pW}_prompt_select`,e);n&&t.push(xe(n,"change",()=>{const e=J(),t=n.value||null;if(ce(e.activeStage,{promptPresetId:t,customPrompt:""}),r)if(t){const e=(0,y.getPromptPreset)(t);e&&(r.value=e.prompt,ut(e.prompt))}else r.value="",ut("")}));const i=_e(`#${v.pW}_save_prompt`,e);i&&t.push(xe(i,"click",()=>er(this,void 0,void 0,function*(){const e=J(),t=(null==r?void 0:r.value)||"";if(!t.trim())return void v.oR.warning("Enter a prompt first");const n=e.stageConfigs[e.activeStage],i=(null==n?void 0:n.promptPresetId)?(0,y.getPromptPreset)(n.promptPresetId):null;if(i&&!i.isBuiltin)return(0,y.updatePromptPreset)(i.id,{prompt:t}),v.oR.success(`Updated preset "${i.name}"`),void bt();const a=y.presetRegistry.getPromptPresets().map(e=>e.name),s=(0,v.Sn)(`${v.BA[e.activeStage]} Custom`,a),o=yield v.lY.input("Save Prompt Preset","Enter a name for this preset:",s);if(!o)return;const c=(0,y.savePromptPreset)({name:o.trim(),stages:[e.activeStage],prompt:t});ce(e.activeStage,{promptPresetId:c.id,customPrompt:""}),v.oR.success(`Saved preset "${c.name}"`),bt()})))}(e,r),function(e,t){const r=_e(`#${v.pW}_use_schema`,e),n=_e(`#${v.pW}_schema_section`,e);r&&n&&t.push(xe(r,"change",()=>{ce(J().activeStage,{useStructuredOutput:r.checked}),n.classList.toggle("cr-hidden",!r.checked)}));const i=_e(`#${v.pW}_schema`,e);if(i){const e=SillyTavern.libs.lodash.debounce(e=>{ce(J().activeStage,{customSchema:e,schemaPresetId:null})},300);at(e),t.push(xe(i,"input",()=>{e(i.value)})),t.push(()=>{e.cancel(),st(e)})}const a=_e(`#${v.pW}_schema_select`,e);a&&i&&t.push(xe(a,"change",()=>{const e=J(),t=a.value||null;if(ce(e.activeStage,{schemaPresetId:t,customSchema:""}),t){const e=(0,y.getSchemaPreset)(t);e&&(i.value=JSON.stringify(e.schema,null,2))}else i.value=""}));const s=_e(`#${v.pW}_generate_schema`,e);s&&i&&t.push(xe(s,"click",()=>er(this,void 0,void 0,function*(){const t=yield v.lY.input("Generate JSON Schema",'Describe the structure you want (e.g., "rating 1-10, list of issues, summary"):',"");if(!t)return;const r=s.innerHTML;s.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Generating...',s.disabled=!0;try{const r=yield(0,D.nr)(t);if(r.success&&r.schema){i.value=r.schema;ce(J().activeStage,{customSchema:r.schema,schemaPresetId:null});const t=_e(`#${v.pW}_schema_select`,e);t&&(t.value=""),v.oR.success("Schema generated! Review and save as preset if desired.")}else v.oR.error(r.error||"Failed to generate schema"),r.schema&&(i.value=r.schema)}catch(e){v.oR.error(`Generation failed: ${e.message}`)}finally{s.innerHTML=r,s.disabled=!1}})));const o=_e(`#${v.pW}_validate_schema`,e);o&&i&&t.push(xe(o,"click",()=>{try{JSON.parse(i.value),v.oR.success("Valid JSON")}catch(e){v.oR.error(`Invalid JSON: ${e.message}`)}}));const c=_e(`#${v.pW}_format_schema`,e);c&&i&&t.push(xe(c,"click",()=>{try{const e=JSON.parse(i.value);i.value=JSON.stringify(e,null,2),v.oR.success("Formatted")}catch(e){v.oR.error(`Invalid JSON: ${e.message}`)}}));const l=_e(`#${v.pW}_save_schema`,e);l&&i&&t.push(xe(l,"click",()=>er(this,void 0,void 0,function*(){const e=J(),t=i.value||"";if(!t.trim())return void v.oR.warning("Enter a schema first");let r;try{r=JSON.parse(t)}catch(e){return void v.oR.error(`Invalid JSON: ${e.message}`)}const n=e.stageConfigs[e.activeStage],a=(null==n?void 0:n.schemaPresetId)?(0,y.getSchemaPreset)(n.schemaPresetId):null;if(a&&!a.isBuiltin)return(0,y.updateSchemaPreset)(a.id,{schema:r}),v.oR.success(`Updated preset "${a.name}"`),void bt();const s=y.presetRegistry.getSchemaPresets().map(e=>e.name),o=(0,v.Sn)(`${v.BA[e.activeStage]} Schema`,s),c=yield v.lY.input("Save Schema Preset","Enter a name for this schema preset:",o);if(!c)return;const l=(0,y.saveSchemaPreset)({name:c.trim(),stages:[e.activeStage],schema:r});ce(e.activeStage,{schemaPresetId:l.id,customSchema:""}),v.oR.success(`Saved preset "${l.name}"`),bt()})))}(e,r),function(e,t,r){const n=_e(`#${v.pW}_preview`,e);n&&t.push(xe(n,"click",()=>er(this,void 0,void 0,function*(){const e=J();if(!e.character)return void v.oR.warning("Select a character first");let t=T(e.character,e.selectedFields);e.userGuidance.trim()&&(t+=`\n\n---\n\n## USER GUIDANCE\n\n${e.userGuidance}`),yield v.lY.alert("Prompt Preview",`<div class="cr-preview-content"><pre>${r.sanitize(t)}</pre></div>`)})))}(e,r,t),function(e,t){const r=we(".cr-preset-manage-btn",e);for(const e of r)t.push(xe(e,"click",()=>{const t=e.dataset.type;Vt(t,{onSelect:e=>{const r=J();ce(r.activeStage,"prompt"===t?{promptPresetId:e.id,customPrompt:""}:{schemaPresetId:e.id,customSchema:""}),bt()},onUpdate:()=>{bt()}})}))}(e,r),()=>{r.forEach(e=>e())}},{name:"StageConfig"}),bi=ze(function(e){const t=[];t.push(xe(e,"click",e=>{const t=e.target.closest(".cr-view-toggle__btn");if(!t)return;const r=t.dataset.view;if(r&&r!==Er()){const e=zr();if(e&&(e(),Tr(null)),Pr=r,Nr(),"compare"===r){const e=_e(`#${v.pW}_compare_content`);e&&Tr(()=>{})}}})),t.push(xe(e,"click",e=>{const t=e.target.closest(".cr-json-toggle__btn");if(!t)return;const r=t.closest(".cr-json-toggle"),n=null==r?void 0:r.dataset.stage;if(!n)return;const i=t.dataset.mode;i&&i!==Ir(n)&&(!function(e,t){Rr[e]=t}(n,i),Nr())})),t.push(xe(e,"click",e=>{const t=e.target.closest(".cr-text-toggle__btn");if(!t)return;const r=t.closest(".cr-text-toggle"),n=null==r?void 0:r.dataset.stage;if(!n)return;const i=t.dataset.mode;i&&i!==Or(n)&&(!function(e,t){Ar[e]=t}(n,i),Nr())})),t.push(xe(e,"click",e=>{e.target.closest(".cr-apply-btn")&&fn()}));const r=_e(`#${v.pW}_results_content`,e);return r&&t.push(xe(r,"click",e=>gn(this,void 0,void 0,function*(){const t=e.target.closest(".cr-result-copy");if(!t)return;const r=t,n=r.dataset.type,i=r.dataset.stage;let a;a="json"===n&&i&&"smart"===Ir(i)?decodeURIComponent(r.dataset.formatted||""):decodeURIComponent(r.dataset.raw||"");const s=yield function(e){return mn(this,void 0,void 0,function*(){if(navigator.clipboard&&window.isSecureContext)try{return yield navigator.clipboard.writeText(e),!0}catch(e){}try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",t.setAttribute("readonly",""),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const r=document.execCommand("copy");return document.body.removeChild(t),r}catch(e){return!1}})}(a),o=t.querySelector("i");s?o&&(o.className="fa-solid fa-check",setTimeout(()=>{o.className="fa-solid fa-copy"},1500)):(o&&(o.className="fa-solid fa-xmark",setTimeout(()=>{o.className="fa-solid fa-copy"},1500)),v.Rm.error("Failed to copy to clipboard"))}))),t.push(xe(e,"click",e=>{const t=e.target.closest(".cr-history__toggle");if(!t)return;const r=t.closest(".cr-history");r&&(!function(){const e=J();k("ui",{historyExpanded:!e.historyExpanded})}(),r.classList.toggle("cr-history--collapsed"),t.setAttribute("aria-expanded",String(J().historyExpanded)))})),t.push(xe(e,"click",e=>{const t=e.target;return t.closest(`#${v.pW}_history_prev`)?(function(){const e=J();0!==e.iterationHistory.length&&(null===e.viewingHistoryIndex?k("ui",{viewingHistoryIndex:e.iterationHistory.length-1}):e.viewingHistoryIndex>0&&k("ui",{viewingHistoryIndex:e.viewingHistoryIndex-1}))}(),void Nr()):t.closest(`#${v.pW}_history_next`)?(function(){const e=J();null!==e.viewingHistoryIndex&&(e.viewingHistoryIndex<e.iterationHistory.length-1?k("ui",{viewingHistoryIndex:e.viewingHistoryIndex+1}):k("ui",{viewingHistoryIndex:null}))}(),void Nr()):t.closest(`#${v.pW}_history_restore`)?(de(),v.oR.success("Result restored"),void Nr()):t.closest(`#${v.pW}_history_back`)?(le(null),void Nr()):void 0})),t.push(xe(e,"click",e=>{const t=e.target;if(!t.closest(`#${v.pW}_history_list`))return;const r=t.closest(".cr-history-restore");if(r){e.stopPropagation();return de(parseInt(r.dataset.index||"0",10)),v.oR.success("Result restored"),void Nr()}const n=t.closest(".cr-list-item");if(!n)return;le(parseInt(n.dataset.index||"0",10)),Nr()})),()=>{const e=zr();e&&(e(),Tr(null)),t.forEach(e=>e())}},{name:"ResultsPanel"}),_i=ze(ii,{name:"ApiStatus"});function wi(){return ai(this,void 0,void 0,function*(){try{const e=SillyTavern.getContext(),{DOMPurify:t}=SillyTavern.libs;q();const r=oi();if(new e.Popup(t.sanitize(r),e.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>ai(this,void 0,void 0,function*(){yield function(e,t){return Re(this,void 0,void 0,function*(){var r;try{return yield e()}catch(e){const n=Ce(e);if(v.Rm.error(`[${t.name}] Failed:`,n),null===(r=t.onError)||void 0===r||r.call(t,n),t.showToast){const e=Ae()?`${t.name}: ${n.message}`:`${t.name} failed`;v.oR.error(e)}return}})}(()=>function(){return ai(this,void 0,void 0,function*(){!function(){for(const e of it)e.flush()}(),yield K(),ci.forEach(e=>e()),ci=[],Pn.forEach(e=>e()),Pn=[],function(){const e=_e(`#${v.pW}_preset_drawer`);e&&e.remove(),$t(),_t.isOpen=!1}(),function(){const e=_e(`#${v.pW}_settings_drawer`);e&&e.remove(),Fn(),Bn(!1)}(),function(){var e;for(const t of je.values())null===(e=t.storeUnsubscribe)||void 0===e||e.call(t);je.clear(),Le.clear(),Ne=!1}(),function(){for(const e of it)e.cancel();it=[]}(),si=null,V(),(0,y.clearCache)(),v.Rm.debug("Popup closed")})}(),{name:"PopupClose"})})),yield new Promise(e=>setTimeout(e,0)),si=document.getElementById(`${v.pW}_popup`),!si)return void v.Rm.error("Popup element not found");Te(()=>function(e){if(_e(`#${v.pW}_preset_drawer`))return;const t=e.closest(".popup");t?t.insertAdjacentHTML("beforeend",Et()):document.body.insertAdjacentHTML("beforeend",Et())}(si),{name:"PresetDrawer"}),Te(()=>Xn(si),{name:"SettingsDrawer"}),Te(()=>function(e){ci.forEach(e=>e()),ci=[],ci.push(De("characterSelector",li,["character","session"])),ci.push(De("stageTabs",di,["stage","pipeline"])),ci.push(De("pipelineControls",ui,["pipeline","character"])),ci.push(De("stageConfig",pi,["stage","config","character"])),ci.push(De("results",fi,["results","stage"])),ci.push(De("sessionDropdown",mi,["session","character"])),ci.push(gi(e)),ci.push(hi(e)),ci.push(vi(e)),ci.push(yi(e)),ci.push(bi(e));const t=_e(`#${v.pW}_api_status_container`,e);t&&ci.push(_i(t));const r=_e(`#${v.pW}_settings_btn`,e);r&&ci.push(xe(r,"click",()=>{Te(()=>function(e,t){Xn(e),Zn(t)}(e),{name:"OpenSettingsDrawer",showToast:!0})}));const n=_e(`#${v.pW}_close_btn`,e);n&&ci.push(xe(n,"click",()=>{!function(){if(!si)return;const e=si.closest(".popup"),t=null==e?void 0:e.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}()}));const i=t=>{try{const r=J();if(t.ctrlKey&&"Enter"===t.key){t.preventDefault();const n=_e(`#${v.pW}_run_stage`,e);n&&!r.isGenerating&&r.character&&n.click()}"Escape"===t.key&&r.isGenerating&&(t.preventDefault(),function(){const e=$();(null==e?void 0:e.abortController)&&(e.abortController.abort(),k("pipeline",{abortController:null,isGenerating:!1}))}())}catch(e){v.Rm.error("Keyboard handler failed:",e)}};document.addEventListener("keydown",i),ci.push(()=>document.removeEventListener("keydown",i))}(si),{name:"EventBinding",showToast:!0,onError:()=>{v.oR.warning("Some features may not work correctly")}}),v.Rm.debug("Popup opened")}catch(e){v.Rm.error("Failed to open popup:",e),v.oR.error("Failed to open Card Refinery")}})}var xi=function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}c((n=n.apply(e,t||[])).next())})};function $i(){return xi(this,void 0,void 0,function*(){const e=document.getElementById("extensions_settings");if(!e)return void v.Rm.error("Extensions container not found");if(document.getElementById(`${v.pW}_panel`))return void v.Rm.debug("Panel already initialized, skipping");e.insertAdjacentHTML("beforeend",function(){const e=(0,y.getSettings)();return`\n<div id="${v.pW}_panel">\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b><i class="fa-solid fa-wand-magic-sparkles"></i> ${v.hi}</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n            <div class="cr-panel-content">\n                <p class="cr-panel-desc">\n                    AI-powered character card scoring, rewriting, and analysis.\n                </p>\n                <button id="${v.pW}_open_btn" class="menu_button cr-panel-launch" type="button">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    <span>Open Card Refinery</span>\n                </button>\n                <div class="cr-panel-footer">\n                    <label class="cr-panel-checkbox">\n                        <input type="checkbox" id="${v.pW}_debug_mode" ${e.debugMode?"checked":""}/>\n                        <span>Debug mode</span>\n                    </label>\n                    <span class="cr-panel-version">v${v.xv}</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>`}());const t=document.getElementById(`${v.pW}_open_btn`);null==t||t.addEventListener("click",wi);const r=document.getElementById(`${v.pW}_debug_mode`);null==r||r.addEventListener("change",()=>{(0,y.getSettings)().debugMode=r.checked,(0,v.pM)(r.checked),(0,y.save)(),v.oR.info(r.checked?"Debug logging enabled":"Debug logging disabled")}),v.Rm.debug("Panel initialized")})}function ki(){try{v.Rm.info(`${v.hi} v${v.xv} initializing...`);const e=(0,y.getSettings)();(0,v.pM)(e.debugMode),$i(),function(){const{eventSource:e,eventTypes:t}=SillyTavern.getContext(),r=(t,r)=>{e.on(t,r),Si.push({type:t,handler:r})};r(t.CHARACTER_EDITED,()=>{v.Rm.debug("Character edited, resetting Fuse index and refreshing popup"),Je(),function(){const e=$();if(!(null==e?void 0:e.character))return;const t=(SillyTavern.getContext().characters||[]).find(t=>{var r;return t.avatar===(null===(r=e.character)||void 0===r?void 0:r.avatar)});t&&k("character",{character:t})}(),Fe()}),r(t.CHARACTER_DELETED,()=>{v.Rm.debug("Character deleted, resetting Fuse index"),Je()}),r(t.CHATCOMPLETION_SOURCE_CHANGED,()=>{v.Rm.debug("Chat completion source changed")}),r(t.CHATCOMPLETION_MODEL_CHANGED,()=>{v.Rm.debug("Chat completion model changed")}),v.Rm.debug("Event listeners registered")}(),v.Rm.info(`${v.hi} v${v.xv} loaded`)}catch(e){v.Rm.error("Extension initialization failed",e),v.oR.error(`${v.hi} failed to initialize. Check console.`)}}(0,v.pM)(v.Oi);const Si=[];function Pi(){!function(){const{eventSource:e}=SillyTavern.getContext();for(const{type:t,handler:r}of Si)e.off(t,r);Si.length=0,v.Rm.debug("Event listeners unregistered")}(),(0,y.clearCache)(),v.Rm.info("Extension cleaned up")}const{eventSource:Ri,eventTypes:Ai}=SillyTavern.getContext();Ri.on(Ai.APP_READY,ki);export{Pi as cleanup,ki as init};export const log=v.Rm;