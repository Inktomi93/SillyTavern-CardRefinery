(()=>{"use strict";var n={56(n,t,e){n.exports=function(n){var t=e.nc;t&&n.setAttribute("nonce",t)}},72(n){var t=[];function e(n){for(var e=-1,r=0;r<t.length;r++)if(t[r].identifier===n){e=r;break}return e}function r(n,r){for(var s={},i=[],o=0;o<n.length;o++){var c=n[o],l=r.base?c[0]+r.base:c[0],d=s[l]||0,p="".concat(l," ").concat(d);s[l]=d+1;var u=e(p),m={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)t[u].references++,t[u].updater(m);else{var f=a(m,r);r.byIndex=o,t.splice(o,0,{identifier:p,updater:f,references:1})}i.push(p)}return i}function a(n,t){var e=t.domAPI(t);e.update(n);return function(t){if(t){if(t.css===n.css&&t.media===n.media&&t.sourceMap===n.sourceMap&&t.supports===n.supports&&t.layer===n.layer)return;e.update(n=t)}else e.remove()}}n.exports=function(n,a){var s=r(n=n||[],a=a||{});return function(n){n=n||[];for(var i=0;i<s.length;i++){var o=e(s[i]);t[o].references--}for(var c=r(n,a),l=0;l<s.length;l++){var d=e(s[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}s=c}}},113(n){n.exports=function(n,t){if(t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}},179(n,t,e){e.r(t),e.d(t,{generate:()=>i,generateSimple:()=>o,generateStructured:()=>c,generateWithRetry:()=>l});var r=e(319),a=e(374),s=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function i(n){return s(this,void 0,void 0,function*(){var t,e,s,i,o,c;if(null===(t=n.signal)||void 0===t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};if(!(0,r.cW)()){return{success:!1,error:(0,r.Lq)().error||"API not connected. Check your connection settings."}}if(n.jsonSchema){const t=(0,a.i6)(n.jsonSchema);if(!t.valid)return{success:!1,error:`Invalid schema: ${t.error}`}}try{if(null===(e=n.signal)||void 0===e?void 0:e.aborted)return{success:!1,error:"Generation cancelled"};const t=SillyTavern.getContext(),r=yield t.generateRaw({prompt:n.prompt,systemPrompt:null!==(s=n.systemPrompt)&&void 0!==s?s:"",responseLength:null!==(i=n.responseLength)&&void 0!==i?i:null,jsonSchema:null!==(o=n.jsonSchema)&&void 0!==o?o:null});if(null===(c=n.signal)||void 0===c?void 0:c.aborted)return{success:!1,error:"Generation cancelled"};const l=function(n){if("string"==typeof n)return n;if(null==n)return"";if("object"==typeof n){const t=n;return"string"==typeof t.text?t.text:"string"==typeof t.content?t.content:JSON.stringify(n)}return String(n)}(r);if(!l||""===l.trim())return{success:!1,error:"Empty response from API"};if(n.jsonSchema){const t=(0,a.Ki)(l,n.jsonSchema);return t?{success:!0,response:l,parsed:t.data,isStructured:!0}:{success:!0,response:l,isStructured:!1}}return{success:!0,response:l,isStructured:!1}}catch(n){return function(n){if("AbortError"===n.name)return{success:!1,error:"Generation cancelled"};const t=n instanceof Error?n.message:String(n),e=t.toLowerCase();if(e.includes("401")||e.includes("unauthorized")||e.includes("invalid_api_key")||e.includes("api key"))return{success:!1,error:"API authentication failed. Check your API key."};if(e.includes("429")||e.includes("rate limit"))return{success:!1,error:"Rate limited. Please wait and try again."};if(e.includes("500")||e.includes("502")||e.includes("503"))return{success:!1,error:"API server error. The service may be temporarily unavailable."};if(e.includes("timeout")||e.includes("etimedout"))return{success:!1,error:"Request timed out. Check your connection or try a different model."};if(e.includes("network")||e.includes("econnrefused")||e.includes("fetch failed"))return{success:!1,error:"Network error. Check your internet connection."};if(e.includes("context")||e.includes("too long")||e.includes("maximum context")||e.includes("token"))return{success:!1,error:"Prompt too long for model context. Try reducing input length."};if(e.includes("model")&&(e.includes("not found")||e.includes("does not exist")))return{success:!1,error:"Model not found. It may have been deprecated or renamed."};if(e.includes("content")&&(e.includes("filter")||e.includes("policy")))return{success:!1,error:"Content was filtered by the API. Try rephrasing your prompt."};return{success:!1,error:t}}(n)}})}function o(n,t){return s(this,void 0,void 0,function*(){var e;const r=yield i({prompt:n,systemPrompt:t});return r.success&&null!==(e=r.response)&&void 0!==e?e:null})}function c(n,t,e){return s(this,void 0,void 0,function*(){const r=yield i({prompt:n,systemPrompt:e,jsonSchema:t});return r.success&&r.parsed?r.parsed:null})}function l(n){return s(this,arguments,void 0,function*(n,t=2,e=1e3){var r,a;let s={success:!1,error:"No attempts made"};for(let o=0;o<=t;o++){if(null===(r=n.signal)||void 0===r?void 0:r.aborted)return{success:!1,error:"Generation cancelled"};if(s=yield i(n),s.success)return s;const c=(null===(a=s.error)||void 0===a?void 0:a.toLowerCase())||"";if(c.includes("cancelled")||c.includes("authentication")||c.includes("api key")||c.includes("content")||c.includes("too long"))return s;o<t&&(yield new Promise(n=>setTimeout(n,e)))}return s})}},208(n,t,e){e.d(t,{A:()=>o});var r=e(601),a=e.n(r),s=e(314),i=e.n(s)()(a());i.push([n.id,"/* =============================================================================\n   CHARACTER TOOLS EXTENSION - CSS DESIGN SYSTEM\n   =============================================================================\n   Mobile-first, ST-native design system that inherits SillyTavern's theming.\n\n   ARCHITECTURE:\n   1. Design Tokens (CSS Variables) - Inherit from ST, define our spacing scale\n   2. Base Reset & Typography - Normalize within our popup\n   3. Layout Primitives - Flex/grid utilities for composition\n   4. Component Styles - BEM-namespaced UI patterns\n   5. Responsive Overrides - Mobile-first breakpoints\n   ============================================================================= */\n\n/* =============================================================================\n   1. DESIGN TOKENS\n   =============================================================================\n   We inherit ST's SmartTheme variables for colors/fonts and define our own\n   spacing scale. This ensures theme compatibility while maintaining consistency.\n   ============================================================================= */\n\n/* Design tokens shared by all CT components */\n.ct-popup,\n.ct-settings-modal,\n.ct-drawer {\n    /* ─────────────────────────────────────────────────────────────────────────\n       COLORS - Inherit from SillyTavern SmartTheme\n       ───────────────────────────────────────────────────────────────────────── */\n\n    /* Backgrounds */\n    --ct-bg: var(--SmartThemeBlurTintColor);\n    --ct-bg-secondary: var(--black30a, rgba(0, 0, 0, 0.3));\n    --ct-bg-tertiary: var(--black50a, rgba(0, 0, 0, 0.5));\n    --ct-bg-elevated: color-mix(\n        in srgb,\n        var(--SmartThemeBlurTintColor) 90%,\n        white 10%\n    );\n\n    /* Text */\n    --ct-text: var(--SmartThemeBodyColor);\n    --ct-text-muted: color-mix(\n        in srgb,\n        var(--SmartThemeBodyColor) 70%,\n        transparent\n    );\n    --ct-text-dim: color-mix(\n        in srgb,\n        var(--SmartThemeBodyColor) 50%,\n        transparent\n    );\n\n    /* Borders */\n    --ct-border: var(--SmartThemeBorderColor);\n    --ct-border-muted: color-mix(\n        in srgb,\n        var(--SmartThemeBorderColor) 50%,\n        transparent\n    );\n\n    /* Accent */\n    --ct-accent: var(--SmartThemeQuoteColor);\n    --ct-accent-hover: color-mix(\n        in srgb,\n        var(--SmartThemeQuoteColor) 80%,\n        white\n    );\n    --ct-accent-muted: color-mix(\n        in srgb,\n        var(--SmartThemeQuoteColor) 30%,\n        transparent\n    );\n\n    /* Semantic Colors */\n    --ct-success: var(--okGreen70a, #4caf50);\n    --ct-success-bg: color-mix(\n        in srgb,\n        var(--okGreen70a, #4caf50) 15%,\n        transparent\n    );\n    --ct-warning: var(--golden, #ff9800);\n    --ct-warning-bg: color-mix(\n        in srgb,\n        var(--golden, #ff9800) 15%,\n        transparent\n    );\n    --ct-danger: var(--fullred, #f44336);\n    --ct-danger-bg: color-mix(\n        in srgb,\n        var(--fullred, #f44336) 15%,\n        transparent\n    );\n\n    /* ─────────────────────────────────────────────────────────────────────────\n       SPACING SCALE - 4px base, follows 4-8-12-16-20-24-32-48 progression\n       ───────────────────────────────────────────────────────────────────────── */\n    --ct-space-1: 0.25rem; /* 4px - tight gaps, icon padding */\n    --ct-space-2: 0.5rem; /* 8px - default gap, small padding */\n    --ct-space-3: 0.75rem; /* 12px - section padding, medium gap */\n    --ct-space-4: 1rem; /* 16px - large padding, section gap */\n    --ct-space-5: 1.25rem; /* 20px - header padding */\n    --ct-space-6: 1.5rem; /* 24px - major section separation */\n    --ct-space-8: 2rem; /* 32px - panel gaps */\n    --ct-space-12: 3rem; /* 48px - major layout spacing */\n\n    /* ─────────────────────────────────────────────────────────────────────────\n       TYPOGRAPHY - Inherit from ST, define scales\n       ───────────────────────────────────────────────────────────────────────── */\n    --ct-font: var(--mainFontFamily, system-ui, -apple-system, sans-serif);\n    --ct-font-mono: var(--monoFontFamily, 'Consolas', 'Monaco', monospace);\n    --ct-font-size: var(--mainFontSize, 1rem);\n\n    /* Font size scale */\n    --ct-text-xs: calc(var(--ct-font-size) * 0.75); /* 12px @ 16px base */\n    --ct-text-sm: calc(var(--ct-font-size) * 0.875); /* 14px */\n    --ct-text-base: var(--ct-font-size); /* 16px */\n    --ct-text-lg: calc(var(--ct-font-size) * 1.125); /* 18px */\n    --ct-text-xl: calc(var(--ct-font-size) * 1.25); /* 20px */\n\n    /* ─────────────────────────────────────────────────────────────────────────\n       RADII - Match ST's rounded aesthetic\n       ───────────────────────────────────────────────────────────────────────── */\n    --ct-radius-sm: 4px;\n    --ct-radius: 8px;\n    --ct-radius-lg: 12px;\n    --ct-radius-pill: 9999px;\n\n    /* ─────────────────────────────────────────────────────────────────────────\n       SHADOWS & EFFECTS\n       ───────────────────────────────────────────────────────────────────────── */\n    --ct-shadow-sm: 0 1px 3px var(--black30a, rgba(0, 0, 0, 0.3));\n    --ct-shadow: 0 4px 12px var(--black30a, rgba(0, 0, 0, 0.3));\n    --ct-shadow-lg: 0 8px 24px var(--black50a, rgba(0, 0, 0, 0.5));\n\n    /* Transitions - use ST's animation-duration */\n    --ct-transition-fast: var(--animation-duration, 150ms) ease;\n    --ct-transition: var(--animation-duration-slow, 300ms) ease;\n\n    /* ─────────────────────────────────────────────────────────────────────────\n       LAYOUT TOKENS\n       ───────────────────────────────────────────────────────────────────────── */\n    --ct-panel-min: 280px;\n    --ct-panel-max: 480px;\n    --ct-header-height: 48px;\n}\n\n/* =============================================================================\n   2. BASE RESET & TYPOGRAPHY\n   =============================================================================\n   Normalize elements within our popup container for consistent rendering.\n   ============================================================================= */\n\n.ct-popup {\n    /* Use ST's native font settings */\n    font-family: var(--ct-font);\n    font-size: var(--ct-font-size);\n    color: var(--ct-text);\n    line-height: 1.5;\n\n    /* Box sizing reset */\n    box-sizing: border-box;\n}\n\n.ct-popup *,\n.ct-popup *::before,\n.ct-popup *::after {\n    box-sizing: inherit;\n}\n\n/* Headings */\n.ct-popup h1,\n.ct-popup h2,\n.ct-popup h3,\n.ct-popup h4 {\n    margin: 0;\n    font-weight: 600;\n    line-height: 1.3;\n    color: var(--ct-text);\n}\n\n.ct-popup h2 {\n    font-size: var(--ct-text-lg);\n}\n.ct-popup h3 {\n    font-size: var(--ct-text-base);\n}\n.ct-popup h4 {\n    font-size: var(--ct-text-sm);\n}\n\n/* Links */\n.ct-popup a {\n    color: var(--ct-accent);\n    text-decoration: none;\n}\n\n.ct-popup a:hover {\n    text-decoration: underline;\n}\n\n/* =============================================================================\n   3. LAYOUT PRIMITIVES\n   =============================================================================\n   Composable flex utilities for building layouts. These complement ST's\n   existing utilities and follow similar naming patterns.\n   ============================================================================= */\n\n/* Stack: Vertical flex layout with consistent gap */\n.ct-stack {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-3);\n}\n\n.ct-stack--tight {\n    gap: var(--ct-space-2);\n}\n.ct-stack--loose {\n    gap: var(--ct-space-4);\n}\n\n/* Row: Horizontal flex layout */\n.ct-row {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-row--wrap {\n    flex-wrap: wrap;\n}\n.ct-row--between {\n    justify-content: space-between;\n}\n.ct-row--end {\n    justify-content: flex-end;\n}\n.ct-row--stretch {\n    align-items: stretch;\n}\n\n/* Grid layouts */\n.ct-grid {\n    display: grid;\n    gap: var(--ct-space-3);\n}\n\n.ct-grid--2col {\n    grid-template-columns: repeat(2, 1fr);\n}\n\n@media (max-width: 600px) {\n    .ct-grid--2col {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* Flex children utilities */\n.ct-flex-1 {\n    flex: 1 1 0%;\n}\n.ct-flex-auto {\n    flex: 1 1 auto;\n}\n.ct-flex-none {\n    flex: none;\n}\n.ct-shrink-0 {\n    flex-shrink: 0;\n}\n\n/* Spacing utilities - use these in HTML when one-offs are needed */\n.ct-gap-1 {\n    gap: var(--ct-space-1);\n}\n.ct-gap-2 {\n    gap: var(--ct-space-2);\n}\n.ct-gap-3 {\n    gap: var(--ct-space-3);\n}\n.ct-gap-4 {\n    gap: var(--ct-space-4);\n}\n\n.ct-p-2 {\n    padding: var(--ct-space-2);\n}\n.ct-p-3 {\n    padding: var(--ct-space-3);\n}\n.ct-p-4 {\n    padding: var(--ct-space-4);\n}\n\n.ct-mt-2 {\n    margin-top: var(--ct-space-2);\n}\n.ct-mt-3 {\n    margin-top: var(--ct-space-3);\n}\n.ct-mt-4 {\n    margin-top: var(--ct-space-4);\n}\n.ct-mt-auto {\n    margin-top: auto;\n}\n\n.ct-mb-2 {\n    margin-bottom: var(--ct-space-2);\n}\n.ct-mb-3 {\n    margin-bottom: var(--ct-space-3);\n}\n.ct-mb-4 {\n    margin-bottom: var(--ct-space-4);\n}\n\n.ct-ml-auto {\n    margin-left: auto;\n}\n.ct-mr-auto {\n    margin-right: auto;\n}\n\n/* Width utilities */\n.ct-w-full {\n    width: 100%;\n}\n.ct-min-w-0 {\n    min-width: 0;\n}\n\n/* Overflow handling */\n.ct-overflow-auto {\n    overflow: auto;\n}\n.ct-overflow-hidden {\n    overflow: hidden;\n}\n.ct-overflow-y-auto {\n    overflow-y: auto;\n}\n\n/* Scrollable container with styled scrollbar */\n.ct-scrollable {\n    overflow-y: auto;\n    scrollbar-width: thin;\n    scrollbar-color: var(--ct-border) transparent;\n}\n\n.ct-scrollable::-webkit-scrollbar {\n    width: 6px;\n    height: 6px;\n}\n\n.ct-scrollable::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.ct-scrollable::-webkit-scrollbar-thumb {\n    background: var(--ct-border);\n    border-radius: var(--ct-radius-pill);\n}\n\n.ct-scrollable::-webkit-scrollbar-thumb:hover {\n    background: var(--ct-accent);\n}\n\n/* Text utilities */\n.ct-text-muted {\n    color: var(--ct-text-muted);\n}\n.ct-text-dim {\n    color: var(--ct-text-dim);\n}\n.ct-text-accent {\n    color: var(--ct-accent);\n}\n.ct-text-success {\n    color: var(--ct-success);\n}\n.ct-text-warning {\n    color: var(--ct-warning);\n}\n.ct-text-danger {\n    color: var(--ct-danger);\n}\n\n.ct-text-xs {\n    font-size: var(--ct-text-xs);\n}\n.ct-text-sm {\n    font-size: var(--ct-text-sm);\n}\n.ct-text-lg {\n    font-size: var(--ct-text-lg);\n}\n\n.ct-text-mono {\n    font-family: var(--ct-font-mono);\n}\n.ct-text-center {\n    text-align: center;\n}\n.ct-text-right {\n    text-align: right;\n}\n.ct-font-medium {\n    font-weight: 500;\n}\n.ct-font-semibold {\n    font-weight: 600;\n}\n\n/* Truncation */\n.ct-truncate {\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-line-clamp-2 {\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n}\n\n/* Visual utilities */\n.ct-hidden {\n    display: none !important;\n}\n.ct-sr-only {\n    position: absolute;\n    width: 1px;\n    height: 1px;\n    padding: 0;\n    margin: -1px;\n    overflow: hidden;\n    clip: rect(0, 0, 0, 0);\n    white-space: nowrap;\n    border: 0;\n}\n\n/* =============================================================================\n   4. COMPONENT STYLES\n   =============================================================================\n   BEM-namespaced components. Use ST's .menu_button for buttons.\n   ============================================================================= */\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   POPUP CONTAINER\n   Mobile-first: full viewport, then constrain on larger screens\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-popup {\n    display: flex;\n    flex-direction: column;\n    width: 100%;\n    height: 100%;\n    min-height: 400px;\n    max-height: 95dvh;\n    background: var(--ct-bg);\n    border-radius: var(--ct-radius-lg);\n    overflow: hidden;\n}\n\n/* Override ST popup sizing for our extension */\n.popup:has(.ct-popup) {\n    width: 95dvw;\n    max-width: 1200px;\n    height: 90dvh;\n    max-height: none;\n    padding: 0;\n}\n\n@media (max-width: 768px) {\n    .popup:has(.ct-popup) {\n        width: 100dvw;\n        height: 100dvh;\n        max-width: none;\n        border-radius: 0;\n    }\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   HEADER - Three-column layout with character selector\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-header {\n    position: relative; /* Establish stacking context for dropdown */\n    z-index: 100; /* Above toolbar */\n    display: grid;\n    grid-template-columns: 1fr auto 1fr;\n    align-items: center;\n    min-height: var(--ct-header-height);\n    padding: var(--ct-space-2) var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n    gap: var(--ct-space-3);\n}\n\n.ct-header__left {\n    display: flex;\n    align-items: center;\n    justify-content: flex-start;\n}\n\n.ct-header__center {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-header__center i {\n    color: var(--ct-accent);\n    font-size: var(--ct-text-lg);\n}\n\n.ct-header__center h2 {\n    font-size: var(--ct-text-base);\n    font-weight: 600;\n    white-space: nowrap;\n}\n\n.ct-header__right {\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: var(--ct-space-2);\n}\n\n/* Legacy support */\n.ct-header__title {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-header__title i {\n    color: var(--ct-accent);\n    font-size: var(--ct-text-lg);\n}\n\n.ct-header__actions {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   API STATUS BADGE - Shows current connection status\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-api-badge {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-1) var(--ct-space-2);\n    background: var(--ct-success-bg);\n    border-radius: var(--ct-radius-pill);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-muted);\n    cursor: default;\n    transition: background var(--ct-transition-fast);\n}\n\n.ct-api-badge--error {\n    background: var(--ct-danger-bg);\n}\n\n.ct-api-badge i {\n    font-size: 0.625rem;\n}\n\n.ct-text-success {\n    color: var(--ct-success);\n}\n\n.ct-text-danger {\n    color: var(--ct-danger);\n}\n\n/* Full API status component (for settings/expanded view) */\n.ct-api-status {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n    border: 1px solid var(--ct-border-muted);\n}\n\n.ct-api-status--ready {\n    border-color: var(--ct-success);\n}\n\n.ct-api-status--error {\n    border-color: var(--ct-danger);\n}\n\n.ct-api-status__indicator {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-api-status__text {\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n}\n\n.ct-api-status__error {\n    color: var(--ct-danger);\n    cursor: help;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   TOOLBAR - Stage tabs + pipeline controls\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-toolbar {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2) var(--ct-space-3);\n    padding: var(--ct-space-2) var(--ct-space-4);\n    background: var(--ct-bg-tertiary);\n    border-bottom: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n    flex-wrap: wrap;\n}\n\n/* When toolbar wraps, give each row proper spacing */\n@media (max-width: 900px) {\n    .ct-toolbar {\n        gap: var(--ct-space-2);\n    }\n}\n\n.ct-toolbar__controls {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    flex-wrap: wrap;\n    flex-shrink: 0;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   STAGE TABS - Horizontal navigation tabs\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-stage-tabs {\n    display: flex;\n    gap: var(--ct-space-1);\n    flex: 1 1 auto;\n    min-width: fit-content; /* Don't shrink below content size */\n}\n\n.ct-stage-tab {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    background: transparent;\n    border: 1px solid transparent;\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n    white-space: nowrap;\n}\n\n.ct-stage-tab:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-stage-tab--active {\n    color: var(--ct-text);\n    background: var(--ct-bg);\n    border-color: var(--ct-accent);\n    box-shadow: var(--ct-shadow-sm);\n}\n\n.ct-stage-tab__checkbox {\n    width: 14px;\n    height: 14px;\n    margin: 0;\n    flex-shrink: 0;\n    accent-color: var(--ct-accent);\n    cursor: pointer;\n}\n\n.ct-stage-tab__icon {\n    font-size: 1em;\n    flex-shrink: 0;\n}\n\n.ct-stage-tab__label {\n    flex: 1 1 auto;\n    min-width: max-content; /* Prevent label from shrinking to 0 */\n}\n\n.ct-stage-tab__status {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 1.25em;\n    height: 1.25em;\n    font-size: 0.75em;\n    border-radius: 50%;\n    flex-shrink: 0;\n}\n\n.ct-stage-tab--running .ct-stage-tab__status {\n    color: var(--ct-accent);\n}\n\n.ct-stage-tab--complete .ct-stage-tab__status {\n    color: var(--ct-success);\n    background: var(--ct-success-bg);\n}\n\n.ct-stage-tab--error .ct-stage-tab__status {\n    color: var(--ct-danger);\n    background: var(--ct-danger-bg);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   PIPELINE CONTROLS - Run buttons and status\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-pipeline-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-pipeline-controls--generating {\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-accent-muted);\n    border-radius: var(--ct-radius);\n}\n\n.ct-pipeline-status {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    color: var(--ct-accent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   CHARACTER SELECTOR DROPDOWN\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-dropdown {\n    position: relative;\n    min-width: 200px;\n    max-width: 280px;\n}\n\n.ct-dropdown__trigger {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    width: 100%;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text);\n    background: var(--ct-bg);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-dropdown__trigger:hover {\n    border-color: var(--ct-accent);\n}\n\n.ct-dropdown--open .ct-dropdown__trigger {\n    border-color: var(--ct-accent);\n    border-bottom-left-radius: 0;\n    border-bottom-right-radius: 0;\n}\n\n.ct-dropdown__trigger-avatar {\n    width: 24px;\n    height: 24px;\n    border-radius: var(--ct-radius-sm);\n    object-fit: cover;\n    flex-shrink: 0;\n}\n\n.ct-dropdown__trigger-icon {\n    width: 24px;\n    text-align: center;\n    color: var(--ct-text-muted);\n    flex-shrink: 0;\n}\n\n.ct-dropdown__trigger-text {\n    flex: 1;\n    text-align: left;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-dropdown__trigger-text--placeholder {\n    color: var(--ct-text-muted);\n}\n\n.ct-dropdown__trigger-chevron {\n    font-size: 0.75em;\n    color: var(--ct-text-muted);\n    transition: transform var(--ct-transition-fast);\n    flex-shrink: 0;\n}\n\n.ct-dropdown--open .ct-dropdown__trigger-chevron {\n    transform: rotate(180deg);\n}\n\n.ct-dropdown__panel {\n    position: absolute;\n    top: 100%;\n    left: 0;\n    right: 0;\n    min-width: 320px;\n    z-index: 1000; /* High z-index to stay above toolbar and other elements */\n    display: none;\n    flex-direction: column;\n    /* Use solid chat background to prevent transparency bleed-through */\n    background: var(--SmartThemeChatBg, #1a1a1a);\n    /* Add backdrop blur for themes that still use transparency */\n    backdrop-filter: blur(20px);\n    -webkit-backdrop-filter: blur(20px);\n    border: 1px solid var(--ct-accent);\n    border-top: none;\n    border-bottom-left-radius: var(--ct-radius);\n    border-bottom-right-radius: var(--ct-radius);\n    box-shadow: var(--ct-shadow-lg);\n    max-height: 400px;\n    overflow: hidden;\n}\n\n.ct-dropdown--open .ct-dropdown__panel {\n    display: flex;\n}\n\n.ct-dropdown__search {\n    position: relative;\n    padding: var(--ct-space-2);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-dropdown__search-icon {\n    position: absolute;\n    left: calc(var(--ct-space-2) + var(--ct-space-2));\n    top: 50%;\n    transform: translateY(-50%);\n    color: var(--ct-text-muted);\n    font-size: var(--ct-text-xs);\n    pointer-events: none;\n}\n\n.ct-dropdown__search-input {\n    width: 100%;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    padding-left: calc(var(--ct-space-3) * 2 + 0.75em);\n    font-size: var(--ct-text-sm);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-dropdown__search-input:focus {\n    border-color: var(--ct-accent);\n    outline: none;\n}\n\n.ct-dropdown__search-clear {\n    position: absolute;\n    right: calc(var(--ct-space-2) + var(--ct-space-1));\n    top: 50%;\n    transform: translateY(-50%);\n    padding: var(--ct-space-1);\n    background: none;\n    border: none;\n    color: var(--ct-text-muted);\n    cursor: pointer;\n    opacity: 0.7;\n}\n\n.ct-dropdown__search-clear:hover {\n    opacity: 1;\n    color: var(--ct-text);\n}\n\n.ct-dropdown__list {\n    flex: 1;\n    overflow-y: auto;\n    max-height: 320px;\n    padding: var(--ct-space-2);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-dropdown__empty {\n    padding: var(--ct-space-6);\n    text-align: center;\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-muted);\n}\n\n.ct-dropdown__empty i {\n    display: block;\n    font-size: 2em;\n    margin-bottom: var(--ct-space-2);\n    opacity: 0.5;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   CHARACTER OPTION CARD - Pretty character list item\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-char-option {\n    display: flex;\n    align-items: flex-start;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-3);\n    cursor: pointer;\n    border-radius: var(--ct-radius);\n    background: var(--ct-bg-secondary);\n    border: 1px solid transparent;\n    transition:\n        background var(--ct-transition-fast),\n        border-color var(--ct-transition-fast),\n        box-shadow var(--ct-transition-fast),\n        transform var(--ct-transition-fast);\n}\n\n.ct-char-option:hover {\n    background: var(--ct-bg-tertiary);\n    border-color: var(--ct-border);\n    transform: translateX(2px);\n}\n\n.ct-char-option--selected {\n    background: var(--ct-accent-muted);\n    border-color: var(--ct-accent);\n}\n\n.ct-char-option--selected:hover {\n    background: var(--ct-accent-muted);\n}\n\n.ct-char-option--highlighted {\n    background: var(--ct-bg-tertiary);\n    border-color: var(--ct-accent);\n    box-shadow: 0 0 0 2px var(--ct-accent-muted);\n}\n\n/* Avatar wrapper with selection indicator */\n.ct-char-option__avatar-wrap {\n    position: relative;\n    flex-shrink: 0;\n}\n\n.ct-char-option__avatar {\n    width: 48px;\n    height: 48px;\n    border-radius: var(--ct-radius);\n    object-fit: cover;\n    border: 2px solid var(--ct-border-muted);\n    transition: border-color var(--ct-transition-fast);\n}\n\n.ct-char-option:hover .ct-char-option__avatar {\n    border-color: var(--ct-accent);\n}\n\n.ct-char-option--selected .ct-char-option__avatar {\n    border-color: var(--ct-accent);\n}\n\n.ct-char-option__check {\n    position: absolute;\n    bottom: -4px;\n    right: -4px;\n    width: 18px;\n    height: 18px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: var(--ct-accent);\n    color: var(--ct-bg);\n    border-radius: 50%;\n    font-size: 10px;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n}\n\n/* Character info section */\n.ct-char-option__info {\n    flex: 1;\n    min-width: 0;\n    display: flex;\n    flex-direction: column;\n    gap: 2px;\n}\n\n.ct-char-option__name {\n    font-size: var(--ct-text-sm);\n    font-weight: 600;\n    color: var(--ct-text);\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-char-option__desc {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n    line-height: 1.4;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n}\n\n.ct-char-option__meta {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    font-size: 10px;\n    color: var(--ct-text-muted);\n    margin-top: 2px;\n}\n\n.ct-char-option__meta i {\n    font-size: 9px;\n    opacity: 0.7;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BODY - Two-panel layout (stacks on mobile)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-body {\n    display: flex;\n    flex-direction: column;\n    flex: 1;\n    min-height: 0; /* Critical for nested flex overflow */\n}\n\n@media (min-width: 768px) {\n    .ct-body {\n        flex-direction: row;\n    }\n}\n\n.ct-panel {\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n    overflow: hidden;\n}\n\n.ct-panel--left,\n.ct-panel--config {\n    flex: 1 1 auto;\n    min-width: 0;\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-panel--right,\n.ct-panel--results {\n    flex: 1 1 auto;\n    min-width: 0;\n}\n\n@media (min-width: 768px) {\n    .ct-panel--left,\n    .ct-panel--config {\n        flex: 0 0 clamp(var(--ct-panel-min), 40%, var(--ct-panel-max));\n        border-bottom: none;\n        border-right: 1px solid var(--ct-border-muted);\n    }\n\n    .ct-panel--right,\n    .ct-panel--results {\n        flex: 1 1 60%;\n    }\n}\n\n.ct-panel__content {\n    flex: 1;\n    min-height: 0;\n    overflow-y: auto;\n    padding: var(--ct-space-3);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SECTION - Content grouping with optional header\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-3);\n    padding-top: 0; /* Header has its own padding */\n    border-bottom: 1px solid var(--ct-border); /* Stronger border for visibility */\n}\n\n.ct-section:last-child {\n    border-bottom: none;\n}\n\n.ct-section__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2);\n    /* Make section headers stand out with background */\n    margin: 0 calc(-1 * var(--ct-space-3));\n    margin-bottom: 0;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-tertiary);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-section__title {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    font-weight: 600;\n    color: var(--ct-text);\n    text-transform: uppercase;\n    letter-spacing: 0.025em;\n}\n\n.ct-section__title i {\n    color: var(--ct-accent);\n    font-size: var(--ct-text-sm);\n    width: 1.25em;\n    text-align: center;\n}\n\n.ct-section__actions {\n    display: flex;\n    gap: var(--ct-space-1);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   CARD - Elevated content container\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-card {\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius);\n    overflow: hidden;\n}\n\n.ct-card--interactive {\n    cursor: pointer;\n    transition:\n        background var(--ct-transition-fast),\n        border-color var(--ct-transition-fast);\n}\n\n.ct-card--interactive:hover {\n    background: var(--ct-bg-tertiary);\n    border-color: var(--ct-border);\n}\n\n.ct-card--selected {\n    background: var(--ct-accent-muted);\n    border-color: var(--ct-accent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BUTTONS - Extend ST's .menu_button with modifiers\n   ─────────────────────────────────────────────────────────────────────────────\n   NOTE: Button modifiers (.menu_button--primary, --danger, --ghost, etc.)\n   are now consolidated in the \"BUTTON VARIANTS\" section near the end of this\n   file. This ensures consistent styling across all CT contexts (popup, settings\n   modal, preset editor, drawer).\n   ───────────────────────────────────────────────────────────────────────────── */\n\n/* Success button (used sparingly, not in all contexts) */\n.ct-popup .menu_button--success {\n    background: var(--ct-success);\n    border-color: var(--ct-success);\n    color: white;\n    filter: none;\n}\n\n/* Button groups */\n.ct-button-group {\n    display: flex;\n    gap: var(--ct-space-2);\n}\n\n.ct-button-group--stretch .menu_button {\n    flex: 1;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   FORM CONTROLS - Inputs, textareas, selects\n   ───────────────────────────────────────────────────────────────────────────── */\n\n/* Inherit ST's textarea/input styling, add consistent sizing */\n.ct-popup input[type='text'],\n.ct-popup input[type='number'],\n.ct-popup input[type='search'],\n.ct-popup textarea,\n.ct-popup select {\n    width: 100%;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-family: var(--ct-font);\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius-sm);\n    transition: border-color var(--ct-transition-fast);\n}\n\n.ct-popup input:focus,\n.ct-popup textarea:focus,\n.ct-popup select:focus {\n    border-color: var(--ct-accent);\n    outline: none;\n}\n\n.ct-popup textarea {\n    min-height: 100px;\n    resize: vertical;\n    line-height: 1.5;\n}\n\n.ct-popup textarea.ct-textarea--code {\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n}\n\n/* Search input with icon */\n.ct-search {\n    position: relative;\n}\n\n.ct-search__icon {\n    position: absolute;\n    left: var(--ct-space-3);\n    top: 50%;\n    transform: translateY(-50%);\n    color: var(--ct-text-muted);\n    pointer-events: none;\n}\n\n.ct-search__input {\n    padding-left: calc(var(--ct-space-3) * 2 + 1em);\n}\n\n.ct-search__clear {\n    position: absolute;\n    right: var(--ct-space-1);\n    top: 50%;\n    transform: translateY(-50%);\n    padding: var(--ct-space-1);\n    background: none;\n    border: none;\n    color: var(--ct-text-muted);\n    cursor: pointer;\n    opacity: 0.7;\n    transition: opacity var(--ct-transition-fast);\n}\n\n.ct-search__clear:hover {\n    opacity: 1;\n    color: var(--ct-text);\n}\n\n/* Checkbox/toggle rows */\n.ct-checkbox {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n}\n\n.ct-checkbox input[type='checkbox'] {\n    width: auto;\n    accent-color: var(--ct-accent);\n}\n\n/* Form group */\n.ct-form-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-form-group__label {\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n}\n\n.ct-form-group__hint {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   TABS - Stage/mode selection\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-tabs {\n    display: flex;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n    overflow-x: auto;\n}\n\n.ct-tab {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    background: transparent;\n    border: 1px solid transparent;\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n    white-space: nowrap;\n}\n\n.ct-tab:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-tertiary);\n}\n\n.ct-tab--active {\n    color: var(--ct-text);\n    background: var(--ct-bg);\n    border-color: var(--ct-accent);\n    box-shadow: var(--ct-shadow-sm);\n}\n\n.ct-tab__icon {\n    font-size: 1em;\n}\n\n.ct-tab__badge {\n    font-size: var(--ct-text-xs);\n    padding: 0.1em 0.5em;\n    background: var(--ct-accent-muted);\n    color: var(--ct-accent);\n    border-radius: var(--ct-radius-pill);\n}\n\n/* Tab internal elements for pipeline tabs */\n.ct-tab-checkbox {\n    width: auto !important;\n    margin: 0;\n    accent-color: var(--ct-accent);\n    cursor: pointer;\n    flex-shrink: 0;\n}\n\n.ct-tab-icon {\n    font-size: 1em;\n    flex-shrink: 0;\n}\n\n.ct-tab-label {\n    flex: 1;\n    text-align: left;\n}\n\n.ct-tab-status {\n    font-size: 0.75em;\n    flex-shrink: 0;\n    margin-left: auto;\n}\n\n/* Status indicator colors */\n.ct-status--pending {\n    color: var(--ct-text-dim);\n}\n\n.ct-status--running {\n    color: var(--ct-accent);\n}\n\n.ct-status--complete {\n    color: var(--ct-success);\n}\n\n.ct-status--error {\n    color: var(--ct-danger);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   LIST ITEMS - Characters, presets, history\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-list {\n    display: flex;\n    flex-direction: column;\n}\n\n.ct-list-item {\n    display: flex;\n    align-items: flex-start;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-3);\n    border-bottom: 1px solid var(--ct-border-muted);\n    cursor: pointer;\n    transition: background var(--ct-transition-fast);\n}\n\n.ct-list-item:last-child {\n    border-bottom: none;\n}\n\n.ct-list-item:hover {\n    background: var(--ct-bg-secondary);\n}\n\n.ct-list-item--selected {\n    background: var(--ct-accent-muted);\n    border-left: 3px solid var(--ct-accent);\n}\n\n.ct-list-item--highlighted {\n    background: var(--ct-bg-tertiary);\n    outline: 2px solid var(--ct-accent);\n    outline-offset: -2px;\n}\n\n.ct-list-item__avatar {\n    width: 48px;\n    height: 48px;\n    border-radius: var(--ct-radius-sm);\n    object-fit: cover;\n    flex-shrink: 0;\n}\n\n.ct-list-item__avatar--sm {\n    width: 32px;\n    height: 32px;\n}\n\n.ct-list-item__avatar--circle {\n    border-radius: 50%;\n}\n\n.ct-list-item__content {\n    flex: 1;\n    min-width: 0;\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-list-item__title {\n    font-weight: 600;\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text);\n}\n\n.ct-list-item__subtitle {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-muted);\n}\n\n.ct-list-item__meta {\n    display: flex;\n    gap: var(--ct-space-3);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-list-item__actions {\n    display: flex;\n    gap: var(--ct-space-1);\n    opacity: 0;\n    transition: opacity var(--ct-transition-fast);\n}\n\n.ct-list-item:hover .ct-list-item__actions {\n    opacity: 1;\n}\n\n/* Empty state */\n.ct-empty {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: var(--ct-space-8);\n    text-align: center;\n    color: var(--ct-text-muted);\n}\n\n.ct-empty__icon {\n    font-size: 3rem;\n    opacity: 0.3;\n    margin-bottom: var(--ct-space-4);\n}\n\n.ct-empty__title {\n    font-weight: 500;\n    margin-bottom: var(--ct-space-2);\n}\n\n.ct-empty__text {\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-dim);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   FIELD CHECKBOXES - Multi-select field list\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-field-list {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n    max-height: 200px;\n    overflow-y: auto;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius);\n}\n\n.ct-field-item {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-3); /* Increase gap between elements */\n    padding: var(--ct-space-2) var(--ct-space-2);\n    border-radius: var(--ct-radius-sm);\n    transition: background var(--ct-transition-fast);\n}\n\n.ct-field-item:hover {\n    background: var(--ct-bg-tertiary);\n}\n\n.ct-field-item__label {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-3); /* Increase gap for better readability */\n    flex: 1;\n    min-width: 0; /* Allow text truncation */\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n}\n\n.ct-field-item__meta {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n/* Field item internal elements */\n.ct-field-label {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    flex: 1;\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n}\n\n.ct-field-checkbox {\n    width: auto !important;\n    margin: 0;\n    accent-color: var(--ct-accent);\n    cursor: pointer;\n    flex-shrink: 0;\n}\n\n.ct-field-name {\n    flex: 1;\n    color: var(--ct-text);\n}\n\n.ct-field-tokens,\n.ct-field-count {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n    flex-shrink: 0;\n    min-width: 2.5em;\n    text-align: right;\n}\n\n/* Expandable field groups (for alternate greetings) */\n.ct-field-group {\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n    overflow: hidden;\n}\n\n.ct-field-group .ct-field-item--parent {\n    background: var(--ct-bg-tertiary);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-field-group .ct-field-children {\n    display: none;\n    padding: var(--ct-space-1);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-field-group--expanded .ct-field-children {\n    display: block;\n}\n\n.ct-field-group .ct-field-item--child {\n    padding-left: var(--ct-space-4);\n}\n\n.ct-field-expand {\n    padding: var(--ct-space-1);\n    background: none;\n    border: none;\n    color: var(--ct-text-muted);\n    cursor: pointer;\n    transition: transform var(--ct-transition-fast);\n}\n\n.ct-field-expand:hover {\n    color: var(--ct-text);\n}\n\n.ct-field-group--expanded .ct-field-expand {\n    transform: rotate(180deg);\n}\n\n/* Field preview (collapsible content preview) */\n.ct-field-preview {\n    display: none;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-secondary);\n    border-top: 1px solid var(--ct-border-muted);\n}\n\n.ct-field-group--expanded .ct-field-preview {\n    display: flex;\n}\n\n.ct-field-preview__text {\n    position: relative;\n    margin: 0;\n    padding: var(--ct-space-2);\n    max-height: 100px;\n    overflow: hidden;\n    font-size: var(--ct-text-xs);\n    font-family: var(--ct-font-mono);\n    white-space: pre-wrap;\n    word-break: break-word;\n    line-height: 1.4;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    color: var(--ct-text-muted);\n}\n\n/* Fade out effect at bottom when content is truncated */\n.ct-field-preview__text::after {\n    content: '';\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    height: 30px;\n    background: linear-gradient(transparent, var(--ct-bg-tertiary));\n    pointer-events: none;\n}\n\n.ct-field-preview__more {\n    display: inline-flex;\n    align-items: center;\n    align-self: flex-start;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-1) var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-accent);\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-accent-muted);\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n    flex-shrink: 0;\n}\n\n.ct-field-preview__more:hover {\n    background: var(--ct-accent-muted);\n}\n\n.ct-field-preview-btn {\n    padding: var(--ct-space-1);\n    background: none;\n    border: none;\n    color: var(--ct-text-dim);\n    cursor: pointer;\n    transition: color var(--ct-transition-fast);\n}\n\n.ct-field-preview-btn:hover {\n    color: var(--ct-accent);\n}\n\n/* Popup preview styles */\n.ct-popup-preview {\n    margin: 0;\n    padding: var(--ct-space-3);\n    max-height: 60vh;\n    overflow-y: auto;\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-sm);\n    white-space: pre-wrap;\n    word-break: break-word;\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n}\n\n/* Select dropdown styling */\n.ct-select {\n    width: auto;\n    min-width: 120px;\n    padding: var(--ct-space-1) var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    font-family: var(--ct-font);\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: border-color var(--ct-transition-fast);\n}\n\n.ct-select:hover {\n    border-color: var(--ct-accent);\n}\n\n.ct-select:focus {\n    border-color: var(--ct-accent);\n    outline: none;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   RESULTS/OUTPUT PANEL\n   ───────────────────────────────────────────────────────────────────────────── */\n\n/* Results wrapper - flex container that manages layout */\n.ct-results-wrapper {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 0;\n    overflow: hidden;\n}\n\n/* Toolbar with view toggle */\n.ct-results-toolbar {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n}\n\n/* Scrollable content area */\n.ct-results-content {\n    flex: 1;\n    min-height: 0;\n    overflow-y: auto;\n}\n\n.ct-result {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n}\n\n.ct-result__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n}\n\n.ct-result__type {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-muted);\n}\n\n.ct-result__actions {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n/* JSON display mode toggle (smart/raw) */\n.ct-json-toggle {\n    display: flex;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    padding: 2px;\n}\n\n.ct-json-toggle__btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 28px;\n    height: 24px;\n    border: none;\n    background: transparent;\n    color: var(--ct-text-dim);\n    cursor: pointer;\n    border-radius: var(--ct-radius-sm);\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-json-toggle__btn:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-json-toggle__btn--active {\n    color: var(--ct-accent);\n    background: var(--ct-bg);\n    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n\n/* Text toggle (shares JSON toggle styling) */\n.ct-text-toggle {\n    display: flex;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    padding: 2px;\n}\n\n.ct-text-toggle__btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 28px;\n    height: 24px;\n    border: none;\n    background: transparent;\n    color: var(--ct-text-dim);\n    cursor: pointer;\n    border-radius: var(--ct-radius-sm);\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-text-toggle__btn:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-text-toggle__btn--active {\n    color: var(--ct-accent);\n    background: var(--ct-bg);\n    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n\n/* Raw text output */\n.ct-result__raw {\n    margin: 0;\n    padding: var(--ct-space-3);\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    white-space: pre-wrap;\n    word-break: break-word;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius);\n    color: var(--ct-text);\n    user-select: text;\n}\n\n.ct-result__content {\n    flex: 1;\n    overflow-y: auto;\n    padding: var(--ct-space-3);\n}\n\n.ct-result__json {\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    white-space: pre-wrap;\n    word-break: break-word;\n    padding: var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n}\n\n.ct-result__prose {\n    line-height: 1.7;\n}\n\n/* Code output with syntax highlighting */\n.ct-result__code {\n    margin: 0;\n    padding: var(--ct-space-3);\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.5;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius);\n    overflow-x: auto;\n}\n\n.ct-result__code code {\n    font-family: inherit;\n}\n\n/* Prose styling - minimal overrides, let showdown do its thing */\n.ct-result__prose {\n    font-size: var(--ct-text-sm);\n    line-height: 1.7;\n}\n\n.ct-result__prose h1,\n.ct-result__prose h2,\n.ct-result__prose h3 {\n    font-weight: 600;\n    margin-top: 1.25em;\n    margin-bottom: 0.5em;\n}\n\n.ct-result__prose h1:first-child,\n.ct-result__prose h2:first-child,\n.ct-result__prose h3:first-child {\n    margin-top: 0;\n}\n\n.ct-result__prose p {\n    margin: 0 0 0.75em 0;\n}\n\n.ct-result__prose ul,\n.ct-result__prose ol {\n    margin: 0.5em 0;\n    padding-left: 1.5em;\n}\n\n.ct-result__prose li {\n    margin: 0.25em 0;\n}\n\n.ct-result__prose code {\n    font-family: var(--ct-font-mono);\n    font-size: 0.9em;\n    padding: 0.15em 0.4em;\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-result__prose pre {\n    margin: 0.75em 0;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n    overflow-x: auto;\n}\n\n.ct-result__prose pre code {\n    padding: 0;\n    background: none;\n}\n\n.ct-result__prose strong {\n    font-weight: 600;\n}\n\n/* Alert message styling */\n.ct-alert__message {\n    margin-top: var(--ct-space-1);\n    font-size: var(--ct-text-sm);\n    white-space: pre-wrap;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   COMPARE VIEW\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-compare-view {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 0;\n}\n\n.ct-compare-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    border-bottom: 1px solid var(--ct-border);\n    flex-shrink: 0;\n}\n\n.ct-compare-stats {\n    display: flex;\n    gap: var(--ct-space-2);\n}\n\n.ct-compare-list {\n    flex: 1;\n    overflow-y: auto;\n    padding: var(--ct-space-2);\n}\n\n.ct-compare-row {\n    margin-bottom: var(--ct-space-3);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius);\n    overflow: hidden;\n}\n\n.ct-compare-row--changed {\n    border-color: var(--ct-accent);\n}\n\n.ct-compare-row--unchanged {\n    opacity: 0.7;\n}\n\n.ct-compare-row__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border);\n}\n\n.ct-compare-row__label {\n    font-weight: 600;\n    font-size: var(--ct-text-sm);\n}\n\n.ct-compare-row__content {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: 1px;\n    background: var(--ct-border);\n}\n\n.ct-compare-row__content--single {\n    grid-template-columns: 1fr;\n    background: transparent;\n}\n\n.ct-compare-col {\n    background: var(--ct-bg);\n    padding: var(--ct-space-2);\n}\n\n.ct-compare-col__header {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    font-weight: 600;\n    text-transform: uppercase;\n    color: var(--ct-text-dim);\n    margin-bottom: var(--ct-space-2);\n}\n\n.ct-compare-col--original .ct-compare-col__header {\n    color: var(--ct-danger);\n}\n\n.ct-compare-col--rewritten .ct-compare-col__header {\n    color: var(--ct-success);\n}\n\n.ct-compare-text {\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    white-space: pre-wrap;\n    word-break: break-word;\n    margin: 0;\n    max-height: 200px;\n    overflow-y: auto;\n}\n\n.ct-diff--added {\n    background: rgba(var(--ct-success-rgb, 46, 160, 67), 0.2);\n    color: var(--ct-success);\n    padding: 0 2px;\n    border-radius: 2px;\n}\n\n.ct-diff--removed {\n    background: rgba(var(--ct-danger-rgb, 248, 81, 73), 0.2);\n    color: var(--ct-danger);\n    text-decoration: line-through;\n    opacity: 0.8;\n    padding: 0 2px;\n    border-radius: 2px;\n}\n\n/* Diff stats (GitHub-style +/- display) */\n.ct-diff-stats {\n    display: inline-flex;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    font-family: var(--ct-font-mono);\n    font-weight: 600;\n}\n\n.ct-diff-stats__add {\n    color: var(--ct-success);\n}\n\n.ct-diff-stats__del {\n    color: var(--ct-danger);\n}\n\n.ct-compare-row__badges {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-compare-popup {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: var(--ct-space-4);\n}\n\n.ct-compare-popup__side h4 {\n    margin-bottom: var(--ct-space-2);\n    font-weight: 600;\n}\n\n.ct-compare-popup__side pre {\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    white-space: pre-wrap;\n    word-break: break-word;\n    max-height: 400px;\n    overflow-y: auto;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n}\n\n/* View mode toggle */\n.ct-view-toggle {\n    display: flex;\n    gap: var(--ct-space-1);\n    background: var(--ct-bg-secondary);\n    padding: var(--ct-space-1);\n    border-radius: var(--ct-radius);\n}\n\n.ct-view-toggle__btn {\n    padding: var(--ct-space-1) var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    border-radius: calc(var(--ct-radius) - 2px);\n    background: transparent;\n    border: none;\n    color: var(--ct-text-dim);\n    cursor: pointer;\n    transition: all 0.15s ease;\n}\n\n.ct-view-toggle__btn:hover {\n    color: var(--ct-text);\n}\n\n.ct-view-toggle__btn--active {\n    background: var(--ct-bg);\n    color: var(--ct-text);\n    box-shadow: var(--ct-shadow-sm);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   ALERTS & MESSAGES\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-alert {\n    display: flex;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-3);\n    border-radius: var(--ct-radius);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-alert--info {\n    background: var(--ct-accent-muted);\n    border: 1px solid var(--ct-accent);\n    color: var(--ct-accent);\n}\n\n.ct-alert--success {\n    background: var(--ct-success-bg);\n    border: 1px solid var(--ct-success);\n    color: var(--ct-success);\n}\n\n.ct-alert--warning {\n    background: var(--ct-warning-bg);\n    border: 1px solid var(--ct-warning);\n    color: var(--ct-warning);\n}\n\n.ct-alert--danger {\n    background: var(--ct-danger-bg);\n    border: 1px solid var(--ct-danger);\n    color: var(--ct-danger);\n}\n\n.ct-alert__icon {\n    flex-shrink: 0;\n}\n\n.ct-alert__content {\n    flex: 1;\n}\n\n.ct-alert__title {\n    font-weight: 600;\n    margin-bottom: var(--ct-space-1);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   GENERATING/LOADING INDICATOR\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-loading {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-3);\n    background: var(--ct-accent-muted);\n    border-radius: var(--ct-radius);\n    color: var(--ct-accent);\n    font-size: var(--ct-text-sm);\n    animation: ct-pulse 2s ease-in-out infinite;\n}\n\n.ct-loading__spinner {\n    animation: ct-spin 1s linear infinite;\n}\n\n@keyframes ct-spin {\n    to {\n        transform: rotate(360deg);\n    }\n}\n\n@keyframes ct-pulse {\n    0%,\n    100% {\n        opacity: 1;\n    }\n    50% {\n        opacity: 0.6;\n    }\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BADGES\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-badge {\n    display: inline-flex;\n    align-items: center;\n    padding: 0.2em 0.6em;\n    font-size: var(--ct-text-xs);\n    font-weight: 500;\n    border-radius: var(--ct-radius-pill);\n    text-transform: uppercase;\n    letter-spacing: 0.03em;\n}\n\n.ct-badge--default {\n    background: var(--ct-bg-tertiary);\n    color: var(--ct-text-muted);\n}\n\n.ct-badge--accent {\n    background: var(--ct-accent-muted);\n    color: var(--ct-accent);\n}\n\n.ct-badge--success {\n    background: var(--ct-success-bg);\n    color: var(--ct-success);\n}\n\n.ct-badge--warning {\n    background: var(--ct-warning-bg);\n    color: var(--ct-warning);\n}\n\n.ct-badge--danger {\n    background: var(--ct-danger-bg);\n    color: var(--ct-danger);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   HISTORY PANEL (Collapsible)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-history {\n    flex-shrink: 0;\n    border-top: 1px solid var(--ct-border-muted);\n    background: var(--ct-bg);\n}\n\n.ct-history__toggle {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    width: 100%;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border: none;\n    cursor: pointer;\n    font-size: var(--ct-text-xs);\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    text-align: left;\n}\n\n.ct-history__toggle:hover {\n    background: var(--ct-bg-tertiary);\n    color: var(--ct-text);\n}\n\n.ct-history__toggle-icon {\n    margin-left: auto;\n    transition: transform var(--ct-transition-fast);\n}\n\n.ct-history--collapsed .ct-history__toggle-icon {\n    transform: rotate(-90deg);\n}\n\n.ct-history--collapsed .ct-history__list {\n    display: none;\n}\n\n.ct-history__list {\n    max-height: 180px;\n    overflow-y: auto;\n    padding: var(--ct-space-1);\n    background: var(--ct-bg-secondary);\n}\n\n/* List item error state (for history) */\n.ct-list-item--error {\n    border-left: 3px solid var(--ct-danger);\n}\n\n.ct-list-item--error .ct-list-item__title {\n    color: var(--ct-danger);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   PRESET MANAGER - Unified preset management section\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-presets-manager {\n    margin-top: var(--ct-space-3);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius);\n    background: var(--ct-bg-secondary);\n    overflow: hidden;\n}\n\n.ct-presets-manager__toggle {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    width: 100%;\n    padding: var(--ct-space-3);\n    background: transparent;\n    border: none;\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n    font-weight: 600;\n    color: var(--ct-text);\n    text-align: left;\n    transition: background var(--ct-transition-fast);\n}\n\n.ct-presets-manager__toggle:hover {\n    background: var(--ct-bg-tertiary);\n}\n\n.ct-presets-manager__title {\n    flex: 1;\n}\n\n.ct-presets-manager__count {\n    padding: 0.125em 0.5em;\n    font-size: var(--ct-text-xs);\n    font-weight: 500;\n    background: var(--ct-accent-muted);\n    color: var(--ct-accent);\n    border-radius: var(--ct-radius-pill);\n}\n\n.ct-presets-manager__chevron {\n    color: var(--ct-text-muted);\n    transition: transform var(--ct-transition-fast);\n}\n\n.ct-presets-manager--collapsed .ct-presets-manager__chevron {\n    transform: rotate(-90deg);\n}\n\n.ct-presets-manager--collapsed .ct-presets-manager__content {\n    display: none;\n}\n\n.ct-presets-manager__content {\n    border-top: 1px solid var(--ct-border-muted);\n}\n\n.ct-presets-manager__tabs {\n    display: flex;\n    background: var(--ct-bg-tertiary);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-presets-manager__tab {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: transparent;\n    border: none;\n    border-bottom: 2px solid transparent;\n    cursor: pointer;\n    font-size: var(--ct-text-xs);\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-presets-manager__tab:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-presets-manager__tab--active {\n    color: var(--ct-accent);\n    border-bottom-color: var(--ct-accent);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-presets-manager__tab .ct-badge {\n    background: var(--ct-bg-tertiary);\n    color: var(--ct-text-muted);\n}\n\n.ct-presets-manager__tab--active .ct-badge {\n    background: var(--ct-accent-muted);\n    color: var(--ct-accent);\n}\n\n.ct-presets-manager__list {\n    max-height: 200px;\n    overflow-y: auto;\n    padding: var(--ct-space-2);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-preset-empty {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-4);\n    color: var(--ct-text-muted);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-preset-empty i {\n    font-size: 1.5em;\n    opacity: 0.5;\n}\n\n.ct-preset-item {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-preset-item:hover {\n    border-color: var(--ct-border);\n}\n\n.ct-preset-item--builtin {\n    opacity: 0.85;\n}\n\n.ct-preset-info {\n    flex: 1;\n    min-width: 0;\n    display: flex;\n    flex-direction: column;\n    gap: 2px;\n}\n\n.ct-preset-name {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-preset-name i {\n    font-size: 0.75em;\n}\n\n.ct-preset-stages {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-preset-actions {\n    display: flex;\n    gap: 2px;\n    flex-shrink: 0;\n    opacity: 0.6;\n    transition: opacity var(--ct-transition-fast);\n}\n\n.ct-preset-item:hover .ct-preset-actions {\n    opacity: 1;\n}\n\n.ct-preset-action {\n    padding: var(--ct-space-1) !important;\n    min-width: 0 !important;\n}\n\n.ct-presets-manager__actions {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-top: 1px solid var(--ct-border-muted);\n}\n\n.ct-presets-manager__io {\n    display: flex;\n    gap: var(--ct-space-1);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SESSIONS PANEL (Collapsible)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-sessions {\n    margin-top: var(--ct-space-4);\n    border-top: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n}\n\n.ct-sessions__toggle {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    width: 100%;\n    padding: var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border: none;\n    border-left: 2px solid transparent;\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n    text-align: left;\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-sessions__toggle::before {\n    content: '\\f07c'; /* folder-open icon */\n    font-family: 'Font Awesome 6 Free';\n    font-weight: 900;\n    color: var(--ct-text-muted);\n    transition: color var(--ct-transition-fast);\n}\n\n.ct-sessions__toggle:hover {\n    background: var(--ct-bg-tertiary);\n    border-left-color: var(--ct-accent);\n}\n\n.ct-sessions__toggle:hover::before {\n    color: var(--ct-accent);\n}\n\n.ct-sessions__toggle-icon {\n    margin-left: auto;\n    color: var(--ct-text-muted);\n    transition:\n        transform var(--ct-transition-fast),\n        color var(--ct-transition-fast);\n}\n\n.ct-sessions__toggle:hover .ct-sessions__toggle-icon {\n    color: var(--ct-text);\n}\n\n.ct-sessions--hidden {\n    display: none;\n}\n\n.ct-sessions--collapsed .ct-sessions__toggle-icon {\n    transform: rotate(-90deg);\n}\n\n.ct-sessions--collapsed .ct-sessions__content {\n    display: none;\n}\n\n.ct-sessions__content {\n    padding: var(--ct-space-2);\n    background: var(--ct-bg);\n}\n\n.ct-sessions__actions {\n    display: flex;\n    gap: var(--ct-space-2);\n    margin-bottom: var(--ct-space-2);\n}\n\n.ct-sessions__list {\n    max-height: 200px;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n/* Session Item */\n.ct-session-item {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-session-item:hover {\n    border-color: var(--ct-border);\n    background: var(--ct-bg-tertiary);\n}\n\n.ct-session-item--active {\n    border-color: var(--ct-accent);\n    background: var(--ct-accent-muted);\n}\n\n.ct-session-item__content {\n    flex: 1;\n    min-width: 0;\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-session-item__header {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-session-item__date {\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n}\n\n.ct-session-item__meta {\n    display: flex;\n    gap: var(--ct-space-3);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-session-item__meta span {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n}\n\n.ct-session-item__actions {\n    display: flex;\n    gap: var(--ct-space-1);\n    opacity: 0;\n    transition: opacity var(--ct-transition-fast);\n}\n\n.ct-session-item:hover .ct-session-item__actions {\n    opacity: 1;\n}\n\n.ct-session-item--active .ct-session-item__actions {\n    opacity: 1;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   PREVIEW & ERROR CONTENT (for popups)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-preview-content {\n    max-height: 60vh;\n    overflow-y: auto;\n    padding: var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n}\n\n.ct-preview-content pre {\n    margin: 0;\n    padding: 0;\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.5;\n    white-space: pre-wrap;\n    word-break: break-word;\n}\n\n.ct-error-box {\n    padding: var(--ct-space-3);\n    background: var(--ct-danger-bg);\n    border: 1px solid var(--ct-danger);\n    border-radius: var(--ct-radius);\n    color: var(--ct-danger);\n    font-size: var(--ct-text-sm);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   STAGE CONFIG COMPONENT\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-stage-config {\n    /* Inherits from ct-section */\n}\n\n.ct-stage-config .ct-form-group textarea {\n    min-height: 120px;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Two-column layout\n   ───────────────────────────────────────────────────────────────────────────── */\n\n/* Override ST popup sizing for settings modal */\n.popup:has(.ct-settings-modal) {\n    width: 90dvw;\n    max-width: 900px;\n    min-width: 320px;\n    padding: 0;\n}\n\n@media (min-width: 1024px) {\n    .popup:has(.ct-settings-modal) {\n        max-width: 1000px;\n    }\n}\n\n/* Container for settings modal content */\n.ct-settings-modal {\n    display: flex;\n    flex-direction: column;\n    max-height: 80vh;\n    color: var(--ct-text);\n    font-family: var(--ct-font);\n    font-size: var(--ct-font-size);\n}\n\n.ct-settings-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-settings-header h2 {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    margin: 0;\n    font-size: var(--ct-text-lg);\n    font-weight: 600;\n}\n\n.ct-settings-header h2 i {\n    color: var(--ct-accent);\n}\n\n.ct-settings-body {\n    flex: 1;\n    overflow-y: auto;\n    padding: var(--ct-space-4);\n    scrollbar-width: thin;\n    scrollbar-color: var(--ct-border) transparent;\n}\n\n.ct-settings-columns {\n    display: grid;\n    grid-template-columns: 1fr;\n    gap: var(--ct-space-4);\n}\n\n/* Two-column layout requires more space to prevent truncation */\n@media (min-width: 850px) {\n    .ct-settings-columns {\n        grid-template-columns: 1fr 1fr;\n    }\n}\n\n/* Give left column (Generation settings) more space at wide viewports */\n@media (min-width: 1000px) {\n    .ct-settings-columns {\n        grid-template-columns: 1.2fr 1fr;\n    }\n}\n\n.ct-settings-column {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-4);\n}\n\n.ct-settings-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius);\n}\n\n.ct-settings-section h3 {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    margin: 0 0 var(--ct-space-2) 0;\n    padding-bottom: var(--ct-space-2);\n    border-bottom: 1px solid var(--ct-border-muted);\n    font-size: var(--ct-text-base);\n    font-weight: 600;\n}\n\n.ct-settings-section h3 i {\n    color: var(--ct-accent);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-settings-footer {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-3) var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border-top: 1px solid var(--ct-border-muted);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - API Status Banner\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-api-banner {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    border-radius: var(--ct-radius);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    margin-bottom: var(--ct-space-3);\n}\n\n.ct-api-banner--ready {\n    border-color: var(--ct-success);\n    background: color-mix(\n        in srgb,\n        var(--ct-success) 10%,\n        var(--ct-bg-secondary)\n    );\n}\n\n.ct-api-banner--error {\n    border-color: var(--ct-error);\n    background: color-mix(in srgb, var(--ct-error) 10%, var(--ct-bg-secondary));\n}\n\n.ct-api-banner__left {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-api-banner--ready .ct-api-banner__left i {\n    color: var(--ct-success);\n}\n\n.ct-api-banner--error .ct-api-banner__left i {\n    color: var(--ct-error);\n}\n\n.ct-api-banner__name {\n    font-weight: 500;\n    font-size: var(--ct-text-sm);\n}\n\n.ct-api-banner__right {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-3);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-muted);\n}\n\n.ct-api-banner__model {\n    max-width: 200px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-api-error {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    margin-bottom: var(--ct-space-3);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-error);\n    background: color-mix(in srgb, var(--ct-error) 8%, transparent);\n    border-radius: var(--ct-radius);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Generation Mode Toggle\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-gen-mode-toggle {\n    display: flex;\n    gap: var(--ct-space-2);\n    margin-bottom: var(--ct-space-3);\n}\n\n.ct-gen-mode-option {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius);\n    background: var(--ct-bg-secondary);\n    cursor: pointer;\n    transition: all var(--ct-transition);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-gen-mode-option input[type='radio'] {\n    display: none;\n}\n\n.ct-gen-mode-option:hover {\n    border-color: var(--ct-border);\n    background: var(--ct-bg-hover);\n}\n\n.ct-gen-mode-option--active {\n    border-color: var(--ct-accent);\n    background: color-mix(\n        in srgb,\n        var(--ct-accent) 15%,\n        var(--ct-bg-secondary)\n    );\n}\n\n.ct-gen-mode-option--active i {\n    color: var(--ct-accent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Profile Selection\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-profile-section {\n    padding: var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius);\n    border: 1px solid var(--ct-border-muted);\n}\n\n.ct-profile-info {\n    margin-top: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-profile-info--empty {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    color: var(--ct-text-dim);\n    font-size: var(--ct-text-sm);\n    font-style: italic;\n}\n\n.ct-profile-info--error {\n    border: 1px solid var(--ct-error);\n}\n\n.ct-profile-info__row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-1) 0;\n    font-size: var(--ct-text-xs);\n}\n\n.ct-profile-info__row:not(:last-child) {\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-profile-info__label {\n    color: var(--ct-text-muted);\n}\n\n.ct-profile-info__value {\n    font-weight: 500;\n    max-width: 200px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-profile-info__error {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    margin-top: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-error);\n    background: color-mix(in srgb, var(--ct-error) 10%, transparent);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-profile-empty {\n    display: flex;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-3);\n    color: var(--ct-text-muted);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-profile-empty i {\n    color: var(--ct-accent);\n    flex-shrink: 0;\n    margin-top: 2px;\n}\n\n.ct-profile-empty strong {\n    display: block;\n    margin-bottom: var(--ct-space-1);\n    color: var(--ct-text);\n}\n\n.ct-profile-empty p {\n    margin: 0;\n    font-size: var(--ct-text-xs);\n    line-height: 1.4;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Form Elements\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-setting-item {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-setting-label {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n    cursor: pointer;\n}\n\n.ct-setting-label input[type='checkbox'] {\n    width: auto;\n    accent-color: var(--ct-accent);\n    cursor: pointer;\n}\n\n.ct-setting-hint {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-setting-desc {\n    margin: 0 0 var(--ct-space-2) 0;\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-muted);\n    line-height: 1.5;\n}\n\n.ct-number-input {\n    width: 120px !important;\n    padding: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-textarea {\n    width: 100%;\n    min-height: 100px;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-family: var(--ct-font);\n    line-height: 1.5;\n    resize: vertical;\n}\n\n.ct-readonly-text {\n    margin: 0;\n    padding: var(--ct-space-3);\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.5;\n    white-space: pre-wrap;\n    word-break: break-word;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    max-height: 150px;\n    overflow-y: auto;\n}\n\n.ct-version {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Preset Tabs & Lists\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-presets-tabs {\n    display: flex;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-1);\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    margin-bottom: var(--ct-space-3);\n}\n\n.ct-presets-tab {\n    flex: 1;\n    padding: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    background: transparent;\n    border: none;\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-presets-tab:hover {\n    color: var(--ct-text);\n    background: var(--ct-bg-secondary);\n}\n\n.ct-presets-tab--active {\n    color: var(--ct-text);\n    background: var(--ct-bg);\n    box-shadow: var(--ct-shadow-sm);\n}\n\n.ct-presets-list {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n    max-height: 250px;\n    overflow-y: auto;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n    margin-bottom: var(--ct-space-3);\n}\n\n.ct-preset-item {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-preset-item:hover {\n    border-color: var(--ct-border);\n    background: var(--ct-bg);\n}\n\n.ct-preset-item--builtin {\n    opacity: 0.8;\n}\n\n.ct-preset-info {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n    min-width: 0;\n    flex: 1;\n}\n\n.ct-preset-name {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.ct-preset-stages {\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-preset-actions {\n    display: flex;\n    gap: var(--ct-space-1);\n    flex-shrink: 0;\n}\n\n.ct-presets-actions {\n    display: flex;\n    gap: var(--ct-space-2);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Shortcuts List\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-shortcuts-list {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-shortcuts-list .ct-shortcut {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-shortcuts-list .ct-shortcut kbd {\n    display: inline-flex;\n    align-items: center;\n    padding: 0.2em 0.5em;\n    font-family: var(--ct-font);\n    font-size: var(--ct-text-xs);\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-shortcuts-list .ct-shortcut span {\n    color: var(--ct-text-muted);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SETTINGS MODAL - Debug Actions\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-debug-actions {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--ct-space-2);\n    margin-top: var(--ct-space-2);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   FORM ELEMENTS (shared by settings modal, preset drawer)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-label {\n    display: block;\n    margin-bottom: var(--ct-space-1);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    color: var(--ct-text);\n}\n\n.ct-required {\n    color: var(--ct-danger);\n}\n\n.ct-input {\n    width: 100%;\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-family: var(--ct-font);\n}\n\n.ct-hint {\n    display: block;\n    margin-top: var(--ct-space-1);\n    font-size: var(--ct-text-xs);\n    color: var(--ct-text-dim);\n}\n\n.ct-checkbox-group {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--ct-space-3);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-checkbox-label {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text);\n    cursor: pointer;\n}\n\n.ct-checkbox-label input[type='checkbox'] {\n    width: auto;\n    accent-color: var(--ct-accent);\n    cursor: pointer;\n}\n\n.ct-textarea--code {\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    tab-size: 2;\n}\n\n.ct-textarea--compact {\n    min-height: 60px;\n    padding: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    line-height: 1.4;\n    resize: vertical;\n}\n\n.ct-schema-toolbar {\n    display: flex;\n    gap: var(--ct-space-2);\n    margin-bottom: var(--ct-space-2);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   PRESET EDITOR - Validation Messages\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-errors,\n.ct-warnings {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-3);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-errors {\n    background: var(--ct-danger-bg);\n    border: 1px solid var(--ct-danger);\n}\n\n.ct-warnings {\n    background: var(--ct-warning-bg);\n    border: 1px solid var(--ct-warning);\n}\n\n.ct-error {\n    font-size: var(--ct-text-sm);\n    color: var(--ct-danger);\n}\n\n.ct-warning {\n    font-size: var(--ct-text-sm);\n    color: var(--ct-warning);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BUTTON VARIANTS - Consolidated modifiers for all CT contexts\n   ─────────────────────────────────────────────────────────────────────────────\n   These extend ST's .menu_button with consistent modifiers. Use the consolidated\n   selector pattern to apply to all CT contexts (popup, settings, drawer, etc.)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n/* Base menu_button normalization for ALL CT contexts */\n.ct-popup .menu_button,\n.ct-settings-modal .menu_button,\n.ct-drawer .menu_button {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    font-weight: 500;\n    white-space: nowrap;\n    border-radius: var(--ct-radius-sm);\n    transition: all var(--ct-transition-fast);\n    width: auto;\n    min-width: auto;\n    margin: 0;\n}\n\n/* Icon-only button (square) */\n.ct-popup .menu_button--icon,\n.ct-settings-modal .menu_button--icon,\n.ct-drawer .menu_button--icon {\n    padding: var(--ct-space-2);\n    aspect-ratio: 1;\n}\n\n/* Small button */\n.ct-popup .menu_button--sm,\n.ct-settings-modal .menu_button--sm,\n.ct-drawer .menu_button--sm {\n    padding: var(--ct-space-1) var(--ct-space-2);\n    font-size: var(--ct-text-xs);\n}\n\n/* Large button */\n.ct-popup .menu_button--lg,\n.ct-settings-modal .menu_button--lg,\n.ct-drawer .menu_button--lg {\n    padding: var(--ct-space-3) var(--ct-space-4);\n    font-size: var(--ct-text-base);\n}\n\n/* Full width button */\n.ct-popup .menu_button--full,\n.ct-settings-modal .menu_button--full,\n.ct-drawer .menu_button--full {\n    width: 100%;\n}\n\n/* Primary (accent) button */\n.ct-popup .menu_button--primary,\n.ct-settings-modal .menu_button--primary,\n.ct-drawer .menu_button--primary {\n    background: var(--ct-accent);\n    border-color: var(--ct-accent);\n    color: var(--ct-bg);\n    filter: none;\n}\n\n.ct-popup .menu_button--primary:hover:not(:disabled),\n.ct-settings-modal .menu_button--primary:hover:not(:disabled),\n.ct-drawer .menu_button--primary:hover:not(:disabled) {\n    background: var(--ct-accent-hover);\n    border-color: var(--ct-accent-hover);\n    filter: none;\n}\n\n/* Danger button */\n.ct-popup .menu_button--danger,\n.ct-settings-modal .menu_button--danger,\n.ct-drawer .menu_button--danger {\n    background: var(--ct-danger);\n    border-color: var(--ct-danger);\n    color: white;\n    filter: none;\n}\n\n.ct-popup .menu_button--danger:hover:not(:disabled),\n.ct-settings-modal .menu_button--danger:hover:not(:disabled),\n.ct-drawer .menu_button--danger:hover:not(:disabled) {\n    filter: brightness(1.1);\n}\n\n/* Ghost button (transparent background) */\n.ct-popup .menu_button--ghost,\n.ct-settings-modal .menu_button--ghost,\n.ct-drawer .menu_button--ghost {\n    background: transparent;\n    border-color: transparent;\n}\n\n.ct-popup .menu_button--ghost:hover:not(:disabled),\n.ct-settings-modal .menu_button--ghost:hover:not(:disabled),\n.ct-drawer .menu_button--ghost:hover:not(:disabled) {\n    background: var(--ct-bg-secondary);\n}\n\n/* Disabled state (applies to all variants) */\n.ct-popup .menu_button:disabled,\n.ct-settings-modal .menu_button:disabled,\n.ct-drawer .menu_button:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n    filter: grayscale(0.5);\n}\n\n/* Active toggle state (for link/unlink buttons, etc.) */\n.ct-popup .menu_button.ct-active,\n.ct-settings-modal .menu_button.ct-active,\n.ct-drawer .menu_button.ct-active {\n    color: var(--ct-accent);\n    background: var(--ct-accent-muted);\n    border-color: var(--ct-accent);\n}\n\n.ct-popup .menu_button.ct-active:hover:not(:disabled),\n.ct-settings-modal .menu_button.ct-active:hover:not(:disabled),\n.ct-drawer .menu_button.ct-active:hover:not(:disabled) {\n    background: color-mix(in srgb, var(--ct-accent) 40%, transparent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BADGE VARIANTS - Additional modifiers\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-badge--small {\n    padding: 0.1em 0.4em;\n    font-size: 0.65rem;\n}\n\n.ct-badge--info {\n    background: var(--ct-accent-muted);\n    color: var(--ct-accent);\n}\n\n.ct-badge--muted {\n    background: var(--ct-bg-tertiary);\n    color: var(--ct-text-dim);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   COLLAPSIBLE DETAILS\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-collapsible {\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-collapsible summary {\n    padding: var(--ct-space-2) var(--ct-space-3);\n    cursor: pointer;\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-muted);\n    background: var(--ct-bg-tertiary);\n    user-select: none;\n}\n\n.ct-collapsible summary:hover {\n    color: var(--ct-text);\n}\n\n.ct-collapsible summary::-webkit-details-marker {\n    margin-right: var(--ct-space-2);\n}\n\n.ct-collapsible__content {\n    padding: var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-muted);\n    max-height: 150px;\n    overflow-y: auto;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   KEYBOARD SHORTCUTS\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-shortcuts {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-shortcut {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n}\n\n.ct-shortcut kbd {\n    display: inline-flex;\n    align-items: center;\n    padding: 0.2em 0.5em;\n    font-family: var(--ct-font);\n    font-size: var(--ct-text-xs);\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius-sm);\n}\n\n.ct-shortcut__desc {\n    color: var(--ct-text-muted);\n}\n\n/* =============================================================================\n   5. RESPONSIVE OVERRIDES\n   =============================================================================\n   Mobile-first means base styles are mobile. These add desktop enhancements.\n   ============================================================================= */\n\n/* Touch-friendly tap targets on mobile */\n@media (max-width: 768px) {\n    .ct-popup .menu_button {\n        min-height: 44px;\n        padding: var(--ct-space-3);\n    }\n\n    .ct-tab {\n        min-height: 44px;\n    }\n\n    .ct-list-item {\n        padding: var(--ct-space-4);\n    }\n\n    /* Always show action buttons on mobile (no hover) */\n    .ct-list-item__actions {\n        opacity: 1;\n    }\n}\n\n/* Reduce motion for accessibility */\n@media (prefers-reduced-motion: reduce) {\n    .ct-popup *,\n    .ct-popup *::before,\n    .ct-popup *::after {\n        animation-duration: 0.01ms !important;\n        animation-iteration-count: 1 !important;\n        transition-duration: 0.01ms !important;\n    }\n}\n\n/* High contrast mode */\n@media (prefers-contrast: high) {\n    .ct-popup {\n        --ct-border: var(--ct-text);\n        --ct-border-muted: var(--ct-text-muted);\n    }\n}\n\n/* =============================================================================\n   6. PRESET DRAWER\n   =============================================================================\n   Slideout panel for preset editing. Positioned absolute within the ST popup\n   dialog to stay in the browser's top layer stacking context.\n   ============================================================================= */\n\n/* Drawer container - absolute within popup dialog */\n.ct-drawer {\n    position: absolute;\n    inset: 0;\n    z-index: 100; /* Above popup content but within dialog */\n    pointer-events: none;\n    overflow: hidden;\n}\n\n.ct-drawer[aria-hidden='true'] {\n    visibility: hidden;\n}\n\n.ct-drawer--open {\n    pointer-events: auto;\n    visibility: visible;\n}\n\n/* Backdrop with fade animation */\n.ct-drawer__backdrop {\n    position: absolute;\n    inset: 0;\n    background: rgba(0, 0, 0, 0.6);\n    opacity: 0;\n    transition: opacity var(--ct-transition);\n    backdrop-filter: blur(4px);\n}\n\n.ct-drawer--open .ct-drawer__backdrop {\n    opacity: 1;\n}\n\n/* Panel slides in from right */\n.ct-drawer__panel {\n    position: absolute;\n    top: 0;\n    right: 0;\n    bottom: 0;\n    width: 100%;\n    max-width: 640px;\n    background: var(--SmartThemeBlurTintColor, var(--ct-bg));\n    border-left: 1px solid var(--ct-border);\n    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.4);\n    transform: translateX(100%);\n    transition: transform var(--ct-transition);\n    display: flex;\n    flex-direction: column;\n}\n\n.ct-drawer--open .ct-drawer__panel {\n    transform: translateX(0);\n}\n\n/* On mobile, full width */\n@media (max-width: 768px) {\n    .ct-drawer__panel {\n        max-width: none;\n    }\n}\n\n/* Drawer content layout */\n.ct-drawer__content {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    min-height: 0;\n}\n\n/* Header */\n.ct-drawer__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--ct-space-3) var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border-bottom: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n}\n\n.ct-drawer__title {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-drawer__title h3 {\n    margin: 0;\n    font-size: var(--ct-text-lg);\n    font-weight: 600;\n}\n\n.ct-drawer__title i {\n    font-size: var(--ct-text-base);\n}\n\n/* Body */\n.ct-drawer__body {\n    flex: 1;\n    min-height: 0;\n    overflow-y: auto;\n    padding: var(--ct-space-4);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-4);\n}\n\n/* Footer */\n.ct-drawer__footer {\n    display: flex;\n    align-items: center;\n    padding: var(--ct-space-3) var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border-top: 1px solid var(--ct-border-muted);\n    flex-shrink: 0;\n}\n\n/* =============================================================================\n   STAGE CHIPS - Compact stage selection\n   ============================================================================= */\n\n.ct-stage-chips {\n    display: flex;\n    flex-wrap: wrap;\n    gap: var(--ct-space-2);\n}\n\n.ct-chip {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-1) var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    color: var(--ct-text-muted);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border-muted);\n    border-radius: var(--ct-radius-pill);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n    user-select: none;\n}\n\n.ct-chip:hover {\n    border-color: var(--ct-border);\n    color: var(--ct-text);\n}\n\n.ct-chip--active {\n    color: var(--ct-accent);\n    background: var(--ct-accent-muted);\n    border-color: var(--ct-accent);\n}\n\n.ct-chip input[type='checkbox'] {\n    display: none;\n}\n\n/* =============================================================================\n   EDITOR COMPONENTS\n   ============================================================================= */\n\n/* Editor wrapper for prompt textarea */\n.ct-editor-wrap {\n    position: relative;\n    flex: 1;\n    min-height: 200px;\n}\n\n.ct-textarea--editor {\n    width: 100%;\n    height: 100%;\n    min-height: 200px;\n    resize: vertical;\n    font-family: var(--ct-font);\n    font-size: var(--ct-text-sm);\n    line-height: 1.6;\n}\n\n/* Editor toolbar */\n.ct-editor-toolbar {\n    display: flex;\n    flex-wrap: wrap;\n    align-items: center;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-border-muted);\n    border-bottom: none;\n    border-radius: var(--ct-radius) var(--ct-radius) 0 0;\n}\n\n.ct-toolbar-divider {\n    width: 1px;\n    height: 1.5em;\n    background: var(--ct-border-muted);\n    margin: 0 var(--ct-space-1);\n}\n\n/* Code editor with syntax highlighting */\n.ct-code-editor {\n    position: relative;\n    flex: 1;\n    min-height: 250px;\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n    border: 1px solid var(--ct-border);\n    border-top: none;\n    border-radius: 0 0 var(--ct-radius) var(--ct-radius);\n    overflow: hidden;\n}\n\n.ct-code-editor__highlight,\n.ct-code-editor__textarea {\n    position: absolute;\n    inset: 0;\n    margin: 0;\n    padding: var(--ct-space-3);\n    font-family: inherit;\n    font-size: inherit;\n    line-height: inherit;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    overflow: auto;\n}\n\n.ct-code-editor__highlight {\n    pointer-events: none;\n    background: var(--ct-bg-secondary);\n    color: var(--ct-text);\n}\n\n.ct-code-editor__highlight code {\n    font-family: inherit;\n    background: transparent;\n}\n\n.ct-code-editor__textarea {\n    background: transparent;\n    color: transparent;\n    caret-color: var(--ct-text);\n    resize: none;\n    border: none;\n    outline: none;\n    z-index: 1;\n}\n\n.ct-code-editor__textarea::selection {\n    background: var(--ct-accent-muted);\n}\n\n/* Syntax highlighting colors (using hljs classes) */\n.ct-code-editor .hljs-string {\n    color: var(--ct-success);\n}\n\n.ct-code-editor .hljs-number {\n    color: var(--ct-warning);\n}\n\n.ct-code-editor .hljs-literal {\n    color: var(--ct-accent);\n}\n\n.ct-code-editor .hljs-attr {\n    color: var(--ct-text);\n}\n\n.ct-code-editor .hljs-punctuation {\n    color: var(--ct-text-muted);\n}\n\n/* Form group that grows to fill space */\n.ct-form-group--grow {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    min-height: 0;\n}\n\n/* =============================================================================\n   DRAWER BUTTONS\n   =============================================================================\n   NOTE: Button styles for drawer are now consolidated in the \"BUTTON VARIANTS\"\n   section above. This section is kept for any drawer-specific overrides.\n   ============================================================================= */\n\n/* =============================================================================\n   PRESET MANAGEMENT BUTTON - Trigger for drawer\n   ============================================================================= */\n\n.ct-preset-manage {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    padding: var(--ct-space-1);\n    color: var(--ct-text-muted);\n    background: transparent;\n    border: none;\n    border-radius: var(--ct-radius-sm);\n    cursor: pointer;\n    transition: all var(--ct-transition-fast);\n}\n\n.ct-preset-manage:hover {\n    color: var(--ct-accent);\n    background: var(--ct-accent-muted);\n}\n\n/* =============================================================================\n   ENHANCED PRESET DROPDOWN ROW\n   ============================================================================= */\n\n.ct-preset-row {\n    display: flex;\n    align-items: center;\n    gap: var(--ct-space-2);\n}\n\n.ct-preset-row .ct-select {\n    flex: 1;\n    min-width: 0;\n}\n\n.ct-preset-row__actions {\n    display: flex;\n    gap: var(--ct-space-1);\n    flex-shrink: 0;\n}\n\n/* =============================================================================\n   EXTENSION PANEL - Settings panel in ST Extensions section\n   ============================================================================= */\n\n.ct-panel-version {\n    color: var(--SmartThemeEmColor, #999);\n    font-size: 0.85em;\n    margin-bottom: 0.5em;\n}\n\n.ct-panel-desc {\n    margin: 0 0 1em 0;\n    font-size: 0.9em;\n    color: var(--SmartThemeBodyColor);\n    line-height: 1.4;\n}\n\n.ct-panel-actions {\n    display: flex;\n    gap: 0.5em;\n}\n\n.ct-panel-actions .menu_button {\n    flex: 1;\n}\n\n/* =============================================================================\n   HYBRID RESPONSE FORMATTER - Premium Results Display\n   ============================================================================= */\n\n/* Score color tokens */\n:root {\n    --ct-score-high: #10b981;\n    --ct-score-good: #22c55e;\n    --ct-score-mid: #eab308;\n    --ct-score-low: #f97316;\n    --ct-score-bad: #ef4444;\n}\n\n/* Main formatted container */\n.ct-formatted {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n    font-size: var(--ct-text-sm);\n    line-height: 1.55;\n}\n\n.ct-formatted--empty {\n    padding: var(--ct-space-4);\n    text-align: center;\n    color: var(--ct-text-dim);\n    font-style: italic;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   HERO SCORE - Compact prominent score display\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-hero {\n    position: relative;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: var(--ct-space-3) var(--ct-space-4);\n    background: linear-gradient(\n        135deg,\n        var(--ct-bg-secondary) 0%,\n        var(--ct-bg-tertiary) 100%\n    );\n    border-radius: var(--ct-radius);\n    border: 1px solid var(--ct-border);\n    text-align: center;\n    overflow: hidden;\n}\n\n/* Subtle glow effect behind score */\n.ct-hero::before {\n    content: '';\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    width: 120px;\n    height: 120px;\n    background: var(--score-color, var(--ct-accent));\n    opacity: 0.06;\n    filter: blur(30px);\n    border-radius: 50%;\n    pointer-events: none;\n}\n\n.ct-hero__label {\n    font-size: var(--ct-text-xs);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.1em;\n    color: var(--ct-text-muted);\n    margin-bottom: var(--ct-space-1);\n}\n\n.ct-hero__score {\n    display: flex;\n    align-items: baseline;\n    gap: 2px;\n}\n\n.ct-hero__value {\n    font-size: 2.5rem;\n    font-weight: 800;\n    line-height: 1;\n    color: var(--score-color, var(--ct-accent));\n    text-shadow: 0 2px 12px\n        color-mix(\n            in srgb,\n            var(--score-color, var(--ct-accent)) 25%,\n            transparent\n        );\n    font-variant-numeric: tabular-nums;\n}\n\n.ct-hero__max {\n    font-size: 1rem;\n    font-weight: 500;\n    color: var(--ct-text-dim);\n    margin-left: 2px;\n}\n\n/* Score progress bar */\n.ct-hero__bar {\n    width: 100%;\n    max-width: 160px;\n    height: 4px;\n    margin-top: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-radius: 2px;\n    overflow: hidden;\n}\n\n.ct-hero__fill {\n    height: 100%;\n    border-radius: 2px;\n    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SECTIONS - Content groups with headers\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-section {\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius);\n    overflow: hidden;\n}\n\n.ct-section__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-2);\n    padding: var(--ct-space-2) var(--ct-space-3);\n    background: var(--ct-bg-tertiary);\n    border-bottom: 1px solid var(--ct-border-muted);\n}\n\n.ct-section__title {\n    margin: 0;\n    font-size: var(--ct-text-sm);\n    font-weight: 700;\n    color: var(--ct-text);\n}\n\n.ct-section__score {\n    display: inline-flex;\n    align-items: baseline;\n    padding: 2px 8px;\n    background: color-mix(\n        in srgb,\n        var(--score-color, var(--ct-accent)) 15%,\n        transparent\n    );\n    border-radius: var(--ct-radius-sm);\n    font-weight: 700;\n    font-size: var(--ct-text-sm);\n    color: var(--score-color, var(--ct-accent));\n    font-variant-numeric: tabular-nums;\n}\n\n.ct-section__score-max {\n    font-size: 0.8em;\n    font-weight: 500;\n    opacity: 0.6;\n    margin-left: 1px;\n}\n\n.ct-section__body {\n    padding: var(--ct-space-3);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-section__body--nested {\n    background: var(--ct-bg);\n    border-left: 2px solid var(--ct-accent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   FIELDS - Key/value pairs\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-field {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-field__label {\n    font-size: var(--ct-text-xs);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--ct-text-muted);\n}\n\n.ct-field__value {\n    font-size: var(--ct-text-sm);\n    line-height: 1.6;\n    color: var(--ct-text);\n}\n\n.ct-field--empty {\n    color: var(--ct-text-dim);\n    font-style: italic;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   PARAGRAPHS - Body text\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-para {\n    margin: 0;\n    font-size: var(--ct-text-sm);\n    line-height: 1.6;\n    color: var(--ct-text);\n}\n\n.ct-para + .ct-para {\n    margin-top: var(--ct-space-1);\n}\n\n.ct-text {\n    font-size: var(--ct-text-sm);\n    line-height: 1.6;\n    white-space: pre-wrap;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   LISTS - Bullet and numbered lists\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-list {\n    margin: 0;\n    padding: 0;\n    list-style: none;\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n}\n\n.ct-list li {\n    position: relative;\n    padding-left: var(--ct-space-3);\n    font-size: var(--ct-text-sm);\n    line-height: 1.5;\n}\n\n.ct-list li::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0.55em;\n    width: 5px;\n    height: 5px;\n    background: var(--ct-accent);\n    border-radius: 50%;\n    opacity: 0.7;\n}\n\n/* Numbered variant */\n.ct-list--numbered {\n    counter-reset: list-counter;\n}\n\n.ct-list--numbered li {\n    counter-increment: list-counter;\n    padding-left: var(--ct-space-5);\n}\n\n.ct-list--numbered li::before {\n    content: counter(list-counter);\n    width: auto;\n    height: auto;\n    background: none;\n    border-radius: 0;\n    font-size: var(--ct-text-xs);\n    font-weight: 700;\n    color: var(--ct-accent);\n    opacity: 1;\n    top: 0;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   CARDS - Complex items in arrays\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-cards {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-3);\n}\n\n.ct-card {\n    padding: var(--ct-space-4);\n    background: var(--ct-bg-secondary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius);\n    transition:\n        border-color var(--ct-transition-fast),\n        box-shadow var(--ct-transition-fast);\n}\n\n.ct-card:hover {\n    border-color: var(--ct-border-active);\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n}\n\n.ct-card__header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--ct-space-3);\n    margin-bottom: var(--ct-space-3);\n}\n\n.ct-card__title {\n    font-weight: 700;\n    font-size: var(--ct-text-base);\n    color: var(--ct-text);\n}\n\n.ct-card__body {\n    font-size: var(--ct-text-sm);\n    line-height: 1.7;\n    color: var(--ct-text-secondary);\n}\n\n.ct-card__extra {\n    margin-top: var(--ct-space-3);\n    padding-top: var(--ct-space-3);\n    border-top: 1px solid var(--ct-border-muted);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   SCORES - Inline and badge scores\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-score {\n    display: inline-flex;\n    align-items: baseline;\n    padding: 2px 8px;\n    background: color-mix(\n        in srgb,\n        var(--score-color, var(--ct-accent)) 15%,\n        transparent\n    );\n    border-radius: var(--ct-radius-sm);\n    font-weight: 700;\n    font-size: var(--ct-text-sm);\n    color: var(--score-color, var(--ct-accent));\n    font-variant-numeric: tabular-nums;\n}\n\n.ct-score__max {\n    font-size: 0.75em;\n    font-weight: 500;\n    opacity: 0.6;\n    margin-left: 1px;\n}\n\n/* Inline score (within text) */\n.ct-inline-score {\n    display: inline-flex;\n    align-items: baseline;\n    padding: 1px 6px;\n    margin: 0 2px;\n    background: color-mix(\n        in srgb,\n        var(--score-color, var(--ct-accent)) 12%,\n        transparent\n    );\n    border-radius: 4px;\n    font-weight: 700;\n    font-size: 0.95em;\n    color: var(--score-color, var(--ct-accent));\n    font-variant-numeric: tabular-nums;\n}\n\n.ct-inline-score__label {\n    font-weight: 500;\n    color: var(--ct-text-muted);\n    margin-right: 2px;\n}\n\n.ct-inline-score__max {\n    font-size: 0.75em;\n    font-weight: 500;\n    opacity: 0.5;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   CODE BLOCKS\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-code {\n    position: relative;\n    background: var(--ct-bg-tertiary);\n    border: 1px solid var(--ct-border);\n    border-radius: var(--ct-radius);\n    overflow: hidden;\n}\n\n.ct-code__lang {\n    position: absolute;\n    top: var(--ct-space-2);\n    right: var(--ct-space-2);\n    padding: 2px 8px;\n    background: var(--ct-bg-secondary);\n    border-radius: var(--ct-radius-sm);\n    font-size: var(--ct-text-xs);\n    font-weight: 600;\n    color: var(--ct-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n.ct-code__pre {\n    margin: 0;\n    padding: var(--ct-space-4);\n    overflow-x: auto;\n    font-family: var(--ct-font-mono);\n    font-size: var(--ct-text-xs);\n    line-height: 1.6;\n}\n\n.ct-code__pre code {\n    font-family: inherit;\n}\n\n/* Inline code */\n.ct-inline-code {\n    padding: 2px 6px;\n    background: var(--ct-bg-tertiary);\n    border-radius: 4px;\n    font-family: var(--ct-font-mono);\n    font-size: 0.9em;\n    color: var(--ct-accent);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   BOOLEANS\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-bool--yes {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    color: var(--ct-success);\n    font-weight: 600;\n}\n\n.ct-bool--no {\n    display: inline-flex;\n    align-items: center;\n    gap: var(--ct-space-1);\n    color: var(--ct-danger);\n    font-weight: 600;\n}\n\n.ct-bool--yes i,\n.ct-bool--no i {\n    font-size: 1.1em;\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   UTILITY CLASSES\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-null {\n    color: var(--ct-text-dim);\n}\n\n.ct-empty {\n    color: var(--ct-text-dim);\n    font-style: italic;\n}\n\n.ct-num {\n    font-family: var(--ct-font-mono);\n    font-weight: 600;\n    font-variant-numeric: tabular-nums;\n}\n\n.ct-link {\n    color: var(--ct-accent);\n    text-decoration: none;\n    border-bottom: 1px solid transparent;\n    transition: border-color var(--ct-transition-fast);\n}\n\n.ct-link:hover {\n    border-bottom-color: var(--ct-accent);\n}\n\n/* Strong/emphasis in formatted content */\n.ct-formatted strong {\n    font-weight: 700;\n    color: var(--ct-text);\n}\n\n.ct-formatted em {\n    font-style: italic;\n    color: var(--ct-text-secondary);\n}\n\n/* ─────────────────────────────────────────────────────────────────────────────\n   LEGACY SUPPORT (deprecated, kept for compatibility)\n   ───────────────────────────────────────────────────────────────────────────── */\n\n.ct-structured {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-3);\n}\n\n.ct-sf {\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-sf__label {\n    font-size: var(--ct-text-xs);\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    color: var(--ct-text-muted);\n}\n\n.ct-sf__value {\n    font-size: var(--ct-text-sm);\n    line-height: 1.5;\n}\n\n.ct-sf--empty,\n.ct-sf--null {\n    color: var(--ct-text-dim);\n    font-style: italic;\n}\n\n.ct-sf--nested {\n    padding-left: var(--ct-space-3);\n    border-left: 2px solid var(--ct-border-muted);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-2);\n}\n\n.ct-sf__list {\n    margin: 0;\n    padding-left: var(--ct-space-4);\n    display: flex;\n    flex-direction: column;\n    gap: var(--ct-space-1);\n}\n\n.ct-sf__list li {\n    font-size: var(--ct-text-sm);\n}\n\n.ct-sf__num {\n    font-family: var(--ct-font-mono);\n    font-weight: 500;\n}\n\n.ct-sf__text {\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    font-size: var(--ct-text-sm);\n    line-height: 1.5;\n}\n\n.ct-json {\n    margin: 0;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    overflow-x: auto;\n    font-size: var(--ct-text-xs);\n}\n\n/* Legacy markdown content */\n.ct_markdown_content {\n    font-size: var(--ct-text-sm);\n    line-height: 1.6;\n}\n\n.ct_markdown_content h1,\n.ct_markdown_content h2,\n.ct_markdown_content h3 {\n    margin-top: var(--ct-space-3);\n    margin-bottom: var(--ct-space-2);\n}\n\n.ct_markdown_content p {\n    margin: var(--ct-space-2) 0;\n}\n\n.ct_markdown_content ul,\n.ct_markdown_content ol {\n    margin: var(--ct-space-2) 0;\n    padding-left: var(--ct-space-4);\n}\n\n.ct_markdown_content code {\n    padding: 0.1em 0.3em;\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    font-family: var(--ct-font-mono);\n    font-size: 0.9em;\n}\n\n.ct_markdown_content pre {\n    margin: var(--ct-space-2) 0;\n    padding: var(--ct-space-2);\n    background: var(--ct-bg-tertiary);\n    border-radius: var(--ct-radius-sm);\n    overflow-x: auto;\n}\n\n.ct_markdown_content pre code {\n    padding: 0;\n    background: none;\n}\n",""]);const o=i},314(n){n.exports=function(n){var t=[];return t.toString=function(){return this.map(function(t){var e="",r=void 0!==t[5];return t[4]&&(e+="@supports (".concat(t[4],") {")),t[2]&&(e+="@media ".concat(t[2]," {")),r&&(e+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),e+=n(t),r&&(e+="}"),t[2]&&(e+="}"),t[4]&&(e+="}"),e}).join("")},t.i=function(n,e,r,a,s){"string"==typeof n&&(n=[[null,n,void 0]]);var i={};if(r)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(i[c]=!0)}for(var l=0;l<n.length;l++){var d=[].concat(n[l]);r&&i[d[0]]||(void 0!==s&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=s),e&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=e):d[2]=e),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),t.push(d))}},t}},319(n,t,e){e.d(t,{IF:()=>m,U8:()=>v,Oi:()=>i,hi:()=>a,Nf:()=>g,pW:()=>r,v7:()=>l,$G:()=>o,an:()=>d,iu:()=>u,BA:()=>p,d5:()=>f,F:()=>c,xv:()=>s,UH:()=>M,Lq:()=>O,We:()=>R,NR:()=>j,gg:()=>D,mi:()=>C,cW:()=>A,Ar:()=>w,wG:()=>_,Rm:()=>S,lY:()=>b,$n:()=>F,pM:()=>P,RG:()=>x,oR:()=>y});const r="sillytavern-extensionbase",a="SillyTavern Extension Base",s="2.0.0",i=!0,o=1,c=2,l=1,d=["score","rewrite","analyze"],p={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},u={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},m=[{key:"description",label:"Description",path:"description"},{key:"personality",label:"Personality",path:"personality"},{key:"first_mes",label:"First Message",path:"first_mes"},{key:"scenario",label:"Scenario",path:"scenario"},{key:"mes_example",label:"Example Messages",path:"mes_example"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}],f={SESSIONS:`${r}_sessions`,SESSION_INDEX:`${r}_session_index`,STORAGE_META:`${r}_storage_meta`},v={SEARCH:150,SAVE:1e3,VALIDATE:300},g=50;var h=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};const b={confirm(n,t){return h(this,void 0,void 0,function*(){return!0===(yield SillyTavern.getContext().Popup.show.confirm(n,t))})},input(n,t,e){return h(this,void 0,void 0,function*(){return SillyTavern.getContext().Popup.show.input(n,t,e)})},alert(n,t){return h(this,void 0,void 0,function*(){yield SillyTavern.getContext().Popup.show.text(n,t)})}},y={success(n,t){toastr.success(n,t)},error(n,t){toastr.error(n,t)},warning(n,t){toastr.warning(n,t)},info(n,t){toastr.info(n,t)}};const _={show(){const n=SillyTavern.getContext();"function"==typeof n.showLoader&&n.showLoader()},hide(){const n=SillyTavern.getContext();"function"==typeof n.hideLoader&&n.hideLoader()},wrap(n){return h(this,void 0,void 0,function*(){_.show();try{return yield n()}finally{_.hide()}})}};function x(n,t){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.setItem(n,t),!0}catch(t){return console.error(`[storeLargeData] Failed to store ${n}:`,t),!1}})}function w(n){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.getItem(n)}catch(t){return console.error(`[loadLargeData] Failed to load ${n}:`,t),null}})}const $=[];let k=!1;const S={debug(n,t){T("debug",n,t),k&&(void 0!==t?console.debug(`[${r}]`,n,t):console.debug(`[${r}]`,n))},info(n,t){T("info",n,t),void 0!==t?console.log(`[${r}]`,n,t):console.log(`[${r}]`,n)},warn(n,t){T("warn",n,t),void 0!==t?console.warn(`[${r}]`,n,t):console.warn(`[${r}]`,n)},error(n,t){T("error",n,t),void 0!==t?console.error(`[${r}]`,n,t):console.error(`[${r}]`,n)}};function P(n){k=n,S.info("Debug mode "+(n?"enabled":"disabled"))}function T(n,t,e){$.unshift({timestamp:new Date,level:n,message:t,data:e}),$.length>100&&$.pop()}function C(){const n=SillyTavern.getContext().ConnectionManagerRequestService;return!(!n||"function"!=typeof n.sendRequest)}function R(){const n=SillyTavern.getContext().ConnectionManagerRequestService;if(!n||"function"!=typeof n.getSupportedProfiles)return[];try{return(n.getSupportedProfiles()||[]).map(t=>{const e=function(n,t){try{const e=(t.getSupportedProfiles()||[]).find(t=>t.id===n);return e?{valid:!0,error:null}:{valid:!1,error:"Profile not found"}}catch(n){return{valid:!1,error:"Failed to validate profile"}}}(t.id,n);return{id:t.id,name:t.name,model:t.model,api:t.api,mode:t.mode,presetName:t.presetName,isSupported:e.valid,validationError:e.error}})}catch(n){return S.error("Failed to get profiles",n),[]}}function E(n){return R().find(t=>t.id===n)||null}function O(n){const t=SillyTavern.getContext();return n?function(n){const t=E(n);if(!t)return{mode:"profile",displayName:"Unknown Profile",source:"unknown",model:"unknown",modelDisplay:"Unknown",apiType:"cc",contextSize:8192,maxOutput:4096,isReady:!1,statusText:"Profile Not Found",error:`Profile ${n} not found`};return{mode:"profile",displayName:t.name,source:t.api,model:t.model,modelDisplay:z(t.model),apiType:t.mode,contextSize:8192,maxOutput:4096,isReady:t.isSupported,statusText:t.isSupported?`${t.name} Ready`:"Not Supported",error:t.validationError}}(n):function(n){var t,e,r,a,s;const i=null!==(t=n.mainApi)&&void 0!==t?t:"unknown",o=n.chatCompletionSettings,c=n.textCompletionSettings,l="textgenerationwebui"!==i&&"kobold"!==i,d=l?"cc":"tc";let p="unknown";l&&"function"==typeof n.getChatCompletionModel?p=n.getChatCompletionModel()||"unknown":l||(p=n.onlineStatus||"unknown");let u=i;l&&(null==o?void 0:o.chat_completion_source)&&(u=o.chat_completion_source);const m=null!==(r=null!==(e=null==o?void 0:o.openai_max_context)&&void 0!==e?e:n.maxContext)&&void 0!==r?r:8192,f=l?null!==(a=null==o?void 0:o.openai_max_tokens)&&void 0!==a?a:4096:null!==(s=null==c?void 0:c.max_length)&&void 0!==s?s:2048,{isReady:v,error:g}=function(n){var t;const e=n.chatCompletionSettings;if(null==e?void 0:e.bypass_status_check)return{isReady:!0,error:null};const r=(null!==(t=n.onlineStatus)&&void 0!==t?t:"").toLowerCase();if(!r)return{isReady:!1,error:"No API connection"};if(["error","fail","invalid","unauthorized","missing"].some(n=>r.includes(n)))return{isReady:!1,error:`API error: ${r}`};if(["valid","connected","ok","ready","key","saved"].some(n=>r.includes(n)))return{isReady:!0,error:null};if("function"!=typeof n.generateRaw)return{isReady:!1,error:"Generation not available (ST version?)"};return{isReady:!0,error:null}}(n);return{mode:"current",displayName:"Current Settings",source:u,model:p,modelDisplay:z(p),apiType:d,contextSize:m,maxOutput:f,isReady:v,statusText:v?`${z(p)} Ready`:"Not Ready",error:g}}(t)}function A(n){return O(n).isReady}function z(n){if(!n||"unknown"===n)return"Unknown";const t=n.replace(/^gpt-/,"GPT-").replace(/^claude-/,"Claude-").replace(/^gemini-/,"Gemini-").replace(/-\d{4}-\d{2}-\d{2}$/,"").replace(/-preview$/,"");return t.length>30?t.slice(0,27)+"...":t}var N=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};const I=new Map;new Map;function W(n){let t=0;for(let e=0;e<n.length;e++){t=(t<<5)-t+n.charCodeAt(e),t&=t}const e=n.slice(0,16),r=n.slice(-16);return`${t}_${n.length}_${e}_${r}`}function j(n){return N(this,void 0,void 0,function*(){const t=n.trim();if(!t)return 0;const e=W(t),r=I.get(e);if(void 0!==r)return r;const a=SillyTavern.getContext();if("function"!=typeof a.getTokenCountAsync)return null;try{const n=yield a.getTokenCountAsync(t);return L(e,n),n}catch(n){return S.error("Token count failed",n),null}})}function D(n){return N(this,void 0,void 0,function*(){const t=n.map(n=>n.text),e=yield function(n){return N(this,void 0,void 0,function*(){const t=new Map,e=[];for(const r of n){const n=r.trim();if(!n){t.set(r,0);continue}const a=W(n),s=I.get(a);void 0!==s?t.set(r,s):e.push({text:n,key:a,original:r})}if(e.length>0){const n=SillyTavern.getContext();if("function"!=typeof n.getTokenCountAsync){for(const{original:n}of e)t.set(n,null);return t}const r=e.map(t=>N(this,[t],void 0,function*({text:t,key:e,original:r}){try{const a=yield n.getTokenCountAsync(t);return L(e,a),{original:r,tokens:a}}catch(n){return{original:r,tokens:null}}})),a=yield Promise.all(r);for(const{original:n,tokens:e}of a)t.set(n,e)}return t})}(t);return n.map(n=>{var t;return{key:n.key,tokens:null!==(t=e.get(n.text))&&void 0!==t?t:null}})})}function L(n,t){if(I.size>=500){const n=I.keys().next().value;n&&I.delete(n)}I.set(n,t)}function M(n,t=["user","persona","original","input"]){if(!n)return n;let e=n;for(const n of t){const t=new RegExp(`\\{\\{(${n})\\}\\}`,"gi");e=e.replace(t,"{{​$1​}}")}return e}function F(n,t){return n&&t?n.replace(/\{\{char\}\}/gi,t):n}},374(n,t,e){e.d(t,{Ki:()=>S,i6:()=>h,jf:()=>k,nr:()=>P});var r=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};const a=8,s=100,i=10,o=100,c=500,l=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],d=[0,1],p=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],u=["minLength","maxLength"],m=["maxItems","uniqueItems","contains","minContains","maxContains"],f=["minProperties","maxProperties","propertyNames","patternProperties"],v=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],g=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function h(n){var t;if("string"==typeof n&&!n.trim())return{valid:!0,schema:void 0};let e;if("string"==typeof n)try{e=JSON.parse(n)}catch(n){const t=n instanceof Error?n.message:"Invalid JSON",e=t.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${e?` (character ${e[1]})`:""}: ${t}`}}else e=n;if("object"!=typeof e||null===e||Array.isArray(e))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(e)?"array":typeof e)};const r=e;if("string"!=typeof r.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!r.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(r.name))return{valid:!1,error:`'name' must be a valid identifier (got '${r.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof r.value||null===r.value||Array.isArray(r.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const a=r.value;if("string"!=typeof a.type&&!a.anyOf&&!a.allOf&&!a.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==r.strict&&"boolean"!=typeof r.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const i={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(a.$defs&&"object"==typeof a.$defs?(i.defs=a.$defs,i.stats.defCount=Object.keys(i.defs).length):a.definitions&&"object"==typeof a.definitions&&(i.defs=a.definitions,i.stats.defCount=Object.keys(i.defs).length),i.stats.defCount>s&&i.errors.push(`Too many definitions: ${i.stats.defCount} (limit: ${s})`),b(a,"value",i),i.stats.optionalFieldCount>0){const n=i.stats.optionalFieldCount,t=i.stats.totalAnyOfVariants+2*n;n>10&&i.warnings.push(`${n} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),t>50&&i.warnings.push(`High anyOf count (~${t} including implicit nullables). May cause slow schema compilation or errors.`)}if(i.errors.length>0)return{valid:!1,error:i.errors.join("\n"),warnings:i.warnings.length>0?i.warnings:void 0};const o={name:r.name,strict:null===(t=r.strict)||void 0===t||t,value:a};return i.info.push(`Schema stats: ${i.stats.propertyCount} properties, ${i.stats.defCount} definitions, ${i.stats.anyOfCount} anyOf blocks, ${i.stats.optionalFieldCount} optional fields, max depth ${i.stats.maxDepth}`),{valid:!0,schema:o,warnings:i.warnings.length>0?i.warnings:void 0,info:i.info.length>0?i.info:void 0}}function b(n,t,e){if(e.currentDepth++,e.stats.maxDepth=Math.max(e.stats.maxDepth,e.currentDepth),e.currentDepth>i)return e.errors.push(`${t}: Exceeds maximum nesting depth of ${i}`),void e.currentDepth--;for(const r of v)void 0!==n[r]&&e.errors.push(`${t}: '${r}' is not supported`);for(const r of p)void 0!==n[r]&&e.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of u)void 0!==n[r]&&e.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of m)void 0!==n[r]&&e.warnings.push(`${t}: '${r}' will be ignored (not supported)`);for(const r of f)void 0!==n[r]&&e.warnings.push(`${t}: '${r}' will be ignored (not supported)`);if(n.$ref&&"string"==typeof n.$ref)return function(n,t,e){if(n.startsWith("http://")||n.startsWith("https://"))return void e.errors.push(`${t}: External $ref not supported ('${n}')`);if(e.seenRefs.has(n))return void e.info.push(`${t}: Circular reference to '${n}'`);e.seenRefs.add(n);const r=n.replace(/^#\/(\$defs|definitions)\//,"");e.defs[r]||e.errors.push(`${t}: Reference '${n}' not found in definitions`)}(n.$ref,t,e),void e.currentDepth--;const r=Array.isArray(n.type)?n.type:[n.type];for(const a of r)switch(a){case"object":y(n,t,e);break;case"array":_(n,t,e);break;case"string":x(n,t,e);break;case"number":case"integer":case"boolean":case"null":break;default:!a||n.anyOf||n.allOf||e.warnings.push(`${t}: Unknown type '${a}'`)}n.anyOf&&Array.isArray(n.anyOf)&&function(n,t,e){e.stats.anyOfCount++,e.stats.totalAnyOfVariants+=n.length,n.length>a&&e.errors.push(`${t}: anyOf has ${n.length} variants (max: ${a})`);if(0===n.length)return void e.errors.push(`${t}: anyOf cannot be empty`);n.forEach((n,r)=>{n&&"object"==typeof n&&b(n,`${t}.anyOf[${r}]`,e)})}(n.anyOf,t,e),n.allOf&&Array.isArray(n.allOf)&&function(n,t,e){if(0===n.length)return void e.errors.push(`${t}: allOf cannot be empty`);n.forEach((n,r)=>{if(n&&"object"==typeof n){const a=n;a.$ref&&e.errors.push(`${t}.allOf[${r}]: allOf with $ref not supported`),b(a,`${t}.allOf[${r}]`,e)}})}(n.allOf,t,e),n.enum&&Array.isArray(n.enum)&&function(n,t,e){if(e.stats.enumCount++,0===n.length)return void e.errors.push(`${t}: enum cannot be empty`);n.length>c&&e.warnings.push(`${t}: enum has ${n.length} values (may be slow)`);for(let r=0;r<n.length;r++){const a=n[r],s=typeof a;if("string"!==s&&"number"!==s&&"boolean"!==s&&null!==a){e.errors.push(`${t}.enum[${r}]: Complex type not allowed in enum (got ${s}). Only string, number, boolean, null permitted.`);break}}const r=new Set;for(const a of n){const n=JSON.stringify(a);if(r.has(n)){e.warnings.push(`${t}: Duplicate value in enum: ${n}`);break}r.add(n)}}(n.enum,t,e),void 0!==n.const&&function(n,t,e){const r=typeof n;"string"!==r&&"number"!==r&&"boolean"!==r&&null!==n&&e.errors.push(`${t}: const must be string, number, boolean, or null (got ${r})`)}(n.const,t,e),e.currentDepth--}function y(n,t,e){if(!1!==n.additionalProperties&&e.warnings.push(`${t}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),n.properties&&"object"==typeof n.properties){const r=n.properties,a=Object.keys(r).length;e.stats.propertyCount+=a,a>o&&e.warnings.push(`${t}: ${a} properties (may be slow, consider splitting)`);const s=n.required||[];for(const[n,a]of Object.entries(r))s.includes(n)||e.stats.optionalFieldCount++,a&&"object"==typeof a&&b(a,`${t}.${n}`,e)}}function _(n,t,e){if(void 0!==n.minItems){d.includes(n.minItems)||e.warnings.push(`${t}: 'minItems: ${n.minItems}' not supported (only 0 or 1 allowed)`)}n.items&&("object"!=typeof n.items||Array.isArray(n.items)?Array.isArray(n.items)&&n.items.forEach((n,r)=>{n&&"object"==typeof n&&b(n,`${t}.items[${r}]`,e)}):b(n.items,`${t}.items`,e)),n.prefixItems&&Array.isArray(n.prefixItems)&&n.prefixItems.forEach((n,r)=>{n&&"object"==typeof n&&b(n,`${t}.prefixItems[${r}]`,e)})}function x(n,t,e){if(n.format&&"string"==typeof n.format){const r=l;r.includes(n.format)||e.warnings.push(`${t}: format '${n.format}' may not be supported. Supported: ${r.join(", ")}`)}n.pattern&&"string"==typeof n.pattern&&function(n,t,e){for(const{pattern:r,name:a}of g)r.test(n)&&e.errors.push(`${t}: Regex pattern uses unsupported feature: ${a}`);try{new RegExp(n)}catch(n){const r=n instanceof Error?n.message:"Invalid regex";e.errors.push(`${t}: Invalid regex pattern: ${r}`)}const r=/\{(\d+),(\d+)\}/g;let a;for(;null!==(a=r.exec(n));){const n=parseInt(a[1],10),r=parseInt(a[2],10);r-n>100&&e.warnings.push(`${t}: Large quantifier range {${n},${r}} may cause issues`)}}(n.pattern,t,e)}function w(n){const t=structuredClone(n);return void 0===t.strict&&(t.strict=!0),$(t.value),t}function $(n){if("object"===n.type&&(n.additionalProperties=!1,n.properties&&"object"==typeof n.properties))for(const t of Object.values(n.properties))t&&"object"==typeof t&&$(t);"array"===n.type&&n.items&&"object"==typeof n.items&&(Array.isArray(n.items)?n.items.forEach(n=>{n&&"object"==typeof n&&$(n)}):$(n.items)),n.anyOf&&Array.isArray(n.anyOf)&&n.anyOf.forEach(n=>{n&&"object"==typeof n&&$(n)}),n.allOf&&Array.isArray(n.allOf)&&n.allOf.forEach(n=>{n&&"object"==typeof n&&$(n)});const t=[];for(const e of p)void 0!==n[e]&&(t.push(`${e}: ${n[e]}`),delete n[e]);for(const e of u)void 0!==n[e]&&(t.push(`${e}: ${n[e]}`),delete n[e]);for(const e of m)void 0!==n[e]&&(t.push(`${e}: ${n[e]}`),delete n[e]);if(void 0!==n.minItems&&null!==n.minItems){const e=n.minItems;0!==e&&1!==e&&(t.push(`minItems: ${e}`),n.minItems=e>0?1:0)}if(t.length>0){const e=`[Constraints: ${t.join(", ")}]`;n.description?n.description=`${n.description} ${e}`:n.description=e}}function k(n){return n?JSON.stringify(n,null,2):""}function S(n,t){let e;try{e=JSON.parse(n)}catch(t){const r=n.match(/```(?:json)?\s*([\s\S]*?)```/);if(!r)return null;try{e=JSON.parse(r[1].trim())}catch(n){return null}}const r=[];if(t&&t.value.required&&Array.isArray(t.value.required)){const n=t.value.required.filter(n=>!(n in e));n.length>0&&r.push(`Missing required fields: ${n.join(", ")}`)}return{data:e,warnings:r}}function P(n){return r(this,void 0,void 0,function*(){var t;const{generateSimple:r}=yield Promise.resolve().then(e.bind(e,179));if(!n.trim())return{success:!1,error:"Please describe what you want in the schema"};try{const e=yield r(`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${n}`,"You are a JSON Schema expert. Output only valid JSON, nothing else.");if(!e)return{success:!1,error:"Generation failed - no response received"};let a=e.trim();a.startsWith("```")&&(a=a.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const s=h(a);if(!s.valid)return{success:!1,error:`Generated schema is invalid: ${s.error}`,schema:a};if(null===(t=s.warnings)||void 0===t?void 0:t.length){const n=w(s.schema);return{success:!0,schema:JSON.stringify(n,null,2)}}return{success:!0,schema:JSON.stringify(s.schema,null,2)}}catch(n){return{success:!1,error:`Generation failed: ${n.message}`}}})}},540(n){n.exports=function(n){var t=document.createElement("style");return n.setAttributes(t,n.attributes),n.insert(t,n.options),t}},601(n){n.exports=function(n){return n[1]}},659(n){var t={};n.exports=function(n,e){var r=function(n){if(void 0===t[n]){var e=document.querySelector(n);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(n){e=null}t[n]=e}return t[n]}(n);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(e)}},825(n){n.exports=function(n){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=n.insertStyleElement(n);return{update:function(e){!function(n,t,e){var r="";e.supports&&(r+="@supports (".concat(e.supports,") {")),e.media&&(r+="@media ".concat(e.media," {"));var a=void 0!==e.layer;a&&(r+="@layer".concat(e.layer.length>0?" ".concat(e.layer):""," {")),r+=e.css,a&&(r+="}"),e.media&&(r+="}"),e.supports&&(r+="}");var s=e.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,n,t.options)}(t,n,e)},remove:function(){!function(n){if(null===n.parentNode)return!1;n.parentNode.removeChild(n)}(t)}}}}},t={};function e(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={id:r,exports:{}};return n[r](s,s.exports,e),s.exports}e.n=n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},e.d=(n,t)=>{for(var r in t)e.o(t,r)&&!e.o(n,r)&&Object.defineProperty(n,r,{enumerable:!0,get:t[r]})},e.o=(n,t)=>Object.prototype.hasOwnProperty.call(n,t),e.r=n=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.nc=void 0;var r=e(72),a=e.n(r),s=e(825),i=e.n(s),o=e(659),c=e.n(o),l=e(56),d=e.n(l),p=e(540),u=e.n(p),m=e(113),f=e.n(m),v=e(208),g={};g.styleTagTransform=f(),g.setAttributes=d(),g.insert=c().bind(null,"head"),g.domAPI=i(),g.insertStyleElement=u();a()(v.A,g);v.A&&v.A.locals&&v.A.locals;var h=e(319);const b={promptPresetId:null,customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},y=[{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided.\n\nFor each field:\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Suggestions** - Concrete changes\n\nThen provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback only."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address weaknesses while preserving strengths.\n\nGuidelines:\n- Maintain core personality and unique traits\n- Improve weak areas from feedback\n- Keep similar length unless noted\n- Preserve distinctive voice/style\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\n**ACCEPT** (ready), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"}],_=[{id:"builtin_schema_score",name:"Score Schema",stages:["score"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score Schema",stages:["score"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Analyze Schema",stages:["analyze"],isBuiltin:!0,version:h.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issues:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulScore","soulAssessment","verdict","issues","recommendations"]}}}],x={version:h.$G,baseSystemPrompt:"You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",userSystemPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},baseRefinementPrompt:"You are refining a character card based on analysis feedback. Address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",userRefinementPrompt:"",stageDefaults:{score:Object.assign(Object.assign({},b),{promptPresetId:"builtin_score_default"}),rewrite:Object.assign(Object.assign({},b),{promptPresetId:"builtin_rewrite_default"}),analyze:Object.assign(Object.assign({},b),{promptPresetId:"builtin_analyze_default"})},promptPresets:[...y],schemaPresets:[..._],generationMode:"current",profileId:null,maxTokensOverride:null,debugMode:!1};h.F,Date.now();function w(){var n;const t=SillyTavern.getContext(),{lodash:e}=SillyTavern.libs,r=t.extensionSettings;if(!r[h.pW])return r[h.pW]=e.cloneDeep(x),$(),r[h.pW];const a=r[h.pW],s=null!==(n=a.version)&&void 0!==n?n:0;if(s<h.$G){!function(n,t){for(let e=t+1;e<=h.$G;e++){const t=k[e];t&&t(n)}}(a,s);const n=function(n){const{lodash:t}=SillyTavern.libs,e=n.promptPresets?[...n.promptPresets]:[],r=n.schemaPresets?[...n.schemaPresets]:[],a=t.merge(structuredClone(x),n);return a.promptPresets=e.length?e:[...x.promptPresets],a.schemaPresets=r.length?r:[...x.schemaPresets],a}(a);return n.version=h.$G,S(n),r[h.pW]=n,$(),n}const i=a;i.promptPresets||(i.promptPresets=[]),i.schemaPresets||(i.schemaPresets=[]);return S(i)&&$(),i}function $(){SillyTavern.getContext().saveSettingsDebounced()}const k={};function S(n){const{lodash:t}=SillyTavern.libs;let e=!1;for(const r of y){const a=n.promptPresets.find(n=>n.id===r.id);a?a.version<r.version&&(Object.assign(a,t.cloneDeep(r)),e=!0):(n.promptPresets.push(t.cloneDeep(r)),e=!0)}for(const r of _){const a=n.schemaPresets.find(n=>n.id===r.id);a?a.version<r.version&&(Object.assign(a,t.cloneDeep(r)),e=!0):(n.schemaPresets.push(t.cloneDeep(r)),e=!0)}return e}function P(n){const{lodash:t}=SillyTavern.libs,e=w();return t.cloneDeep(e.stageDefaults[n])}const T=new class{constructor(){this.listeners=new Set,this.getPromptPresets=n=>{const t=w();return this.applyFilter(t.promptPresets,n)},this.getSchemaPresets=n=>{const t=w();return this.applyFilter(t.schemaPresets,n)},this.getPromptPreset=n=>{var t;return null!==(t=w().promptPresets.find(t=>t.id===n))&&void 0!==t?t:null},this.getSchemaPreset=n=>{var t;return null!==(t=w().schemaPresets.find(t=>t.id===n))&&void 0!==t?t:null},this.getPresetsForStage=(n,t)=>"prompt"===n?this.getPromptPresets({stage:t}):this.getSchemaPresets({stage:t}),this.exists=(n,t)=>"prompt"===n?null!==this.getPromptPreset(t):null!==this.getSchemaPreset(t),this.isBuiltin=(n,t)=>{var e;const r="prompt"===n?this.getPromptPreset(t):this.getSchemaPreset(t);return null!==(e=null==r?void 0:r.isBuiltin)&&void 0!==e&&e},this.registerPromptPreset=n=>{const t=w(),e=Object.assign(Object.assign({},n),{id:crypto.randomUUID(),isBuiltin:!1,version:h.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.promptPresets.push(e),$(),this.emit({type:"add",presetType:"prompt",preset:e}),e},this.registerSchemaPreset=n=>{const t=w(),e=Object.assign(Object.assign({},n),{id:crypto.randomUUID(),isBuiltin:!1,version:h.v7,createdAt:Date.now(),updatedAt:Date.now()});return t.schemaPresets.push(e),$(),this.emit({type:"add",presetType:"schema",preset:e}),e},this.updatePromptPreset=(n,t)=>{const e=w().promptPresets.find(t=>t.id===n);if(!e||e.isBuiltin)return!1;const r=Object.assign({},e);return Object.assign(e,t,{updatedAt:Date.now()}),$(),this.emit({type:"update",presetType:"prompt",preset:e,previousValue:r}),!0},this.updateSchemaPreset=(n,t)=>{const e=w().schemaPresets.find(t=>t.id===n);if(!e||e.isBuiltin)return!1;const r=Object.assign({},e);return Object.assign(e,t,{updatedAt:Date.now()}),$(),this.emit({type:"update",presetType:"schema",preset:e,previousValue:r}),!0},this.deletePromptPreset=n=>{const t=w(),e=t.promptPresets.findIndex(t=>t.id===n&&!t.isBuiltin);if(-1===e)return!1;const[r]=t.promptPresets.splice(e,1);return $(),this.emit({type:"delete",presetType:"prompt",preset:r}),!0},this.deleteSchemaPreset=n=>{const t=w(),e=t.schemaPresets.findIndex(t=>t.id===n&&!t.isBuiltin);if(-1===e)return!1;const[r]=t.schemaPresets.splice(e,1);return $(),this.emit({type:"delete",presetType:"schema",preset:r}),!0},this.duplicatePromptPreset=(n,t)=>{const e=this.getPromptPreset(n);if(!e)return null;const r=t||`${e.name} (Copy)`;return this.registerPromptPreset({name:r,stages:[...e.stages],prompt:e.prompt})},this.duplicateSchemaPreset=(n,t)=>{const e=this.getSchemaPreset(n);if(!e)return null;const{lodash:r}=SillyTavern.libs,a=t||`${e.name} (Copy)`;return this.registerSchemaPreset({name:a,stages:[...e.stages],schema:r.cloneDeep(e.schema)})},this.subscribe=n=>(this.listeners.add(n),()=>this.listeners.delete(n)),this.isNameUnique=(n,t,e)=>!("prompt"===n?this.getPromptPresets():this.getSchemaPresets()).some(n=>n.name.toLowerCase()===t.toLowerCase()&&n.id!==e),this.generateUniqueName=(n,t)=>{let e=t,r=1;for(;!this.isNameUnique(n,e);)e=`${t} (${r})`,r++;return e},this.getDisplayName=(n,t)=>{if(!t)return"Custom";const e="prompt"===n?this.getPromptPreset(t):this.getSchemaPreset(t);return e?e.isBuiltin?`${e.name} (builtin)`:e.name:"Unknown"}}applyFilter(n,t){return t?n.filter(n=>{if(t.stage){if(!(0===n.stages.length||n.stages.includes(t.stage)))return!1}return!(t.builtinOnly&&!n.isBuiltin)&&(!t.userOnly||!n.isBuiltin)}):n}emit(n){for(const t of this.listeners)try{t(n)}catch(n){console.error("[PresetRegistry] Listener error:",n)}}},{getPromptPresets:C,getSchemaPresets:R,getPromptPreset:E,getSchemaPreset:O,getPresetsForStage:A,registerPromptPreset:z,registerSchemaPreset:N,updatePromptPreset:I,updateSchemaPreset:W,deletePromptPreset:j,deleteSchemaPreset:D,duplicatePromptPreset:L,duplicateSchemaPreset:M,isNameUnique:F,generateUniqueName:B,getDisplayName:G,subscribe:U}=T;var q=e(374);function H(n){return C({stage:n})}function J(n){return E(n)}function Y(n){return R({stage:n})}function V(n){return O(n)}function K(n){var t;const e=[],r=[];if((null===(t=n.name)||void 0===t?void 0:t.trim())?n.name.length>100&&e.push("Name must be 100 characters or less"):e.push("Name is required"),n.schema){const t="string"==typeof n.schema?n.schema:JSON.stringify(n.schema),a=(0,q.i6)(t);a.valid||e.push(a.error||"Invalid schema"),a.warnings&&r.push(...a.warnings)}else e.push("Schema is required");return{valid:0===e.length,errors:e,warnings:r}}let Q=null,X=null,Z=null;function nn(){return Q}function tn(){return X}function en(n){Z=n}var rn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function an(){return rn(this,void 0,void 0,function*(){if(Z)return Z;const n=yield(0,h.Ar)(h.d5.STORAGE_META);if(!n){const n={version:h.F,lastMigration:Date.now()};return en(n),yield(0,h.RG)(h.d5.STORAGE_META,n),n}return n.version!==h.F&&(yield function(n){return rn(this,void 0,void 0,function*(){var t;const e=null!==(t=n.version)&&void 0!==t?t:0;if(e<2){const n=yield(0,h.Ar)(h.d5.SESSIONS);if(n){let t=!1;for(const e of Object.values(n))if(!e.stageFields&&e.selectedFields){const n=e.selectedFields;e.stageFields={base:n,linked:!0,overrides:{}},delete e.selectedFields,t=!0}t&&(yield(0,h.RG)(h.d5.SESSIONS,n))}}n.version=h.F,n.lastMigration=Date.now(),yield(0,h.RG)(h.d5.STORAGE_META,n)})}(n)),en(n),n})}function sn(){return rn(this,void 0,void 0,function*(){const n=nn();if(n)return n;yield an();const t=yield(0,h.Ar)(h.d5.SESSIONS),e=new Map(Object.entries(null!=t?t:{}));return function(n){Q=n}(e),e})}function on(){return rn(this,void 0,void 0,function*(){var n;const t=tn();if(t)return t;yield an();const e=null!==(n=yield(0,h.Ar)(h.d5.SESSION_INDEX))&&void 0!==n?n:{};return X=e,e})}function cn(){return rn(this,void 0,void 0,function*(){const n=nn();n&&(yield(0,h.RG)(h.d5.SESSIONS,Object.fromEntries(n)))})}function ln(){return rn(this,void 0,void 0,function*(){const n=tn();n&&(yield(0,h.RG)(h.d5.SESSION_INDEX,n))})}function dn(n){return rn(this,void 0,void 0,function*(){var t;return null!==(t=(yield sn()).get(n))&&void 0!==t?t:null})}function pn(n){return rn(this,void 0,void 0,function*(){const{characterId:t,characterName:e,stageFields:r,originalData:a,configs:s}=n,i=yield sn(),o=yield on(),c=SillyTavern.libs.lodash,l=function(n,t,e){return{id:n,characterId:t,characterName:e,createdAt:Date.now(),updatedAt:Date.now(),stageFields:{base:{},linked:!0,overrides:{}},originalData:{},configs:{score:Object.assign({},b),rewrite:Object.assign({},b),analyze:Object.assign({},b)},history:[],iterationCount:0,status:"active",version:h.F}}(crypto.randomUUID(),t,e);if(l.stageFields=c.cloneDeep(r),l.originalData=c.cloneDeep(a),l.configs=c.cloneDeep(s),i.set(l.id,l),o[t]||(o[t]=[]),o[t].unshift(l.id),o[t].length>h.Nf){const n=o[t].splice(h.Nf);for(const t of n)i.delete(t)}return yield cn(),yield ln(),l})}function un(n){return rn(this,void 0,void 0,function*(){const t=yield sn();n.updatedAt=Date.now(),t.set(n.id,n),yield cn()})}var mn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};var fn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function vn(n){return fn(this,void 0,void 0,function*(){const t=SillyTavern.getContext(),e=t.characters||[],r=e.findIndex(t=>t.avatar===n.avatar);if(-1===r)return h.Rm.debug("Character not found in ST array, using provided data"),n;const a=e[r];return a.shallow&&"function"==typeof t.unshallowCharacter?(h.Rm.debug(`Unshallowing character: ${n.name}`),yield t.unshallowCharacter(r),e[r]):a})}function gn(n,t){const e=n;let r=hn(e,t);if(void 0===r&&t.startsWith("data.")){const n=t.replace(/^data\./,"").replace(/^extensions\./,"");r=hn(e,n),void 0===r&&n in e&&(r=e[n])}if(void 0===r&&t.startsWith("data.extensions.")){r=hn(e,`extensions.${t.replace("data.extensions.","")}`)}return r}function hn(n,t){return t.split(".").reduce((n,t)=>{if(n&&"object"==typeof n)return n[t]},n)}function bn(n,t){if(null==n)return!1;switch(t){case"array":return Array.isArray(n)&&n.length>0;case"object":return"object"==typeof n&&("prompt"in n?"string"==typeof n.prompt&&n.prompt.trim().length>0:"entries"in n?Array.isArray(n.entries)&&n.entries.length>0:Object.keys(n).length>0);default:return"string"==typeof n&&n.trim().length>0}}function yn(n,t){switch(t.type){case"array":return Array.isArray(n)?n.map((n,t)=>`${t+1}. ${String(n).trim()}`).join("\n"):"";case"object":return function(n,t){var e,r,a,s;if(!n||"object"!=typeof n)return"";if("depth_prompt"===t){const t=n;return(null===(e=t.prompt)||void 0===e?void 0:e.trim())?`[Depth: ${null!==(r=t.depth)&&void 0!==r?r:0}, Role: ${null!==(a=t.role)&&void 0!==a?a:"system"}]\n${t.prompt.trim()}`:""}if("character_book"===t){const t=n;if(!(null===(s=t.entries)||void 0===s?void 0:s.length))return"";const e=[];t.name&&e.push(`Lorebook: ${t.name}`),e.push(`Entries: ${t.entries.length}`);for(const n of t.entries.slice(0,10)){const t=n.enabled?"✓":"✗",r=n.comment||n.keys.slice(0,3).join(", ");e.push(`  ${t} ${r}`)}return t.entries.length>10&&e.push(`  ... and ${t.entries.length-10} more`),e.join("\n")}try{return JSON.stringify(n,null,2)}catch(n){return"[Complex Object]"}}(n,t.key);default:return"string"==typeof n?n.trim():String(n)}}function _n(n){if(!n)return[];const t=[];for(const e of h.IF){const r=gn(n,e.path);if(!bn(r,e.type))continue;const a=yn(r,e);a&&t.push({key:e.key,label:e.label,value:a,rawValue:r,charCount:a.length,type:e.type})}return t}function xn(n,t){const e=_n(n),r=[];for(const n of e){const e=t[n.key];if(e)if("alternate_greetings"===n.key&&Array.isArray(e)){const t=n.rawValue,a=e.filter(n=>n>=0&&n<t.length).map(n=>`**Greeting ${n+1}:**\n${t[n].trim()}`).join("\n\n");a&&r.push(`### ${n.label}\n\n${a}`)}else r.push(`### ${n.label}\n\n${n.value}`)}const a=r.length>0?r.join("\n\n"):"(No fields selected)";let s=`# CHARACTER: ${n.name}\n\n${a}`;return s=(0,h.$n)(s,n.name),s=(0,h.UH)(s),s}var wn=e(179),$n=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function kn(n,t){return $n(this,arguments,void 0,function*(n,t,e={}){var r,a,s,i;const{signal:o,onProgress:c}=e,l=Date.now(),d=function(n,t){var e;const r=[];"analyze"===n.stage?(r.push("## ORIGINAL CHARACTER\n\n"),r.push(xn(n.character,n.selection)),n.previousResults.score&&r.push("\n\n---\n\n## SCORE RESULTS\n\n"+n.previousResults.score.output),n.previousResults.rewrite&&r.push("\n\n---\n\n## REWRITTEN VERSION\n\n"+n.previousResults.rewrite.output)):(r.push(xn(n.character,n.selection)),"rewrite"===n.stage&&(n.previousResults.score&&r.push("\n\n---\n\n## SCORE RESULTS\n\n"+n.previousResults.score.output),n.isRefinement&&n.previousResults.analyze&&r.push("\n\n---\n\n## ANALYSIS FEEDBACK\n\n"+n.previousResults.analyze.output))),(null===(e=n.guidance)||void 0===e?void 0:e.trim())&&r.push("\n\n---\n\n## USER GUIDANCE\n\n"+n.guidance.trim()),n.iterationCount>0&&r.push(`\n\n---\n\n*Refinement iteration ${n.iterationCount+1}*`);const a=function(n,t){if(n.customPrompt.trim())return n.customPrompt.trim();if(n.promptPresetId){const e=t.getPromptPreset(n.promptPresetId);if(e)return e.prompt}return""}(n.config,t);return a&&r.push("\n\n---\n\n## INSTRUCTIONS\n\n"+a),r.join("")}(n,t),p=function(n,t,e){return t?e.getRefinementPrompt():e.getSystemPrompt(n)}(n.stage,null!==(r=n.isRefinement)&&void 0!==r&&r,t),u=function(n,t){if(!n.useStructuredOutput)return null;if(n.customSchema.trim())try{return JSON.parse(n.customSchema)}catch(n){return null}if(n.schemaPresetId){const e=t.getSchemaPreset(n.schemaPresetId);if(e)return e.schema}return null}(n.config,t);if(null==c||c(`Running ${n.stage}...`),null==o?void 0:o.aborted)return{stage:n.stage,timestamp:l,input:d,output:"",guidance:n.guidance,error:"Aborted"};const m=yield(0,wn.generate)({prompt:d,systemPrompt:p,jsonSchema:null!==(a=u)&&void 0!==a?a:void 0,signal:o});return m.success?{stage:n.stage,timestamp:l,input:d,output:null!==(i=m.response)&&void 0!==i?i:"",guidance:n.guidance}:(h.Rm.error(`Stage ${n.stage} failed`,m.error),{stage:n.stage,timestamp:l,input:d,output:"",guidance:n.guidance,error:null!==(s=m.error)&&void 0!==s?s:"Generation failed"})})}var Sn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function Pn(n,t,e){return Sn(this,void 0,void 0,function*(){if(yield e(),n.character=t,n.selectedFields={},n.stageFields={base:{},linked:!0,overrides:{}},n.activeSessionId=null,n.sessions=[],n.sessionsLoaded=!1,n.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},n.stageResults={score:null,rewrite:null,analyze:null},n.iterationCount=0,n.iterationHistory=[],n.hasUnsavedChanges=!1,t){try{n.character=yield vn(t),h.Rm.debug(`Character loaded: ${n.character.name}`)}catch(e){h.Rm.error("Failed to unshallow character",e),n.character=t}n.sessions=yield function(n){return rn(this,void 0,void 0,function*(){var t;const e=yield sn();return(null!==(t=(yield on())[n])&&void 0!==t?t:[]).map(n=>e.get(n)).filter(n=>void 0!==n)})}(t.avatar),n.sessionsLoaded=!0}})}function Tn(n,t){return Sn(this,void 0,void 0,function*(){if(!n.character)return null;yield t();const e=function(n,t){const e=_n(n),r={};for(const n of e)t[n.key]&&(r[n.key]=n.value);return r}(n.character,n.stageFields.base),r=yield pn({characterId:n.character.avatar,characterName:n.character.name,stageFields:n.stageFields,originalData:e,configs:n.stageConfigs});return n.sessions.unshift(r),n.activeSessionId=r.id,n.iterationCount=0,n.iterationHistory=[],n.stageResults={score:null,rewrite:null,analyze:null},n.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},n.hasUnsavedChanges=!1,r})}function Cn(n,t){return Sn(this,void 0,void 0,function*(){yield function(n){return rn(this,void 0,void 0,function*(){const t=yield sn(),e=yield on(),r=t.get(n);if(!r)return;t.delete(n);const a=e[r.characterId];if(a){const t=a.indexOf(n);-1!==t&&a.splice(t,1),0===a.length&&delete e[r.characterId]}yield cn(),yield ln()})}(t);const e=n.sessions.findIndex(n=>n.id===t);-1!==e&&n.sessions.splice(e,1),n.activeSessionId===t&&(n.activeSessionId=null,n.iterationHistory=[],n.iterationCount=0,n.stageResults={score:null,rewrite:null,analyze:null},n.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"})})}var Rn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};let En=null;const On=function(n,t){const e=SillyTavern.libs.lodash;return e.debounce(()=>mn(this,void 0,void 0,function*(){const r=n();if(!(null==r?void 0:r.activeSessionId)||!r.character)return;const a=yield dn(r.activeSessionId);a&&(a.stageFields=e.cloneDeep(r.stageFields),a.configs=e.cloneDeep(r.stageConfigs),a.history=e.cloneDeep(r.iterationHistory),a.iterationCount=r.iterationCount,a.userGuidance=r.userGuidance||void 0,yield un(a),t(!1))}),1e3)}(()=>En,n=>{En&&(En.hasUnsavedChanges=n)});function An(){return En={character:null,selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}},activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1,selectedStages:[...h.an],stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},stageResults:{score:null,rewrite:null,analyze:null},stageConfigs:{score:P("score"),rewrite:P("rewrite"),analyze:P("analyze")},activeStage:"score",iterationCount:0,iterationHistory:[],userGuidance:"",isGenerating:!1,abortController:null,searchQuery:"",searchResults:[],searchSelectedIndex:-1,dropdownOpen:!1,sessionListExpanded:!1,historyExpanded:!0},En}function zn(){if(!En)throw new Error("State not initialized");return En}function Nn(){return En}function In(){On.cancel(),En=null}function Wn(){const n=Nn();n&&(n.hasUnsavedChanges=!0,On())}function jn(){return Rn(this,void 0,void 0,function*(){On.flush()})}function Dn(n){return Rn(this,void 0,void 0,function*(){return function(n,t,e){return Sn(this,void 0,void 0,function*(){var r;yield e();const a=yield dn(t);if(!a)return!1;if((null===(r=n.character)||void 0===r?void 0:r.avatar)!==a.characterId){const t=SillyTavern.getContext().characters.find(n=>n.avatar===a.characterId);if(!t)return!1;n.character=t}const s=SillyTavern.libs.lodash;n.activeSessionId=a.id,n.stageFields=s.cloneDeep(a.stageFields),n.selectedFields=s.cloneDeep(a.stageFields.base),n.stageConfigs=s.cloneDeep(a.configs),n.iterationHistory=s.cloneDeep(a.history),n.iterationCount=a.iterationCount,n.userGuidance=a.userGuidance||"",n.hasUnsavedChanges=!1,n.stageResults={score:null,rewrite:null,analyze:null};for(const t of a.history)n.stageResults[t.stage]=t;for(const t of h.an)n.stageStatus[t]=n.stageResults[t]?n.stageResults[t].error?"error":"complete":"pending";return!0})}(zn(),n,jn)})}function Ln(n){var t;const e=zn(),r=null!=n?n:e.activeStage;return e.stageFields.linked?e.stageFields.base:null!==(t=e.stageFields.overrides[r])&&void 0!==t?t:e.stageFields.base}function Mn(){return Ln()}function Fn(){return zn().stageFields.linked}function Bn(n,t){var e,r,a;const s=zn(),i=s.stageFields.linked?s.stageFields.base:null!==(e=(r=s.stageFields.overrides)[a=s.activeStage])&&void 0!==e?e:r[a]={};!1===t||Array.isArray(t)&&0===t.length?delete i[n]:i[n]=t,s.selectedFields=Object.assign({},i),Wn()}function Gn(n){zn().activeStage=n}function Un(n,t){const e=zn();Object.assign(e.stageConfigs[n],t),Wn()}var qn=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};const Hn={getPromptPreset:J,getSchemaPreset:V,getSystemPrompt:function(n){const t=w();return[t.baseSystemPrompt,t.userSystemPrompt,t.stageSystemPrompts[n]].filter(n=>n.trim()).join("\n\n")},getRefinementPrompt:function(){const n=w();return[n.baseRefinementPrompt,n.userRefinementPrompt].filter(n=>n.trim()).join("\n\n")}};function Jn(n,t,e){n.stageStatus[t]=e}function Yn(n,t,e){n.isGenerating=t,n.abortController=t?null!=e?e:new AbortController:null,t?h.wG.show():h.wG.hide()}function Vn(n,t){n.stageResults[t.stage]=t,n.stageStatus[t.stage]=t.error?"error":"complete",n.iterationHistory.push(t),n.hasUnsavedChanges=!0}function Kn(n,t){return n.character?{character:n.character,selection:Ln(t),stage:t,config:n.stageConfigs[t],previousResults:n.stageResults,iterationCount:n.iterationCount,guidance:n.userGuidance||void 0}:null}function Qn(n){return qn(this,arguments,void 0,function*(n,t={}){var e,r,a,s,i;const{stages:o=[...h.an],callbacks:c}=t;if(!n.character)return h.Rm.warn("Cannot execute pipeline: no character selected"),{score:null,rewrite:null,analyze:null};if(n.isGenerating)return h.Rm.warn("Cannot execute pipeline: generation already in progress"),{score:null,rewrite:null,analyze:null};const l=new AbortController;Yn(n,!0,l);for(const t of h.an)Jn(n,t,"pending");const d={score:n.stageResults.score,rewrite:n.stageResults.rewrite,analyze:n.stageResults.analyze};try{for(const t of o){if(l.signal.aborted){h.Rm.debug("Pipeline aborted");break}const i=Kn(n,t);if(!i)break;i.previousResults=d,Jn(n,t,"running"),null===(e=null==c?void 0:c.onStageStart)||void 0===e||e.call(c,t),null===(r=null==c?void 0:c.onProgress)||void 0===r||r.call(c,`Running ${t}...`);const o=yield kn(i,Hn,{signal:l.signal,onProgress:n=>{var t;h.Rm.debug(`[Pipeline] ${n}`),null===(t=null==c?void 0:c.onProgress)||void 0===t||t.call(c,n)}});if(d[t]=o,Vn(n,o),null===(a=null==c?void 0:c.onStageComplete)||void 0===a||a.call(c,t,o),o.error){null===(s=null==c?void 0:c.onError)||void 0===s||s.call(c,t,o.error);break}}}catch(t){const e=t instanceof Error?t.message:"Unknown error";h.Rm.error("Pipeline execution failed:",t),null===(i=null==c?void 0:c.onError)||void 0===i||i.call(c,n.activeStage,e)}finally{Yn(n,!1)}return d})}function Xn(n,t=document){return t.querySelector(n)}function Zn(n,t=document){return Array.from(t.querySelectorAll(n))}function nt(n,t,e,r){return n?(n.addEventListener(t,e,r),()=>{n.removeEventListener(t,e,r)}):()=>{}}function tt(n){return void 0===n?"...":null===n?"—":n>=1e3?`${(n/1e3).toFixed(1)}k`:n.toString()}function et(n,t){return n.length<=t?n:n.slice(0,t-1)+"…"}function rt(...n){return n.filter(Boolean).join(" ")}function at(n,t,e){const r=SillyTavern.libs.morphdom,a=SillyTavern.libs.DOMPurify,s=document.createElement("div");s.innerHTML=a.sanitize(t),r(n,s,{childrenOnly:!0,onBeforeElUpdated:(n,t)=>{var r,a;if(document.activeElement===n&&"INPUT"===n.tagName){const e=n,r=t;r.value=e.value,r.selectionStart=e.selectionStart,r.selectionEnd=e.selectionEnd}if(document.activeElement===n&&"TEXTAREA"===n.tagName){const e=n,r=t;r.value=e.value,r.selectionStart=e.selectionStart,r.selectionEnd=e.selectionEnd}return null===(a=null===(r=null==e?void 0:e.onBeforeElUpdated)||void 0===r?void 0:r.call(e,n,t))||void 0===a||a},onBeforeNodeDiscarded:null==e?void 0:e.onBeforeNodeDiscarded,onNodeAdded:null==e?void 0:e.onNodeAdded})}const st=new Map;let it=new Set,ot=!1;function ct(n,t,e){return st.set(n,{fn:t,categories:e}),()=>st.delete(n)}function lt(...n){for(const t of n)it.add(t);ot||(ot=!0,queueMicrotask(dt))}function dt(){if(ot=!1,0===it.size)return;const n=it;it=new Set;const t=n.has("all");for(const e of st.values())if(t||e.categories.some(t=>n.has(t)))try{e.fn()}catch(n){console.error("[UpdateCoordinator] Update failed:",n)}}function pt(){lt("character","session","fields","config","results","pipeline")}var ut=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function mt(){return SillyTavern.getContext().characters||[]}let ft=null;function vt(){ft=null}let gt=!1,ht="",bt=-1;function yt(n){gt=n;const t=Xn(`#${h.pW}_char_dropdown`);t&&t.classList.toggle("ct-dropdown--open",n),n||(bt=-1)}function _t(){const n=ht.trim();if(!n)return mt().slice(0,30);return function(){var n;const t=mt();if(!ft||(null===(n=ft._docs)||void 0===n?void 0:n.length)!==t.length){const n=SillyTavern.libs.Fuse;ft=new n(t,{keys:[{name:"name",weight:3},{name:"description",weight:1}],threshold:.3,includeScore:!0,minMatchCharLength:2,ignoreLocation:!0})}return ft}().search(n).map(n=>n.item).slice(0,20)}function xt(){var n;const t=zn(),e=_t(),r=null===(n=t.character)||void 0===n?void 0:n.avatar;return 0===e.length?`\n            <div class="ct-dropdown__empty">\n                <i class="fa-solid ${ht?"fa-search":"fa-users-slash"}"></i>\n                ${ht?`No matches for "${et(ht,20)}"`:"No characters available"}\n            </div>\n        `:e.map((n,t)=>function(n,t,e){var r,a;const s=SillyTavern.libs.DOMPurify,i=SillyTavern.getContext().getThumbnailUrl("avatar",n.avatar),o=_n(n).length,c=et((n.description||"").replace(/\n/g," "),60),l=(null===(r=n.data)||void 0===r?void 0:r.creator)||"",d=(null===(a=n.data)||void 0===a?void 0:a.character_version)||"",p=[];return l&&p.push(l),d&&p.push(`v${d}`),0===p.length&&p.push(`${o} ${1===o?"field":"fields"}`),`\n        <div class="ct-char-option ${e?"ct-char-option--selected":""} ${t===bt?"ct-char-option--highlighted":""}"\n             data-avatar="${s.sanitize(n.avatar)}"\n             data-index="${t}"\n             role="option"\n             aria-selected="${e}">\n            <div class="ct-char-option__avatar-wrap">\n                <img class="ct-char-option__avatar"\n                     src="${i}"\n                     alt=""\n                     onerror="this.src='/img/ai4.png'"\n                     loading="lazy" />\n                ${e?'<i class="fa-solid fa-check ct-char-option__check"></i>':""}\n            </div>\n            <div class="ct-char-option__info">\n                <span class="ct-char-option__name">${s.sanitize(n.name)}</span>\n                ${c?`<span class="ct-char-option__desc">${s.sanitize(c)}</span>`:""}\n                <span class="ct-char-option__meta">\n                    <i class="fa-solid fa-user-pen"></i>\n                    ${s.sanitize(p.join(" • "))}\n                </span>\n            </div>\n        </div>\n    `}(n,t,n.avatar===r)).join("")}function wt(){if(!Xn(`#${h.pW}_char_dropdown`))return;const n=SillyTavern.libs.DOMPurify,t=zn().character,e=Xn(`#${h.pW}_char_trigger`);if(e){const r=t?n.sanitize(t.name):"Select character...",a=t?`<img class="ct-dropdown__trigger-avatar"\n                   src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n                   alt=""\n                   onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user ct-dropdown__trigger-icon"></i>';e.innerHTML=`\n            ${a}\n            <span class="ct-dropdown__trigger-text ${t?"":"ct-dropdown__trigger-text--placeholder"}">${r}</span>\n            <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n        `}const r=Xn(`#${h.pW}_char_list`);r&&(r.innerHTML=xt())}function $t(n){n.forEach((n,t)=>{n.classList.toggle("ct-char-option--highlighted",t===bt),t===bt&&n.scrollIntoView({block:"nearest"})})}function kt(n){return ut(this,void 0,void 0,function*(){const t=n.dataset.avatar;if(!t)return;const e=mt().find(n=>n.avatar===t);e&&(yield function(n){return Rn(this,void 0,void 0,function*(){yield Pn(zn(),n,jn)})}(e),ht="",yt(!1),pt())})}var St=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};let Pt={isOpen:!1,type:"prompt",mode:"create",preset:null,activeTab:"edit"},Tt={},Ct=[];function Rt(){return`\n        <div id="${h.pW}_preset_drawer" class="ct-drawer" aria-hidden="true">\n            <div class="ct-drawer__backdrop"></div>\n            <aside class="ct-drawer__panel" role="dialog" aria-label="Preset Editor">\n                <div class="ct-drawer__content">\n                    ${Et()}\n                    ${Ot()}\n                    ${At()}\n                </div>\n            </aside>\n        </div>\n    `}function Et(){const{type:n,mode:t,preset:e}=Pt;let r="",a="";return"create"===t?(r=`New ${"prompt"===n?"Prompt":"Schema"} Preset`,a="fa-plus"):"edit"===t?(r=`Edit ${"prompt"===n?"Prompt":"Schema"} Preset`,a="fa-pen"):(r=`Duplicate ${"prompt"===n?"Prompt":"Schema"} Preset`,a="fa-copy"),`\n        <header class="ct-drawer__header">\n            <div class="ct-drawer__title">\n                <i class="fa-solid ${a} ct-text-accent"></i>\n                <h3>${r}</h3>\n                ${(null==e?void 0:e.isBuiltin)?'<span class="ct-badge ct-badge--info ct-badge--small">builtin</span>':""}\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n    `}function Ot(){const{type:n,mode:t,preset:e}=Pt;return`\n        <div class="ct-drawer__body ct-scrollable">\n            ${"duplicate"===t&&(null==e?void 0:e.isBuiltin)?'\n                <div class="ct-alert ct-alert--info ct-mb-3">\n                    <i class="fa-solid fa-circle-info ct-alert__icon"></i>\n                    <div class="ct-alert__content">\n                        <div class="ct-alert__message">\n                            Builtin presets cannot be modified. You\'re creating an editable copy.\n                        </div>\n                    </div>\n                </div>\n            ':""}\n            ${function(){const{preset:n,mode:t}=Pt,e=SillyTavern.libs.DOMPurify;let r="";n&&(r="duplicate"===t?`${n.name} (Copy)`:n.name);return`\n        <div class="ct-form-group">\n            <label class="ct-label" for="${h.pW}_drawer_name">\n                Name <span class="ct-required">*</span>\n            </label>\n            <input type="text"\n                   id="${h.pW}_drawer_name"\n                   class="ct-input text_pole"\n                   value="${e.sanitize(r)}"\n                   placeholder="Enter preset name..."\n                   maxlength="100"\n                   autocomplete="off" />\n        </div>\n    `}()}\n            ${function(){const{preset:n}=Pt,t=(null==n?void 0:n.stages)||[];return`\n        <div class="ct-form-group">\n            <label class="ct-label">\n                Applicable Stages\n                <span class="ct-hint ct-text-dim">(empty = all stages)</span>\n            </label>\n            <div class="ct-stage-chips">\n                ${h.an.map(n=>`\n                    <label class="ct-chip ${0===t.length||t.includes(n)?"ct-chip--active":""}">\n                        <input type="checkbox"\n                               name="drawer_stages"\n                               value="${n}"\n                               ${0===t.length||t.includes(n)?"checked":""} />\n                        <span>${h.BA[n]}</span>\n                    </label>\n                `).join("")}\n            </div>\n        </div>\n    `}()}\n            ${"prompt"===n?function(){const{preset:n}=Pt,t=SillyTavern.libs.DOMPurify,e=(null==n?void 0:n.prompt)||"";return`\n        <div class="ct-form-group ct-form-group--grow">\n            <div class="ct-row ct-row--between">\n                <label class="ct-label" for="${h.pW}_drawer_prompt">\n                    Prompt Template <span class="ct-required">*</span>\n                </label>\n                <div class="ct-row ct-gap-1">\n                    <button id="${h.pW}_drawer_prompt_vars"\n                            class="menu_button menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="View available variables">\n                        <i class="fa-solid fa-code"></i>\n                        Variables\n                    </button>\n                </div>\n            </div>\n            <div class="ct-editor-wrap">\n                <textarea id="${h.pW}_drawer_prompt"\n                          class="ct-textarea ct-textarea--editor text_pole"\n                          placeholder="Enter your prompt template...\n\nUse {{character}} for character data, {{field_name}} for specific fields.\nThe prompt will be sent to the LLM along with the selected character fields."\n                          spellcheck="false">${t.sanitize(e)}</textarea>\n            </div>\n            <div class="ct-form-group__hint ct-row ct-row--between">\n                <span id="${h.pW}_drawer_prompt_tokens" class="ct-text-dim">Calculating tokens...</span>\n            </div>\n        </div>\n    `}():function(){const{preset:n}=Pt,t=SillyTavern.libs.DOMPurify;let e="";n&&"schema"in n&&(e="string"==typeof n.schema?n.schema:JSON.stringify(n.schema,null,2));return`\n        <div class="ct-form-group ct-form-group--grow">\n            <div class="ct-row ct-row--between">\n                <label class="ct-label" for="${h.pW}_drawer_schema">\n                    JSON Schema <span class="ct-required">*</span>\n                </label>\n            </div>\n\n            \x3c!-- Schema Toolbar --\x3e\n            <div class="ct-editor-toolbar">\n                <button id="${h.pW}_drawer_generate"\n                        class="menu_button menu_button--sm menu_button--primary"\n                        type="button"\n                        title="Generate schema from description using AI">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    AI Generate\n                </button>\n                <div class="ct-toolbar-divider"></div>\n                <button id="${h.pW}_drawer_validate"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Validate JSON schema">\n                    <i class="fa-solid fa-check-circle"></i>\n                    Validate\n                </button>\n                <button id="${h.pW}_drawer_format"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Format JSON">\n                    <i class="fa-solid fa-align-left"></i>\n                    Format\n                </button>\n                <button id="${h.pW}_drawer_minify"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Minify JSON">\n                    <i class="fa-solid fa-compress"></i>\n                </button>\n            </div>\n\n            \x3c!-- Schema Editor with syntax highlighting --\x3e\n            <div class="ct-code-editor" id="${h.pW}_drawer_schema_wrap">\n                <pre class="ct-code-editor__highlight" id="${h.pW}_drawer_schema_highlight" aria-hidden="true"><code class="language-json"></code></pre>\n                <textarea id="${h.pW}_drawer_schema"\n                          class="ct-code-editor__textarea ct-textarea--code text_pole"\n                          placeholder='{"name": "MySchema", "strict": true, "schema": {...}}'\n                          spellcheck="false">${t.sanitize(e)}</textarea>\n            </div>\n\n            \x3c!-- Validation messages --\x3e\n            <div id="${h.pW}_drawer_errors" class="ct-errors ct-hidden"></div>\n            <div id="${h.pW}_drawer_warnings" class="ct-warnings ct-hidden"></div>\n        </div>\n    `}()}\n        </div>\n    `}function At(){const{mode:n,preset:t}=Pt,e=(null==t?void 0:t.isBuiltin)||!1,r="create"===n?"Create Preset":"edit"===n?"Save Changes":"Create Copy";return`\n        <footer class="ct-drawer__footer">\n            <div class="ct-row ct-row--between ct-flex-1">\n                <div class="ct-row">\n                    ${t&&!e&&"edit"===n?`\n                        <button id="${h.pW}_drawer_delete"\n                                class="menu_button menu_button--danger"\n                                type="button">\n                            <i class="fa-solid fa-trash"></i>\n                            Delete\n                        </button>\n                    `:""}\n                </div>\n                <div class="ct-row ct-gap-2">\n                    <button id="${h.pW}_drawer_cancel"\n                            class="menu_button"\n                            type="button">\n                        Cancel\n                    </button>\n                    <button id="${h.pW}_drawer_save"\n                            class="menu_button menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-check"></i>\n                        ${r}\n                    </button>\n                </div>\n            </div>\n        </footer>\n    `}function zt(n,t){Pt={isOpen:!0,type:n,mode:"create",preset:null,activeTab:"edit"},Tt=t||{},jt()}function Nt(n,t,e){const r="prompt"===n?T.getPromptPreset(t):T.getSchemaPreset(t);r?r.isBuiltin?It(n,t,e):(Pt={isOpen:!0,type:n,mode:"edit",preset:r,activeTab:"edit"},Tt=e||{},jt()):h.oR.error("Preset not found")}function It(n,t,e){const r="prompt"===n?T.getPromptPreset(t):T.getSchemaPreset(t);r?(Pt={isOpen:!0,type:n,mode:"duplicate",preset:r,activeTab:"edit"},Tt=e||{},jt()):h.oR.error("Preset not found")}function Wt(){const n=Xn(`#${h.pW}_preset_drawer`);n&&(n.classList.remove("ct-drawer--open"),n.setAttribute("aria-hidden","true"),setTimeout(()=>{var n;Ct.forEach(n=>n()),Ct=[],Pt.isOpen=!1,null===(n=Tt.onClose)||void 0===n||n.call(Tt)},300))}function jt(){const n=Xn(`#${h.pW}_preset_drawer`);if(!n)return void h.Rm.error("Drawer not initialized");const t=Xn(".ct-drawer__panel",n);t&&(t.innerHTML=`\n            <div class="ct-drawer__content">\n                ${Et()}\n                ${Ot()}\n                ${At()}\n            </div>\n        `),function(n){const t=Xn(`#${h.pW}_drawer_close`,n);t&&Ct.push(nt(t,"click",Wt));const e=Xn(".ct-drawer__backdrop",n);e&&Ct.push(nt(e,"click",Wt));const r=Xn(`#${h.pW}_drawer_cancel`,n);r&&Ct.push(nt(r,"click",Wt));const a=Xn(`#${h.pW}_drawer_save`,n);a&&Ct.push(nt(a,"click",Lt));const s=Xn(`#${h.pW}_drawer_delete`,n);s&&Ct.push(nt(s,"click",Ft));const i=Zn('.ct-chip input[name="drawer_stages"]',n);for(const n of i)Ct.push(nt(n,"change",()=>{const t=n.closest(".ct-chip");t&&t.classList.toggle("ct-chip--active",n.checked)}));"prompt"===Pt.type?function(n){const t=Xn(`#${h.pW}_drawer_prompt`,n);if(t){const n=SillyTavern.libs.lodash.debounce(()=>St(this,void 0,void 0,function*(){const n=Xn(`#${h.pW}_drawer_prompt_tokens`);if(!n)return;const e=t.value,r=Math.ceil(e.length/4);n.textContent=`~${r} tokens`}),300);Ct.push(nt(t,"input",()=>{n()})),n()}const e=Xn(`#${h.pW}_drawer_prompt_vars`,n);e&&Ct.push(nt(e,"click",()=>St(this,void 0,void 0,function*(){yield h.lY.alert("Available Variables",'\n                    <div class="ct-stack">\n                        <p>Use these placeholders in your prompt:</p>\n                        <ul class="ct-list ct-text-sm">\n                            <li><code>{{character}}</code> - Full character summary</li>\n                            <li><code>{{name}}</code> - Character name</li>\n                            <li><code>{{description}}</code> - Character description</li>\n                            <li><code>{{personality}}</code> - Personality traits</li>\n                            <li><code>{{scenario}}</code> - Scenario/setting</li>\n                            <li><code>{{first_mes}}</code> - First message</li>\n                            <li><code>{{mes_example}}</code> - Example messages</li>\n                            <li><code>{{system_prompt}}</code> - System prompt</li>\n                            <li><code>{{creator_notes}}</code> - Creator notes</li>\n                        </ul>\n                    </div>\n                ')})))}(n):function(n){const t=Xn(`#${h.pW}_drawer_schema`,n);if(t){const n=SillyTavern.libs.lodash.debounce(()=>{Dt()},100);Ct.push(nt(t,"input",()=>{n()})),Ct.push(nt(t,"scroll",()=>{!function(n){const t=Xn(`#${h.pW}_drawer_schema_highlight`);t&&(t.scrollTop=n.scrollTop,t.scrollLeft=n.scrollLeft)}(t)}))}const e=Xn(`#${h.pW}_drawer_generate`,n);e&&Ct.push(nt(e,"click",()=>St(this,void 0,void 0,function*(){const n=yield h.lY.input("Generate Schema","Describe the structure you want:","e.g., rating 1-10, list of strengths and weaknesses, summary paragraph");if(!n)return;e.setAttribute("disabled","true");const r=e.querySelector("i"),a=null==r?void 0:r.className;r&&(r.className="fa-solid fa-spinner fa-spin");try{const e=yield(0,q.nr)(n);e.success&&e.schema&&t?(t.value=e.schema,Dt(),h.oR.success("Schema generated"),function(){const n=Xn(`#${h.pW}_drawer_errors`),t=Xn(`#${h.pW}_drawer_warnings`);null==n||n.classList.add("ct-hidden"),null==t||t.classList.add("ct-hidden")}()):h.oR.error(e.error||"Generation failed")}catch(n){h.oR.error(`Failed: ${n.message}`)}finally{e.removeAttribute("disabled"),r&&a&&(r.className=a)}})));const r=Xn(`#${h.pW}_drawer_validate`,n);r&&t&&Ct.push(nt(r,"click",()=>{!function(n){var t;const e=Xn(`#${h.pW}_drawer_errors`),r=Xn(`#${h.pW}_drawer_warnings`);e&&(n.valid?(e.classList.add("ct-hidden"),h.oR.success("Schema is valid")):(e.innerHTML=`<div class="ct-error"><i class="fa-solid fa-times-circle"></i> ${n.error}</div>`,e.classList.remove("ct-hidden")));r&&((null===(t=n.warnings)||void 0===t?void 0:t.length)?(r.innerHTML=n.warnings.map(n=>`<div class="ct-warning"><i class="fa-solid fa-exclamation-triangle"></i> ${n}</div>`).join(""),r.classList.remove("ct-hidden")):r.classList.add("ct-hidden"))}((0,q.i6)(t.value))}));const a=Xn(`#${h.pW}_drawer_format`,n);a&&t&&Ct.push(nt(a,"click",()=>{try{const n=JSON.parse(t.value);t.value=(0,q.jf)(n),Dt(),h.oR.success("Formatted")}catch(n){h.oR.error(`Invalid JSON: ${n.message}`)}}));const s=Xn(`#${h.pW}_drawer_minify`,n);s&&t&&Ct.push(nt(s,"click",()=>{try{const n=JSON.parse(t.value);t.value=JSON.stringify(n),Dt(),h.oR.success("Minified")}catch(n){h.oR.error(`Invalid JSON: ${n.message}`)}}))}(n);const o=n=>{"Escape"===n.key&&Pt.isOpen&&(n.preventDefault(),n.stopPropagation(),Wt())};document.addEventListener("keydown",o),Ct.push(()=>document.removeEventListener("keydown",o))}(n),requestAnimationFrame(()=>{n.classList.add("ct-drawer--open"),n.setAttribute("aria-hidden","false");const t=Xn(`#${h.pW}_drawer_name`,n);t&&(t.focus(),t.select()),"schema"===Pt.type&&Dt()})}function Dt(){const n=Xn(`#${h.pW}_drawer_schema`),t=Xn(`#${h.pW}_drawer_schema_highlight code`);if(!n||!t)return;const e=SillyTavern.libs.hljs,r=SillyTavern.libs.DOMPurify;try{const a=e.highlight(n.value||" ",{language:"json"});t.innerHTML=r.sanitize(a.value)}catch(e){t.textContent=n.value}}function Lt(){return St(this,void 0,void 0,function*(){var n,t;const{type:e,mode:r,preset:a}=Pt,s=Xn(`#${h.pW}_drawer_name`),i=(null==s?void 0:s.value.trim())||"",o=Zn('input[name="drawer_stages"]:checked'),c=Array.from(o).map(n=>n.value),l=c.length===h.an.length?[]:c;if("prompt"===e){const t=Xn(`#${h.pW}_drawer_prompt`),e=(null==t?void 0:t.value)||"",s=function(n){var t,e;const r=[],a=[];return(null===(t=n.name)||void 0===t?void 0:t.trim())?n.name.length>100&&r.push("Name must be 100 characters or less"):r.push("Name is required"),(null===(e=n.prompt)||void 0===e?void 0:e.trim())?n.prompt.length>5e4&&r.push("Prompt is too long (max 50,000 characters)"):r.push("Prompt is required"),n.prompt&&/\{\{user\}\}/i.test(n.prompt)&&a.push("{{user}} is not replaced - user persona is not relevant to card analysis"),{valid:0===r.length,errors:r,warnings:a}}({name:i,prompt:e,stages:l});if(!s.valid)return void Mt(s.errors);const o="edit"===r?null==a?void 0:a.id:void 0;if(!T.isNameUnique("prompt",i,o))return void Mt(["A preset with this name already exists"]);let c;"edit"===r&&a?(T.updatePromptPreset(a.id,{name:i,prompt:e,stages:l}),c=T.getPromptPreset(a.id),h.oR.success("Preset updated")):(c=T.registerPromptPreset({name:i,prompt:e,stages:l}),h.oR.success("Preset created")),null===(n=Tt.onSave)||void 0===n||n.call(Tt,c),Wt()}else{const n=Xn(`#${h.pW}_drawer_schema`),e=(null==n?void 0:n.value)||"";let s;try{s=JSON.parse(e)}catch(n){return void Mt([`Invalid JSON: ${n.message}`])}const o=K({name:i,schema:s,stages:l});if(!o.valid)return void Mt(o.errors);const c="edit"===r?null==a?void 0:a.id:void 0;if(!T.isNameUnique("schema",i,c))return void Mt(["A preset with this name already exists"]);let d;"edit"===r&&a?(T.updateSchemaPreset(a.id,{name:i,schema:s,stages:l}),d=T.getSchemaPreset(a.id),h.oR.success("Schema preset updated")):(d=T.registerSchemaPreset({name:i,schema:s,stages:l}),h.oR.success("Schema preset created")),null===(t=Tt.onSave)||void 0===t||t.call(Tt,d),Wt()}})}function Mt(n){const t=Xn(`#${h.pW}_drawer_errors`);t&&(t.innerHTML=n.map(n=>`<div class="ct-error"><i class="fa-solid fa-times-circle"></i> ${n}</div>`).join(""),t.classList.remove("ct-hidden"))}function Ft(){return St(this,void 0,void 0,function*(){const{type:n,preset:t}=Pt;if(!t)return;(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${t.name}"?`))&&("prompt"===n?T.deletePromptPreset(t.id):T.deleteSchemaPreset(t.id),h.oR.success("Preset deleted"),Wt())})}var Bt=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function Gt(){const n=zn();if(!n.character)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-user-slash ct-empty__icon"></i>\n                <div class="ct-empty__title">No character selected</div>\n                <div class="ct-empty__text">Select a character to see available fields</div>\n            </div>\n        ';const t=_n(n.character);return 0===t.length?'\n            <div class="ct-empty">\n                <i class="fa-solid fa-file-circle-question ct-empty__icon"></i>\n                <div class="ct-empty__title">No fields</div>\n                <div class="ct-empty__text">This character has no populated fields</div>\n            </div>\n        ':(requestAnimationFrame(()=>function(n){return Bt(this,void 0,void 0,function*(){const t=n.filter(n=>"alternate_greetings"!==n.key).map(n=>({key:n.key,text:n.value}));if(0===t.length)return;const e=yield(0,h.gg)(t);for(const{key:n,tokens:t}of e){const e=Xn(`.ct-field-tokens[data-field="${n}"]`);e&&(e.textContent=tt(t))}})}(t)),`\n        <div class="ct-field-list ct-scrollable">\n            ${t.map(n=>function(n){const t=SillyTavern.libs.DOMPurify,e=Mn(),r=n.key in e&&!1!==e[n.key];if("alternate_greetings"===n.key&&Array.isArray(n.rawValue)){const r=n.rawValue,a=Array.isArray(e[n.key])?e[n.key]:[],s=a.length===r.length;return`\n            <div class="ct-field-group ct-field-group--expandable" data-field="${n.key}">\n                <div class="ct-field-item ct-field-item--parent">\n                    <label class="ct-field-label">\n                        <input type="checkbox"\n                               class="ct-field-checkbox ct-field-checkbox--parent"\n                               data-field="${n.key}"\n                               ${s?"checked":""}\n                               ${a.length>0&&!s?"indeterminate":""} />\n                        <span class="ct-field-name">${t.sanitize(n.label)}</span>\n                    </label>\n                    <span class="ct-field-count">${r.length} greetings</span>\n                    <button class="ct-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="ct-field-children">\n                    ${r.map((t,e)=>`\n                        <div class="ct-field-item ct-field-item--child">\n                            <label class="ct-field-label">\n                                <input type="checkbox"\n                                       class="ct-field-checkbox ct-field-checkbox--child"\n                                       data-field="${n.key}"\n                                       data-index="${e}"\n                                       ${a.includes(e)?"checked":""} />\n                                <span class="ct-field-name">Greeting ${e+1}</span>\n                            </label>\n                            <button class="ct-field-preview-btn" type="button" data-field="${n.key}" data-index="${e}" title="Preview greeting">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}const a=150,s=n.value.length>a?n.value.substring(0,a).trim()+"…":n.value;return`\n        <div class="ct-field-group ct-field-group--expandable" data-field="${n.key}">\n            <div class="ct-field-item ct-field-item--has-preview">\n                <label class="ct-field-label">\n                    <input type="checkbox"\n                           class="ct-field-checkbox"\n                           data-field="${n.key}"\n                           ${r?"checked":""} />\n                    <span class="ct-field-name">${t.sanitize(n.label)}</span>\n                </label>\n                <span class="ct-field-tokens" data-field="${n.key}">${tt(n.tokens)}</span>\n                <button class="ct-field-expand" type="button" aria-label="Expand field preview">\n                    <i class="fa-solid fa-chevron-down"></i>\n                </button>\n            </div>\n            <div class="ct-field-preview">\n                <pre class="ct-field-preview__text">${t.sanitize(s)}</pre>\n                <button class="ct-field-preview__more" type="button" data-field="${n.key}" title="View full content in popup">\n                    <i class="fa-solid fa-expand"></i>\n                    <span>View full content</span>\n                </button>\n            </div>\n        </div>\n    `}(n)).join("")}\n        </div>\n    `)}function Ut(n,t,e){const r=SillyTavern.libs.DOMPurify,a="prompt"===n?H(t):Y(t);return`\n        <div class="ct-preset-row">\n            <select id="${`${h.pW}_${n}_select`}" class="ct-select text_pole" aria-label="${n} preset">\n                <option value="">Custom</option>\n                ${a.map(n=>`\n                    <option value="${n.id}" ${n.id===e?"selected":""}>\n                        ${r.sanitize(n.name)}${n.isBuiltin?"":" ✦"}\n                    </option>\n                `).join("")}\n            </select>\n            <div class="ct-preset-row__actions">\n                <button class="ct-preset-manage ct-preset-edit-btn"\n                        data-type="${n}"\n                        type="button"\n                        title="Edit selected preset"\n                        ${e?"":"disabled"}>\n                    <i class="fa-solid fa-pen"></i>\n                </button>\n                <button class="ct-preset-manage ct-preset-new-btn"\n                        data-type="${n}"\n                        type="button"\n                        title="Create new ${n} preset">\n                    <i class="fa-solid fa-plus"></i>\n                </button>\n            </div>\n        </div>\n    `}function qt(n,t,e){const r=Xn(`#${`${h.pW}_${n}_select`}`);if(!r)return;const a=SillyTavern.libs.DOMPurify,s=`\n        <option value="">Custom</option>\n        ${("prompt"===n?H(t):Y(t)).map(n=>`\n            <option value="${n.id}" ${n.id===e?"selected":""}>\n                ${a.sanitize(n.name)}${n.isBuiltin?"":" ✦"}\n            </option>\n        `).join("")}\n    `;r.innerHTML=s}function Ht(){const n=Xn(".ct-stage-config");if(!n)return;const t=zn(),e=t.activeStage,r=t.stageConfigs[e],a=n.querySelector(".ct-section__title");a&&(a.innerHTML=`\n            <i class="fa-solid ${h.iu[e]}"></i>\n            ${h.BA[e]} Configuration\n        `);const s=Xn(`#${h.pW}_fields_container`);s&&(s.innerHTML=Gt());const i=Xn(`#${h.pW}_prompt`);if(i){let n=r.customPrompt;if(!n&&r.promptPresetId){const t=J(r.promptPresetId);t&&(n=t.prompt)}i.value=n,Jt(i.value)}qt("prompt",e,r.promptPresetId);const o=Xn(`#${h.pW}_use_schema`);o&&(o.checked=r.useStructuredOutput);const c=Xn(`#${h.pW}_schema_section`);c&&c.classList.toggle("ct-hidden",!r.useStructuredOutput),qt("schema",e,r.schemaPresetId);const l=Xn(`#${h.pW}_schema`);if(l){let n=r.customSchema;if(!n&&r.schemaPresetId){const t=V(r.schemaPresetId);t&&(n=JSON.stringify(t.schema,null,2))}l.value=n}}function Jt(n){return Bt(this,void 0,void 0,function*(){const t=Xn(`#${h.pW}_prompt_tokens`);if(!t)return;const e=yield(0,h.NR)(n);t.textContent=null!==e?`~${e} tokens`:`~${Math.ceil(n.length/4)} tokens`})}function Yt(n){const t=SillyTavern.libs.DOMPurify,e=[],r=Xn(`#${h.pW}_link_fields`,n);r&&e.push(nt(r,"click",()=>{!function(){const n=zn();if(n.stageFields.linked=!n.stageFields.linked,!n.stageFields.linked){const{lodash:t}=SillyTavern.libs;n.stageFields.overrides[n.activeStage]=t.cloneDeep(n.stageFields.base)}Wn()}();const n=Fn();r.classList.toggle("ct-active",n),r.setAttribute("aria-pressed",String(n)),r.title=n?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const t=r.querySelector("i");t&&(t.className="fa-solid "+(n?"fa-link":"fa-link-slash")),Ht()}));const a=Xn(`#${h.pW}_fields_container`,n);a&&(e.push(nt(a,"change",n=>{const t=n.target;if(!t.classList.contains("ct-field-checkbox"))return;const e=t.dataset.field;if(e){if(void 0!==t.dataset.index){const n=parseInt(t.dataset.index,10),r=Mn(),a=Array.isArray(r[e])?[...r[e]]:[];if(t.checked)a.includes(n)||a.push(n);else{const t=a.indexOf(n);-1!==t&&a.splice(t,1)}Bn(e,a.length>0&&a.sort((n,t)=>n-t))}else if(t.classList.contains("ct-field-checkbox--parent")){const n=t.closest(".ct-field-group");if(!n)return;const r=Zn(".ct-field-checkbox--child",n);if(t.checked){Bn(e,r.map((n,t)=>t))}else Bn(e,!1)}else Bn(e,t.checked);!function(){const n=Xn(`#${h.pW}_fields_container`);if(!n)return;const t=Zn(".ct-field-group",n);for(const n of t){if(!n.dataset.field)continue;const t=Xn(".ct-field-checkbox--parent",n),e=Zn(".ct-field-checkbox--child",n);if(!t)continue;const r=e.filter(n=>n.checked).length,a=e.length;0===r?(t.checked=!1,t.indeterminate=!1):r===a?(t.checked=!0,t.indeterminate=!1):(t.checked=!1,t.indeterminate=!0)}}()}})),e.push(nt(a,"click",n=>{const t=n.target.closest(".ct-field-expand");if(!t)return;const e=t.closest(".ct-field-group");e&&e.classList.toggle("ct-field-group--expanded")})),e.push(nt(a,"click",n=>Bt(this,void 0,void 0,function*(){const t=n.target.closest(".ct-field-preview__more");if(!t)return;const e=t.dataset.field;if(!e)return;const r=zn();if(!r.character)return;const a=_n(r.character).find(n=>n.key===e);a&&h.lY.alert(a.label,`<pre class="ct-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(a.value)}</pre>`)}))),e.push(nt(a,"click",n=>Bt(this,void 0,void 0,function*(){const t=n.target.closest(".ct-field-preview-btn");if(!t)return;const e=t.dataset.field,r=t.dataset.index;if(!e||void 0===r)return;const a=zn();if(!a.character)return;const s=_n(a.character).find(n=>n.key===e);if(!s||!Array.isArray(s.rawValue))return;const i=parseInt(r,10),o=s.rawValue[i];o&&h.lY.alert(`Greeting ${i+1}`,`<pre class="ct-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(o)}</pre>`)}))));const s=Xn(`#${h.pW}_prompt`,n);if(s){const n=SillyTavern.libs.lodash.debounce(n=>{Un(zn().activeStage,{customPrompt:n,promptPresetId:null}),Jt(n)},300);e.push(nt(s,"input",()=>{n(s.value)})),Jt(s.value)}const i=Xn(`#${h.pW}_prompt_select`,n);i&&e.push(nt(i,"change",()=>{const n=zn(),t=i.value||null;if(Un(n.activeStage,{promptPresetId:t,customPrompt:""}),t){const n=J(t);n&&s&&(s.value=n.prompt,Jt(n.prompt))}}));const o=Xn(`#${h.pW}_save_prompt`,n);o&&e.push(nt(o,"click",()=>Bt(this,void 0,void 0,function*(){const n=zn(),t=(null==s?void 0:s.value)||"";if(!t.trim())return void h.oR.warning("Enter a prompt first");const e=yield h.lY.input("Save Prompt Preset","Enter a name for this preset:",`${h.BA[n.activeStage]} Custom`);if(!e)return;const r=function(n){return z(n)}({name:e.trim(),stages:[n.activeStage],prompt:t});h.oR.success(`Saved preset "${r.name}"`),Ht()})));const c=Xn(`#${h.pW}_use_schema`,n),l=Xn(`#${h.pW}_schema_section`,n);c&&l&&e.push(nt(c,"change",()=>{Un(zn().activeStage,{useStructuredOutput:c.checked}),l.classList.toggle("ct-hidden",!c.checked)}));const d=Xn(`#${h.pW}_schema`,n);if(d){const n=SillyTavern.libs.lodash.debounce(n=>{Un(zn().activeStage,{customSchema:n,schemaPresetId:null})},300);e.push(nt(d,"input",()=>{n(d.value)}))}const p=Xn(`#${h.pW}_validate_schema`,n);p&&d&&e.push(nt(p,"click",()=>{try{JSON.parse(d.value),h.oR.success("Valid JSON")}catch(n){h.oR.error(`Invalid JSON: ${n.message}`)}}));const u=Xn(`#${h.pW}_format_schema`,n);u&&d&&e.push(nt(u,"click",()=>{try{const n=JSON.parse(d.value);d.value=JSON.stringify(n,null,2),h.oR.success("Formatted")}catch(n){h.oR.error(`Invalid JSON: ${n.message}`)}}));const m=Xn(`#${h.pW}_guidance`,n);if(m){const n=SillyTavern.libs.lodash.debounce(n=>{var t;t=n,zn().userGuidance=t,Wn()},300);e.push(nt(m,"input",()=>{n(m.value)}))}const f=Xn(`#${h.pW}_preview`,n);f&&e.push(nt(f,"click",()=>Bt(this,void 0,void 0,function*(){const n=zn();if(!n.character)return void h.oR.warning("Select a character first");let e=xn(n.character,n.selectedFields);n.userGuidance.trim()&&(e+=`\n\n---\n\n## USER GUIDANCE\n\n${n.userGuidance}`),yield h.lY.alert("Prompt Preview",`<div class="ct-preview-content"><pre>${t.sanitize(e)}</pre></div>`)})));const v=Zn(".ct-preset-edit-btn",n);for(const t of v)e.push(nt(t,"click",()=>{const e=t.dataset.type,r=Xn(`#${`${h.pW}_${e}_select`}`,n),a=null==r?void 0:r.value;a?Nt(e,a,{onSave:()=>{Ht()}}):h.oR.warning("Select a preset first")}));const g=Zn(".ct-preset-new-btn",n);for(const n of g)e.push(nt(n,"click",()=>{const t=n.dataset.type;zt(t,{onSave:n=>{const e=zn();Un(e.activeStage,"prompt"===t?{promptPresetId:n.id,customPrompt:""}:{schemaPresetId:n.id,customSchema:""}),Ht()}})}));const b=Xn(`#${h.pW}_prompt_select`,n),y=Xn(`#${h.pW}_schema_select`,n),_=()=>{const t=Xn('.ct-preset-edit-btn[data-type="prompt"]',n),e=Xn('.ct-preset-edit-btn[data-type="schema"]',n);t&&b&&(t.disabled=!b.value),e&&y&&(e.disabled=!y.value)};return b&&e.push(nt(b,"change",_)),y&&e.push(nt(y,"change",_)),()=>{e.forEach(n=>n())}}function Vt(n){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[n.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function Kt(){const n=zn(),t=[];if(!n.character)return t;const e=_n(n.character),r=n.stageResults.rewrite,a=(null==r?void 0:r.output)?function(n){var t,e;const r={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,s=[];let i;for(;null!==(i=a.exec(n));)s.push({name:i[1].trim().toLowerCase(),start:i.index+i[0].length});for(let a=0;a<s.length;a++){const i=s[a],o=null!==(e=null===(t=s[a+1])||void 0===t?void 0:t.start)&&void 0!==e?e:n.length,c=n.slice(i.start,o).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=Vt(i.name);l&&c&&(r[l]=c)}return r}(r.output):{};for(const n of e){const e=a[n.key]||null;t.push({key:n.key,label:n.label,original:n.value,rewritten:e,hasChanges:null!==e&&e!==n.value})}return t}function Qt(n){const t=SillyTavern.libs.DOMPurify;if(!n.rewritten)return`\n            <div class="ct-compare-row ct-compare-row--unchanged">\n                <div class="ct-compare-row__header">\n                    <span class="ct-compare-row__label">${n.label}</span>\n                    <span class="ct-badge ct-badge--small ct-badge--muted">No changes</span>\n                </div>\n                <div class="ct-compare-row__content ct-compare-row__content--single">\n                    <pre class="ct-compare-text">${t.sanitize(n.original)}</pre>\n                </div>\n            </div>\n        `;const{originalHtml:e,rewrittenHtml:r}=function(n,t){const e=SillyTavern.libs.DOMPurify,r=new(0,SillyTavern.libs.DiffMatchPatch),a=r.diff_main(n,t);r.diff_cleanupSemantic(a);const s=[],i=[];for(const[n,t]of a){const r=e.sanitize(t);switch(n){case-1:s.push(`<span class="ct-diff--removed">${r}</span>`);break;case 1:i.push(`<span class="ct-diff--added">${r}</span>`);break;default:s.push(r),i.push(r)}}return{originalHtml:s.join(""),rewrittenHtml:i.join("")}}(n.original,n.rewritten),a=function(n,t){const e=(new(0,SillyTavern.libs.DiffMatchPatch)).diff_main(n,t);let r=0,a=0,s=0;for(const[n,t]of e){const e=t.length;switch(n){case-1:a+=e;break;case 1:r+=e;break;default:s+=e}}return{additions:r,deletions:a,unchanged:s}}(n.original,n.rewritten),s=a.additions>0||a.deletions>0;return`\n        <div class="ct-compare-row ${n.hasChanges?"ct-compare-row--changed":""}">\n            <div class="ct-compare-row__header">\n                <span class="ct-compare-row__label">${n.label}</span>\n                <div class="ct-compare-row__badges">\n                    ${n.hasChanges?'<span class="ct-badge ct-badge--small ct-badge--accent">Modified</span>':""}\n                    ${s?`<span class="ct-diff-stats"><span class="ct-diff-stats__add">+${a.additions}</span> <span class="ct-diff-stats__del">-${a.deletions}</span></span>`:""}\n                </div>\n            </div>\n            <div class="ct-compare-row__content">\n                <div class="ct-compare-col ct-compare-col--original">\n                    <div class="ct-compare-col__header">\n                        <i class="fa-solid fa-file"></i> Original\n                    </div>\n                    <pre class="ct-compare-text">${e}</pre>\n                </div>\n                <div class="ct-compare-col ct-compare-col--rewritten">\n                    <div class="ct-compare-col__header">\n                        <i class="fa-solid fa-pen-fancy"></i> Rewritten\n                    </div>\n                    <pre class="ct-compare-text">${r}</pre>\n                </div>\n            </div>\n        </div>\n    `}function Xt(){const n=zn();if(!n.character)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-code-compare ct-empty__icon"></i>\n                <div class="ct-empty__title">No character selected</div>\n                <div class="ct-empty__text">Select a character to compare versions</div>\n            </div>\n        ';if(!n.stageResults.rewrite)return'\n            <div class="ct-empty">\n                <i class="fa-solid fa-code-compare ct-empty__icon"></i>\n                <div class="ct-empty__title">No rewrite available</div>\n                <div class="ct-empty__text">Run the Rewrite stage first to see comparisons</div>\n            </div>\n        ';const t=Kt(),e=t.filter(n=>n.hasChanges).length;return`\n        <div class="ct-compare-view">\n            <div class="ct-compare-header">\n                <div class="ct-compare-stats">\n                    <span class="ct-badge ct-badge--accent">${e} field${1!==e?"s":""} modified</span>\n                    <span class="ct-badge ct-badge--muted">${t.length-e} unchanged</span>\n                </div>\n            </div>\n            <div class="ct-compare-list ct-scrollable">\n                ${t.map(Qt).join("")}\n            </div>\n        </div>\n    `}var Zt=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function ne(n){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[n.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function te(){const n=zn(),t=[];if(!n.character||!n.stageResults.rewrite)return t;const e=_n(n.character),r=function(n){var t,e;const r={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,s=[];let i;for(;null!==(i=a.exec(n));)s.push({name:i[1].trim().toLowerCase(),start:i.index+i[0].length});for(let a=0;a<s.length;a++){const i=s[a],o=null!==(e=null===(t=s[a+1])||void 0===t?void 0:t.start)&&void 0!==e?e:n.length,c=n.slice(i.start,o).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=ne(i.name);l&&c&&(r[l]=c)}return r}(n.stageResults.rewrite.output);for(const n of e){const e=r[n.key];e&&e!==n.value&&t.push({key:n.key,label:n.label,original:n.value,rewritten:e,selected:!0})}return t}function ee(n,t,e,r){return Zt(this,void 0,void 0,function*(){const a=SillyTavern.getContext();try{return(yield fetch("/api/characters/edit-attribute",{method:"POST",headers:a.getRequestHeaders(),body:JSON.stringify({avatar_url:n,ch_name:t,field:e,value:r})})).ok}catch(n){return h.Rm.error(`Failed to edit attribute ${e}:`,n),!1}})}function re(n){return Zt(this,void 0,void 0,function*(){const t=SillyTavern.getContext();try{const e=yield fetch("/api/characters/export",{method:"POST",headers:t.getRequestHeaders(),body:JSON.stringify({avatar_url:n,format:"png"})});return e.ok?yield e.blob():null}catch(n){return h.Rm.error("Failed to export character:",n),null}})}function ae(n){return Zt(this,void 0,void 0,function*(){const t=zn();if(!t.character)return!1;const e=t.character,r=yield function(n){return Zt(this,void 0,void 0,function*(){const t=SillyTavern.getContext();try{const e=yield fetch("/api/characters/export",{method:"POST",headers:t.getRequestHeaders(),body:JSON.stringify({avatar_url:n,format:"json"})});return e.ok?yield e.json():null}catch(n){return h.Rm.error("Failed to get character JSON:",n),null}})}(e.avatar);if(!r)return h.oR.error("Failed to get character data"),!1;for(const t of n)t.selected&&(r[t.key]=t.rewritten,r.data&&"object"==typeof r.data&&(r.data[t.key]=t.rewritten));const a=JSON.stringify(r,null,2),s=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(s),o=document.createElement("a");return o.href=i,o.download=`${e.name}_updated.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),h.oR.success("Character JSON downloaded!"),!0})}function se(){return Zt(this,void 0,void 0,function*(){const n=te();if(0===n.length)return void h.oR.warning("No changes detected in the rewrite output.");const t=SillyTavern.libs.DOMPurify,e=`\n        <div class="ct-apply-dialog">\n            <p class="ct-apply-dialog__intro">\n                <strong>${n.length} field${n.length>1?"s":""}</strong> modified. \n                Select which fields to apply:\n            </p>\n            \n            <div class="ct-apply-dialog__fields">\n                ${n.map((n,e)=>`\n                    <div class="ct-apply-field">\n                        <label class="ct-apply-field__header">\n                            <input type="checkbox" \n                                   class="ct-apply-checkbox"\n                                   data-field-index="${e}" \n                                   ${n.selected?"checked":""}>\n                            <span class="ct-apply-field__label">${n.label}</span>\n                        </label>\n                        <div class="ct-apply-field__preview">\n                            <pre>${t.sanitize(n.rewritten.substring(0,300))}${n.rewritten.length>300?"...":""}</pre>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            \n            <div class="ct-apply-dialog__actions">\n                <button class="menu_button menu_button--sm ct-select-all-btn" type="button">\n                    Select All\n                </button>\n                <button class="menu_button menu_button--sm ct-select-none-btn" type="button">\n                    Select None\n                </button>\n            </div>\n            \n            <hr style="margin: 12px 0; border-color: var(--SmartThemeBorderColor);">\n            \n            <p class="ct-text-sm ct-text-dim">\n                <strong>Apply Directly</strong> - Updates the character card in SillyTavern immediately.<br>\n                <strong>Download PNG</strong> - Downloads the original card image with updated metadata.<br>\n                <strong>Download JSON</strong> - Downloads a JSON file you can import elsewhere.\n            </p>\n        </div>\n    `,r=SillyTavern.getContext();setTimeout(()=>{const n=document.querySelector(".ct-select-all-btn"),t=document.querySelector(".ct-select-none-btn");n&&n.addEventListener("click",()=>{document.querySelectorAll(".ct-apply-checkbox").forEach(n=>n.checked=!0)}),t&&t.addEventListener("click",()=>{document.querySelectorAll(".ct-apply-checkbox").forEach(n=>n.checked=!1)})},0);const a=yield r.callGenericPopup(e,r.POPUP_TYPE.CONFIRM,"",{okButton:"Apply Directly",cancelButton:"Cancel",customButtons:["Download PNG","Download JSON"],wide:!0});if(!1===a||void 0===a)return;const s=n.filter((n,t)=>{var e;const r=document.querySelector(`.ct-apply-checkbox[data-field-index="${t}"]`);return null!==(e=null==r?void 0:r.checked)&&void 0!==e&&e});0!==s.length?!0===a?yield function(n){return Zt(this,void 0,void 0,function*(){const t=zn();if(!t.character)return!1;const e=t.character;let r=0;for(const t of n)t.selected&&((yield ee(e.avatar,e.name,t.key,t.rewritten))?r++:h.oR.error(`Failed to update ${t.label}`));if(r>0){const n=SillyTavern.getContext();yield n.getCharacters(),h.oR.success(`Applied ${r} update${r>1?"s":""} to character!`)}return r===n.filter(n=>n.selected).length})}(s):0===a?yield function(n){return Zt(this,void 0,void 0,function*(){const t=zn();if(!t.character)return!1;const e=t.character;let r=0;const a={};for(const t of n)t.selected&&(a[t.key]=t.original,(yield ee(e.avatar,e.name,t.key,t.rewritten))&&r++);if(0===r)return h.oR.error("Failed to apply updates for PNG export"),!1;const s=yield re(e.avatar);if(!s){h.oR.error("Failed to export character PNG");for(const[n,t]of Object.entries(a))yield ee(e.avatar,e.name,n,t);return!1}const i=URL.createObjectURL(s),o=document.createElement("a");o.href=i,o.download=`${e.name}_updated.png`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),h.oR.success("Character PNG downloaded! (Changes applied to card)");const c=SillyTavern.getContext();return yield c.getCharacters(),!0})}(s):1===a&&(yield ae(s)):h.oR.warning("No fields selected.")})}const ie=document.createElement("style");function oe(n){const{DOMPurify:t}=SillyTavern.libs,e="string"==typeof n?n:String(null!=n?n:""),r=le(e);if(r&&"object"==typeof r)return ce(e,null);const a=fe(de(e));return t.sanitize(a)}function ce(n,t){var e;const{DOMPurify:r}=SillyTavern.libs,a="string"==typeof n?n:String(null!=n?n:""),s=le(a);if(!s||"object"!=typeof s){const n=de(a);return r.sanitize(fe(n))}const i=function(n,t){const e=function(n){const t=["overallscore","totalscore","overall","total","score","rating"];for(const e of t)for(const t of Object.keys(n))if(t.toLowerCase().replace(/_/g,"")===e&&"number"==typeof n[t])return t;return null}(n),r=e?n[e]:null,a=[];if(e&&"number"==typeof r){const n=r>10?100:10;a.push(ge({type:"hero",title:Te(e),score:{value:r,max:n}}))}const s=t.properties||{},i=Object.keys(s).length>0?Object.keys(s):Object.keys(n);for(const t of i){if(t===e)continue;const r=n[t];if(void 0===r)continue;const i=s[t]||{type:Se(r)};a.push(_e(t,r,i,0))}return`<div class="ct-formatted">${a.join("")}</div>`}(s,null!==(e=null==t?void 0:t.value)&&void 0!==e?e:ye(s));return r.sanitize(i)}function le(n){try{return JSON.parse(n)}catch(t){const e=n.match(/```(?:json)?\s*([\s\S]*?)```/);if(e)try{return JSON.parse(e[1].trim())}catch(n){return null}return null}}function de(n){const t=n.split("\n"),e=[];let r=null,a=[],s=!1,i="",o=[];const c=()=>{if(0===a.length)return;const n=a.join("\n").trim();if(!n)return void(a=[]);const t=function(n){const t=n.split("\n"),e=[];let r="";for(const n of t){const t=n.match(/^[\s]*[-*•]\s+(.+)$/),a=n.match(/^[\s]*\d+[.)]\s+(.+)$/);if(t||a)r&&e.push(r.trim()),r=(t||a)[1];else if(r&&n.match(/^\s+/))r+=" "+n.trim();else if(""===n.trim())r&&e.push(r.trim()),r="";else{if(0===e.length)return[];r&&e.push(r.trim()),r=""}}r&&e.push(r.trim());return e}(n);if(t.length>0){const n={type:"list",items:t};r?(r.children=r.children||[],r.children.push(n)):e.push(n)}else{const t=n.split(/\n\n+/);for(const n of t){if(!n.trim())continue;const t={type:"paragraph",content:n.trim()};r?(r.children=r.children||[],r.children.push(t)):e.push(t)}}a=[]},l=()=>{if(0===o.length)return;const n={type:"code",content:o.join("\n"),language:i};r?(r.children=r.children||[],r.children.push(n)):e.push(n),o=[],i=""};for(const n of t){if(/^[-*_]{3,}\s*$/.test(n.trim()))continue;const t=n.match(/^```(\w*)/);if(t){s?(l(),s=!1):(c(),s=!0,i=t[1]||"");continue}if(s){o.push(n);continue}const d=n.match(/^(#{1,3})\s+(.+)$/);if(d){c(),r&&(r.children&&r.children.length>0||r.score)&&e.push(r);const n=d[1].length,t=d[2].trim(),a=me(t);if(a&&1===n)e.push({type:"hero",title:a.label,score:{value:a.value,max:a.max}}),r=null;else{r={type:"section",title:t,children:[]};const n=pe(t);n&&(r.score={value:n.value,max:n.max},r.title=t.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim())}continue}const p=ue(n);p&&r?r.score={value:p.value,max:p.max}:a.push(n)}if(c(),s&&l(),r&&(r.children&&r.children.length>0||r.score)&&e.push(r),e.length>0&&"section"===e[0].type){const n=e[0];n.score&&function(n){const t=n.toLowerCase().replace(/[_-]/g,"");return["overall","total","final","summary","verdict","rating","soulcheck"].some(n=>t.includes(n))}(n.title||"")&&(e[0]={type:"hero",title:n.title,score:n.score},n.children&&n.children.length>0&&e.splice(1,0,...n.children.map(n=>n)))}return e}function pe(n){const t=n.match(/(\d+(?:\.\d+)?)\s*\/\s*(\d+)/);if(t){const n=parseFloat(t[1]),e=parseInt(t[2],10);if(!isNaN(n)&&!isNaN(e)&&e>0)return{value:n,max:e}}return null}function ue(n){const t=n.trim().match(/^(?:score\s*:?\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)$/i);if(t){const n=parseFloat(t[1]),e=parseInt(t[2],10);if(!isNaN(n)&&!isNaN(e)&&e>0)return{value:n,max:e}}return null}function me(n){const t=pe(n);if(t){const e=n.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim();return Object.assign(Object.assign({},t),{label:e})}return null}function fe(n){if(0===n.length)return'<div class="ct-formatted ct-formatted--empty">No content</div>';return`<div class="ct-formatted">${n.map(ve).join("")}</div>`}function ve(n){switch(n.type){case"hero":return ge(n);case"section":return function(n){const t=n.title||"",e=null!=n.score,r=n.children||[];let a="";if(e&&n.score){a=`\n            <span class="ct-section__score" style="--score-color: ${Ce(100===n.score.max?n.score.value/10:n.score.value)}">\n                ${Number.isInteger(n.score.value)?n.score.value:n.score.value.toFixed(1)}<span class="ct-section__score-max">/${n.score.max}</span>\n            </span>\n        `}const s=r.map(ve).join("");return`\n        <div class="ct-section">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">${ke(t)}</h3>\n                ${a}\n            </div>\n            <div class="ct-section__body">\n                ${s}\n            </div>\n        </div>\n    `}(n);case"paragraph":return function(n){const t=n.content||"";return`<p class="ct-para">${he(t)}</p>`}(n);case"list":return function(n){const t=n.items||[];if(0===t.length)return"";return`<ul class="ct-list">${t.map(n=>`<li>${he(n)}</li>`).join("")}</ul>`}(n);case"code":return function(n){const{hljs:t}=SillyTavern.libs,e=n.content||"",r=n.language||"";let a;try{a=r&&t.getLanguage(r)?t.highlight(e,{language:r}).value:t.highlightAuto(e).value}catch(n){a=ke(e)}return`\n        <div class="ct-code">\n            ${r?`<div class="ct-code__lang">${ke(r)}</div>`:""}\n            <pre class="ct-code__pre"><code class="hljs">${a}</code></pre>\n        </div>\n    `}(n);default:return""}}function ge(n){const t=n.score;if(!t)return"";const e=Ce(100===t.max?t.value/10:t.value),r=Number.isInteger(t.value)?t.value:t.value.toFixed(1);return`\n        <div class="ct-hero">\n            <div class="ct-hero__label">${ke(n.title||"Score")}</div>\n            <div class="ct-hero__score">\n                <span class="ct-hero__value" style="--score-color: ${e}">${r}</span>\n                <span class="ct-hero__max">/${t.max}</span>\n            </div>\n            <div class="ct-hero__bar">\n                <div class="ct-hero__fill" style="width: ${t.value/t.max*100}%; background: ${e}"></div>\n            </div>\n        </div>\n    `}function he(n){let t=ke(n);return t=t.replace(/(?:(\w+)\s*:\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)/gi,(n,t,e,r)=>{const a=parseFloat(e),s=parseInt(r,10);return`${t?`<span class="ct-inline-score__label">${t}:</span> `:""}<span class="ct-inline-score" style="--score-color: ${Ce(100===s?a/10:a)}">${Number.isInteger(a)?a:a.toFixed(1)}<span class="ct-inline-score__max">/${s}</span></span>`}),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.+?)__/g,"<strong>$1</strong>"),t=t.replace(/(?<![*_])\*(?![*\s])(.+?)(?<![*\s])\*(?![*_])/g,"<em>$1</em>"),t=t.replace(/(?<![*_])_(?![_\s])(.+?)(?<![_\s])_(?![*_])/g,"<em>$1</em>"),t=t.replace(/`([^`]+)`/g,'<code class="ct-inline-code">$1</code>'),t}ie.textContent="\n.ct-apply-dialog {\n    max-height: 60vh;\n    overflow-y: auto;\n}\n\n.ct-apply-dialog__intro {\n    margin-bottom: 12px;\n}\n\n.ct-apply-dialog__fields {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    margin-bottom: 12px;\n}\n\n.ct-apply-field {\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 4px;\n    overflow: hidden;\n}\n\n.ct-apply-field__header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    cursor: pointer;\n}\n\n.ct-apply-field__header input {\n    margin: 0;\n}\n\n.ct-apply-field__label {\n    font-weight: 600;\n}\n\n.ct-apply-field__preview {\n    padding: 8px;\n    background: var(--SmartThemeBodyColor);\n}\n\n.ct-apply-field__preview pre {\n    margin: 0;\n    white-space: pre-wrap;\n    word-break: break-word;\n    font-size: 0.85em;\n    max-height: 100px;\n    overflow-y: auto;\n}\n\n.ct-apply-dialog__actions {\n    display: flex;\n    gap: 8px;\n}\n",document.head.appendChild(ie);const be=8;function ye(n){if(null===n)return{type:"null"};if(Array.isArray(n))return{type:"array",items:n.length>0?ye(n[0]):{type:"string"}};if("object"==typeof n){const t={};for(const[e,r]of Object.entries(n))t[e]=ye(r);return{type:"object",properties:t}}return{type:typeof n}}function _e(n,t,e,r){if(r>be)return function(n){const{hljs:t}=SillyTavern.libs,e=JSON.stringify(n,null,2);return`<pre class="ct-code__pre"><code class="hljs">${t.highlight(e,{language:"json"}).value}</code></pre>`}(t);const a=Te(n),s=e.type||Se(t);if("array"===s&&Array.isArray(t))return function(n,t,e,r){if(0===t.length)return`\n            <div class="ct-field">\n                <div class="ct-field__label">${ke(n)}</div>\n                <div class="ct-field__value ct-field--empty">(none)</div>\n            </div>\n        `;const a=e.items||{type:Se(t[0])};if(t.every(Pe)){const e=t.map(n=>`<li>${function(n){if("boolean"==typeof n)return $e(n);if("number"==typeof n)return`<span class="ct-num">${n.toLocaleString()}</span>`;return he(String(n))}(n)}</li>`).join("");return`\n            <div class="ct-field">\n                <div class="ct-field__label">${ke(n)}</div>\n                <ul class="ct-list">${e}</ul>\n            </div>\n        `}const s=t.map((n,t)=>"object"==typeof n&&null!==n?function(n,t,e){const r=t.properties||{},a=Object.keys(r).length>0?Object.keys(r):Object.keys(n),s=a.find(t=>"string"==typeof n[t]&&n[t].length<100),i=a.find(t=>"number"==typeof n[t]&&n[t]>=0&&n[t]<=100),o=a.find(t=>"string"==typeof n[t]&&n[t].length>=50&&t!==s);let c="";if(s||i){c=`<div class="ct-card__header">${s?`<span class="ct-card__title">${ke(String(n[s]))}</span>`:""}${i?we(n[i]):""}</div>`}let l="";o&&(l=`<div class="ct-card__body">${he(String(n[o]))}</div>`);const d=a.filter(n=>n!==s&&n!==i&&n!==o).map(t=>{const a=n[t];if(void 0===a)return"";return _e(t,a,r[t]||{type:Se(a)},e+1)}).filter(Boolean).join("");return`<div class="ct-card">${c}${l}${d?`<div class="ct-card__extra">${d}</div>`:""}</div>`}(n,a,r+1):`<div class="ct-card">${xe(n,a)}</div>`).join("");return`\n        <div class="ct-field">\n            <div class="ct-field__label">${ke(n)}</div>\n            <div class="ct-cards">${s}</div>\n        </div>\n    `}(a,t,e,r);if("object"===s&&"object"==typeof t&&null!==t)return function(n,t,e,r){const a=e.properties||{},s=(Object.keys(a).length>0?Object.keys(a):Object.keys(t)).map(n=>{const e=t[n];if(void 0===e)return"";return _e(n,e,a[n]||{type:Se(e)},r+1)}).filter(Boolean).join("");return`\n        <div class="ct-section">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">${ke(n)}</h3>\n            </div>\n            <div class="ct-section__body ct-section__body--nested">\n                ${s}\n            </div>\n        </div>\n    `}(a,t,e,r);const i=xe(t,e,n);return`\n        <div class="ct-field">\n            <div class="ct-field__label">${ke(a)}</div>\n            <div class="ct-field__value">${i}</div>\n        </div>\n    `}function xe(n,t,e){if(null==n)return'<span class="ct-null">—</span>';switch(t.type||Se(n)){case"string":return function(n,t){if(!n.trim())return'<span class="ct-empty">(empty)</span>';const e=t.format;if("uri"===e||"url"===e||(r=n,/^https?:\/\//i.test(r))){const t=n.length>50?n.substring(0,47)+"...":n;return`<a href="${ke(n)}" target="_blank" rel="noopener" class="ct-link">${ke(t)}</a>`}var r;if("email"===e||function(n){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)}(n))return`<a href="mailto:${ke(n)}" class="ct-link">${ke(n)}</a>`;if(n.length>100||n.includes("\n"))return`<div class="ct-text">${he(n)}</div>`;return`<span>${he(n)}</span>`}(n,t);case"number":case"integer":return function(n,t,e){const r=String(t.title||t.description||e||"").toLowerCase();if(function(n,t){return!!["score","rating","rank","grade","level","confidence","quality"].some(t=>n.includes(t))||(!!(t>=0&&t<=10&&Number.isFinite(t))||!!(t>=0&&t<=100&&Number.isInteger(t)))}(r,n))return we(n);return`<span class="ct-num">${n.toLocaleString(void 0,{maximumFractionDigits:2})}</span>`}(n,t,e);case"boolean":return $e(n);default:return`<span>${ke(String(n))}</span>`}}function we(n){const t=n>10?100:10;return`<span class="ct-score" style="--score-color: ${Ce(n>10?n/10:n)}">${Number.isInteger(n)?n:n.toFixed(1)}<span class="ct-score__max">/${t}</span></span>`}function $e(n){return`<span class="${n?"ct-bool--yes":"ct-bool--no"}"><i class="fa-solid ${n?"fa-check-circle":"fa-times-circle"}"></i> ${n?"Yes":"No"}</span>`}function ke(n){const{DOMPurify:t}=SillyTavern.libs,e="string"==typeof n?n:String(null!=n?n:"");return t.sanitize(e,{ALLOWED_TAGS:[]})}function Se(n){return null===n?"null":Array.isArray(n)?"array":typeof n}function Pe(n){return"string"==typeof n||"number"==typeof n||"boolean"==typeof n||null===n}function Te(n){return n.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,n=>n.toUpperCase())}function Ce(n){return n>=8?"var(--ct-score-high, #10b981)":n>=6?"var(--ct-score-good, #22c55e)":n>=4?"var(--ct-score-mid, #eab308)":n>=2?"var(--ct-score-low, #f97316)":"var(--ct-score-bad, #ef4444)"}var Re=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};let Ee="result",Oe="smart",Ae="formatted";function ze(n,t){var e;const r=SillyTavern.libs.DOMPurify,a=SillyTavern.libs.hljs;if(!n)return`\n            <div class="ct-empty">\n                <i class="fa-solid ${h.iu[t]} ct-empty__icon"></i>\n                <div class="ct-empty__title">No results yet</div>\n                <div class="ct-empty__text">Run ${h.BA[t]} to see results</div>\n            </div>\n        `;if(n.error)return`\n            <div class="ct-alert ct-alert--danger">\n                <i class="fa-solid fa-exclamation-triangle ct-alert__icon"></i>\n                <div class="ct-alert__content">\n                    <div class="ct-alert__title">Error</div>\n                    <div class="ct-alert__message">${r.sanitize(n.error)}</div>\n                </div>\n            </div>\n        `;const s=le(n.output);if(null!==s&&"object"==typeof s){const i=JSON.stringify(s,null,2),o=zn().stageConfigs[t];let c,l=null;if(null==o?void 0:o.schemaPresetId){const n=V(o.schemaPresetId);l=null!==(e=null==n?void 0:n.schema)&&void 0!==e?e:null}if("smart"===Oe)c=ce(n.output,l);else{let n;try{n=a.highlight(i,{language:"json"}).value}catch(t){n=r.sanitize(i)}c=`<pre class="ct-result__code hljs"><code>${n}</code></pre>`}return`\n            <div class="ct-result">\n                <div class="ct-result__header">\n                    <span class="ct-result__type">\n                        <i class="fa-solid fa-brackets-curly"></i>\n                        Structured Output\n                    </span>\n                    <div class="ct-result__actions">\n                        <div class="ct-json-toggle">\n                            <button class="ct-json-toggle__btn ${"smart"===Oe?"ct-json-toggle__btn--active":""}"\n                                    data-mode="smart"\n                                    type="button"\n                                    title="Smart formatted view">\n                                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            </button>\n                            <button class="ct-json-toggle__btn ${"raw"===Oe?"ct-json-toggle__btn--active":""}"\n                                    data-mode="raw"\n                                    type="button"\n                                    title="Raw JSON view">\n                                <i class="fa-solid fa-code"></i>\n                            </button>\n                        </div>\n                        <button class="ct-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                data-content="${encodeURIComponent(i)}"\n                                type="button"\n                                title="Copy to clipboard">\n                            <i class="fa-solid fa-copy"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="ct-result__content">\n                    ${c}\n                </div>\n            </div>\n        `}let i;return i="formatted"===Ae?oe(n.output):`<pre class="ct-result__raw">${r.sanitize(n.output)}</pre>`,`\n        <div class="ct-result">\n            <div class="ct-result__header">\n                <span class="ct-result__type">\n                    <i class="fa-solid fa-file-lines"></i>\n                    Analysis\n                </span>\n                <div class="ct-result__actions">\n                    <div class="ct-text-toggle">\n                        <button class="ct-text-toggle__btn ${"formatted"===Ae?"ct-text-toggle__btn--active":""}"\n                                data-mode="formatted"\n                                type="button"\n                                title="Formatted view">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        </button>\n                        <button class="ct-text-toggle__btn ${"raw"===Ae?"ct-text-toggle__btn--active":""}"\n                                data-mode="raw"\n                                type="button"\n                                title="Raw text (easy to copy)">\n                            <i class="fa-solid fa-code"></i>\n                        </button>\n                    </div>\n                    <button class="ct-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            data-content="${encodeURIComponent(n.output)}"\n                            type="button"\n                            title="Copy to clipboard">\n                        <i class="fa-solid fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="ct-result__content">\n                ${i}\n            </div>\n        </div>\n    `}function Ne(n,t){const e=SillyTavern.libs.DOMPurify,r=(0,SillyTavern.libs.moment)(n.timestamp),a=r.fromNow(),s=r.format("MMM D, h:mm A"),i=et(n.output||n.error||"",100);return`\n        <div class="ct-list-item ${rt(n.error&&"ct-list-item--error")}"\n             data-index="${t}">\n            <div class="ct-list-item__content">\n                <div class="ct-row ct-row--between">\n                    <span class="ct-list-item__title">\n                        <i class="fa-solid ${h.iu[n.stage]} ct-text-accent"></i>\n                        ${h.BA[n.stage]}\n                    </span>\n                    <span class="ct-text-xs ct-text-dim" title="${s}">${a}</span>\n                </div>\n                <div class="ct-list-item__subtitle ct-truncate">${e.sanitize(i)}</div>\n            </div>\n        </div>\n    `}function Ie(){const n=zn(),t=!!n.stageResults.rewrite,e=t&&te().length>0,r=n.iterationHistory.length>0,a=Xn(".ct-results-wrapper");if(!a)return;let s=a.querySelector(".ct-results-toolbar");if(t){const n=`\n            <div class="ct-view-toggle">\n                <button class="ct-view-toggle__btn ${"result"===Ee?"ct-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="ct-view-toggle__btn ${"compare"===Ee?"ct-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${e?'\n                <button class="menu_button menu_button--primary menu_button--sm ct-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `;if(!s){s=document.createElement("div"),s.className="ct-results-toolbar";const n=Xn(`#${h.pW}_results_content`);n&&a.insertBefore(s,n)}s.innerHTML=n}else s&&s.remove();const i=Xn(`#${h.pW}_results_content`);if(!i)return;if("compare"===Ee&&t)i.innerHTML=`<div id="${h.pW}_compare_content">${Xt()}</div>`;else{const t=n.stageResults[n.activeStage];i.innerHTML=ze(t,n.activeStage)}let o=a.querySelector(".ct-history");if(r){o||(o=document.createElement("div"),o.className="ct-history "+(n.historyExpanded?"":"ct-history--collapsed"),o.innerHTML=`\n                <button class="ct-history__toggle"\n                        type="button"\n                        aria-expanded="${n.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${n.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down ct-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="ct-history__list ct-list">\n                </div>\n            `,a.appendChild(o));const t=Xn(`#${h.pW}_history_list`);if(t){at(t,n.iterationHistory.map((n,t)=>Ne(n,t)).join(""))}const e=o.querySelector(".ct-history__toggle span");e&&(e.textContent=`Run History (${n.iterationHistory.length})`)}else o&&o.remove()}function We(n){const t=[];t.push(nt(n,"click",n=>{const e=n.target.closest(".ct-view-toggle__btn");if(!e)return;const r=e.dataset.view;if(r&&r!==Ee&&(Ee=r,Ie(),"compare"===r)){const n=Xn(`#${h.pW}_compare_content`);n&&t.push(function(n){const t=[],e=Xn(".ct-compare-list",n);return e&&t.push(nt(e,"click",n=>{const t=n.target.closest(".ct-compare-row");if(!t)return;const e=t.querySelector(".ct-compare-row__label"),r=(null==e?void 0:e.textContent)||"Field",a=t.querySelector(".ct-compare-col--original pre"),s=t.querySelector(".ct-compare-col--rewritten pre");a&&s&&h.lY.alert(`Compare: ${r}`,`\n                        <div class="ct-compare-popup">\n                            <div class="ct-compare-popup__side">\n                                <h4>Original</h4>\n                                <pre>${a.innerHTML}</pre>\n                            </div>\n                            <div class="ct-compare-popup__side">\n                                <h4>Rewritten</h4>\n                                <pre>${s.innerHTML}</pre>\n                            </div>\n                        </div>\n                        `)})),()=>{t.forEach(n=>n())}}(n))}})),t.push(nt(n,"click",n=>{const t=n.target.closest(".ct-json-toggle__btn");if(!t)return;const e=t.dataset.mode;e&&e!==Oe&&(Oe=e,Ie())})),t.push(nt(n,"click",n=>{const t=n.target.closest(".ct-text-toggle__btn");if(!t)return;const e=t.dataset.mode;e&&e!==Ae&&(Ae=e,Ie())})),t.push(nt(n,"click",n=>{n.target.closest(".ct-apply-btn")&&se()}));const e=Xn(`#${h.pW}_results_content`,n);e&&t.push(nt(e,"click",n=>Re(this,void 0,void 0,function*(){const t=n.target.closest(".ct-result-copy");if(!t)return;const e=decodeURIComponent(t.dataset.content||""),r=yield function(n){return Re(this,void 0,void 0,function*(){if(navigator.clipboard&&window.isSecureContext)try{return yield navigator.clipboard.writeText(n),!0}catch(n){}try{const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",t.setAttribute("readonly",""),document.body.appendChild(t),t.select(),t.setSelectionRange(0,n.length);const e=document.execCommand("copy");return document.body.removeChild(t),e}catch(n){return!1}})}(e),a=t.querySelector("i");r?a&&(a.className="fa-solid fa-check",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)):(a&&(a.className="fa-solid fa-xmark",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)),console.error("Failed to copy to clipboard"))})));const r=Xn(".ct-history__toggle",n),a=Xn(".ct-history",n);r&&a&&t.push(nt(r,"click",()=>{!function(){const n=zn();n.historyExpanded=!n.historyExpanded}(),a.classList.toggle("ct-history--collapsed"),r.setAttribute("aria-expanded",String(zn().historyExpanded))}));const s=Xn(`#${h.pW}_history_list`,n);return s&&t.push(nt(s,"click",n=>Re(this,void 0,void 0,function*(){const t=SillyTavern.libs.DOMPurify,e=n.target.closest(".ct-list-item");if(!e)return;const r=parseInt(e.dataset.index||"0",10),a=zn().iterationHistory[r];if(!a)return;const s=new Date(a.timestamp),i=a.error?`<div class="ct-error-box">${t.sanitize(a.error)}</div>`:`<div class="ct-preview-content">${oe(a.output)}</div>`;h.lY.alert(`${h.BA[a.stage]} - ${s.toLocaleString()}`,i)}))),()=>{t.forEach(n=>n())}}var je=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};const De={pending:"",running:"fa-spinner fa-spin",complete:"fa-check",error:"fa-exclamation"},Le={pending:"",running:"ct-stage-tab--running",complete:"ct-stage-tab--complete",error:"ct-stage-tab--error"};function Me(n){const t=zn(),e=t.activeStage===n,r=t.selectedStages.includes(n),a=t.stageStatus[n],s=De[a],i=s?`<span class="ct-stage-tab__status"><i class="fa-solid ${s}"></i></span>`:"",o=`\n        <input type="checkbox" \n               class="ct-stage-tab__checkbox"\n               data-stage-checkbox="${n}"\n               ${r?"checked":""}\n               title="Include in 'Run Selected'"\n               onclick="event.stopPropagation()">\n    `;return`\n        <button class="ct-stage-tab ${rt(e&&"ct-stage-tab--active")} ${Le[a]}"\n                data-stage="${n}"\n                role="tab"\n                aria-selected="${e}"\n                type="button">\n            ${o}\n            <i class="fa-solid ${h.iu[n]} ct-stage-tab__icon"></i>\n            <span class="ct-stage-tab__label">${h.BA[n]}</span>\n            ${i}\n        </button>\n    `}function Fe(){const n=zn(),t=n.character&&!n.isGenerating,e=t&&n.stageResults.analyze&&!n.stageResults.analyze.error,r=n.selectedStages.length>0,a=n.selectedStages.length;if(n.isGenerating)return`\n            <div class="ct-pipeline-controls ct-pipeline-controls--generating">\n                <div class="ct-pipeline-status">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Generating...</span>\n                </div>\n                <button id="${h.pW}_abort"\n                        class="menu_button menu_button--danger menu_button--sm"\n                        type="button">\n                    <i class="fa-solid fa-stop"></i>\n                    Stop\n                </button>\n            </div>\n        `;const s=n.iterationCount>0?`<span class="ct-badge ct-badge--small ct-badge--muted" title="Refinement iteration">\n                   <i class="fa-solid fa-rotate"></i> ${n.iterationCount}\n               </span>`:"",i=a<h.an.length?`<span class="ct-badge ct-badge--small" title="Stages selected for Run Selected">${a}/${h.an.length}</span>`:"";return`\n        <div class="ct-pipeline-controls">\n            <button id="${h.pW}_run_stage"\n                    class="menu_button menu_button--primary"\n                    type="button"\n                    ${t?"":"disabled"}>\n                <i class="fa-solid fa-play"></i>\n                Run ${h.BA[n.activeStage]}\n            </button>\n            <button id="${h.pW}_run_selected"\n                    class="menu_button"\n                    type="button"\n                    ${t&&r?"":"disabled"}\n                    title="Run checked stages in sequence">\n                <i class="fa-solid fa-list-check"></i>\n                Run Selected\n                ${i}\n            </button>\n            <button id="${h.pW}_run_all"\n                    class="menu_button menu_button--ghost"\n                    type="button"\n                    ${t?"":"disabled"}\n                    title="Run all stages in sequence">\n                <i class="fa-solid fa-forward"></i>\n                All\n            </button>\n            <button id="${h.pW}_refine"\n                    class="menu_button ${e?"":"menu_button--disabled"}"\n                    type="button"\n                    ${e?"":"disabled"}\n                    title="Re-run rewrite using analyze feedback to refine the output">\n                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                Refine\n            </button>\n            <button id="${h.pW}_iterate"\n                    class="menu_button menu_button--primary ${e?"":"menu_button--disabled"}"\n                    type="button"\n                    ${e?"":"disabled"}\n                    title="Quick iterate: Refine then Analyze in one click">\n                <i class="fa-solid fa-arrows-rotate"></i>\n                Iterate\n            </button>\n            ${s}\n            <button id="${h.pW}_reset"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Reset pipeline">\n                <i class="fa-solid fa-rotate-left"></i>\n            </button>\n        </div>\n    `}function Be(){const n=Xn(".ct-stage-tabs");n&&(n.innerHTML=h.an.map(Me).join(""))}function Ge(){const n=Xn(`#${h.pW}_pipeline_controls`);n&&(n.innerHTML=Fe(),Ke(n))}const Ue={score:{required:[],recommended:[]},rewrite:{required:[],recommended:["score"]},analyze:{required:["rewrite"],recommended:["score"]}};function qe(n){return je(this,void 0,void 0,function*(){const t=zn();Be(),Ge(),yield function(n,t){return qn(this,void 0,void 0,function*(){var e,r,a,s;const{stage:i,callbacks:o}=t;if(!n.character)return h.Rm.warn("Cannot execute stage: no character selected"),null;if(n.isGenerating)return h.Rm.warn("Cannot execute stage: generation already in progress"),null;const c=Kn(n,i);if(!c)return null;const l=new AbortController;Yn(n,!0,l),Jn(n,i,"running"),null===(e=null==o?void 0:o.onStageStart)||void 0===e||e.call(o,i);try{const t=yield kn(c,Hn,{signal:l.signal,onProgress:n=>{var t;h.Rm.debug(`[Pipeline] ${n}`),null===(t=null==o?void 0:o.onProgress)||void 0===t||t.call(o,n)}});return Vn(n,t),null===(r=null==o?void 0:o.onStageComplete)||void 0===r||r.call(o,i,t),t.error&&(null===(a=null==o?void 0:o.onError)||void 0===a||a.call(o,i,t.error)),t}catch(t){const e=t instanceof Error?t.message:"Unknown error";return h.Rm.error(`Stage ${i} failed:`,t),Jn(n,i,"error"),null===(s=null==o?void 0:o.onError)||void 0===s||s.call(o,i,e),null}finally{Yn(n,!1)}})}(t,{stage:n,callbacks:{onStageStart:()=>{Be(),Ge()},onStageComplete:()=>{Ie(),Be(),Ge()},onError:()=>{Be(),Ge()}}})})}function He(){return je(this,void 0,void 0,function*(){const n=zn(),t=n.selectedStages;if(0===t.length)return void h.oR.warning("No stages selected. Check the boxes next to stage names.");const e=function(n,t){const e=[];for(const r of n){const a=Ue[r];for(const s of a.required)n.includes(s)||t[s]||e.push({stage:r,missing:h.BA[s],severity:"required"});for(const s of a.recommended)n.includes(s)||t[s]||e.push({stage:r,missing:h.BA[s],severity:"recommended"})}return e}(t,n.stageResults);if(e.length>0){const n=e.filter(n=>"required"===n.severity),t=e.filter(n=>"recommended"===n.severity);if(n.length>0){const t=n.map(n=>`${h.BA[n.stage]} requires ${n.missing}`).join(", ");return void h.oR.error(`Missing required stages: ${t}`)}if(t.length>0){const n=t.map(n=>`${h.BA[n.stage]} works better with ${n.missing}`).join("; ");h.oR.warning(`Note: ${n}. Running anyway...`)}}Be(),Ge(),yield Qn(n,{stages:t,callbacks:{onStageStart:()=>{Be()},onStageComplete:()=>{Ie(),Be()},onProgress:()=>{Ge()},onError:()=>{Be(),Ge()}}}),Be(),Ge()})}function Je(){return je(this,void 0,void 0,function*(){const n=zn();Be(),Ge(),yield function(n){return qn(this,arguments,void 0,function*(n,t={}){var e,r,a,s;const{callbacks:i}=t;if(!n.character)return h.Rm.warn("Cannot execute refinement: no character selected"),null;if(n.isGenerating)return h.Rm.warn("Cannot execute refinement: generation already in progress"),null;if(!n.stageResults.analyze)return h.Rm.warn("Cannot execute refinement: no analyze result available"),null;const o=Kn(n,"rewrite");if(!o)return null;o.isRefinement=!0;const c=new AbortController;Yn(n,!0,c),Jn(n,"rewrite","running"),n.iterationCount++,null===(e=null==i?void 0:i.onStageStart)||void 0===e||e.call(i,"rewrite");try{const t=yield kn(o,Hn,{signal:c.signal,onProgress:n=>{var t;h.Rm.debug(`[Pipeline] ${n}`),null===(t=null==i?void 0:i.onProgress)||void 0===t||t.call(i,n)}});return Vn(n,t),null===(r=null==i?void 0:i.onStageComplete)||void 0===r||r.call(i,"rewrite",t),t.error&&(null===(a=null==i?void 0:i.onError)||void 0===a||a.call(i,"rewrite",t.error)),t}catch(t){const e=t instanceof Error?t.message:"Unknown error";return h.Rm.error("Refinement failed:",t),Jn(n,"rewrite","error"),null===(s=null==i?void 0:i.onError)||void 0===s||s.call(i,"rewrite",e),null}finally{Yn(n,!1)}})}(n,{callbacks:{onStageStart:()=>{Be(),Ge()},onStageComplete:()=>{Ie(),Be(),Ge()},onError:()=>{Be(),Ge()}}})})}function Ye(){return je(this,void 0,void 0,function*(){const n=zn();Be(),Ge(),yield function(n){return qn(this,arguments,void 0,function*(n,t={}){var e,r,a,s,i,o,c,l,d,p;const{callbacks:u}=t;if(!n.character)return h.Rm.warn("Cannot execute quick iterate: no character selected"),{rewrite:null,analyze:null};if(n.isGenerating)return h.Rm.warn("Cannot execute quick iterate: generation already in progress"),{rewrite:null,analyze:null};if(!n.stageResults.analyze)return h.Rm.warn("Cannot execute quick iterate: no analyze result available"),{rewrite:null,analyze:null};const m=new AbortController;Yn(n,!0,m),n.iterationCount++;const f={rewrite:null,analyze:null};try{const t=Kn(n,"rewrite");if(!t)return f;t.isRefinement=!0,Jn(n,"rewrite","running"),null===(e=null==u?void 0:u.onStageStart)||void 0===e||e.call(u,"rewrite"),null===(r=null==u?void 0:u.onProgress)||void 0===r||r.call(u,"Refining rewrite with feedback...");const p=yield kn(t,Hn,{signal:m.signal,onProgress:n=>{var t;h.Rm.debug(`[Pipeline] ${n}`),null===(t=null==u?void 0:u.onProgress)||void 0===t||t.call(u,n)}});if(f.rewrite=p,Vn(n,p),null===(a=null==u?void 0:u.onStageComplete)||void 0===a||a.call(u,"rewrite",p),p.error)return null===(s=null==u?void 0:u.onError)||void 0===s||s.call(u,"rewrite",p.error),f;if(m.signal.aborted)return h.Rm.debug("Quick iterate aborted"),f;const v=Kn(n,"analyze");if(!v)return f;v.previousResults=Object.assign(Object.assign({},n.stageResults),{rewrite:p}),Jn(n,"analyze","running"),null===(i=null==u?void 0:u.onStageStart)||void 0===i||i.call(u,"analyze"),null===(o=null==u?void 0:u.onProgress)||void 0===o||o.call(u,"Analyzing refined version...");const g=yield kn(v,Hn,{signal:m.signal,onProgress:n=>{var t;h.Rm.debug(`[Pipeline] ${n}`),null===(t=null==u?void 0:u.onProgress)||void 0===t||t.call(u,n)}});return f.analyze=g,Vn(n,g),null===(c=null==u?void 0:u.onStageComplete)||void 0===c||c.call(u,"analyze",g),g.error&&(null===(l=null==u?void 0:u.onError)||void 0===l||l.call(u,"analyze",g.error)),null===(d=null==u?void 0:u.onIterateComplete)||void 0===d||d.call(u),f}catch(t){const e=t instanceof Error?t.message:"Unknown error";return h.Rm.error("Quick iterate failed:",t),null===(p=null==u?void 0:u.onError)||void 0===p||p.call(u,n.activeStage,e),f}finally{Yn(n,!1)}})}(n,{callbacks:{onStageStart:n=>{Be(),Ge()},onStageComplete:()=>{Ie(),Be(),Ge()},onError:()=>{Be(),Ge()},onIterateComplete:()=>{Gn("analyze"),Be(),Ht(),Ie()}}})})}let Ve=[];function Ke(n){Ve.forEach(n=>n()),Ve=[];const t=Xn(`#${h.pW}_run_stage`,n);t&&Ve.push(nt(t,"click",()=>{qe(zn().activeStage)}));const e=Xn(`#${h.pW}_run_selected`,n);e&&Ve.push(nt(e,"click",()=>{He()}));const r=Xn(`#${h.pW}_run_all`,n);r&&Ve.push(nt(r,"click",()=>{!function(){je(this,void 0,void 0,function*(){const n=zn();Be(),Ge(),yield Qn(n,{callbacks:{onStageStart:()=>{Be()},onStageComplete:()=>{Ie(),Be()},onProgress:()=>{Ge()},onError:()=>{Be(),Ge()}}}),Be(),Ge()})}()}));const a=Xn(`#${h.pW}_refine`,n);a&&Ve.push(nt(a,"click",()=>{Je()}));const s=Xn(`#${h.pW}_iterate`,n);s&&Ve.push(nt(s,"click",()=>{Ye()}));const i=Xn(`#${h.pW}_reset`,n);i&&Ve.push(nt(i,"click",()=>{!function(n){n.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},n.stageResults={score:null,rewrite:null,analyze:null},n.iterationCount=0,n.hasUnsavedChanges=!0}(zn()),Be(),Ie(),Ge()}));const o=Xn(`#${h.pW}_abort`,n);o&&Ve.push(nt(o,"click",()=>{!function(n){n.abortController&&(n.abortController.abort(),n.abortController=null,n.isGenerating=!1,h.Rm.debug("Pipeline aborted by user"))}(zn()),Be(),Ge()}))}function Qe(n){const t=[],e=Xn(".ct-stage-tabs",n);e&&(t.push(nt(e,"click",n=>{const t=n.target;if(t.classList.contains("ct-stage-tab__checkbox"))return;const e=t.closest(".ct-stage-tab");if(!e)return;const r=e.dataset.stage;r&&(Gn(r),Be(),Ht(),Ie(),Ge())})),t.push(nt(e,"change",n=>{const t=n.target;if(!t.dataset.stageCheckbox)return;!function(n){const t=zn(),e=t.selectedStages.indexOf(n);-1===e?(t.selectedStages.push(n),t.selectedStages.sort((n,t)=>h.an.indexOf(n)-h.an.indexOf(t))):t.selectedStages.splice(e,1)}(t.dataset.stageCheckbox),Ge()})));const r=Xn(`#${h.pW}_pipeline_controls`,n);return r&&Ke(r),()=>{t.forEach(n=>n())}}var Xe=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function Ze(n,t){var e,r;const a=SillyTavern.libs.DOMPurify,s=(0,SillyTavern.libs.moment)(n.updatedAt).calendar(null,{sameDay:"[Today] h:mm A",lastDay:"[Yesterday] h:mm A",lastWeek:"ddd, h:mm A",sameElse:"MMM D, h:mm A"}),i=Object.keys(null!==(r=null===(e=n.stageFields)||void 0===e?void 0:e.base)&&void 0!==r?r:{}).length,o=n.history.length;return`\n        <div class="ct-session-item ${rt(t&&"ct-session-item--active")}"\n             data-session-id="${n.id}"\n             role="option"\n             aria-selected="${t}">\n            <div class="ct-session-item__content">\n                <div class="ct-session-item__header">\n                    <span class="ct-session-item__date">${a.sanitize(s)}</span>\n                    ${t?'<span class="ct-badge ct-badge--accent ct-badge--small">Active</span>':""}\n                </div>\n                <div class="ct-session-item__meta">\n                    <span><i class="fa-solid fa-list-check"></i> ${i} fields</span>\n                    <span><i class="fa-solid fa-clock-rotate-left"></i> ${o} runs</span>\n                    <span><i class="fa-solid fa-rotate"></i> ${n.iterationCount} iterations</span>\n                </div>\n            </div>\n            <div class="ct-session-item__actions">\n                ${t?"":'\n                    <button class="ct-session-load menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Load session">\n                        <i class="fa-solid fa-folder-open"></i>\n                    </button>\n                '}\n                <button class="ct-session-delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        type="button"\n                        title="Delete session">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        </div>\n    `}function nr(){const n=Xn(`#${h.pW}_sessions_container`);if(!n)return;const t=zn(),e=t.sessions,r=t.character&&t.sessionsLoaded;if(n.classList.toggle("ct-sessions--hidden",!r),!r)return;const a=n.querySelector(".ct-sessions__toggle span");a&&(a.textContent=0===e.length?"No saved sessions":`Saved Sessions (${e.length})`);const s=Xn(`#${h.pW}_session_list`);if(s){at(s,e.length>0?e.map(n=>Ze(n,n.id===t.activeSessionId)).join(""):'\n                <div class="ct-empty ct-p-3">\n                    <div class="ct-empty__text">No saved sessions</div>\n                    <div class="ct-text-xs ct-text-dim ct-mt-2">\n                        Create a new session to save your work\n                    </div>\n                </div>\n            ')}}function tr(){lt("session","fields","config","results","pipeline","stage")}function er(n){const t=[],e=Xn(".ct-sessions__toggle",n),r=Xn(".ct-sessions",n);e&&r&&t.push(nt(e,"click",()=>{!function(){const n=zn();n.sessionListExpanded=!n.sessionListExpanded}(),r.classList.toggle("ct-sessions--collapsed"),e.setAttribute("aria-expanded",String(zn().sessionListExpanded))}));const a=Xn(`#${h.pW}_new_session`,n);a&&t.push(nt(a,"click",()=>Xe(this,void 0,void 0,function*(){(yield function(){return Rn(this,void 0,void 0,function*(){return Tn(zn(),jn)})}())&&(h.oR.success("New session created"),tr())})));const s=Xn(`#${h.pW}_session_list`,n);return s&&t.push(nt(s,"click",n=>Xe(this,void 0,void 0,function*(){const t=n.target,e=t.closest(".ct-session-item");if(!e)return;const r=e.dataset.sessionId;if(r){if(t.closest(".ct-session-delete")){n.stopPropagation();return void((yield h.lY.confirm("Delete Session","Are you sure you want to delete this session? This cannot be undone."))&&(yield function(n){return Rn(this,void 0,void 0,function*(){return Cn(zn(),n)})}(r),h.oR.success("Session deleted"),tr()))}if(t.closest(".ct-session-load")||!e.classList.contains("ct-session-item--active")){(yield Dn(r))?(h.oR.success("Session loaded"),tr()):h.oR.error("Failed to load session")}}}))),()=>{t.forEach(n=>n())}}var rr=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function ar(n){const t=SillyTavern.libs.DOMPurify,e=n.isReady?"ct-api-banner--ready":"ct-api-banner--error",r=n.isReady?"fa-circle-check":"fa-circle-xmark",a="cc"===n.apiType?"Chat":"Text";return`\n        <div class="ct-api-banner ${e}">\n            <div class="ct-api-banner__left">\n                <i class="fa-solid ${r}"></i>\n                <span class="ct-api-banner__name">${t.sanitize(n.displayName)}</span>\n                <span class="ct-badge ct-badge--small">${a}</span>\n            </div>\n            <div class="ct-api-banner__right">\n                <span class="ct-api-banner__model" title="${t.sanitize(n.model)}">${t.sanitize(n.modelDisplay)}</span>\n                <span class="ct-api-banner__limits">${n.maxOutput.toLocaleString()}t max</span>\n            </div>\n        </div>\n        ${n.error?`\n            <div class="ct-api-error">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                <span>${t.sanitize(n.error)}</span>\n            </div>\n        `:""}\n    `}function sr(n){const t=SillyTavern.libs.DOMPurify;if(!n)return'\n            <div class="ct-profile-info ct-profile-info--empty">\n                <i class="fa-solid fa-circle-question"></i>\n                <span>Select a profile above</span>\n            </div>\n        ';const e="cc"===n.mode?"Chat":"Text";return`\n        <div class="ct-profile-info ${n.isSupported?"":"ct-profile-info--error"}">\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">API</span>\n                <span class="ct-profile-info__value">${t.sanitize(n.api)}</span>\n            </div>\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">Model</span>\n                <span class="ct-profile-info__value" title="${t.sanitize(n.model)}">${t.sanitize(function(n){const t=n.replace(/^anthropic\//,"").replace(/^openai\//,"").replace(/^google\//,"").replace(/^meta-llama\//,"llama-").replace(/^mistralai\//,"mistral-");if(t.length>30)return t.substring(0,27)+"...";return t}(n.model))}</span>\n            </div>\n            <div class="ct-profile-info__row">\n                <span class="ct-profile-info__label">Type</span>\n                <span class="ct-badge ct-badge--small">${e}</span>\n            </div>\n            ${n.presetName?`\n                <div class="ct-profile-info__row">\n                    <span class="ct-profile-info__label">Preset</span>\n                    <span class="ct-profile-info__value">${t.sanitize(n.presetName)}</span>\n                </div>\n            `:""}\n            ${n.isSupported?"":`\n                <div class="ct-profile-info__error">\n                    <i class="fa-solid fa-triangle-exclamation"></i>\n                    <span>${n.validationError||"Profile configuration is invalid"}</span>\n                </div>\n            `}\n        </div>\n    `}function ir(n,t){const e=Xn(`#${h.pW}_api_status_banner`,n);if(!e)return;let r=null;if(t){const t=Xn(`#${h.pW}_profile_select`,n);r=(null==t?void 0:t.value)||null}const a=(0,h.Lq)(r);e.innerHTML=ar(a)}function or(){return rr(this,void 0,void 0,function*(){const n=SillyTavern.libs.DOMPurify,t=SillyTavern.getContext(),e=function(){var n;const t=SillyTavern.libs.DOMPurify,e=w(),r=(0,h.We)(),a=(0,h.Lq)("profile"===e.generationMode?e.profileId:null);return`\n        <div id="${h.pW}_settings_modal" class="ct-settings-modal">\n            <div class="ct-settings-header">\n                <h2>\n                    <i class="fa-solid fa-cog"></i>\n                    ${h.hi} Settings\n                </h2>\n            </div>\n\n            <div class="ct-settings-body">\n                <div class="ct-settings-columns">\n                    \x3c!-- Left Column: Generation Settings --\x3e\n                    <div class="ct-settings-column">\n                        <section class="ct-settings-section">\n                            <h3>\n                                <i class="fa-solid fa-sliders"></i>\n                                Generation\n                            </h3>\n\n                            \x3c!-- Current API Status --\x3e\n                            <div id="${h.pW}_api_status_banner">\n                                ${ar(a)}\n                            </div>\n\n                            \x3c!-- Mode Toggle --\x3e\n                            ${(0,h.mi)()?`\n                                <div class="ct-gen-mode-toggle">\n                                    <label class="ct-gen-mode-option ${"current"===e.generationMode?"ct-gen-mode-option--active":""}" data-mode="current">\n                                        <input type="radio" name="${h.pW}_gen_mode" value="current" ${"current"===e.generationMode?"checked":""}>\n                                        <i class="fa-solid fa-sliders"></i>\n                                        <span>Current ST Settings</span>\n                                    </label>\n                                    <label class="ct-gen-mode-option ${"profile"===e.generationMode?"ct-gen-mode-option--active":""}" data-mode="profile">\n                                        <input type="radio" name="${h.pW}_gen_mode" value="profile" ${"profile"===e.generationMode?"checked":""}>\n                                        <i class="fa-solid fa-plug"></i>\n                                        <span>Connection Profile</span>\n                                    </label>\n                                </div>\n\n                                \x3c!-- Profile Selection --\x3e\n                                <div id="${h.pW}_profile_section" class="ct-profile-section ${"current"===e.generationMode?"ct-hidden":""}">\n                                    ${r.length>0?`\n                                        <div class="ct-setting-item">\n                                            <label class="ct-setting-label">Select Profile</label>\n                                            <select id="${h.pW}_profile_select" class="ct-select text_pole">\n                                                <option value="">-- Select a profile --</option>\n                                                ${r.map(n=>`\n                                                    <option value="${n.id}"\n                                                            ${n.id===e.profileId?"selected":""}\n                                                            ${n.isSupported?"":"disabled"}>\n                                                        ${t.sanitize(n.name)}${n.isSupported?"":" (invalid)"}\n                                                    </option>\n                                                `).join("")}\n                                            </select>\n                                        </div>\n                                        <div id="${h.pW}_profile_info_container">\n                                            ${sr(r.find(n=>n.id===e.profileId)||null)}\n                                        </div>\n                                    `:'\n                                        <div class="ct-profile-empty">\n                                            <i class="fa-solid fa-info-circle"></i>\n                                            <div>\n                                                <strong>No connection profiles found</strong>\n                                                <p>Create profiles in SillyTavern\'s Connection Manager to use specific API configurations.</p>\n                                            </div>\n                                        </div>\n                                    '}\n                                </div>\n                            `:""}\n\n                            \x3c!-- Max Tokens Override --\x3e\n                            <details class="ct-collapsible">\n                                <summary>Response Length Override</summary>\n                                <div class="ct-setting-item">\n                                    <label class="ct-setting-label">\n                                        <input type="checkbox"\n                                               id="${h.pW}_max_tokens_enabled"\n                                               ${null!==e.maxTokensOverride?"checked":""} />\n                                        <span>Override max response tokens</span>\n                                    </label>\n                                    <input type="number"\n                                           id="${h.pW}_max_tokens"\n                                           class="ct-number-input text_pole"\n                                           value="${null!==(n=e.maxTokensOverride)&&void 0!==n?n:4096}"\n                                           min="100"\n                                           max="32000"\n                                           step="100"\n                                           ${null===e.maxTokensOverride?"disabled":""} />\n                                    <span class="ct-setting-hint">\n                                        Leave unchecked to use the profile's preset settings\n                                    </span>\n                                </div>\n                            </details>\n                        </section>\n\n                        \x3c!-- System Prompt --\x3e\n                        <section class="ct-settings-section">\n                            <h3>\n                                <i class="fa-solid fa-terminal"></i>\n                                System Prompt\n                            </h3>\n                            <p class="ct-setting-desc">\n                                The system prompt is sent with every generation. Your additions are appended after the base prompt.\n                            </p>\n\n                            <div class="ct-setting-item">\n                                <label class="ct-setting-label">Your Additions</label>\n                                <textarea id="${h.pW}_user_system_prompt"\n                                          class="ct-textarea text_pole"\n                                          rows="4"\n                                          placeholder="Add custom instructions...">${t.sanitize(e.userSystemPrompt)}</textarea>\n                            </div>\n\n                            <details class="ct-collapsible">\n                                <summary>Base Prompt (Read-only)</summary>\n                                <pre class="ct-readonly-text">${t.sanitize(e.baseSystemPrompt)}</pre>\n                            </details>\n                        </section>\n\n                        \x3c!-- Refinement Prompt --\x3e\n                        <section class="ct-settings-section">\n                            <h3>\n                                <i class="fa-solid fa-rotate"></i>\n                                Refinement Prompt\n                            </h3>\n                            <p class="ct-setting-desc">\n                                Instructions for refinement iterations. Your additions are appended after the base.\n                            </p>\n\n                            <div class="ct-setting-item">\n                                <label class="ct-setting-label">Your Additions</label>\n                                <textarea id="${h.pW}_user_refinement_prompt"\n                                          class="ct-textarea text_pole"\n                                          rows="4"\n                                          placeholder="Add custom refinement instructions...">${t.sanitize(e.userRefinementPrompt)}</textarea>\n                            </div>\n\n                            <details class="ct-collapsible">\n                                <summary>Base Prompt (Read-only)</summary>\n                                <pre class="ct-readonly-text">${t.sanitize(e.baseRefinementPrompt)}</pre>\n                            </details>\n                        </section>\n                    </div>\n\n                    \x3c!-- Right Column: Shortcuts & Debug --\x3e\n                    <div class="ct-settings-column">\n                        \x3c!-- Keyboard Shortcuts --\x3e\n                        <section class="ct-settings-section">\n                            <h3>\n                                <i class="fa-solid fa-keyboard"></i>\n                                Keyboard Shortcuts\n                            </h3>\n                            <div class="ct-shortcuts-list">\n                                <div class="ct-shortcut">\n                                    <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n                                    <span>Run current stage</span>\n                                </div>\n                                <div class="ct-shortcut">\n                                    <kbd>Escape</kbd>\n                                    <span>Cancel generation</span>\n                                </div>\n                            </div>\n                        </section>\n\n                        \x3c!-- Debug --\x3e\n                        <section class="ct-settings-section">\n                            <h3>\n                                <i class="fa-solid fa-bug"></i>\n                                Debug\n                            </h3>\n\n                            <div class="ct-setting-item">\n                                <label class="ct-setting-label">\n                                    <input type="checkbox"\n                                           id="${h.pW}_debug_mode"\n                                           ${e.debugMode?"checked":""} />\n                                    <span>Enable debug logging</span>\n                                </label>\n                            </div>\n\n                            <div class="ct-debug-actions">\n                                <button id="${h.pW}_view_logs"\n                                        class="ct-btn ct-btn--small menu_button"\n                                        type="button">\n                                    <i class="fa-solid fa-list"></i>\n                                    View Logs\n                                </button>\n                                <button id="${h.pW}_reset_settings"\n                                        class="ct-btn ct-btn--small ct-btn--danger menu_button"\n                                        type="button">\n                                    <i class="fa-solid fa-rotate-left"></i>\n                                    Reset All\n                                </button>\n                            </div>\n                        </section>\n                    </div>\n                </div>\n            </div>\n\n            <div class="ct-settings-footer">\n                <span class="ct-version">v${h.xv}</span>\n                <button id="${h.pW}_settings_close"\n                        class="ct-btn ct-btn--primary menu_button"\n                        type="button">\n                    <i class="fa-solid fa-check"></i>\n                    Save & Close\n                </button>\n            </div>\n        </div>\n    `}();new t.Popup(n.sanitize(e),t.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show(),yield new Promise(n=>setTimeout(n,0));const r=Xn(`#${h.pW}_settings_modal`);if(!r)return;const a=function(n){const t=[],e=Zn(".ct-gen-mode-option",n),r=Xn(`#${h.pW}_profile_section`,n);for(const a of e)t.push(nt(a,"click",()=>{const t=a.dataset.mode;e.forEach(n=>n.classList.remove("ct-gen-mode-option--active")),a.classList.add("ct-gen-mode-option--active"),r&&r.classList.toggle("ct-hidden","current"===t),ir(n,"profile"===t)}));const a=Xn(`#${h.pW}_profile_select`,n),s=Xn(`#${h.pW}_profile_info_container`,n);a&&s&&t.push(nt(a,"change",()=>{const t=(0,h.We)().find(n=>n.id===a.value);s.innerHTML=sr(t||null),ir(n,!0)}));const i=Xn(`#${h.pW}_max_tokens_enabled`,n),o=Xn(`#${h.pW}_max_tokens`,n);i&&o&&t.push(nt(i,"change",()=>{o.disabled=!i.checked}));const c=Xn(`#${h.pW}_view_logs`,n);c&&t.push(nt(c,"click",()=>{h.oR.info("Check browser console for logs")}));const l=Xn(`#${h.pW}_reset_settings`,n);l&&t.push(nt(l,"click",()=>rr(this,void 0,void 0,function*(){if(!(yield h.lY.confirm("Reset Settings","This will reset all settings to defaults. Custom presets will be kept. Continue?")))return;!function(){const{lodash:n}=SillyTavern.libs,t=SillyTavern.getContext().extensionSettings;t[h.pW]=n.cloneDeep(x),$(),t[h.pW]}(),h.oR.success("Settings reset to defaults");const t=n.closest(".popup"),e=null==t?void 0:t.querySelector(".popup-button-cancel, .popup-button-ok");null==e||e.click(),setTimeout(()=>or(),100)})));return()=>{t.forEach(n=>n())}}(r),s=Xn(`#${h.pW}_settings_close`,r);s&&s.addEventListener("click",()=>{!function(){const n=w(),t=document.querySelector(`input[name="${h.pW}_gen_mode"]:checked`);t&&(n.generationMode=t.value);const e=Xn(`#${h.pW}_profile_select`);e&&(n.profileId=e.value||null);const r=Xn(`#${h.pW}_max_tokens_enabled`),a=Xn(`#${h.pW}_max_tokens`);r&&a&&(n.maxTokensOverride=r.checked?parseInt(a.value,10):null);const s=Xn(`#${h.pW}_user_system_prompt`);s&&(n.userSystemPrompt=s.value);const i=Xn(`#${h.pW}_user_refinement_prompt`);i&&(n.userRefinementPrompt=i.value);const o=Xn(`#${h.pW}_debug_mode`);o&&(n.debugMode=o.checked,(0,h.pM)(o.checked));$(),h.oR.success("Settings saved")}(),a();const n=r.closest(".popup"),t=null==n?void 0:n.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()})})}var cr=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};let lr="prompt",dr=!0;function pr(n){const t="prompt"===n?T.getPromptPresets():T.getSchemaPresets();if(0===t.length)return`\n            <div class="ct-preset-empty">\n                <i class="fa-solid fa-bookmark"></i>\n                <span>No ${n} presets yet</span>\n            </div>\n        `;return[...t].sort((n,t)=>n.isBuiltin!==t.isBuiltin?n.isBuiltin?1:-1:n.name.localeCompare(t.name)).map(t=>function(n,t){const e=SillyTavern.libs.DOMPurify,r=n.stages.length>0?n.stages.map(n=>h.BA[n]).join(", "):"All stages",a=n.isBuiltin;return`\n        <div class="ct-preset-item ${a?"ct-preset-item--builtin":""}"\n             data-id="${n.id}"\n             data-type="${t}">\n            <div class="ct-preset-info">\n                <span class="ct-preset-name">\n                    ${a?'<i class="fa-solid fa-lock ct-text-dim" title="Built-in preset"></i>':""}\n                    ${e.sanitize(n.name)}\n                </span>\n                <span class="ct-preset-stages">${r}</span>\n            </div>\n            <div class="ct-preset-actions">\n                <button class="ct-preset-action ct-preset-action--duplicate menu_button menu_button--icon menu_button--ghost"\n                        type="button"\n                        title="${a?"Duplicate to create editable copy":"Duplicate preset"}">\n                    <i class="fa-solid fa-copy"></i>\n                </button>\n                ${a?"":'\n                    <button class="ct-preset-action ct-preset-action--edit menu_button menu_button--icon menu_button--ghost"\n                            type="button"\n                            title="Edit preset">\n                        <i class="fa-solid fa-pen"></i>\n                    </button>\n                    <button class="ct-preset-action ct-preset-action--delete menu_button menu_button--icon menu_button--ghost"\n                            type="button"\n                            title="Delete preset">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                '}\n            </div>\n        </div>\n    `}(t,n)).join("")}function ur(){const n=Xn(`#${h.pW}_preset_manager`);if(!n)return;const t=T.getPromptPresets().length,e=T.getSchemaPresets().length,r=n.querySelector(".ct-presets-manager__count");r&&(r.textContent=String(t+e));const a=n.querySelector('[data-tab="prompt"] .ct-badge'),s=n.querySelector('[data-tab="schema"] .ct-badge');a&&(a.textContent=String(t)),s&&(s.textContent=String(e));const i=Xn(`#${h.pW}_preset_list_prompt`),o=Xn(`#${h.pW}_preset_list_schema`);i&&(i.innerHTML=pr("prompt")),o&&(o.innerHTML=pr("schema"));const c=Xn(`#${h.pW}_preset_create`);c&&(c.innerHTML=`\n            <i class="fa-solid fa-plus"></i>\n            New ${"prompt"===lr?"Prompt":"Schema"}\n        `)}function mr(){return cr(this,void 0,void 0,function*(){const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=n=>cr(this,void 0,void 0,function*(){var t;const e=null===(t=n.target.files)||void 0===t?void 0:t[0];if(e)try{const n=yield e.text(),t=JSON.parse(n),r=w();let a=0;if(Array.isArray(t.promptPresets))for(const n of t.promptPresets)n.isBuiltin||(n.id=crypto.randomUUID(),r.promptPresets.push(n),a++);if(Array.isArray(t.schemaPresets))for(const n of t.schemaPresets)n.isBuiltin||(n.id=crypto.randomUUID(),r.schemaPresets.push(n),a++);$(),h.oR.success(`Imported ${a} presets`),ur()}catch(n){h.oR.error("Failed to import presets"),console.error("Import error:",n)}}),n.click()})}function fr(){const n=w(),t=n.promptPresets.filter(n=>!n.isBuiltin),e=n.schemaPresets.filter(n=>!n.isBuiltin);if(0===t.length&&0===e.length)return void h.oR.warning("No custom presets to export");const r={version:h.xv,exportedAt:(new Date).toISOString(),promptPresets:t,schemaPresets:e},a=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=`character-tools-presets-${(new Date).toISOString().slice(0,10)}.json`,i.click(),URL.revokeObjectURL(s),h.oR.success(`Exported ${t.length+e.length} presets`)}let vr=null;function gr(){const n=SillyTavern.libs.DOMPurify,t=(0,h.Lq)(vr),e=(0,h.mi)(),r=e?(0,h.We)():[],a=t.isReady?"fa-circle-check ct-text-success":"fa-circle-xmark ct-text-danger",s=t.isReady?"ct-api-status--ready":"ct-api-status--error",i=e&&r.length>0?`\n        <select id="${h.pW}_profile_select" \n                class="ct-select ct-select--sm text_pole" \n                aria-label="Connection profile">\n            <option value="" ${vr?"":"selected"}>\n                Current Settings\n            </option>\n            ${r.map(n=>function(n,t){const e=SillyTavern.libs.DOMPurify;return`\n        <option value="${n.id}" \n                ${t?"selected":""}\n                ${n.isSupported?"":"disabled"}>\n            ${e.sanitize(n.name)} (${e.sanitize(n.model)})\n        </option>\n    `}(n,n.id===vr)).join("")}\n        </select>\n    `:"";return`\n        <div id="${h.pW}_api_status" class="ct-api-status ${s}">\n            <div class="ct-api-status__indicator">\n                <i class="fa-solid ${a}"></i>\n                <span class="ct-api-status__text">${n.sanitize(t.modelDisplay)}</span>\n            </div>\n            ${i}\n            ${t.error?`\n                <span class="ct-api-status__error" title="${n.sanitize(t.error)}">\n                    <i class="fa-solid fa-exclamation-triangle"></i>\n                </span>\n            `:""}\n        </div>\n    `}function hr(n){const t=[],e=Xn(`#${h.pW}_profile_select`,n);return e&&t.push(nt(e,"change",()=>{const n=e.value||null;vr=n;w().selectedProfile=n,$(),function(){const n=Xn(`#${h.pW}_api_status`);if(!n)return;const t=n.parentElement;t&&(t.innerHTML=gr(),hr(t))}()})),()=>{t.forEach(n=>n())}}var br=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};let yr=null;function _r(){return`\n<div id="${h.pW}_popup" class="ct-popup">\n    <header class="ct-header">\n        <div class="ct-header__left">\n            ${function(){const n=SillyTavern.libs.DOMPurify,t=zn().character,e=t?n.sanitize(t.name):"Select character...",r=t?`<img class="ct-dropdown__trigger-avatar"\n               src="${SillyTavern.getContext().getThumbnailUrl("avatar",t.avatar)}"\n               alt=""\n               onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user ct-dropdown__trigger-icon"></i>';return`\n        <div id="${h.pW}_char_dropdown" class="ct-dropdown ${gt?"ct-dropdown--open":""}">\n            <button id="${h.pW}_char_trigger"\n                    class="ct-dropdown__trigger"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${gt}">\n                ${r}\n                <span class="ct-dropdown__trigger-text ${t?"":"ct-dropdown__trigger-text--placeholder"}">${e}</span>\n                <i class="fa-solid fa-chevron-down ct-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="ct-dropdown__panel" role="listbox">\n                <div class="ct-dropdown__search">\n                    <i class="fa-solid fa-search ct-dropdown__search-icon"></i>\n                    <input type="text"\n                           id="${h.pW}_char_search"\n                           class="ct-dropdown__search-input"\n                           placeholder="Search characters..."\n                           autocomplete="off"\n                           value="${n.sanitize(ht)}" />\n                    ${ht?'\n                        <button class="ct-dropdown__search-clear" type="button" aria-label="Clear">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    ':""}\n                </div>\n                <div id="${h.pW}_char_list" class="ct-dropdown__list ct-scrollable">\n                    ${xt()}\n                </div>\n            </div>\n        </div>\n    `}()}\n        </div>\n        <div class="ct-header__center">\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <h2>Character Tools</h2>\n            <div id="${h.pW}_api_status_container">\n                ${function(){const n=(0,h.Lq)(vr),t=n.isReady?"fa-circle-check ct-text-success":"fa-circle-xmark ct-text-danger";return`\n        <div class="ct-api-badge ${rt(!n.isReady&&"ct-api-badge--error")}" \n             title="${n.statusText}${n.error?": "+n.error:""}">\n            <i class="fa-solid ${t}"></i>\n            <span>${n.modelDisplay}</span>\n        </div>\n    `}()}\n            </div>\n        </div>\n        <div class="ct-header__right">\n            <button id="${h.pW}_export_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Export character as PNG"\n                    aria-label="Export character">\n                <i class="fa-solid fa-download"></i>\n            </button>\n            <button id="${h.pW}_settings_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Settings"\n                    aria-label="Settings">\n                <i class="fa-solid fa-cog"></i>\n            </button>\n            <button id="${h.pW}_close_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Close"\n                    aria-label="Close popup">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    </header>\n\n    <div class="ct-toolbar">\n        \n        <nav class="ct-stage-tabs" role="tablist" aria-label="Pipeline stages">\n            ${h.an.map(Me).join("")}\n        </nav>\n    \n        <div id="${h.pW}_pipeline_controls" class="ct-toolbar__controls">\n            ${Fe()}\n        </div>\n    </div>\n\n    <div class="ct-body">\n        <aside class="ct-panel ct-panel--config ct-scrollable">\n            ${function(){const n=SillyTavern.libs.DOMPurify,t=zn(),e=t.activeStage,r=t.stageConfigs[e];let a=r.customPrompt;if(!a&&r.promptPresetId){const n=J(r.promptPresetId);n&&(a=n.prompt)}let s=r.customSchema;if(!s&&r.schemaPresetId){const n=V(r.schemaPresetId);n&&(s=JSON.stringify(n.schema,null,2))}return`\n        <section class="ct-section ct-stage-config" aria-label="Stage Configuration">\n            <div class="ct-section__header">\n                <h3 class="ct-section__title">\n                    <i class="fa-solid ${h.iu[e]}"></i>\n                    ${h.BA[e]} Configuration\n                </h3>\n            </div>\n\n            \x3c!-- Field Selection --\x3e\n            <div class="ct-stack ct-stack--tight">\n                <div class="ct-row ct-row--between">\n                    <div class="ct-row">\n                        <i class="fa-solid fa-list-check ct-text-accent"></i>\n                        <span class="ct-font-medium ct-text-sm">Fields to Include</span>\n                    </div>\n                    <button id="${h.pW}_link_fields"\n                            class="menu_button menu_button--icon menu_button--sm menu_button--ghost ${Fn()?"ct-active":""}"\n                            type="button"\n                            title="${Fn()?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)"}"\n                            aria-pressed="${Fn()}">\n                        <i class="fa-solid ${Fn()?"fa-link":"fa-link-slash"}"></i>\n                    </button>\n                </div>\n                <div id="${h.pW}_fields_container">\n                    ${Gt()}\n                </div>\n            </div>\n\n            \x3c!-- Prompt Configuration --\x3e\n            <div class="ct-stack ct-stack--tight ct-mt-4">\n                <div class="ct-row ct-row--between">\n                    <div class="ct-row">\n                        <i class="fa-solid fa-message ct-text-accent"></i>\n                        <span class="ct-font-medium ct-text-sm">Prompt</span>\n                    </div>\n                    <div class="ct-row ct-gap-1">\n                        <button id="${h.pW}_save_prompt"\n                                class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Save as preset"\n                                aria-label="Save as preset">\n                            <i class="fa-solid fa-floppy-disk"></i>\n                        </button>\n                        ${Ut("prompt",e,r.promptPresetId)}\n                    </div>\n                </div>\n                <div class="ct-form-group">\n                    <textarea id="${h.pW}_prompt"\n                              placeholder="Enter instructions for this stage..."\n                              rows="6">${n.sanitize(a)}</textarea>\n                    <div class="ct-form-group__hint ct-text-right">\n                        <span id="${h.pW}_prompt_tokens">Calculating...</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Structured Output Toggle --\x3e\n            <div class="ct-stack ct-stack--tight ct-mt-4">\n                <label class="ct-checkbox">\n                    <input type="checkbox"\n                           id="${h.pW}_use_schema"\n                           ${r.useStructuredOutput?"checked":""} />\n                    <span>Use Structured Output (JSON Schema)</span>\n                </label>\n\n                <div id="${h.pW}_schema_section"\n                     class="${rt(!r.useStructuredOutput&&"ct-hidden")} ct-stack ct-stack--tight ct-mt-2">\n                    <div class="ct-row ct-row--between">\n                        <div class="ct-row">\n                            <i class="fa-solid fa-code ct-text-accent"></i>\n                            <span class="ct-font-medium ct-text-sm">JSON Schema</span>\n                        </div>\n                        ${Ut("schema",e,r.schemaPresetId)}\n                    </div>\n                    <textarea id="${h.pW}_schema"\n                              class="ct-textarea--code"\n                              placeholder='{"name": "MySchema", "strict": true, "value": {...}}'\n                              rows="8">${n.sanitize(s)}</textarea>\n                    <div class="ct-button-group">\n                        <button id="${h.pW}_validate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-check"></i>\n                            Validate\n                        </button>\n                        <button id="${h.pW}_format_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-indent"></i>\n                            Format\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- User Guidance --\x3e\n            <div class="ct-stack ct-stack--tight ct-mt-4">\n                <div class="ct-row">\n                    <i class="fa-solid fa-compass ct-text-accent"></i>\n                    <span class="ct-font-medium ct-text-sm">Guidance</span>\n                    <span class="ct-text-xs ct-text-dim">(optional focus or constraints)</span>\n                </div>\n                <textarea id="${h.pW}_guidance"\n                          class="ct-textarea--compact"\n                          placeholder="e.g., 'Focus on dialogue quality' or 'Maintain a dark, brooding tone'"\n                          rows="2">${n.sanitize(t.userGuidance)}</textarea>\n            </div>\n\n            \x3c!-- Preview --\x3e\n            <div class="ct-mt-4">\n                <button id="${h.pW}_preview"\n                        class="menu_button menu_button--full"\n                        type="button"\n                        ${t.character?"":"disabled"}>\n                    <i class="fa-solid fa-eye"></i>\n                    Preview Full Prompt\n                </button>\n            </div>\n        </section>\n    `}()}\n            ${function(){const n=T.getPromptPresets().length,t=T.getSchemaPresets().length;return`\n        <section id="${h.pW}_preset_manager"\n                 class="ct-presets-manager ${dr?"":"ct-presets-manager--collapsed"}">\n            <button class="ct-presets-manager__toggle" type="button" aria-expanded="${dr}">\n                <i class="fa-solid fa-bookmark ct-text-accent"></i>\n                <span class="ct-presets-manager__title">Presets</span>\n                <span class="ct-presets-manager__count">${n+t}</span>\n                <i class="fa-solid fa-chevron-down ct-presets-manager__chevron"></i>\n            </button>\n\n            <div class="ct-presets-manager__content">\n                \x3c!-- Tabs --\x3e\n                <div class="ct-presets-manager__tabs">\n                    <button class="ct-presets-manager__tab ${"prompt"===lr?"ct-presets-manager__tab--active":""}"\n                            data-tab="prompt"\n                            type="button">\n                        <i class="fa-solid fa-message"></i>\n                        Prompts\n                        <span class="ct-badge ct-badge--small">${n}</span>\n                    </button>\n                    <button class="ct-presets-manager__tab ${"schema"===lr?"ct-presets-manager__tab--active":""}"\n                            data-tab="schema"\n                            type="button">\n                        <i class="fa-solid fa-code"></i>\n                        Schemas\n                        <span class="ct-badge ct-badge--small">${t}</span>\n                    </button>\n                </div>\n\n                \x3c!-- Preset Lists --\x3e\n                <div id="${h.pW}_preset_list_prompt"\n                     class="ct-presets-manager__list ct-scrollable ${"prompt"!==lr?"ct-hidden":""}">\n                    ${pr("prompt")}\n                </div>\n                <div id="${h.pW}_preset_list_schema"\n                     class="ct-presets-manager__list ct-scrollable ${"schema"!==lr?"ct-hidden":""}">\n                    ${pr("schema")}\n                </div>\n\n                \x3c!-- Actions --\x3e\n                <div class="ct-presets-manager__actions">\n                    <button id="${h.pW}_preset_create"\n                            class="menu_button menu_button--sm menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-plus"></i>\n                        New ${"prompt"===lr?"Prompt":"Schema"}\n                    </button>\n                    <div class="ct-presets-manager__io">\n                        <button id="${h.pW}_preset_import"\n                                class="menu_button menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Import presets from file">\n                            <i class="fa-solid fa-file-import"></i>\n                        </button>\n                        <button id="${h.pW}_preset_export"\n                                class="menu_button menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Export custom presets">\n                            <i class="fa-solid fa-file-export"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </section>\n    `}()}\n            ${function(){const n=zn(),t=n.sessions,e=n.sessionListExpanded,r=n.character&&n.sessionsLoaded;return`\n        <div id="${h.pW}_sessions_container" class="ct-sessions ${rt(!e&&"ct-sessions--collapsed")} ${rt(!r&&"ct-sessions--hidden")}">\n            <button class="ct-sessions__toggle"\n                    type="button"\n                    aria-expanded="${e}"\n                    title="Saved workspaces - load to continue previous work">\n                <span>${0===t.length?"No saved sessions":`Saved Sessions (${t.length})`}</span>\n                <i class="fa-solid fa-chevron-down ct-sessions__toggle-icon"></i>\n            </button>\n            <div class="ct-sessions__content">\n                <div class="ct-sessions__actions">\n                    <button id="${h.pW}_new_session"\n                            class="menu_button menu_button--sm menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-plus"></i>\n                        New Session\n                    </button>\n                </div>\n                <div id="${h.pW}_session_list" class="ct-sessions__list ct-scrollable">\n                    ${t.length>0?t.map(t=>Ze(t,t.id===n.activeSessionId)).join(""):'\n                            <div class="ct-empty ct-p-3">\n                                <div class="ct-empty__text">No saved sessions</div>\n                                <div class="ct-text-xs ct-text-dim ct-mt-2">\n                                    Create a new session to save your work\n                                </div>\n                            </div>\n                        '}\n                </div>\n            </div>\n        </div>\n    `}()}\n        </aside>\n        <main class="ct-panel ct-panel--results">\n            ${function(){const n=zn(),t=n.stageResults[n.activeStage],e=!!n.stageResults.rewrite,r=n.iterationHistory.length>0,a=e&&te().length>0,s=e?`\n            <div class="ct-view-toggle">\n                <button class="ct-view-toggle__btn ${"result"===Ee?"ct-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="ct-view-toggle__btn ${"compare"===Ee?"ct-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${a?'\n                <button class="menu_button menu_button--primary menu_button--sm ct-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `:"",i="compare"===Ee&&e?`<div id="${h.pW}_compare_content">${Xt()}</div>`:ze(t,n.activeStage),o=r?`\n            <div class="ct-history ${rt(!n.historyExpanded&&"ct-history--collapsed")}">\n                <button class="ct-history__toggle"\n                        type="button"\n                        aria-expanded="${n.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${n.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down ct-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="ct-history__list ct-list">\n                    ${n.iterationHistory.map((n,t)=>Ne(n,t)).join("")}\n                </div>\n            </div>\n        `:"";return`\n        <div class="ct-results-wrapper">\n            \x3c!-- View Toggle --\x3e\n            ${s?`<div class="ct-results-toolbar">${s}</div>`:""}\n\n            \x3c!-- Results/Compare content --\x3e\n            <div id="${h.pW}_results_content" class="ct-results-content">\n                ${i}\n            </div>\n\n            \x3c!-- Run History Section (only if there's history) --\x3e\n            ${o}\n        </div>\n    `}()}\n        </main>\n    </div>\n</div>`}let xr=[];function wr(){return br(this,void 0,void 0,function*(){const n=SillyTavern.getContext(),{DOMPurify:t}=SillyTavern.libs;An();const e=_r();new n.Popup(t.sanitize(e),n.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>br(this,void 0,void 0,function*(){yield function(){return br(this,void 0,void 0,function*(){yield jn(),xr.forEach(n=>n()),xr=[],Ve.forEach(n=>n()),Ve=[],function(){const n=Xn(`#${h.pW}_preset_drawer`);n&&n.remove(),Ct.forEach(n=>n()),Ct=[],Pt.isOpen=!1}(),st.clear(),it.clear(),ot=!1,yr=null,In(),Q=null,X=null,Z=null,h.Rm.debug("Popup closed")})}()})),yield new Promise(n=>setTimeout(n,0)),yr=document.getElementById(`${h.pW}_popup`),yr?(!function(n){if(Xn(`#${h.pW}_preset_drawer`))return;const t=n.closest(".popup");t?t.insertAdjacentHTML("beforeend",Rt()):document.body.insertAdjacentHTML("beforeend",Rt())}(yr),function(n){xr.forEach(n=>n()),xr=[],xr.push(ct("characterSelector",wt,["character","session"])),xr.push(ct("stageTabs",Be,["stage","pipeline"])),xr.push(ct("pipelineControls",Ge,["pipeline","character"])),xr.push(ct("stageConfig",Ht,["stage","config","fields","character"])),xr.push(ct("results",Ie,["results","stage"])),xr.push(ct("sessionList",nr,["session","character"])),xr.push(function(n){const t=[],e=Xn(`#${h.pW}_char_dropdown`,n),r=Xn(`#${h.pW}_char_trigger`,n),a=Xn(`#${h.pW}_char_search`,n),s=Xn(`#${h.pW}_char_list`,n);r&&t.push(nt(r,"click",n=>{n.stopPropagation(),yt(!gt),gt&&a&&setTimeout(()=>a.focus(),0)}));const i=n=>{gt&&e&&!e.contains(n.target)&&yt(!1)};if(document.addEventListener("click",i),t.push(()=>document.removeEventListener("click",i)),a){const n=SillyTavern.libs.lodash.debounce(()=>{ht=a.value,bt=-1,s&&(s.innerHTML=xt())},h.U8.SEARCH);t.push(nt(a,"input",()=>{n()})),t.push(nt(a,"keydown",n=>{const t=Zn(".ct-char-option",s),e=t.length-1;switch(n.key){case"ArrowDown":n.preventDefault(),bt=Math.min(bt+1,e),$t(t);break;case"ArrowUp":n.preventDefault(),bt=Math.max(bt-1,0),$t(t);break;case"Enter":n.preventDefault(),bt>=0&&t[bt]&&kt(t[bt]);break;case"Escape":n.preventDefault(),yt(!1),null==r||r.focus()}})),t.push(()=>n.cancel())}const o=Xn(".ct-dropdown__search-clear",n);return o&&a&&t.push(nt(o,"click",n=>{n.stopPropagation(),a.value="",ht="",bt=-1,s&&(s.innerHTML=xt()),a.focus()})),s&&t.push(nt(s,"click",n=>{const t=n.target.closest(".ct-char-option");t&&kt(t)})),()=>{t.forEach(n=>n()),gt=!1,ht="",bt=-1}}(n)),xr.push(Qe(n)),xr.push(Yt(n)),xr.push(We(n)),xr.push(function(n){const t=[],e=Xn(`#${h.pW}_preset_manager`,n);if(!e)return()=>{};const r=e.querySelector(".ct-presets-manager__toggle");r&&t.push(nt(r,"click",()=>{dr=!dr,e.classList.toggle("ct-presets-manager--collapsed",!dr),r.setAttribute("aria-expanded",String(dr))}));const a=Zn(".ct-presets-manager__tab",e);for(const n of a)t.push(nt(n,"click",()=>{const t=n.dataset.tab;if(t===lr)return;lr=t,a.forEach(n=>n.classList.remove("ct-presets-manager__tab--active")),n.classList.add("ct-presets-manager__tab--active");const e=Xn(`#${h.pW}_preset_list_prompt`),r=Xn(`#${h.pW}_preset_list_schema`);null==e||e.classList.toggle("ct-hidden","prompt"!==t),null==r||r.classList.toggle("ct-hidden","schema"!==t);const s=Xn(`#${h.pW}_preset_create`);s&&(s.innerHTML=`\n                        <i class="fa-solid fa-plus"></i>\n                        New ${"prompt"===t?"Prompt":"Schema"}\n                    `)}));const s=Xn(`#${h.pW}_preset_create`,e);s&&t.push(nt(s,"click",()=>{zt(lr,{onSave:()=>ur()})}));const i=n=>cr(this,void 0,void 0,function*(){const t=n.target,e=t.closest(".ct-preset-item");if(!e)return;const r=e.dataset.id,a=e.dataset.type;if(r&&a)if(t.closest(".ct-preset-action--edit"))Nt(a,r,{onSave:()=>ur()});else if(t.closest(".ct-preset-action--duplicate"))It(a,r,{onSave:()=>ur()});else if(t.closest(".ct-preset-action--delete")){const n="prompt"===a?T.getPromptPreset(r):T.getSchemaPreset(r);if(!(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${null==n?void 0:n.name}"?`)))return;"prompt"===a?T.deletePromptPreset(r):T.deleteSchemaPreset(r),h.oR.success("Preset deleted"),ur()}}),o=Xn(`#${h.pW}_preset_list_prompt`,e),c=Xn(`#${h.pW}_preset_list_schema`,e);o&&t.push(nt(o,"click",i)),c&&t.push(nt(c,"click",i));const l=Xn(`#${h.pW}_preset_import`,e);l&&t.push(nt(l,"click",mr));const d=Xn(`#${h.pW}_preset_export`,e);return d&&t.push(nt(d,"click",fr)),()=>t.forEach(n=>n())}(n)),xr.push(er(n));const t=Xn(`#${h.pW}_api_status_container`,n);t&&xr.push(hr(t));const e=Xn(`#${h.pW}_export_btn`,n);e&&xr.push(nt(e,"click",()=>{!function(){Zt(this,void 0,void 0,function*(){const n=zn();if(!n.character)return h.oR.warning("No character selected"),!1;const t=n.character,e=yield re(t.avatar);if(!e)return h.oR.error("Failed to export character PNG"),!1;const r=URL.createObjectURL(e),a=document.createElement("a");return a.href=r,a.download=`${t.name}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),h.oR.success("Character PNG downloaded!"),!0})}()}));const r=Xn(`#${h.pW}_settings_btn`,n);r&&xr.push(nt(r,"click",()=>{or()}));const a=Xn(`#${h.pW}_close_btn`,n);a&&xr.push(nt(a,"click",()=>{!function(){if(!yr)return;const n=yr.closest(".popup"),t=null==n?void 0:n.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click()}()}));const s=t=>{const e=zn();if(t.ctrlKey&&"Enter"===t.key){t.preventDefault();const r=Xn(`#${h.pW}_run_stage`,n);r&&!e.isGenerating&&e.character&&r.click()}"Escape"===t.key&&e.isGenerating&&(t.preventDefault(),function(){const n=Nn();(null==n?void 0:n.abortController)&&(n.abortController.abort(),n.abortController=null,n.isGenerating=!1)}())};document.addEventListener("keydown",s),xr.push(()=>document.removeEventListener("keydown",s))}(yr),h.Rm.debug("Popup opened")):h.Rm.error("Popup element not found")})}var $r=function(n,t,e,r){return new(e||(e=Promise))(function(a,s){function i(n){try{c(r.next(n))}catch(n){s(n)}}function o(n){try{c(r.throw(n))}catch(n){s(n)}}function c(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e(function(n){n(t)})).then(i,o)}c((r=r.apply(n,t||[])).next())})};function kr(){return $r(this,void 0,void 0,function*(){const n=document.getElementById("extensions_settings");if(!n)return void h.Rm.error("Extensions container not found");n.insertAdjacentHTML("beforeend",`\n<div id="${h.pW}_panel">\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b><i class="fa-solid fa-wand-magic-sparkles"></i> ${h.hi}</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n            <div class="flex-container flexFlowColumn">\n                <small class="ct-panel-version">Version ${h.xv}</small>\n                <p class="ct-panel-desc">\n                    AI-powered character card analysis, scoring, and enhancement.\n                    Run the pipeline to evaluate and improve your character cards.\n                </p>\n                <div class="ct-panel-actions">\n                    <button id="${h.pW}_open_btn" class="menu_button menu_button_icon">\n                        <i class="fa-solid fa-play"></i>\n                        <span>Open Character Tools</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>`);const t=document.getElementById(`${h.pW}_open_btn`);null==t||t.addEventListener("click",wr),h.Rm.debug("Panel initialized")})}(0,h.pM)(h.Oi);const{eventSource:Sr,eventTypes:Pr}=SillyTavern.getContext();Sr.on(Pr.APP_READY,function(){try{h.Rm.info(`${h.hi} v${h.xv} initializing...`),w(),kr(),function(){const{eventSource:n,eventTypes:t}=SillyTavern.getContext();n.on(t.CHARACTER_EDITED,()=>{h.Rm.debug("Character edited, resetting Fuse index and refreshing popup"),vt(),function(){const n=Nn();if(!(null==n?void 0:n.character))return;const t=(SillyTavern.getContext().characters||[]).find(t=>{var e;return t.avatar===(null===(e=n.character)||void 0===e?void 0:e.avatar)});t&&(n.character=t)}(),pt()}),n.on(t.CHARACTER_DELETED,()=>{h.Rm.debug("Character deleted, resetting Fuse index"),vt()}),n.on(t.CHATCOMPLETION_SOURCE_CHANGED,()=>{h.Rm.debug("Chat completion source changed")}),n.on(t.CHATCOMPLETION_MODEL_CHANGED,()=>{h.Rm.debug("Chat completion model changed")}),h.Rm.debug("Event listeners registered")}(),h.Rm.info(`${h.hi} v${h.xv} loaded`)}catch(n){h.Rm.error("Extension initialization failed",n),h.oR.error(`${h.hi} failed to initialize. Check console.`)}})})();