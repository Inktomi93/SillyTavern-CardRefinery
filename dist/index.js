var e={56(e,r,t){e.exports=function(e){var r=t.nc;r&&e.setAttribute("nonce",r)}},72(e){var r=[];function t(e){for(var t=-1,n=0;n<r.length;n++)if(r[n].identifier===e){t=n;break}return t}function n(e,n){for(var i={},o=[],s=0;s<e.length;s++){var c=e[s],l=n.base?c[0]+n.base:c[0],d=i[l]||0,p="".concat(l," ").concat(d);i[l]=d+1;var u=t(p),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)r[u].references++,r[u].updater(f);else{var v=a(f,n);n.byIndex=s,r.splice(s,0,{identifier:p,updater:v,references:1})}o.push(p)}return o}function a(e,r){var t=r.domAPI(r);t.update(e);return function(r){if(r){if(r.css===e.css&&r.media===e.media&&r.sourceMap===e.sourceMap&&r.supports===e.supports&&r.layer===e.layer)return;t.update(e=r)}else t.remove()}}e.exports=function(e,a){var i=n(e=e||[],a=a||{});return function(e){e=e||[];for(var o=0;o<i.length;o++){var s=t(i[o]);r[s].references--}for(var c=n(e,a),l=0;l<i.length;l++){var d=t(i[l]);0===r[d].references&&(r[d].updater(),r.splice(d,1))}i=c}}},113(e){e.exports=function(e,r){if(r.styleSheet)r.styleSheet.cssText=e;else{for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(document.createTextNode(e))}}},179(e,r,t){t.r(r),t.d(r,{generate:()=>o,generateSimple:()=>s,generateStructured:()=>c,generateWithRetry:()=>l});var n=t(319),a=t(374),i=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function o(e){return i(this,void 0,void 0,function*(){var r,t,i,o,s,c;if(null===(r=e.signal)||void 0===r?void 0:r.aborted)return{success:!1,error:"Generation cancelled"};if(!(0,n.cW)()){return{success:!1,error:(0,n.Lq)().error||"API not connected. Check your connection settings."}}if(e.jsonSchema){const r=(0,a.i6)(e.jsonSchema);if(!r.valid)return{success:!1,error:`Invalid schema: ${r.error}`}}try{if(null===(t=e.signal)||void 0===t?void 0:t.aborted)return{success:!1,error:"Generation cancelled"};const r=SillyTavern.getContext(),n=yield r.generateRaw({prompt:e.prompt,systemPrompt:null!==(i=e.systemPrompt)&&void 0!==i?i:"",responseLength:null!==(o=e.responseLength)&&void 0!==o?o:null,jsonSchema:null!==(s=e.jsonSchema)&&void 0!==s?s:null});if(null===(c=e.signal)||void 0===c?void 0:c.aborted)return{success:!1,error:"Generation cancelled"};const l=function(e){if("string"==typeof e)return e;if(null==e)return"";if("object"==typeof e){const r=e;return"string"==typeof r.text?r.text:"string"==typeof r.content?r.content:JSON.stringify(e)}return String(e)}(n);if(!l||""===l.trim())return{success:!1,error:"Empty response from API"};if(e.jsonSchema){const r=(0,a.Ki)(l,e.jsonSchema);return r?{success:!0,response:l,parsed:r.data,isStructured:!0}:{success:!0,response:l,isStructured:!1}}return{success:!0,response:l,isStructured:!1}}catch(e){return function(e){if("AbortError"===e.name)return{success:!1,error:"Generation cancelled"};const r=e instanceof Error?e.message:String(e),t=r.toLowerCase();if(t.includes("401")||t.includes("unauthorized")||t.includes("invalid_api_key")||t.includes("api key"))return{success:!1,error:"API authentication failed. Check your API key."};if(t.includes("429")||t.includes("rate limit"))return{success:!1,error:"Rate limited. Please wait and try again."};if(t.includes("500")||t.includes("502")||t.includes("503"))return{success:!1,error:"API server error. The service may be temporarily unavailable."};if(t.includes("timeout")||t.includes("etimedout"))return{success:!1,error:"Request timed out. Check your connection or try a different model."};if(t.includes("network")||t.includes("econnrefused")||t.includes("fetch failed"))return{success:!1,error:"Network error. Check your internet connection."};if(t.includes("context")||t.includes("too long")||t.includes("maximum context")||t.includes("token"))return{success:!1,error:"Prompt too long for model context. Try reducing input length."};if(t.includes("model")&&(t.includes("not found")||t.includes("does not exist")))return{success:!1,error:"Model not found. It may have been deprecated or renamed."};if(t.includes("content")&&(t.includes("filter")||t.includes("policy")))return{success:!1,error:"Content was filtered by the API. Try rephrasing your prompt."};return{success:!1,error:r}}(e)}})}function s(e,r){return i(this,void 0,void 0,function*(){var t;const n=yield o({prompt:e,systemPrompt:r});return n.success&&null!==(t=n.response)&&void 0!==t?t:null})}function c(e,r,t){return i(this,void 0,void 0,function*(){const n=yield o({prompt:e,systemPrompt:t,jsonSchema:r});return n.success&&n.parsed?n.parsed:null})}function l(e){return i(this,arguments,void 0,function*(e,r=2,t=1e3){var n,a;let i={success:!1,error:"No attempts made"};for(let s=0;s<=r;s++){if(null===(n=e.signal)||void 0===n?void 0:n.aborted)return{success:!1,error:"Generation cancelled"};if(i=yield o(e),i.success)return i;const c=(null===(a=i.error)||void 0===a?void 0:a.toLowerCase())||"";if(c.includes("cancelled")||c.includes("authentication")||c.includes("api key")||c.includes("content")||c.includes("too long"))return i;s<r&&(yield new Promise(e=>setTimeout(e,t)))}return i})}},314(e){e.exports=function(e){var r=[];return r.toString=function(){return this.map(function(r){var t="",n=void 0!==r[5];return r[4]&&(t+="@supports (".concat(r[4],") {")),r[2]&&(t+="@media ".concat(r[2]," {")),n&&(t+="@layer".concat(r[5].length>0?" ".concat(r[5]):""," {")),t+=e(r),n&&(t+="}"),r[2]&&(t+="}"),r[4]&&(t+="}"),t}).join("")},r.i=function(e,t,n,a,i){"string"==typeof e&&(e=[[null,e,void 0]]);var o={};if(n)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(o[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);n&&o[d[0]]||(void 0!==i&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=i),t&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=t):d[2]=t),a&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=a):d[4]="".concat(a)),r.push(d))}},r}},319(e,r,t){t.d(r,{IF:()=>f,U8:()=>m,Oi:()=>o,hi:()=>a,Nf:()=>g,pW:()=>n,v7:()=>l,$G:()=>s,an:()=>d,iu:()=>u,BA:()=>p,d5:()=>v,F:()=>c,xv:()=>i,UH:()=>M,Lq:()=>O,We:()=>T,NR:()=>I,gg:()=>D,mi:()=>C,cW:()=>E,Ar:()=>w,wG:()=>_,Rm:()=>S,lY:()=>b,$n:()=>F,pM:()=>P,RG:()=>x,oR:()=>y});const n="SillyTavern-CardRefinery",a="CardRefinery",i="1.0.0",o=!0,s=1,c=2,l=1,d=["score","rewrite","analyze"],p={score:"Score",rewrite:"Rewrite",analyze:"Analyze"},u={score:"fa-star-half-stroke",rewrite:"fa-pen-fancy",analyze:"fa-magnifying-glass-chart"},f=[{key:"description",label:"Description",path:"description"},{key:"personality",label:"Personality",path:"personality"},{key:"first_mes",label:"First Message",path:"first_mes"},{key:"scenario",label:"Scenario",path:"scenario"},{key:"mes_example",label:"Example Messages",path:"mes_example"},{key:"system_prompt",label:"System Prompt",path:"data.system_prompt"},{key:"post_history_instructions",label:"Post-History Instructions",path:"data.post_history_instructions"},{key:"creator_notes",label:"Creator Notes",path:"data.creator_notes"},{key:"alternate_greetings",label:"Alternate Greetings",path:"data.alternate_greetings",type:"array"},{key:"depth_prompt",label:"Depth Prompt",path:"data.extensions.depth_prompt",type:"object"},{key:"character_book",label:"Character Lorebook",path:"data.character_book",type:"object"}],v={SESSIONS:`${n}_sessions`,SESSION_INDEX:`${n}_session_index`,STORAGE_META:`${n}_storage_meta`},m={SEARCH:150,SAVE:1e3,VALIDATE:300},g=50;var h=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};const b={confirm(e,r){return h(this,void 0,void 0,function*(){return!0===(yield SillyTavern.getContext().Popup.show.confirm(e,r))})},input(e,r,t){return h(this,void 0,void 0,function*(){return SillyTavern.getContext().Popup.show.input(e,r,t)})},alert(e,r){return h(this,void 0,void 0,function*(){yield SillyTavern.getContext().Popup.show.text(e,r)})}},y={success(e,r){toastr.success(e,r)},error(e,r){toastr.error(e,r)},warning(e,r){toastr.warning(e,r)},info(e,r){toastr.info(e,r)}};const _={show(){const e=SillyTavern.getContext();"function"==typeof e.showLoader&&e.showLoader()},hide(){const e=SillyTavern.getContext();"function"==typeof e.hideLoader&&e.hideLoader()},wrap(e){return h(this,void 0,void 0,function*(){_.show();try{return yield e()}finally{_.hide()}})}};function x(e,r){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.setItem(e,r),!0}catch(r){return console.error(`[storeLargeData] Failed to store ${e}:`,r),!1}})}function w(e){return h(this,void 0,void 0,function*(){try{return yield SillyTavern.libs.localforage.getItem(e)}catch(r){return console.error(`[loadLargeData] Failed to load ${e}:`,r),null}})}const $=[];let k=!1;const S={debug(e,r){R("debug",e,r),k&&(void 0!==r?console.debug(`[${n}]`,e,r):console.debug(`[${n}]`,e))},info(e,r){R("info",e,r),void 0!==r?console.log(`[${n}]`,e,r):console.log(`[${n}]`,e)},warn(e,r){R("warn",e,r),void 0!==r?console.warn(`[${n}]`,e,r):console.warn(`[${n}]`,e)},error(e,r){R("error",e,r),void 0!==r?console.error(`[${n}]`,e,r):console.error(`[${n}]`,e)}};function P(e){k=e,S.info("Debug mode "+(e?"enabled":"disabled"))}function R(e,r,t){$.unshift({timestamp:new Date,level:e,message:r,data:t}),$.length>100&&$.pop()}function C(){const e=SillyTavern.getContext().ConnectionManagerRequestService;return!(!e||"function"!=typeof e.sendRequest)}function T(){const e=SillyTavern.getContext().ConnectionManagerRequestService;if(!e||"function"!=typeof e.getSupportedProfiles)return[];try{return(e.getSupportedProfiles()||[]).map(r=>{const t=function(e,r){try{const t=(r.getSupportedProfiles()||[]).find(r=>r.id===e);return t?{valid:!0,error:null}:{valid:!1,error:"Profile not found"}}catch(e){return{valid:!1,error:"Failed to validate profile"}}}(r.id,e);return{id:r.id,name:r.name,model:r.model,api:r.api,mode:r.mode,presetName:r.presetName,isSupported:t.valid,validationError:t.error}})}catch(e){return S.error("Failed to get profiles",e),[]}}function z(e){return T().find(r=>r.id===e)||null}function O(e){const r=SillyTavern.getContext();return e?function(e){const r=z(e);if(!r)return{mode:"profile",displayName:"Unknown Profile",source:"unknown",model:"unknown",modelDisplay:"Unknown",apiType:"cc",contextSize:8192,maxOutput:4096,isReady:!1,statusText:"Profile Not Found",error:`Profile ${e} not found`};return{mode:"profile",displayName:r.name,source:r.api,model:r.model,modelDisplay:A(r.model),apiType:r.mode,contextSize:8192,maxOutput:4096,isReady:r.isSupported,statusText:r.isSupported?`${r.name} Ready`:"Not Supported",error:r.validationError}}(e):function(e){var r,t,n,a,i;const o=null!==(r=e.mainApi)&&void 0!==r?r:"unknown",s=e.chatCompletionSettings,c=e.textCompletionSettings,l="textgenerationwebui"!==o&&"kobold"!==o,d=l?"cc":"tc";let p="unknown";l&&"function"==typeof e.getChatCompletionModel?p=e.getChatCompletionModel()||"unknown":l||(p=e.onlineStatus||"unknown");let u=o;l&&(null==s?void 0:s.chat_completion_source)&&(u=s.chat_completion_source);const f=null!==(n=null!==(t=null==s?void 0:s.openai_max_context)&&void 0!==t?t:e.maxContext)&&void 0!==n?n:8192,v=l?null!==(a=null==s?void 0:s.openai_max_tokens)&&void 0!==a?a:4096:null!==(i=null==c?void 0:c.max_length)&&void 0!==i?i:2048,{isReady:m,error:g}=function(e){var r;const t=e.chatCompletionSettings;if(null==t?void 0:t.bypass_status_check)return{isReady:!0,error:null};const n=(null!==(r=e.onlineStatus)&&void 0!==r?r:"").toLowerCase();if(!n)return{isReady:!1,error:"No API connection"};if(["error","fail","invalid","unauthorized","missing"].some(e=>n.includes(e)))return{isReady:!1,error:`API error: ${n}`};if(["valid","connected","ok","ready","key","saved"].some(e=>n.includes(e)))return{isReady:!0,error:null};if("function"!=typeof e.generateRaw)return{isReady:!1,error:"Generation not available (ST version?)"};return{isReady:!0,error:null}}(e);return{mode:"current",displayName:"Current Settings",source:u,model:p,modelDisplay:A(p),apiType:d,contextSize:f,maxOutput:v,isReady:m,statusText:m?`${A(p)} Ready`:"Not Ready",error:g}}(r)}function E(e){return O(e).isReady}function A(e){if(!e||"unknown"===e)return"Unknown";const r=e.replace(/^gpt-/,"GPT-").replace(/^claude-/,"Claude-").replace(/^gemini-/,"Gemini-").replace(/-\d{4}-\d{2}-\d{2}$/,"").replace(/-preview$/,"");return r.length>30?r.slice(0,27)+"...":r}var j=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};const W=new Map;new Map;function N(e){let r=0;for(let t=0;t<e.length;t++){r=(r<<5)-r+e.charCodeAt(t),r&=r}const t=e.slice(0,16),n=e.slice(-16);return`${r}_${e.length}_${t}_${n}`}function I(e){return j(this,void 0,void 0,function*(){const r=e.trim();if(!r)return 0;const t=N(r),n=W.get(t);if(void 0!==n)return n;const a=SillyTavern.getContext();if("function"!=typeof a.getTokenCountAsync)return null;try{const e=yield a.getTokenCountAsync(r);return L(t,e),e}catch(e){return S.error("Token count failed",e),null}})}function D(e){return j(this,void 0,void 0,function*(){const r=e.map(e=>e.text),t=yield function(e){return j(this,void 0,void 0,function*(){const r=new Map,t=[];for(const n of e){const e=n.trim();if(!e){r.set(n,0);continue}const a=N(e),i=W.get(a);void 0!==i?r.set(n,i):t.push({text:e,key:a,original:n})}if(t.length>0){const e=SillyTavern.getContext();if("function"!=typeof e.getTokenCountAsync){for(const{original:e}of t)r.set(e,null);return r}const n=t.map(r=>j(this,[r],void 0,function*({text:r,key:t,original:n}){try{const a=yield e.getTokenCountAsync(r);return L(t,a),{original:n,tokens:a}}catch(e){return{original:n,tokens:null}}})),a=yield Promise.all(n);for(const{original:e,tokens:t}of a)r.set(e,t)}return r})}(r);return e.map(e=>{var r;return{key:e.key,tokens:null!==(r=t.get(e.text))&&void 0!==r?r:null}})})}function L(e,r){if(W.size>=500){const e=W.keys().next().value;e&&W.delete(e)}W.set(e,r)}function M(e,r=["user","persona","original","input"]){if(!e)return e;let t=e;for(const e of r){const r=new RegExp(`\\{\\{(${e})\\}\\}`,"gi");t=t.replace(r,"{{​$1​}}")}return t}function F(e,r){return e&&r?e.replace(/\{\{char\}\}/gi,r):e}},374(e,r,t){t.d(r,{Ki:()=>S,i6:()=>h,jf:()=>k,nr:()=>P});var n=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};const a=8,i=100,o=10,s=100,c=500,l=["date-time","time","date","duration","email","hostname","uri","ipv4","ipv6","uuid"],d=[0,1],p=["minimum","maximum","exclusiveMinimum","exclusiveMaximum","multipleOf"],u=["minLength","maxLength"],f=["maxItems","uniqueItems","contains","minContains","maxContains"],v=["minProperties","maxProperties","propertyNames","patternProperties"],m=["if","then","else","not","oneOf","dependentRequired","dependentSchemas","unevaluatedProperties","unevaluatedItems","$dynamicRef","$dynamicAnchor"],g=[{pattern:/\(\?[=!<]/,name:"lookahead/lookbehind assertions"},{pattern:/\\[1-9]/,name:"backreferences"},{pattern:/\\[bB]/,name:"word boundaries"}];function h(e){var r;if("string"==typeof e&&!e.trim())return{valid:!0,schema:void 0};let t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){const r=e instanceof Error?e.message:"Invalid JSON",t=r.match(/position (\d+)/);return{valid:!1,error:`JSON syntax error${t?` (character ${t[1]})`:""}: ${r}`}}else t=e;if("object"!=typeof t||null===t||Array.isArray(t))return{valid:!1,error:"Schema must be a JSON object, not "+(Array.isArray(t)?"array":typeof t)};const n=t;if("string"!=typeof n.name)return{valid:!1,error:"Missing required 'name' property (string)"};if(!n.name.trim())return{valid:!1,error:"'name' cannot be empty"};if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(n.name))return{valid:!1,error:`'name' must be a valid identifier (got '${n.name}'). Use letters, numbers, underscores; start with letter or underscore.`};if("object"!=typeof n.value||null===n.value||Array.isArray(n.value))return{valid:!1,error:"Missing or invalid 'value' property (must be object)"};const a=n.value;if("string"!=typeof a.type&&!a.anyOf&&!a.allOf&&!a.$ref)return{valid:!1,error:"'value' must have a 'type', 'anyOf', 'allOf', or '$ref'"};if(void 0!==n.strict&&"boolean"!=typeof n.strict)return{valid:!1,error:"'strict' must be a boolean if provided"};const o={errors:[],warnings:[],info:[],stats:{defCount:0,anyOfCount:0,totalAnyOfVariants:0,maxDepth:0,propertyCount:0,optionalFieldCount:0,enumCount:0},currentDepth:0,seenRefs:new Set,defs:{}};if(a.$defs&&"object"==typeof a.$defs?(o.defs=a.$defs,o.stats.defCount=Object.keys(o.defs).length):a.definitions&&"object"==typeof a.definitions&&(o.defs=a.definitions,o.stats.defCount=Object.keys(o.defs).length),o.stats.defCount>i&&o.errors.push(`Too many definitions: ${o.stats.defCount} (limit: ${i})`),b(a,"value",o),o.stats.optionalFieldCount>0){const e=o.stats.optionalFieldCount,r=o.stats.totalAnyOfVariants+2*e;e>10&&o.warnings.push(`${e} optional fields detected. Each spawns an implicit anyOf with null. Consider making fields required or reducing optionals.`),r>50&&o.warnings.push(`High anyOf count (~${r} including implicit nullables). May cause slow schema compilation or errors.`)}if(o.errors.length>0)return{valid:!1,error:o.errors.join("\n"),warnings:o.warnings.length>0?o.warnings:void 0};const s={name:n.name,strict:null===(r=n.strict)||void 0===r||r,value:a};return o.info.push(`Schema stats: ${o.stats.propertyCount} properties, ${o.stats.defCount} definitions, ${o.stats.anyOfCount} anyOf blocks, ${o.stats.optionalFieldCount} optional fields, max depth ${o.stats.maxDepth}`),{valid:!0,schema:s,warnings:o.warnings.length>0?o.warnings:void 0,info:o.info.length>0?o.info:void 0}}function b(e,r,t){if(t.currentDepth++,t.stats.maxDepth=Math.max(t.stats.maxDepth,t.currentDepth),t.currentDepth>o)return t.errors.push(`${r}: Exceeds maximum nesting depth of ${o}`),void t.currentDepth--;for(const n of m)void 0!==e[n]&&t.errors.push(`${r}: '${n}' is not supported`);for(const n of p)void 0!==e[n]&&t.warnings.push(`${r}: '${n}' will be ignored (not supported)`);for(const n of u)void 0!==e[n]&&t.warnings.push(`${r}: '${n}' will be ignored (not supported)`);for(const n of f)void 0!==e[n]&&t.warnings.push(`${r}: '${n}' will be ignored (not supported)`);for(const n of v)void 0!==e[n]&&t.warnings.push(`${r}: '${n}' will be ignored (not supported)`);if(e.$ref&&"string"==typeof e.$ref)return function(e,r,t){if(e.startsWith("http://")||e.startsWith("https://"))return void t.errors.push(`${r}: External $ref not supported ('${e}')`);if(t.seenRefs.has(e))return void t.info.push(`${r}: Circular reference to '${e}'`);t.seenRefs.add(e);const n=e.replace(/^#\/(\$defs|definitions)\//,"");t.defs[n]||t.errors.push(`${r}: Reference '${e}' not found in definitions`)}(e.$ref,r,t),void t.currentDepth--;const n=Array.isArray(e.type)?e.type:[e.type];for(const a of n)switch(a){case"object":y(e,r,t);break;case"array":_(e,r,t);break;case"string":x(e,r,t);break;case"number":case"integer":case"boolean":case"null":break;default:!a||e.anyOf||e.allOf||t.warnings.push(`${r}: Unknown type '${a}'`)}e.anyOf&&Array.isArray(e.anyOf)&&function(e,r,t){t.stats.anyOfCount++,t.stats.totalAnyOfVariants+=e.length,e.length>a&&t.errors.push(`${r}: anyOf has ${e.length} variants (max: ${a})`);if(0===e.length)return void t.errors.push(`${r}: anyOf cannot be empty`);e.forEach((e,n)=>{e&&"object"==typeof e&&b(e,`${r}.anyOf[${n}]`,t)})}(e.anyOf,r,t),e.allOf&&Array.isArray(e.allOf)&&function(e,r,t){if(0===e.length)return void t.errors.push(`${r}: allOf cannot be empty`);e.forEach((e,n)=>{if(e&&"object"==typeof e){const a=e;a.$ref&&t.errors.push(`${r}.allOf[${n}]: allOf with $ref not supported`),b(a,`${r}.allOf[${n}]`,t)}})}(e.allOf,r,t),e.enum&&Array.isArray(e.enum)&&function(e,r,t){if(t.stats.enumCount++,0===e.length)return void t.errors.push(`${r}: enum cannot be empty`);e.length>c&&t.warnings.push(`${r}: enum has ${e.length} values (may be slow)`);for(let n=0;n<e.length;n++){const a=e[n],i=typeof a;if("string"!==i&&"number"!==i&&"boolean"!==i&&null!==a){t.errors.push(`${r}.enum[${n}]: Complex type not allowed in enum (got ${i}). Only string, number, boolean, null permitted.`);break}}const n=new Set;for(const a of e){const e=JSON.stringify(a);if(n.has(e)){t.warnings.push(`${r}: Duplicate value in enum: ${e}`);break}n.add(e)}}(e.enum,r,t),void 0!==e.const&&function(e,r,t){const n=typeof e;"string"!==n&&"number"!==n&&"boolean"!==n&&null!==e&&t.errors.push(`${r}: const must be string, number, boolean, or null (got ${n})`)}(e.const,r,t),t.currentDepth--}function y(e,r,t){if(!1!==e.additionalProperties&&t.warnings.push(`${r}: Missing 'additionalProperties: false' (REQUIRED for Anthropic)`),e.properties&&"object"==typeof e.properties){const n=e.properties,a=Object.keys(n).length;t.stats.propertyCount+=a,a>s&&t.warnings.push(`${r}: ${a} properties (may be slow, consider splitting)`);const i=e.required||[];for(const[e,a]of Object.entries(n))i.includes(e)||t.stats.optionalFieldCount++,a&&"object"==typeof a&&b(a,`${r}.${e}`,t)}}function _(e,r,t){if(void 0!==e.minItems){d.includes(e.minItems)||t.warnings.push(`${r}: 'minItems: ${e.minItems}' not supported (only 0 or 1 allowed)`)}e.items&&("object"!=typeof e.items||Array.isArray(e.items)?Array.isArray(e.items)&&e.items.forEach((e,n)=>{e&&"object"==typeof e&&b(e,`${r}.items[${n}]`,t)}):b(e.items,`${r}.items`,t)),e.prefixItems&&Array.isArray(e.prefixItems)&&e.prefixItems.forEach((e,n)=>{e&&"object"==typeof e&&b(e,`${r}.prefixItems[${n}]`,t)})}function x(e,r,t){if(e.format&&"string"==typeof e.format){const n=l;n.includes(e.format)||t.warnings.push(`${r}: format '${e.format}' may not be supported. Supported: ${n.join(", ")}`)}e.pattern&&"string"==typeof e.pattern&&function(e,r,t){for(const{pattern:n,name:a}of g)n.test(e)&&t.errors.push(`${r}: Regex pattern uses unsupported feature: ${a}`);try{new RegExp(e)}catch(e){const n=e instanceof Error?e.message:"Invalid regex";t.errors.push(`${r}: Invalid regex pattern: ${n}`)}const n=/\{(\d+),(\d+)\}/g;let a;for(;null!==(a=n.exec(e));){const e=parseInt(a[1],10),n=parseInt(a[2],10);n-e>100&&t.warnings.push(`${r}: Large quantifier range {${e},${n}} may cause issues`)}}(e.pattern,r,t)}function w(e){const r=structuredClone(e);return void 0===r.strict&&(r.strict=!0),$(r.value),r}function $(e){if("object"===e.type&&(e.additionalProperties=!1,e.properties&&"object"==typeof e.properties))for(const r of Object.values(e.properties))r&&"object"==typeof r&&$(r);"array"===e.type&&e.items&&"object"==typeof e.items&&(Array.isArray(e.items)?e.items.forEach(e=>{e&&"object"==typeof e&&$(e)}):$(e.items)),e.anyOf&&Array.isArray(e.anyOf)&&e.anyOf.forEach(e=>{e&&"object"==typeof e&&$(e)}),e.allOf&&Array.isArray(e.allOf)&&e.allOf.forEach(e=>{e&&"object"==typeof e&&$(e)});const r=[];for(const t of p)void 0!==e[t]&&(r.push(`${t}: ${e[t]}`),delete e[t]);for(const t of u)void 0!==e[t]&&(r.push(`${t}: ${e[t]}`),delete e[t]);for(const t of f)void 0!==e[t]&&(r.push(`${t}: ${e[t]}`),delete e[t]);if(void 0!==e.minItems&&null!==e.minItems){const t=e.minItems;0!==t&&1!==t&&(r.push(`minItems: ${t}`),e.minItems=t>0?1:0)}if(r.length>0){const t=`[Constraints: ${r.join(", ")}]`;e.description?e.description=`${e.description} ${t}`:e.description=t}}function k(e){return e?JSON.stringify(e,null,2):""}function S(e,r){let t;try{t=JSON.parse(e)}catch(r){const n=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(!n)return null;try{t=JSON.parse(n[1].trim())}catch(e){return null}}const n=[];if(r&&r.value.required&&Array.isArray(r.value.required)){const e=r.value.required.filter(e=>!(e in t));e.length>0&&n.push(`Missing required fields: ${e.join(", ")}`)}return{data:t,warnings:n}}function P(e){return n(this,void 0,void 0,function*(){var r;const{generateSimple:n}=yield Promise.resolve().then(t.bind(t,179));if(!e.trim())return{success:!1,error:"Please describe what you want in the schema"};try{const t=yield n(`Generate a JSON Schema for structured LLM output based on the user's description.\n\nExample input: "rating 1-10, list of issues, summary"\nExample output: {"name": "Analysis", "strict": true, "value": {"type": "object", "additionalProperties": false, "properties": {"rating": {"type": "number"}, "issues": {"type": "array", "items": {"type": "string"}}, "summary": {"type": "string"}}, "required": ["rating", "issues", "summary"]}}\n\nRequirements:\n- Output ONLY valid JSON, no markdown, no explanation\n- Use this exact wrapper format: {"name": "SchemaName", "strict": true, "value": {...}}\n- The "value" must be a valid JSON Schema with "type": "object"\n- Add "additionalProperties": false to ALL object types (required for Anthropic)\n- All object properties should be in a "required" array unless explicitly optional\n- Use simple types: string, number, integer, boolean, array, object\n- For arrays, always specify "items" with a schema\n- Keep it minimal - only what the user asked for\n\nUser's description:\n\n${e}`,"You are a JSON Schema expert. Output only valid JSON, nothing else.");if(!t)return{success:!1,error:"Generation failed - no response received"};let a=t.trim();a.startsWith("```")&&(a=a.replace(/^```(?:json)?\s*/,"").replace(/\s*```$/,""));const i=h(a);if(!i.valid)return{success:!1,error:`Generated schema is invalid: ${i.error}`,schema:a};if(null===(r=i.warnings)||void 0===r?void 0:r.length){const e=w(i.schema);return{success:!0,schema:JSON.stringify(e,null,2)}}return{success:!0,schema:JSON.stringify(i.schema,null,2)}}catch(e){return{success:!1,error:`Generation failed: ${e.message}`}}})}},540(e){e.exports=function(e){var r=document.createElement("style");return e.setAttributes(r,e.attributes),e.insert(r,e.options),r}},601(e){e.exports=function(e){return e[1]}},659(e){var r={};e.exports=function(e,t){var n=function(e){if(void 0===r[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}r[e]=t}return r[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(t)}},691(e,r,t){t.d(r,{tB:()=>o,lp:()=>i,WC:()=>s,L$:()=>c,a$:()=>l,_j:()=>a,O0:()=>d,Gv:()=>p,$q:()=>G,QO:()=>Y,lo:()=>N,jT:()=>I,wI:()=>F,mW:()=>M,SK:()=>_,Bx:()=>q,bA:()=>U,mt:()=>u,hu:()=>h,sR:()=>y,wM:()=>W,PL:()=>x,Tx:()=>v,UN:()=>f,DV:()=>B,aQ:()=>J,RC:()=>b,Fc:()=>H,iO:()=>V,G1:()=>Q,tH:()=>K});var n=t(319);const a={promptPresetId:null,customPrompt:"",schemaPresetId:null,customSchema:"",useStructuredOutput:!1},i="You are a character card analyst and writer. You help improve roleplay character cards by providing specific, actionable feedback and high-quality rewrites.\n\nKey principles:\n- Preserve the character's core identity and unique traits\n- Be specific - vague feedback is useless\n- Quality over quantity - concise and impactful\n- Maintain consistency across all fields",o="You are refining a character card based on analysis feedback. Address identified issues while preserving what works.\n\nKey principles:\n- Fix specific problems from the analysis\n- Keep improvements from previous iterations\n- Maintain the character's essential identity\n- Don't reintroduce previously fixed issues",s=[{id:"builtin_score_default",name:"Default Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rate this character card on a scale of 1-10 for each field provided.\n\nFor each field:\n1. **Score** (1-10)\n2. **Strengths** - What works well\n3. **Weaknesses** - What needs improvement\n4. **Suggestions** - Concrete changes\n\nThen provide:\n- **Overall Score** (weighted average)\n- **Top 3 Priority Improvements**\n- **Summary**\n\nBe critical but constructive. Specific, actionable feedback only."},{id:"builtin_score_quick",name:"Quick Score",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Give a quick assessment:\n\n1. Overall score (1-10)\n2. Three biggest strengths\n3. Three areas needing work\n4. One-sentence summary\n\nKeep it concise but useful."},{id:"builtin_rewrite_default",name:"Default Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Rewrite this character card to address weaknesses while preserving strengths.\n\nGuidelines:\n- Maintain core personality and unique traits\n- Improve weak areas from feedback\n- Keep similar length unless noted\n- Preserve distinctive voice/style\n- Fix contradictions and fill gaps\n\nOutput the complete rewritten character with all fields."},{id:"builtin_rewrite_conservative",name:"Conservative Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Make minimal, surgical improvements. Only change what's clearly broken or weak.\n\nRules:\n- Change as little as possible\n- Preserve the author's voice completely\n- Only fix obvious issues (contradictions, grammar, clarity)\n- Do NOT add new content unless filling a critical gap\n- Do NOT change style or tone\n\nOutput only the fields you changed, with [ORIGINAL] and [REVISED] versions for comparison."},{id:"builtin_rewrite_expansive",name:"Expansive Rewrite",stages:["rewrite"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Significantly expand and enhance this character card. Add depth, detail, and richness.\n\nGoals:\n- Flesh out underdeveloped areas\n- Add sensory details and specific examples\n- Deepen personality with quirks, contradictions, history\n- Improve example messages with more variety\n- Make the character feel more three-dimensional\n\nDon't change the core concept, but make it shine. Output the complete expanded character card."},{id:"builtin_analyze_default",name:"Default Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the original character card with the rewritten version.\n\n## What Was Preserved\nCore traits, distinctive elements, voice consistency\n\n## What Was Lost\nDiminished aspects, missing quirks, tone shifts\n\n## What Was Gained\nNew depth, improvements, better clarity\n\n## Soul Check\nDoes the rewrite still feel like the same character? Rate 1-10.\n\n## Verdict\n**ACCEPT** (ready), **NEEDS_REFINEMENT** (has issues), or **REGRESSION** (worse)\n\n## Issues to Address\nIf NEEDS_REFINEMENT, list specific problems for next iteration."},{id:"builtin_analyze_iteration",name:"Iteration Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Compare the current rewrite against the original.\n\n## Progress Check\n- What issues from previous analysis were addressed?\n- What new issues (if any) were introduced?\n- Is this version better, worse, or lateral move?\n\n## Current State\n- Preserved from Original\n- Still Missing or Lost\n- Successfully Improved\n- New Problems\n\n## Soul Preservation Score (1-10)\n\n## Verdict\n**ACCEPT** - Ready, no more iterations needed\n**NEEDS_REFINEMENT** - Progress, but issues remain\n**REGRESSION** - Made things worse\n\n## Next Steps\nIf NEEDS_REFINEMENT: What to fix next.\nIf REGRESSION: What went wrong."},{id:"builtin_analyze_quick",name:"Quick Analyze",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,prompt:"Quick comparison:\n\n1. Soul preserved? (Yes/Partially/No)\n2. Best improvement made\n3. Biggest thing lost (if any)\n4. Verdict: ACCEPT / NEEDS_REFINEMENT / REGRESSION"}],c=[{id:"builtin_schema_score",name:"Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{fieldScores:{type:"array",items:{type:"object",additionalProperties:!1,properties:{field:{type:"string"},score:{type:"number"},strengths:{type:"string"},weaknesses:{type:"string"},suggestions:{type:"string"}},required:["field","score","strengths","weaknesses","suggestions"]}},overallScore:{type:"number"},priorityImprovements:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["fieldScores","overallScore","priorityImprovements","summary"]}}},{id:"builtin_schema_quick_score",name:"Quick Score Schema",stages:["score"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"QuickScore",strict:!0,value:{type:"object",additionalProperties:!1,properties:{overallScore:{type:"number"},strengths:{type:"array",items:{type:"string"}},weaknesses:{type:"array",items:{type:"string"}},summary:{type:"string"}},required:["overallScore","strengths","weaknesses","summary"]}}},{id:"builtin_schema_analyze",name:"Analyze Schema",stages:["analyze"],isBuiltin:!0,version:n.v7,createdAt:0,updatedAt:0,schema:{name:"CharacterAnalysis",strict:!0,value:{type:"object",additionalProperties:!1,properties:{preserved:{type:"array",items:{type:"string"}},lost:{type:"array",items:{type:"string"}},gained:{type:"array",items:{type:"string"}},soulScore:{type:"number"},soulAssessment:{type:"string"},verdict:{type:"string",enum:["ACCEPT","NEEDS_REFINEMENT","REGRESSION"]},issues:{type:"array",items:{type:"string"}},recommendations:{type:"array",items:{type:"string"}}},required:["preserved","lost","gained","soulScore","soulAssessment","verdict","issues","recommendations"]}}}],l={version:n.$G,baseSystemPrompt:i,userSystemPrompt:"",stageSystemPrompts:{score:"",rewrite:"",analyze:""},baseRefinementPrompt:o,userRefinementPrompt:"",stageDefaults:{score:Object.assign(Object.assign({},a),{promptPresetId:"builtin_score_default"}),rewrite:Object.assign(Object.assign({},a),{promptPresetId:"builtin_rewrite_default"}),analyze:Object.assign(Object.assign({},a),{promptPresetId:"builtin_analyze_default"})},promptPresets:[...s],schemaPresets:[...c],generationMode:"current",profileId:null,maxTokensOverride:null,debugMode:!1},d={version:n.F,lastMigration:Date.now()};function p(e,r,t){return{id:e,characterId:r,characterName:t,createdAt:Date.now(),updatedAt:Date.now(),stageFields:{base:{},linked:!0,overrides:{}},originalData:{},configs:{score:Object.assign({},a),rewrite:Object.assign({},a),analyze:Object.assign({},a)},history:[],iterationCount:0,status:"active",version:n.F}}function u(){var e;const r=SillyTavern.getContext(),{lodash:t}=SillyTavern.libs,a=r.extensionSettings;if(!a[n.pW])return a[n.pW]=t.cloneDeep(l),f(),a[n.pW];const i=a[n.pW],o=null!==(e=i.version)&&void 0!==e?e:0;if(o<n.$G){!function(e,r){for(let t=r+1;t<=n.$G;t++){const r=m[t];r&&r(e)}}(i,o);const e=function(e){const{lodash:r}=SillyTavern.libs,t=e.promptPresets?[...e.promptPresets]:[],n=e.schemaPresets?[...e.schemaPresets]:[],a=r.merge(structuredClone(l),e);return a.promptPresets=t.length?t:[...l.promptPresets],a.schemaPresets=n.length?n:[...l.schemaPresets],a}(i);return e.version=n.$G,g(e),a[n.pW]=e,f(),e}const s=i;s.promptPresets||(s.promptPresets=[]),s.schemaPresets||(s.schemaPresets=[]);return g(s)&&f(),s}function f(){SillyTavern.getContext().saveSettingsDebounced()}function v(){const{lodash:e}=SillyTavern.libs,r=SillyTavern.getContext().extensionSettings;return r[n.pW]=e.cloneDeep(l),f(),r[n.pW]}const m={};function g(e){const{lodash:r}=SillyTavern.libs;let t=!1;for(const n of s){const a=e.promptPresets.find(e=>e.id===n.id);a?a.version<n.version&&(Object.assign(a,r.cloneDeep(n)),t=!0):(e.promptPresets.push(r.cloneDeep(n)),t=!0)}for(const n of c){const a=e.schemaPresets.find(e=>e.id===n.id);a?a.version<n.version&&(Object.assign(a,r.cloneDeep(n)),t=!0):(e.schemaPresets.push(r.cloneDeep(n)),t=!0)}return t}function h(e){const{lodash:r}=SillyTavern.libs,t=u();return r.cloneDeep(t.stageDefaults[e])}function b(e,r){const{lodash:t}=SillyTavern.libs;u().stageDefaults[e]=t.cloneDeep(r),f()}function y(e){const r=u();return[r.baseSystemPrompt,r.userSystemPrompt,r.stageSystemPrompts[e]].filter(e=>e.trim()).join("\n\n")}function _(){const e=u();return[e.baseRefinementPrompt,e.userRefinementPrompt].filter(e=>e.trim()).join("\n\n")}const x=new class{constructor(){this.listeners=new Set,this.getPromptPresets=e=>{const r=u();return this.applyFilter(r.promptPresets,e)},this.getSchemaPresets=e=>{const r=u();return this.applyFilter(r.schemaPresets,e)},this.getPromptPreset=e=>{var r;return null!==(r=u().promptPresets.find(r=>r.id===e))&&void 0!==r?r:null},this.getSchemaPreset=e=>{var r;return null!==(r=u().schemaPresets.find(r=>r.id===e))&&void 0!==r?r:null},this.getPresetsForStage=(e,r)=>"prompt"===e?this.getPromptPresets({stage:r}):this.getSchemaPresets({stage:r}),this.exists=(e,r)=>"prompt"===e?null!==this.getPromptPreset(r):null!==this.getSchemaPreset(r),this.isBuiltin=(e,r)=>{var t;const n="prompt"===e?this.getPromptPreset(r):this.getSchemaPreset(r);return null!==(t=null==n?void 0:n.isBuiltin)&&void 0!==t&&t},this.registerPromptPreset=e=>{const r=u(),t=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return r.promptPresets.push(t),f(),this.emit({type:"add",presetType:"prompt",preset:t}),t},this.registerSchemaPreset=e=>{const r=u(),t=Object.assign(Object.assign({},e),{id:crypto.randomUUID(),isBuiltin:!1,version:n.v7,createdAt:Date.now(),updatedAt:Date.now()});return r.schemaPresets.push(t),f(),this.emit({type:"add",presetType:"schema",preset:t}),t},this.updatePromptPreset=(e,r)=>{const t=u().promptPresets.find(r=>r.id===e);if(!t||t.isBuiltin)return!1;const n=Object.assign({},t);return Object.assign(t,r,{updatedAt:Date.now()}),f(),this.emit({type:"update",presetType:"prompt",preset:t,previousValue:n}),!0},this.updateSchemaPreset=(e,r)=>{const t=u().schemaPresets.find(r=>r.id===e);if(!t||t.isBuiltin)return!1;const n=Object.assign({},t);return Object.assign(t,r,{updatedAt:Date.now()}),f(),this.emit({type:"update",presetType:"schema",preset:t,previousValue:n}),!0},this.deletePromptPreset=e=>{const r=u(),t=r.promptPresets.findIndex(r=>r.id===e&&!r.isBuiltin);if(-1===t)return!1;const[n]=r.promptPresets.splice(t,1);return f(),this.emit({type:"delete",presetType:"prompt",preset:n}),!0},this.deleteSchemaPreset=e=>{const r=u(),t=r.schemaPresets.findIndex(r=>r.id===e&&!r.isBuiltin);if(-1===t)return!1;const[n]=r.schemaPresets.splice(t,1);return f(),this.emit({type:"delete",presetType:"schema",preset:n}),!0},this.duplicatePromptPreset=(e,r)=>{const t=this.getPromptPreset(e);if(!t)return null;const n=r||`${t.name} (Copy)`;return this.registerPromptPreset({name:n,stages:[...t.stages],prompt:t.prompt})},this.duplicateSchemaPreset=(e,r)=>{const t=this.getSchemaPreset(e);if(!t)return null;const{lodash:n}=SillyTavern.libs,a=r||`${t.name} (Copy)`;return this.registerSchemaPreset({name:a,stages:[...t.stages],schema:n.cloneDeep(t.schema)})},this.subscribe=e=>(this.listeners.add(e),()=>this.listeners.delete(e)),this.isNameUnique=(e,r,t)=>!("prompt"===e?this.getPromptPresets():this.getSchemaPresets()).some(e=>e.name.toLowerCase()===r.toLowerCase()&&e.id!==t),this.generateUniqueName=(e,r)=>{let t=r,n=1;for(;!this.isNameUnique(e,t);)t=`${r} (${n})`,n++;return t},this.getDisplayName=(e,r)=>{if(!r)return"Custom";const t="prompt"===e?this.getPromptPreset(r):this.getSchemaPreset(r);return t?t.isBuiltin?`${t.name} (builtin)`:t.name:"Unknown"}}applyFilter(e,r){return r?e.filter(e=>{if(r.stage){if(!(0===e.stages.length||e.stages.includes(r.stage)))return!1}return!(r.builtinOnly&&!e.isBuiltin)&&(!r.userOnly||!e.isBuiltin)}):e}emit(e){for(const r of this.listeners)try{r(e)}catch(e){console.error("[PresetRegistry] Listener error:",e)}}},{getPromptPresets:w,getSchemaPresets:$,getPromptPreset:k,getSchemaPreset:S,getPresetsForStage:P,registerPromptPreset:R,registerSchemaPreset:C,updatePromptPreset:T,updateSchemaPreset:z,deletePromptPreset:O,deleteSchemaPreset:E,duplicatePromptPreset:A,duplicateSchemaPreset:j,isNameUnique:W,generateUniqueName:N,getDisplayName:I,subscribe:D}=x;var L=t(374);function M(e){return w({stage:e})}function F(e){return k(e)}function B(e){return R(e)}function H(e,r){return T(e,r)}function G(e){return O(e)}function U(e){return $({stage:e})}function q(e){return S(e)}function J(e){return C(e)}function V(e,r){return z(e,r)}function Y(e){return E(e)}function Q(e){var r,t;const n=[],a=[];return(null===(r=e.name)||void 0===r?void 0:r.trim())?e.name.length>100&&n.push("Name must be 100 characters or less"):n.push("Name is required"),(null===(t=e.prompt)||void 0===t?void 0:t.trim())?e.prompt.length>5e4&&n.push("Prompt is too long (max 50,000 characters)"):n.push("Prompt is required"),e.prompt&&/\{\{user\}\}/i.test(e.prompt)&&a.push("{{user}} is not replaced - user persona is not relevant to card analysis"),{valid:0===n.length,errors:n,warnings:a}}function K(e){var r;const t=[],n=[];if((null===(r=e.name)||void 0===r?void 0:r.trim())?e.name.length>100&&t.push("Name must be 100 characters or less"):t.push("Name is required"),e.schema){const r="string"==typeof e.schema?e.schema:JSON.stringify(e.schema),a=(0,L.i6)(r);a.valid||t.push(a.error||"Invalid schema"),a.warnings&&n.push(...a.warnings)}else t.push("Schema is required");return{valid:0===t.length,errors:t,warnings:n}}},737(e,r,t){t.d(r,{BASE_REFINEMENT_PROMPT:()=>n.tB,BASE_SYSTEM_PROMPT:()=>n.lp,BUILTIN_PROMPT_PRESETS:()=>n.WC,BUILTIN_SCHEMA_PRESETS:()=>n.L$,DEFAULT_SETTINGS:()=>n.a$,DEFAULT_STAGE_CONFIG:()=>n._j,DEFAULT_STORAGE_META:()=>n.O0,clearCache:()=>s,createDefaultSession:()=>n.Gv,createSession:()=>_,deleteAllSessionsForCharacter:()=>$,deletePromptPreset:()=>n.$q,deleteSchemaPreset:()=>n.QO,deleteSession:()=>w,generateUniquePresetName:()=>n.lo,getPresetDisplayName:()=>n.jT,getPromptPreset:()=>n.wI,getPromptPresetsForStage:()=>n.mW,getRefinementPrompt:()=>n.SK,getSchemaPreset:()=>n.Bx,getSchemaPresetsForStage:()=>n.bA,getSession:()=>y,getSessionCount:()=>S,getSessionsForCharacter:()=>b,getSettings:()=>n.mt,getStageDefaults:()=>n.hu,getSystemPrompt:()=>n.sR,isPresetNameUnique:()=>n.wM,presetRegistry:()=>n.PL,renameSession:()=>k,resetSettings:()=>n.Tx,save:()=>n.UN,savePromptPreset:()=>n.DV,saveSchemaPreset:()=>n.aQ,setStageDefaults:()=>n.RC,updatePromptPreset:()=>n.Fc,updateSchemaPreset:()=>n.iO,updateSession:()=>x,validatePromptPreset:()=>n.G1,validateSchemaPreset:()=>n.tH}),t.r(r);var n=t(691);let a=null,i=null,o=null;function s(){a=null,i=null,o=null}function c(){return a}function l(){return i}function d(e){o=e}var p=t(319),u=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function f(){return u(this,void 0,void 0,function*(){if(o)return o;const e=yield(0,p.Ar)(p.d5.STORAGE_META);if(!e){const e={version:p.F,lastMigration:Date.now()};return d(e),yield(0,p.RG)(p.d5.STORAGE_META,e),e}return e.version!==p.F&&(yield function(e){return u(this,void 0,void 0,function*(){var r;const t=null!==(r=e.version)&&void 0!==r?r:0;if(t<2){const e=yield(0,p.Ar)(p.d5.SESSIONS);if(e){let r=!1;for(const t of Object.values(e))if(!t.stageFields&&t.selectedFields){const e=t.selectedFields;t.stageFields={base:e,linked:!0,overrides:{}},delete t.selectedFields,r=!0}r&&(yield(0,p.RG)(p.d5.SESSIONS,e))}}e.version=p.F,e.lastMigration=Date.now(),yield(0,p.RG)(p.d5.STORAGE_META,e)})}(e)),d(e),e})}function v(){return u(this,void 0,void 0,function*(){const e=c();if(e)return e;yield f();const r=yield(0,p.Ar)(p.d5.SESSIONS),t=new Map(Object.entries(null!=r?r:{}));return function(e){a=e}(t),t})}function m(){return u(this,void 0,void 0,function*(){var e;const r=l();if(r)return r;yield f();const t=null!==(e=yield(0,p.Ar)(p.d5.SESSION_INDEX))&&void 0!==e?e:{};return i=t,t})}function g(){return u(this,void 0,void 0,function*(){const e=c();e&&(yield(0,p.RG)(p.d5.SESSIONS,Object.fromEntries(e)))})}function h(){return u(this,void 0,void 0,function*(){const e=l();e&&(yield(0,p.RG)(p.d5.SESSION_INDEX,e))})}function b(e){return u(this,void 0,void 0,function*(){var r;const t=yield v();return(null!==(r=(yield m())[e])&&void 0!==r?r:[]).map(e=>t.get(e)).filter(e=>void 0!==e)})}function y(e){return u(this,void 0,void 0,function*(){var r;return null!==(r=(yield v()).get(e))&&void 0!==r?r:null})}function _(e){return u(this,void 0,void 0,function*(){const{characterId:r,characterName:t,stageFields:a,originalData:i,configs:o}=e,s=yield v(),c=yield m(),l=SillyTavern.libs.lodash,d=(0,n.Gv)(crypto.randomUUID(),r,t);if(d.stageFields=l.cloneDeep(a),d.originalData=l.cloneDeep(i),d.configs=l.cloneDeep(o),s.set(d.id,d),c[r]||(c[r]=[]),c[r].unshift(d.id),c[r].length>p.Nf){const e=c[r].splice(p.Nf);for(const r of e)s.delete(r)}return yield g(),yield h(),d})}function x(e){return u(this,void 0,void 0,function*(){const r=yield v();e.updatedAt=Date.now(),r.set(e.id,e),yield g()})}function w(e){return u(this,void 0,void 0,function*(){const r=yield v(),t=yield m(),n=r.get(e);if(!n)return;r.delete(e);const a=t[n.characterId];if(a){const r=a.indexOf(e);-1!==r&&a.splice(r,1),0===a.length&&delete t[n.characterId]}yield g(),yield h()})}function $(e){return u(this,void 0,void 0,function*(){var r;const t=yield v(),n=yield m(),a=null!==(r=n[e])&&void 0!==r?r:[];for(const e of a)t.delete(e);delete n[e],yield g(),yield h()})}function k(e,r){return u(this,void 0,void 0,function*(){const t=yield y(e);t&&(t.name=r.trim()||void 0,yield x(t))})}function S(e){return u(this,void 0,void 0,function*(){var r,t;return null!==(t=null===(r=(yield m())[e])||void 0===r?void 0:r.length)&&void 0!==t?t:0})}},805(e,r,t){t.d(r,{A:()=>s});var n=t(601),a=t.n(n),i=t(314),o=t.n(i)()(a());o.push([e.id,'.cr-drawer,.cr-popup,.cr-settings-modal{--cr-bg:var(--SmartThemeBlurTintColor);--cr-bg-secondary:var(--black30a,rgba(0,0,0,.3));--cr-bg-tertiary:var(--black50a,rgba(0,0,0,.5));--cr-bg-elevated:color-mix(in srgb,var(--SmartThemeBlurTintColor) 90%,#fff 10%);--cr-text:var(--SmartThemeBodyColor);--cr-text-muted:color-mix(in srgb,var(--SmartThemeBodyColor) 70%,transparent);--cr-text-dim:color-mix(in srgb,var(--SmartThemeBodyColor) 50%,transparent);--cr-border:var(--SmartThemeBorderColor);--cr-border-muted:color-mix(in srgb,var(--SmartThemeBorderColor) 50%,transparent);--cr-accent:var(--SmartThemeQuoteColor);--cr-accent-hover:color-mix(in srgb,var(--SmartThemeQuoteColor) 80%,#fff);--cr-accent-muted:color-mix(in srgb,var(--SmartThemeQuoteColor) 30%,transparent);--cr-success:var(--okGreen70a,#4caf50);--cr-success-bg:color-mix(in srgb,var(--okGreen70a,#4caf50) 15%,transparent);--cr-warning:var(--golden,#ff9800);--cr-warning-bg:color-mix(in srgb,var(--golden,#ff9800) 15%,transparent);--cr-danger:var(--fullred,#f44336);--cr-danger-bg:color-mix(in srgb,var(--fullred,#f44336) 15%,transparent);--cr-space-1:0.25rem;--cr-space-2:0.5rem;--cr-space-3:0.75rem;--cr-space-4:1rem;--cr-space-5:1.25rem;--cr-space-6:1.5rem;--cr-space-8:2rem;--cr-space-12:3rem;--cr-font:var(--mainFontFamily,system-ui,-apple-system,sans-serif);--cr-font-mono:var(--monoFontFamily,"Consolas","Monaco",monospace);--cr-font-size:var(--mainFontSize,1rem);--cr-text-xs:calc(var(--cr-font-size) * 0.75);--cr-text-sm:calc(var(--cr-font-size) * 0.875);--cr-text-base:var(--cr-font-size);--cr-text-lg:calc(var(--cr-font-size) * 1.125);--cr-text-xl:calc(var(--cr-font-size) * 1.25);--cr-radius-sm:4px;--cr-radius:8px;--cr-radius-lg:12px;--cr-radius-pill:9999px;--cr-shadow-sm:0 1px 3px var(--black30a,rgba(0,0,0,.3));--cr-shadow:0 4px 12px var(--black30a,rgba(0,0,0,.3));--cr-shadow-lg:0 8px 24px var(--black50a,rgba(0,0,0,.5));--cr-transition-fast:var(--animation-duration,150ms) ease;--cr-transition:var(--animation-duration-slow,300ms) ease;--cr-panel-min:280px;--cr-panel-max:480px;--cr-header-height:48px}.cr-popup{font-family:var(--cr-font);font-size:var(--cr-font-size);color:var(--cr-text);line-height:1.5;box-sizing:border-box}.cr-popup *,.cr-popup :after,.cr-popup :before{box-sizing:inherit}.cr-popup h1,.cr-popup h2,.cr-popup h3,.cr-popup h4{margin:0;font-weight:600;line-height:1.3;color:var(--cr-text)}.cr-popup h2{font-size:var(--cr-text-lg)}.cr-popup h3{font-size:var(--cr-text-base)}.cr-popup h4{font-size:var(--cr-text-sm)}.cr-popup a{color:var(--cr-accent);text-decoration:none}.cr-popup a:hover{text-decoration:underline}.cr-stack{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-stack--tight{gap:var(--cr-space-2)}.cr-stack--loose{gap:var(--cr-space-4)}.cr-row{display:flex;flex-direction:row;align-items:center;gap:var(--cr-space-2)}.cr-row--wrap{flex-wrap:wrap}.cr-row--between{justify-content:space-between}.cr-row--end{justify-content:flex-end}.cr-row--stretch{align-items:stretch}.cr-grid{display:grid;gap:var(--cr-space-3)}.cr-grid--2col{grid-template-columns:repeat(2,1fr)}@media (max-width:600px){.cr-grid--2col{grid-template-columns:1fr}}.cr-flex-1{flex:1 1 0%}.cr-flex-auto{flex:1 1 auto}.cr-flex-none{flex:none}.cr-shrink-0{flex-shrink:0}.cr-gap-1{gap:var(--cr-space-1)}.cr-gap-2{gap:var(--cr-space-2)}.cr-gap-3{gap:var(--cr-space-3)}.cr-gap-4{gap:var(--cr-space-4)}.cr-p-2{padding:var(--cr-space-2)}.cr-p-3{padding:var(--cr-space-3)}.cr-p-4{padding:var(--cr-space-4)}.cr-mt-2{margin-top:var(--cr-space-2)}.cr-mt-3{margin-top:var(--cr-space-3)}.cr-mt-4{margin-top:var(--cr-space-4)}.cr-mt-auto{margin-top:auto}.cr-mb-2{margin-bottom:var(--cr-space-2)}.cr-mb-3{margin-bottom:var(--cr-space-3)}.cr-mb-4{margin-bottom:var(--cr-space-4)}.cr-ml-auto{margin-left:auto}.cr-mr-auto{margin-right:auto}.cr-w-full{width:100%}.cr-min-w-0{min-width:0}.cr-overflow-auto{overflow:auto}.cr-overflow-hidden{overflow:hidden}.cr-overflow-y-auto,.cr-scrollable{overflow-y:auto}.cr-scrollable{scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-scrollable::-webkit-scrollbar{width:6px;height:6px}.cr-scrollable::-webkit-scrollbar-track{background:transparent}.cr-scrollable::-webkit-scrollbar-thumb{background:var(--cr-border);border-radius:var(--cr-radius-pill)}.cr-scrollable::-webkit-scrollbar-thumb:hover{background:var(--cr-accent)}.cr-text-muted{color:var(--cr-text-muted)}.cr-text-dim{color:var(--cr-text-dim)}.cr-text-accent{color:var(--cr-accent)}.cr-text-success{color:var(--cr-success)}.cr-text-warning{color:var(--cr-warning)}.cr-text-danger{color:var(--cr-danger)}.cr-text-xs{font-size:var(--cr-text-xs)}.cr-text-sm{font-size:var(--cr-text-sm)}.cr-text-lg{font-size:var(--cr-text-lg)}.cr-text-mono{font-family:var(--cr-font-mono)}.cr-text-center{text-align:center}.cr-text-right{text-align:right}.cr-font-medium{font-weight:500}.cr-font-semibold{font-weight:600}.cr-truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.cr-hidden{display:none!important}.cr-sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.cr-popup{display:flex;flex-direction:column;width:100%;height:100%;min-height:0;background:var(--cr-bg);overflow:hidden}.popup:has(.cr-popup){width:95dvw;max-width:1200px;height:90dvh;max-height:none;padding:0;border-radius:var(--cr-radius-lg);overflow:hidden}.popup:has(.cr-popup)>.popup-content,.popup:has(.cr-popup)>div:first-child{display:flex;flex-direction:column;height:100%;padding:0;margin:0}@media (max-width:768px){.popup:has(.cr-popup){width:100dvw;height:100dvh;max-width:none;border-radius:0}}.cr-body{display:flex;flex-direction:column;flex:1;min-height:0}@media (min-width:769px){.cr-body{flex-direction:row}}.cr-panel{display:flex;flex-direction:column;min-height:0;min-width:0}.cr-panel--config,.cr-panel--left{flex:1 1 auto;border-bottom:1px solid var(--cr-border-muted);overflow-y:auto}@media (min-width:769px){.cr-panel--config,.cr-panel--left{flex:0 0 clamp(var(--cr-panel-min),38%,var(--cr-panel-max));border-bottom:none;border-right:1px solid var(--cr-border-muted)}}.cr-panel--results,.cr-panel--right{flex:1 1 auto;overflow:hidden}@media (min-width:769px){.cr-panel--results,.cr-panel--right{flex:1 1 62%}}.cr-panel__content{flex:1;min-height:0;overflow-y:auto;padding:var(--cr-space-3)}.cr-section{display:flex;flex-direction:column;gap:var(--cr-space-3);padding:var(--cr-space-3);padding-top:0;border-bottom:1px solid var(--cr-border)}.cr-section:last-child{border-bottom:none}.cr-section__header{justify-content:space-between;margin:0 calc(-1 * var(--cr-space-3));margin-bottom:0;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted)}.cr-section__header,.cr-section__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-section__title{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);text-transform:uppercase;letter-spacing:.025em}.cr-section__title i{color:var(--cr-accent);font-size:var(--cr-text-sm);width:1.25em;text-align:center}.cr-section__actions{display:flex;gap:var(--cr-space-1)}.cr-card{background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);overflow:hidden}.cr-card--interactive{cursor:pointer;transition:background var(--cr-transition-fast),border-color var(--cr-transition-fast)}.cr-card--interactive:hover{background:var(--cr-bg-tertiary);border-color:var(--cr-border)}.cr-card--selected{background:var(--cr-accent-muted);border-color:var(--cr-accent)}.cr-header{position:relative;z-index:100;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;min-height:var(--cr-header-height);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;gap:var(--cr-space-3)}.cr-header__left{display:flex;align-items:center;justify-content:flex-start}.cr-header__center{display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2)}.cr-header__center i{color:var(--cr-accent);font-size:var(--cr-text-lg)}.cr-header__center h2{font-size:var(--cr-text-base);font-weight:600;white-space:nowrap}.cr-header__right{justify-content:flex-end;gap:var(--cr-space-2)}.cr-header__right,.cr-toolbar{display:flex;align-items:center}.cr-toolbar{justify-content:space-between;gap:var(--cr-space-2) var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-4);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0;flex-wrap:wrap}@media (max-width:900px){.cr-toolbar{gap:var(--cr-space-2)}}.cr-toolbar__controls{display:flex;align-items:center;gap:var(--cr-space-2);flex-wrap:wrap;flex-shrink:0}.cr-pipeline-controls{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-pipeline-controls__main{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-pipeline-controls--generating{padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-radius:var(--cr-radius);flex-direction:row}.cr-pipeline-status{font-size:var(--cr-text-sm);color:var(--cr-accent)}.cr-iteration-row,.cr-pipeline-status{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-iteration-row{padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-radius:var(--cr-radius);border-left:3px solid var(--cr-accent)}.cr-iteration-row__label{display:flex;align-items:center;gap:var(--cr-space-1);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-accent);white-space:nowrap}.cr-iteration-row__input,.cr-iteration-row__label i{font-size:var(--cr-text-xs)}.cr-iteration-row__input{flex:1;min-width:150px;max-width:300px;padding:var(--cr-space-1) var(--cr-space-2);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);transition:border-color var(--cr-transition-fast)}.cr-iteration-row__input:focus{border-color:var(--cr-accent);outline:none}.cr-iteration-row__input::-moz-placeholder{color:var(--cr-text-muted);font-style:italic}.cr-iteration-row__input::placeholder{color:var(--cr-text-muted);font-style:italic}.cr-tabs{padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);overflow-x:auto}.cr-tab,.cr-tabs{display:flex;gap:var(--cr-space-2)}.cr-tab{flex:1;align-items:center;justify-content:center;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);white-space:nowrap}.cr-tab:hover{color:var(--cr-text);background:var(--cr-bg-tertiary)}.cr-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-tab__icon{font-size:1em}.cr-tab__badge{font-size:var(--cr-text-xs);padding:.1em .5em;background:var(--cr-accent-muted);color:var(--cr-accent);border-radius:var(--cr-radius-pill)}.cr-stage-tabs{display:flex;gap:var(--cr-space-1);flex:1 1 auto;min-width:-moz-fit-content;min-width:fit-content}.cr-stage-tab{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:transparent;border:1px solid transparent;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);white-space:nowrap}.cr-stage-tab:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}.cr-stage-tab--active{color:var(--cr-text);background:var(--cr-bg);border-color:var(--cr-accent);box-shadow:var(--cr-shadow-sm)}.cr-stage-tab__icon{font-size:1em;flex-shrink:0}.cr-stage-tab__label{flex:1 1 auto;min-width:-moz-max-content;min-width:max-content}.cr-stage-tab__status{display:flex;align-items:center;justify-content:center;width:1.25em;height:1.25em;font-size:.75em;border-radius:50%;flex-shrink:0}.cr-stage-tab--running .cr-stage-tab__status{color:var(--cr-accent)}.cr-stage-tab--complete .cr-stage-tab__status{color:var(--cr-success);background:var(--cr-success-bg)}.cr-stage-tab--error .cr-stage-tab__status{color:var(--cr-danger);background:var(--cr-danger-bg)}.cr-dropdown{position:relative;min-width:200px;max-width:280px}.cr-dropdown--session{min-width:180px}.cr-dropdown--disabled .cr-dropdown__trigger{opacity:.5;cursor:not-allowed}.cr-dropdown--open .cr-dropdown__trigger{border-color:var(--cr-accent);border-bottom-left-radius:0;border-bottom-right-radius:0}.cr-dropdown--open .cr-dropdown__trigger-chevron{transform:rotate(180deg)}.cr-dropdown--open .cr-dropdown__panel{display:flex}.cr-dropdown__trigger{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);color:var(--cr-text);background:var(--cr-bg);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-dropdown__trigger:hover{border-color:var(--cr-accent)}.cr-dropdown__trigger--session{gap:var(--cr-space-2)}.cr-dropdown__trigger-avatar{width:24px;height:24px;border-radius:var(--cr-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.cr-dropdown__trigger-icon{width:24px;text-align:center;color:var(--cr-text-muted);flex-shrink:0}.cr-dropdown__trigger-text{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-dropdown__trigger-text--placeholder{color:var(--cr-text-muted)}.cr-dropdown__trigger-chevron{font-size:.75em;color:var(--cr-text-muted);transition:transform var(--cr-transition-fast);flex-shrink:0}.cr-dropdown__count{background:var(--cr-accent-muted);color:var(--cr-accent);padding:2px 6px;border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);font-weight:600}.cr-dropdown__panel{position:absolute;top:100%;left:0;right:0;min-width:320px;z-index:1000;display:none;flex-direction:column;background:var(--SmartThemeChatBg,#1a1a1a);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--cr-accent);border-top:none;border-bottom-left-radius:var(--cr-radius);border-bottom-right-radius:var(--cr-radius);box-shadow:var(--cr-shadow-lg);max-height:400px;overflow:hidden}.cr-dropdown__panel--session{min-width:280px;max-height:320px}.cr-dropdown__search{position:relative;padding:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted)}.cr-dropdown__search-icon{position:absolute;left:calc(var(--cr-space-2) + var(--cr-space-2));top:50%;transform:translateY(-50%);color:var(--cr-text-muted);font-size:var(--cr-text-xs);pointer-events:none}.cr-dropdown__search-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);padding-left:calc(var(--cr-space-3) * 2 + .75em);font-size:var(--cr-text-sm);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-dropdown__search-input:focus{border-color:var(--cr-accent);outline:none}.cr-dropdown__search-clear{position:absolute;right:calc(var(--cr-space-2) + var(--cr-space-1));top:50%;transform:translateY(-50%);padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;opacity:.7}.cr-dropdown__search-clear:hover{opacity:1;color:var(--cr-text)}.cr-dropdown__list{flex:1;overflow-y:auto;max-height:320px;padding:var(--cr-space-2);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-dropdown__list--session{max-height:220px}.cr-dropdown__empty{padding:var(--cr-space-6);text-align:center;font-size:var(--cr-text-sm);color:var(--cr-text-muted)}.cr-dropdown__empty i{display:block;font-size:2em;margin-bottom:var(--cr-space-2);opacity:.5}.cr-dropdown__footer{padding:var(--cr-space-2);border-top:1px solid var(--cr-border-muted)}.cr-dropdown__new-btn{width:100%;justify-content:center}.cr-char-option{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);cursor:pointer;border-radius:var(--cr-radius);background:var(--cr-bg-secondary);border:1px solid transparent;transition:background var(--cr-transition-fast),border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast),transform var(--cr-transition-fast)}.cr-char-option:hover{background:var(--cr-bg-tertiary);border-color:var(--cr-border);transform:translateX(2px)}.cr-char-option--selected{border-color:var(--cr-accent)}.cr-char-option--selected,.cr-char-option--selected:hover{background:var(--cr-accent-muted)}.cr-char-option--highlighted{background:var(--cr-bg-tertiary);border-color:var(--cr-accent);box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-char-option__avatar-wrap{position:relative;flex-shrink:0}.cr-char-option__avatar{width:48px;height:48px;border-radius:var(--cr-radius);-o-object-fit:cover;object-fit:cover;border:2px solid var(--cr-border-muted);transition:border-color var(--cr-transition-fast)}.cr-char-option--selected .cr-char-option__avatar,.cr-char-option:hover .cr-char-option__avatar{border-color:var(--cr-accent)}.cr-char-option__check{position:absolute;bottom:-4px;right:-4px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;background:var(--cr-accent);color:var(--cr-bg);border-radius:50%;font-size:10px;box-shadow:0 2px 4px rgba(0,0,0,.3)}.cr-char-option__info{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}.cr-char-option__name{font-size:var(--cr-text-sm);font-weight:600;color:var(--cr-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-char-option__desc{font-size:var(--cr-text-xs);color:var(--cr-text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.cr-char-option__meta{display:flex;align-items:center;gap:var(--cr-space-1);font-size:10px;color:var(--cr-text-muted);margin-top:2px}.cr-char-option__meta i{font-size:9px;opacity:.7}.cr-session-option{display:flex;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background .15s ease}.cr-session-option:last-child{border-bottom:none}.cr-session-option:hover{background:var(--cr-bg-tertiary)}.cr-session-option--active,.cr-session-option--active:hover{background:var(--cr-accent-muted)}.cr-session-option__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px}.cr-session-option__name{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cr-session-option__indicator{font-size:6px;color:var(--cr-accent);flex-shrink:0}.cr-session-option__name-input{flex:1;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-sm);border:1px solid var(--cr-accent);border-radius:var(--cr-radius-sm);background:var(--cr-bg);color:var(--cr-text);outline:none}.cr-session-option__name-input:focus{box-shadow:0 0 0 2px var(--cr-accent-muted)}.cr-session-option__meta{display:flex;gap:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-session-option__meta span:after{content:"•";margin-left:var(--cr-space-2);opacity:.5}.cr-session-option__meta span:last-child:after{display:none}.cr-session-option__actions{display:flex;gap:2px;opacity:0;transition:opacity .15s ease}.cr-session-option__actions--editing{opacity:1}.cr-session-option__actions .menu_button--ghost{padding:var(--cr-space-1)}.cr-session-option__actions .menu_button--ghost:hover{background:var(--cr-bg-secondary)}.cr-session-option__actions .cr-session-delete:hover{color:var(--cr-danger)}.cr-session-option:hover .cr-session-option__actions{opacity:1}.cr-popup input[type=number],.cr-popup input[type=search],.cr-popup input[type=text],.cr-popup select,.cr-popup textarea{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);transition:border-color var(--cr-transition-fast)}.cr-popup input[type=number]:focus,.cr-popup input[type=search]:focus,.cr-popup input[type=text]:focus,.cr-popup select:focus,.cr-popup textarea:focus{border-color:var(--cr-accent);outline:none}.cr-popup textarea{min-height:100px;resize:vertical;line-height:1.5}.cr-popup textarea.cr-textarea--code{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs)}.cr-search{position:relative}.cr-search__icon{position:absolute;left:var(--cr-space-3);top:50%;transform:translateY(-50%);color:var(--cr-text-muted);pointer-events:none}.cr-search__input{padding-left:calc(var(--cr-space-3) * 2 + 1em)}.cr-search__clear{position:absolute;right:var(--cr-space-1);top:50%;transform:translateY(-50%);padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;opacity:.7;transition:opacity var(--cr-transition-fast)}.cr-search__clear:hover{opacity:1;color:var(--cr-text)}.cr-checkbox{display:flex;align-items:center;gap:var(--cr-space-2);cursor:pointer;font-size:var(--cr-text-sm)}.cr-checkbox input[type=checkbox]{width:auto;accent-color:var(--cr-accent)}.cr-form-group{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-form-group__label{font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text)}.cr-form-group__hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-form-group--grow{flex:1;display:flex;flex-direction:column;min-height:0}.cr-select{width:auto;min-width:120px;padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);font-family:var(--cr-font);color:var(--cr-text);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm);cursor:pointer;transition:border-color var(--cr-transition-fast)}.cr-select:focus,.cr-select:hover{border-color:var(--cr-accent);outline:none}.cr-textarea--editor{width:100%;height:100%;min-height:200px;resize:vertical;font-family:var(--cr-font);font-size:var(--cr-text-sm);line-height:1.6}.cr-textarea--compact{min-height:60px}.cr-editor-wrap{position:relative;flex:1;min-height:200px}.cr-editor-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border-muted);border-bottom:none;border-radius:var(--cr-radius) var(--cr-radius) 0 0}.cr-toolbar-divider{width:1px;height:1.5em;background:var(--cr-border-muted);margin:0 var(--cr-space-1)}.cr-code-editor{position:relative;flex:1;min-height:250px;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;border:1px solid var(--cr-border);border-top:none;border-radius:0 0 var(--cr-radius) var(--cr-radius);overflow:hidden}.cr-code-editor__highlight,.cr-code-editor__textarea{position:absolute;inset:0;margin:0;padding:var(--cr-space-3);font-family:inherit;font-size:inherit;line-height:inherit;white-space:pre-wrap;word-wrap:break-word;overflow:auto}.cr-code-editor__highlight{pointer-events:none;background:var(--cr-bg-secondary);color:var(--cr-text)}.cr-code-editor__highlight code{font-family:inherit;background:transparent}.cr-code-editor__textarea{background:transparent;color:transparent;caret-color:var(--cr-text);resize:none;border:none;outline:none;z-index:1}.cr-code-editor__textarea::-moz-selection{background:var(--cr-accent-muted)}.cr-code-editor__textarea::selection{background:var(--cr-accent-muted)}.cr-code-editor .hljs-string{color:var(--cr-success)}.cr-code-editor .hljs-number{color:var(--cr-warning)}.cr-code-editor .hljs-literal{color:var(--cr-accent)}.cr-code-editor .hljs-attr{color:var(--cr-text)}.cr-code-editor .hljs-punctuation{color:var(--cr-text-muted)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button{display:inline-flex;align-items:center;justify-content:center;gap:var(--cr-space-1);padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;white-space:nowrap;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast);width:auto;min-width:auto;margin:0}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--icon{padding:var(--cr-space-2);aspect-ratio:1}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--sm{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--lg{padding:var(--cr-space-3) var(--cr-space-4);font-size:var(--cr-text-base)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--full{width:100%}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--primary{background:var(--cr-accent);border-color:var(--cr-accent);color:var(--cr-bg);filter:none}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--primary:hover:not(:disabled){background:var(--cr-accent-hover);border-color:var(--cr-accent-hover);filter:none}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--danger{background:var(--cr-danger);border-color:var(--cr-danger);color:#fff;filter:none}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--danger:hover:not(:disabled){filter:brightness(1.1)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--ghost{background:transparent;border-color:transparent}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--ghost:hover:not(:disabled){background:var(--cr-bg-secondary)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button--success{background:var(--cr-success);border-color:var(--cr-success);color:#fff;filter:none}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(.5)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button.cr-active{color:var(--cr-accent);background:var(--cr-accent-muted);border-color:var(--cr-accent)}:is(.cr-popup,.cr-settings-modal,.cr-drawer) .menu_button.cr-active:hover:not(:disabled){background:color-mix(in srgb,var(--cr-accent) 40%,transparent)}.cr-button-group{display:flex;gap:var(--cr-space-2)}.cr-button-group--stretch .menu_button{flex:1}.cr-field-list{flex-direction:column;gap:var(--cr-space-1);max-height:200px;overflow-y:auto;background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius)}.cr-field-item,.cr-field-list{display:flex;padding:var(--cr-space-2)}.cr-field-item{align-items:center;justify-content:space-between;gap:var(--cr-space-3);border-radius:var(--cr-radius-sm);transition:background var(--cr-transition-fast)}.cr-field-item:hover{background:var(--cr-bg-tertiary)}.cr-field-item__label{display:flex;align-items:center;gap:var(--cr-space-3);flex:1;min-width:0;cursor:pointer;font-size:var(--cr-text-sm)}.cr-field-item__meta{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-field-label{display:flex;align-items:center;gap:var(--cr-space-2);flex:1;cursor:pointer;font-size:var(--cr-text-sm)}.cr-field-checkbox{width:auto!important;margin:0;accent-color:var(--cr-accent);cursor:pointer;flex-shrink:0}.cr-field-name{flex:1;color:var(--cr-text)}.cr-field-count,.cr-field-tokens{font-size:var(--cr-text-xs);color:var(--cr-text-dim);flex-shrink:0;min-width:2.5em;text-align:right}.cr-field-group{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm);overflow:hidden}.cr-field-group .cr-field-item--parent{background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted)}.cr-field-group .cr-field-children{display:none;padding:var(--cr-space-1);background:var(--cr-bg-secondary)}.cr-field-group--expanded .cr-field-children{display:block}.cr-field-group .cr-field-item--child{padding-left:var(--cr-space-4)}.cr-field-expand{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-muted);cursor:pointer;transition:transform var(--cr-transition-fast)}.cr-field-expand:hover{color:var(--cr-text)}.cr-field-group--expanded .cr-field-expand{transform:rotate(180deg)}.cr-field-preview{display:none;flex-direction:column;gap:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted)}.cr-field-group--expanded .cr-field-preview{display:flex}.cr-field-preview__text{position:relative;margin:0;padding:var(--cr-space-2);max-height:100px;overflow:hidden;font-size:var(--cr-text-xs);font-family:var(--cr-font-mono);white-space:pre-wrap;word-break:break-word;line-height:1.4;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);color:var(--cr-text-muted)}.cr-field-preview__text:after{content:"";position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,var(--cr-bg-tertiary));pointer-events:none}.cr-field-preview__more{display:inline-flex;align-items:center;align-self:flex-start;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-accent);background:var(--cr-bg-tertiary);border:1px solid var(--cr-accent-muted);border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast);flex-shrink:0}.cr-field-preview__more:hover{background:var(--cr-accent-muted)}.cr-field-preview-btn{padding:var(--cr-space-1);background:none;border:none;color:var(--cr-text-dim);cursor:pointer;transition:color var(--cr-transition-fast)}.cr-field-preview-btn:hover{color:var(--cr-accent)}.cr-popup-preview{margin:0;padding:var(--cr-space-3);max-height:60vh;overflow-y:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-sm);white-space:pre-wrap;word-break:break-word;background:var(--cr-bg-secondary);border-radius:var(--cr-radius)}.cr-label{display:block;margin-bottom:var(--cr-space-1);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text)}.cr-required{color:var(--cr-danger)}.cr-input{width:100%;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-family:var(--cr-font)}.cr-hint{display:block;margin-top:var(--cr-space-1);font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-checkbox-group{display:flex;flex-wrap:wrap;gap:var(--cr-space-3);padding:var(--cr-space-2);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm)}.cr-checkbox-label{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);color:var(--cr-text);cursor:pointer}.cr-checkbox-label input[type=checkbox]{width:auto;accent-color:var(--cr-accent);cursor:pointer}.cr-schema-toolbar{display:flex;gap:var(--cr-space-2);margin-bottom:var(--cr-space-2)}.cr-errors,.cr-warnings{display:flex;flex-direction:column;gap:var(--cr-space-1);padding:var(--cr-space-3);border-radius:var(--cr-radius-sm)}.cr-errors{background:var(--cr-danger-bg);border:1px solid var(--cr-danger)}.cr-warnings{background:var(--cr-warning-bg);border:1px solid var(--cr-warning)}.cr-error{color:var(--cr-danger)}.cr-error,.cr-warning{font-size:var(--cr-text-sm)}.cr-warning{color:var(--cr-warning)}.cr-collapsible{border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-collapsible summary{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;cursor:pointer;background:var(--cr-bg-secondary);list-style:none;transition:background var(--cr-transition-fast)}.cr-collapsible summary:hover{background:var(--cr-bg-tertiary)}.cr-collapsible summary::-webkit-details-marker{display:none}.cr-collapsible[open] summary{border-bottom:1px solid var(--cr-border-muted)}.cr-collapsible__content{padding:var(--cr-space-3)}.cr-shortcut{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2);border-radius:var(--cr-radius-sm)}.cr-shortcut__keys{display:flex;gap:var(--cr-space-1)}.cr-shortcut__desc{color:var(--cr-text-muted)}.cr-list{display:flex;flex-direction:column}.cr-list-item{display:flex;align-items:flex-start;gap:var(--cr-space-3);padding:var(--cr-space-3);border-bottom:1px solid var(--cr-border-muted);cursor:pointer;transition:background var(--cr-transition-fast)}.cr-list-item:last-child{border-bottom:none}.cr-list-item:hover{background:var(--cr-bg-secondary)}.cr-list-item--selected{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item--highlighted{background:var(--cr-bg-tertiary);outline:2px solid var(--cr-accent);outline-offset:-2px}.cr-list-item__avatar{width:48px;height:48px;border-radius:var(--cr-radius-sm);-o-object-fit:cover;object-fit:cover;flex-shrink:0}.cr-list-item__avatar--sm{width:32px;height:32px}.cr-list-item__avatar--circle{border-radius:50%}.cr-list-item__content{flex:1;min-width:0;display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-list-item__title{font-weight:600;font-size:var(--cr-text-sm);color:var(--cr-text)}.cr-list-item__subtitle{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-list-item__meta{display:flex;gap:var(--cr-space-3);font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-list-item__actions{display:flex;gap:var(--cr-space-1);opacity:0;transition:opacity var(--cr-transition-fast)}.cr-list-item:hover .cr-list-item__actions{opacity:1}.cr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--cr-space-8);text-align:center;color:var(--cr-text-muted)}.cr-empty__icon{font-size:3rem;opacity:.3;margin-bottom:var(--cr-space-4)}.cr-empty__title{font-weight:500;margin-bottom:var(--cr-space-2)}.cr-empty__text{font-size:var(--cr-text-sm);color:var(--cr-text-dim)}.cr-results-wrapper{display:flex;flex-direction:column;height:100%;min-height:0;overflow:hidden}.cr-results-toolbar{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-results-content{flex:1;min-height:0;overflow-y:auto}.cr-result{display:flex;flex-direction:column;height:100%}.cr-result__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-result__type{font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-result__actions,.cr-result__type{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-result__content{flex:1;overflow-y:auto;padding:var(--cr-space-3)}.cr-result__raw{margin:0;background:var(--cr-bg-tertiary);color:var(--cr-text);-webkit-user-select:text;-moz-user-select:text;user-select:text}.cr-result__json,.cr-result__raw{padding:var(--cr-space-3);font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;border-radius:var(--cr-radius)}.cr-result__json{background:var(--cr-bg-secondary)}.cr-result__code{margin:0;padding:var(--cr-space-3);font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.5;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius);overflow-x:auto}.cr-result__code code{font-family:inherit}.cr-result__prose{font-size:var(--cr-text-sm);line-height:1.7}.cr-result__prose h1,.cr-result__prose h2,.cr-result__prose h3{font-weight:600;margin-top:1.25em;margin-bottom:.5em}.cr-result__prose h1:first-child,.cr-result__prose h2:first-child,.cr-result__prose h3:first-child{margin-top:0}.cr-result__prose p{margin:0 0 .75em}.cr-result__prose ol,.cr-result__prose ul{margin:.5em 0;padding-left:1.5em}.cr-result__prose li{margin:.25em 0}.cr-result__prose code{font-family:var(--cr-font-mono);font-size:.9em;padding:.15em .4em;background:var(--cr-bg-secondary);border-radius:var(--cr-radius-sm)}.cr-result__prose pre{margin:.75em 0;padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);overflow-x:auto}.cr-result__prose pre code{padding:0;background:none}.cr-result__prose strong{font-weight:600}:is(.cr-json-toggle,.cr-text-toggle){display:flex;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);padding:2px}:is(.cr-json-toggle,.cr-text-toggle)>button{display:flex;align-items:center;justify-content:center;width:28px;height:24px;border:none;background:transparent;color:var(--cr-text-dim);cursor:pointer;border-radius:var(--cr-radius-sm);transition:all var(--cr-transition-fast)}:is(.cr-json-toggle,.cr-text-toggle)>button:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}:is(.cr-json-toggle__btn,.cr-text-toggle__btn)--active{color:var(--cr-accent);background:var(--cr-bg);box-shadow:0 1px 2px rgba(0,0,0,.1)}.cr-view-toggle{display:flex;gap:var(--cr-space-1);background:var(--cr-bg-secondary);padding:var(--cr-space-1);border-radius:var(--cr-radius)}.cr-view-toggle__btn{padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);border-radius:calc(var(--cr-radius) - 2px);background:transparent;border:none;color:var(--cr-text-dim);cursor:pointer;transition:all .15s ease}.cr-view-toggle__btn:hover{color:var(--cr-text)}.cr-view-toggle__btn--active{background:var(--cr-bg);color:var(--cr-text);box-shadow:var(--cr-shadow-sm)}.cr-compare-view{display:flex;flex-direction:column;height:100%;min-height:0}.cr-compare-header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);border-bottom:1px solid var(--cr-border);flex-shrink:0}.cr-compare-stats{display:flex;gap:var(--cr-space-2)}.cr-compare-list{flex:1;overflow-y:auto;padding:var(--cr-space-2)}.cr-compare-row{margin-bottom:var(--cr-space-3);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-compare-row--changed{border-color:var(--cr-accent)}.cr-compare-row--unchanged{opacity:.7}.cr-compare-row__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border)}.cr-compare-row__label{font-weight:600;font-size:var(--cr-text-sm)}.cr-compare-row__badges{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-compare-row__content{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--cr-border)}.cr-compare-row__content--single{grid-template-columns:1fr;background:transparent}.cr-compare-col{background:var(--cr-bg);padding:var(--cr-space-2)}.cr-compare-col__header{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;color:var(--cr-text-dim);margin-bottom:var(--cr-space-2)}.cr-compare-col--original .cr-compare-col__header{color:var(--cr-danger)}.cr-compare-col--rewritten .cr-compare-col__header{color:var(--cr-success)}.cr-compare-text{font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;margin:0;max-height:200px;overflow-y:auto}.cr-diff--added{background:rgba(var(--cr-success-rgb,46,160,67),.2);color:var(--cr-success);padding:0 2px;border-radius:2px}.cr-diff--removed{background:rgba(var(--cr-danger-rgb,248,81,73),.2);color:var(--cr-danger);text-decoration:line-through;opacity:.8;padding:0 2px;border-radius:2px}.cr-diff-stats{display:inline-flex;gap:var(--cr-space-2);font-size:var(--cr-text-xs);font-family:var(--cr-font-mono);font-weight:600}.cr-diff-stats__add{color:var(--cr-success)}.cr-diff-stats__del{color:var(--cr-danger)}.cr-compare-popup{display:grid;grid-template-columns:1fr 1fr;gap:var(--cr-space-4)}.cr-compare-popup__side h4{margin-bottom:var(--cr-space-2);font-weight:600}.cr-compare-popup__side pre{font-size:var(--cr-text-xs);line-height:1.6;white-space:pre-wrap;word-break:break-word;max-height:400px;overflow-y:auto;padding:var(--cr-space-2);background:var(--cr-bg-secondary);border-radius:var(--cr-radius)}:root{--cr-score-high:#10b981;--cr-score-good:#22c55e;--cr-score-mid:#eab308;--cr-score-low:#f97316;--cr-score-bad:#ef4444}.cr-formatted{display:flex;flex-direction:column;gap:var(--cr-space-2);font-size:var(--cr-text-sm);line-height:1.55}.cr-formatted--empty{padding:var(--cr-space-4);text-align:center;color:var(--cr-text-dim);font-style:italic}.cr-hero{position:relative;display:flex;flex-direction:column;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:linear-gradient(135deg,var(--cr-bg-secondary) 0,var(--cr-bg-tertiary) 100%);border-radius:var(--cr-radius);border:1px solid var(--cr-border);text-align:center;overflow:hidden}.cr-hero:before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:120px;background:var(--score-color,var(--cr-accent));opacity:.06;filter:blur(30px);border-radius:50%;pointer-events:none}.cr-hero__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--cr-text-muted);margin-bottom:var(--cr-space-1)}.cr-hero__score{display:flex;align-items:baseline;gap:2px}.cr-hero__value{font-size:2.5rem;font-weight:800;line-height:1;color:var(--score-color,var(--cr-accent));text-shadow:0 2px 12px color-mix(in srgb,var(--score-color,var(--cr-accent)) 25%,transparent);font-variant-numeric:tabular-nums}.cr-hero__max{font-size:1rem;font-weight:500;color:var(--cr-text-dim);margin-left:2px}.cr-hero__bar{width:100%;max-width:160px;height:4px;margin-top:var(--cr-space-2);background:var(--cr-bg-tertiary);border-radius:2px;overflow:hidden}.cr-hero__fill{height:100%;border-radius:2px;transition:width .5s cubic-bezier(.4,0,.2,1)}.cr-formatted .cr-section{background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-formatted .cr-section .cr-section__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-tertiary);border-bottom:1px solid var(--cr-border-muted);margin:0}.cr-formatted .cr-section .cr-section__title{margin:0;font-size:var(--cr-text-sm);font-weight:700;color:var(--cr-text);text-transform:none;letter-spacing:normal}.cr-formatted .cr-section .cr-section__body{padding:var(--cr-space-3);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-formatted .cr-section .cr-section__body--nested{background:var(--cr-bg);border-left:2px solid var(--cr-accent)}.cr-section__score{display:inline-flex;align-items:baseline;padding:2px 8px;background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-section__score-max{font-size:.8em;font-weight:500;opacity:.6;margin-left:1px}.cr-field{display:flex;flex-direction:column;gap:var(--cr-space-1)}.cr-field__label{font-size:var(--cr-text-xs);font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--cr-text-muted)}.cr-field__value{font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-field--empty{color:var(--cr-text-dim);font-style:italic}.cr-para{margin:0;font-size:var(--cr-text-sm);line-height:1.6;color:var(--cr-text)}.cr-para+.cr-para{margin-top:var(--cr-space-1)}.cr-text{font-size:var(--cr-text-sm);line-height:1.6;white-space:pre-wrap}.cr-formatted .cr-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:4px}.cr-formatted .cr-list li{position:relative;padding-left:var(--cr-space-3);font-size:var(--cr-text-sm);line-height:1.5}.cr-formatted .cr-list li:before{content:"";position:absolute;left:0;top:.55em;width:5px;height:5px;background:var(--cr-accent);border-radius:50%;opacity:.7}.cr-formatted .cr-list--numbered{counter-reset:list-counter}.cr-formatted .cr-list--numbered li{counter-increment:list-counter;padding-left:var(--cr-space-5)}.cr-formatted .cr-list--numbered li:before{content:counter(list-counter);width:auto;height:auto;background:none;border-radius:0;font-size:var(--cr-text-xs);font-weight:700;color:var(--cr-accent);opacity:1;top:0}.cr-cards{display:flex;flex-direction:column;gap:var(--cr-space-3)}.cr-formatted .cr-card{padding:var(--cr-space-4);background:var(--cr-bg-secondary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);transition:border-color var(--cr-transition-fast),box-shadow var(--cr-transition-fast)}.cr-formatted .cr-card:hover{border-color:var(--cr-border);box-shadow:0 4px 12px rgba(0,0,0,.1)}.cr-formatted .cr-card__header{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);margin-bottom:var(--cr-space-3)}.cr-formatted .cr-card__title{font-weight:700;font-size:var(--cr-text-base);color:var(--cr-text)}.cr-formatted .cr-card__body{font-size:var(--cr-text-sm);line-height:1.7;color:var(--cr-text-muted)}.cr-formatted .cr-card__extra{margin-top:var(--cr-space-3);padding-top:var(--cr-space-3);border-top:1px solid var(--cr-border-muted);display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-score{display:inline-flex;align-items:baseline;padding:2px 8px;background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 15%,transparent);border-radius:var(--cr-radius-sm);font-weight:700;font-size:var(--cr-text-sm);color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-score__max{font-size:.75em;font-weight:500;opacity:.6;margin-left:1px}.cr-inline-score{display:inline-flex;align-items:baseline;padding:1px 6px;margin:0 2px;background:color-mix(in srgb,var(--score-color,var(--cr-accent)) 12%,transparent);border-radius:4px;font-weight:700;font-size:.95em;color:var(--score-color,var(--cr-accent));font-variant-numeric:tabular-nums}.cr-inline-score__label{font-weight:500;color:var(--cr-text-muted);margin-right:2px}.cr-inline-score__max{font-size:.75em;font-weight:500;opacity:.5}.cr-code{position:relative;background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius);overflow:hidden}.cr-code__lang{position:absolute;top:var(--cr-space-2);right:var(--cr-space-2);padding:2px 8px;background:var(--cr-bg-secondary);border-radius:var(--cr-radius-sm);font-size:var(--cr-text-xs);font-weight:600;color:var(--cr-text-muted);text-transform:uppercase;letter-spacing:.05em}.cr-code__pre{margin:0;padding:var(--cr-space-4);overflow-x:auto;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.6}.cr-code__pre code{font-family:inherit}.cr-inline-code{padding:2px 6px;background:var(--cr-bg-tertiary);border-radius:4px;font-family:var(--cr-font-mono);font-size:.9em;color:var(--cr-accent)}.cr-bool--yes{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-success);font-weight:600}.cr-bool--yes i{font-size:1.1em}.cr-bool--no{display:inline-flex;align-items:center;gap:var(--cr-space-1);color:var(--cr-danger);font-weight:600}.cr-bool--no i{font-size:1.1em}.cr-formatted .cr-empty,.cr-null{color:var(--cr-text-dim)}.cr-formatted .cr-empty{font-style:italic}.cr-num{font-family:var(--cr-font-mono);font-weight:600;font-variant-numeric:tabular-nums}.cr-link{color:var(--cr-accent);text-decoration:none;border-bottom:1px solid transparent;transition:border-color var(--cr-transition-fast)}.cr-link:hover{border-bottom-color:var(--cr-accent)}.cr-preview-content{max-height:60vh;overflow-y:auto;padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius)}.cr-preview-content pre{margin:0;padding:0;font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word}.cr-error-box{padding:var(--cr-space-3);background:var(--cr-danger-bg);border:1px solid var(--cr-danger);border-radius:var(--cr-radius);color:var(--cr-danger);font-size:var(--cr-text-sm)}.cr-history{flex-shrink:0;border-top:1px solid var(--cr-border-muted);background:var(--cr-bg)}.cr-history--collapsed .cr-history__toggle-icon{transform:rotate(-90deg)}.cr-history--collapsed .cr-history__list{display:none}.cr-history__toggle{display:flex;align-items:center;gap:var(--cr-space-2);width:100%;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border:none;cursor:pointer;font-size:var(--cr-text-xs);font-weight:500;color:var(--cr-text-muted);text-align:left}.cr-history__toggle:hover{background:var(--cr-bg-tertiary);color:var(--cr-text)}.cr-history__toggle-icon{margin-left:auto;transition:transform var(--cr-transition-fast)}.cr-history__list{max-height:180px;overflow-y:auto;padding:var(--cr-space-1);background:var(--cr-bg-secondary)}.cr-history-nav{display:flex;align-items:center;justify-content:space-between;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-accent-muted);border-bottom:1px solid var(--cr-accent)}.cr-history-nav__info{font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-accent)}.cr-history-nav__controls,.cr-history-nav__info{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-history-nav__btn{flex-shrink:0}.cr-list-item--error{border-left:3px solid var(--cr-danger)}.cr-list-item--error .cr-list-item__title{color:var(--cr-danger)}.cr-list-item--viewing{background:var(--cr-accent-muted);border-left:3px solid var(--cr-accent)}.cr-list-item--current{opacity:.7}.cr-api-badge{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);background:var(--cr-success-bg);border-radius:var(--cr-radius-pill);font-size:var(--cr-text-xs);color:var(--cr-text-muted);cursor:default;transition:background var(--cr-transition-fast)}.cr-api-badge--error{background:var(--cr-danger-bg)}.cr-api-badge i{font-size:.625rem}.cr-api-status{display:flex;align-items:center;gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-api-status--ready{border-color:var(--cr-success)}.cr-api-status--error{border-color:var(--cr-danger)}.cr-api-status__indicator{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-status__text{font-size:var(--cr-text-sm);font-weight:500}.cr-api-status__error{color:var(--cr-danger);cursor:help}.cr-badge{display:inline-flex;align-items:center;padding:.2em .6em;font-size:var(--cr-text-xs);font-weight:500;border-radius:var(--cr-radius-pill);text-transform:uppercase;letter-spacing:.03em}.cr-badge--default{background:var(--cr-bg-tertiary);color:var(--cr-text-muted)}.cr-badge--accent{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-badge--success{background:var(--cr-success-bg);color:var(--cr-success)}.cr-badge--warning{background:var(--cr-warning-bg);color:var(--cr-warning)}.cr-badge--danger{background:var(--cr-danger-bg);color:var(--cr-danger)}.cr-badge--sm,.cr-badge--small{padding:.1em .4em;font-size:9px}.cr-badge--info{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-badge--muted{background:var(--cr-bg-secondary);color:var(--cr-text-dim)}.cr-alert{display:flex;gap:var(--cr-space-3);padding:var(--cr-space-3);border-radius:var(--cr-radius);font-size:var(--cr-text-sm)}.cr-alert--info{background:var(--cr-accent-muted);border:1px solid var(--cr-accent);color:var(--cr-accent)}.cr-alert--success{background:var(--cr-success-bg);border:1px solid var(--cr-success);color:var(--cr-success)}.cr-alert--warning{background:var(--cr-warning-bg);border:1px solid var(--cr-warning);color:var(--cr-warning)}.cr-alert--danger{background:var(--cr-danger-bg);border:1px solid var(--cr-danger);color:var(--cr-danger)}.cr-alert__icon{flex-shrink:0}.cr-alert__content{flex:1}.cr-alert__title{font-weight:600;margin-bottom:var(--cr-space-1)}.cr-alert__message{margin-top:var(--cr-space-1);font-size:var(--cr-text-sm);white-space:pre-wrap}.cr-loading{display:flex;align-items:center;gap:var(--cr-space-3);padding:var(--cr-space-3);background:var(--cr-accent-muted);border-radius:var(--cr-radius);color:var(--cr-accent);font-size:var(--cr-text-sm);animation:cr-pulse 2s ease-in-out infinite}.cr-loading__spinner{animation:cr-spin 1s linear infinite}@keyframes cr-spin{to{transform:rotate(1turn)}}@keyframes cr-pulse{0%,to{opacity:1}50%{opacity:.6}}.cr-drawer{position:absolute;inset:0;z-index:100;pointer-events:none;overflow:hidden}.cr-drawer[aria-hidden=true]{visibility:hidden}.cr-drawer--open{pointer-events:auto;visibility:visible}.cr-drawer--open .cr-drawer__backdrop{opacity:1}.cr-drawer--open .cr-drawer__panel{transform:translateX(0)}.cr-drawer__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);opacity:0;transition:opacity var(--cr-transition);backdrop-filter:blur(4px)}.cr-drawer__panel{position:absolute;top:0;right:0;bottom:0;width:100%;max-width:640px;background:var(--SmartThemeBlurTintColor,var(--cr-bg));border-left:1px solid var(--cr-border);box-shadow:-4px 0 24px rgba(0,0,0,.4);transform:translateX(100%);transition:transform var(--cr-transition);display:flex;flex-direction:column}@media (max-width:768px){.cr-drawer__panel{max-width:none}}.cr-drawer__content{display:flex;flex-direction:column;height:100%;min-height:0}.cr-drawer__header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__title{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-drawer__title h3{margin:0;font-size:var(--cr-text-lg);font-weight:600}.cr-drawer__title i{font-size:var(--cr-text-base)}.cr-drawer__body{flex:1;min-height:0;overflow-y:auto;padding:var(--cr-space-4);display:flex;flex-direction:column;gap:var(--cr-space-4)}.cr-drawer__footer{display:flex;align-items:center;padding:var(--cr-space-3) var(--cr-space-4);background:var(--cr-bg-secondary);border-top:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__footer--list{justify-content:space-between}.cr-drawer__tabs{display:flex;background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted);flex-shrink:0}.cr-drawer__tab{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-3);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all var(--cr-transition-fast)}.cr-drawer__tab:hover{color:var(--cr-text);background:var(--cr-bg-tertiary)}.cr-drawer__tab--active{color:var(--cr-accent);border-bottom-color:var(--cr-accent)}.cr-preset-manage{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1);color:var(--cr-text-muted);background:transparent;border:none;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-preset-manage:hover{color:var(--cr-accent);background:var(--cr-accent-muted)}.cr-preset-row{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-preset-row .cr-select{flex:1;min-width:0}.cr-preset-row__actions{display:flex;gap:var(--cr-space-1);flex-shrink:0}.cr-chip{display:inline-flex;align-items:center;gap:var(--cr-space-1);padding:var(--cr-space-1) var(--cr-space-2);font-size:var(--cr-text-xs);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-pill);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-chip--active,.cr-chip:hover{border-color:var(--cr-accent)}.cr-chip--active{background:var(--cr-accent-muted);color:var(--cr-accent)}.cr-chip input[type=checkbox]{display:none}.popup:has(.cr-settings-modal){width:90dvw;max-width:900px;min-width:320px;padding:0}@media (min-width:1024px){.popup:has(.cr-settings-modal){max-width:1000px}}.cr-settings-modal{display:flex;flex-direction:column;height:85vh;max-height:85vh;color:var(--cr-text);font-family:var(--cr-font);font-size:var(--cr-font-size)}.cr-settings-header{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-4);background:var(--cr-bg-secondary);border-bottom:1px solid var(--cr-border-muted)}.cr-settings-header h2{display:flex;align-items:center;gap:var(--cr-space-2);margin:0;font-size:var(--cr-text-lg);font-weight:600}.cr-settings-header h2 i{color:var(--cr-accent)}.cr-settings-body{flex:1;gap:var(--cr-space-4);overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--cr-border) transparent}.cr-settings-body,.cr-settings-section{display:flex;flex-direction:column;padding:var(--cr-space-4)}.cr-settings-section{gap:var(--cr-space-3);background:var(--cr-bg-secondary);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius)}.cr-settings-section h3{display:flex;align-items:center;gap:var(--cr-space-2);margin:0 0 var(--cr-space-2) 0;padding-bottom:var(--cr-space-2);border-bottom:1px solid var(--cr-border-muted);font-size:var(--cr-text-base);font-weight:600}.cr-settings-section h3 i{color:var(--cr-accent);font-size:var(--cr-text-sm)}.cr-settings-footer{padding:var(--cr-space-3) var(--cr-space-4);border-top:1px solid var(--cr-border-muted)}.cr-api-banner,.cr-settings-footer{display:flex;align-items:center;justify-content:space-between;background:var(--cr-bg-secondary)}.cr-api-banner{gap:var(--cr-space-3);padding:var(--cr-space-2) var(--cr-space-3);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted);margin-bottom:var(--cr-space-3)}.cr-api-banner--ready{border-color:var(--cr-success);background:color-mix(in srgb,var(--cr-success) 10%,var(--cr-bg-secondary))}.cr-api-banner--ready .cr-api-banner__left i{color:var(--cr-success)}.cr-api-banner--error{border-color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,var(--cr-bg-secondary))}.cr-api-banner--error .cr-api-banner__left i{color:var(--cr-danger)}.cr-api-banner__left{display:flex;align-items:center;gap:var(--cr-space-2)}.cr-api-banner__name{font-weight:500;font-size:var(--cr-text-sm)}.cr-api-banner__right{display:flex;align-items:center;gap:var(--cr-space-3);font-size:var(--cr-text-xs);color:var(--cr-text-muted)}.cr-api-banner__model{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-api-error{align-items:center;padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 8%,transparent);border-radius:var(--cr-radius)}.cr-api-error,.cr-gen-mode-toggle{display:flex;gap:var(--cr-space-2);margin-bottom:var(--cr-space-3)}.cr-gen-mode-option{flex:1;display:flex;align-items:center;justify-content:center;gap:var(--cr-space-2);padding:var(--cr-space-2) var(--cr-space-3);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius);background:var(--cr-bg-secondary);cursor:pointer;transition:all var(--cr-transition);font-size:var(--cr-text-sm)}.cr-gen-mode-option input[type=radio]{display:none}.cr-gen-mode-option:hover{border-color:var(--cr-border);background:var(--cr-bg-tertiary)}.cr-gen-mode-option--active{border-color:var(--cr-accent);background:color-mix(in srgb,var(--cr-accent) 15%,var(--cr-bg-secondary))}.cr-gen-mode-option--active i{color:var(--cr-accent)}.cr-profile-section{padding:var(--cr-space-3);background:var(--cr-bg-secondary);border-radius:var(--cr-radius);border:1px solid var(--cr-border-muted)}.cr-profile-info{margin-top:var(--cr-space-2);padding:var(--cr-space-2);background:var(--cr-bg);border-radius:var(--cr-radius-sm)}.cr-profile-info--empty{display:flex;align-items:center;gap:var(--cr-space-2);color:var(--cr-text-dim);font-size:var(--cr-text-sm);font-style:italic}.cr-profile-info--error{border:1px solid var(--cr-danger)}.cr-profile-info__row{display:flex;align-items:center;justify-content:space-between;padding:var(--cr-space-1) 0;font-size:var(--cr-text-xs)}.cr-profile-info__row:not(:last-child){border-bottom:1px solid var(--cr-border-muted)}.cr-profile-info__label{color:var(--cr-text-muted)}.cr-profile-info__value{font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-profile-info__error{display:flex;align-items:center;gap:var(--cr-space-2);margin-top:var(--cr-space-2);padding:var(--cr-space-2);font-size:var(--cr-text-xs);color:var(--cr-danger);background:color-mix(in srgb,var(--cr-danger) 10%,transparent);border-radius:var(--cr-radius-sm)}.cr-profile-empty{display:flex;gap:var(--cr-space-2);padding:var(--cr-space-3);color:var(--cr-text-muted);font-size:var(--cr-text-sm)}.cr-profile-empty i{color:var(--cr-accent);flex-shrink:0;margin-top:2px}.cr-profile-empty strong{display:block;margin-bottom:var(--cr-space-1);color:var(--cr-text)}.cr-profile-empty p{margin:0;font-size:var(--cr-text-xs);line-height:1.4}.cr-setting-item{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-setting-label{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text);cursor:pointer}.cr-setting-label input[type=checkbox]{width:auto;accent-color:var(--cr-accent);cursor:pointer}.cr-setting-hint{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-setting-desc{margin:0 0 var(--cr-space-2) 0;font-size:var(--cr-text-sm);color:var(--cr-text-muted);line-height:1.5}.cr-number-input{width:120px!important;padding:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-readonly-text{margin:0;padding:var(--cr-space-3);font-family:var(--cr-font-mono);font-size:var(--cr-text-xs);line-height:1.5;white-space:pre-wrap;word-break:break-word;background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);max-height:150px;overflow-y:auto}.cr-version{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-presets-tabs{display:flex;gap:var(--cr-space-1);padding:var(--cr-space-1);background:var(--cr-bg-tertiary);border-radius:var(--cr-radius-sm);margin-bottom:var(--cr-space-3)}.cr-presets-tab{flex:1;padding:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text-muted);background:transparent;border:none;border-radius:var(--cr-radius-sm);cursor:pointer;transition:all var(--cr-transition-fast)}.cr-presets-tab:hover{color:var(--cr-text);background:var(--cr-bg-secondary)}.cr-presets-tab--active{color:var(--cr-text);background:var(--cr-bg);box-shadow:var(--cr-shadow-sm)}.cr-presets-list{flex-direction:column;max-height:250px;overflow-y:auto;padding:var(--cr-space-2);background:var(--cr-bg-tertiary);margin-bottom:var(--cr-space-3)}.cr-preset-item,.cr-presets-list{display:flex;gap:var(--cr-space-2);border:1px solid var(--cr-border-muted);border-radius:var(--cr-radius-sm)}.cr-preset-item{align-items:center;justify-content:space-between;padding:var(--cr-space-2) var(--cr-space-3);background:var(--cr-bg-secondary);transition:all var(--cr-transition-fast)}.cr-preset-item:hover{border-color:var(--cr-border);background:var(--cr-bg)}.cr-preset-item--builtin{opacity:.8}.cr-preset-info{display:flex;flex-direction:column;gap:var(--cr-space-1);min-width:0;flex:1}.cr-preset-name{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm);font-weight:500;color:var(--cr-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.cr-preset-stages{font-size:var(--cr-text-xs);color:var(--cr-text-dim)}.cr-preset-actions,.cr-presets-actions{display:flex;gap:var(--cr-space-1);flex-shrink:0}.cr-presets-actions{gap:var(--cr-space-2)}.cr-shortcuts-list{display:flex;flex-direction:column;gap:var(--cr-space-2)}.cr-shortcuts-list .cr-shortcut{display:flex;align-items:center;gap:var(--cr-space-2);font-size:var(--cr-text-sm)}.cr-shortcuts-list .cr-shortcut kbd{display:inline-flex;align-items:center;padding:.2em .5em;font-family:var(--cr-font);font-size:var(--cr-text-xs);background:var(--cr-bg-tertiary);border:1px solid var(--cr-border);border-radius:var(--cr-radius-sm)}.cr-shortcuts-list .cr-shortcut span{color:var(--cr-text-muted)}.cr-debug-actions{display:flex;flex-wrap:wrap;gap:var(--cr-space-2);margin-top:var(--cr-space-2)}.cr-panel-version{color:var(--SmartThemeEmColor,#999);font-size:.85em;margin-bottom:.5em}.cr-panel-desc{margin:0 0 1em;font-size:.9em;color:var(--SmartThemeBodyColor);line-height:1.4}.cr-panel-actions{display:flex;gap:.5em}@media (max-width:768px){.cr-popup .menu_button{min-height:44px;padding:var(--cr-space-3)}.cr-tab{min-height:44px}.cr-list-item{padding:var(--cr-space-4)}.cr-list-item__actions{opacity:1}}@media (prefers-reduced-motion:reduce){.cr-popup *,.cr-popup :after,.cr-popup :before{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}@media (prefers-contrast:high){.cr-popup{--cr-border:var(--cr-text);--cr-border-muted:var(--cr-text-muted)}}',""]);const s=o},825(e){e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var r=e.insertStyleElement(e);return{update:function(t){!function(e,r,t){var n="";t.supports&&(n+="@supports (".concat(t.supports,") {")),t.media&&(n+="@media ".concat(t.media," {"));var a=void 0!==t.layer;a&&(n+="@layer".concat(t.layer.length>0?" ".concat(t.layer):""," {")),n+=t.css,a&&(n+="}"),t.media&&(n+="}"),t.supports&&(n+="}");var i=t.sourceMap;i&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),r.styleTagTransform(n,e,r.options)}(r,e,t)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(r)}}}}},r={};function t(n){var a=r[n];if(void 0!==a)return a.exports;var i=r[n]={id:n,exports:{}};return e[n](i,i.exports,t),i.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),t.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.nc=void 0;var n=t(72),a=t.n(n),i=t(825),o=t.n(i),s=t(659),c=t.n(s),l=t(56),d=t.n(l),p=t(540),u=t.n(p),f=t(113),v=t.n(f),m=t(805),g={};g.styleTagTransform=v(),g.setAttributes=d(),g.insert=c().bind(null,"head"),g.domAPI=o(),g.insertStyleElement=u();a()(m.A,g);m.A&&m.A.locals&&m.A.locals;var h=t(319),b=t(737),y=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};var _=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function x(e){return _(this,void 0,void 0,function*(){const r=SillyTavern.getContext(),t=r.characters||[],n=t.findIndex(r=>r.avatar===e.avatar);if(-1===n)return h.Rm.debug("Character not found in ST array, using provided data"),e;const a=t[n];return a.shallow&&"function"==typeof r.unshallowCharacter?(h.Rm.debug(`Unshallowing character: ${e.name}`),yield r.unshallowCharacter(n),t[n]):a})}function w(e,r){const t=e;let n=$(t,r);if(void 0===n&&r.startsWith("data.")){const e=r.replace(/^data\./,"").replace(/^extensions\./,"");n=$(t,e),void 0===n&&e in t&&(n=t[e])}if(void 0===n&&r.startsWith("data.extensions.")){n=$(t,`extensions.${r.replace("data.extensions.","")}`)}return n}function $(e,r){return r.split(".").reduce((e,r)=>{if(e&&"object"==typeof e)return e[r]},e)}function k(e,r){if(null==e)return!1;switch(r){case"array":return Array.isArray(e)&&e.length>0;case"object":return"object"==typeof e&&("prompt"in e?"string"==typeof e.prompt&&e.prompt.trim().length>0:"entries"in e?Array.isArray(e.entries)&&e.entries.length>0:Object.keys(e).length>0);default:return"string"==typeof e&&e.trim().length>0}}function S(e,r){switch(r.type){case"array":return Array.isArray(e)?e.map((e,r)=>`${r+1}. ${String(e).trim()}`).join("\n"):"";case"object":return function(e,r){var t,n,a,i;if(!e||"object"!=typeof e)return"";if("depth_prompt"===r){const r=e;return(null===(t=r.prompt)||void 0===t?void 0:t.trim())?`[Depth: ${null!==(n=r.depth)&&void 0!==n?n:0}, Role: ${null!==(a=r.role)&&void 0!==a?a:"system"}]\n${r.prompt.trim()}`:""}if("character_book"===r){const r=e;if(!(null===(i=r.entries)||void 0===i?void 0:i.length))return"";const t=[];r.name&&t.push(`Lorebook: ${r.name}`),t.push(`Entries: ${r.entries.length}`);for(const e of r.entries.slice(0,10)){const r=e.enabled?"✓":"✗",n=e.comment||e.keys.slice(0,3).join(", ");t.push(`  ${r} ${n}`)}return r.entries.length>10&&t.push(`  ... and ${r.entries.length-10} more`),t.join("\n")}try{return JSON.stringify(e,null,2)}catch(e){return"[Complex Object]"}}(e,r.key);default:return"string"==typeof e?e.trim():String(e)}}function P(e){if(!e)return[];const r=[];for(const t of h.IF){const n=w(e,t.path);if(!k(n,t.type))continue;const a=S(n,t);a&&r.push({key:t.key,label:t.label,value:a,rawValue:n,charCount:a.length,type:t.type})}return r}function R(e,r){const t=P(e),n=[];for(const e of t){const t=r[e.key];if(t)if("alternate_greetings"===e.key&&Array.isArray(t)){const r=e.rawValue,a=t.filter(e=>e>=0&&e<r.length).map(e=>`**Greeting ${e+1}:**\n${r[e].trim()}`).join("\n\n");a&&n.push(`### ${e.label}\n\n${a}`)}else n.push(`### ${e.label}\n\n${e.value}`)}const a=n.length>0?n.join("\n\n"):"(No fields selected)";let i=`# CHARACTER: ${e.name}\n\n${a}`;return i=(0,h.$n)(i,e.name),i=(0,h.UH)(i),i}function C(e,r){const t=P(e),n={};for(const e of t)r[e.key]&&(n[e.key]=e.value);return n}var T=t(179),z=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function O(e,r){return z(this,arguments,void 0,function*(e,r,t={}){var n,a,i,o;const{signal:s,onProgress:c}=t,l=Date.now(),d=function(e,r){var t;const n=[];"analyze"===e.stage?(n.push("## ORIGINAL CHARACTER\n\n"),n.push(R(e.character,e.selection)),e.previousResults.score&&n.push("\n\n---\n\n## SCORE RESULTS\n\n"+e.previousResults.score.output),e.previousResults.rewrite&&n.push("\n\n---\n\n## REWRITTEN VERSION\n\n"+e.previousResults.rewrite.output)):(n.push(R(e.character,e.selection)),"rewrite"===e.stage&&(e.previousResults.score&&n.push("\n\n---\n\n## SCORE RESULTS\n\n"+e.previousResults.score.output),e.isRefinement&&e.previousResults.analyze&&n.push("\n\n---\n\n## ANALYSIS FEEDBACK\n\n"+e.previousResults.analyze.output))),(null===(t=e.guidance)||void 0===t?void 0:t.trim())&&n.push("\n\n---\n\n## USER GUIDANCE\n\n"+e.guidance.trim()),e.iterationCount>0&&n.push(`\n\n---\n\n*Refinement iteration ${e.iterationCount+1}*`);const a=function(e,r){if(e.customPrompt.trim())return e.customPrompt.trim();if(e.promptPresetId){const t=r.getPromptPreset(e.promptPresetId);if(t)return t.prompt}return""}(e.config,r);return a&&n.push("\n\n---\n\n## INSTRUCTIONS\n\n"+a),n.join("")}(e,r),p=function(e,r,t){return r?t.getRefinementPrompt():t.getSystemPrompt(e)}(e.stage,null!==(n=e.isRefinement)&&void 0!==n&&n,r),u=function(e,r){if(!e.useStructuredOutput)return null;if(e.customSchema.trim())try{return JSON.parse(e.customSchema)}catch(e){return null}if(e.schemaPresetId){const t=r.getSchemaPreset(e.schemaPresetId);if(t)return t.schema}return null}(e.config,r);if(null==c||c(`Running ${e.stage}...`),null==s?void 0:s.aborted)return{stage:e.stage,timestamp:l,input:d,output:"",guidance:e.guidance,error:"Aborted"};const f=yield(0,T.generate)({prompt:d,systemPrompt:p,jsonSchema:null!==(a=u)&&void 0!==a?a:void 0,signal:s});return f.success?{stage:e.stage,timestamp:l,input:d,output:null!==(o=f.response)&&void 0!==o?o:"",guidance:e.guidance}:(h.Rm.error(`Stage ${e.stage} failed`,f.error),{stage:e.stage,timestamp:l,input:d,output:"",guidance:e.guidance,error:null!==(i=f.error)&&void 0!==i?i:"Generation failed"})})}var E=t(374),A=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};var j=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let W=null;const N=function(e,r){const t=SillyTavern.libs.lodash,n=()=>y(this,void 0,void 0,function*(){const n=e();if(!(null==n?void 0:n.activeSessionId)||!n.character)return;const a=yield(0,b.getSession)(n.activeSessionId);a&&(a.stageFields=t.cloneDeep(n.stageFields),a.configs=t.cloneDeep(n.stageConfigs),a.stageResults=t.cloneDeep(n.stageResults),a.history=t.cloneDeep(n.iterationHistory),a.iterationCount=n.iterationCount,a.userGuidance=n.userGuidance||void 0,yield(0,b.updateSession)(a),r(!1))}),a=t.debounce(()=>{n()},1e3);return{trigger:a,save:n,cancel:()=>a.cancel(),flush:()=>y(this,void 0,void 0,function*(){a.cancel(),yield n()})}}(()=>W,e=>{W&&(W.hasUnsavedChanges=e)});function I(){return W={character:null,selectedFields:{},stageFields:{base:{},linked:!0,overrides:{}},activeSessionId:null,sessions:[],sessionsLoaded:!1,hasUnsavedChanges:!1,stageStatus:{score:"pending",rewrite:"pending",analyze:"pending"},stageResults:{score:null,rewrite:null,analyze:null},stageConfigs:{score:(0,b.getStageDefaults)("score"),rewrite:(0,b.getStageDefaults)("rewrite"),analyze:(0,b.getStageDefaults)("analyze")},activeStage:"score",iterationCount:0,iterationHistory:[],userGuidance:"",isGenerating:!1,abortController:null,searchQuery:"",searchResults:[],searchSelectedIndex:-1,dropdownOpen:!1,sessionListExpanded:!1,historyExpanded:!0,viewingHistoryIndex:null},W}function D(){if(!W)throw new Error("State not initialized");return W}function L(){return W}function M(){N.cancel(),W=null}function F(){const e=L();e&&(e.hasUnsavedChanges=!0,N.trigger())}function B(){return j(this,void 0,void 0,function*(){yield N.flush()})}function H(e){return j(this,void 0,void 0,function*(){yield function(e,r,t){return A(this,void 0,void 0,function*(){if(yield t(),e.character=r,e.selectedFields={},e.stageFields={base:{},linked:!0,overrides:{}},e.activeSessionId=null,e.sessions=[],e.sessionsLoaded=!1,e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.stageResults={score:null,rewrite:null,analyze:null},e.iterationCount=0,e.iterationHistory=[],e.hasUnsavedChanges=!1,r){try{e.character=yield x(r),h.Rm.debug(`Character loaded: ${e.character.name}`)}catch(t){h.Rm.error("Failed to unshallow character",t),e.character=r}if(e.sessions=yield(0,b.getSessionsForCharacter)(r.avatar),e.sessionsLoaded=!0,e.sessions.length>0){const r=e.sessions[0],t=SillyTavern.libs.lodash;if(e.activeSessionId=r.id,e.stageFields=t.cloneDeep(r.stageFields),e.selectedFields=t.cloneDeep(r.stageFields.base),e.stageConfigs=t.cloneDeep(r.configs),e.iterationHistory=t.cloneDeep(r.history),e.iterationCount=r.iterationCount,e.userGuidance=r.userGuidance||"",r.stageResults)e.stageResults=t.cloneDeep(r.stageResults);else for(const t of r.history)e.stageResults[t.stage]=t;for(const r of h.an)e.stageStatus[r]=e.stageResults[r]?e.stageResults[r].error?"error":"complete":"pending";h.Rm.debug(`Loaded most recent session: ${r.id}`),h.oR.info("Resumed session"+(r.name?`: ${r.name}`:""))}else{const r=C(e.character,e.stageFields.base),t=yield(0,b.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:r,configs:e.stageConfigs});e.sessions.unshift(t),e.activeSessionId=t.id,h.Rm.debug(`Auto-created new session: ${t.id}`),h.oR.info("New session started")}}})}(D(),e,B)})}function G(){return j(this,void 0,void 0,function*(){return function(e,r){return A(this,void 0,void 0,function*(){if(!e.character)return null;yield r();const t=C(e.character,e.stageFields.base),n=yield(0,b.createSession)({characterId:e.character.avatar,characterName:e.character.name,stageFields:e.stageFields,originalData:t,configs:e.stageConfigs});return e.sessions.unshift(n),e.activeSessionId=n.id,e.iterationCount=0,e.iterationHistory=[],e.stageResults={score:null,rewrite:null,analyze:null},e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.hasUnsavedChanges=!1,n})}(D(),B)})}function U(e){return j(this,void 0,void 0,function*(){return function(e,r,t){return A(this,void 0,void 0,function*(){var n;yield t();const a=yield(0,b.getSession)(r);if(!a)return!1;if((null===(n=e.character)||void 0===n?void 0:n.avatar)!==a.characterId){const r=SillyTavern.getContext().characters.find(e=>e.avatar===a.characterId);if(!r)return!1;e.character=r}const i=SillyTavern.libs.lodash;if(e.activeSessionId=a.id,e.stageFields=i.cloneDeep(a.stageFields),e.selectedFields=i.cloneDeep(a.stageFields.base),e.stageConfigs=i.cloneDeep(a.configs),e.iterationHistory=i.cloneDeep(a.history),e.iterationCount=a.iterationCount,e.userGuidance=a.userGuidance||"",e.hasUnsavedChanges=!1,a.stageResults)e.stageResults=i.cloneDeep(a.stageResults);else{e.stageResults={score:null,rewrite:null,analyze:null};for(const r of a.history)e.stageResults[r.stage]=r}for(const r of h.an)e.stageStatus[r]=e.stageResults[r]?e.stageResults[r].error?"error":"complete":"pending";return!0})}(D(),e,B)})}function q(e){return j(this,void 0,void 0,function*(){return function(e,r){return A(this,void 0,void 0,function*(){yield(0,b.deleteSession)(r);const t=e.sessions.findIndex(e=>e.id===r);-1!==t&&e.sessions.splice(t,1),e.activeSessionId===r&&(e.activeSessionId=null,e.iterationHistory=[],e.iterationCount=0,e.stageResults={score:null,rewrite:null,analyze:null},e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"})})}(D(),e)})}function J(e,r){return j(this,void 0,void 0,function*(){const n=D().sessions.find(r=>r.id===e);if(!n)return;n.name=r.trim()||void 0,n.updatedAt=Date.now();const{updateSession:a}=yield Promise.resolve().then(t.bind(t,737));yield a(n)})}function V(e){var r;const t=D(),n=null!=e?e:t.activeStage;return t.stageFields.linked?t.stageFields.base:null!==(r=t.stageFields.overrides[n])&&void 0!==r?r:t.stageFields.base}function Y(){return V()}function Q(){return D().stageFields.linked}function K(e,r){var t,n,a;const i=D(),o=i.stageFields.linked?i.stageFields.base:null!==(t=(n=i.stageFields.overrides)[a=i.activeStage])&&void 0!==t?t:n[a]={};!1===r||Array.isArray(r)&&0===r.length?delete o[e]:o[e]=r,i.selectedFields=Object.assign({},o),F()}function X(e){D().activeStage=e}function Z(e,r){const t=D();Object.assign(t.stageConfigs[e],r),F()}function ee(e){const r=D();null!==e&&(e<0||e>=r.iterationHistory.length)||(r.viewingHistoryIndex=e)}function re(e){const r=D(),t=null!=e?e:r.viewingHistoryIndex;if(null===t||t<0||t>=r.iterationHistory.length)return;const n=r.iterationHistory[t];r.stageResults[n.stage]=n,r.stageStatus[n.stage]=n.error?"error":"complete",r.viewingHistoryIndex=null,F()}var te=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};const ne={getPromptPreset:b.getPromptPreset,getSchemaPreset:b.getSchemaPreset,getSystemPrompt:b.getSystemPrompt,getRefinementPrompt:b.getRefinementPrompt};function ae(e,r,t){e.stageStatus[r]=t}function ie(e,r,t){e.isGenerating=r,e.abortController=r?null!=t?t:new AbortController:null,r?h.wG.show():h.wG.hide()}function oe(e,r){e.stageResults[r.stage]=r,e.stageStatus[r.stage]=r.error?"error":"complete",e.iterationHistory.push(r),e.hasUnsavedChanges=!0}function se(e,r){return e.character?{character:e.character,selection:V(r),stage:r,config:e.stageConfigs[r],previousResults:e.stageResults,iterationCount:e.iterationCount,guidance:e.userGuidance||void 0}:null}function ce(e,r=document){return r.querySelector(e)}function le(e,r=document){return Array.from(r.querySelectorAll(e))}function de(e,r,t,n){return e?(e.addEventListener(r,t,n),()=>{e.removeEventListener(r,t,n)}):()=>{}}function pe(e){return void 0===e?"...":null===e?"—":e>=1e3?`${(e/1e3).toFixed(1)}k`:e.toString()}function ue(e,r){return e.length<=r?e:e.slice(0,r-1)+"…"}function fe(...e){return e.filter(Boolean).join(" ")}const ve=new Map;let me=new Set,ge=!1;function he(e,r,t){return ve.set(e,{fn:r,categories:t}),()=>ve.delete(e)}function be(...e){for(const r of e)me.add(r);ge||(ge=!0,queueMicrotask(ye))}function ye(){if(ge=!1,0===me.size)return;const e=me;me=new Set;const r=e.has("all");for(const t of ve.values())if(r||t.categories.some(r=>e.has(r)))try{t.fn()}catch(e){console.error("[UpdateCoordinator] Update failed:",e)}}function _e(){be("character","session","fields","config","results","pipeline")}function xe(){be("session","fields","config","results","pipeline","stage")}var we=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function $e(){return SillyTavern.getContext().characters||[]}let ke=null;function Se(){ke=null}let Pe=!1,Re="",Ce=-1;function Te(e){Pe=e;const r=ce(`#${h.pW}_char_dropdown`);r&&r.classList.toggle("cr-dropdown--open",e),e||(Ce=-1)}function ze(){const e=Re.trim();if(!e)return $e().slice(0,30);return function(){var e;const r=$e();if(!ke||(null===(e=ke._docs)||void 0===e?void 0:e.length)!==r.length){const e=SillyTavern.libs.Fuse;ke=new e(r,{keys:[{name:"name",weight:3},{name:"description",weight:1}],threshold:.3,includeScore:!0,minMatchCharLength:2,ignoreLocation:!0})}return ke}().search(e).map(e=>e.item).slice(0,20)}function Oe(){var e;const r=D(),t=ze(),n=null===(e=r.character)||void 0===e?void 0:e.avatar;return 0===t.length?`\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid ${Re?"fa-search":"fa-users-slash"}"></i>\n                ${Re?`No matches for "${ue(Re,20)}"`:"No characters available"}\n            </div>\n        `:t.map((e,r)=>function(e,r,t){var n,a;const i=SillyTavern.libs.DOMPurify,o=SillyTavern.getContext().getThumbnailUrl("avatar",e.avatar),s=P(e).length,c=ue((e.description||"").replace(/\n/g," "),60),l=(null===(n=e.data)||void 0===n?void 0:n.creator)||"",d=(null===(a=e.data)||void 0===a?void 0:a.character_version)||"",p=[];return l&&p.push(l),d&&p.push(`v${d}`),0===p.length&&p.push(`${s} ${1===s?"field":"fields"}`),`\n        <div class="cr-char-option ${t?"cr-char-option--selected":""} ${r===Ce?"cr-char-option--highlighted":""}"\n             data-avatar="${i.sanitize(e.avatar)}"\n             data-index="${r}"\n             role="option"\n             aria-selected="${t}">\n            <div class="cr-char-option__avatar-wrap">\n                <img class="cr-char-option__avatar"\n                     src="${o}"\n                     alt=""\n                     onerror="this.src='/img/ai4.png'"\n                     loading="lazy" />\n                ${t?'<i class="fa-solid fa-check cr-char-option__check"></i>':""}\n            </div>\n            <div class="cr-char-option__info">\n                <span class="cr-char-option__name">${i.sanitize(e.name)}</span>\n                ${c?`<span class="cr-char-option__desc">${i.sanitize(c)}</span>`:""}\n                <span class="cr-char-option__meta">\n                    <i class="fa-solid fa-user-pen"></i>\n                    ${i.sanitize(p.join(" • "))}\n                </span>\n            </div>\n        </div>\n    `}(e,r,e.avatar===n)).join("")}function Ee(){if(!ce(`#${h.pW}_char_dropdown`))return;const e=SillyTavern.libs.DOMPurify,r=D().character,t=ce(`#${h.pW}_char_trigger`);if(t){const n=r?e.sanitize(r.name):"Select character...",a=r?`<img class="cr-dropdown__trigger-avatar"\n                   src="${SillyTavern.getContext().getThumbnailUrl("avatar",r.avatar)}"\n                   alt=""\n                   onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';t.innerHTML=`\n            ${a}\n            <span class="cr-dropdown__trigger-text ${r?"":"cr-dropdown__trigger-text--placeholder"}">${n}</span>\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const n=ce(`#${h.pW}_char_list`);n&&(n.innerHTML=Oe())}function Ae(e){e.forEach((e,r)=>{e.classList.toggle("cr-char-option--highlighted",r===Ce),r===Ce&&e.scrollIntoView({block:"nearest"})})}function je(e){return we(this,void 0,void 0,function*(){const r=e.dataset.avatar;if(!r)return;const t=$e().find(e=>e.avatar===r);t&&(yield H(t),Re="",Te(!1),_e())})}var We=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let Ne={isOpen:!1,type:"prompt",mode:"create",preset:null,activeTab:"edit"},Ie={},De=[];function Le(){return`\n        <div id="${h.pW}_preset_drawer" class="cr-drawer" aria-hidden="true">\n            <div class="cr-drawer__backdrop"></div>\n            <aside class="cr-drawer__panel" role="dialog" aria-label="Preset Editor">\n                <div class="cr-drawer__content">\n                    ${Me()}\n                    ${Fe()}\n                    ${Be()}\n                </div>\n            </aside>\n        </div>\n    `}function Me(){const{type:e,mode:r,preset:t}=Ne;let n="",a="";return"create"===r?(n=`New ${"prompt"===e?"Prompt":"Schema"} Preset`,a="fa-plus"):"edit"===r?(n=`Edit ${"prompt"===e?"Prompt":"Schema"} Preset`,a="fa-pen"):(n=`Duplicate ${"prompt"===e?"Prompt":"Schema"} Preset`,a="fa-copy"),`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid ${a} cr-text-accent"></i>\n                <h3>${n}</h3>\n                ${(null==t?void 0:t.isBuiltin)?'<span class="cr-badge cr-badge--info cr-badge--small">builtin</span>':""}\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n    `}function Fe(){const{type:e,mode:r,preset:t}=Ne;return`\n        <div class="cr-drawer__body cr-scrollable">\n            ${"duplicate"===r&&(null==t?void 0:t.isBuiltin)?'\n                <div class="cr-alert cr-alert--info cr-mb-3">\n                    <i class="fa-solid fa-circle-info cr-alert__icon"></i>\n                    <div class="cr-alert__content">\n                        <div class="cr-alert__message">\n                            Builtin presets cannot be modified. You\'re creating an editable copy.\n                        </div>\n                    </div>\n                </div>\n            ':""}\n            ${function(){const{preset:e,mode:r}=Ne,t=SillyTavern.libs.DOMPurify;let n="";e&&(n="duplicate"===r?`${e.name} (Copy)`:e.name);return`\n        <div class="cr-form-group">\n            <label class="cr-label" for="${h.pW}_drawer_name">\n                Name <span class="cr-required">*</span>\n            </label>\n            <input type="text"\n                   id="${h.pW}_drawer_name"\n                   class="cr-input text_pole"\n                   value="${t.sanitize(n)}"\n                   placeholder="Enter preset name..."\n                   maxlength="100"\n                   autocomplete="off" />\n        </div>\n    `}()}\n            ${function(){const{preset:e}=Ne,r=(null==e?void 0:e.stages)||[];return`\n        <div class="cr-form-group">\n            <label class="cr-label">\n                Applicable Stages\n                <span class="cr-hint cr-text-dim">(empty = all stages)</span>\n            </label>\n            <div class="cr-stage-chips">\n                ${h.an.map(e=>`\n                    <label class="cr-chip ${0===r.length||r.includes(e)?"cr-chip--active":""}">\n                        <input type="checkbox"\n                               name="drawer_stages"\n                               value="${e}"\n                               ${0===r.length||r.includes(e)?"checked":""} />\n                        <span>${h.BA[e]}</span>\n                    </label>\n                `).join("")}\n            </div>\n        </div>\n    `}()}\n            ${"prompt"===e?function(){const{preset:e}=Ne,r=SillyTavern.libs.DOMPurify,t=(null==e?void 0:e.prompt)||"";return`\n        <div class="cr-form-group cr-form-group--grow">\n            <div class="cr-row cr-row--between">\n                <label class="cr-label" for="${h.pW}_drawer_prompt">\n                    Prompt Template <span class="cr-required">*</span>\n                </label>\n                <div class="cr-row cr-gap-1">\n                    <button id="${h.pW}_drawer_prompt_vars"\n                            class="menu_button menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="View available variables">\n                        <i class="fa-solid fa-code"></i>\n                        Variables\n                    </button>\n                </div>\n            </div>\n            <div class="cr-editor-wrap">\n                <textarea id="${h.pW}_drawer_prompt"\n                          class="cr-textarea cr-textarea--editor text_pole"\n                          placeholder="Enter your prompt template...\n\nUse {{character}} for character data, {{field_name}} for specific fields.\nThe prompt will be sent to the LLM along with the selected character fields."\n                          spellcheck="false">${r.sanitize(t)}</textarea>\n            </div>\n            <div class="cr-form-group__hint cr-row cr-row--between">\n                <span id="${h.pW}_drawer_prompt_tokens" class="cr-text-dim">Calculating tokens...</span>\n            </div>\n        </div>\n    `}():function(){const{preset:e}=Ne,r=SillyTavern.libs.DOMPurify;let t="";e&&"schema"in e&&(t="string"==typeof e.schema?e.schema:JSON.stringify(e.schema,null,2));return`\n        <div class="cr-form-group cr-form-group--grow">\n            <div class="cr-row cr-row--between">\n                <label class="cr-label" for="${h.pW}_drawer_schema">\n                    JSON Schema <span class="cr-required">*</span>\n                </label>\n            </div>\n\n            \x3c!-- Schema Toolbar --\x3e\n            <div class="cr-editor-toolbar">\n                <button id="${h.pW}_drawer_generate"\n                        class="menu_button menu_button--sm menu_button--primary"\n                        type="button"\n                        title="Generate schema from description using AI">\n                    <i class="fa-solid fa-wand-magic-sparkles"></i>\n                    AI Generate\n                </button>\n                <div class="cr-toolbar-divider"></div>\n                <button id="${h.pW}_drawer_validate"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Validate JSON schema">\n                    <i class="fa-solid fa-check-circle"></i>\n                    Validate\n                </button>\n                <button id="${h.pW}_drawer_format"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Format JSON">\n                    <i class="fa-solid fa-align-left"></i>\n                    Format\n                </button>\n                <button id="${h.pW}_drawer_minify"\n                        class="menu_button menu_button--sm"\n                        type="button"\n                        title="Minify JSON">\n                    <i class="fa-solid fa-compress"></i>\n                </button>\n            </div>\n\n            \x3c!-- Schema Editor with syntax highlighting --\x3e\n            <div class="cr-code-editor" id="${h.pW}_drawer_schema_wrap">\n                <pre class="cr-code-editor__highlight" id="${h.pW}_drawer_schema_highlight" aria-hidden="true"><code class="language-json"></code></pre>\n                <textarea id="${h.pW}_drawer_schema"\n                          class="cr-code-editor__textarea cr-textarea--code text_pole"\n                          placeholder='{"name": "MySchema", "strict": true, "schema": {...}}'\n                          spellcheck="false">${r.sanitize(t)}</textarea>\n            </div>\n\n            \x3c!-- Validation messages --\x3e\n            <div id="${h.pW}_drawer_errors" class="cr-errors cr-hidden"></div>\n            <div id="${h.pW}_drawer_warnings" class="cr-warnings cr-hidden"></div>\n        </div>\n    `}()}\n        </div>\n    `}function Be(){const{mode:e,preset:r}=Ne,t=(null==r?void 0:r.isBuiltin)||!1,n="create"===e?"Create Preset":"edit"===e?"Save Changes":"Create Copy";return`\n        <footer class="cr-drawer__footer">\n            <div class="cr-row cr-row--between cr-flex-1">\n                <div class="cr-row">\n                    ${r&&!t&&"edit"===e?`\n                        <button id="${h.pW}_drawer_delete"\n                                class="menu_button menu_button--danger"\n                                type="button">\n                            <i class="fa-solid fa-trash"></i>\n                            Delete\n                        </button>\n                    `:""}\n                </div>\n                <div class="cr-row cr-gap-2">\n                    <button id="${h.pW}_drawer_cancel"\n                            class="menu_button"\n                            type="button">\n                        Cancel\n                    </button>\n                    <button id="${h.pW}_drawer_save"\n                            class="menu_button menu_button--primary"\n                            type="button">\n                        <i class="fa-solid fa-check"></i>\n                        ${n}\n                    </button>\n                </div>\n            </div>\n        </footer>\n    `}function He(){const{type:e}=Ne,r=[..."prompt"===e?b.presetRegistry.getPromptPresets():b.presetRegistry.getSchemaPresets()].sort((e,r)=>e.isBuiltin!==r.isBuiltin?e.isBuiltin?1:-1:e.name.localeCompare(r.name)),t=r.filter(e=>!e.isBuiltin).length,n=r.filter(e=>e.isBuiltin).length;return`\n        <div class="cr-drawer__body cr-drawer__body--list">\n            ${0===r.length?`\n                <div class="cr-empty cr-empty--compact">\n                    <i class="fa-solid fa-bookmark cr-empty__icon"></i>\n                    <div class="cr-empty__title">No ${e} presets</div>\n                    <div class="cr-empty__text">Create one to get started</div>\n                </div>\n            `:`\n                <div class="cr-preset-list cr-scrollable">\n                    ${t>0?'<div class="cr-preset-list__section-label">Custom</div>':""}\n                    ${r.filter(e=>!e.isBuiltin).map(r=>Ge(r,e)).join("")}\n                    ${n>0?'<div class="cr-preset-list__section-label">Built-in</div>':""}\n                    ${r.filter(e=>e.isBuiltin).map(r=>Ge(r,e)).join("")}\n                </div>\n            `}\n        </div>\n    `}function Ge(e,r){const t=SillyTavern.libs.DOMPurify,n=e.stages.length>0?e.stages.map(e=>h.BA[e]).join(", "):"All stages";return`\n        <div class="cr-preset-list__item ${e.isBuiltin?"cr-preset-list__item--builtin":""}"\n             data-id="${e.id}"\n             data-type="${r}">\n            <button class="cr-preset-list__select" type="button" title="Apply this preset">\n                <div class="cr-preset-list__info">\n                    <span class="cr-preset-list__name">\n                        ${e.isBuiltin?'<i class="fa-solid fa-lock cr-text-dim"></i>':""}\n                        ${t.sanitize(e.name)}\n                    </span>\n                    <span class="cr-preset-list__stages">${n}</span>\n                </div>\n            </button>\n            <div class="cr-preset-list__actions">\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Edit">\n                        <i class="fa-solid fa-pen"></i>\n                    </button>\n                '}\n                <button class="cr-preset-list__action cr-preset-list__action--duplicate menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        type="button" title="${e.isBuiltin?"Create editable copy":"Duplicate"}">\n                    <i class="fa-solid fa-copy"></i>\n                </button>\n                ${e.isBuiltin?"":'\n                    <button class="cr-preset-list__action cr-preset-list__action--delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                '}\n            </div>\n        </div>\n    `}function Ue(e,r){Ne={isOpen:!0,type:e,mode:"list",preset:null,activeTab:"edit"},Ie=r||{},Je()}function qe(){const e=ce(`#${h.pW}_preset_drawer`);e&&(e.classList.remove("cr-drawer--open"),e.setAttribute("aria-hidden","true"),setTimeout(()=>{var e;De.forEach(e=>e()),De=[],Ne.isOpen=!1,null===(e=Ie.onClose)||void 0===e||e.call(Ie)},300))}function Je(){const e=ce(`#${h.pW}_preset_drawer`);if(!e)return void h.Rm.error("Drawer not initialized");const r=ce(".cr-drawer__panel",e);r&&("list"===Ne.mode?r.innerHTML=`\n                <div class="cr-drawer__content cr-drawer__content--list">\n                    ${function(){const{type:e}=Ne;return`\n        <header class="cr-drawer__header">\n            <div class="cr-drawer__title">\n                <i class="fa-solid fa-bookmark cr-text-accent"></i>\n                <h3>Manage Presets</h3>\n            </div>\n            <button id="${h.pW}_drawer_close"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    aria-label="Close drawer">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </header>\n        <div class="cr-drawer__tabs">\n            <button class="cr-drawer__tab ${"prompt"===e?"cr-drawer__tab--active":""}"\n                    data-tab="prompt" type="button">\n                <i class="fa-solid fa-message"></i>\n                Prompts\n            </button>\n            <button class="cr-drawer__tab ${"schema"===e?"cr-drawer__tab--active":""}"\n                    data-tab="schema" type="button">\n                <i class="fa-solid fa-code"></i>\n                Schemas\n            </button>\n        </div>\n    `}()}\n                    ${He()}\n                    \n        <footer class="cr-drawer__footer cr-drawer__footer--list">\n            <button id="${h.pW}_drawer_list_create"\n                    class="menu_button menu_button--primary"\n                    type="button">\n                <i class="fa-solid fa-plus"></i>\n                New Preset\n            </button>\n            <div class="cr-row cr-gap-2">\n                <button id="${h.pW}_drawer_list_import"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Import presets from file">\n                    <i class="fa-solid fa-file-import"></i>\n                </button>\n                <button id="${h.pW}_drawer_list_export"\n                        class="menu_button menu_button--ghost"\n                        type="button"\n                        title="Export custom presets">\n                    <i class="fa-solid fa-file-export"></i>\n                </button>\n            </div>\n        </footer>\n    \n                </div>\n            `:r.innerHTML=`\n                <div class="cr-drawer__content">\n                    ${Me()}\n                    ${Fe()}\n                    ${Be()}\n                </div>\n            `),"list"===Ne.mode?function(e){const r=ce(`#${h.pW}_drawer_close`,e);r&&De.push(de(r,"click",qe));const t=ce(".cr-drawer__backdrop",e);t&&De.push(de(t,"click",qe));const n=le(".cr-drawer__tab",e);for(const r of n)De.push(de(r,"click",()=>{const t=r.dataset.tab;if(t===Ne.type)return;Ne.type=t,n.forEach(e=>e.classList.remove("cr-drawer__tab--active")),r.classList.add("cr-drawer__tab--active");const a=ce(".cr-drawer__body--list",e);a&&(a.outerHTML=He())}));const a=ce(".cr-preset-list",e);a&&De.push(de(a,"click",r=>We(this,void 0,void 0,function*(){var t,n;const a=r.target,i=a.closest(".cr-preset-list__item");if(!i)return;const o=i.dataset.id,s=i.dataset.type;if(!o||!s)return;const c="prompt"===s?b.presetRegistry.getPromptPreset(o):b.presetRegistry.getSchemaPreset(o);if(c){if(a.closest(".cr-preset-list__select"))return null===(t=Ie.onSelect)||void 0===t||t.call(Ie,c),void qe();if(a.closest(".cr-preset-list__action--edit"))!function(e,r){const t="prompt"===e?b.presetRegistry.getPromptPreset(r):b.presetRegistry.getSchemaPreset(r);if(!t)return;De.forEach(e=>e()),De=[],Ne.mode="edit",Ne.type=e,Ne.preset=t;const n=ce(`#${h.pW}_preset_drawer`);if(!n)return;const a=ce(".cr-drawer__panel",n);a&&(a.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Me()}\n                ${Fe()}\n                ${Be()}\n            </div>\n        `);Ve(n);const i=ce(`#${h.pW}_drawer_name`,n);i&&(i.focus(),i.select());"schema"===e&&Ye()}(s,o);else if(a.closest(".cr-preset-list__action--duplicate"))!function(e,r){const t="prompt"===e?b.presetRegistry.getPromptPreset(r):b.presetRegistry.getSchemaPreset(r);if(!t)return;De.forEach(e=>e()),De=[],Ne.mode="duplicate",Ne.type=e,Ne.preset=t;const n=ce(`#${h.pW}_preset_drawer`);if(!n)return;const a=ce(".cr-drawer__panel",n);a&&(a.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Me()}\n                ${Fe()}\n                ${Be()}\n            </div>\n        `);Ve(n);const i=ce(`#${h.pW}_drawer_name`,n);i&&(i.focus(),i.select());"schema"===e&&Ye()}(s,o);else if(a.closest(".cr-preset-list__action--delete")){if(!(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${c.name}"?`)))return;"prompt"===s?b.presetRegistry.deletePromptPreset(o):b.presetRegistry.deleteSchemaPreset(o),h.oR.success("Preset deleted"),null===(n=Ie.onUpdate)||void 0===n||n.call(Ie),Ze(e)}}})));const i=ce(`#${h.pW}_drawer_list_create`,e);i&&De.push(de(i,"click",()=>{!function(e){De.forEach(e=>e()),De=[],Ne.mode="create",Ne.type=e,Ne.preset=null;const r=ce(`#${h.pW}_preset_drawer`);if(!r)return;const t=ce(".cr-drawer__panel",r);t&&(t.innerHTML=`\n            <div class="cr-drawer__content">\n                ${Me()}\n                ${Fe()}\n                ${Be()}\n            </div>\n        `);Ve(r);const n=ce(`#${h.pW}_drawer_name`,r);n&&n.focus()}(Ne.type)}));const o=ce(`#${h.pW}_drawer_list_import`,e);o&&De.push(de(o,"click",er));const s=ce(`#${h.pW}_drawer_list_export`,e);s&&De.push(de(s,"click",rr));const c=e=>{"Escape"===e.key&&Ne.isOpen&&(e.preventDefault(),e.stopPropagation(),qe())};document.addEventListener("keydown",c),De.push(()=>document.removeEventListener("keydown",c))}(e):Ve(e),requestAnimationFrame(()=>{if(e.classList.add("cr-drawer--open"),e.setAttribute("aria-hidden","false"),"list"!==Ne.mode){const r=ce(`#${h.pW}_drawer_name`,e);r&&(r.focus(),r.select()),"schema"===Ne.type&&Ye()}})}function Ve(e){const r=ce(`#${h.pW}_drawer_close`,e);r&&De.push(de(r,"click",qe));const t=ce(".cr-drawer__backdrop",e);t&&De.push(de(t,"click",qe));const n=ce(`#${h.pW}_drawer_cancel`,e);n&&De.push(de(n,"click",qe));const a=ce(`#${h.pW}_drawer_save`,e);a&&De.push(de(a,"click",Qe));const i=ce(`#${h.pW}_drawer_delete`,e);i&&De.push(de(i,"click",Xe));const o=le('.cr-chip input[name="drawer_stages"]',e);for(const e of o)De.push(de(e,"change",()=>{const r=e.closest(".cr-chip");r&&r.classList.toggle("cr-chip--active",e.checked)}));"prompt"===Ne.type?function(e){const r=ce(`#${h.pW}_drawer_prompt`,e);if(r){const e=SillyTavern.libs.lodash.debounce(()=>We(this,void 0,void 0,function*(){const e=ce(`#${h.pW}_drawer_prompt_tokens`);if(!e)return;const t=r.value,n=Math.ceil(t.length/4);e.textContent=`~${n} tokens`}),300);De.push(de(r,"input",()=>{e()})),e()}const t=ce(`#${h.pW}_drawer_prompt_vars`,e);t&&De.push(de(t,"click",()=>We(this,void 0,void 0,function*(){yield h.lY.alert("Available Variables",'\n                    <div class="cr-stack">\n                        <p>Use these placeholders in your prompt:</p>\n                        <ul class="cr-list cr-text-sm">\n                            <li><code>{{character}}</code> - Full character summary</li>\n                            <li><code>{{name}}</code> - Character name</li>\n                            <li><code>{{description}}</code> - Character description</li>\n                            <li><code>{{personality}}</code> - Personality traits</li>\n                            <li><code>{{scenario}}</code> - Scenario/setting</li>\n                            <li><code>{{first_mes}}</code> - First message</li>\n                            <li><code>{{mes_example}}</code> - Example messages</li>\n                            <li><code>{{system_prompt}}</code> - System prompt</li>\n                            <li><code>{{creator_notes}}</code> - Creator notes</li>\n                        </ul>\n                    </div>\n                ')})))}(e):function(e){const r=ce(`#${h.pW}_drawer_schema`,e);if(r){const e=SillyTavern.libs.lodash.debounce(()=>{Ye()},100);De.push(de(r,"input",()=>{e()})),De.push(de(r,"scroll",()=>{!function(e){const r=ce(`#${h.pW}_drawer_schema_highlight`);r&&(r.scrollTop=e.scrollTop,r.scrollLeft=e.scrollLeft)}(r)}))}const t=ce(`#${h.pW}_drawer_generate`,e);t&&De.push(de(t,"click",()=>We(this,void 0,void 0,function*(){const e=yield h.lY.input("Generate Schema","Describe the structure you want:","e.g., rating 1-10, list of strengths and weaknesses, summary paragraph");if(!e)return;t.setAttribute("disabled","true");const n=t.querySelector("i"),a=null==n?void 0:n.className;n&&(n.className="fa-solid fa-spinner fa-spin");try{const t=yield(0,E.nr)(e);t.success&&t.schema&&r?(r.value=t.schema,Ye(),h.oR.success("Schema generated"),function(){const e=ce(`#${h.pW}_drawer_errors`),r=ce(`#${h.pW}_drawer_warnings`);null==e||e.classList.add("cr-hidden"),null==r||r.classList.add("cr-hidden")}()):h.oR.error(t.error||"Generation failed")}catch(e){h.oR.error(`Failed: ${e.message}`)}finally{t.removeAttribute("disabled"),n&&a&&(n.className=a)}})));const n=ce(`#${h.pW}_drawer_validate`,e);n&&r&&De.push(de(n,"click",()=>{!function(e){var r;const t=ce(`#${h.pW}_drawer_errors`),n=ce(`#${h.pW}_drawer_warnings`);t&&(e.valid?(t.classList.add("cr-hidden"),h.oR.success("Schema is valid")):(t.innerHTML=`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e.error}</div>`,t.classList.remove("cr-hidden")));n&&((null===(r=e.warnings)||void 0===r?void 0:r.length)?(n.innerHTML=e.warnings.map(e=>`<div class="cr-warning"><i class="fa-solid fa-exclamation-triangle"></i> ${e}</div>`).join(""),n.classList.remove("cr-hidden")):n.classList.add("cr-hidden"))}((0,E.i6)(r.value))}));const a=ce(`#${h.pW}_drawer_format`,e);a&&r&&De.push(de(a,"click",()=>{try{const e=JSON.parse(r.value);r.value=(0,E.jf)(e),Ye(),h.oR.success("Formatted")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const i=ce(`#${h.pW}_drawer_minify`,e);i&&r&&De.push(de(i,"click",()=>{try{const e=JSON.parse(r.value);r.value=JSON.stringify(e),Ye(),h.oR.success("Minified")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}))}(e);const s=e=>{"Escape"===e.key&&Ne.isOpen&&(e.preventDefault(),e.stopPropagation(),qe())};document.addEventListener("keydown",s),De.push(()=>document.removeEventListener("keydown",s))}function Ye(){const e=ce(`#${h.pW}_drawer_schema`),r=ce(`#${h.pW}_drawer_schema_highlight code`);if(!e||!r)return;const t=SillyTavern.libs.hljs,n=SillyTavern.libs.DOMPurify;try{const a=t.highlight(e.value||" ",{language:"json"});r.innerHTML=n.sanitize(a.value)}catch(t){r.textContent=e.value}}function Qe(){return We(this,void 0,void 0,function*(){var e,r;const{type:t,mode:n,preset:a}=Ne,i=ce(`#${h.pW}_drawer_name`),o=(null==i?void 0:i.value.trim())||"",s=le('input[name="drawer_stages"]:checked'),c=Array.from(s).map(e=>e.value),l=c.length===h.an.length?[]:c;if("prompt"===t){const r=ce(`#${h.pW}_drawer_prompt`),t=(null==r?void 0:r.value)||"",i=(0,b.validatePromptPreset)({name:o,prompt:t,stages:l});if(!i.valid)return void Ke(i.errors);const s="edit"===n?null==a?void 0:a.id:void 0;if(!b.presetRegistry.isNameUnique("prompt",o,s))return void Ke(["A preset with this name already exists"]);let c;"edit"===n&&a?(b.presetRegistry.updatePromptPreset(a.id,{name:o,prompt:t,stages:l}),c=b.presetRegistry.getPromptPreset(a.id),h.oR.success("Preset updated")):(c=b.presetRegistry.registerPromptPreset({name:o,prompt:t,stages:l}),h.oR.success("Preset created")),null===(e=Ie.onSave)||void 0===e||e.call(Ie,c),qe()}else{const e=ce(`#${h.pW}_drawer_schema`),t=(null==e?void 0:e.value)||"";let i;try{i=JSON.parse(t)}catch(e){return void Ke([`Invalid JSON: ${e.message}`])}const s=(0,b.validateSchemaPreset)({name:o,schema:i,stages:l});if(!s.valid)return void Ke(s.errors);const c="edit"===n?null==a?void 0:a.id:void 0;if(!b.presetRegistry.isNameUnique("schema",o,c))return void Ke(["A preset with this name already exists"]);let d;"edit"===n&&a?(b.presetRegistry.updateSchemaPreset(a.id,{name:o,schema:i,stages:l}),d=b.presetRegistry.getSchemaPreset(a.id),h.oR.success("Schema preset updated")):(d=b.presetRegistry.registerSchemaPreset({name:o,schema:i,stages:l}),h.oR.success("Schema preset created")),null===(r=Ie.onSave)||void 0===r||r.call(Ie,d),qe()}})}function Ke(e){const r=ce(`#${h.pW}_drawer_errors`);r&&(r.innerHTML=e.map(e=>`<div class="cr-error"><i class="fa-solid fa-times-circle"></i> ${e}</div>`).join(""),r.classList.remove("cr-hidden"))}function Xe(){return We(this,void 0,void 0,function*(){const{type:e,preset:r}=Ne;if(!r)return;(yield h.lY.confirm("Delete Preset",`Are you sure you want to delete "${r.name}"?`))&&("prompt"===e?b.presetRegistry.deletePromptPreset(r.id):b.presetRegistry.deleteSchemaPreset(r.id),h.oR.success("Preset deleted"),qe())})}function Ze(e){const r=ce(".cr-drawer__body--list",e);r&&(r.outerHTML=He())}function er(){return We(this,void 0,void 0,function*(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=e=>We(this,void 0,void 0,function*(){var r,t;const n=null===(r=e.target.files)||void 0===r?void 0:r[0];if(n)try{const e=yield n.text(),r=JSON.parse(e),a=(0,b.getSettings)();let i=0;if(Array.isArray(r.promptPresets))for(const e of r.promptPresets)e.isBuiltin||(e.id=crypto.randomUUID(),a.promptPresets.push(e),i++);if(Array.isArray(r.schemaPresets))for(const e of r.schemaPresets)e.isBuiltin||(e.id=crypto.randomUUID(),a.schemaPresets.push(e),i++);(0,b.save)(),h.oR.success(`Imported ${i} preset${1!==i?"s":""}`),null===(t=Ie.onUpdate)||void 0===t||t.call(Ie);const o=ce(`#${h.pW}_preset_drawer`);o&&"list"===Ne.mode&&Ze(o)}catch(e){h.oR.error("Failed to import presets"),console.error("Import error:",e)}}),e.click()})}function rr(){const e=(0,b.getSettings)(),r=e.promptPresets.filter(e=>!e.isBuiltin),t=e.schemaPresets.filter(e=>!e.isBuiltin);if(0===r.length&&0===t.length)return void h.oR.warning("No custom presets to export");const n={version:h.xv,exportedAt:(new Date).toISOString(),promptPresets:r,schemaPresets:t},a=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),i=URL.createObjectURL(a),o=document.createElement("a");o.href=i,o.download=`character-tools-presets-${(new Date).toISOString().slice(0,10)}.json`,o.click(),URL.revokeObjectURL(i),h.oR.success(`Exported ${r.length+t.length} preset${r.length+t.length!==1?"s":""}`)}var tr=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let nr=[];function ar(){const e=D();if(!e.character)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-user-slash cr-empty__icon"></i>\n                <div class="cr-empty__title">No character selected</div>\n                <div class="cr-empty__text">Select a character to see available fields</div>\n            </div>\n        ';const r=P(e.character);return 0===r.length?'\n            <div class="cr-empty">\n                <i class="fa-solid fa-file-circle-question cr-empty__icon"></i>\n                <div class="cr-empty__title">No fields</div>\n                <div class="cr-empty__text">This character has no populated fields</div>\n            </div>\n        ':(requestAnimationFrame(()=>function(e){return tr(this,void 0,void 0,function*(){const r=e.filter(e=>"alternate_greetings"!==e.key).map(e=>({key:e.key,text:e.value}));if(0===r.length)return;const t=yield(0,h.gg)(r);for(const{key:e,tokens:r}of t){const t=ce(`.cr-field-tokens[data-field="${e}"]`);t&&(t.textContent=pe(r))}})}(r)),`\n        <div class="cr-field-list cr-scrollable">\n            ${r.map(e=>function(e){const r=SillyTavern.libs.DOMPurify,t=Y(),n=e.key in t&&!1!==t[e.key];if("alternate_greetings"===e.key&&Array.isArray(e.rawValue)){const n=e.rawValue,a=Array.isArray(t[e.key])?t[e.key]:[],i=a.length===n.length;return`\n            <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n                <div class="cr-field-item cr-field-item--parent">\n                    <label class="cr-field-label">\n                        <input type="checkbox"\n                               class="cr-field-checkbox cr-field-checkbox--parent"\n                               data-field="${e.key}"\n                               ${i?"checked":""}\n                               ${a.length>0&&!i?"indeterminate":""} />\n                        <span class="cr-field-name">${r.sanitize(e.label)}</span>\n                    </label>\n                    <span class="cr-field-count">${n.length} greetings</span>\n                    <button class="cr-field-expand" type="button" aria-label="Expand">\n                        <i class="fa-solid fa-chevron-down"></i>\n                    </button>\n                </div>\n                <div class="cr-field-children">\n                    ${n.map((r,t)=>`\n                        <div class="cr-field-item cr-field-item--child">\n                            <label class="cr-field-label">\n                                <input type="checkbox"\n                                       class="cr-field-checkbox cr-field-checkbox--child"\n                                       data-field="${e.key}"\n                                       data-index="${t}"\n                                       ${a.includes(t)?"checked":""} />\n                                <span class="cr-field-name">Greeting ${t+1}</span>\n                            </label>\n                            <button class="cr-field-preview-btn" type="button" data-field="${e.key}" data-index="${t}" title="Preview greeting">\n                                <i class="fa-solid fa-eye"></i>\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n            </div>\n        `}const a=150,i=e.value.length>a?e.value.substring(0,a).trim()+"…":e.value;return`\n        <div class="cr-field-group cr-field-group--expandable" data-field="${e.key}">\n            <div class="cr-field-item cr-field-item--has-preview">\n                <label class="cr-field-label">\n                    <input type="checkbox"\n                           class="cr-field-checkbox"\n                           data-field="${e.key}"\n                           ${n?"checked":""} />\n                    <span class="cr-field-name">${r.sanitize(e.label)}</span>\n                </label>\n                <span class="cr-field-tokens" data-field="${e.key}">${pe(e.tokens)}</span>\n                <button class="cr-field-expand" type="button" aria-label="Expand field preview">\n                    <i class="fa-solid fa-chevron-down"></i>\n                </button>\n            </div>\n            <div class="cr-field-preview">\n                <pre class="cr-field-preview__text">${r.sanitize(i)}</pre>\n                <button class="cr-field-preview__more" type="button" data-field="${e.key}" title="View full content in popup">\n                    <i class="fa-solid fa-expand"></i>\n                    <span>View full content</span>\n                </button>\n            </div>\n        </div>\n    `}(e)).join("")}\n        </div>\n    `)}function ir(e,r,t){const n=SillyTavern.libs.DOMPurify,a="prompt"===e?(0,b.getPromptPresetsForStage)(r):(0,b.getSchemaPresetsForStage)(r);return`\n        <div class="cr-preset-row">\n            <select id="${`${h.pW}_${e}_select`}" class="cr-select text_pole" aria-label="${e} preset">\n                <option value="">Custom</option>\n                ${a.map(e=>`\n                    <option value="${e.id}" ${e.id===t?"selected":""}>\n                        ${n.sanitize(e.name)}${e.isBuiltin?"":" ✦"}\n                    </option>\n                `).join("")}\n            </select>\n            <button class="cr-preset-manage-btn menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                    data-type="${e}"\n                    type="button"\n                    title="Manage ${e} presets">\n                <i class="fa-solid fa-folder-open"></i>\n            </button>\n        </div>\n    `}function or(e,r,t){const n=ce(`#${`${h.pW}_${e}_select`}`);if(!n)return;const a=SillyTavern.libs.DOMPurify,i=`\n        <option value="">Custom</option>\n        ${("prompt"===e?(0,b.getPromptPresetsForStage)(r):(0,b.getSchemaPresetsForStage)(r)).map(e=>`\n            <option value="${e.id}" ${e.id===t?"selected":""}>\n                ${a.sanitize(e.name)}${e.isBuiltin?"":" ✦"}\n            </option>\n        `).join("")}\n    `;n.innerHTML=i}function sr(){const e=ce(".cr-stage-config");if(!e)return;const r=D(),t=r.activeStage,n=r.stageConfigs[t],a=e.querySelector(".cr-section__title");a&&(a.innerHTML=`\n            <i class="fa-solid ${h.iu[t]}"></i>\n            ${h.BA[t]} Configuration\n        `);const i=ce(`#${h.pW}_fields_container`);i&&(i.innerHTML=ar());const o=ce(`#${h.pW}_prompt`);if(o){let e=n.customPrompt;if(!e&&n.promptPresetId){const r=(0,b.getPromptPreset)(n.promptPresetId);r&&(e=r.prompt)}o.value=e,cr(o.value)}or("prompt",t,n.promptPresetId);const s=ce(`#${h.pW}_use_schema`);s&&(s.checked=n.useStructuredOutput);const c=ce(`#${h.pW}_schema_section`);c&&c.classList.toggle("cr-hidden",!n.useStructuredOutput),or("schema",t,n.schemaPresetId);const l=ce(`#${h.pW}_schema`);if(l){let e=n.customSchema;if(!e&&n.schemaPresetId){const r=(0,b.getSchemaPreset)(n.schemaPresetId);r&&(e=JSON.stringify(r.schema,null,2))}l.value=e}}function cr(e){return tr(this,void 0,void 0,function*(){const r=ce(`#${h.pW}_prompt_tokens`);if(!r)return;const t=yield(0,h.NR)(e);r.textContent=null!==t?`~${t} tokens`:`~${Math.ceil(e.length/4)} tokens`})}function lr(e){const r=SillyTavern.libs.DOMPurify,t=[],n=ce(`#${h.pW}_link_fields`,e);n&&t.push(de(n,"click",()=>{!function(){const e=D();if(e.stageFields.linked=!e.stageFields.linked,!e.stageFields.linked){const{lodash:r}=SillyTavern.libs;e.stageFields.overrides[e.activeStage]=r.cloneDeep(e.stageFields.base)}F()}();const e=Q();n.classList.toggle("cr-active",e),n.setAttribute("aria-pressed",String(e)),n.title=e?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)";const r=n.querySelector("i");r&&(r.className="fa-solid "+(e?"fa-link":"fa-link-slash")),sr()}));const a=ce(`#${h.pW}_fields_container`,e);a&&(t.push(de(a,"change",e=>{const r=e.target;if(!r.classList.contains("cr-field-checkbox"))return;const t=r.dataset.field;if(t){if(void 0!==r.dataset.index){const e=parseInt(r.dataset.index,10),n=Y(),a=Array.isArray(n[t])?[...n[t]]:[];if(r.checked)a.includes(e)||a.push(e);else{const r=a.indexOf(e);-1!==r&&a.splice(r,1)}K(t,a.length>0&&a.sort((e,r)=>e-r))}else if(r.classList.contains("cr-field-checkbox--parent")){const e=r.closest(".cr-field-group");if(!e)return;const n=le(".cr-field-checkbox--child",e);if(r.checked){K(t,n.map((e,r)=>r))}else K(t,!1)}else K(t,r.checked);!function(){const e=ce(`#${h.pW}_fields_container`);if(!e)return;const r=le(".cr-field-group",e);for(const e of r){if(!e.dataset.field)continue;const r=ce(".cr-field-checkbox--parent",e),t=le(".cr-field-checkbox--child",e);if(!r)continue;const n=t.filter(e=>e.checked).length,a=t.length;0===n?(r.checked=!1,r.indeterminate=!1):n===a?(r.checked=!0,r.indeterminate=!1):(r.checked=!1,r.indeterminate=!0)}}()}})),t.push(de(a,"click",e=>{const r=e.target.closest(".cr-field-expand");if(!r)return;const t=r.closest(".cr-field-group");t&&t.classList.toggle("cr-field-group--expanded")})),t.push(de(a,"click",e=>tr(this,void 0,void 0,function*(){const r=e.target.closest(".cr-field-preview__more");if(!r)return;const t=r.dataset.field;if(!t)return;const n=D();if(!n.character)return;const a=P(n.character).find(e=>e.key===t);a&&h.lY.alert(a.label,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(a.value)}</pre>`)}))),t.push(de(a,"click",e=>tr(this,void 0,void 0,function*(){const r=e.target.closest(".cr-field-preview-btn");if(!r)return;const t=r.dataset.field,n=r.dataset.index;if(!t||void 0===n)return;const a=D();if(!a.character)return;const i=P(a.character).find(e=>e.key===t);if(!i||!Array.isArray(i.rawValue))return;const o=parseInt(n,10),s=i.rawValue[o];s&&h.lY.alert(`Greeting ${o+1}`,`<pre class="cr-popup-preview">${SillyTavern.libs.DOMPurify.sanitize(s)}</pre>`)}))));const i=ce(`#${h.pW}_prompt`,e);if(i){const e=SillyTavern.libs.lodash.debounce(e=>{Z(D().activeStage,{customPrompt:e,promptPresetId:null}),cr(e)},300);nr.push(e),t.push(de(i,"input",()=>{e(i.value)})),cr(i.value)}const o=ce(`#${h.pW}_prompt_select`,e);o&&t.push(de(o,"change",()=>{const e=D(),r=o.value||null;if(Z(e.activeStage,{promptPresetId:r,customPrompt:""}),r){const e=(0,b.getPromptPreset)(r);e&&i&&(i.value=e.prompt,cr(e.prompt))}}));const s=ce(`#${h.pW}_save_prompt`,e);s&&t.push(de(s,"click",()=>tr(this,void 0,void 0,function*(){const e=D(),r=(null==i?void 0:i.value)||"";if(!r.trim())return void h.oR.warning("Enter a prompt first");const t=yield h.lY.input("Save Prompt Preset","Enter a name for this preset:",`${h.BA[e.activeStage]} Custom`);if(!t)return;const n=(0,b.savePromptPreset)({name:t.trim(),stages:[e.activeStage],prompt:r});h.oR.success(`Saved preset "${n.name}"`),sr()})));const c=ce(`#${h.pW}_use_schema`,e),l=ce(`#${h.pW}_schema_section`,e);c&&l&&t.push(de(c,"change",()=>{Z(D().activeStage,{useStructuredOutput:c.checked}),l.classList.toggle("cr-hidden",!c.checked)}));const d=ce(`#${h.pW}_schema`,e);if(d){const e=SillyTavern.libs.lodash.debounce(e=>{Z(D().activeStage,{customSchema:e,schemaPresetId:null})},300);nr.push(e),t.push(de(d,"input",()=>{e(d.value)}))}const p=ce(`#${h.pW}_validate_schema`,e);p&&d&&t.push(de(p,"click",()=>{try{JSON.parse(d.value),h.oR.success("Valid JSON")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const u=ce(`#${h.pW}_format_schema`,e);u&&d&&t.push(de(u,"click",()=>{try{const e=JSON.parse(d.value);d.value=JSON.stringify(e,null,2),h.oR.success("Formatted")}catch(e){h.oR.error(`Invalid JSON: ${e.message}`)}}));const f=ce(`#${h.pW}_preview`,e);f&&t.push(de(f,"click",()=>tr(this,void 0,void 0,function*(){const e=D();if(!e.character)return void h.oR.warning("Select a character first");let t=R(e.character,e.selectedFields);e.userGuidance.trim()&&(t+=`\n\n---\n\n## USER GUIDANCE\n\n${e.userGuidance}`),yield h.lY.alert("Prompt Preview",`<div class="cr-preview-content"><pre>${r.sanitize(t)}</pre></div>`)})));const v=le(".cr-preset-manage-btn",e);for(const e of v)t.push(de(e,"click",()=>{const r=e.dataset.type;Ue(r,{onSelect:e=>{const t=D();Z(t.activeStage,"prompt"===r?{promptPresetId:e.id,customPrompt:""}:{schemaPresetId:e.id,customSchema:""}),sr()},onUpdate:()=>{sr()}})}));return()=>{t.forEach(e=>e())}}var dr=t(691);function pr(e){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[e.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function ur(){const e=D(),r=[];if(!e.character)return r;const t=P(e.character),n=e.stageResults.rewrite,a=(null==n?void 0:n.output)?function(e){var r,t;const n={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,i=[];let o;for(;null!==(o=a.exec(e));)i.push({name:o[1].trim().toLowerCase(),start:o.index+o[0].length});for(let a=0;a<i.length;a++){const o=i[a],s=null!==(t=null===(r=i[a+1])||void 0===r?void 0:r.start)&&void 0!==t?t:e.length,c=e.slice(o.start,s).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=pr(o.name);l&&c&&(n[l]=c)}return n}(n.output):{};for(const e of t){const t=a[e.key]||null;r.push({key:e.key,label:e.label,original:e.value,rewritten:t,hasChanges:null!==t&&t!==e.value})}return r}function fr(e){const r=SillyTavern.libs.DOMPurify;if(!e.rewritten)return`\n            <div class="cr-compare-row cr-compare-row--unchanged">\n                <div class="cr-compare-row__header">\n                    <span class="cr-compare-row__label">${e.label}</span>\n                    <span class="cr-badge cr-badge--small cr-badge--muted">No changes</span>\n                </div>\n                <div class="cr-compare-row__content cr-compare-row__content--single">\n                    <pre class="cr-compare-text">${r.sanitize(e.original)}</pre>\n                </div>\n            </div>\n        `;const{originalHtml:t,rewrittenHtml:n}=function(e,r){const t=SillyTavern.libs.DOMPurify,n=new(0,SillyTavern.libs.DiffMatchPatch),a=n.diff_main(e,r);n.diff_cleanupSemantic(a);const i=[],o=[];for(const[e,r]of a){const n=t.sanitize(r);switch(e){case-1:i.push(`<span class="cr-diff--removed">${n}</span>`);break;case 1:o.push(`<span class="cr-diff--added">${n}</span>`);break;default:i.push(n),o.push(n)}}return{originalHtml:i.join(""),rewrittenHtml:o.join("")}}(e.original,e.rewritten),a=function(e,r){const t=(new(0,SillyTavern.libs.DiffMatchPatch)).diff_main(e,r);let n=0,a=0,i=0;for(const[e,r]of t){const t=r.length;switch(e){case-1:a+=t;break;case 1:n+=t;break;default:i+=t}}return{additions:n,deletions:a,unchanged:i}}(e.original,e.rewritten),i=a.additions>0||a.deletions>0;return`\n        <div class="cr-compare-row ${e.hasChanges?"cr-compare-row--changed":""}">\n            <div class="cr-compare-row__header">\n                <span class="cr-compare-row__label">${e.label}</span>\n                <div class="cr-compare-row__badges">\n                    ${e.hasChanges?'<span class="cr-badge cr-badge--small cr-badge--accent">Modified</span>':""}\n                    ${i?`<span class="cr-diff-stats"><span class="cr-diff-stats__add">+${a.additions}</span> <span class="cr-diff-stats__del">-${a.deletions}</span></span>`:""}\n                </div>\n            </div>\n            <div class="cr-compare-row__content">\n                <div class="cr-compare-col cr-compare-col--original">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-file"></i> Original\n                    </div>\n                    <pre class="cr-compare-text">${t}</pre>\n                </div>\n                <div class="cr-compare-col cr-compare-col--rewritten">\n                    <div class="cr-compare-col__header">\n                        <i class="fa-solid fa-pen-fancy"></i> Rewritten\n                    </div>\n                    <pre class="cr-compare-text">${n}</pre>\n                </div>\n            </div>\n        </div>\n    `}function vr(){const e=D();if(!e.character)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No character selected</div>\n                <div class="cr-empty__text">Select a character to compare versions</div>\n            </div>\n        ';if(!e.stageResults.rewrite)return'\n            <div class="cr-empty">\n                <i class="fa-solid fa-code-compare cr-empty__icon"></i>\n                <div class="cr-empty__title">No rewrite available</div>\n                <div class="cr-empty__text">Run the Rewrite stage first to see comparisons</div>\n            </div>\n        ';const r=ur(),t=r.filter(e=>e.hasChanges).length;return`\n        <div class="cr-compare-view">\n            <div class="cr-compare-header">\n                <div class="cr-compare-stats">\n                    <span class="cr-badge cr-badge--accent">${t} field${1!==t?"s":""} modified</span>\n                    <span class="cr-badge cr-badge--muted">${r.length-t} unchanged</span>\n                </div>\n            </div>\n            <div class="cr-compare-list cr-scrollable">\n                ${r.map(fr).join("")}\n            </div>\n        </div>\n    `}var mr=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function gr(e){return{description:"description",personality:"personality",firstmessage:"first_mes",greeting:"first_mes",scenario:"scenario",examplemessages:"mes_example",examples:"mes_example",systemprompt:"system_prompt",system:"system_prompt",posthistoryinstructions:"post_history_instructions",posthistory:"post_history_instructions",creatornotes:"creator_notes",notes:"creator_notes",alternategreetings:"alternate_greetings",greetings:"alternate_greetings"}[e.toLowerCase().replace(/[^a-z0-9]/g,"")]||null}function hr(){const e=D(),r=[];if(!e.character||!e.stageResults.rewrite)return r;const t=P(e.character),n=function(e){var r,t;const n={},a=/^#{2,3}\s*(.+?)[\s:]*$/gm,i=[];let o;for(;null!==(o=a.exec(e));)i.push({name:o[1].trim().toLowerCase(),start:o.index+o[0].length});for(let a=0;a<i.length;a++){const o=i[a],s=null!==(t=null===(r=i[a+1])||void 0===r?void 0:r.start)&&void 0!==t?t:e.length,c=e.slice(o.start,s).trim().replace(/^#{2,3}\s*.+$/gm,"").trim(),l=gr(o.name);l&&c&&(n[l]=c)}return n}(e.stageResults.rewrite.output);for(const e of t){const t=n[e.key];t&&t!==e.value&&r.push({key:e.key,label:e.label,original:e.value,rewritten:t,selected:!0})}return r}function br(e,r,t,n){return mr(this,void 0,void 0,function*(){const a=SillyTavern.getContext();try{return(yield fetch("/api/characters/edit-attribute",{method:"POST",headers:a.getRequestHeaders(),body:JSON.stringify({avatar_url:e,ch_name:r,field:t,value:n})})).ok}catch(e){return h.Rm.error(`Failed to edit attribute ${t}:`,e),!1}})}function yr(e){return mr(this,void 0,void 0,function*(){const r=SillyTavern.getContext();try{const t=yield fetch("/api/characters/export",{method:"POST",headers:r.getRequestHeaders(),body:JSON.stringify({avatar_url:e,format:"png"})});return t.ok?yield t.blob():null}catch(e){return h.Rm.error("Failed to export character:",e),null}})}function _r(e){return mr(this,void 0,void 0,function*(){const r=D();if(!r.character)return!1;const t=r.character,n=yield function(e){return mr(this,void 0,void 0,function*(){const r=SillyTavern.getContext();try{const t=yield fetch("/api/characters/export",{method:"POST",headers:r.getRequestHeaders(),body:JSON.stringify({avatar_url:e,format:"json"})});return t.ok?yield t.json():null}catch(e){return h.Rm.error("Failed to get character JSON:",e),null}})}(t.avatar);if(!n)return h.oR.error("Failed to get character data"),!1;for(const r of e)r.selected&&(n[r.key]=r.rewritten,n.data&&"object"==typeof n.data&&(n.data[r.key]=r.rewritten));const a=JSON.stringify(n,null,2),i=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(i),s=document.createElement("a");return s.href=o,s.download=`${t.name}_updated.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),h.oR.success("Character JSON downloaded!"),!0})}function xr(){return mr(this,void 0,void 0,function*(){const e=hr();if(0===e.length)return void h.oR.warning("No changes detected in the rewrite output.");const r=SillyTavern.libs.DOMPurify,t=`\n        <div class="cr-apply-dialog">\n            <p class="cr-apply-dialog__intro">\n                <strong>${e.length} field${e.length>1?"s":""}</strong> modified. \n                Select which fields to apply:\n            </p>\n            \n            <div class="cr-apply-dialog__fields">\n                ${e.map((e,t)=>`\n                    <div class="cr-apply-field">\n                        <label class="cr-apply-field__header">\n                            <input type="checkbox" \n                                   class="cr-apply-checkbox"\n                                   data-field-index="${t}" \n                                   ${e.selected?"checked":""}>\n                            <span class="cr-apply-field__label">${e.label}</span>\n                        </label>\n                        <div class="cr-apply-field__preview">\n                            <pre>${r.sanitize(e.rewritten.substring(0,300))}${e.rewritten.length>300?"...":""}</pre>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            \n            <div class="cr-apply-dialog__actions">\n                <button class="menu_button menu_button--sm cr-selecr-all-btn" type="button">\n                    Select All\n                </button>\n                <button class="menu_button menu_button--sm cr-selecr-none-btn" type="button">\n                    Select None\n                </button>\n            </div>\n            \n            <hr style="margin: 12px 0; border-color: var(--SmartThemeBorderColor);">\n            \n            <p class="cr-text-sm cr-text-dim">\n                <strong>Apply Directly</strong> - Updates the character card in SillyTavern immediately.<br>\n                <strong>Download PNG</strong> - Downloads the original card image with updated metadata.<br>\n                <strong>Download JSON</strong> - Downloads a JSON file you can import elsewhere.\n            </p>\n        </div>\n    `,n=SillyTavern.getContext();setTimeout(()=>{const e=document.querySelector(".cr-selecr-all-btn"),r=document.querySelector(".cr-selecr-none-btn");e&&e.addEventListener("click",()=>{document.querySelectorAll(".cr-apply-checkbox").forEach(e=>e.checked=!0)}),r&&r.addEventListener("click",()=>{document.querySelectorAll(".cr-apply-checkbox").forEach(e=>e.checked=!1)})},0);const a=yield n.callGenericPopup(t,n.POPUP_TYPE.CONFIRM,"",{okButton:"Apply Directly",cancelButton:"Cancel",customButtons:["Download PNG","Download JSON"],wide:!0});if(!1===a||void 0===a)return;const i=e.filter((e,r)=>{var t;const n=document.querySelector(`.cr-apply-checkbox[data-field-index="${r}"]`);return null!==(t=null==n?void 0:n.checked)&&void 0!==t&&t});0!==i.length?!0===a?yield function(e){return mr(this,void 0,void 0,function*(){const r=D();if(!r.character)return!1;const t=r.character;let n=0;for(const r of e)r.selected&&((yield br(t.avatar,t.name,r.key,r.rewritten))?n++:h.oR.error(`Failed to update ${r.label}`));if(n>0){const e=SillyTavern.getContext();yield e.getCharacters(),h.oR.success(`Applied ${n} update${n>1?"s":""} to character!`)}return n===e.filter(e=>e.selected).length})}(i):0===a?yield function(e){return mr(this,void 0,void 0,function*(){const r=D();if(!r.character)return!1;const t=r.character;let n=0;const a={};for(const r of e)r.selected&&(a[r.key]=r.original,(yield br(t.avatar,t.name,r.key,r.rewritten))&&n++);if(0===n)return h.oR.error("Failed to apply updates for PNG export"),!1;const i=yield yr(t.avatar);if(!i){h.oR.error("Failed to export character PNG");for(const[e,r]of Object.entries(a))yield br(t.avatar,t.name,e,r);return!1}const o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download=`${t.name}_updated.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),h.oR.success("Character PNG downloaded! (Changes applied to card)");const c=SillyTavern.getContext();return yield c.getCharacters(),!0})}(i):1===a&&(yield _r(i)):h.oR.warning("No fields selected.")})}const wr=document.createElement("style");function $r(e,r){var t;const{DOMPurify:n}=SillyTavern.libs,a="string"==typeof e?e:String(null!=e?e:""),i=kr(a);if(!i||"object"!=typeof i){const e=Sr(a);return n.sanitize(Tr(e))}const o=function(e,r){const t=function(e){const r=["overallscore","totalscore","overall","total","score","rating"];for(const t of r)for(const r of Object.keys(e))if(r.toLowerCase().replace(/_/g,"")===t&&"number"==typeof e[r])return r;return null}(e),n=t?e[t]:null,a=[];if(t&&"number"==typeof n){const e=n>10?100:10;a.push(Or({type:"hero",title:Br(t),score:{value:n,max:e}}))}const i=r.properties||{},o=Object.keys(i).length>0?Object.keys(i):Object.keys(e);for(const r of o){if(r===t)continue;const n=e[r];if(void 0===n)continue;const o=i[r]||{type:Mr(n)};a.push(Wr(r,n,o,0))}return`<div class="cr-formatted">${a.join("")}</div>`}(i,null!==(t=null==r?void 0:r.value)&&void 0!==t?t:jr(i));return n.sanitize(o)}function kr(e){try{return JSON.parse(e)}catch(r){const t=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(t)try{return JSON.parse(t[1].trim())}catch(e){return null}return null}}function Sr(e){const r=e.split("\n"),t=[];let n=null,a=[],i=!1,o="",s=[];const c=()=>{if(0===a.length)return;const e=a.join("\n").trim();if(!e)return void(a=[]);const r=function(e){const r=e.split("\n"),t=[];let n="";for(const e of r){const r=e.match(/^[\s]*[-*•]\s+(.+)$/),a=e.match(/^[\s]*\d+[.)]\s+(.+)$/);if(r||a)n&&t.push(n.trim()),n=(r||a)[1];else if(n&&e.match(/^\s+/))n+=" "+e.trim();else if(""===e.trim())n&&t.push(n.trim()),n="";else{if(0===t.length)return[];n&&t.push(n.trim()),n=""}}n&&t.push(n.trim());return t}(e);if(r.length>0){const e={type:"list",items:r};n?(n.children=n.children||[],n.children.push(e)):t.push(e)}else{const r=e.split(/\n\n+/);for(const e of r){if(!e.trim())continue;const r={type:"paragraph",content:e.trim()};n?(n.children=n.children||[],n.children.push(r)):t.push(r)}}a=[]},l=()=>{if(0===s.length)return;const e={type:"code",content:s.join("\n"),language:o};n?(n.children=n.children||[],n.children.push(e)):t.push(e),s=[],o=""};for(const e of r){if(/^[-*_]{3,}\s*$/.test(e.trim()))continue;const r=e.match(/^```(\w*)/);if(r){i?(l(),i=!1):(c(),i=!0,o=r[1]||"");continue}if(i){s.push(e);continue}const d=e.match(/^(#{1,3})\s+(.+)$/);if(d){c(),n&&(n.children&&n.children.length>0||n.score)&&t.push(n);const e=d[1].length,r=d[2].trim(),a=Cr(r);if(a&&1===e)t.push({type:"hero",title:a.label,score:{value:a.value,max:a.max}}),n=null;else{n={type:"section",title:r,children:[]};const e=Pr(r);e&&(n.score={value:e.value,max:e.max},n.title=r.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim())}continue}const p=Rr(e);p&&n?n.score={value:p.value,max:p.max}:a.push(e)}if(c(),i&&l(),n&&(n.children&&n.children.length>0||n.score)&&t.push(n),t.length>0&&"section"===t[0].type){const e=t[0];e.score&&function(e){const r=e.toLowerCase().replace(/[_-]/g,"");return["overall","total","final","summary","verdict","rating","soulcheck"].some(e=>r.includes(e))}(e.title||"")&&(t[0]={type:"hero",title:e.title,score:e.score},e.children&&e.children.length>0&&t.splice(1,0,...e.children.map(e=>e)))}return t}function Pr(e){const r=e.match(/(\d+(?:\.\d+)?)\s*\/\s*(\d+)/);if(r){const e=parseFloat(r[1]),t=parseInt(r[2],10);if(!isNaN(e)&&!isNaN(t)&&t>0)return{value:e,max:t}}return null}function Rr(e){const r=e.trim().match(/^(?:score\s*:?\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)$/i);if(r){const e=parseFloat(r[1]),t=parseInt(r[2],10);if(!isNaN(e)&&!isNaN(t)&&t>0)return{value:e,max:t}}return null}function Cr(e){const r=Pr(e);if(r){const t=e.replace(/\s*[\d.]+\s*\/\s*\d+\s*$/,"").trim();return Object.assign(Object.assign({},r),{label:t})}return null}function Tr(e){if(0===e.length)return'<div class="cr-formatted cr-formatted--empty">No content</div>';return`<div class="cr-formatted">${e.map(zr).join("")}</div>`}function zr(e){switch(e.type){case"hero":return Or(e);case"section":return function(e){const r=e.title||"",t=null!=e.score,n=e.children||[];let a="";if(t&&e.score){a=`\n            <span class="cr-section__score" style="--score-color: ${Hr(100===e.score.max?e.score.value/10:e.score.value)}">\n                ${Number.isInteger(e.score.value)?e.score.value:e.score.value.toFixed(1)}<span class="cr-section__score-max">/${e.score.max}</span>\n            </span>\n        `}const i=n.map(zr).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${Lr(r)}</h3>\n                ${a}\n            </div>\n            <div class="cr-section__body">\n                ${i}\n            </div>\n        </div>\n    `}(e);case"paragraph":return function(e){const r=e.content||"";return`<p class="cr-para">${Er(r)}</p>`}(e);case"list":return function(e){const r=e.items||[];if(0===r.length)return"";return`<ul class="cr-list">${r.map(e=>`<li>${Er(e)}</li>`).join("")}</ul>`}(e);case"code":return function(e){const{hljs:r}=SillyTavern.libs,t=e.content||"",n=e.language||"";let a;try{a=n&&r.getLanguage(n)?r.highlight(t,{language:n}).value:r.highlightAuto(t).value}catch(e){a=Lr(t)}return`\n        <div class="cr-code">\n            ${n?`<div class="cr-code__lang">${Lr(n)}</div>`:""}\n            <pre class="cr-code__pre"><code class="hljs">${a}</code></pre>\n        </div>\n    `}(e);default:return""}}function Or(e){const r=e.score;if(!r)return"";const t=Hr(100===r.max?r.value/10:r.value),n=Number.isInteger(r.value)?r.value:r.value.toFixed(1);return`\n        <div class="cr-hero">\n            <div class="cr-hero__label">${Lr(e.title||"Score")}</div>\n            <div class="cr-hero__score">\n                <span class="cr-hero__value" style="--score-color: ${t}">${n}</span>\n                <span class="cr-hero__max">/${r.max}</span>\n            </div>\n            <div class="cr-hero__bar">\n                <div class="cr-hero__fill" style="width: ${r.value/r.max*100}%; background: ${t}"></div>\n            </div>\n        </div>\n    `}function Er(e){let r=Lr(e);return r=r.replace(/(?:(\w+)\s*:\s*)?(\d+(?:\.\d+)?)\s*\/\s*(\d+)/gi,(e,r,t,n)=>{const a=parseFloat(t),i=parseInt(n,10);return`${r?`<span class="cr-inline-score__label">${r}:</span> `:""}<span class="cr-inline-score" style="--score-color: ${Hr(100===i?a/10:a)}">${Number.isInteger(a)?a:a.toFixed(1)}<span class="cr-inline-score__max">/${i}</span></span>`}),r=r.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),r=r.replace(/__(.+?)__/g,"<strong>$1</strong>"),r=r.replace(/(?<![*_])\*(?![*\s])(.+?)(?<![*\s])\*(?![*_])/g,"<em>$1</em>"),r=r.replace(/(?<![*_])_(?![_\s])(.+?)(?<![_\s])_(?![*_])/g,"<em>$1</em>"),r=r.replace(/`([^`]+)`/g,'<code class="cr-inline-code">$1</code>'),r}wr.textContent="\n.cr-apply-dialog {\n    max-height: 60vh;\n    overflow-y: auto;\n}\n\n.cr-apply-dialog__intro {\n    margin-bottom: 12px;\n}\n\n.cr-apply-dialog__fields {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    margin-bottom: 12px;\n}\n\n.cr-apply-field {\n    border: 1px solid var(--SmartThemeBorderColor);\n    border-radius: 4px;\n    overflow: hidden;\n}\n\n.cr-apply-field__header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px;\n    background: var(--SmartThemeBlurTintColor);\n    cursor: pointer;\n}\n\n.cr-apply-field__header input {\n    margin: 0;\n}\n\n.cr-apply-field__label {\n    font-weight: 600;\n}\n\n.cr-apply-field__preview {\n    padding: 8px;\n    background: var(--SmartThemeBodyColor);\n}\n\n.cr-apply-field__preview pre {\n    margin: 0;\n    white-space: pre-wrap;\n    word-break: break-word;\n    font-size: 0.85em;\n    max-height: 100px;\n    overflow-y: auto;\n}\n\n.cr-apply-dialog__actions {\n    display: flex;\n    gap: 8px;\n}\n",document.head.appendChild(wr);const Ar=8;function jr(e){if(null===e)return{type:"null"};if(Array.isArray(e))return{type:"array",items:e.length>0?jr(e[0]):{type:"string"}};if("object"==typeof e){const r={};for(const[t,n]of Object.entries(e))r[t]=jr(n);return{type:"object",properties:r}}return{type:typeof e}}function Wr(e,r,t,n){if(n>Ar)return function(e){const{hljs:r}=SillyTavern.libs,t=JSON.stringify(e,null,2);return`<pre class="cr-code__pre"><code class="hljs">${r.highlight(t,{language:"json"}).value}</code></pre>`}(r);const a=Br(e),i=t.type||Mr(r);if("array"===i&&Array.isArray(r))return function(e,r,t,n){if(0===r.length)return`\n            <div class="cr-field">\n                <div class="cr-field__label">${Lr(e)}</div>\n                <div class="cr-field__value cr-field--empty">(none)</div>\n            </div>\n        `;const a=t.items||{type:Mr(r[0])};if(r.every(Fr)){const t=r.map(e=>`<li>${function(e){if("boolean"==typeof e)return Dr(e);if("number"==typeof e)return`<span class="cr-num">${e.toLocaleString()}</span>`;return Er(String(e))}(e)}</li>`).join("");return`\n            <div class="cr-field">\n                <div class="cr-field__label">${Lr(e)}</div>\n                <ul class="cr-list">${t}</ul>\n            </div>\n        `}const i=r.map((e,r)=>"object"==typeof e&&null!==e?function(e,r,t){const n=r.properties||{},a=Object.keys(n).length>0?Object.keys(n):Object.keys(e),i=a.find(r=>"string"==typeof e[r]&&e[r].length<100),o=a.find(r=>"number"==typeof e[r]&&e[r]>=0&&e[r]<=100),s=a.find(r=>"string"==typeof e[r]&&e[r].length>=50&&r!==i);let c="";if(i||o){c=`<div class="cr-card__header">${i?`<span class="cr-card__title">${Lr(String(e[i]))}</span>`:""}${o?Ir(e[o]):""}</div>`}let l="";s&&(l=`<div class="cr-card__body">${Er(String(e[s]))}</div>`);const d=a.filter(e=>e!==i&&e!==o&&e!==s).map(r=>{const a=e[r];if(void 0===a)return"";return Wr(r,a,n[r]||{type:Mr(a)},t+1)}).filter(Boolean).join("");return`<div class="cr-card">${c}${l}${d?`<div class="cr-card__extra">${d}</div>`:""}</div>`}(e,a,n+1):`<div class="cr-card">${Nr(e,a)}</div>`).join("");return`\n        <div class="cr-field">\n            <div class="cr-field__label">${Lr(e)}</div>\n            <div class="cr-cards">${i}</div>\n        </div>\n    `}(a,r,t,n);if("object"===i&&"object"==typeof r&&null!==r)return function(e,r,t,n){const a=t.properties||{},i=(Object.keys(a).length>0?Object.keys(a):Object.keys(r)).map(e=>{const t=r[e];if(void 0===t)return"";return Wr(e,t,a[e]||{type:Mr(t)},n+1)}).filter(Boolean).join("");return`\n        <div class="cr-section">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">${Lr(e)}</h3>\n            </div>\n            <div class="cr-section__body cr-section__body--nested">\n                ${i}\n            </div>\n        </div>\n    `}(a,r,t,n);const o=Nr(r,t,e);return`\n        <div class="cr-field">\n            <div class="cr-field__label">${Lr(a)}</div>\n            <div class="cr-field__value">${o}</div>\n        </div>\n    `}function Nr(e,r,t){if(null==e)return'<span class="cr-null">—</span>';switch(r.type||Mr(e)){case"string":return function(e,r){if(!e.trim())return'<span class="cr-empty">(empty)</span>';const t=r.format;if("uri"===t||"url"===t||(n=e,/^https?:\/\//i.test(n))){const r=e.length>50?e.substring(0,47)+"...":e;return`<a href="${Lr(e)}" target="_blank" rel="noopener" class="cr-link">${Lr(r)}</a>`}var n;if("email"===t||function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))return`<a href="mailto:${Lr(e)}" class="cr-link">${Lr(e)}</a>`;if(e.length>100||e.includes("\n"))return`<div class="cr-text">${Er(e)}</div>`;return`<span>${Er(e)}</span>`}(e,r);case"number":case"integer":return function(e,r,t){const n=String(r.title||r.description||t||"").toLowerCase();if(function(e,r){return!!["score","rating","rank","grade","level","confidence","quality"].some(r=>e.includes(r))||(!!(r>=0&&r<=10&&Number.isFinite(r))||!!(r>=0&&r<=100&&Number.isInteger(r)))}(n,e))return Ir(e);return`<span class="cr-num">${e.toLocaleString(void 0,{maximumFractionDigits:2})}</span>`}(e,r,t);case"boolean":return Dr(e);default:return`<span>${Lr(String(e))}</span>`}}function Ir(e){const r=e>10?100:10;return`<span class="cr-score" style="--score-color: ${Hr(e>10?e/10:e)}">${Number.isInteger(e)?e:e.toFixed(1)}<span class="cr-score__max">/${r}</span></span>`}function Dr(e){return`<span class="${e?"cr-bool--yes":"cr-bool--no"}"><i class="fa-solid ${e?"fa-check-circle":"fa-times-circle"}"></i> ${e?"Yes":"No"}</span>`}function Lr(e){const{DOMPurify:r}=SillyTavern.libs,t="string"==typeof e?e:String(null!=e?e:"");return r.sanitize(t,{ALLOWED_TAGS:[]})}function Mr(e){return null===e?"null":Array.isArray(e)?"array":typeof e}function Fr(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e}function Br(e){return e.replace(/_/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/\b\w/g,e=>e.toUpperCase())}function Hr(e){return e>=8?"var(--cr-score-high, #10b981)":e>=6?"var(--cr-score-good, #22c55e)":e>=4?"var(--cr-score-mid, #eab308)":e>=2?"var(--cr-score-low, #f97316)":"var(--cr-score-bad, #ef4444)"}var Gr=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let Ur="result",qr="smart",Jr="formatted";function Vr(e,r){var t;const n=SillyTavern.libs.DOMPurify,a=SillyTavern.libs.hljs;if(!e)return`\n            <div class="cr-empty">\n                <i class="fa-solid ${h.iu[r]} cr-empty__icon"></i>\n                <div class="cr-empty__title">No results yet</div>\n                <div class="cr-empty__text">Run ${h.BA[r]} to see results</div>\n            </div>\n        `;if(e.error)return`\n            <div class="cr-alert cr-alert--danger">\n                <i class="fa-solid fa-exclamation-triangle cr-alert__icon"></i>\n                <div class="cr-alert__content">\n                    <div class="cr-alert__title">Error</div>\n                    <div class="cr-alert__message">${n.sanitize(e.error)}</div>\n                </div>\n            </div>\n        `;const i=kr(e.output);if(null!==i&&"object"==typeof i){const o=JSON.stringify(i,null,2),s=D().stageConfigs[r];let c,l=null;if(null==s?void 0:s.schemaPresetId){const e=(0,dr.Bx)(s.schemaPresetId);l=null!==(t=null==e?void 0:e.schema)&&void 0!==t?t:null}if("smart"===qr)c=$r(e.output,l);else{let e;try{e=a.highlight(o,{language:"json"}).value}catch(r){e=n.sanitize(o)}c=`<pre class="cr-result__code hljs"><code>${e}</code></pre>`}return`\n            <div class="cr-result">\n                <div class="cr-result__header">\n                    <span class="cr-result__type">\n                        <i class="fa-solid fa-brackets-curly"></i>\n                        Structured Output\n                    </span>\n                    <div class="cr-result__actions">\n                        <div class="cr-json-toggle">\n                            <button class="cr-json-toggle__btn ${"smart"===qr?"cr-json-toggle__btn--active":""}"\n                                    data-mode="smart"\n                                    type="button"\n                                    title="Smart formatted view">\n                                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                            </button>\n                            <button class="cr-json-toggle__btn ${"raw"===qr?"cr-json-toggle__btn--active":""}"\n                                    data-mode="raw"\n                                    type="button"\n                                    title="Raw JSON view">\n                                <i class="fa-solid fa-code"></i>\n                            </button>\n                        </div>\n                        <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                data-content="${encodeURIComponent(o)}"\n                                type="button"\n                                title="Copy to clipboard">\n                            <i class="fa-solid fa-copy"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="cr-result__content">\n                    ${c}\n                </div>\n            </div>\n        `}let o;return o="formatted"===Jr?function(e){const{DOMPurify:r}=SillyTavern.libs,t="string"==typeof e?e:String(null!=e?e:""),n=kr(t);if(n&&"object"==typeof n)return $r(t,null);const a=Tr(Sr(t));return r.sanitize(a)}(e.output):`<pre class="cr-result__raw">${n.sanitize(e.output)}</pre>`,`\n        <div class="cr-result">\n            <div class="cr-result__header">\n                <span class="cr-result__type">\n                    <i class="fa-solid fa-file-lines"></i>\n                    Analysis\n                </span>\n                <div class="cr-result__actions">\n                    <div class="cr-text-toggle">\n                        <button class="cr-text-toggle__btn ${"formatted"===Jr?"cr-text-toggle__btn--active":""}"\n                                data-mode="formatted"\n                                type="button"\n                                title="Formatted view">\n                            <i class="fa-solid fa-wand-magic-sparkles"></i>\n                        </button>\n                        <button class="cr-text-toggle__btn ${"raw"===Jr?"cr-text-toggle__btn--active":""}"\n                                data-mode="raw"\n                                type="button"\n                                title="Raw text (easy to copy)">\n                            <i class="fa-solid fa-code"></i>\n                        </button>\n                    </div>\n                    <button class="cr-result-copy menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            data-content="${encodeURIComponent(e.output)}"\n                            type="button"\n                            title="Copy to clipboard">\n                        <i class="fa-solid fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n            <div class="cr-result__content">\n                ${o}\n            </div>\n        </div>\n    `}function Yr(e,r){var t;const n=SillyTavern.libs.DOMPurify,a=SillyTavern.libs.moment,i=D(),o=a(e.timestamp),s=o.fromNow(),c=o.format("MMM D, h:mm A"),l=ue(e.output||e.error||"",100),d=i.viewingHistoryIndex===r,p=(null===(t=i.stageResults[e.stage])||void 0===t?void 0:t.timestamp)===e.timestamp;return`\n        <div class="cr-list-item ${fe(e.error&&"cr-list-item--error",d&&"cr-list-item--viewing",p&&"cr-list-item--current")}"\n             data-index="${r}">\n            <div class="cr-list-item__content">\n                <div class="cr-row cr-row--between">\n                    <span class="cr-list-item__title">\n                        <i class="fa-solid ${h.iu[e.stage]} cr-text-accent"></i>\n                        ${h.BA[e.stage]}\n                        ${p?'<span class="cr-badge cr-badge--sm">current</span>':""}\n                    </span>\n                    <span class="cr-text-xs cr-text-dim" title="${c}">${s}</span>\n                </div>\n                <div class="cr-list-item__subtitle cr-truncate">${n.sanitize(l)}</div>\n            </div>\n            <div class="cr-list-item__actions">\n                <button class="cr-history-restore menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                        data-index="${r}"\n                        type="button"\n                        title="Restore this result as current">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n        </div>\n    `}function Qr(){var e,r;const t=D(),n=function(){var e;const r=D();return null===r.viewingHistoryIndex?null:null!==(e=r.iterationHistory[r.viewingHistoryIndex])&&void 0!==e?e:null}(),a=null!==n,i=a?n:t.stageResults[t.activeStage],o=!!t.stageResults.rewrite,s=t.iterationHistory.length>0,c=!a&&o&&hr().length>0,l=a?`\n            <div class="cr-history-nav">\n                <div class="cr-history-nav__info">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Viewing history ${(null!==(e=t.viewingHistoryIndex)&&void 0!==e?e:0)+1} of ${t.iterationHistory.length}</span>\n                </div>\n                <div class="cr-history-nav__controls">\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_prev"\n                            type="button"\n                            title="Previous"\n                            ${0===t.viewingHistoryIndex?"disabled":""}>\n                        <i class="fa-solid fa-chevron-left"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--icon menu_button--sm"\n                            id="${h.pW}_history_next"\n                            type="button"\n                            title="Next">\n                        <i class="fa-solid fa-chevron-right"></i>\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--primary menu_button--sm"\n                            id="${h.pW}_history_restore"\n                            type="button"\n                            title="Restore this as current result">\n                        <i class="fa-solid fa-rotate-left"></i> Restore\n                    </button>\n                    <button class="cr-history-nav__btn menu_button menu_button--sm"\n                            id="${h.pW}_history_back"\n                            type="button"\n                            title="Back to current results">\n                        <i class="fa-solid fa-xmark"></i> Back\n                    </button>\n                </div>\n            </div>\n        `:"",d=o&&!a?`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===Ur?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===Ur?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${c?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `:"",p=a?Vr(i,null!==(r=null==i?void 0:i.stage)&&void 0!==r?r:t.activeStage):"compare"===Ur&&o?`<div id="${h.pW}_compare_content">${vr()}</div>`:Vr(i,t.activeStage),u=s?`\n            <div class="cr-history ${fe(!t.historyExpanded&&"cr-history--collapsed")}">\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${t.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${t.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="cr-history__list cr-list">\n                    ${t.iterationHistory.map((e,r)=>Yr(e,r)).join("")}\n                </div>\n            </div>\n        `:"";return`\n        <div class="cr-results-wrapper">\n            \x3c!-- History Navigation (when viewing history) --\x3e\n            ${l}\n\n            \x3c!-- View Toggle --\x3e\n            ${d?`<div class="cr-results-toolbar">${d}</div>`:""}\n\n            \x3c!-- Results/Compare content --\x3e\n            <div id="${h.pW}_results_content" class="cr-results-content">\n                ${p}\n            </div>\n\n            \x3c!-- Run History Section (only if there's history) --\x3e\n            ${u}\n        </div>\n    `}function Kr(){const e=D(),r=!!e.stageResults.rewrite,t=r&&hr().length>0,n=e.iterationHistory.length>0,a=ce(".cr-results-wrapper");if(!a)return;let i=a.querySelector(".cr-results-toolbar");if(r){const e=`\n            <div class="cr-view-toggle">\n                <button class="cr-view-toggle__btn ${"result"===Ur?"cr-view-toggle__btn--active":""}"\n                        data-view="result"\n                        type="button"\n                        title="Show stage result">\n                    <i class="fa-solid fa-file-lines"></i> Result\n                </button>\n                <button class="cr-view-toggle__btn ${"compare"===Ur?"cr-view-toggle__btn--active":""}"\n                        data-view="compare"\n                        type="button"\n                        title="Compare original vs rewritten">\n                    <i class="fa-solid fa-code-compare"></i> Compare\n                </button>\n            </div>\n            ${t?'\n                <button class="menu_button menu_button--primary menu_button--sm cr-apply-btn"\n                        type="button"\n                        title="Apply rewritten content to character card">\n                    <i class="fa-solid fa-check"></i> Apply\n                </button>\n            ':""}\n        `;if(!i){i=document.createElement("div"),i.className="cr-results-toolbar";const e=ce(`#${h.pW}_results_content`);e&&a.insertBefore(i,e)}i.innerHTML=e}else i&&i.remove();const o=ce(`#${h.pW}_results_content`);if(!o)return;if("compare"===Ur&&r)o.innerHTML=`<div id="${h.pW}_compare_content">${vr()}</div>`;else{const r=e.stageResults[e.activeStage];o.innerHTML=Vr(r,e.activeStage)}let s=a.querySelector(".cr-history");if(n){s||(s=document.createElement("div"),s.className="cr-history "+(e.historyExpanded?"":"cr-history--collapsed"),s.innerHTML=`\n                <button class="cr-history__toggle"\n                        type="button"\n                        aria-expanded="${e.historyExpanded}"\n                        title="Previous pipeline runs in this session">\n                    <i class="fa-solid fa-clock-rotate-left"></i>\n                    <span>Run History (${e.iterationHistory.length})</span>\n                    <i class="fa-solid fa-chevron-down cr-history__toggle-icon"></i>\n                </button>\n                <div id="${h.pW}_history_list" class="cr-history__list cr-list">\n                </div>\n            `,a.appendChild(s));const r=ce(`#${h.pW}_history_list`);if(r){!function(e,r,t){const n=SillyTavern.libs.morphdom,a=SillyTavern.libs.DOMPurify,i=document.createElement("div");i.innerHTML=a.sanitize(r),n(e,i,{childrenOnly:!0,onBeforeElUpdated:(e,r)=>{var n,a;if(document.activeElement===e&&"INPUT"===e.tagName){const t=e,n=r;n.value=t.value,n.selectionStart=t.selectionStart,n.selectionEnd=t.selectionEnd}if(document.activeElement===e&&"TEXTAREA"===e.tagName){const t=e,n=r;n.value=t.value,n.selectionStart=t.selectionStart,n.selectionEnd=t.selectionEnd}return null===(a=null===(n=null==t?void 0:t.onBeforeElUpdated)||void 0===n?void 0:n.call(t,e,r))||void 0===a||a},onBeforeNodeDiscarded:null==t?void 0:t.onBeforeNodeDiscarded,onNodeAdded:null==t?void 0:t.onNodeAdded})}(r,e.iterationHistory.map((e,r)=>Yr(e,r)).join(""))}const t=s.querySelector(".cr-history__toggle span");t&&(t.textContent=`Run History (${e.iterationHistory.length})`)}else s&&s.remove()}function Xr(e){const r=[];r.push(de(e,"click",e=>{const t=e.target.closest(".cr-view-toggle__btn");if(!t)return;const n=t.dataset.view;if(n&&n!==Ur&&(Ur=n,Kr(),"compare"===n)){const e=ce(`#${h.pW}_compare_content`);e&&r.push(function(e){const r=[],t=ce(".cr-compare-list",e);return t&&r.push(de(t,"click",e=>{const r=e.target.closest(".cr-compare-row");if(!r)return;const t=r.querySelector(".cr-compare-row__label"),n=(null==t?void 0:t.textContent)||"Field",a=r.querySelector(".cr-compare-col--original pre"),i=r.querySelector(".cr-compare-col--rewritten pre");a&&i&&h.lY.alert(`Compare: ${n}`,`\n                        <div class="cr-compare-popup">\n                            <div class="cr-compare-popup__side">\n                                <h4>Original</h4>\n                                <pre>${a.innerHTML}</pre>\n                            </div>\n                            <div class="cr-compare-popup__side">\n                                <h4>Rewritten</h4>\n                                <pre>${i.innerHTML}</pre>\n                            </div>\n                        </div>\n                        `)})),()=>{r.forEach(e=>e())}}(e))}})),r.push(de(e,"click",e=>{const r=e.target.closest(".cr-json-toggle__btn");if(!r)return;const t=r.dataset.mode;t&&t!==qr&&(qr=t,Kr())})),r.push(de(e,"click",e=>{const r=e.target.closest(".cr-text-toggle__btn");if(!r)return;const t=r.dataset.mode;t&&t!==Jr&&(Jr=t,Kr())})),r.push(de(e,"click",e=>{e.target.closest(".cr-apply-btn")&&xr()}));const t=ce(`#${h.pW}_results_content`,e);t&&r.push(de(t,"click",e=>Gr(this,void 0,void 0,function*(){const r=e.target.closest(".cr-result-copy");if(!r)return;const t=decodeURIComponent(r.dataset.content||""),n=yield function(e){return Gr(this,void 0,void 0,function*(){if(navigator.clipboard&&window.isSecureContext)try{return yield navigator.clipboard.writeText(e),!0}catch(e){}try{const r=document.createElement("textarea");r.value=e,r.style.position="fixed",r.style.left="-9999px",r.style.top="-9999px",r.setAttribute("readonly",""),document.body.appendChild(r),r.select(),r.setSelectionRange(0,e.length);const t=document.execCommand("copy");return document.body.removeChild(r),t}catch(e){return!1}})}(t),a=r.querySelector("i");n?a&&(a.className="fa-solid fa-check",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)):(a&&(a.className="fa-solid fa-xmark",setTimeout(()=>{a.className="fa-solid fa-copy"},1500)),console.error("Failed to copy to clipboard"))})));const n=ce(".cr-history__toggle",e),a=ce(".cr-history",e);n&&a&&r.push(de(n,"click",()=>{!function(){const e=D();e.historyExpanded=!e.historyExpanded}(),a.classList.toggle("cr-history--collapsed"),n.setAttribute("aria-expanded",String(D().historyExpanded))})),r.push(de(e,"click",e=>{const r=e.target;return r.closest(`#${h.pW}_history_prev`)?(function(){const e=D();0!==e.iterationHistory.length&&(null===e.viewingHistoryIndex?e.viewingHistoryIndex=e.iterationHistory.length-1:e.viewingHistoryIndex>0&&e.viewingHistoryIndex--)}(),void Kr()):r.closest(`#${h.pW}_history_next`)?(function(){const e=D();null!==e.viewingHistoryIndex&&(e.viewingHistoryIndex<e.iterationHistory.length-1?e.viewingHistoryIndex++:e.viewingHistoryIndex=null)}(),void Kr()):r.closest(`#${h.pW}_history_restore`)?(re(),h.oR.success("Result restored"),void Kr()):r.closest(`#${h.pW}_history_back`)?(ee(null),void Kr()):void 0}));const i=ce(`#${h.pW}_history_list`,e);return i&&r.push(de(i,"click",e=>Gr(this,void 0,void 0,function*(){const r=e.target,t=r.closest(".cr-history-restore");if(t){e.stopPropagation();return re(parseInt(t.dataset.index||"0",10)),h.oR.success("Result restored"),void Kr()}const n=r.closest(".cr-list-item");if(!n)return;ee(parseInt(n.dataset.index||"0",10)),Kr()}))),()=>{r.forEach(e=>e())}}var Zr=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};const et={pending:"",running:"fa-spinner fa-spin",complete:"fa-check",error:"fa-exclamation"},rt={pending:"",running:"cr-stage-tab--running",complete:"cr-stage-tab--complete",error:"cr-stage-tab--error"};function tt(e){const r=D(),t=r.activeStage===e,n=r.stageStatus[e],a=et[n],i=a?`<span class="cr-stage-tab__status"><i class="fa-solid ${a}"></i></span>`:"";return`\n        <button class="cr-stage-tab ${fe(t&&"cr-stage-tab--active")} ${rt[n]}"\n                data-stage="${e}"\n                role="tab"\n                aria-selected="${t}"\n                type="button">\n            <i class="fa-solid ${h.iu[e]} cr-stage-tab__icon"></i>\n            <span class="cr-stage-tab__label">${h.BA[e]}</span>\n            ${i}\n        </button>\n    `}function nt(){const e=SillyTavern.libs.DOMPurify,r=D(),t=r.character&&!r.isGenerating,n=t&&r.stageResults.analyze&&!r.stageResults.analyze.error;if(r.isGenerating)return`\n            <div class="cr-pipeline-controls cr-pipeline-controls--generating">\n                <div class="cr-pipeline-status">\n                    <i class="fa-solid fa-spinner fa-spin"></i>\n                    <span>Generating...</span>\n                </div>\n                <button id="${h.pW}_abort"\n                        class="menu_button menu_button--danger menu_button--sm"\n                        type="button">\n                    <i class="fa-solid fa-stop"></i>\n                    Stop\n                </button>\n            </div>\n        `;const a=n?`\n        <div class="cr-iteration-row">\n            <div class="cr-iteration-row__label">\n                <i class="fa-solid fa-arrows-rotate"></i>\n                <span>Iteration ${r.iterationCount+1}</span>\n            </div>\n            <input type="text"\n                   id="${h.pW}_guidance_input"\n                   class="cr-iteration-row__input"\n                   placeholder="Optional guidance to steer refinement..."\n                   value="${e.sanitize(D().userGuidance)}"\n                   title="Focus areas or constraints for the next iteration" />\n            <button id="${h.pW}_iterate"\n                    class="menu_button menu_button--primary"\n                    type="button"\n                    title="Refine with feedback, then re-analyze">\n                <i class="fa-solid fa-wand-magic-sparkles"></i>\n                Iterate\n            </button>\n        </div>\n    `:"";return`\n        <div class="cr-pipeline-controls">\n            <div class="cr-pipeline-controls__main">\n                <button id="${h.pW}_run_stage"\n                        class="menu_button menu_button--primary"\n                        type="button"\n                        ${t?"":"disabled"}>\n                    <i class="fa-solid fa-play"></i>\n                    Run ${h.BA[r.activeStage]}\n                </button>\n                <button id="${h.pW}_run_all"\n                        class="menu_button"\n                        type="button"\n                        ${t?"":"disabled"}\n                        title="Run all stages: Score → Rewrite → Analyze">\n                    <i class="fa-solid fa-forward"></i>\n                    Run All\n                </button>\n                <button id="${h.pW}_reset"\n                        class="menu_button menu_button--icon menu_button--ghost"\n                        type="button"\n                        title="Clear all results and start fresh">\n                    <i class="fa-solid fa-rotate-left"></i>\n                </button>\n            </div>\n            ${a}\n        </div>\n    `}function at(){const e=ce(".cr-stage-tabs");e&&(e.innerHTML=h.an.map(tt).join(""))}function it(){const e=ce(`#${h.pW}_pipeline_controls`);e&&(e.innerHTML=nt(),dt(e))}function ot(e){return Zr(this,void 0,void 0,function*(){const r=D();at(),it(),yield function(e,r){return te(this,void 0,void 0,function*(){var t,n,a,i;const{stage:o,callbacks:s}=r;if(!e.character)return h.Rm.warn("Cannot execute stage: no character selected"),null;if(e.isGenerating)return h.Rm.warn("Cannot execute stage: generation already in progress"),null;const c=se(e,o);if(!c)return null;const l=new AbortController;ie(e,!0,l),ae(e,o,"running"),null===(t=null==s?void 0:s.onStageStart)||void 0===t||t.call(s,o);try{const r=yield O(c,ne,{signal:l.signal,onProgress:e=>{var r;h.Rm.debug(`[Pipeline] ${e}`),null===(r=null==s?void 0:s.onProgress)||void 0===r||r.call(s,e)}});return oe(e,r),null===(n=null==s?void 0:s.onStageComplete)||void 0===n||n.call(s,o,r),r.error&&(null===(a=null==s?void 0:s.onError)||void 0===a||a.call(s,o,r.error)),r}catch(r){const t=r instanceof Error?r.message:"Unknown error";return h.Rm.error(`Stage ${o} failed:`,r),ae(e,o,"error"),null===(i=null==s?void 0:s.onError)||void 0===i||i.call(s,o,t),null}finally{ie(e,!1)}})}(r,{stage:e,callbacks:{onStageStart:()=>{at(),it()},onStageComplete:()=>{Kr(),at(),it()},onError:()=>{at(),it()}}})})}function st(){return Zr(this,void 0,void 0,function*(){const e=D();at(),it(),yield function(e){return te(this,arguments,void 0,function*(e,r={}){var t,n,a,i,o;const{stages:s=[...h.an],callbacks:c}=r;if(!e.character)return h.Rm.warn("Cannot execute pipeline: no character selected"),{score:null,rewrite:null,analyze:null};if(e.isGenerating)return h.Rm.warn("Cannot execute pipeline: generation already in progress"),{score:null,rewrite:null,analyze:null};const l=new AbortController;ie(e,!0,l);for(const r of h.an)ae(e,r,"pending");const d={score:e.stageResults.score,rewrite:e.stageResults.rewrite,analyze:e.stageResults.analyze};try{for(const r of s){if(l.signal.aborted){h.Rm.debug("Pipeline aborted");break}const o=se(e,r);if(!o)break;o.previousResults=d,ae(e,r,"running"),null===(t=null==c?void 0:c.onStageStart)||void 0===t||t.call(c,r),null===(n=null==c?void 0:c.onProgress)||void 0===n||n.call(c,`Running ${r}...`);const s=yield O(o,ne,{signal:l.signal,onProgress:e=>{var r;h.Rm.debug(`[Pipeline] ${e}`),null===(r=null==c?void 0:c.onProgress)||void 0===r||r.call(c,e)}});if(d[r]=s,oe(e,s),null===(a=null==c?void 0:c.onStageComplete)||void 0===a||a.call(c,r,s),s.error){null===(i=null==c?void 0:c.onError)||void 0===i||i.call(c,r,s.error);break}}}catch(r){const t=r instanceof Error?r.message:"Unknown error";h.Rm.error("Pipeline execution failed:",r),null===(o=null==c?void 0:c.onError)||void 0===o||o.call(c,e.activeStage,t)}finally{ie(e,!1)}return d})}(e,{callbacks:{onStageStart:()=>{at()},onStageComplete:()=>{Kr(),at()},onProgress:()=>{it()},onError:()=>{at(),it()}}}),at(),it()})}function ct(){return Zr(this,void 0,void 0,function*(){const e=D();at(),it(),yield function(e){return te(this,arguments,void 0,function*(e,r={}){var t,n,a,i,o,s,c,l,d,p;const{callbacks:u}=r;if(!e.character)return h.Rm.warn("Cannot execute quick iterate: no character selected"),{rewrite:null,analyze:null};if(e.isGenerating)return h.Rm.warn("Cannot execute quick iterate: generation already in progress"),{rewrite:null,analyze:null};if(!e.stageResults.analyze)return h.Rm.warn("Cannot execute quick iterate: no analyze result available"),{rewrite:null,analyze:null};const f=new AbortController;ie(e,!0,f),e.iterationCount++;const v={rewrite:null,analyze:null};try{const r=se(e,"rewrite");if(!r)return v;r.isRefinement=!0,ae(e,"rewrite","running"),null===(t=null==u?void 0:u.onStageStart)||void 0===t||t.call(u,"rewrite"),null===(n=null==u?void 0:u.onProgress)||void 0===n||n.call(u,"Refining rewrite with feedback...");const p=yield O(r,ne,{signal:f.signal,onProgress:e=>{var r;h.Rm.debug(`[Pipeline] ${e}`),null===(r=null==u?void 0:u.onProgress)||void 0===r||r.call(u,e)}});if(v.rewrite=p,oe(e,p),null===(a=null==u?void 0:u.onStageComplete)||void 0===a||a.call(u,"rewrite",p),p.error)return null===(i=null==u?void 0:u.onError)||void 0===i||i.call(u,"rewrite",p.error),v;if(f.signal.aborted)return h.Rm.debug("Quick iterate aborted"),v;const m=se(e,"analyze");if(!m)return v;m.previousResults=Object.assign(Object.assign({},e.stageResults),{rewrite:p}),ae(e,"analyze","running"),null===(o=null==u?void 0:u.onStageStart)||void 0===o||o.call(u,"analyze"),null===(s=null==u?void 0:u.onProgress)||void 0===s||s.call(u,"Analyzing refined version...");const g=yield O(m,ne,{signal:f.signal,onProgress:e=>{var r;h.Rm.debug(`[Pipeline] ${e}`),null===(r=null==u?void 0:u.onProgress)||void 0===r||r.call(u,e)}});return v.analyze=g,oe(e,g),null===(c=null==u?void 0:u.onStageComplete)||void 0===c||c.call(u,"analyze",g),g.error&&(null===(l=null==u?void 0:u.onError)||void 0===l||l.call(u,"analyze",g.error)),null===(d=null==u?void 0:u.onIterateComplete)||void 0===d||d.call(u),v}catch(r){const t=r instanceof Error?r.message:"Unknown error";return h.Rm.error("Quick iterate failed:",r),null===(p=null==u?void 0:u.onError)||void 0===p||p.call(u,e.activeStage,t),v}finally{ie(e,!1)}})}(e,{callbacks:{onStageStart:e=>{at(),it()},onStageComplete:()=>{Kr(),at(),it()},onError:()=>{at(),it()},onIterateComplete:()=>{X("analyze"),at(),sr(),Kr()}}})})}let lt=[];function dt(e){lt.forEach(e=>e()),lt=[];const r=ce(`#${h.pW}_guidance_input`,e);if(r){const e=()=>{var e;e=r.value,D().userGuidance=e,F()};lt.push(de(r,"change",e)),lt.push(de(r,"blur",e))}const t=ce(`#${h.pW}_run_stage`,e);t&&lt.push(de(t,"click",()=>{ot(D().activeStage)}));const n=ce(`#${h.pW}_run_all`,e);n&&lt.push(de(n,"click",()=>{st()}));const a=ce(`#${h.pW}_iterate`,e);a&&lt.push(de(a,"click",()=>{ct()}));const i=ce(`#${h.pW}_reset`,e);i&&lt.push(de(i,"click",()=>{!function(e){e.stageStatus={score:"pending",rewrite:"pending",analyze:"pending"},e.stageResults={score:null,rewrite:null,analyze:null},e.iterationCount=0,e.hasUnsavedChanges=!0}(D()),at(),Kr(),it()}));const o=ce(`#${h.pW}_abort`,e);o&&lt.push(de(o,"click",()=>{!function(e){e.abortController&&(e.abortController.abort(),e.abortController=null,e.isGenerating=!1,h.Rm.debug("Pipeline aborted by user"))}(D()),at(),it()}))}var pt=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let ut=!1,ft=null;function vt(e){ut=e;const r=ce(`#${h.pW}_session_dropdown`);r&&r.classList.toggle("cr-dropdown--open",e),e||(ft=null)}function mt(e){return e.name?e.name:(r=e.updatedAt,(0,SillyTavern.libs.moment)(r).calendar(null,{sameDay:"[Today] h:mm A",lastDay:"[Yesterday] h:mm A",lastWeek:"ddd, h:mm A",sameElse:"MMM D, h:mm A"}));var r}function gt(){const e=D(),r=e.sessions;return e.character?0===r.length?'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-folder-open"></i>\n                No sessions yet\n            </div>\n        ':r.map(r=>function(e,r){var t,n;const a=SillyTavern.libs.DOMPurify,i=mt(e),o=ft===e.id,s=Object.keys(null!==(n=null===(t=e.stageFields)||void 0===t?void 0:t.base)&&void 0!==n?n:{}).length,c=e.history.length;return`\n        <div class="cr-session-option ${fe(r&&"cr-session-option--active")}"\n             data-session-id="${e.id}"\n             role="option"\n             aria-selected="${r}">\n            <div class="cr-session-option__content">\n                ${o?`\n                    <input type="text"\n                           class="cr-session-option__name-input"\n                           value="${a.sanitize(e.name||"")}"\n                           placeholder="Session name..."\n                           autocomplete="off"\n                           data-session-id="${e.id}" />\n                `:`\n                    <div class="cr-session-option__name">\n                        ${r?'<i class="fa-solid fa-circle cr-session-option__indicator"></i>':""}\n                        <span>${a.sanitize(i)}</span>\n                    </div>\n                `}\n                <div class="cr-session-option__meta">\n                    <span>${s} fields</span>\n                    <span>${c} runs</span>\n                </div>\n            </div>\n            <div class="cr-session-option__actions ${fe(o&&"cr-session-option__actions--editing")}">\n                ${o?`\n                    <button class="cr-session-save menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Save name"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-check"></i>\n                    </button>\n                    <button class="cr-session-cancel menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Cancel">\n                        <i class="fa-solid fa-times"></i>\n                    </button>\n                `:`\n                    <button class="cr-session-edit menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Rename session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-pencil"></i>\n                    </button>\n                    <button class="cr-session-delete menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                            type="button"\n                            title="Delete session"\n                            data-session-id="${e.id}">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                `}\n            </div>\n        </div>\n    `}(r,r.id===e.activeSessionId)).join(""):'\n            <div class="cr-dropdown__empty">\n                <i class="fa-solid fa-user-slash"></i>\n                Select a character first\n            </div>\n        '}function ht(){const e=ce(`#${h.pW}_session_dropdown`);if(!e)return;const r=D(),t=r.sessions.find(e=>e.id===r.activeSessionId),n=!!r.character;e.classList.toggle("cr-dropdown--disabled",!n);const a=ce(`#${h.pW}_session_trigger`);if(a){a.disabled=!n;let e="No session";n?t&&(e=mt(t)):e="Select character...";const i=r.sessions.length;a.innerHTML=`\n            <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n            <span class="cr-dropdown__trigger-text ${fe(!t&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(e)}</span>\n            ${i>0?`<span class="cr-dropdown__count">${i}</span>`:""}\n            <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n        `}const i=ce(`#${h.pW}_new_session_btn`);i&&(i.disabled=!n);const o=ce(`#${h.pW}_session_list`);o&&(o.innerHTML=gt())}var bt=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function yt(e){const r=SillyTavern.libs.DOMPurify,t=e.isReady?"cr-api-banner--ready":"cr-api-banner--error",n=e.isReady?"fa-circle-check":"fa-circle-xmark",a="cc"===e.apiType?"Chat":"Text";return`\n        <div class="cr-api-banner ${t}">\n            <div class="cr-api-banner__left">\n                <i class="fa-solid ${n}"></i>\n                <span class="cr-api-banner__name">${r.sanitize(e.displayName)}</span>\n                <span class="cr-badge cr-badge--small">${a}</span>\n            </div>\n            <div class="cr-api-banner__right">\n                <span class="cr-api-banner__model" title="${r.sanitize(e.model)}">${r.sanitize(e.modelDisplay)}</span>\n                <span class="cr-api-banner__limits">${e.maxOutput.toLocaleString()}t max</span>\n            </div>\n        </div>\n        ${e.error?`\n            <div class="cr-api-error">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                <span>${r.sanitize(e.error)}</span>\n            </div>\n        `:""}\n    `}function _t(e){const r=SillyTavern.libs.DOMPurify;if(!e)return'\n            <div class="cr-profile-info cr-profile-info--empty">\n                <i class="fa-solid fa-circle-question"></i>\n                <span>Select a profile above</span>\n            </div>\n        ';const t="cc"===e.mode?"Chat":"Text";return`\n        <div class="cr-profile-info ${e.isSupported?"":"cr-profile-info--error"}">\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">API</span>\n                <span class="cr-profile-info__value">${r.sanitize(e.api)}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Model</span>\n                <span class="cr-profile-info__value" title="${r.sanitize(e.model)}">${r.sanitize(function(e){const r=e.replace(/^anthropic\//,"").replace(/^openai\//,"").replace(/^google\//,"").replace(/^meta-llama\//,"llama-").replace(/^mistralai\//,"mistral-");if(r.length>30)return r.substring(0,27)+"...";return r}(e.model))}</span>\n            </div>\n            <div class="cr-profile-info__row">\n                <span class="cr-profile-info__label">Type</span>\n                <span class="cr-badge cr-badge--small">${t}</span>\n            </div>\n            ${e.presetName?`\n                <div class="cr-profile-info__row">\n                    <span class="cr-profile-info__label">Preset</span>\n                    <span class="cr-profile-info__value">${r.sanitize(e.presetName)}</span>\n                </div>\n            `:""}\n            ${e.isSupported?"":`\n                <div class="cr-profile-info__error">\n                    <i class="fa-solid fa-triangle-exclamation"></i>\n                    <span>${e.validationError||"Profile configuration is invalid"}</span>\n                </div>\n            `}\n        </div>\n    `}function xt(e,r){const t=ce(`#${h.pW}_api_status_banner`,e);if(!t)return;let n=null;if(r){const r=ce(`#${h.pW}_profile_select`,e);n=(null==r?void 0:r.value)||null}const a=(0,h.Lq)(n);t.innerHTML=yt(a)}function wt(){return bt(this,void 0,void 0,function*(){const e=SillyTavern.libs.DOMPurify,r=SillyTavern.getContext(),t=function(){var e;const r=SillyTavern.libs.DOMPurify,t=(0,b.getSettings)(),n=(0,h.We)(),a=(0,h.Lq)("profile"===t.generationMode?t.profileId:null);return`\n        <div id="${h.pW}_settings_modal" class="cr-settings-modal">\n            <div class="cr-settings-header">\n                <h2>\n                    <i class="fa-solid fa-cog"></i>\n                    ${h.hi} Settings\n                </h2>\n            </div>\n\n            <div class="cr-settings-body">\n                \x3c!-- Keyboard Shortcuts --\x3e\n                <section class="cr-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-keyboard"></i>\n                        Keyboard Shortcuts\n                    </h3>\n                    <div class="cr-shortcuts-list">\n                        <div class="cr-shortcut">\n                            <kbd>Ctrl</kbd> + <kbd>Enter</kbd>\n                            <span>Run current stage</span>\n                        </div>\n                        <div class="cr-shortcut">\n                            <kbd>Escape</kbd>\n                            <span>Cancel generation</span>\n                        </div>\n                    </div>\n                </section>\n\n                \x3c!-- Generation Settings --\x3e\n                <section class="cr-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-sliders"></i>\n                        Generation\n                    </h3>\n\n                    \x3c!-- Current API Status --\x3e\n                    <div id="${h.pW}_api_status_banner">\n                        ${yt(a)}\n                    </div>\n\n                    \x3c!-- Mode Toggle --\x3e\n                    ${(0,h.mi)()?`\n                    <div class="cr-gen-mode-toggle">\n                        <label class="cr-gen-mode-option ${"current"===t.generationMode?"cr-gen-mode-option--active":""}" data-mode="current">\n                            <input type="radio" name="${h.pW}_gen_mode" value="current" ${"current"===t.generationMode?"checked":""}>\n                            <i class="fa-solid fa-sliders"></i>\n                            <span>Current ST Settings</span>\n                        </label>\n                        <label class="cr-gen-mode-option ${"profile"===t.generationMode?"cr-gen-mode-option--active":""}" data-mode="profile">\n                            <input type="radio" name="${h.pW}_gen_mode" value="profile" ${"profile"===t.generationMode?"checked":""}>\n                            <i class="fa-solid fa-plug"></i>\n                            <span>Connection Profile</span>\n                        </label>\n                    </div>\n\n                    \x3c!-- Profile Selection --\x3e\n                    <div id="${h.pW}_profile_section" class="cr-profile-section ${"current"===t.generationMode?"cr-hidden":""}">\n                        ${n.length>0?`\n                        <div class="cr-setting-item">\n                            <label class="cr-setting-label">Select Profile</label>\n                            <select id="${h.pW}_profile_select" class="cr-select text_pole">\n                                <option value="">-- Select a profile --</option>\n                                ${n.map(e=>`\n                                <option value="${e.id}"\n                                        ${e.id===t.profileId?"selected":""}\n                                        ${e.isSupported?"":"disabled"}>\n                                    ${r.sanitize(e.name)}${e.isSupported?"":" (invalid)"}\n                                </option>\n                                `).join("")}\n                            </select>\n                        </div>\n                        <div id="${h.pW}_profile_info_container">\n                            ${_t(n.find(e=>e.id===t.profileId)||null)}\n                        </div>\n                        `:'\n                        <div class="cr-profile-empty">\n                            <i class="fa-solid fa-info-circle"></i>\n                            <div>\n                                <strong>No connection profiles found</strong>\n                                <p>Create profiles in SillyTavern\'s Connection Manager to use specific API configurations.</p>\n                            </div>\n                        </div>\n                        '}\n                    </div>\n                    `:""}\n\n                    \x3c!-- Max Tokens Override --\x3e\n                    <details class="cr-collapsible">\n                        <summary>Response Length Override</summary>\n                        <div class="cr-setting-item">\n                            <label class="cr-setting-label">\n                                <input type="checkbox"\n                                       id="${h.pW}_max_tokens_enabled"\n                                       ${null!==t.maxTokensOverride?"checked":""} />\n                                <span>Override max response tokens</span>\n                            </label>\n                            <input type="number"\n                                   id="${h.pW}_max_tokens"\n                                   class="cr-number-input text_pole"\n                                   value="${null!==(e=t.maxTokensOverride)&&void 0!==e?e:4096}"\n                                   min="100"\n                                   max="32000"\n                                   step="100"\n                                   ${null===t.maxTokensOverride?"disabled":""} />\n                            <span class="cr-setting-hint">\n                                Leave unchecked to use the profile's preset settings\n                            </span>\n                        </div>\n                    </details>\n                </section>\n\n                \x3c!-- System Prompt --\x3e\n                <section class="cr-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-terminal"></i>\n                        System Prompt\n                    </h3>\n                    <p class="cr-setting-desc">\n                        The system prompt is sent with every generation. Your additions are appended after the base prompt.\n                    </p>\n\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">Your Additions</label>\n                        <textarea id="${h.pW}_user_system_prompt"\n                                  class="cr-textarea text_pole"\n                                  rows="4"\n                                  placeholder="Add custom instructions...">${r.sanitize(t.userSystemPrompt)}</textarea>\n                    </div>\n\n                    <details class="cr-collapsible">\n                        <summary>Base Prompt (Read-only)</summary>\n                        <pre class="cr-readonly-text">${r.sanitize(t.baseSystemPrompt)}</pre>\n                    </details>\n                </section>\n\n                \x3c!-- Refinement Prompt --\x3e\n                <section class="cr-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-rotate"></i>\n                        Refinement Prompt\n                    </h3>\n                    <p class="cr-setting-desc">\n                        Instructions for refinement iterations. Your additions are appended after the base.\n                    </p>\n\n                    <div class="cr-setting-item">\n                        <label class="cr-setting-label">Your Additions</label>\n                        <textarea id="${h.pW}_user_refinement_prompt"\n                                  class="cr-textarea text_pole"\n                                  rows="4"\n                                  placeholder="Add custom refinement instructions...">${r.sanitize(t.userRefinementPrompt)}</textarea>\n                    </div>\n\n                    <details class="cr-collapsible">\n                        <summary>Base Prompt (Read-only)</summary>\n                        <pre class="cr-readonly-text">${r.sanitize(t.baseRefinementPrompt)}</pre>\n                    </details>\n                </section>\n\n                \x3c!-- Reset Settings --\x3e\n                <section class="cr-settings-section">\n                    <h3>\n                        <i class="fa-solid fa-rotate-left"></i>\n                        Reset\n                    </h3>\n                    <button id="${h.pW}_reset_settings"\n                            class="cr-btn cr-btn--small cr-btn--danger menu_button"\n                            type="button">\n                        <i class="fa-solid fa-rotate-left"></i>\n                        Reset All Settings\n                    </button>\n                </section>\n            </div>\n\n            <div class="cr-settings-footer">\n                <span class="cr-version">v${h.xv}</span>\n                <button id="${h.pW}_settings_close"\n                        class="cr-btn cr-btn--primary menu_button"\n                        type="button">\n                    <i class="fa-solid fa-check"></i>\n                    Save & Close\n                </button>\n            </div>\n        </div>\n    `}();new r.Popup(e.sanitize(t),r.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show(),yield new Promise(e=>setTimeout(e,0));const n=ce(`#${h.pW}_settings_modal`);if(!n)return;const a=function(e){const r=[],t=le(".cr-gen-mode-option",e),n=ce(`#${h.pW}_profile_section`,e);for(const a of t)r.push(de(a,"click",()=>{const r=a.dataset.mode;t.forEach(e=>e.classList.remove("cr-gen-mode-option--active")),a.classList.add("cr-gen-mode-option--active"),n&&n.classList.toggle("cr-hidden","current"===r),xt(e,"profile"===r)}));const a=ce(`#${h.pW}_profile_select`,e),i=ce(`#${h.pW}_profile_info_container`,e);a&&i&&r.push(de(a,"change",()=>{const r=(0,h.We)().find(e=>e.id===a.value);i.innerHTML=_t(r||null),xt(e,!0)}));const o=ce(`#${h.pW}_max_tokens_enabled`,e),s=ce(`#${h.pW}_max_tokens`,e);o&&s&&r.push(de(o,"change",()=>{s.disabled=!o.checked}));const c=ce(`#${h.pW}_reset_settings`,e);c&&r.push(de(c,"click",()=>bt(this,void 0,void 0,function*(){if(!(yield h.lY.confirm("Reset Settings","This will reset all settings to defaults. Custom presets will be kept. Continue?")))return;(0,b.resetSettings)(),h.oR.success("Settings reset to defaults");const r=e.closest(".popup"),t=null==r?void 0:r.querySelector(".popup-button-cancel, .popup-button-ok");null==t||t.click(),setTimeout(()=>wt(),100)})));return()=>{r.forEach(e=>e())}}(n),i=ce(`#${h.pW}_settings_close`,n);i&&i.addEventListener("click",()=>{!function(){const e=(0,b.getSettings)(),r=document.querySelector(`input[name="${h.pW}_gen_mode"]:checked`);r&&(e.generationMode=r.value);const t=ce(`#${h.pW}_profile_select`);t&&(e.profileId=t.value||null);const n=ce(`#${h.pW}_max_tokens_enabled`),a=ce(`#${h.pW}_max_tokens`);n&&a&&(e.maxTokensOverride=n.checked?parseInt(a.value,10):null);const i=ce(`#${h.pW}_user_system_prompt`);i&&(e.userSystemPrompt=i.value);const o=ce(`#${h.pW}_user_refinement_prompt`);o&&(e.userRefinementPrompt=o.value);(0,b.save)(),h.oR.success("Settings saved")}(),a();const e=n.closest(".popup"),r=null==e?void 0:e.querySelector(".popup-button-cancel, .popup-button-ok");null==r||r.click()})})}let $t=null;function kt(){const e=SillyTavern.libs.DOMPurify,r=(0,h.Lq)($t),t=(0,h.mi)(),n=t?(0,h.We)():[],a=r.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger",i=r.isReady?"cr-api-status--ready":"cr-api-status--error",o=t&&n.length>0?`\n        <select id="${h.pW}_profile_select" \n                class="cr-select cr-selecr--sm text_pole" \n                aria-label="Connection profile">\n            <option value="" ${$t?"":"selected"}>\n                Current Settings\n            </option>\n            ${n.map(e=>function(e,r){const t=SillyTavern.libs.DOMPurify;return`\n        <option value="${e.id}" \n                ${r?"selected":""}\n                ${e.isSupported?"":"disabled"}>\n            ${t.sanitize(e.name)} (${t.sanitize(e.model)})\n        </option>\n    `}(e,e.id===$t)).join("")}\n        </select>\n    `:"";return`\n        <div id="${h.pW}_api_status" class="cr-api-status ${i}">\n            <div class="cr-api-status__indicator">\n                <i class="fa-solid ${a}"></i>\n                <span class="cr-api-status__text">${e.sanitize(r.modelDisplay)}</span>\n            </div>\n            ${o}\n            ${r.error?`\n                <span class="cr-api-status__error" title="${e.sanitize(r.error)}">\n                    <i class="fa-solid fa-exclamation-triangle"></i>\n                </span>\n            `:""}\n        </div>\n    `}function St(e){const r=[],t=ce(`#${h.pW}_profile_select`,e);return t&&r.push(de(t,"change",()=>{const e=t.value||null;$t=e;(0,b.getSettings)().selectedProfile=e,(0,b.save)(),function(){const e=ce(`#${h.pW}_api_status`);if(!e)return;const r=e.parentElement;r&&(r.innerHTML=kt(),St(r))}()})),()=>{r.forEach(e=>e())}}var Pt=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};let Rt=null;function Ct(){return`\n<div id="${h.pW}_popup" class="cr-popup">\n    <header class="cr-header">\n        <div class="cr-header__left">\n            ${function(){const e=SillyTavern.libs.DOMPurify,r=D().character,t=r?e.sanitize(r.name):"Select character...",n=r?`<img class="cr-dropdown__trigger-avatar"\n               src="${SillyTavern.getContext().getThumbnailUrl("avatar",r.avatar)}"\n               alt=""\n               onerror="this.src='/img/ai4.png'" />`:'<i class="fa-solid fa-user cr-dropdown__trigger-icon"></i>';return`\n        <div id="${h.pW}_char_dropdown" class="cr-dropdown ${Pe?"cr-dropdown--open":""}">\n            <button id="${h.pW}_char_trigger"\n                    class="cr-dropdown__trigger"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${Pe}">\n                ${n}\n                <span class="cr-dropdown__trigger-text ${r?"":"cr-dropdown__trigger-text--placeholder"}">${t}</span>\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel" role="listbox">\n                <div class="cr-dropdown__search">\n                    <i class="fa-solid fa-search cr-dropdown__search-icon"></i>\n                    <input type="text"\n                           id="${h.pW}_char_search"\n                           class="cr-dropdown__search-input"\n                           placeholder="Search characters..."\n                           autocomplete="off"\n                           value="${e.sanitize(Re)}" />\n                    ${Re?'\n                        <button class="cr-dropdown__search-clear" type="button" aria-label="Clear">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    ':""}\n                </div>\n                <div id="${h.pW}_char_list" class="cr-dropdown__list cr-scrollable">\n                    ${Oe()}\n                </div>\n            </div>\n        </div>\n    `}()}\n            ${function(){const e=D(),r=e.sessions.find(r=>r.id===e.activeSessionId),t=!!e.character;let n="No session";t?r&&(n=mt(r)):n="Select character...";const a=e.sessions.length;return`\n        <div id="${h.pW}_session_dropdown" class="cr-dropdown cr-dropdown--session ${fe(ut&&"cr-dropdown--open")} ${fe(!t&&"cr-dropdown--disabled")}">\n            <button id="${h.pW}_session_trigger"\n                    class="cr-dropdown__trigger cr-dropdown__trigger--session"\n                    type="button"\n                    aria-haspopup="listbox"\n                    aria-expanded="${ut}"\n                    ${t?"":"disabled"}>\n                <i class="fa-solid fa-folder cr-dropdown__trigger-icon"></i>\n                <span class="cr-dropdown__trigger-text ${fe(!r&&"cr-dropdown__trigger-text--placeholder")}">${SillyTavern.libs.DOMPurify.sanitize(n)}</span>\n                ${a>0?`<span class="cr-dropdown__count">${a}</span>`:""}\n                <i class="fa-solid fa-chevron-down cr-dropdown__trigger-chevron"></i>\n            </button>\n            <div class="cr-dropdown__panel cr-dropdown__panel--session" role="listbox">\n                <div id="${h.pW}_session_list" class="cr-dropdown__list cr-dropdown__list--session cr-scrollable">\n                    ${gt()}\n                </div>\n                <div class="cr-dropdown__footer">\n                    <button id="${h.pW}_new_session_btn"\n                            class="menu_button menu_button--sm menu_button--primary cr-dropdown__new-btn"\n                            type="button"\n                            ${t?"":"disabled"}>\n                        <i class="fa-solid fa-plus"></i>\n                        New Session\n                    </button>\n                </div>\n            </div>\n        </div>\n    `}()}\n        </div>\n        <div class="cr-header__center">\n            <i class="fa-solid fa-wand-magic-sparkles"></i>\n            <h2>Character Tools</h2>\n            <div id="${h.pW}_api_status_container">\n                ${function(){const e=(0,h.Lq)($t),r=e.isReady?"fa-circle-check cr-text-success":"fa-circle-xmark cr-text-danger";return`\n        <div class="cr-api-badge ${fe(!e.isReady&&"cr-api-badge--error")}" \n             title="${e.statusText}${e.error?": "+e.error:""}">\n            <i class="fa-solid ${r}"></i>\n            <span>${e.modelDisplay}</span>\n        </div>\n    `}()}\n            </div>\n        </div>\n        <div class="cr-header__right">\n            <button id="${h.pW}_export_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Export character as PNG"\n                    aria-label="Export character">\n                <i class="fa-solid fa-download"></i>\n            </button>\n            <button id="${h.pW}_settings_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Settings"\n                    aria-label="Settings">\n                <i class="fa-solid fa-cog"></i>\n            </button>\n            <button id="${h.pW}_close_btn"\n                    class="menu_button menu_button--icon menu_button--ghost"\n                    type="button"\n                    title="Close"\n                    aria-label="Close popup">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    </header>\n\n    <div class="cr-toolbar">\n        \n        <nav class="cr-stage-tabs" role="tablist" aria-label="Pipeline stages">\n            ${h.an.map(tt).join("")}\n        </nav>\n    \n        <div id="${h.pW}_pipeline_controls" class="cr-toolbar__controls">\n            ${nt()}\n        </div>\n    </div>\n\n    <div class="cr-body">\n        <aside class="cr-panel cr-panel--config cr-scrollable">\n            ${function(){const e=SillyTavern.libs.DOMPurify,r=D(),t=r.activeStage,n=r.stageConfigs[t];let a=n.customPrompt;if(!a&&n.promptPresetId){const e=(0,b.getPromptPreset)(n.promptPresetId);e&&(a=e.prompt)}let i=n.customSchema;if(!i&&n.schemaPresetId){const e=(0,b.getSchemaPreset)(n.schemaPresetId);e&&(i=JSON.stringify(e.schema,null,2))}return`\n        <section class="cr-section cr-stage-config" aria-label="Stage Configuration">\n            <div class="cr-section__header">\n                <h3 class="cr-section__title">\n                    <i class="fa-solid ${h.iu[t]}"></i>\n                    ${h.BA[t]} Configuration\n                </h3>\n            </div>\n\n            \x3c!-- Field Selection --\x3e\n            <div class="cr-stack cr-stack--tight">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-list-check cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Fields to Include</span>\n                    </div>\n                    <button id="${h.pW}_link_fields"\n                            class="menu_button menu_button--icon menu_button--sm menu_button--ghost ${Q()?"cr-active":""}"\n                            type="button"\n                            title="${Q()?"Fields shared across stages (click to unlink)":"Fields independent per stage (click to link)"}"\n                            aria-pressed="${Q()}">\n                        <i class="fa-solid ${Q()?"fa-link":"fa-link-slash"}"></i>\n                    </button>\n                </div>\n                <div id="${h.pW}_fields_container">\n                    ${ar()}\n                </div>\n            </div>\n\n            \x3c!-- Prompt Configuration --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <div class="cr-row cr-row--between">\n                    <div class="cr-row">\n                        <i class="fa-solid fa-message cr-text-accent"></i>\n                        <span class="cr-font-medium cr-text-sm">Prompt</span>\n                    </div>\n                    <div class="cr-row cr-gap-1">\n                        <button id="${h.pW}_save_prompt"\n                                class="menu_button menu_button--icon menu_button--sm menu_button--ghost"\n                                type="button"\n                                title="Save as preset"\n                                aria-label="Save as preset">\n                            <i class="fa-solid fa-floppy-disk"></i>\n                        </button>\n                        ${ir("prompt",t,n.promptPresetId)}\n                    </div>\n                </div>\n                <div class="cr-form-group">\n                    <textarea id="${h.pW}_prompt"\n                              placeholder="Enter instructions for this stage..."\n                              rows="6">${e.sanitize(a)}</textarea>\n                    <div class="cr-form-group__hint cr-text-right">\n                        <span id="${h.pW}_prompt_tokens">Calculating...</span>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Structured Output Toggle --\x3e\n            <div class="cr-stack cr-stack--tight cr-mt-4">\n                <label class="cr-checkbox">\n                    <input type="checkbox"\n                           id="${h.pW}_use_schema"\n                           ${n.useStructuredOutput?"checked":""} />\n                    <span>Use Structured Output (JSON Schema)</span>\n                </label>\n\n                <div id="${h.pW}_schema_section"\n                     class="${fe(!n.useStructuredOutput&&"cr-hidden")} cr-stack cr-stack--tight cr-mt-2">\n                    <div class="cr-row cr-row--between">\n                        <div class="cr-row">\n                            <i class="fa-solid fa-code cr-text-accent"></i>\n                            <span class="cr-font-medium cr-text-sm">JSON Schema</span>\n                        </div>\n                        ${ir("schema",t,n.schemaPresetId)}\n                    </div>\n                    <textarea id="${h.pW}_schema"\n                              class="cr-textarea--code"\n                              placeholder='{"name": "MySchema", "strict": true, "value": {...}}'\n                              rows="8">${e.sanitize(i)}</textarea>\n                    <div class="cr-button-group">\n                        <button id="${h.pW}_validate_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-check"></i>\n                            Validate\n                        </button>\n                        <button id="${h.pW}_format_schema"\n                                class="menu_button menu_button--sm"\n                                type="button">\n                            <i class="fa-solid fa-indent"></i>\n                            Format\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            \x3c!-- Preview --\x3e\n            <div class="cr-mt-4">\n                <button id="${h.pW}_preview"\n                        class="menu_button menu_button--full"\n                        type="button"\n                        ${r.character?"":"disabled"}>\n                    <i class="fa-solid fa-eye"></i>\n                    Preview Full Prompt\n                </button>\n            </div>\n        </section>\n    `}()}\n        </aside>\n        <main class="cr-panel cr-panel--results">\n            ${Qr()}\n        </main>\n    </div>\n</div>`}let Tt=[];function zt(){return Pt(this,void 0,void 0,function*(){const e=SillyTavern.getContext(),{DOMPurify:r}=SillyTavern.libs;I();const t=Ct();new e.Popup(r.sanitize(t),e.POPUP_TYPE.TEXT,"",{wide:!0,large:!0,allowVerticalScrolling:!0,okButton:!1,cancelButton:!1}).show().then(()=>Pt(this,void 0,void 0,function*(){yield function(){return Pt(this,void 0,void 0,function*(){!function(){for(const e of nr)e.flush()}(),yield B(),Tt.forEach(e=>e()),Tt=[],lt.forEach(e=>e()),lt=[],function(){const e=ce(`#${h.pW}_preset_drawer`);e&&e.remove(),De.forEach(e=>e()),De=[],Ne.isOpen=!1}(),ve.clear(),me.clear(),ge=!1,function(){for(const e of nr)e.cancel();nr=[]}(),Rt=null,M(),(0,b.clearCache)(),h.Rm.debug("Popup closed")})}()})),yield new Promise(e=>setTimeout(e,0)),Rt=document.getElementById(`${h.pW}_popup`),Rt?(!function(e){if(ce(`#${h.pW}_preset_drawer`))return;const r=e.closest(".popup");r?r.insertAdjacentHTML("beforeend",Le()):document.body.insertAdjacentHTML("beforeend",Le())}(Rt),function(e){Tt.forEach(e=>e()),Tt=[],Tt.push(he("characterSelector",Ee,["character","session"])),Tt.push(he("stageTabs",at,["stage","pipeline"])),Tt.push(he("pipelineControls",it,["pipeline","character"])),Tt.push(he("stageConfig",sr,["stage","config","fields","character"])),Tt.push(he("results",Kr,["results","stage"])),Tt.push(he("sessionDropdown",ht,["session","character"])),Tt.push(function(e){const r=[],t=ce(`#${h.pW}_char_dropdown`,e),n=ce(`#${h.pW}_char_trigger`,e),a=ce(`#${h.pW}_char_search`,e),i=ce(`#${h.pW}_char_list`,e);n&&r.push(de(n,"click",e=>{e.stopPropagation(),Te(!Pe),Pe&&a&&setTimeout(()=>a.focus(),0)}));const o=e=>{Pe&&t&&!t.contains(e.target)&&Te(!1)};if(document.addEventListener("click",o),r.push(()=>document.removeEventListener("click",o)),a){const e=SillyTavern.libs.lodash.debounce(()=>{Re=a.value,Ce=-1,i&&(i.innerHTML=Oe())},h.U8.SEARCH);r.push(de(a,"input",()=>{e()})),r.push(de(a,"keydown",e=>{const r=le(".cr-char-option",i),t=r.length-1;switch(e.key){case"ArrowDown":e.preventDefault(),Ce=Math.min(Ce+1,t),Ae(r);break;case"ArrowUp":e.preventDefault(),Ce=Math.max(Ce-1,0),Ae(r);break;case"Enter":e.preventDefault(),Ce>=0&&r[Ce]&&je(r[Ce]);break;case"Escape":e.preventDefault(),Te(!1),null==n||n.focus()}})),r.push(()=>e.cancel())}const s=ce(".cr-dropdown__search-clear",e);return s&&a&&r.push(de(s,"click",e=>{e.stopPropagation(),a.value="",Re="",Ce=-1,i&&(i.innerHTML=Oe()),a.focus()})),i&&r.push(de(i,"click",e=>{const r=e.target.closest(".cr-char-option");r&&je(r)})),()=>{r.forEach(e=>e()),Pe=!1,Re="",Ce=-1}}(e)),Tt.push(function(e){const r=[],t=ce(`#${h.pW}_session_dropdown`,e),n=ce(`#${h.pW}_session_trigger`,e),a=ce(`#${h.pW}_session_list`,e),i=ce(`#${h.pW}_new_session_btn`,e);n&&r.push(de(n,"click",e=>{e.stopPropagation(),n.disabled||vt(!ut)}));const o=e=>{ut&&t&&!t.contains(e.target)&&(vt(!1),ht())};return document.addEventListener("click",o),r.push(()=>document.removeEventListener("click",o)),i&&r.push(de(i,"click",e=>pt(this,void 0,void 0,function*(){e.stopPropagation(),(yield G())&&(h.oR.success("New session created"),vt(!1),xe())}))),a&&(r.push(de(a,"click",e=>pt(this,void 0,void 0,function*(){const r=e.target,t=r.closest(".cr-session-option");if(!t)return;const n=t.dataset.sessionId||r.dataset.sessionId;if(n){if(r.closest(".cr-session-edit"))return e.stopPropagation(),ft=n,ht(),void setTimeout(()=>{const e=ce(`.cr-session-option__name-input[data-session-id="${n}"]`);e&&(e.focus(),e.select())},0);if(r.closest(".cr-session-save")){e.stopPropagation();const r=ce(`.cr-session-option__name-input[data-session-id="${n}"]`);return r&&(yield J(n,r.value),h.oR.success("Session renamed")),ft=null,void ht()}if(r.closest(".cr-session-cancel"))return e.stopPropagation(),ft=null,void ht();if(r.closest(".cr-session-delete"))return e.stopPropagation(),void((yield h.lY.confirm("Delete Session","Are you sure you want to delete this session? This cannot be undone."))&&(yield q(n),h.oR.success("Session deleted"),ht(),xe()));t.classList.contains("cr-session-option--active")||ft||((yield U(n))?(h.oR.success("Session loaded"),vt(!1),xe()):h.oR.error("Failed to load session"))}}))),r.push(de(a,"keydown",e=>pt(this,void 0,void 0,function*(){const r=e.target;if(!r.classList.contains("cr-session-option__name-input"))return;const t=r.dataset.sessionId;t&&("Enter"===e.key?(e.preventDefault(),yield J(t,r.value),h.oR.success("Session renamed"),ft=null,ht()):"Escape"===e.key&&(e.preventDefault(),ft=null,ht()))})))),()=>{r.forEach(e=>e()),ut=!1,ft=null}}(e)),Tt.push(function(e){const r=[],t=ce(".cr-stage-tabs",e);t&&r.push(de(t,"click",e=>{const r=e.target.closest(".cr-stage-tab");if(!r)return;const t=r.dataset.stage;t&&(X(t),at(),sr(),Kr(),it())}));const n=ce(`#${h.pW}_pipeline_controls`,e);return n&&dt(n),()=>{r.forEach(e=>e())}}(e)),Tt.push(lr(e)),Tt.push(Xr(e));const r=ce(`#${h.pW}_api_status_container`,e);r&&Tt.push(St(r));const t=ce(`#${h.pW}_export_btn`,e);t&&Tt.push(de(t,"click",()=>{!function(){mr(this,void 0,void 0,function*(){const e=D();if(!e.character)return h.oR.warning("No character selected"),!1;const r=e.character,t=yield yr(r.avatar);if(!t)return h.oR.error("Failed to export character PNG"),!1;const n=URL.createObjectURL(t),a=document.createElement("a");return a.href=n,a.download=`${r.name}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),h.oR.success("Character PNG downloaded!"),!0})}()}));const n=ce(`#${h.pW}_settings_btn`,e);n&&Tt.push(de(n,"click",()=>{wt()}));const a=ce(`#${h.pW}_close_btn`,e);a&&Tt.push(de(a,"click",()=>{!function(){if(!Rt)return;const e=Rt.closest(".popup"),r=null==e?void 0:e.querySelector(".popup-button-cancel, .popup-button-ok");null==r||r.click()}()}));const i=r=>{const t=D();if(r.ctrlKey&&"Enter"===r.key){r.preventDefault();const n=ce(`#${h.pW}_run_stage`,e);n&&!t.isGenerating&&t.character&&n.click()}"Escape"===r.key&&t.isGenerating&&(r.preventDefault(),function(){const e=L();(null==e?void 0:e.abortController)&&(e.abortController.abort(),e.abortController=null,e.isGenerating=!1)}())};document.addEventListener("keydown",i),Tt.push(()=>document.removeEventListener("keydown",i))}(Rt),h.Rm.debug("Popup opened")):h.Rm.error("Popup element not found")})}var Ot=function(e,r,t,n){return new(t||(t=Promise))(function(a,i){function o(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(o,s)}c((n=n.apply(e,r||[])).next())})};function Et(){return Ot(this,void 0,void 0,function*(){const e=document.getElementById("extensions_settings");if(!e)return void h.Rm.error("Extensions container not found");e.insertAdjacentHTML("beforeend",function(){const e=(0,b.getSettings)();return`\n<div id="${h.pW}_panel">\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b><i class="fa-solid fa-wand-magic-sparkles"></i> ${h.hi}</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n            <div class="flex-container flexFlowColumn">\n                <small class="cr-panel-version">Version ${h.xv}</small>\n                <p class="cr-panel-desc">\n                    AI-powered character card analysis, scoring, and enhancement.\n                    Run the pipeline to evaluate and improve your character cards.\n                </p>\n                <div class="cr-panel-actions">\n                    <button id="${h.pW}_open_btn" class="menu_button menu_button_icon">\n                        <i class="fa-solid fa-play"></i>\n                        <span>Open Character Tools</span>\n                    </button>\n                </div>\n                <hr class="cr-panel-divider" />\n                <div class="cr-panel-debug">\n                    <label class="cr-panel-checkbox">\n                        <input type="checkbox" id="${h.pW}_debug_mode" ${e.debugMode?"checked":""} />\n                        <span>Enable debug logging</span>\n                    </label>\n                    <button id="${h.pW}_view_logs" class="menu_button menu_button--sm">\n                        <i class="fa-solid fa-terminal"></i>\n                        <span>View Logs</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>`}());const r=document.getElementById(`${h.pW}_open_btn`);null==r||r.addEventListener("click",zt);const t=document.getElementById(`${h.pW}_debug_mode`);null==t||t.addEventListener("change",()=>{(0,b.getSettings)().debugMode=t.checked,(0,h.pM)(t.checked),(0,b.save)(),h.oR.info(t.checked?"Debug logging enabled":"Debug logging disabled")});const n=document.getElementById(`${h.pW}_view_logs`);null==n||n.addEventListener("click",()=>{h.oR.info("Check browser console (F12) for logs")}),h.Rm.debug("Panel initialized")})}function At(){try{h.Rm.info(`${h.hi} v${h.xv} initializing...`),(0,b.getSettings)(),Et(),function(){const{eventSource:e,eventTypes:r}=SillyTavern.getContext();e.on(r.CHARACTER_EDITED,()=>{h.Rm.debug("Character edited, resetting Fuse index and refreshing popup"),Se(),function(){const e=L();if(!(null==e?void 0:e.character))return;const r=(SillyTavern.getContext().characters||[]).find(r=>{var t;return r.avatar===(null===(t=e.character)||void 0===t?void 0:t.avatar)});r&&(e.character=r)}(),_e()}),e.on(r.CHARACTER_DELETED,()=>{h.Rm.debug("Character deleted, resetting Fuse index"),Se()}),e.on(r.CHATCOMPLETION_SOURCE_CHANGED,()=>{h.Rm.debug("Chat completion source changed")}),e.on(r.CHATCOMPLETION_MODEL_CHANGED,()=>{h.Rm.debug("Chat completion model changed")}),h.Rm.debug("Event listeners registered")}(),h.Rm.info(`${h.hi} v${h.xv} loaded`)}catch(e){h.Rm.error("Extension initialization failed",e),h.oR.error(`${h.hi} failed to initialize. Check console.`)}}function jt(){(0,b.clearCache)(),h.Rm.info("Extension cleaned up")}(0,h.pM)(h.Oi);const{eventSource:Wt,eventTypes:Nt}=SillyTavern.getContext();Wt.on(Nt.APP_READY,At);export{jt as cleanup,At as init};export const log=h.Rm;